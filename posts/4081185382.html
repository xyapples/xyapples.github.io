<!-- build time:Mon Jun 30 2025 21:42:01 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico"><link rel="alternate" href="/rss.xml" title="LinuxSre云原生" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="LinuxSre云原生" type="application/atom+xml"><link rel="alternate" type="application/json" title="LinuxSre云原生" href="http://ixuyong.cn/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.17"><link rel="modulepreload" href="/js/chunk-GV364XSK.js"><link rel="modulepreload" href="/js/chunk-NYSE5UKM.js"><link rel="modulepreload" href="/js/chunk-RONCYO2S.js"><link rel="modulepreload" href="/js/chunk-THHXCRSX.js"><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/js/comments-DL2IYMPZ.js"><link rel="modulepreload" href="/js/copy-tex-NADCTXPG.js"><link rel="modulepreload" href="/js/post-DA635IH6.js"><link rel="modulepreload" href="/js/quicklink-WEDHL4BA.js"><link rel="modulepreload" href="/js/search-VCZRKTM5.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/waline-NNBYRQEE.js"><link rel="stylesheet" href="/css/comments-F4ZGS7LD.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/waline-IDNZKML2.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="preload" href="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" as="image" fetchpriority="high"><meta name="keywords" content="Prometheus"><meta name="description" content="专注于 Linux 运维、云计算、云原⽣等技术"><link rel="canonical" href="http://ixuyong.cn/posts/4081185382.html"><title>Prometheus监控实战（四）</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Prometheus监控实战（四）</h1><div class="meta"><span class="item" title="创建时间：2025-06-29 22:03:48"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-06-29T22:03:48+08:00">2025-06-29</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>36k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>33 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">LinuxSre云原生</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" loading="eager" decoding="async" fetchpriority="high" alt="LinuxSre云原生"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Prometheus/" itemprop="item" rel="index" title="分类于Prometheus"><span itemprop="name">Prometheus<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://ixuyong.cn/posts/4081185382.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"><meta itemprop="name" content="Xu Yong"><meta itemprop="description" content="致力于技术布道、普及前沿技术、打造云原生系列标杆博客, 专注于 Linux 运维、云计算、云原⽣等技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LinuxSre云原生"></span><div class="body md" itemprop="articleBody"><h3 id="prometheus告警服务"><a class="anchor" href="#prometheus告警服务">#</a> <strong>Prometheus 告警服务</strong></h3><h4 id="一-aleartmanager部署"><a class="anchor" href="#一-aleartmanager部署">#</a> 一. AleartManager 部署</h4><h5 id="11-aleartmanager安装"><a class="anchor" href="#11-aleartmanager安装">#</a> 1.1 AleartManager 安装</h5><p>1、访问 AlertManager 的 github，获取 AlertManager 的下载地址， <a target="_blank" rel="noopener" href="https://github.com/prometheus/alertmanager/releases">https://github.com/prometheus/alertmanager/releases</a></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 下载 AlertManager</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 加速地址</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.ghproxy.com/https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#2. 解压 AlertManager</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># tar xf alertmanager-0.26.0.linux-amd64.tar.gz -C /etc/</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/alertmanager-0.26.0.linux-amd64/ /etc/alertmanager</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#3. 查看 AlertManager ⽬录结构</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment">#  ll /etc/alertmanager/</span></pre></td></tr><tr><td data-num="13"></td><td><pre>total <span class="token number">62504</span></pre></td></tr><tr><td data-num="14"></td><td><pre>-rwxr-xr-x <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span> <span class="token number">35410965</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> alertmanager</pre></td></tr><tr><td data-num="15"></td><td><pre>-rw-r--r-- <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span>      <span class="token number">356</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> alertmanager.yml</pre></td></tr><tr><td data-num="16"></td><td><pre>-rwxr-xr-x <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span> <span class="token number">28566971</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> amtool</pre></td></tr><tr><td data-num="17"></td><td><pre>-rw-r--r-- <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span>    <span class="token number">11357</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> LICENSE</pre></td></tr><tr><td data-num="18"></td><td><pre>-rw-r--r-- <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span>      <span class="token number">457</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> NOTICE</pre></td></tr></table></figure><h5 id="12-aleartmanager配置"><a class="anchor" href="#12-aleartmanager配置">#</a> 1.2 AleartManager 配置</h5><p>1、定义 Alertmanager 的配置⽂件，设定发件⼈的邮箱，以及路由匹配规则，和接收⼈ （group_wait 与 group_interval 区别）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cp /etc/alertmanager/alertmanager.yml /etc/alertmanager/alertmanager.yml.bak</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  resolve_timeout: 2h    <span class="token comment"># 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  smtp_smarthost: <span class="token string">'smtp.qq.com:25'</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  smtp_from: <span class="token string">'373370405@qq.com'</span>  <span class="token comment"># 发件人邮件</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  smtp_auth_username: <span class="token string">'373370405@qq.com'</span>  <span class="token comment"># 发件人用户名</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  smtp_auth_password: <span class="token string">'jmtpwlkuijaybhic'</span> <span class="token comment"># 发件人密码 [授权码]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  smtp_hello: <span class="token string">'qq.com'</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  smtp_require_tls: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="11"></td><td><pre> </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 所有报警信息进入后的根路由，用来设置报警的分发策略</span></pre></td></tr><tr><td data-num="13"></td><td><pre>route:</pre></td></tr><tr><td data-num="14"></td><td><pre>  group_by: <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">]</span> <span class="token comment">#告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  group_wait: 30s     <span class="token comment"># 当一组新告警产生时，系统会等待 30 秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的 30s 内会有新的同校学生上车）</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  group_interval: 1m  <span class="token comment"># 已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少 1 分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  repeat_interval: 5m <span class="token comment"># 如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  receiver: default   <span class="token comment"># 默认的 receiver：如果一个报警没有被一个 route 匹配，则发送给默认的接收器</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  </pre></td></tr><tr><td data-num="20"></td><td><pre>receivers:</pre></td></tr><tr><td data-num="21"></td><td><pre>- name: <span class="token string">'default'</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  email_configs:</pre></td></tr><tr><td data-num="23"></td><td><pre>  - to: <span class="token string">'373370405@qq.com'</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    send_resolved: <span class="token boolean">true</span> <span class="token comment"># 接受告警恢复的通知</span></pre></td></tr></table></figure><p>2、检查 AlertManager 的配置⽂件是否正确</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment">#  /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Checking <span class="token string">'/etc/alertmanager/alertmanager.yml'</span>  SUCCESS</pre></td></tr><tr><td data-num="3"></td><td><pre>Found:</pre></td></tr><tr><td data-num="4"></td><td><pre> - global config</pre></td></tr><tr><td data-num="5"></td><td><pre> - route</pre></td></tr><tr><td data-num="6"></td><td><pre> - <span class="token number">0</span> inhibit rules</pre></td></tr><tr><td data-num="7"></td><td><pre> - <span class="token number">1</span> receivers</pre></td></tr><tr><td data-num="8"></td><td><pre> - <span class="token number">0</span> templates</pre></td></tr></table></figure><h5 id="13-alertmanager启动"><a class="anchor" href="#13-alertmanager启动">#</a> 1.3 AlertManager 启动</h5><p>1、配置 system 管理 alertmanager 启动和停⽌</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/alertmanager.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>alertmanager</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/etc/alertmanager/alertmanager <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  --web.listen-address<span class="token operator">=</span>:9093 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token parameter variable">--config.file</span><span class="token operator">=</span>/etc/alertmanager/alertmanager.yml <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token parameter variable">--storage.path</span><span class="token operator">=</span>/etc/alertmanager/data <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token parameter variable">--data.retention</span><span class="token operator">=</span>120h</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start alertmanager</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable alertmanager</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 9093</span></pre></td></tr><tr><td data-num="24"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::9093                 :::*                    LISTEN      <span class="token number">2648</span>/alertmanager</pre></td></tr></table></figure><p>2、访问 alertmanager，通过 <a target="_blank" rel="noopener" href="http://IP:9093">http://IP:9093</a> 访问</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/yuWRORp.png" alt="image-20240305221644642.png"></p><h5 id="14-alertmanager测试"><a class="anchor" href="#14-alertmanager测试">#</a> 1.4 AlertManager 测试</h5><p>1、使⽤ Go 编写的告警测试⼯具来验证告警合并功能。发送具有相同 alertname 名称，但不同内容的告警，以验证 AlertManager 是否会将它们合并成⼀个组。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下载告警程序</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/prometheus/Alert/alert_test_oldxu</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x alert_test_oldxu</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># alertname = 节点故障（--alertURL 指定 alertmanager 服务器所在的地址、端⼝以及接⼝）</span></pre></td></tr><tr><td data-num="6"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://prom-node01.oldxu.net:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=节点故障,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://prom-node01.oldxu.net:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=节点故障,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># alertname=cpu 故障</span></pre></td></tr><tr><td data-num="10"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://prom-node01.oldxu.net:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=cpu故障,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://prom-node01.oldxu.net:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=cpu故障,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr></table></figure><h4 id="二-prometheus对接aleartmanager"><a class="anchor" href="#二-prometheus对接aleartmanager">#</a> 二. Prometheus 对接 AleartManager</h4><h5 id="21-配置prom对接aleartmanager"><a class="anchor" href="#21-配置prom对接aleartmanager">#</a> 2.1 配置 Prom 对接 AleartManager</h5><p>1、编辑 prometheus.yml ⽂件，然后将告警接⼊⾄ AlertManager 组件；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># Alertmanager 配置</span></pre></td></tr><tr><td data-num="7"></td><td><pre>alerting:</pre></td></tr><tr><td data-num="8"></td><td><pre>  alertmanagers:</pre></td></tr><tr><td data-num="9"></td><td><pre>  - static_configs:</pre></td></tr><tr><td data-num="10"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9093"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="13"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="16"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="17"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="25"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="30"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="35"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="40"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="45"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="50"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="55"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="60"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>  - job_name: <span class="token string">"mysqld_exporter"</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="65"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="67"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="68"></td><td><pre>        role: master</pre></td></tr><tr><td data-num="69"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="71"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="72"></td><td><pre>        role: slave</pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>  - job_name: <span class="token string">"redis_exporter"</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="77"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9121"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>  - job_name: <span class="token string">'blackbox_http'</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 这次不是 /metrics，是 /probe</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    params: <span class="token comment"># 传递参数</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      module: <span class="token punctuation">[</span>http_2xx<span class="token punctuation">]</span> <span class="token comment"># 调哪个模块进探测</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="84"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"https://www.xuliangwei.com"</span>,<span class="token string">"http://www.oldxu.net"</span>,<span class="token string">"https://www.baidu.com"</span>,<span class="token string">"http://httpbin.org/status/400"</span>,<span class="token string">"https://httpstat.us/500"</span>,<span class="token string">"https://httpstat.us/502"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="86"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="87"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="88"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="90"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="91"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>  - job_name: <span class="token string">'blackbox_tcp'</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="95"></td><td><pre>    params:</pre></td></tr><tr><td data-num="96"></td><td><pre>      module: <span class="token punctuation">[</span>tcp_connect<span class="token punctuation">]</span> <span class="token comment"># 使 tcp_connect 模块</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="98"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:3306"</span>,<span class="token string">"prom-node03.oldxu.net:6379"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="100"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="101"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="102"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="104"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="105"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>  - job_name: <span class="token string">'blackbox_icmp'</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="109"></td><td><pre>    params:</pre></td></tr><tr><td data-num="110"></td><td><pre>      module: <span class="token punctuation">[</span>icmp<span class="token punctuation">]</span> <span class="token comment"># 使 icmp 模块</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="112"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net"</span>,<span class="token string">"prom-node02.oldxu.net"</span>,<span class="token string">"prom-node03.oldxu.net"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="114"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="115"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="116"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="117"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="118"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="119"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>  - job_name: <span class="token string">'blackbox_ssh'</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="123"></td><td><pre>    params:</pre></td></tr><tr><td data-num="124"></td><td><pre>      module: <span class="token punctuation">[</span>ssh_banner<span class="token punctuation">]</span> <span class="token comment"># 使⽤ ssh_banner 模块</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="126"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:22"</span>,<span class="token string">"prom-node02.oldxu.net:22"</span>,<span class="token string">"prom-node03.oldxu.net:22"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="128"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="129"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="130"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="131"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="132"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="133"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="134"></td><td><pre></pre></td></tr><tr><td data-num="135"></td><td><pre>  - job_name: <span class="token string">'domain_exporter'</span></pre></td></tr><tr><td data-num="136"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 不是 /metrics，⽽是 /probe</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="138"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"nf-leasing.com"</span>,<span class="token string">"hmallleasing.com"</span>,<span class="token string">"jd.com"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="140"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="141"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="142"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="143"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="144"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="145"></td><td><pre>      replacement: prom-node04.oldxu.net:9222</pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre>  - job_name: <span class="token string">"pushgateway"</span></pre></td></tr><tr><td data-num="148"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="149"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="150"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9091"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>2、由于 AlertManager 也对外提供了 Metrics 接⼝，我们可以直接将 AlertManager 纳⼊监控中来；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># Alertmanager 配置</span></pre></td></tr><tr><td data-num="7"></td><td><pre>alerting:</pre></td></tr><tr><td data-num="8"></td><td><pre>  alertmanagers:</pre></td></tr><tr><td data-num="9"></td><td><pre>  - static_configs:</pre></td></tr><tr><td data-num="10"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9093"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="13"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="16"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="17"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="25"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="30"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="35"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="40"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="45"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="50"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="55"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="60"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>  - job_name: <span class="token string">"mysqld_exporter"</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="65"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="67"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="68"></td><td><pre>        role: master</pre></td></tr><tr><td data-num="69"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="71"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="72"></td><td><pre>        role: slave</pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>  - job_name: <span class="token string">"redis_exporter"</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="77"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9121"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>  - job_name: <span class="token string">'blackbox_http'</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 这次不是 /metrics，是 /probe</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    params: <span class="token comment"># 传递参数</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      module: <span class="token punctuation">[</span>http_2xx<span class="token punctuation">]</span> <span class="token comment"># 调哪个模块进探测</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="84"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"https://www.xuliangwei.com"</span>,<span class="token string">"http://www.oldxu.net"</span>,<span class="token string">"https://www.baidu.com"</span>,<span class="token string">"http://httpbin.org/status/400"</span>,<span class="token string">"https://httpstat.us/500"</span>,<span class="token string">"https://httpstat.us/502"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="86"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="87"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="88"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="90"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="91"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>  - job_name: <span class="token string">'blackbox_tcp'</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="95"></td><td><pre>    params:</pre></td></tr><tr><td data-num="96"></td><td><pre>      module: <span class="token punctuation">[</span>tcp_connect<span class="token punctuation">]</span> <span class="token comment"># 使 tcp_connect 模块</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="98"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:3306"</span>,<span class="token string">"prom-node03.oldxu.net:6379"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="100"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="101"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="102"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="104"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="105"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>  - job_name: <span class="token string">'blackbox_icmp'</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="109"></td><td><pre>    params:</pre></td></tr><tr><td data-num="110"></td><td><pre>      module: <span class="token punctuation">[</span>icmp<span class="token punctuation">]</span> <span class="token comment"># 使 icmp 模块</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="112"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net"</span>,<span class="token string">"prom-node02.oldxu.net"</span>,<span class="token string">"prom-node03.oldxu.net"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="114"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="115"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="116"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="117"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="118"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="119"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>  - job_name: <span class="token string">'blackbox_ssh'</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="123"></td><td><pre>    params:</pre></td></tr><tr><td data-num="124"></td><td><pre>      module: <span class="token punctuation">[</span>ssh_banner<span class="token punctuation">]</span> <span class="token comment"># 使⽤ ssh_banner 模块</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="126"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:22"</span>,<span class="token string">"prom-node02.oldxu.net:22"</span>,<span class="token string">"prom-node03.oldxu.net:22"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="128"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="129"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="130"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="131"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="132"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="133"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="134"></td><td><pre></pre></td></tr><tr><td data-num="135"></td><td><pre>  - job_name: <span class="token string">'domain_exporter'</span></pre></td></tr><tr><td data-num="136"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 不是 /metrics，⽽是 /probe</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="138"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"nf-leasing.com"</span>,<span class="token string">"hmallleasing.com"</span>,<span class="token string">"jd.com"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="140"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="141"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="142"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="143"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="144"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="145"></td><td><pre>      replacement: prom-node04.oldxu.net:9222</pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre>  - job_name: <span class="token string">"pushgateway"</span></pre></td></tr><tr><td data-num="148"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="149"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="150"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9091"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre>  - job_name: <span class="token string">"alertmanager"</span></pre></td></tr><tr><td data-num="153"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="154"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="155"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9093"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>3、重新加载 Prometheus 服务</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="22-配置prometheus告警规则"><a class="anchor" href="#22-配置prometheus告警规则">#</a> 2.2 配置 Prometheus 告警规则</h5><p>1、在 Prometheus 服务器上编辑⼀个测试的告警规则</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/node_rules.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>groups:</pre></td></tr><tr><td data-num="3"></td><td><pre>- name: 节点告警规则</pre></td></tr><tr><td data-num="4"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="5"></td><td><pre>  - alert: 节点处于Down状态</pre></td></tr><tr><td data-num="6"></td><td><pre>    expr: up <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="8"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="10"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="11"></td><td><pre>      summary: <span class="token string">"节点处于Down状态,实例:"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      description: <span class="token string">" 节点已关闭"</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  - alert: 节点CPU使率超过80%</pre></td></tr><tr><td data-num="15"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - avg<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> <span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="17"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="18"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="19"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="20"></td><td><pre>      summary: <span class="token string">"主机CPU利率过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      description: <span class="token string">"该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。"</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  - alert: CPU饱和度过高</pre></td></tr><tr><td data-num="24"></td><td><pre>    expr: sum<span class="token punctuation">(</span>node_load1<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token punctuation">(</span>count<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> * <span class="token number">2</span><span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="26"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="27"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="28"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="29"></td><td><pre>      summary: <span class="token string">"CPU饱和度过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      description: <span class="token string">"该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。"</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  - alert: 主机内存不足</pre></td></tr><tr><td data-num="33"></td><td><pre>    expr: <span class="token punctuation">(</span>node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes<span class="token punctuation">)</span> / node_memory_MemTotal_bytes * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="35"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="36"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="37"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="38"></td><td><pre>      summary: <span class="token string">"主机内存使用率较高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      description: <span class="token string">"该实例的内存使用率持续2分钟高于80%，当前利用率：%"</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - alert: 内存饱和度高</pre></td></tr><tr><td data-num="42"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">10</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="44"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="45"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="46"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="47"></td><td><pre>      summary: <span class="token string">"主机内存内存饱和度高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      description: <span class="token string">"SWAP内存使用率已连续2分钟超过10%，表明内存饱和度过高，当前SWAP使用率为：%。"</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>  - alert: 磁盘空间告急</pre></td></tr><tr><td data-num="51"></td><td><pre>    expr: <span class="token punctuation">(</span> node_filesystem_size_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> - node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> / node_filesystem_size_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">70</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="53"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="54"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="55"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="56"></td><td><pre>      summary: <span class="token string">"实例  磁盘 分区空间不足"</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      description: <span class="token string">"实例  磁盘  分区空间使用率已超过 70%，当前使用率为 %，请及时处理。"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>          </pre></td></tr><tr><td data-num="59"></td><td><pre>  - alert: 磁盘Inode空间告急</pre></td></tr><tr><td data-num="60"></td><td><pre>    expr: <span class="token punctuation">(</span>node_filesystem_files<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> - node_filesystem_files_free<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> / node_filesystem_files<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">70</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="62"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="63"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="64"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="65"></td><td><pre>      summary: <span class="token string">"实例  磁盘 分区Inode空间不足"</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      description: <span class="token string">"实例  磁盘  分区的Inode空间使用率已超过 70%，，当前使用率为 %，请及时处理。"</span></pre></td></tr><tr><td data-num="67"></td><td><pre>          </pre></td></tr><tr><td data-num="68"></td><td><pre>  - alert: 磁盘IOPS写入较高</pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">#expr: sum(rate(node_disk_writes_completed_total[1m])) by (instance,job) / 120 * 100 >60</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token comment">#round 函数可以对值进行四舍五入，磁盘最大 IOPS 为 120 次 /s</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_disk_writes_completed_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">120</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="73"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="74"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="75"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="76"></td><td><pre>      summary: <span class="token string">"实例  IOPS每秒写入次数超过120次/s"</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      description: </pre></td></tr><tr><td data-num="78"></td><td><pre>        当前磁盘IOPS写入饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼25--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="79"></td><td><pre>        当前磁盘IOPS每秒写入最大 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼26--<span class="token operator">></span> 次/s</pre></td></tr><tr><td data-num="80"></td><td><pre>                </pre></td></tr><tr><td data-num="81"></td><td><pre>  - alert: 磁盘IOPS读取较高</pre></td></tr><tr><td data-num="82"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_disk_reads_completed_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">120</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="84"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="85"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="86"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="87"></td><td><pre>      summary: <span class="token string">"实例  IOPS每秒读取次数超过120次/s"</span></pre></td></tr><tr><td data-num="88"></td><td><pre>      description:</pre></td></tr><tr><td data-num="89"></td><td><pre>        当前磁盘IOPS读取饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼28--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="90"></td><td><pre>        当前磁盘IOPS每秒读取最⼤ <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼29--<span class="token operator">></span> 次/s</pre></td></tr><tr><td data-num="91"></td><td><pre>  </pre></td></tr><tr><td data-num="92"></td><td><pre>  - alert: 磁盘IO写入吞吐较高</pre></td></tr><tr><td data-num="93"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_written_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">1024</span> /1024 / <span class="token number">30</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="95"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="96"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="97"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="98"></td><td><pre>      summary: <span class="token string">"实例  磁盘IO写入每秒超过最高30MB/s"</span></pre></td></tr><tr><td data-num="99"></td><td><pre>      description:</pre></td></tr><tr><td data-num="100"></td><td><pre>        当前磁盘IO写入吞吐量的饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼31--<span class="token operator">></span>%。</pre></td></tr><tr><td data-num="101"></td><td><pre>        当前磁盘IO写入吞吐量每秒最大是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼32--<span class="token operator">></span>MB/s</pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>  - alert: 磁盘IO读取吞吐较高</pre></td></tr><tr><td data-num="104"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_read_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">1024</span> /1024 /30 * <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="106"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="107"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="108"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="109"></td><td><pre>      summary: <span class="token string">"实例  磁盘IO读取每秒超过最大30MB/s"</span></pre></td></tr><tr><td data-num="110"></td><td><pre>      description:</pre></td></tr><tr><td data-num="111"></td><td><pre>        当前磁盘IO读取吞吐量的饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼34--<span class="token operator">></span>%。</pre></td></tr><tr><td data-num="112"></td><td><pre>        当前磁盘IO读取吞吐量每秒最大是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼35--<span class="token operator">></span>MB/s</pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>  - alert: 网络下载带宽异常</pre></td></tr><tr><td data-num="115"></td><td><pre>    expr: max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_network_receive_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> * <span class="token number">8</span> / <span class="token number">1024</span> / <span class="token number">1024</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job,device<span class="token punctuation">)</span> / <span class="token number">50</span> * <span class="token number">100</span> <span class="token operator">>=</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="117"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="118"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="119"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="120"></td><td><pre>      summary: <span class="token string">"实例  的  接口下载流量已经超过公司实际50Mbps"</span></pre></td></tr><tr><td data-num="121"></td><td><pre>      description:</pre></td></tr><tr><td data-num="122"></td><td><pre>        当前下载带宽已经达到 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼38--<span class="token operator">></span> Mbps/s</pre></td></tr><tr><td data-num="123"></td><td><pre>        当前下载带宽使用率在 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼39--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="124"></td><td><pre>  </pre></td></tr><tr><td data-num="125"></td><td><pre>  - alert: 网络上传带宽异常</pre></td></tr><tr><td data-num="126"></td><td><pre>    expr: max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_network_transmit_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> * <span class="token number">8</span> / <span class="token number">1024</span> / <span class="token number">1024</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job,device<span class="token punctuation">)</span> / <span class="token number">50</span> * <span class="token number">100</span> <span class="token operator">>=</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="128"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="129"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="130"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="131"></td><td><pre>      summary: <span class="token string">"实例  的  接口上传流量已经超过公司实际50Mbps"</span></pre></td></tr><tr><td data-num="132"></td><td><pre>      description:</pre></td></tr><tr><td data-num="133"></td><td><pre>        当前上传带宽已经达到 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼42--<span class="token operator">></span> Mbps/s</pre></td></tr><tr><td data-num="134"></td><td><pre>        当前上传带宽使用率在 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼43--<span class="token operator">></span>%</pre></td></tr></table></figure><h5 id="23-配置prometheus加载规则"><a class="anchor" href="#23-配置prometheus加载规则">#</a> 2.3 配置 Prometheus 加载规则</h5><p>为了能够让 Prometheus 能够定期评估告警规则，我们需要在 Prometheus 全局配置⽂件中通过 rule_files 指定告警规则⽂件的路径，⽽后 Prometheus 会定期评估这些告警规则， 当规则条件满⾜时，会向外部发送通知。</p><p>1、配置 Prometheus 加载告警规则⽂件</p><pre><code>[root@prom-node01 ~]# cat /etc/prometheus/prometheus.yml
# 全局段定义
global:
  scrape_interval: 15s # 设置 Prometheus 抓取指标数据的间隔，默认为15秒。

# Alertmanager 配置
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&quot;prom-node01.oldxu.net:9093&quot;]

rule_files:
  - &quot;/etc/prometheus/rules/*.yml&quot; 

# 抓取指定的目标
scrape_configs:
  - job_name: &quot;prometheus&quot; # 定义一个抓取任务，名为 'prometheus'。
    metrics_path: &quot;/metrics&quot; # 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。
    static_configs: # 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。
    - targets: [&quot;prom-node01.oldxu.net:9090&quot;]

  - job_name: &quot;grafana&quot;
    metrics_path: &quot;/metrics&quot;
    static_configs:
    - targets: [&quot;prom-node01.oldxu.net:3000&quot;]
</code></pre><p>2、检查 Prometheus 语法</p><pre><code>[root@prom-node01 ~]# /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml 
Checking /etc/prometheus/rules/node_rules.yml
  SUCCESS: 13 rules found
</code></pre><p>3、重启 Prometheus 服务</p><pre><code>curl -X POST http://localhost:9090/-/reload
</code></pre><h5 id="24-触发规则并验证告警通知"><a class="anchor" href="#24-触发规则并验证告警通知">#</a> 2.4 触发规则并验证告警通知</h5><p>1、停⽌ node2 和 node03 的 node_exporter 服务，那么就会触发告警</p><pre><code>[root@prom-node02 ~]# systemctl stop node_exporter.service
[root@prom-node03 ~]# systemctl stop node_exporter.service
</code></pre><p>2、检查 Prometheus 的 Alert ⻚⾯的状态是否处于 Firing</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306194624448.png" alt="image-20240306194624448"></p><p>3、检查 AlertManager 是否收到了告警</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306194659288.png" alt="image-20240306194659288"></p><p>4、检查邮件是否能看到告警的信息，因为两条告警的 alertname 是⼀致的，因此它们会合并为⼀条消息发送出来。</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306194735774.png" alt="image-20240306194735774"></p><h5 id="25-自定义邮件告警模板"><a class="anchor" href="#25-自定义邮件告警模板">#</a> 2.5 ⾃定义邮件告警模板</h5><p>1、定义告警的通知模板和恢复模板</p><pre><code>[root@prom-node01 ~]# mkdir /etc/alertmanager/template
[root@prom-node01 ~]# cat /etc/alertmanager/template/email.tmpl
&#123;&#123; define "email.html" &#125;&#125;
&#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;
&#123;&#123; range .Alerts &#125;&#125;
&lt;h2 style=&quot;color: red;&quot;&gt;@告警通知&lt;/h2&gt;
告警程序: AlertManager &lt;br&gt;
告警级别: &#123;&#123; .Labels.severity &#125;&#125; &lt;br&gt;
告警类型: &#123;&#123; .Labels.alertname &#125;&#125; &lt;br&gt;
故障主机: &#123;&#123; .Labels.instance &#125;&#125; &lt;br&gt;
告警主题: &#123;&#123; .Annotations.summary &#125;&#125; &lt;br&gt;
告警详情: &#123;&#123; .Annotations.description &#125;&#125; &lt;br&gt;
触发时间: &#123;&#123; (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" &#125;&#125; &lt;br&gt;
&#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;

&#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;
&#123;&#123; range .Alerts &#125;&#125;
&lt;h2 style=&quot;color: green;&quot;&gt;@告警恢复&lt;/h2&gt;
告警程序: AlertManager &lt;br&gt;
告警级别: &#123;&#123; .Labels.severity &#125;&#125; &lt;br&gt;
告警类型: &#123;&#123; .Labels.alertname &#125;&#125; &lt;br&gt;
告警主机: &#123;&#123; .Labels.instance &#125;&#125; &lt;br&gt;
告警主题: &#123;&#123; .Annotations.summary &#125;&#125; &lt;br&gt;
告警详情: &#123;&#123; .Annotations.description &#125;&#125; &lt;br&gt;
触发时间: &#123;&#123; (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" &#125;&#125; &lt;br&gt;
恢复时间: &#123;&#123; (.EndsAt.Add 28800e9).Format "2006-01-02 15:04:05" &#125;&#125; &lt;br&gt;
&#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;
&#123;&#123; end &#125;&#125;
</code></pre><p>2、配置 AlertManager，引⽤该模板</p><pre><code>[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: 'smtp.qq.com:25'
  smtp_from: '373370405@qq.com'  # 发件人邮件
  smtp_auth_username: '373370405@qq.com'  # 发件人用户名
  smtp_auth_password: 'jmtpwlkuijaybhic' # 发件人密码[授权码]
  smtp_hello: 'qq.com'
  smtp_require_tls: false

# 加载模板文件
templates:
  - '/etc/alertmanager/template/email.tmpl'
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: ['alertname'] # 告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s     # 当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m  # 已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m # 如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: default   # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器
  
receivers:
- name: 'default'
  email_configs:
  - to: '373370405@qq.com'
    send_resolved: true # 接受告警恢复的通知
    html: '&#123;&#123; template "email.html" . &#125;&#125;' # 发送邮件内容，调用该模板进行渲染
</code></pre><p>3、检查 AlertManager 的配置⽂件是否正确</p><pre><code>[root@prom-node01 ~]# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml
Checking '/etc/alertmanager/alertmanager.yml'  SUCCESS
Found:
 - global config
 - route
 - 0 inhibit rules
 - 1 receivers
 - 1 templates
  SUCCESS
</code></pre><p>4、重新加载 AlertManager</p><pre><code>[root@prom-node01 ~]#  curl -X POST http://localhost:9093/-/reload
</code></pre><p>5、触发告警，验证告警模板是否正常渲染</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306200956695.png" alt="image-20240306200956695"></p><h4 id="三-alertmanager告警通知方式"><a class="anchor" href="#三-alertmanager告警通知方式">#</a> 三. AlertManager 告警通知⽅式</h4><h5 id="31-配置alert对接微信告警"><a class="anchor" href="#31-配置alert对接微信告警">#</a> 3.1 配置 Alert 对接微信告警</h5><p>企业微信告警，需要将发送告警的服务器域名添加到⽩名单，同时该服务器必须运⾏在公⽹，因此常规的企业微信告警没办法很好在本地实现。但是我们可以采⽤ webhook ⽅式来实现： Prometheus--&gt;AlertManager--&gt; ⾃定义 Webhook 程序 --&gt; 企业微信机器⼈ --&gt; 通知给对应的⽤户</p><ul><li>1. 访问企业微信官⽹， <a target="_blank" rel="noopener" href="https://work.weixin.qq.com/">https://work.weixin.qq.com/</a> ，注册⼀个账户。</li><li>2. 创建⼀个群聊，并邀请⾄少两名其他成员加⼊，因为企业微信群聊⾄少需要三名成员才能启⽤。</li><li>3. 在群组聊天中添加⼀个新的机器⼈。</li><li>4. 记录机器⼈的 Webhook URL (Token)</li></ul><pre><code>https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=47ffbdd9-4308-4db0-aa08-f309546cc92d
</code></pre><p>1、下载并运⾏ webhook_wechat</p><pre><code>[root@prom-node01 ~]# wget http://file.oldxu.net/prometheus/Alert/webhook_wechat_oldxu
[root@prom-node01 ~]# mv webhook_wechat_oldxu /usr/local/bin/
[root@prom-node01 ~]# chmod +x /usr/local/bin/webhook_wechat_oldxu
</code></pre><p>2、编辑启动脚本⽂件</p><pre><code>[root@prom-node01 ~]# cat /usr/lib/systemd/system/webhook_wechat.service
[Unit]
Description=webhook_wechat
Documentation=https://prometheus.io/
After=network.target

[Service]
ExecStart=/usr/local/bin/webhook_wechat_oldxu --port 5001
ExecReload=/bin/kill -HUP
TimeoutStopSec=20s
Restart=always

[Install]
WantedBy=multi-user.target

[root@prom-node01 ~]# systemctl daemon-reload
[root@prom-node01 ~]# systemctl start webhook_wechat &amp;&amp; systemctl enable webhook_wechat
[root@prom-node01 ~]# netstat -lntp|grep 5001
tcp6       0      0 :::5001                 :::*                    LISTEN      2576/webhook_wechat 
</code></pre><p>3、测试 webhook_wechat 能否正确发送消息到企业微信</p><pre><code>[root@prom-node01 ~]# curl -X POST http://localhost:5001/alert?token=&lt;企业微信机器人token&gt; \
-H &quot;Content-Type: application/json&quot; \
-d '&#123;
  &quot;alerts&quot;: [
    &#123;
      &quot;status&quot;: &quot;firing&quot;,
      &quot;labels&quot;: &#123;
        &quot;severity&quot;: &quot;critical&quot;,
        &quot;alertname&quot;: &quot;InstanceDown&quot;,
        &quot;instance&quot;: &quot;example1&quot;
      &#125;,
      &quot;annotations&quot;: &#123;
        &quot;summary&quot;: &quot;Instance example1 down&quot;,
        &quot;description&quot;: &quot;The instance example1 is down.&quot;
      &#125;,
      &quot;startsAt&quot;: &quot;2024-12-20T15:04:05Z&quot;,
      &quot;endsAt&quot;: &quot;0001-01-01T00:00:00Z&quot;
    &#125;,
   &#123;
      &quot;status&quot;: &quot;resolved&quot;,
      &quot;labels&quot;: &#123;
        &quot;severity&quot;: &quot;critical&quot;,
        &quot;alertname&quot;: &quot;InstanceDown&quot;,
        &quot;instance&quot;: &quot;example1&quot;
      &#125;,
      &quot;annotations&quot;: &#123;
        &quot;summary&quot;: &quot;Instance example1 is back up&quot;,
        &quot;description&quot;: &quot;The instance example1 has recovered.&quot;
      &#125;,
      &quot;startsAt&quot;: &quot;2024-12-20T15:04:05Z&quot;,
      &quot;endsAt&quot;: &quot;2024-12-20T16:04:05Z&quot;
    &#125;
  ]
&#125;'
</code></pre><p>4、检查企业微信结果</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306211653486.png" alt="image-20240306211653486"></p><p>5、配置 AlertManager 对接 webhook_wechat</p><pre><code>[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: 'smtp.qq.com:25'
  smtp_from: '373370405@qq.com'  # 发件人邮件
  smtp_auth_username: '373370405@qq.com'  # 发件人用户名
  smtp_auth_password: 'jmtpwlkuijaybhic' # 发件人密码[授权码]
  smtp_hello: 'qq.com'
  smtp_require_tls: false

# 加载模板文件
templates:
  - '/etc/alertmanager/template/email.tmpl'
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: ['alertname'] # 告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s     # 当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m  # 已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m # 如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: webhook-wechat-ops   # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器
  
receivers:
- name: 'webhook-wechat-ops'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:5001/alert?token=47ffbdd9-4308-4db0-aa08-f309546cc92d'  #http://&lt;你的服务器地址&gt;:5001/alert?token=&lt;企业微信机器人token&gt;'

- name: 'default'
  email_configs:
  - to: '373370405@qq.com'
    send_resolved: true # 接受告警恢复的通知
    html: '&#123;&#123; template "email.html" . &#125;&#125;' # 发送邮件内容，调用该模板进行渲染
</code></pre><p>6、检查 AlertManager 的配置⽂件是否正确</p><pre><code>[root@prom-node01 ~]# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml
Checking '/etc/alertmanager/alertmanager.yml'  SUCCESS
Found:
 - global config
 - route
 - 0 inhibit rules
 - 1 receivers
 - 1 templates
  SUCCESS
</code></pre><p>7、重新加载 AlertManager</p><pre><code>[root@prom-node01 ~]#  curl -X POST http://localhost:9093/-/reload
</code></pre><p>8、触发告警，验证是否能通过企业微信收到消息</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306212303561.png" alt="image-20240306212303561"></p><h5 id="32-配置alert对接钉钉告警"><a class="anchor" href="#32-配置alert对接钉钉告警">#</a> 3.2 配置 Alert 对接钉钉告警</h5><p>钉钉告警可以是⽤ Prometheus-webhook-dingtalk ⼯具，github 地址 <a target="_blank" rel="noopener" href="https://github.com/timonwong/prometheus-webhook-dingtalk">https://github.com/timonwong/prometheus-webhook-dingtalk</a> 。但在此处，我们使⽤的是⾃⼰开发的 webhook 程序来对接钉钉， Prometheus--&gt;AlertManager--&gt; ⾃定义 Webhook 程序 --&gt; 钉钉机器⼈ --&gt; 通知给对应的群组</p><ul><li>1、访问钉钉开发者后台： <a target="_blank" rel="noopener" href="https://open-dev.dingtalk.com/">https://open-dev.dingtalk.com/</a></li><li>2、点击应⽤开发，然后创建机器⼈（使⽤旧版），填写机器⼈名称，然后找到创建的机器⼈（版本管理与发布，点击上线），该机器⼈就可以添加到群组。</li><li>3、发起群聊（添加两个⽤户），然后创建⼀个普通群，群归属为个⼈。</li><li>4、紧接着找到对应的群，点击群类型，必须转为 “内部群”，然后在智能群助⼿中添加机器⼈，找到此前在钉钉开发者平台创建的机器⼈添加即可。</li><li>5、最后点击机器⼈，获取对应的 Token 令牌。</li></ul><pre><code>https://oapi.dingtalk.com/robot/send?access_token=49989606592d7ff06ee4b83120bf5a81ed1e4c3860696dcd7e663be1c66ef43f
</code></pre><p>1、下载并运⾏ webhook_dingding</p><pre><code>[root@prom-node01 ~]# wget http://file.oldxu.net/prometheus/Alert/webhook_dingding_oldxu
[root@prom-node01 ~]# mv webhook_dingding_oldxu /usr/local/bin/
[root@prom-node01 ~]# chmod +x /usr/local/bin/webhook_dingding_oldxu
</code></pre><p>2、编辑启动脚本⽂件</p><pre><code>[root@prom-node01 ~]# cat /usr/lib/systemd/system/webhook_dingding.service
[Unit]
Description=webhook_dingding
Documentation=https://prometheus.io/
After=network.target

[Service]
ExecStart=/usr/local/bin/webhook_dingding_oldxu --port 5002
ExecReload=/bin/kill -HUP
TimeoutStopSec=20s
Restart=always

[Install]
WantedBy=multi-user.target

[root@prom-node01 ~]# systemctl daemon-reload
[root@prom-node01 ~]# systemctl start webhook_dingding
[root@prom-node01 ~]# systemctl enable webhook_dingding 
[root@prom-node01 ~]# netstat -lntp|grep 5002
tcp6       0      0 :::5002                 :::*                    LISTEN      3141/webhook_dingdi 
</code></pre><p>3、测试 webhook_wechat 能否正确发送消息到钉钉（注意端⼝是 5002）</p><pre><code>[root@prom-node01 ~]# curl -X POST http://localhost:5001/alert?token=47ffbdd9-4308-4db0-aa08-f309546cc92d \
-H &quot;Content-Type: application/json&quot; \
-d '&#123;
  &quot;alerts&quot;: [
    &#123;
      &quot;status&quot;: &quot;firing&quot;,
      &quot;labels&quot;: &#123;
        &quot;severity&quot;: &quot;critical&quot;,
        &quot;alertname&quot;: &quot;InstanceDown&quot;,
        &quot;instance&quot;: &quot;example1&quot;
      &#125;,
      &quot;annotations&quot;: &#123;
        &quot;summary&quot;: &quot;Instance example1 down&quot;,
        &quot;description&quot;: &quot;The instance example1 is down.&quot;
      &#125;,
      &quot;startsAt&quot;: &quot;2024-12-20T15:04:05Z&quot;,
      &quot;endsAt&quot;: &quot;0001-01-01T00:00:00Z&quot;
    &#125;,
   &#123;
      &quot;status&quot;: &quot;resolved&quot;,
      &quot;labels&quot;: &#123;
        &quot;severity&quot;: &quot;critical&quot;,
        &quot;alertname&quot;: &quot;InstanceDown&quot;,
        &quot;instance&quot;: &quot;example1&quot;
      &#125;,
      &quot;annotations&quot;: &#123;
        &quot;summary&quot;: &quot;Instance example1 is back up&quot;,
        &quot;description&quot;: &quot;The instance example1 has recovered.&quot;
      &#125;,
      &quot;startsAt&quot;: &quot;2024-12-20T15:04:05Z&quot;,
      &quot;endsAt&quot;: &quot;2024-12-20T16:04:05Z&quot;
    &#125;
  ]
&#125;'
</code></pre><p>4、检查企业微信结果</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306214425736.png" alt="image-20240306214425736"></p><p>5、配置 AlertManager 对接 webhook_dingding</p><pre><code>[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: 'smtp.qq.com:25'
  smtp_from: '373370405@qq.com'  # 发件人邮件
  smtp_auth_username: '373370405@qq.com'  # 发件人用户名
  smtp_auth_password: 'jmtpwlkuijaybhic' # 发件人密码[授权码]
  smtp_hello: 'qq.com'
  smtp_require_tls: false

# 加载模板文件
templates:
  - '/etc/alertmanager/template/email.tmpl'
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: ['alertname'] # 告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s     # 当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m  # 已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m # 如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: webhook-dingding-ops   # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器
  
receivers:
- name: 'webhook-wechat-ops'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:5001/alert?token=47ffbdd9-4308-4db0-aa08-f309546cc92d'  #http://&lt;你的服务器地址&gt;:5001/alert?token=&lt;企业微信机器人token&gt;'

- name: 'webhook-dingding-ops'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:5002/alert?token=49989606592d7ff06ee4b83120bf5a81ed1e4c3860696dcd7e663be1c66ef43f'  #http://&lt;你的服务器地址&gt;:5002/alert?token=&lt;钉钉机器人access_token&gt;'

- name: 'default'
  email_configs:
  - to: '373370405@qq.com'
    send_resolved: true # 接受告警恢复的通知
    html: '&#123;&#123; template "email.html" . &#125;&#125;' # 发送邮件内容，调用该模板进行渲染
</code></pre><p>6、检查 AlertManager 的配置⽂件是否正确</p><pre><code>[root@prom-node01 ~]# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml
Checking '/etc/alertmanager/alertmanager.yml'  SUCCESS
Found:
 - global config
 - route
 - 0 inhibit rules
 - 3 receivers
 - 1 templates
  SUCCESS
</code></pre><p>7、重新加载 AlertManager</p><pre><code>[root@prom-node01 ~]#  curl -X POST http://localhost:9093/-/reload
</code></pre><p>8、触发告警，验证是否能通过企业微信收到消息</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306214829806.png" alt="image-20240306214829806"></p><h4 id="四-alertmanager告警路由"><a class="anchor" href="#四-alertmanager告警路由">#</a> 四. AlertManager 告警路由</h4><h5 id="41-告警路由介绍"><a class="anchor" href="#41-告警路由介绍">#</a> 4.1 告警路由介绍</h5><p>所谓的告警路由，就是将不同的告警消息转发给不同的接收⼈，以便故障能快速的被处理和解决。</p><p>Alertmanager 的告警路由配置，使⽤的是树状结构来定义，以确保每条告警消息都能够按照定义好的路径进⾏处理。当⼀条告警消息进来后，会先进⼊根路由，然后逐级的去匹配每个⼦路由的规则，然后将消息通过媒介发送给对应的接收⼈。</p><p>例如，我们可以设置⼀个规则，将标签 severity 级别为 critical 的告警发送到钉钉，⽽剩余其他的告警则全部发送给微信。</p><p><strong>AlertManager 告警路由场景示例：</strong></p><ul><li>1、mysql_exporter 和 redis_exporter 的 Job 告警时，就将其发送给 “钉钉的 DBA 团队”。</li><li>2、node_exporter 的 Job 告警时，则将告警路由到 “钉钉的 OPS 团队”。</li><li>3、最后，如果告警消息不符合上述任何⼀个规则，它们将默认通过微信发送给 “企业微信运维团队”。</li></ul><h5 id="42-告警路由实践"><a class="anchor" href="#42-告警路由实践">#</a> 4.2 告警路由实践</h5><p>1、配置 AlertManager，添加⼦路由规则</p><pre><code>[root@prom-node01 data]# cat  /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: 'smtp.qq.com:25'
  smtp_from: '373370405@qq.com'  # 发件人邮件
  smtp_auth_username: '373370405@qq.com'  # 发件人用户名
  smtp_auth_password: 'jmtpwlkuijaybhic' # 发件人密码[授权码]
  smtp_hello: 'qq.com'
  smtp_require_tls: false

# 加载模板文件
templates:
  - '/etc/alertmanager/template/email.tmpl'
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: ['alertname'] # 告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s     # 当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m  # 已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m # 如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: email   # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器

  # 子路由匹配规则
  routes:
  - match_re:
      job: '(mysql.*|redis.*)'
    receiver: 'webhook-wechat-ops'
    continue: true

  - match_re:
      job: 'node.*'
    receiver: 'webhook-dingding-ops'
    continue: true

receivers:
- name: 'webhook-wechat-ops'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:5001/alert?token=47ffbdd9-4308-4db0-aa08-f309546cc92d'  #http://&lt;你的服务器地址&gt;:5001/alert?token=&lt;企业微信机器人token&gt;'

- name: 'webhook-dingding-ops'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:5002/alert?token=49989606592d7ff06ee4b83120bf5a81ed1e4c3860696dcd7e663be1c66ef43f'  #http://&lt;你的服务器地址&gt;:5002/alert?token=&lt;钉钉机器人access_token&gt;'

- name: 'email'
  email_configs:
  - to: '373370405@qq.com'
    send_resolved: true # 接受告警恢复的通知
    html: '&#123;&#123; template "email.html" . &#125;&#125;' # 发送邮件内容，调用该模板进行渲染
</code></pre><p>2、检查语法，并重新加载 AlertManager</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 data<span class="token punctuation">]</span><span class="token comment"># /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Checking <span class="token string">'/etc/alertmanager/alertmanager.yml'</span>  SUCCESS</pre></td></tr><tr><td data-num="3"></td><td><pre>Found:</pre></td></tr><tr><td data-num="4"></td><td><pre> - global config</pre></td></tr><tr><td data-num="5"></td><td><pre> - route</pre></td></tr><tr><td data-num="6"></td><td><pre> - <span class="token number">0</span> inhibit rules</pre></td></tr><tr><td data-num="7"></td><td><pre> - <span class="token number">3</span> receivers</pre></td></tr><tr><td data-num="8"></td><td><pre> - <span class="token number">1</span> templates</pre></td></tr><tr><td data-num="9"></td><td><pre>  SUCCESS</pre></td></tr><tr><td data-num="10"></td><td><pre>  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 data<span class="token punctuation">]</span><span class="token comment">#  curl -X POST http://localhost:9093/-/reload</span></pre></td></tr></table></figure><h5 id="43-告警路由验证"><a class="anchor" href="#43-告警路由验证">#</a> 4.3 告警路由验证</h5><p>1、触发 mysql 和 redis 的告警，验证钉钉 - DBA 团队是否能收到告警消息</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop mysqld_exporter.service redis_exporter.service</span></pre></td></tr></table></figure><p>2、触发 node 相关的告警，验证钉钉 - OPS 团队是否能收到告警消息</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node02 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop node_exporter.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop node_exporter.service</span></pre></td></tr></table></figure><p>3、触发 nginx 相关的告警，验证微信运维团队是否能收到告警消息</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop nginx_exporter.service</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/Prometheus/" rel="tag"><i class="ic i-tag"></i>Prometheus</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/posts/4081185382.html">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2025-06-30 21:41:46" itemprop="dateModified" datetime="2025-06-30T21:41:46+08:00">2025-06-30</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Xu Yong 微信支付"><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Xu Yong 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Xu Yong<i class="ic i-at"><em>@</em></i>LinuxSre云原生</li><li class="link"><strong>本文链接：</strong><a href="http://ixuyong.cn/posts/4081185382.html" title="Prometheus监控实战（四）">http://ixuyong.cn/posts/4081185382.html</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/posts/4081185381.html" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;o1ceeNN.jpeg" title="Prometheus监控实战（三）"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Prometheus</span><h3>Prometheus监控实战（三）</h3></a></div><div class="item right"><a href="/posts/2041568856.html" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;el5JHV9.jpeg" title="Prometheus监控Kubernetes"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>Prometheus</span><h3>Prometheus监控Kubernetes</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus%E5%91%8A%E8%AD%A6%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">Prometheus 告警服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-aleartmanager%E9%83%A8%E7%BD%B2"><span class="toc-number">1.1.</span> <span class="toc-text">一. AleartManager 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#11-aleartmanager%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 AleartManager 安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-aleartmanager%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 AleartManager 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#13-alertmanager%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 AlertManager 启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#14-alertmanager%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 AlertManager 测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-prometheus%E5%AF%B9%E6%8E%A5aleartmanager"><span class="toc-number">1.2.</span> <span class="toc-text">二. Prometheus 对接 AleartManager</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-%E9%85%8D%E7%BD%AEprom%E5%AF%B9%E6%8E%A5aleartmanager"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 配置 Prom 对接 AleartManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-%E9%85%8D%E7%BD%AEprometheus%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 配置 Prometheus 告警规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23-%E9%85%8D%E7%BD%AEprometheus%E5%8A%A0%E8%BD%BD%E8%A7%84%E5%88%99"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 配置 Prometheus 加载规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-%E8%A7%A6%E5%8F%91%E8%A7%84%E5%88%99%E5%B9%B6%E9%AA%8C%E8%AF%81%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 触发规则并验证告警通知</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#25-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.5 ⾃定义邮件告警模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-alertmanager%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">三. AlertManager 告警通知⽅式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#31-%E9%85%8D%E7%BD%AEalert%E5%AF%B9%E6%8E%A5%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 配置 Alert 对接微信告警</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#32-%E9%85%8D%E7%BD%AEalert%E5%AF%B9%E6%8E%A5%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 配置 Alert 对接钉钉告警</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B-alertmanager%E5%91%8A%E8%AD%A6%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.</span> <span class="toc-text">四. AlertManager 告警路由</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#41-%E5%91%8A%E8%AD%A6%E8%B7%AF%E7%94%B1%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 告警路由介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#42-%E5%91%8A%E8%AD%A6%E8%B7%AF%E7%94%B1%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 告警路由实践</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#43-%E5%91%8A%E8%AD%A6%E8%B7%AF%E7%94%B1%E9%AA%8C%E8%AF%81"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 告警路由验证</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/posts/1595025559.html" rel="bookmark" title="Prometheus监控实战（一）">Prometheus监控实战（一）</a></li><li><a href="/posts/3386060324.html" rel="bookmark" title="PromQL快速入门（二）">PromQL快速入门（二）</a></li><li><a href="/posts/4081185381.html" rel="bookmark" title="Prometheus监控实战（三）">Prometheus监控实战（三）</a></li><li class="active"><a href="/posts/4081185382.html" rel="bookmark" title="Prometheus监控实战（四）">Prometheus监控实战（四）</a></li><li><a href="/posts/2041568856.html" rel="bookmark" title="Prometheus监控Kubernetes">Prometheus监控Kubernetes</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Xu Yong" src="/assets/avatar.png"><p class="name" itemprop="name">Xu Yong</p><div class="description" itemprop="description">专注于 Linux 运维、云计算、云原⽣等技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">48</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">15</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">18</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/xyapples" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;xyapples"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://gitee.com/chinagei" class="item gitee" title="https:&#x2F;&#x2F;gitee.com&#x2F;chinagei"><i class="ic i-gitee"></i></a><a href="mailto:373370405@qq.com" class="item email" title="mailto:373370405@qq.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-about"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/posts/2041568856.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/posts/4081185381.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Tomcat/" title="分类于Tomcat">Tomcat</a></div><span><a href="/posts/754945111.html">Tomcat JVM调优实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/DevOps/" title="分类于DevOps">DevOps</a></div><span><a href="/posts/1366748664.html">K8S基于Jenkins实现Java项目CI与CD实践（二）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Openvpn/" title="分类于Openvpn">Openvpn</a></div><span><a href="/posts/2126514413.html">虚拟隧道网络Openvpn</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Prometheus/" title="分类于Prometheus">Prometheus</a></div><span><a href="/posts/3386060324.html">PromQL快速入门（二）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/MySQL/" title="分类于MySQL">MySQL</a></div><span><a href="/posts/2628187572.html">MySQL运维DBA应用与实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/176412055.html">K8s准入控制ResourceQuota、LimitRange、QoS服务质量</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于Linux">Linux</a></div><span><a href="/posts/2260957686.html">Linux—Centos7修改网卡名称</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ELKStack/" title="分类于ELKStack">ELKStack</a></div><span><a href="/posts/570469260.html">ELK收集Kubernetes组件日志分析与实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于Linux">Linux</a></div><span><a href="/posts/269104229.html">Samba服务实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/LVS/" title="分类于LVS">LVS</a></div><span><a href="/posts/1598774589.html">负载均衡LVS入门与实践</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Xu Yong @ LinuxSre云原生</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.5m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">22:19</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `posts/4081185382.html`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hrmmi -->