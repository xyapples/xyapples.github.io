<!-- build time:Sun Jul 27 2025 21:57:54 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico"><link rel="alternate" href="/rss.xml" title="LinuxSre云原生" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="LinuxSre云原生" type="application/atom+xml"><link rel="alternate" type="application/json" title="LinuxSre云原生" href="http://ixuyong.cn/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.17"><link rel="modulepreload" href="/js/chunk-GV364XSK.js"><link rel="modulepreload" href="/js/chunk-NYSE5UKM.js"><link rel="modulepreload" href="/js/chunk-RONCYO2S.js"><link rel="modulepreload" href="/js/chunk-THHXCRSX.js"><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/js/comments-DL2IYMPZ.js"><link rel="modulepreload" href="/js/copy-tex-NADCTXPG.js"><link rel="modulepreload" href="/js/post-DA635IH6.js"><link rel="modulepreload" href="/js/quicklink-WEDHL4BA.js"><link rel="modulepreload" href="/js/search-VCZRKTM5.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/waline-NNBYRQEE.js"><link rel="stylesheet" href="/css/comments-F4ZGS7LD.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/waline-IDNZKML2.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="preload" href="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" as="image" fetchpriority="high"><meta name="keywords" content="Prometheus"><meta name="description" content="专注于 Linux 运维、云计算、云原⽣等技术"><link rel="canonical" href="http://ixuyong.cn/posts/4081185382.html"><title>Prometheus监控实战（四）</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Prometheus监控实战（四）</h1><div class="meta"><span class="item" title="创建时间：2025-07-13 22:03:48"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-07-13T22:03:48+08:00">2025-07-13</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>51k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>46 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">LinuxSre云原生</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" loading="eager" decoding="async" fetchpriority="high" alt="LinuxSre云原生"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Prometheus/" itemprop="item" rel="index" title="分类于Prometheus"><span itemprop="name">Prometheus<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://ixuyong.cn/posts/4081185382.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"><meta itemprop="name" content="Xu Yong"><meta itemprop="description" content="致力于技术布道、普及前沿技术、打造云原生系列标杆博客, 专注于 Linux 运维、云计算、云原⽣等技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LinuxSre云原生"></span><div class="body md" itemprop="articleBody"><h3 id="prometheus告警服务"><a class="anchor" href="#prometheus告警服务">#</a> <strong>Prometheus 告警服务</strong></h3><h4 id="一-什么是aleartmanager"><a class="anchor" href="#一-什么是aleartmanager">#</a> 一。什么是 AleartManager</h4><h5 id="11-什么是-aleartmanager"><a class="anchor" href="#11-什么是-aleartmanager">#</a> 1.1 什么是 AleartManager</h5><p>由于 Prometheus 本身⽆法实现告警，因此需要借助 AlertManager 来实现告警的推送。</p><p>Prometheus Server 会对已经设定好的 “告警规则” 进⾏定期评估，当检测到问题时，会⽣成相应的告警通知并发送给 AlertManager。AlertManager 则会根据告警消息所携带的 “标签” 和事先配置的 “路由规则（Routes）”，将告警消息分发⾄不同的接收器 / 接收⼈（receivers）。例如，带有 &quot;system&quot; 标签的告警会通过 Email 发送给运维团队，⽽带有 &quot;database&quot; 标签的告警则通过 WeChat 发给数据库团队。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/UsACANX.jpeg" alt="1.jpg"></p><p>prometheus---&gt; 评估规则 ---&gt; 持续满⾜触发条件 ---&gt; 触发告警 ---&gt;alertmanager---&gt; 根据路由规则匹配标签 --&gt; 通过不同的媒介 ---&gt; 发送不</p><p>同的接收⼈（邮件 | 钉钉 | 微信）。</p><h5 id="12-aleartmanager特性"><a class="anchor" href="#12-aleartmanager特性">#</a> 1.2 AleartManager 特性</h5><p>除了基本的告警通知能⼒外，Altermanager 还⽀持对告警进⾏去重、分组、抑制、 静默和路由等功能：</p><p>1、去重：prometheus ⼀条报警发送给多个 AlertManager，AlertManager 会对其进⾏去重并发送。</p><p>2、分组（Group）：将相似告警合并为单个告警发送，在系统因⼤⾯积故障⽽触发告警潮时，分组机制能避免⽤户被⼤量的告警淹没，进⽽导致关键信息的隐没；</p><p>例如：我们可能会使⽤ Prometheus 中的 up 指标来检测每台主机的存活状态。如果某台主机不可达，Prometheus 将会为这台主机⽣成⼀个 InstanceDown 的告警。如果多台主机同时出现不存活的问题，那么就会收到⼀连串的告警邮件，每个告警信息都是⼀个独⽴的事件，这样就⽐较难以区分哪些告警是最紧急的。⽽ Alertmanager 的分组功能它允许你定义合并的规则，例如将 alertname 相同的告警合并在⼀起，发送单⼀的通知。这意味着，如果多台主机同时出现不存活的情况，Alertmanager 会将消息合并为⼀个通知发送出去，其中包含受影响的所有主机的信息，⽽不是通知每个主机的故障。</p><p>3、路由（route）：它负责决定告警的分发逻辑。它通过检查告警的属性，使⽤ “预定义的匹配规则” 来判断告警的类别，然后根据这些规则把告警发送到合适的接收器</p><p>例如：我们使⽤ Prometheus 监控了很多服务，包括数据库、web、⽀付系统等。⽽不同类型的服务故障需要通知到不同的团队，这样问题才能得到快速的解决。像数据库问题需要通知 DBA 团队，⽽应⽤层⾯的问题需要通知给运维团队。在 Alertmanager 中，可以为不同类型的告警，设置不同的接收器（receivers），Alertmanager 路由规则会将告警发送到对应的接收器，确保消息能正确的通知到不同的团队。</p><p>4、静默（Silence）：是指在⼀个特定的时间窗⼝内，即便接收到告警通知，Alertmanager 也不会真正向⽤户发送告警信息</p><p>例如：在系统维护或升级过程中，通常会触发⼤量的告警。这些告警往往是维护系统的过程中引起的，⽽⾮真正出现了故障。如果我们不对告警通知进⾏调整，将会收到⼤量的告警信息，造成不必要的⼲扰。为了应对这种情况，在维护期间，我们可以在 Alertmanager 中设置静默（silence）规则。这些规则能够禁⽌对外发送告警通知。等到维护⼯作完成后，我们再取消静默规则，恢复正常的告警通知流程。这样可以保证告警系统的有效性，同时避免了在维护期间产⽣⼤量不必要的告警信息。</p><p>5、抑制（Inhibition）：是⼀种告警管理机制，⽤以减少因组件故障导致的连锁告警。当⼀个核⼼组件发⽣故障时，依赖它的其他组件或服务也可能产⽣告警。启⽤抑制功能后，系统将⾃动抑制这些级联的次要告警，从⽽让⽤户将精⼒集中于真正的故障所在。</p><p>例如：当⼀台主机宕机，主机之上的所有应⽤也会随之宕机，每个应⽤异常都会单独发送告警，从⽽导致告警数量激增。为避免告警泛滥，我们可以通过告警抑制功能来设置告警规则：在主机宕机的情况下，抑制所有由主机引起的其他应⽤的告警。 仅关注主机本身的告警信息。这样我们就能更快的定位到根本的问题并解决该问题。</p><p>6、⾼可⽤（High Availability）：AlertManager 可以使⽤ gossip 留⾔协议实现⾼可⽤性；</p><h5 id="13-alertmanager配置说明"><a class="anchor" href="#13-alertmanager配置说明">#</a> 1.3 AlertManager 配置说明</h5><p>Alertmanager 负责对 Prometheus ⽣成的告警进⾏统⼀处理。常⻅的配置分为以下⼏个主要部分：</p><ul><li>1、全局配置 (global): 定义了全局通⽤的参数。例如：（ SMTP 配置（⽤于邮件通知）、Slack 配置（⽤于 Slack 通知）、以及其他第三⽅服务的配置）</li><li>2、模板 (templates): 定义告警通知时使⽤的模板。例如：（HTML 模板、邮件模板）</li><li>3、告警路由 (route): 根据告警的标签进⾏匹配，确定分组逻辑，以及告警通知给谁。</li><li>4、接收⼈ (receivers): 接收⼈可以是邮箱、微信、Slack、Webhook 等。配合告警路由使⽤，确保告警通知到达正确的⽬的地。</li><li>5、抑制规则 (inhibit_rules): 通过设置抑制规则来减少不必要的告警，避免告警泛滥。</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>global:</pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment"># 已经触发了告警的消息，在多⻓时间内没有收到该告警的消息，则会⾃动将该告警标记为已解决。默认值是 5 分钟。</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token punctuation">[</span> resolve_timeout: <span class="token operator">&lt;</span>duration<span class="token operator">></span> <span class="token operator">|</span> default <span class="token operator">=</span> 5m <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre> </pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment"># 邮件配置</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">[</span> smtp_from: <span class="token operator">&lt;</span>tmpl_string<span class="token operator">></span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">[</span> smtp_smarthost: <span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">[</span> smtp_hello: <span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token operator">|</span> default <span class="token operator">=</span> <span class="token string">"localhost"</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">[</span> smtp_auth_username: <span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">[</span> smtp_auth_password: <span class="token operator">&lt;</span>secret<span class="token operator">></span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">[</span> smtp_auth_identity: <span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">[</span> smtp_auth_secret: <span class="token operator">&lt;</span>secret<span class="token operator">></span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">[</span> smtp_require_tls: <span class="token operator">&lt;</span>bool<span class="token operator">></span> <span class="token operator">|</span> default <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre> </pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment"># 其他全局配置...</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">[</span> wechat_api_url: <span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token operator">|</span> default <span class="token operator">=</span> <span class="token string">"https://qyapi.weixin.qq.com/cgi␂bin/"</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">[</span> wechat_api_secret: <span class="token operator">&lt;</span>secret<span class="token operator">></span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">[</span> wechat_api_corp_id: <span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># 模板配置</span></pre></td></tr><tr><td data-num="21"></td><td><pre>templates:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment"># 路径到告警模板⽂件</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">[</span> - <span class="token operator">&lt;</span>filepath<span class="token operator">></span> <span class="token punctuation">..</span>. <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  </pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># 告警路由</span></pre></td></tr><tr><td data-num="26"></td><td><pre>route:</pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment"># 告警的⼦路由配置</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token operator">&lt;</span>route<span class="token operator">></span></pre></td></tr><tr><td data-num="29"></td><td><pre>    </pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># 定义接收告警的接收⼈或服务</span></pre></td></tr><tr><td data-num="31"></td><td><pre>receivers:</pre></td></tr><tr><td data-num="32"></td><td><pre>  - <span class="token operator">&lt;</span>receiver<span class="token operator">></span> <span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="33"></td><td><pre>  </pre></td></tr><tr><td data-num="34"></td><td><pre>inhibit_rules:</pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment"># 抑制规则，⽤于减少告警噪声</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token punctuation">[</span> - <span class="token operator">&lt;</span>inhibit_rule<span class="token operator">></span> <span class="token punctuation">..</span>. <span class="token punctuation">]</span></pre></td></tr></table></figure><h4 id="二-aleartmanager部署"><a class="anchor" href="#二-aleartmanager部署">#</a> 二. AleartManager 部署</h4><h5 id="21-aleartmanager安装"><a class="anchor" href="#21-aleartmanager安装">#</a> 2.1 AleartManager 安装</h5><p>1、访问 AlertManager 的 github，获取 AlertManager 的下载地址， <a target="_blank" rel="noopener" href="https://github.com/prometheus/alertmanager/releases">https://github.com/prometheus/alertmanager/releases</a></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 下载 AlertManager</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 加速地址</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.ghproxy.com/https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#2. 解压 AlertManager</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># tar xf alertmanager-0.26.0.linux-amd64.tar.gz -C /etc/</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/alertmanager-0.26.0.linux-amd64/ /etc/alertmanager</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#3. 查看 AlertManager ⽬录结构</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># ll /etc/alertmanager/</span></pre></td></tr><tr><td data-num="13"></td><td><pre>total <span class="token number">62504</span></pre></td></tr><tr><td data-num="14"></td><td><pre>-rwxr-xr-x <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span> <span class="token number">35410965</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> alertmanager</pre></td></tr><tr><td data-num="15"></td><td><pre>-rw-r--r-- <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span>      <span class="token number">356</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> alertmanager.yml</pre></td></tr><tr><td data-num="16"></td><td><pre>-rwxr-xr-x <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span> <span class="token number">28566971</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> amtool</pre></td></tr><tr><td data-num="17"></td><td><pre>-rw-r--r-- <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span>    <span class="token number">11357</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> LICENSE</pre></td></tr><tr><td data-num="18"></td><td><pre>-rw-r--r-- <span class="token number">1</span> <span class="token number">3434</span> <span class="token number">3434</span>      <span class="token number">457</span> Aug <span class="token number">24</span>  <span class="token number">2023</span> NOTICE</pre></td></tr></table></figure><h5 id="22-aleartmanager配置"><a class="anchor" href="#22-aleartmanager配置">#</a> 2.2 AleartManager 配置</h5><p>1、定义的配置⽂件，设定发件⼈的邮箱，以及路由匹配规则，和接收⼈ （group_wait 与 group_interval 区别）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cp /etc/alertmanager/alertmanager.yml /etc/alertmanager/alertmanager.yml.bak</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  resolve_timeout: 2h    <span class="token comment"># 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  smtp_smarthost: <span class="token string">'smtp.qq.com:587'</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  smtp_from: <span class="token string">'373370405@qq.com'</span>  <span class="token comment"># 发件人邮件</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  smtp_auth_username: <span class="token string">'373370405@qq.com'</span>  <span class="token comment"># 发件人用户名</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  smtp_auth_password: <span class="token string">'******'</span> <span class="token comment"># 发件人密码 [授权码]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  smtp_hello: <span class="token string">'qq.com'</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  smtp_require_tls: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="11"></td><td><pre> </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 所有报警信息进入后的根路由，用来设置报警的分发策略</span></pre></td></tr><tr><td data-num="13"></td><td><pre>route:</pre></td></tr><tr><td data-num="14"></td><td><pre>  group_by: <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">]</span> <span class="token comment">#告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  group_wait: 30s         <span class="token comment">#当一组新告警产生时，系统会等待 30 秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的 30s 内会有新的同校学生上车）</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  group_interval: 1m     <span class="token comment">#已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少 1 分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  repeat_interval: 5m  <span class="token comment">#如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  receiver: default    <span class="token comment">#默认的 receiver：如果一个报警没有被一个 route 匹配，则发送给默认的接收器</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  </pre></td></tr><tr><td data-num="20"></td><td><pre>receivers:</pre></td></tr><tr><td data-num="21"></td><td><pre>- name: <span class="token string">'default'</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  email_configs:</pre></td></tr><tr><td data-num="23"></td><td><pre>  - to: <span class="token string">'373370405@qq.com'</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    send_resolved: <span class="token boolean">true</span> <span class="token comment"># 接受告警恢复的通知</span></pre></td></tr></table></figure><p>2、检查 AlertManager 的配置⽂件是否正确</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Checking <span class="token string">'/etc/alertmanager/alertmanager.yml'</span>  SUCCESS</pre></td></tr><tr><td data-num="3"></td><td><pre>Found:</pre></td></tr><tr><td data-num="4"></td><td><pre> - global config</pre></td></tr><tr><td data-num="5"></td><td><pre> - route</pre></td></tr><tr><td data-num="6"></td><td><pre> - <span class="token number">0</span> inhibit rules</pre></td></tr><tr><td data-num="7"></td><td><pre> - <span class="token number">1</span> receivers</pre></td></tr><tr><td data-num="8"></td><td><pre> - <span class="token number">0</span> templates</pre></td></tr></table></figure><h5 id="23-alertmanager启动"><a class="anchor" href="#23-alertmanager启动">#</a> 2.3 AlertManager 启动</h5><p>1、配置 system 管理 alertmanager 启动和停⽌</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/alertmanager.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>alertmanager</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/etc/alertmanager/alertmanager <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  --web.listen-address<span class="token operator">=</span>:9093 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token parameter variable">--config.file</span><span class="token operator">=</span>/etc/alertmanager/alertmanager.yml <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token parameter variable">--storage.path</span><span class="token operator">=</span>/etc/alertmanager/data <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token parameter variable">--data.retention</span><span class="token operator">=</span>120h</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable alertmanager &amp;&amp; systemctl start alertmanager</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 9093</span></pre></td></tr><tr><td data-num="23"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::9093                 :::*                    LISTEN      <span class="token number">2648</span>/alertmanager</pre></td></tr></table></figure><p>2、访问 alertmanager，通过 <a target="_blank" rel="noopener" href="http://IP:9093">http://IP:9093</a> 访问</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/yuWRORp.png" alt="image-20240305221644642.png"></p><h5 id="24-alertmanager测试"><a class="anchor" href="#24-alertmanager测试">#</a> 2.4 AlertManager 测试</h5><p>1、使⽤ Go 编写的告警测试⼯具来验证告警合并功能。发送具有相同 alertname 名称，但不同内容的告警，以验证 AlertManager 是否会将它们合并成⼀个组。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下载告警程序</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/prometheus/Alert/alert_test_oldxu</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x alert_test_oldxu</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># docker run -it --rm -v `pwd`:/app/program ubuntu</span></pre></td></tr><tr><td data-num="5"></td><td><pre>root@4c83c1816d0b:/<span class="token comment"># cd /app/program/</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># alertname=nodedown（--alertURL 指定 alertmanager 服务器所在的地址、端⼝以及接⼝）</span></pre></td></tr><tr><td data-num="8"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=nodedown,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=nodedown,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># alertname=cpuhigh</span></pre></td></tr><tr><td data-num="12"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=cpuhigh,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=cpuhigh,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr></table></figure><p>2、验证结果，会发现 AlertManager 是根据 group_by 中定义的 alertname 将告警信息进⾏分组，这样能够有效避免了消息重复通知。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/wfEmqC2.jpeg" alt="2.jpg"></p><p>3、登录邮件查看告警信息，理想的结果是收到两封电⼦邮件通知，每封包含两条关联告警，⽽⾮四封单独的邮件。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/Kokh438.jpeg" alt="1.jpg"></p><h4 id="三-prometheus对接aleartmanager"><a class="anchor" href="#三-prometheus对接aleartmanager">#</a> 三. Prometheus 对接 AleartManager</h4><h5 id="31-配置prom对接aleartmanager"><a class="anchor" href="#31-配置prom对接aleartmanager">#</a> 3.1 配置 Prom 对接 AleartManager</h5><p>1、编辑 prometheus.yml ⽂件，然后将告警接⼊⾄ AlertManager 组件；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># Alertmanager 配置</span></pre></td></tr><tr><td data-num="7"></td><td><pre>alerting:</pre></td></tr><tr><td data-num="8"></td><td><pre>  alertmanagers:</pre></td></tr><tr><td data-num="9"></td><td><pre>  - static_configs:</pre></td></tr><tr><td data-num="10"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9093"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>2、由于 AlertManager 也对外提供了 Metrics 接⼝，我们可以直接将 AlertManager 纳⼊监控中来；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># Alertmanager 配置</span></pre></td></tr><tr><td data-num="7"></td><td><pre>alerting:</pre></td></tr><tr><td data-num="8"></td><td><pre>  alertmanagers:</pre></td></tr><tr><td data-num="9"></td><td><pre>  - static_configs:</pre></td></tr><tr><td data-num="10"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9093"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="13"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="16"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="17"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="25"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="30"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="35"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="40"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="45"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="50"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="55"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="60"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>  - job_name: <span class="token string">"mysqld_exporter"</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="65"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="67"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="68"></td><td><pre>        role: master</pre></td></tr><tr><td data-num="69"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="71"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="72"></td><td><pre>        role: slave</pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>  - job_name: <span class="token string">"redis_exporter"</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="77"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9121"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>  - job_name: <span class="token string">'blackbox_http'</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 这次不是 /metrics，是 /probe</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    params: <span class="token comment"># 传递参数</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      module: <span class="token punctuation">[</span>http_2xx<span class="token punctuation">]</span> <span class="token comment"># 调哪个模块进探测</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="84"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"https://www.xuliangwei.com"</span>,<span class="token string">"http://www.oldxu.net"</span>,<span class="token string">"https://www.baidu.com"</span>,<span class="token string">"http://httpbin.org/status/400"</span>,<span class="token string">"https://httpstat.us/500"</span>,<span class="token string">"https://httpstat.us/502"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="86"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="87"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="88"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="90"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="91"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>  - job_name: <span class="token string">'blackbox_tcp'</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="95"></td><td><pre>    params:</pre></td></tr><tr><td data-num="96"></td><td><pre>      module: <span class="token punctuation">[</span>tcp_connect<span class="token punctuation">]</span> <span class="token comment"># 使 tcp_connect 模块</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="98"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:3306"</span>,<span class="token string">"prom-node03.oldxu.net:6379"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="100"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="101"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="102"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="104"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="105"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>  - job_name: <span class="token string">'blackbox_icmp'</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="109"></td><td><pre>    params:</pre></td></tr><tr><td data-num="110"></td><td><pre>      module: <span class="token punctuation">[</span>icmp<span class="token punctuation">]</span> <span class="token comment"># 使 icmp 模块</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="112"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net"</span>,<span class="token string">"prom-node02.oldxu.net"</span>,<span class="token string">"prom-node03.oldxu.net"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="114"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="115"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="116"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="117"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="118"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="119"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>  - job_name: <span class="token string">'blackbox_ssh'</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="123"></td><td><pre>    params:</pre></td></tr><tr><td data-num="124"></td><td><pre>      module: <span class="token punctuation">[</span>ssh_banner<span class="token punctuation">]</span> <span class="token comment"># 使⽤ ssh_banner 模块</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="126"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:22"</span>,<span class="token string">"prom-node02.oldxu.net:22"</span>,<span class="token string">"prom-node03.oldxu.net:22"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="128"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="129"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="130"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="131"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="132"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="133"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="134"></td><td><pre></pre></td></tr><tr><td data-num="135"></td><td><pre>  - job_name: <span class="token string">'domain_exporter'</span></pre></td></tr><tr><td data-num="136"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 不是 /metrics，⽽是 /probe</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="138"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"nf-leasing.com"</span>,<span class="token string">"hmallleasing.com"</span>,<span class="token string">"jd.com"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="140"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="141"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="142"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="143"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="144"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="145"></td><td><pre>      replacement: prom-node04.oldxu.net:9222</pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre>  - job_name: <span class="token string">"pushgateway"</span></pre></td></tr><tr><td data-num="148"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="149"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="150"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9091"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre>  - job_name: <span class="token string">"alertmanager"</span></pre></td></tr><tr><td data-num="153"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="154"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="155"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9093"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>3、重新加载 Prometheus 服务</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="32-配置prometheus告警规则"><a class="anchor" href="#32-配置prometheus告警规则">#</a> 3.2 配置 Prometheus 告警规则</h5><p>1、在 Prometheus 服务器上编辑⼀个测试的告警规则</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/node_rules.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>groups:</pre></td></tr><tr><td data-num="3"></td><td><pre>- name: 节点告警规则</pre></td></tr><tr><td data-num="4"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="5"></td><td><pre>  - alert: 节点处于Down状态</pre></td></tr><tr><td data-num="6"></td><td><pre>    expr: up <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="8"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="10"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="11"></td><td><pre>      summary: <span class="token string">"节点处于Down状态,实例:"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      description: <span class="token string">" 节点已关闭"</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  - alert: 节点CPU使率超过80%</pre></td></tr><tr><td data-num="15"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - avg<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> <span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="17"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="18"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="19"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="20"></td><td><pre>      summary: <span class="token string">"主机CPU利率过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      description: <span class="token string">"该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。"</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  - alert: CPU饱和度过高</pre></td></tr><tr><td data-num="24"></td><td><pre>    expr: sum<span class="token punctuation">(</span>node_load1<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token punctuation">(</span>count<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> * <span class="token number">2</span><span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="26"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="27"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="28"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="29"></td><td><pre>      summary: <span class="token string">"CPU饱和度过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      description: <span class="token string">"该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。"</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  - alert: 主机内存不足</pre></td></tr><tr><td data-num="33"></td><td><pre>    expr: <span class="token punctuation">(</span>node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes<span class="token punctuation">)</span> / node_memory_MemTotal_bytes * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="35"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="36"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="37"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="38"></td><td><pre>      summary: <span class="token string">"主机内存使用率较高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      description: <span class="token string">"该实例的内存使用率持续2分钟高于80%，当前利用率：%"</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - alert: 内存饱和度高</pre></td></tr><tr><td data-num="42"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">10</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="44"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="45"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="46"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="47"></td><td><pre>      summary: <span class="token string">"主机内存内存饱和度高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      description: <span class="token string">"SWAP内存使用率已连续2分钟超过10%，表明内存饱和度过高，当前SWAP使用率为：%。"</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>  - alert: 磁盘空间告急</pre></td></tr><tr><td data-num="51"></td><td><pre>    expr: <span class="token punctuation">(</span> node_filesystem_size_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> - node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> / node_filesystem_size_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">70</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="53"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="54"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="55"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="56"></td><td><pre>      summary: <span class="token string">"实例  磁盘 分区空间不足"</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      description: <span class="token string">"实例  磁盘  分区空间使用率已超过 70%，当前使用率为 %，请及时处理。"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>          </pre></td></tr><tr><td data-num="59"></td><td><pre>  - alert: 磁盘Inode空间告急</pre></td></tr><tr><td data-num="60"></td><td><pre>    expr: <span class="token punctuation">(</span>node_filesystem_files<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> - node_filesystem_files_free<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> / node_filesystem_files<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">70</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="62"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="63"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="64"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="65"></td><td><pre>      summary: <span class="token string">"实例  磁盘 分区Inode空间不足"</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      description: <span class="token string">"实例  磁盘  分区的Inode空间使用率已超过 70%，，当前使用率为 %，请及时处理。"</span></pre></td></tr><tr><td data-num="67"></td><td><pre>          </pre></td></tr><tr><td data-num="68"></td><td><pre>  - alert: 磁盘IOPS写入较高</pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">#expr: sum(rate(node_disk_writes_completed_total[1m])) by (instance,job) / 120 * 100 >60</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token comment">#round 函数可以对值进行四舍五入，磁盘最大 IOPS 为 120 次 /s</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_disk_writes_completed_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">120</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="73"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="74"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="75"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="76"></td><td><pre>      summary: <span class="token string">"实例  IOPS每秒写入次数超过120次/s"</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      description: </pre></td></tr><tr><td data-num="78"></td><td><pre>        当前磁盘IOPS写入饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼25--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="79"></td><td><pre>        当前磁盘IOPS每秒写入最大 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼26--<span class="token operator">></span> 次/s</pre></td></tr><tr><td data-num="80"></td><td><pre>                </pre></td></tr><tr><td data-num="81"></td><td><pre>  - alert: 磁盘IOPS读取较高</pre></td></tr><tr><td data-num="82"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_disk_reads_completed_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">120</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="84"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="85"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="86"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="87"></td><td><pre>      summary: <span class="token string">"实例  IOPS每秒读取次数超过120次/s"</span></pre></td></tr><tr><td data-num="88"></td><td><pre>      description:</pre></td></tr><tr><td data-num="89"></td><td><pre>        当前磁盘IOPS读取饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼28--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="90"></td><td><pre>        当前磁盘IOPS每秒读取最⼤ <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼29--<span class="token operator">></span> 次/s</pre></td></tr><tr><td data-num="91"></td><td><pre>  </pre></td></tr><tr><td data-num="92"></td><td><pre>  - alert: 磁盘IO写入吞吐较高</pre></td></tr><tr><td data-num="93"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_written_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">1024</span> /1024 / <span class="token number">30</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="95"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="96"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="97"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="98"></td><td><pre>      summary: <span class="token string">"实例  磁盘IO写入每秒超过最高30MB/s"</span></pre></td></tr><tr><td data-num="99"></td><td><pre>      description:</pre></td></tr><tr><td data-num="100"></td><td><pre>        当前磁盘IO写入吞吐量的饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼31--<span class="token operator">></span>%。</pre></td></tr><tr><td data-num="101"></td><td><pre>        当前磁盘IO写入吞吐量每秒最大是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼32--<span class="token operator">></span>MB/s</pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>  - alert: 磁盘IO读取吞吐较高</pre></td></tr><tr><td data-num="104"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_read_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">1024</span> /1024 /30 * <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="106"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="107"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="108"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="109"></td><td><pre>      summary: <span class="token string">"实例  磁盘IO读取每秒超过最大30MB/s"</span></pre></td></tr><tr><td data-num="110"></td><td><pre>      description:</pre></td></tr><tr><td data-num="111"></td><td><pre>        当前磁盘IO读取吞吐量的饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼34--<span class="token operator">></span>%。</pre></td></tr><tr><td data-num="112"></td><td><pre>        当前磁盘IO读取吞吐量每秒最大是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼35--<span class="token operator">></span>MB/s</pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>  - alert: 网络下载带宽异常</pre></td></tr><tr><td data-num="115"></td><td><pre>    expr: max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_network_receive_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> * <span class="token number">8</span> / <span class="token number">1024</span> / <span class="token number">1024</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job,device<span class="token punctuation">)</span> / <span class="token number">50</span> * <span class="token number">100</span> <span class="token operator">>=</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="117"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="118"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="119"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="120"></td><td><pre>      summary: <span class="token string">"实例  的  接口下载流量已经超过公司实际50Mbps"</span></pre></td></tr><tr><td data-num="121"></td><td><pre>      description:</pre></td></tr><tr><td data-num="122"></td><td><pre>        当前下载带宽已经达到 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼38--<span class="token operator">></span> Mbps/s</pre></td></tr><tr><td data-num="123"></td><td><pre>        当前下载带宽使用率在 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼39--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="124"></td><td><pre>  </pre></td></tr><tr><td data-num="125"></td><td><pre>  - alert: 网络上传带宽异常</pre></td></tr><tr><td data-num="126"></td><td><pre>    expr: max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_network_transmit_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> * <span class="token number">8</span> / <span class="token number">1024</span> / <span class="token number">1024</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job,device<span class="token punctuation">)</span> / <span class="token number">50</span> * <span class="token number">100</span> <span class="token operator">>=</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="128"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="129"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="130"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="131"></td><td><pre>      summary: <span class="token string">"实例  的  接口上传流量已经超过公司实际50Mbps"</span></pre></td></tr><tr><td data-num="132"></td><td><pre>      description:</pre></td></tr><tr><td data-num="133"></td><td><pre>        当前上传带宽已经达到 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼42--<span class="token operator">></span> Mbps/s</pre></td></tr><tr><td data-num="134"></td><td><pre>        当前上传带宽使用率在 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼43--<span class="token operator">></span>%</pre></td></tr></table></figure><h5 id="33-配置prometheus加载规则"><a class="anchor" href="#33-配置prometheus加载规则">#</a> 3.3 配置 Prometheus 加载规则</h5><p>为了能够让 Prometheus 能够定期评估告警规则，我们需要在 Prometheus 全局配置⽂件中通过 rule_files 指定告警规则⽂件的路径，⽽后 Prometheus 会定期评估这些告警规则， 当规则条件满⾜时，会向外部发送通知。</p><p>1、配置 Prometheus 加载告警规则⽂件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># Alertmanager 配置</span></pre></td></tr><tr><td data-num="7"></td><td><pre>alerting:</pre></td></tr><tr><td data-num="8"></td><td><pre>  alertmanagers:</pre></td></tr><tr><td data-num="9"></td><td><pre>  - static_configs:</pre></td></tr><tr><td data-num="10"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9093"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="13"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="16"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="17"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="25"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>2、检查 Prometheus 语法</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>Checking /etc/prometheus/rules/node_rules.yml</pre></td></tr><tr><td data-num="3"></td><td><pre>  SUCCESS: <span class="token number">13</span> rules found</pre></td></tr></table></figure><p>3、重启 Prometheus 服务</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://localhost:9090/-/reload</pre></td></tr></table></figure><h5 id="34-触发规则并验证告警通知"><a class="anchor" href="#34-触发规则并验证告警通知">#</a> 3.4 触发规则并验证告警通知</h5><p>1、停⽌ node2 和 node03 的 node_exporter 服务，那么就会触发告警</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node02 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop node_exporter.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop node_exporter.service</span></pre></td></tr></table></figure><p>2、检查 Prometheus 的 Alert ⻚⾯的状态是否处于 Firing</p><p>3、检查 AlertManager 是否收到了告警</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/i9iZoxh.png" alt="12.png"></p><p>4、检查邮件是否能看到告警的信息，因为两条告警的 alertname 是一致的，因此它们会合并为一条消息发送出来。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/FwXQPdL.png" alt="13.png"></p><h5 id="35-自定义邮件告警模板"><a class="anchor" href="#35-自定义邮件告警模板">#</a> 3.5 ⾃定义邮件告警模板</h5><p>1、定义告警的通知模板和恢复模板</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/alertmanager/template</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/alertmanager/template/email.tmpl</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼44--<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼45--<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼46--<span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">&lt;</span>h2 <span class="token assign-left variable">style</span><span class="token operator">=</span><span class="token string">"color: red;"</span><span class="token operator">></span>@告警通知<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">2</span>></span></pre></td></tr><tr><td data-num="7"></td><td><pre>告警程序: AlertManager <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>告警级别: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼47--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre>告警类型: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼48--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>故障主机: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼49--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>告警主题: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼50--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre>告警详情: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼51--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre>触发时间: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼52--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼53--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼54--<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼55--<span class="token operator">></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼56--<span class="token operator">></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token operator">&lt;</span>h2 <span class="token assign-left variable">style</span><span class="token operator">=</span><span class="token string">"color: green;"</span><span class="token operator">></span>@告警恢复<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">2</span>></span></pre></td></tr><tr><td data-num="19"></td><td><pre>告警程序: AlertManager <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="20"></td><td><pre>告警级别: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼57--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="21"></td><td><pre>告警类型: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼58--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="22"></td><td><pre>告警主机: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼59--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="23"></td><td><pre>告警主题: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼60--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="24"></td><td><pre>告警详情: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼61--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="25"></td><td><pre>触发时间: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼62--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="26"></td><td><pre>恢复时间: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼63--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼64--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼65--<span class="token operator">></span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼66--<span class="token operator">></span></pre></td></tr></table></figure><p>2、配置 AlertManager，应用该模板</p><pre><code>[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml 
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: 'smtp.qq.com:587'
  smtp_from: '373370405@qq.com'  # 发件人邮件
  smtp_auth_username: '373370405@qq.com'  # 发件人用户名
  smtp_auth_password: '******' # 发件人密码[授权码]
  smtp_hello: 'qq.com'
  smtp_require_tls: true

# 加载模板文件
templates:
  - '/etc/alertmanager/template/email.tmpl'  # 模板文件的实际路径
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: ['alertname'] #告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s         #当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m     #已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m  #如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: default    #默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器
  
receivers:
- name: 'default'
  email_configs:
  - to: '373370405@qq.com'
    send_resolved: true # 接受告警恢复的通知
    html: '&#123;&#123; template "email.html" . &#125;&#125;' # 发送邮件内容，调用该模板进行渲染
</code></pre><p>3、检查 AlertManager 的配置文件是否正确</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Checking <span class="token string">'/etc/alertmanager/alertmanager.yml'</span>  SUCCESS</pre></td></tr><tr><td data-num="3"></td><td><pre>Found:</pre></td></tr><tr><td data-num="4"></td><td><pre> - global config</pre></td></tr><tr><td data-num="5"></td><td><pre> - route</pre></td></tr><tr><td data-num="6"></td><td><pre> - <span class="token number">0</span> inhibit rules</pre></td></tr><tr><td data-num="7"></td><td><pre> - <span class="token number">1</span> receivers</pre></td></tr><tr><td data-num="8"></td><td><pre> - <span class="token number">1</span> templates</pre></td></tr><tr><td data-num="9"></td><td><pre>  SUCCESS</pre></td></tr></table></figure><p>4、重新加载 AlertManager</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9093/-/reload</span></pre></td></tr></table></figure><p>5、触发告警，验证告警模板是否正常渲染</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/oQV6bLR.jpeg" alt="3.jpg"></p><h4 id="四-alertmanager告警通知方式"><a class="anchor" href="#四-alertmanager告警通知方式">#</a> 四. AlertManager 告警通知⽅式</h4><h5 id="41-配置alert对接微信告警"><a class="anchor" href="#41-配置alert对接微信告警">#</a> 4.1 配置 Alert 对接微信告警</h5><p>企业微信告警，需要将发送告警的服务器域名添加到⽩名单，同时该服务器必须运⾏在公⽹，因此常规的企业微信告警没办法很好在本地实现。但是我们可以采⽤ webhook ⽅式来实现： Prometheus--&gt;AlertManager--&gt; 自定义 Webhook 程序 --&gt; 企业微信机器⼈ --&gt; 通知给对应的⽤户</p><ul><li>1. 访问企业微信官⽹， <a target="_blank" rel="noopener" href="https://work.weixin.qq.com/">https://work.weixin.qq.com/</a> ，注册⼀个账户。</li><li>2. 创建⼀个群聊，并邀请⾄少两名其他成员加⼊，因为企业微信群聊⾄少需要三名成员才能启⽤。</li><li>3. 在群组聊天中添加⼀个新的机器⼈。</li><li>4. 记录机器⼈的 Webhook URL (Token)</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key<span class="token operator">=</span>47ffbdd9-4308-4db0-aa08-f309546cc92d</pre></td></tr></table></figure><p>1、下载并运⾏ webhook_wechat</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/prometheus/Alert/webhook_wechat_oldxu</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># mv webhook_wechat_oldxu /usr/local/bin/</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /usr/local/bin/webhook_wechat_oldxu</span></pre></td></tr></table></figure><p>2、编辑启动脚本⽂件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/webhook_wechat.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>webhook_wechat</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/webhook_wechat_oldxu <span class="token parameter variable">--port</span> <span class="token number">5001</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start webhook_wechat &amp;&amp; systemctl enable webhook_wechat</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 5001</span></pre></td></tr><tr><td data-num="19"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::5001                 :::*                    LISTEN      <span class="token number">2576</span>/webhook_wechat</pre></td></tr></table></figure><p>3、测试 webhook_wechat 能否正确发送消息到企业微信</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:5001/alert?token=&lt; 企业微信机器人 token> \</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/json"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">-d</span> <span class="token string">'&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  "alerts": [</pre></td></tr><tr><td data-num="5"></td><td><pre>    &#123;</pre></td></tr><tr><td data-num="6"></td><td><pre>      "status": "firing",</pre></td></tr><tr><td data-num="7"></td><td><pre>      "labels": &#123;</pre></td></tr><tr><td data-num="8"></td><td><pre>        "severity": "critical",</pre></td></tr><tr><td data-num="9"></td><td><pre>        "alertname": "InstanceDown",</pre></td></tr><tr><td data-num="10"></td><td><pre>        "instance": "example1"</pre></td></tr><tr><td data-num="11"></td><td><pre>      &#125;,</pre></td></tr><tr><td data-num="12"></td><td><pre>      "annotations": &#123;</pre></td></tr><tr><td data-num="13"></td><td><pre>        "summary": "Instance example1 down",</pre></td></tr><tr><td data-num="14"></td><td><pre>        "description": "The instance example1 is down."</pre></td></tr><tr><td data-num="15"></td><td><pre>      &#125;,</pre></td></tr><tr><td data-num="16"></td><td><pre>      "startsAt": "2024-12-20T15:04:05Z",</pre></td></tr><tr><td data-num="17"></td><td><pre>      "endsAt": "0001-01-01T00:00:00Z"</pre></td></tr><tr><td data-num="18"></td><td><pre>    &#125;,</pre></td></tr><tr><td data-num="19"></td><td><pre>   &#123;</pre></td></tr><tr><td data-num="20"></td><td><pre>      "status": "resolved",</pre></td></tr><tr><td data-num="21"></td><td><pre>      "labels": &#123;</pre></td></tr><tr><td data-num="22"></td><td><pre>        "severity": "critical",</pre></td></tr><tr><td data-num="23"></td><td><pre>        "alertname": "InstanceDown",</pre></td></tr><tr><td data-num="24"></td><td><pre>        "instance": "example1"</pre></td></tr><tr><td data-num="25"></td><td><pre>      &#125;,</pre></td></tr><tr><td data-num="26"></td><td><pre>      "annotations": &#123;</pre></td></tr><tr><td data-num="27"></td><td><pre>        "summary": "Instance example1 is back up",</pre></td></tr><tr><td data-num="28"></td><td><pre>        "description": "The instance example1 has recovered."</pre></td></tr><tr><td data-num="29"></td><td><pre>      &#125;,</pre></td></tr><tr><td data-num="30"></td><td><pre>      "startsAt": "2024-12-20T15:04:05Z",</pre></td></tr><tr><td data-num="31"></td><td><pre>      "endsAt": "2024-12-20T16:04:05Z"</pre></td></tr><tr><td data-num="32"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="33"></td><td><pre>  ]</pre></td></tr><tr><td data-num="34"></td><td><pre>&#125;'</pre></td></tr></table></figure><p>4、检查企业微信结果</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306211653486.png" alt="image-20240306211653486"></p><p>5、配置 AlertManager 对接 webhook_wechat</p><pre><code>[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: 'smtp.qq.com:25'
  smtp_from: '373370405@qq.com'  # 发件人邮件
  smtp_auth_username: '373370405@qq.com'  # 发件人用户名
  smtp_auth_password: '******' # 发件人密码[授权码]
  smtp_hello: 'qq.com'
  smtp_require_tls: false

# 加载模板文件
templates:
  - '/etc/alertmanager/template/email.tmpl'
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: ['alertname'] # 告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s     # 当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m  # 已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m # 如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: webhook-wechat-ops   # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器
  
receivers:
- name: 'webhook-wechat-ops'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:5001/alert?token=47ffbdd9-4308-4db0-aa08-f309546cc92d'  #http://&lt;你的服务器地址&gt;:5001/alert?token=&lt;企业微信机器人token&gt;'

- name: 'default'
  email_configs:
  - to: '373370405@qq.com'
    send_resolved: true # 接受告警恢复的通知
    html: '&#123;&#123; template "email.html" . &#125;&#125;' # 发送邮件内容，调用该模板进行渲染
</code></pre><p>6、检查 AlertManager 的配置⽂件是否正确</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Checking <span class="token string">'/etc/alertmanager/alertmanager.yml'</span>  SUCCESS</pre></td></tr><tr><td data-num="3"></td><td><pre>Found:</pre></td></tr><tr><td data-num="4"></td><td><pre> - global config</pre></td></tr><tr><td data-num="5"></td><td><pre> - route</pre></td></tr><tr><td data-num="6"></td><td><pre> - <span class="token number">0</span> inhibit rules</pre></td></tr><tr><td data-num="7"></td><td><pre> - <span class="token number">1</span> receivers</pre></td></tr><tr><td data-num="8"></td><td><pre> - <span class="token number">1</span> templates</pre></td></tr><tr><td data-num="9"></td><td><pre>  SUCCESS</pre></td></tr></table></figure><p>7、重新加载 AlertManager</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment">#  curl -X POST http://localhost:9093/-/reload</span></pre></td></tr></table></figure><p>8、触发告警，验证是否能通过企业微信收到消息</p><p><img loading="lazy" data-src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306212303561.png" alt="image-20240306212303561"></p><h5 id="42-配置alert对接钉钉告警"><a class="anchor" href="#42-配置alert对接钉钉告警">#</a> 4.2 配置 Alert 对接钉钉告警</h5><p>钉钉告警可以是⽤ Prometheus-webhook-dingtalk ⼯具，github 地址 <a target="_blank" rel="noopener" href="https://github.com/timonwong/prometheus-webhook-dingtalk">https://github.com/timonwong/prometheus-webhook-dingtalk</a> 。但在此处，我们使⽤的是自己开发的 webhook 程序来对接钉钉， Prometheus--&gt;AlertManager--&gt; 自定义 Webhook 程序 --&gt; 钉钉机器人 --&gt; 通知给对应的群组</p><ul><li>1、访问钉钉开发者后台： <a target="_blank" rel="noopener" href="https://open-dev.dingtalk.com/">https://open-dev.dingtalk.com/</a></li><li>2、点击应⽤开发，然后创建机器⼈（使⽤旧版），填写机器⼈名称，然后找到创建的机器⼈（版本管理与发布，点击上线），该机器⼈就可以添加到群组。</li><li>3、发起群聊（添加两个⽤户），然后创建⼀个普通群，群归属为个⼈。</li><li>4、紧接着找到对应的群，点击群类型，必须转为 “内部群”，然后在智能群助⼿中添加机器⼈，找到此前在钉钉开发者平台创建的机器⼈添加即可。</li><li>5、最后点击机器⼈，获取对应的 Token 令牌。</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>https://oapi.dingtalk.com/robot/send?access_token<span class="token operator">=</span>906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db</pre></td></tr></table></figure><h6 id="421-配置alert对接钉钉告警1"><a class="anchor" href="#421-配置alert对接钉钉告警1">#</a> 4.2.1 配置 Alert 对接钉钉告警 1</h6><p>1、下载并运⾏ webhook_dingding</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/prometheus/Alert/webhook_dingding_oldxu</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># mv webhook_dingding_oldxu /usr/local/bin/</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /usr/local/bin/webhook_dingding_oldxu</span></pre></td></tr></table></figure><p>2、编辑启动脚本⽂件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/webhook_dingding.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>webhook_dingding</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/webhook_dingding_oldxu <span class="token parameter variable">--port</span> <span class="token number">5002</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start webhook_dingding &amp;&amp; systemctl enable webhook_dingding </span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 5002</span></pre></td></tr><tr><td data-num="19"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::5002                 :::*                    LISTEN      <span class="token number">3141</span>/webhook_dingdi</pre></td></tr></table></figure><p>3、测试 webhook_wechat 能否正确发送消息到钉钉（注意端⼝是 5002）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:5002/alert?token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db \</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/json"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">-d</span> <span class="token string">'&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  "alerts": [</pre></td></tr><tr><td data-num="5"></td><td><pre>    &#123;</pre></td></tr><tr><td data-num="6"></td><td><pre>      "status": "firing",</pre></td></tr><tr><td data-num="7"></td><td><pre>      "labels": &#123;</pre></td></tr><tr><td data-num="8"></td><td><pre>        "severity": "critical",</pre></td></tr><tr><td data-num="9"></td><td><pre>        "alertname": "InstanceDown",</pre></td></tr><tr><td data-num="10"></td><td><pre>        "instance": "example1"</pre></td></tr><tr><td data-num="11"></td><td><pre>      &#125;,</pre></td></tr><tr><td data-num="12"></td><td><pre>      "annotations": &#123;</pre></td></tr><tr><td data-num="13"></td><td><pre>        "summary": "Instance example1 down",</pre></td></tr><tr><td data-num="14"></td><td><pre>        "description": "The instance example1 is down."</pre></td></tr><tr><td data-num="15"></td><td><pre>      &#125;,</pre></td></tr><tr><td data-num="16"></td><td><pre>      "startsAt": "2024-12-20T15:04:05Z",</pre></td></tr><tr><td data-num="17"></td><td><pre>      "endsAt": "0001-01-01T00:00:00Z"</pre></td></tr><tr><td data-num="18"></td><td><pre>    &#125;,</pre></td></tr><tr><td data-num="19"></td><td><pre>   &#123;</pre></td></tr><tr><td data-num="20"></td><td><pre>      "status": "resolved",</pre></td></tr><tr><td data-num="21"></td><td><pre>      "labels": &#123;</pre></td></tr><tr><td data-num="22"></td><td><pre>        "severity": "critical",</pre></td></tr><tr><td data-num="23"></td><td><pre>        "alertname": "InstanceDown",</pre></td></tr><tr><td data-num="24"></td><td><pre>        "instance": "example1"</pre></td></tr><tr><td data-num="25"></td><td><pre>      &#125;,</pre></td></tr><tr><td data-num="26"></td><td><pre>      "annotations": &#123;</pre></td></tr><tr><td data-num="27"></td><td><pre>        "summary": "Instance example1 is back up",</pre></td></tr><tr><td data-num="28"></td><td><pre>        "description": "The instance example1 has recovered."</pre></td></tr><tr><td data-num="29"></td><td><pre>      &#125;,</pre></td></tr><tr><td data-num="30"></td><td><pre>      "startsAt": "2024-12-20T15:04:05Z",</pre></td></tr><tr><td data-num="31"></td><td><pre>      "endsAt": "2024-12-20T16:04:05Z"</pre></td></tr><tr><td data-num="32"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="33"></td><td><pre>  ]</pre></td></tr><tr><td data-num="34"></td><td><pre>&#125;'</pre></td></tr></table></figure><p>4、检查企业微信结果</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/ZKWmmc2.jpeg" alt="1.jpg"></p><p>5、配置 AlertManager 对接 webhook_dingding</p><pre><code>[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: 'smtp.qq.com:587'
  smtp_from: '373370405@qq.com'  # 发件人邮件
  smtp_auth_username: '373370405@qq.com'  # 发件人用户名
  smtp_auth_password: '******' # 发件人密码[授权码]
  smtp_hello: 'qq.com'
  smtp_require_tls: true

# 加载模板文件
templates:
  - '/etc/alertmanager/template/email.tmpl'  # 模板文件的实际路径
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: ['alertname'] #告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭车回家）
  group_wait: 30s         #当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m     #已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m  #如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: webhook-dingding-ops    #默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器

receivers:
- name: 'webhook-dingding-ops'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:5002/alert?token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db'

- name: 'default'
  email_configs:
  - to: '373370405@qq.com'
    send_resolved: true # 接受告警恢复的通知
    html: '&#123;&#123; template "email.html" . &#125;&#125;' # 发送邮件内容，调用该模板进行渲染
</code></pre><p>6、检查 AlertManager 的配置⽂件是否正确</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml</span></pre></td></tr></table></figure><p>7、重新加载 AlertManager</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment">#  curl -X POST http://localhost:9093/-/reload</span></pre></td></tr></table></figure><p>8、触发告警，验证是否能通过钉钉收到消息</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/w8JdsaP.jpeg" alt="2.jpg"></p><h6 id="422-配置alert对接钉钉告警2"><a class="anchor" href="#422-配置alert对接钉钉告警2">#</a> 4.2.2 配置 Alert 对接钉钉告警 2</h6><p><em>参考链接：<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_13236892/12095979">https://blog.51cto.com/u_13236892/12095979</a></em></p><p>1、下载 prometheus-webhook-dingtalk</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>https://github.com/timonwong/prometheus-webhook-dingtalk</pre></td></tr><tr><td data-num="2"></td><td><pre>https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz</pre></td></tr></table></figure><p>2、解压安装</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># tar -xf prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz -C /usr/local/bin/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /usr/local/bin/prometheus-webhook-dingtalk-2.1.0.linux-amd64/ /usr/local/bin/webhook-dingtalk</span></pre></td></tr></table></figure><p>3、添加告警规则模板</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment">#  cat /usr/local/bin/webhook-dingtalk//template.tmpl</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼70--<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼71--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼72--<span class="token operator">></span>:<span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼73--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼74--<span class="token operator">></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼75--<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼76--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼77--<span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre>---</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼78--<span class="token operator">></span>@<span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼79--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼80--<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>**告警程序**: AlertManager <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre>**告警类型**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼81--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>**告警级别**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼82--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>**告警主机**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼83--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre>**告警主题**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼84--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre>**告警信息**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼85--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre>**告警时间**: <span class="token operator">&lt;</span>font <span class="token assign-left variable">color</span><span class="token operator">=</span><span class="token string">'#FF0000'</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼86--<span class="token operator">></span> <span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼87--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼88--<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼89--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼90--<span class="token operator">></span></pre></td></tr><tr><td data-num="17"></td><td><pre>---</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼91--<span class="token operator">></span>@<span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼92--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼93--<span class="token operator">></span></pre></td></tr><tr><td data-num="19"></td><td><pre>**告警程序**: AlertManager <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="20"></td><td><pre>**告警类型**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼94--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="21"></td><td><pre>**告警级别**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼95--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="22"></td><td><pre>**告警主机**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼96--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="23"></td><td><pre>**告警主题**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼97--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="24"></td><td><pre>**告警信息**: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼98--<span class="token operator">></span> <span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="25"></td><td><pre>**告警时间**: <span class="token operator">&lt;</span>font <span class="token assign-left variable">color</span><span class="token operator">=</span><span class="token string">'#FF0000'</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼99--<span class="token operator">></span> <span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="26"></td><td><pre>**恢复时间**: <span class="token operator">&lt;</span>font <span class="token assign-left variable">color</span><span class="token operator">=</span><span class="token string">'#FF0000'</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼100--<span class="token operator">></span> <span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>br<span class="token operator">></span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼101--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼102--<span class="token operator">></span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼103--<span class="token operator">></span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼104--<span class="token operator">></span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼105--<span class="token operator">></span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼106--<span class="token operator">></span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼107--<span class="token operator">></span></pre></td></tr><tr><td data-num="33"></td><td><pre>**<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token operator">&lt;</span>font <span class="token assign-left variable">color</span><span class="token operator">=</span><span class="token string">'#FF7F00'</span><span class="token operator">></span>侦测到<span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼108--<span class="token operator">></span>个故障<span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">2</span>></span>**</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼109--<span class="token operator">></span></pre></td></tr><tr><td data-num="35"></td><td><pre>---</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼110--<span class="token operator">></span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼111--<span class="token operator">></span></pre></td></tr><tr><td data-num="38"></td><td><pre>**<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token operator">&lt;</span>font <span class="token assign-left variable">color</span><span class="token operator">=</span><span class="token string">'#00FF00'</span><span class="token operator">></span>恢复<span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼112--<span class="token operator">></span>个故障<span class="token operator">&lt;</span>/font<span class="token operator">></span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">2</span>></span>**</pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼113--<span class="token operator">></span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼114--<span class="token operator">></span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼115--<span class="token operator">></span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼116--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼117--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼118--<span class="token operator">></span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼119--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼120--<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼121--<span class="token operator">></span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼122--<span class="token operator">></span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼123--<span class="token operator">></span></pre></td></tr></table></figure><p>4、添加启动配置文件</p><pre><code>[root@prom-node01 soft]# cd /usr/local/bin/webhook-dingtalk/
[root@prom-node01 webhook-dingtalk]# cp config.example.yml config.yml
[root@prom-node01 ~]# cat /usr/local/bin/webhook-dingtalk/config.yml 
## Request timeout
# timeout: 5s

## Uncomment following line in order to write template from scratch (be careful!)
#no_builtin_template: true

## Customizable templates path
templates:
  - /usr/local/bin/webhook-dingtalk/template.tmpl   #告警模板

## You can also override default template using `default_message`
## The following example to use the 'legacy' template from v0.3.0
#default_message:
#  title: '&#123;&#123; template "legacy.title" . &#125;&#125;'
#  text: '&#123;&#123; template "legacy.content" . &#125;&#125;'

## Targets, previously was known as &quot;profiles&quot;
targets:
  webhook1:
    url: https://oapi.dingtalk.com/robot/send?access_token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db #钉钉token
    # secret for signature
    secret: SEC000000000000000000000
  webhook2:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx
  webhook_legacy:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx
    # Customize template content
    message:
      # Use legacy template
      title: '&#123;&#123; template "legacy.title" . &#125;&#125;'
      text: '&#123;&#123; template "legacy.content" . &#125;&#125;'
  webhook_mention_all:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx
    mention:
      all: true
  webhook_mention_users:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx
    mention:
      mobiles: ['156xxxx8827', '189xxxx8325']
</code></pre><p>5、编辑启动脚本</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/webhook.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>Prometheus-Server</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/webhook-dingtalk/prometheus-webhook-dingtalk <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token parameter variable">--config.file</span><span class="token operator">=</span>/usr/local/bin/webhook-dingtalk/config.yml</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr></table></figure><p>6、启动 webhook</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start webhook.service &amp;&amp; systemctl enable webhook.service</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 8060</span></pre></td></tr><tr><td data-num="4"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::8060                 :::*                    LISTEN      <span class="token number">3008</span>/prometheus-web</pre></td></tr></table></figure><p>7、配置 AlertManager 对接 webhook_dingding</p><pre><code>[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: 'smtp.qq.com:587'
  smtp_from: '373370405@qq.com'  # 发件人邮件
  smtp_auth_username: '373370405@qq.com'  # 发件人用户名
  smtp_auth_password: '******' # 发件人密码[授权码]
  smtp_hello: 'qq.com'
  smtp_require_tls: true

# 加载模板文件
templates:
  - '/etc/alertmanager/template/email.tmpl'  # 模板文件的实际路径
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: ['alertname'] #告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s         #当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m     #已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m  #如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: webhook-dingding-ops1    #默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器

  
receivers:
- name: 'webhook-dingding-ops'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:5002/alert?token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db'

- name: 'webhook-dingding-ops1'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:8060/dingtalk/webhook1/send'

- name: 'default'
  email_configs:
  - to: '373370405@qq.com'
    send_resolved: true # 接受告警恢复的通知
    html: '&#123;&#123; template "email.html" . &#125;&#125;' # 发送邮件内容，调用该模板进行渲染
</code></pre><p>8、检查 AlertManager 的配置⽂件是否正确</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Checking <span class="token string">'/etc/alertmanager/alertmanager.yml'</span>  SUCCESS</pre></td></tr><tr><td data-num="3"></td><td><pre>Found:</pre></td></tr><tr><td data-num="4"></td><td><pre> - global config</pre></td></tr><tr><td data-num="5"></td><td><pre> - route</pre></td></tr><tr><td data-num="6"></td><td><pre> - <span class="token number">0</span> inhibit rules</pre></td></tr><tr><td data-num="7"></td><td><pre> - <span class="token number">3</span> receivers</pre></td></tr><tr><td data-num="8"></td><td><pre> - <span class="token number">1</span> templates</pre></td></tr><tr><td data-num="9"></td><td><pre>  SUCCESS</pre></td></tr></table></figure><p>9、重新加载 AlertManager</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://localhost:9093/-/reload</pre></td></tr></table></figure><p>10、触发告警，验证是否能通过钉钉收到消息</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/sKrY09u.jpeg" alt="1.jpg"></p><h4 id="五-alertmanager告警路由"><a class="anchor" href="#五-alertmanager告警路由">#</a> 五. AlertManager 告警路由</h4><h5 id="51-告警路由介绍"><a class="anchor" href="#51-告警路由介绍">#</a> 5.1 告警路由介绍</h5><p>所谓的告警路由，就是将不同的告警消息转发给不同的接收⼈，以便故障能快速的被处理和解决。</p><p>Alertmanager 的告警路由配置，使⽤的是树状结构来定义，以确保每条告警消息都能够按照定义好的路径进⾏处理。当⼀条告警消息进来后，会先进⼊根路由，然后逐级的去匹配每个⼦路由的规则，然后将消息通过媒介发送给对应的接收⼈。</p><p>例如，我们可以设置⼀个规则，将标签 severity 级别为 critical 的告警发送到钉钉，⽽剩余其他的告警则全部发送给微信。</p><p><strong>AlertManager 告警路由场景示例：</strong></p><ul><li>1、mysql_exporter 和 redis_exporter 的 Job 告警时，就将其发送给 “钉钉的 DBA 团队”。</li><li>2、node_exporter 的 Job 告警时，则将告警路由到 “钉钉的 OPS 团队”。</li><li>3、最后，如果告警消息不符合上述任何⼀个规则，它们将默认通过微信发送给 “企业微信运维团队”。</li></ul><h5 id="52-告警路由实践"><a class="anchor" href="#52-告警路由实践">#</a> 5.2 告警路由实践</h5><p>1、配置 AlertManager，添加子路由规则</p><pre><code>[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: 'smtp.qq.com:587'
  smtp_from: '373370405@qq.com'  # 发件人邮件
  smtp_auth_username: '373370405@qq.com'  # 发件人用户名
  smtp_auth_password: '******' # 发件人密码[授权码]
  smtp_hello: 'qq.com'
  smtp_require_tls: true

# 加载模板文件
templates:
  - '/etc/alertmanager/template/email.tmpl'  # 模板文件的实际路径
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: ['alertname'] #告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s         #当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m     #已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m  #如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: default    #默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器

  # 子路由匹配规则
  routes:
  - match_re:
      job: '(domain_exporter.*|blackbox_http.*)'   #正则匹配
    receiver: 'webhook-dingding-ops'
    continue: true

  - match_re:
      job: 'node.*'                   #正则匹配
    receiver: 'webhook-dingding-ops1'
    continue: true

#  - match:
#      severity: 'critical'           #精准匹配
#    receiver: 'webhook-wechat'
#    continue: true
  
receivers:
- name: 'webhook-dingding-ops'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:5002/alert?token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db'

- name: 'webhook-dingding-ops1'
  webhook_configs:
  - url: 'http://prom-node01.oldxu.net:8060/dingtalk/webhook1/send'

- name: 'default'
  email_configs:
  - to: '373370405@qq.com'
    send_resolved: true # 接受告警恢复的通知
    html: '&#123;&#123; template "email.html" . &#125;&#125;' # 发送邮件内容，调用该模板进行渲染
</code></pre><p>2、检查语法，并重新加载 AlertManager</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Checking <span class="token string">'/etc/alertmanager/alertmanager.yml'</span>  SUCCESS</pre></td></tr><tr><td data-num="3"></td><td><pre>Found:</pre></td></tr><tr><td data-num="4"></td><td><pre> - global config</pre></td></tr><tr><td data-num="5"></td><td><pre> - route</pre></td></tr><tr><td data-num="6"></td><td><pre> - <span class="token number">0</span> inhibit rules</pre></td></tr><tr><td data-num="7"></td><td><pre> - <span class="token number">3</span> receivers</pre></td></tr><tr><td data-num="8"></td><td><pre> - <span class="token number">1</span> templates</pre></td></tr><tr><td data-num="9"></td><td><pre>  SUCCESS</pre></td></tr><tr><td data-num="10"></td><td><pre>  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9093/-/reload</span></pre></td></tr></table></figure><h5 id="53-告警路由验证"><a class="anchor" href="#53-告警路由验证">#</a> 5.3 告警路由验证</h5><p>1、触发 mysql 和 redis 的告警，验证钉钉 - DBA 团队是否能收到告警消息</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop mysqld_exporter.service redis_exporter.service</span></pre></td></tr></table></figure><p>2、触发 node 相关的告警，验证钉钉 - OPS 团队是否能收到告警消息</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node02 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop node_exporter.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop node_exporter.service</span></pre></td></tr></table></figure><p>3、触发 nginx 相关的告警，验证微信运维团队是否能收到告警消息</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop nginx_exporter.service</span></pre></td></tr></table></figure><h4 id="六-alertmanager告警静默"><a class="anchor" href="#六-alertmanager告警静默">#</a> 六. AlertManager 告警静默</h4><h5 id="61-告警静默介绍"><a class="anchor" href="#61-告警静默介绍">#</a> 6.1 告警静默介绍</h5><p>在系统维护或升级过程中，通常会触发⼤量的告警。这些告警往往是维护系统的过程中引起的，⽽⾮真正出现了故障。如果我们不对告警通知进⾏调整，将会收到⼤量的告警信息，造成不必要的⼲扰。</p><p>为了应对这种情况，在维护期间，我们可以在 Alertmanager 中设置静默（silence）规则。这些规则能够禁⽌对外发送告警通知。等到维护⼯作完成后，我们再取消静默规则，恢复正常的告警通知流程。这样可以保证告警系统的有效性，同时避免了在维护期间产⽣⼤量不必要的告警信息。</p><p>告警静默配置有两种⽅式：</p><ul><li>1、先告警后静默： 当告警发⽣时，我们可以直接在 WEB UI 界⾯上对其进⾏静默处理，从⽽停⽌持续发送相同告警信息，确保及时终⽌告警。</li><li>2、先配置静默： 在维护时可能会触发⼤量告警，这时我们可以提前创建静默规则，有效地防⽌告警⻛暴的发⽣。</li></ul><h5 id="62-配置告警静默"><a class="anchor" href="#62-配置告警静默">#</a> 6.2 配置告警静默</h5><p>1、在 AlertManager 的 silences ⻚⾯，点击 New Silences，然后定义开始时间和结束时间（注意这个时间为 UTC 时间，如果转为北京时间要 + 8 ⼩时）</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/7TjIXYP.jpeg" alt="1.jpg"></p><p>2、配置 Matchers，来定义静默规则，例如，我不希望在维护期间收到 node_exporter 这个 job 相关的任何告警，（注意：如果编写多个 Matchers 规则，它们是 “并且” 的关系）</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/R72oOZY.jpeg" alt="2.jpg"></p><p>3、检查最终的静默规则（当 State 状态由 Pending 转为 Active 则说明规则已经激活了，如果是 pengding 表示规则未到指定时间，没⽣效。）</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/oc1zPxo.jpeg" alt="3.jpg"></p><h5 id="63-静默效果验证"><a class="anchor" href="#63-静默效果验证">#</a> 6.3 静默效果验证</h5><p>1、通过程序模拟 Prometheus 发送告警信息，确保其中包含 job=~node_exporter ，以便与静默规则匹配。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下载告警程序</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/prometheus/Alert/alert_test_oldxu</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x alert_test_oldxu</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># docker run -it --rm -v `pwd`:/app/program ubuntu</span></pre></td></tr><tr><td data-num="5"></td><td><pre>root@4c83c1816d0b:/<span class="token comment"># cd /app/program/</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># alertname=nodedown（--alertURL 指定 alertmanager 服务器所在的地址、端⼝以及接⼝）</span></pre></td></tr><tr><td data-num="8"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=nodedown,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=nodedown,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># alertname=cpuhigh</span></pre></td></tr><tr><td data-num="12"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=cpuhigh,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=cpuhigh,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr></table></figure><p>2、访问 AlertManager ⻚⾯，点击 Silenced，然后查看被静默的告警信息</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/VWTmDA8.jpeg" alt="4.jpg"></p><h4 id="七-alertmanager告警抑制"><a class="anchor" href="#七-alertmanager告警抑制">#</a> 七. AlertManager 告警抑制</h4><h5 id="71-告警抑制介绍"><a class="anchor" href="#71-告警抑制介绍">#</a> 7.1 告警抑制介绍</h5><p>当⼀个节点发⽣故障后，那么运⾏在该节点上的服务（nginx、tomcat、redis）都会失去响应，并且各⾃触发告警。因此为了避免被⼤量的告警信息淹没，我们可以设定⼀个抑制规则：当检测到节点故障，则⾃动抑制那些因节点故障⽽产⽣的次要告警，从⽽让⽤户将精⼒集中在真正的故障所在。</p><p>要实现告警抑制（Inhibition），就需要定义⼀些规则告诉 Alertmanager 在什么情况下应该阻⽌告警发送通知。避免重复或不必要的告警，抑制规则由以下⼏个关键参数构成：</p><ul><li>source_match 和 source_matchers（正则匹配）：源告警，表示已经触发并且被识别为重要的告警。</li><li>target_match 和 target_matchers（正则匹配）：⽬标告警，则是那些可能 “由源告警所引起的告警”。当源告警被触发时，我们不希望这些⽬标告警发送通知，因为它们是源告警故障引起的告警。</li><li>equal：⽤于指定源告警和⽬标告警之间必须匹配的标签，以确保抑制的相关性。</li></ul><p>示例配置：如果检测到节点故障告警，则⾃动抑制该节点上所有服务的告警。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>inhibit_rules:</pre></td></tr><tr><td data-num="2"></td><td><pre>- source_matchers:</pre></td></tr><tr><td data-num="3"></td><td><pre>    - alertname <span class="token operator">=</span> <span class="token string">"NodeDown"</span> <span class="token comment"># 源告警是节点故障告警。</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  target_matchers:</pre></td></tr><tr><td data-num="5"></td><td><pre>    - job <span class="token operator">=~</span> <span class="token string">".*"</span>     <span class="token comment"># ⽬标告警可以是任何 job 产⽣的，因为⼀个节点上的服务会被划分到不同的 job</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  equal: <span class="token punctuation">[</span><span class="token string">"instance"</span><span class="token punctuation">]</span> <span class="token comment"># 确保只有当源告警和⽬标告警具有相同的 instance 的值时，⽬标告警才会被抑制。</span></pre></td></tr></table></figure><h5 id="72-告警抑制场景-1"><a class="anchor" href="#72-告警抑制场景-1">#</a> 7.2 告警抑制场景 - 1</h5><p>1、模拟节点故障，并且模拟因为节点故障从⽽造成的其他级联故障；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下载告警程序</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/prometheus/Alert/alert_test_oldxu</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x alert_test_oldxu</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># docker run -it --rm -v `pwd`:/app/program ubuntu</span></pre></td></tr><tr><td data-num="5"></td><td><pre>root@4c83c1816d0b:/<span class="token comment"># cd /app/program/</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 主要故障</span></pre></td></tr><tr><td data-num="8"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=NodeDown,instance=prom-node01.oldxu.net,job=node_exporter"</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 级联故障</span></pre></td></tr><tr><td data-num="11"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=tomcatDown,instance=prom-node01.oldxu.net,job=tomcat_exporter"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=NginxDown,instance=prom-node01.oldxu.net,job=nginx_exporter"</span></pre></td></tr></table></figure><p>2、正常情况下我们会收到 3 条告警消息，但最为重要的就是节点 Down 机，其他告警消息都是因为节点 Down ⽽产⽣的级联故障。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/9F9Z6xx.jpeg" alt="5.jpg"></p><p>3、配置抑制规则，当节点出现故障，则抑制该节点上，其他应⽤因为节点故障⽽发出的级联故障</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>inhibit_rules:</pre></td></tr><tr><td data-num="3"></td><td><pre>- source_matchers:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - alertname <span class="token operator">=</span> <span class="token string">"NodeDown"</span> <span class="token comment"># 假设当节点故障时，触发的告警名为 "NodeDown"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  target_matchers:</pre></td></tr><tr><td data-num="6"></td><td><pre>    - job <span class="token operator">=~</span> <span class="token string">".*"</span>            <span class="token comment"># 则抑制该节点上所有应⽤发送的故障，不论他是哪个 job 产⽣的</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  equal: <span class="token punctuation">[</span><span class="token string">"instance"</span><span class="token punctuation">]</span>        <span class="token comment"># instance 必须相等，才能表示是同⼀个节点上的告警</span></pre></td></tr><tr><td data-num="8"></td><td><pre> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml </span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9093/-/reload</span></pre></td></tr></table></figure><p>4、再次模拟节点故障，以及节点故障所造成的应⽤级联故障</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 主要故障</span></pre></td></tr><tr><td data-num="2"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=NodeDown,instance=prom-node01.oldxu.net,job=node_exporter"</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 级联故障</span></pre></td></tr><tr><td data-num="5"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=tomcatDown,instance=prom-node01.oldxu.net,job=tomcat_exporter"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=NginxDown,instance=prom-node01.oldxu.net,job=nginx_exporter"</span></pre></td></tr></table></figure><p>5、验证最终</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/NO5EVWB.jpeg" alt="7.jpg"></p><h5 id="73-告警抑制场景-2"><a class="anchor" href="#73-告警抑制场景-2">#</a> 7.3 告警抑制场景 - 2</h5><p>1、假设我们运⾏了 MySQL 主从，我们的告警规则如下：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>groups:</pre></td></tr><tr><td data-num="2"></td><td><pre>- name: database-alerts</pre></td></tr><tr><td data-num="3"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="4"></td><td><pre>  - alert: 主库down机了</pre></td></tr><tr><td data-num="5"></td><td><pre>    expr: up<span class="token punctuation">&#123;</span>service<span class="token operator">=</span><span class="token string">"database"</span>, <span class="token assign-left variable">role</span><span class="token operator">=</span><span class="token string">"master"</span><span class="token punctuation">&#125;</span> <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="7"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="8"></td><td><pre>      severity: <span class="token string">'critical'</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      service: <span class="token string">'database'</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      role: <span class="token string">'master'</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="12"></td><td><pre>    summary: <span class="token string">"master database down"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    </pre></td></tr><tr><td data-num="14"></td><td><pre> - alert: 从库down机了</pre></td></tr><tr><td data-num="15"></td><td><pre>   expr: up<span class="token punctuation">&#123;</span>service<span class="token operator">=</span><span class="token string">"database"</span>, <span class="token assign-left variable">role</span><span class="token operator">=</span><span class="token string">"slave"</span><span class="token punctuation">&#125;</span> <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   for: 5m</pre></td></tr><tr><td data-num="17"></td><td><pre>   labels:</pre></td></tr><tr><td data-num="18"></td><td><pre>     severity: <span class="token string">'warning'</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     service: <span class="token string">'database'</span></pre></td></tr><tr><td data-num="20"></td><td><pre>     role: <span class="token string">'slave'</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   annotations:</pre></td></tr><tr><td data-num="22"></td><td><pre>   summary: <span class="token string">"slave database down"</span></pre></td></tr></table></figure><p>2、接下来，模拟主库异常和从库异常，看是否会收到两条告警消息。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># alertname = 节点故障（--alertURL 指定 alertmanager 服务器所在的地址、端⼝以及接⼝）</span></pre></td></tr><tr><td data-num="2"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=主库down机了,instance=mysql-master.oldxu.net,severity=critical,role=master,service=database,job=mysql_exporter"</span></pre></td></tr><tr><td data-num="4"></td><td><pre> </pre></td></tr><tr><td data-num="5"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=从库down机了,instance=mysql-slave.oldxu.net,severity=critical,role=slave,service=database,job=mysql_exporter"</span></pre></td></tr></table></figure><p>3、配置抑制规则，当主库出现故障，则抑制从库的故障</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/alertmanager/alertmanager.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>inhibit_rules:</pre></td></tr><tr><td data-num="3"></td><td><pre>- source_match:</pre></td></tr><tr><td data-num="4"></td><td><pre>    service: <span class="token string">"database"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    role: <span class="token string">"master"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  target_match:</pre></td></tr><tr><td data-num="7"></td><td><pre>    role: <span class="token string">"slave"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  equal: <span class="token punctuation">[</span><span class="token string">"service"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9093/-/reload</span></pre></td></tr></table></figure><h4 id="八-aleartmanager高可用"><a class="anchor" href="#八-aleartmanager高可用">#</a> 八. AleartManager ⾼可⽤</h4><h5 id="81-alertmanager传统架构"><a class="anchor" href="#81-alertmanager传统架构">#</a> 8.1 AlertManager 传统架构</h5><p>在⼤多数情况下，AlertManager 组件通常以单点架构存在，如下图所示。如果单点的 AlertManager 发⽣故障，将导致所有消息都⽆法及时发送，也就意味着系统即使出现了故障，我们也⽆法第⼀时间获取到对应的告警信息。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/IGhyGAQ.jpeg" alt="8.jpg"></p><h5 id="82-alertmanager高可用架构"><a class="anchor" href="#82-alertmanager高可用架构">#</a> 8.2 AlertManager ⾼可⽤架构</h5><p>为了解决多个 AlertManager 之间的信息传递问题，AlertManager 引⼊了 Gossip 机制。这种机制类似于⼈们之间的留⾔传递，</p><p>通过 Gossip 多个 AlertManager 之间可以及时共享相同的告警信息。这意味着，即使多个 AlertManager 分别接收到相同的告警信息，系统也能确保只有⼀个告警通知被发送给 Receiver。此外，即便其中⼀台 AlertManager 发⽣故障，也不会对其他节点的消息传递产⽣影响。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/7bf61kj.jpeg" alt="1.jpg"></p><h5 id="83-alertmanager高可用配置实践"><a class="anchor" href="#83-alertmanager高可用配置实践">#</a> 8.3 AlertManager ⾼可⽤配置实践</h5><p>注意：需要保证每台的 /etc/alertmanager/alertmanager.yml 的配置是⾼度⼀致的。</p><table><thead><tr><th style="text-align:center">主机名称</th><th style="text-align:center">IP 地址</th><th style="text-align:center">角色</th></tr></thead><tbody><tr><td style="text-align:center"><a target="_blank" rel="noopener" href="http://prom-node01.oldxu.net">prom-node01.oldxu.net</a></td><td style="text-align:center">192.168.40.221</td><td style="text-align:center">AlertManager-1</td></tr><tr><td style="text-align:center"><a target="_blank" rel="noopener" href="http://prom-node02.oldxu.net">prom-node02.oldxu.net</a></td><td style="text-align:center">192.168.40.222</td><td style="text-align:center">AlertManager-2</td></tr><tr><td style="text-align:center"><a target="_blank" rel="noopener" href="http://prom-node03.oldxu.net">prom-node03.oldxu.net</a></td><td style="text-align:center">192.168.40.223</td><td style="text-align:center">AlertManager-3</td></tr></tbody></table><p>1、将 node01 节点上的，AlertManager 拷⻉⾄其他两个节点；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># scp -rp /etc/alertmanager-0.26.0.linux-amd64/ root@192.168.40.222:/etc/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># scp -rp /etc/alertmanager-0.26.0.linux-amd64/ root@192.168.40.223:/etc/</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># node02 配置软链接</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@prom-node02 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/alertmanager-0.26.0.linux-amd64/ /etc/alertmanager</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># node03 配置软链接</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/alertmanager-0.26.0.linux-amd64/ /etc/alertmanager</span></pre></td></tr></table></figure><p>2、在所有节点上，准备 alertmanager_ha.service 的启动配置⽂件（--cluster.listen-address: 当前实例集群服务监听地址 、--cluster.peer: 关联的其它实例地址</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop alertmanager</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">vim</span> /usr/lib/systemd/system/alertmanager_ha.service</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>alertmanager</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/etc/alertmanager/alertmanager <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  --web.listen-address<span class="token operator">=</span>:9093 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  --cluster.listen-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0:9094 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token parameter variable">--cluster.peer</span><span class="token operator">=</span><span class="token number">192.168</span>.40.221:9094 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token parameter variable">--cluster.peer</span><span class="token operator">=</span><span class="token number">192.168</span>.40.222:9094 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token parameter variable">--cluster.peer</span><span class="token operator">=</span><span class="token number">192.168</span>.40.223:9094 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  --cluster.peer-timeout<span class="token operator">=</span>15s <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token parameter variable">--config.file</span><span class="token operator">=</span>/etc/alertmanager/alertmanager.yml <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token parameter variable">--storage.path</span><span class="token operator">=</span>/etc/alertmanager/data <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token parameter variable">--data.retention</span><span class="token operator">=</span>120h</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># systemctl daemon-reload </span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># systemctl start alertmanager_ha.service &amp;&amp;  systemctl start alertmanager_ha.service</span></pre></td></tr></table></figure><p>3、检查 AlertManager 集群状态</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/mZDdXSL.jpeg" alt="2.jpg"></p><p>4、配置 Prometheus 对接多个 AlertManager 实例</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>alerting:</pre></td></tr><tr><td data-num="3"></td><td><pre>  alertmanagers:</pre></td></tr><tr><td data-num="4"></td><td><pre>  - static_configs:</pre></td></tr><tr><td data-num="5"></td><td><pre>    - targets:</pre></td></tr><tr><td data-num="6"></td><td><pre>      - prom-node01.oldxu.net:9093</pre></td></tr><tr><td data-num="7"></td><td><pre>      - prom-node02.oldxu.net:9093</pre></td></tr><tr><td data-num="8"></td><td><pre>      - prom-node03.oldxu.net:9093</pre></td></tr><tr><td data-num="9"></td><td><pre>      </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="84-alertmanager高可用结果验证"><a class="anchor" href="#84-alertmanager高可用结果验证">#</a> 8.4 AlertManager ⾼可⽤结果验证</h5><p>1、测试集群同步状态，当在⼀个节点上创建了⼀个静默（Silence）记录，其他节点的监控⻚⾯能够即时显示该静默的信息。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/WuTLtnr.jpeg" alt="3.jpg"></p><p>2、通过使⽤ curl 命令模拟 Prometheus，将同⼀条告警消息分别发送到两个 AlertManager 实例，验证最终是否只会收到⼀条消息。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下载告警程序</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/prometheus/Alert/alert_test_oldxu</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x alert_test_oldxu</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># docker run -it --rm -v `pwd`:/app/program ubuntu</span></pre></td></tr><tr><td data-num="5"></td><td><pre>root@4c83c1816d0b:/<span class="token comment"># cd /app/program/</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># alertname=nodedown（--alertURL 指定 alertmanager 服务器所在的地址、端⼝以及接⼝）</span></pre></td></tr><tr><td data-num="8"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.221:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=nodedown,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>./alert_test_oldxu <span class="token parameter variable">--alertURL</span><span class="token operator">=</span><span class="token string">"http://192.168.40.222:9093/api/v1/alerts"</span> <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"alertname=nodedown,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter"</span></pre></td></tr></table></figure><p>3、根据此前的规则设定，node 相关的告警，最终会发送到 “钉钉的 OPS 团队”，并且只会有⼀条告警消息，⽽不会出现多条重复才对。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/PPRwiy6.jpeg" alt="5.jpg"></p><p>4、尝试停⽌掉某台 AlertManager 实例，验证消息是否还能正常发送。</p><div class="tags"><a href="/tags/Prometheus/" rel="tag"><i class="ic i-tag"></i>Prometheus</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/posts/4081185382.html">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2025-07-13 22:01:09" itemprop="dateModified" datetime="2025-07-13T22:01:09+08:00">2025-07-13</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Xu Yong 微信支付"><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Xu Yong 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Xu Yong<i class="ic i-at"><em>@</em></i>LinuxSre云原生</li><li class="link"><strong>本文链接：</strong><a href="http://ixuyong.cn/posts/4081185382.html" title="Prometheus监控实战（四）">http://ixuyong.cn/posts/4081185382.html</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/posts/4081185381.html" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;o1ceeNN.jpeg" title="Prometheus监控实战（三）"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Prometheus</span><h3>Prometheus监控实战（三）</h3></a></div><div class="item right"><a href="/posts/737291847.html" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;o1ceeNN.jpeg" title="Prometheus监控实战（五）"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>Prometheus</span><h3>Prometheus监控实战（五）</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus%E5%91%8A%E8%AD%A6%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">Prometheus 告警服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-%E4%BB%80%E4%B9%88%E6%98%AFaleartmanager"><span class="toc-number">1.1.</span> <span class="toc-text">一。什么是 AleartManager</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E4%BB%80%E4%B9%88%E6%98%AF-aleartmanager"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 什么是 AleartManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-aleartmanager%E7%89%B9%E6%80%A7"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 AleartManager 特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#13-alertmanager%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 AlertManager 配置说明</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-aleartmanager%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.</span> <span class="toc-text">二. AleartManager 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-aleartmanager%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 AleartManager 安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-aleartmanager%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 AleartManager 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23-alertmanager%E5%90%AF%E5%8A%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 AlertManager 启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-alertmanager%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 AlertManager 测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-prometheus%E5%AF%B9%E6%8E%A5aleartmanager"><span class="toc-number">1.3.</span> <span class="toc-text">三. Prometheus 对接 AleartManager</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#31-%E9%85%8D%E7%BD%AEprom%E5%AF%B9%E6%8E%A5aleartmanager"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 配置 Prom 对接 AleartManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#32-%E9%85%8D%E7%BD%AEprometheus%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 配置 Prometheus 告警规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#33-%E9%85%8D%E7%BD%AEprometheus%E5%8A%A0%E8%BD%BD%E8%A7%84%E5%88%99"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 配置 Prometheus 加载规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#34-%E8%A7%A6%E5%8F%91%E8%A7%84%E5%88%99%E5%B9%B6%E9%AA%8C%E8%AF%81%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 触发规则并验证告警通知</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#35-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.3.5.</span> <span class="toc-text">3.5 ⾃定义邮件告警模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B-alertmanager%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">四. AlertManager 告警通知⽅式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#41-%E9%85%8D%E7%BD%AEalert%E5%AF%B9%E6%8E%A5%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 配置 Alert 对接微信告警</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#42-%E9%85%8D%E7%BD%AEalert%E5%AF%B9%E6%8E%A5%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 配置 Alert 对接钉钉告警</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#421-%E9%85%8D%E7%BD%AEalert%E5%AF%B9%E6%8E%A5%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A61"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">4.2.1 配置 Alert 对接钉钉告警 1</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#422-%E9%85%8D%E7%BD%AEalert%E5%AF%B9%E6%8E%A5%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A62"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">4.2.2 配置 Alert 对接钉钉告警 2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94-alertmanager%E5%91%8A%E8%AD%A6%E8%B7%AF%E7%94%B1"><span class="toc-number">1.5.</span> <span class="toc-text">五. AlertManager 告警路由</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#51-%E5%91%8A%E8%AD%A6%E8%B7%AF%E7%94%B1%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 告警路由介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#52-%E5%91%8A%E8%AD%A6%E8%B7%AF%E7%94%B1%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 告警路由实践</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#53-%E5%91%8A%E8%AD%A6%E8%B7%AF%E7%94%B1%E9%AA%8C%E8%AF%81"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 告警路由验证</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AD-alertmanager%E5%91%8A%E8%AD%A6%E9%9D%99%E9%BB%98"><span class="toc-number">1.6.</span> <span class="toc-text">六. AlertManager 告警静默</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#61-%E5%91%8A%E8%AD%A6%E9%9D%99%E9%BB%98%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 告警静默介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#62-%E9%85%8D%E7%BD%AE%E5%91%8A%E8%AD%A6%E9%9D%99%E9%BB%98"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 配置告警静默</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#63-%E9%9D%99%E9%BB%98%E6%95%88%E6%9E%9C%E9%AA%8C%E8%AF%81"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 静默效果验证</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%83-alertmanager%E5%91%8A%E8%AD%A6%E6%8A%91%E5%88%B6"><span class="toc-number">1.7.</span> <span class="toc-text">七. AlertManager 告警抑制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#71-%E5%91%8A%E8%AD%A6%E6%8A%91%E5%88%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 告警抑制介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#72-%E5%91%8A%E8%AD%A6%E6%8A%91%E5%88%B6%E5%9C%BA%E6%99%AF-1"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 告警抑制场景 - 1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#73-%E5%91%8A%E8%AD%A6%E6%8A%91%E5%88%B6%E5%9C%BA%E6%99%AF-2"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 告警抑制场景 - 2</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AB-aleartmanager%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">1.8.</span> <span class="toc-text">八. AleartManager ⾼可⽤</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#81-alertmanager%E4%BC%A0%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 AlertManager 传统架构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#82-alertmanager%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 AlertManager ⾼可⽤架构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#83-alertmanager%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.8.3.</span> <span class="toc-text">8.3 AlertManager ⾼可⽤配置实践</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#84-alertmanager%E9%AB%98%E5%8F%AF%E7%94%A8%E7%BB%93%E6%9E%9C%E9%AA%8C%E8%AF%81"><span class="toc-number">1.8.4.</span> <span class="toc-text">8.4 AlertManager ⾼可⽤结果验证</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/posts/1595025559.html" rel="bookmark" title="Prometheus监控实战（一）">Prometheus监控实战（一）</a></li><li><a href="/posts/3386060324.html" rel="bookmark" title="PromQL快速入门（二）">PromQL快速入门（二）</a></li><li><a href="/posts/4081185381.html" rel="bookmark" title="Prometheus监控实战（三）">Prometheus监控实战（三）</a></li><li class="active"><a href="/posts/4081185382.html" rel="bookmark" title="Prometheus监控实战（四）">Prometheus监控实战（四）</a></li><li><a href="/posts/737291847.html" rel="bookmark" title="Prometheus监控实战（五）">Prometheus监控实战（五）</a></li><li><a href="/posts/2041568856.html" rel="bookmark" title="Prometheus监控Kubernetes">Prometheus监控Kubernetes</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Xu Yong" src="/assets/avatar.png"><p class="name" itemprop="name">Xu Yong</p><div class="description" itemprop="description">专注于 Linux 运维、云计算、云原⽣等技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">50</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">15</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">18</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/xyapples" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;xyapples"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://gitee.com/chinagei" class="item gitee" title="https:&#x2F;&#x2F;gitee.com&#x2F;chinagei"><i class="ic i-gitee"></i></a><a href="mailto:373370405@qq.com" class="item email" title="mailto:373370405@qq.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-about"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/posts/737291847.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/posts/4081185381.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Prometheus/" title="分类于Prometheus">Prometheus</a></div><span><a href="/posts/4081185382.html">Prometheus监控实战（四）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于Linux">Linux</a></div><span><a href="/posts/1922841233.html">Rsync服务实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Tomcat/" title="分类于Tomcat">Tomcat</a></div><span><a href="/posts/4201058646.html">Tomcat配置管理实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/312010518.html">K8s亲和力Affinity</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/2771271649.html">云原生K8s安全专家CKS认证考题详解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于Linux">Linux</a></div><span><a href="/posts/2260957686.html">Linux—Centos7修改网卡名称</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ELKStack/" title="分类于ELKStack">ELKStack</a></div><span><a href="/posts/570469260.html">ELK收集Kubernetes组件日志分析与实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3890389502.html">K8S持久化存储NFS+StorageClass</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Prometheus/" title="分类于Prometheus">Prometheus</a></div><span><a href="/posts/4081185381.html">Prometheus监控实战（三）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/858611107.html">K8s服务发布Service</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Xu Yong @ LinuxSre云原生</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.5m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">22:57</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `posts/4081185382.html`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hrmmi -->