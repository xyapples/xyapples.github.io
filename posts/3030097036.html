<!-- build time:Mon Jun 30 2025 20:51:39 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico"><link rel="alternate" href="/rss.xml" title="LinuxSre云原生" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="LinuxSre云原生" type="application/atom+xml"><link rel="alternate" type="application/json" title="LinuxSre云原生" href="http://ixuyong.cn/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.17"><link rel="modulepreload" href="/js/chunk-GV364XSK.js"><link rel="modulepreload" href="/js/chunk-NYSE5UKM.js"><link rel="modulepreload" href="/js/chunk-RONCYO2S.js"><link rel="modulepreload" href="/js/chunk-THHXCRSX.js"><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/js/comments-DL2IYMPZ.js"><link rel="modulepreload" href="/js/copy-tex-NADCTXPG.js"><link rel="modulepreload" href="/js/post-DA635IH6.js"><link rel="modulepreload" href="/js/quicklink-WEDHL4BA.js"><link rel="modulepreload" href="/js/search-VCZRKTM5.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/waline-NNBYRQEE.js"><link rel="stylesheet" href="/css/comments-F4ZGS7LD.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/waline-IDNZKML2.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="preload" href="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" as="image" fetchpriority="high"><meta name="keywords" content="Kubernetes"><meta name="description" content="专注于 Linux 运维、云计算、云原⽣等技术"><link rel="canonical" href="http://ixuyong.cn/posts/3030097036.html"><title>K8S云原生存储Rook-Ceph</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">K8S云原生存储Rook-Ceph</h1><div class="meta"><span class="item" title="创建时间：2025-04-24 21:43:19"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-04-24T21:43:19+08:00">2025-04-24</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>35k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>32 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">LinuxSre云原生</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" loading="eager" decoding="async" fetchpriority="high" alt="LinuxSre云原生"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Kubernetes/" itemprop="item" rel="index" title="分类于Kubernetes"><span itemprop="name">Kubernetes<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://ixuyong.cn/posts/3030097036.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"><meta itemprop="name" content="Xu Yong"><meta itemprop="description" content="致力于技术布道、普及前沿技术、打造云原生系列标杆博客, 专注于 Linux 运维、云计算、云原⽣等技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LinuxSre云原生"></span><div class="body md" itemprop="articleBody"><h3 id="k8s云原生存储rook-ceph"><a class="anchor" href="#k8s云原生存储rook-ceph">#</a> K8S 云原生存储 Rook-Ceph</h3><h4 id="1-storageclass动态存储"><a class="anchor" href="#1-storageclass动态存储">#</a> 1. StorageClass 动态存储</h4><p>StorageClass：存储类，由 K8s 管理员创建，用于动态 PV 的管理，可以链接至不同的后端存储，比如 Ceph、GlusterFS 等。之后对存储的请求可以指向 StorageClass，然后 StorageClass 会自动的创建、删除 PV。</p><p>实现方式：</p><ul><li>in-tree: 内置于 K8s 核心代码，对于存储的管理，都需要编写相应的代码。</li><li>out-of-tree：由存储厂商提供一个驱动（CSI 或 Flex Volume），安装到 K8s 集群，然后 StorageClass 只需要配置该驱动即可，驱动器会代替 StorageClass 管理存储。</li></ul><p>StorageClass 官网介绍：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/">https://kubernetes.io/docs/concepts/storage/storage-classes/</a></p><h4 id="2-云原生存储rook"><a class="anchor" href="#2-云原生存储rook">#</a> 2. 云原生存储 Rook</h4><p>Rook 是一个自我管理的分布式存储编排系统，它本身并不是存储系统，在存储和 k8s 之前搭建了一个桥梁，使存储系统的搭建或者维护变得特别简单，Rook 将分布式存储系统转变为自我管理、自我扩展、自我修复的存储服务。它让一些存储的操作，比如部署、配置、扩容、升级、迁移、灾难恢复、监视和资源管理变得自动化，无需人工处理。并且 Rook 支持 CSI，可以利用 CSI 做一些 PVC 的快照、扩容、克隆等操作。</p><p>Rook 官网介绍：<a target="_blank" rel="noopener" href="https://rook.io/">https://rook.io/</a></p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/CK4Gn1u.jpeg" alt="Snipaste_2025-05-07_20-15-59.jpg"></p><h4 id="3-rook-安装"><a class="anchor" href="#3-rook-安装">#</a> 3. Rook 安装</h4><p>环境准备</p><ul><li>K8s 集群至少五个节点，每个节点的内存不低于 5G，CPU 不低于 2 核</li><li>所有节点时间同步</li><li>至少有三个存储节点，并且每个节点至少有一个裸盘，k8s-master03、k8s-node01、k8s-node02 增加裸盘</li></ul><h5 id="31-下载-rook-安装文件"><a class="anchor" href="#31-下载-rook-安装文件">#</a> 3.1 下载 Rook 安装文件</h5><pre><code>[root@k8s-master01 ~]# git clone --single-branch --branch v1.17.2 https://github.com/rook/rook.git
</code></pre><h5 id="32-配置更改"><a class="anchor" href="#32-配置更改">#</a> 3.2 配置更改</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd rook/deploy/examples</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># vim operator.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  ROOK_CSI_CEPH_IMAGE: <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/cephcsi:v3.14.0"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  ROOK_CSI_REGISTRAR_IMAGE: <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-node-driver-registrar:v2.13.0"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  ROOK_CSI_RESIZER_IMAGE: <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-resizer:v1.13.1"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  ROOK_CSI_PROVISIONER_IMAGE: <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-provisioner:v5.1.0"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  ROOK_CSI_SNAPSHOTTER_IMAGE: <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-snapshotter:v8.2.0"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  ROOK_CSI_ATTACHER_IMAGE: <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-attacher:v4.8.0"</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#ROOK_ENABLE_DISCOVERY_DAEMON 改成 true 即可</span></pre></td></tr><tr><td data-num="11"></td><td><pre>ROOK_ENABLE_DISCOVERY_DAEMON: <span class="token string">"true"</span></pre></td></tr></table></figure><h5 id="33-部署-rook"><a class="anchor" href="#33-部署-rook">#</a> 3.3 部署 rook</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ceph<span class="token punctuation">]</span><span class="token comment"># kubectl create -f crds.yaml -f common.yaml -f operator.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n rook-ceph</span></pre></td></tr><tr><td data-num="3"></td><td><pre>NAME                                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="4"></td><td><pre>rook-ceph-operator-84ff77778b-7ww2w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          91m</pre></td></tr><tr><td data-num="5"></td><td><pre>rook-discover-6j68f                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          82m</pre></td></tr><tr><td data-num="6"></td><td><pre>rook-discover-9w4kt                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          82m</pre></td></tr><tr><td data-num="7"></td><td><pre>rook-discover-h2zfm                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          82m</pre></td></tr><tr><td data-num="8"></td><td><pre>rook-discover-hsz8b                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m</pre></td></tr><tr><td data-num="9"></td><td><pre>rook-discover-rj4t7                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          82m</pre></td></tr></table></figure><h4 id="4创建-ceph-集群"><a class="anchor" href="#4创建-ceph-集群">#</a> 4. 创建 Ceph 集群</h4><h5 id="41-配置更改"><a class="anchor" href="#41-配置更改">#</a> 4.1 配置更改</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># vim cluster.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="3"></td><td><pre>    image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/cephv19.2.2:v19.2.2</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="5"></td><td><pre>  skipUpgradeChecks: <span class="token boolean">true</span>     <span class="token comment">#改为 true，跳过升级</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  dashboard:</pre></td></tr><tr><td data-num="8"></td><td><pre>    enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment"># serve the dashboard under a subpath (useful when you are accessing the dashboard via a reverse proxy)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment"># urlPrefix: /ceph-dashboard</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment"># serve the dashboard at the given port.</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment"># port: 8443</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment"># serve the dashboard using SSL</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    ssl: <span class="token boolean">false</span>          <span class="token comment">#改为 false</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="16"></td><td><pre>  storage: <span class="token comment"># cluster level storage configuration and selection</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    useAllNodes: <span class="token boolean">false</span>      <span class="token comment">#改为 false, 不使用所有的节点当 osd</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    useAllDevices: <span class="token boolean">false</span>    <span class="token comment">#改为 false, 不使用所有的磁盘当 osd</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">#     deviceFilter: "^sd."</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    nodes:</pre></td></tr><tr><td data-num="22"></td><td><pre>    - name: <span class="token string">"k8s-master03"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      devices:</pre></td></tr><tr><td data-num="24"></td><td><pre>      - name: <span class="token string">"sdb"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    - name: <span class="token string">"k8s-node01"</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      devices:</pre></td></tr><tr><td data-num="27"></td><td><pre>      - name: <span class="token string">"sdb"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    - name: <span class="token string">"k8s-node02"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      devices:</pre></td></tr><tr><td data-num="30"></td><td><pre>      - name: <span class="token string">"sdb"</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr></table></figure><p>注意：新版必须采用裸盘，即未格式化的磁盘。其中 k8s-master03、 k8s-node01、 k8s-node02 有新加的一个磁盘，可以通过 lsblk -f 查看新添加的磁盘名称。建议最少三个节点，否则后面的试验可能会出现问题</p><h5 id="42-创建-ceph-集群"><a class="anchor" href="#42-创建-ceph-集群">#</a> 4.2 创建 Ceph 集群</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl create -f cluster.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n rook-ceph</span></pre></td></tr><tr><td data-num="3"></td><td><pre>NAME                                                     READY   STATUS      RESTARTS        AGE</pre></td></tr><tr><td data-num="4"></td><td><pre>csi-cephfsplugin-5nmnl                                   <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="5"></td><td><pre>csi-cephfsplugin-6b6ct                                   <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="6"></td><td><pre>csi-cephfsplugin-8xlnl                                   <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="7"></td><td><pre>csi-cephfsplugin-fh9w5                                   <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="8"></td><td><pre>csi-cephfsplugin-mslst                                   <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="9"></td><td><pre>csi-cephfsplugin-provisioner-59bd447c6d-5zwj2            <span class="token number">6</span>/6     Running     <span class="token number">0</span>               61s</pre></td></tr><tr><td data-num="10"></td><td><pre>csi-cephfsplugin-provisioner-59bd447c6d-7t2kg            <span class="token number">6</span>/6     Running     <span class="token number">2</span> <span class="token punctuation">(</span>20s ago<span class="token punctuation">)</span>     61s</pre></td></tr><tr><td data-num="11"></td><td><pre>csi-rbdplugin-5gvmp                                      <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="12"></td><td><pre>csi-rbdplugin-dzcs4                                      <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="13"></td><td><pre>csi-rbdplugin-n82b5                                      <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="14"></td><td><pre>csi-rbdplugin-provisioner-6856fb8b86-86hw8               <span class="token number">6</span>/6     Running     <span class="token number">0</span>               19s</pre></td></tr><tr><td data-num="15"></td><td><pre>csi-rbdplugin-provisioner-6856fb8b86-lj9s4               <span class="token number">6</span>/6     Running     <span class="token number">0</span>               19s</pre></td></tr><tr><td data-num="16"></td><td><pre>csi-rbdplugin-vh8j2                                      <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="17"></td><td><pre>csi-rbdplugin-xfgwr                                      <span class="token number">3</span>/3     Running     <span class="token number">1</span> <span class="token punctuation">(</span>60m ago<span class="token punctuation">)</span>     62m</pre></td></tr><tr><td data-num="18"></td><td><pre>rook-ceph-crashcollector-k8s-master01-bbc78d496-bzjk8    <span class="token number">1</span>/1     Running     <span class="token number">0</span>               8m26s</pre></td></tr><tr><td data-num="19"></td><td><pre>rook-ceph-crashcollector-k8s-master03-765ff964bb-95wmt   <span class="token number">1</span>/1     Running     <span class="token number">0</span>               28m</pre></td></tr><tr><td data-num="20"></td><td><pre>rook-ceph-crashcollector-k8s-node01-7cf4c4b6b6-r4n84     <span class="token number">1</span>/1     Running     <span class="token number">0</span>               20m</pre></td></tr><tr><td data-num="21"></td><td><pre>rook-ceph-crashcollector-k8s-node02-f887f8cf9-jz2l8      <span class="token number">1</span>/1     Running     <span class="token number">0</span>               28m</pre></td></tr><tr><td data-num="22"></td><td><pre>rook-ceph-detect-version-nsrwj                           <span class="token number">0</span>/1     Init:0/1    <span class="token number">0</span>               3s</pre></td></tr><tr><td data-num="23"></td><td><pre>rook-ceph-exporter-k8s-master01-5cd4577b79-ckd4m         <span class="token number">1</span>/1     Running     <span class="token number">0</span>               8m26s</pre></td></tr><tr><td data-num="24"></td><td><pre>rook-ceph-exporter-k8s-master03-75f4cf6f7-hc9zb          <span class="token number">1</span>/1     Running     <span class="token number">0</span>               28m</pre></td></tr><tr><td data-num="25"></td><td><pre>rook-ceph-exporter-k8s-node01-96fc7cf49-d2r24            <span class="token number">1</span>/1     Running     <span class="token number">0</span>               20m</pre></td></tr><tr><td data-num="26"></td><td><pre>rook-ceph-exporter-k8s-node02-777b9f555b-7j6cz           <span class="token number">1</span>/1     Running     <span class="token number">0</span>               27m</pre></td></tr><tr><td data-num="27"></td><td><pre>rook-ceph-mgr-a-6f46b4b945-q6cjb                         <span class="token number">3</span>/3     Running     <span class="token number">3</span> <span class="token punctuation">(</span>14m ago<span class="token punctuation">)</span>     35m</pre></td></tr><tr><td data-num="28"></td><td><pre>rook-ceph-mgr-b-5d4cc5465b-8dfh6                         <span class="token number">3</span>/3     Running     <span class="token number">0</span>               35m</pre></td></tr><tr><td data-num="29"></td><td><pre>rook-ceph-mon-a-7c7b7555c7-nlhwg                         <span class="token number">2</span>/2     Running     <span class="token number">2</span> <span class="token punctuation">(</span>6m14s ago<span class="token punctuation">)</span>   51m</pre></td></tr><tr><td data-num="30"></td><td><pre>rook-ceph-mon-c-559bcf95fd-cl62w                         <span class="token number">2</span>/2     Running     <span class="token number">0</span>               8m27s</pre></td></tr><tr><td data-num="31"></td><td><pre>rook-ceph-mon-d-7dbc6b8f5c-8264t                         <span class="token number">2</span>/2     Running     <span class="token number">0</span>               28m</pre></td></tr><tr><td data-num="32"></td><td><pre>rook-ceph-operator-645478ff5b-jdcrp                      <span class="token number">1</span>/1     Running     <span class="token number">0</span>               102m</pre></td></tr><tr><td data-num="33"></td><td><pre>rook-ceph-osd-0-6d9cf78f76-4zhx8                         <span class="token number">2</span>/2     Running     <span class="token number">0</span>               12m</pre></td></tr><tr><td data-num="34"></td><td><pre>rook-ceph-osd-1-88c78bbcb-cn48c                          <span class="token number">2</span>/2     Running     <span class="token number">0</span>               5m15s</pre></td></tr><tr><td data-num="35"></td><td><pre>rook-ceph-osd-2-b464c9fc6-458hv                          <span class="token number">2</span>/2     Running     <span class="token number">0</span>               4m29s</pre></td></tr><tr><td data-num="36"></td><td><pre>rook-ceph-osd-prepare-k8s-master03-pwnrc                 <span class="token number">0</span>/1     Completed   <span class="token number">0</span>               86s</pre></td></tr><tr><td data-num="37"></td><td><pre>rook-ceph-osd-prepare-k8s-node01-xxp2j                   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>               83s</pre></td></tr><tr><td data-num="38"></td><td><pre>rook-ceph-osd-prepare-k8s-node02-8nz7x                   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>               78s</pre></td></tr><tr><td data-num="39"></td><td><pre>rook-discover-jzmkr                                      <span class="token number">1</span>/1     Running     <span class="token number">0</span>               91m</pre></td></tr><tr><td data-num="40"></td><td><pre>rook-discover-k7pxt                                      <span class="token number">1</span>/1     Running     <span class="token number">0</span>               91m</pre></td></tr><tr><td data-num="41"></td><td><pre>rook-discover-vqjh5                                      <span class="token number">1</span>/1     Running     <span class="token number">0</span>               91m</pre></td></tr><tr><td data-num="42"></td><td><pre>rook-discover-wk8jq                                      <span class="token number">1</span>/1     Running     <span class="token number">0</span>               91m</pre></td></tr><tr><td data-num="43"></td><td><pre>rook-discover-x8rsn                                      <span class="token number">1</span>/1     Running     <span class="token number">0</span>               91m</pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get cephcluster -n rook-ceph</span></pre></td></tr><tr><td data-num="46"></td><td><pre>NAME        DATADIRHOSTPATH   MONCOUNT   AGE   PHASE   MESSAGE                        HEALTH        EXTERNAL   FSID</pre></td></tr><tr><td data-num="47"></td><td><pre>rook-ceph   /var/lib/rook     <span class="token number">3</span>          63m   Ready   Cluster created successfully   HEALTH_WARN              ca429602-66f4-4a1e-9d5c-a5773a0f594f</pre></td></tr></table></figure><h5 id="43-安装-ceph-snapshot-控制器"><a class="anchor" href="#43-安装-ceph-snapshot-控制器">#</a> 4.3 安装 ceph snapshot 控制器</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># git checkout manual-installation-v1.32.x</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># kubectl create -f snapshotter/ -n kube-system</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># kubectl get po -n kube-system -l app=snapshot-controller</span></pre></td></tr><tr><td data-num="5"></td><td><pre>NAME                    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="6"></td><td><pre>snapshot-controller-0   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          67s</pre></td></tr></table></figure><h4 id="5-安装-ceph-客户端工具"><a class="anchor" href="#5-安装-ceph-客户端工具">#</a> 5. 安装 ceph 客户端工具</h4><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># cd /root/rook/deploy/examples/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl create -f toolbox.yaml -n rook-ceph</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get po -n rook-ceph -l app=rook-ceph-tools</span></pre></td></tr><tr><td data-num="4"></td><td><pre>NAME                               READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="5"></td><td><pre>rook-ceph-tools-7b75b967db-sqddk   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it rook-ceph-tools-7b75b967db-sqddk -n rook-ceph -- bash</span></pre></td></tr><tr><td data-num="7"></td><td><pre>bash-5.1$ ceph status</pre></td></tr><tr><td data-num="8"></td><td><pre>  cluster:</pre></td></tr><tr><td data-num="9"></td><td><pre>    id:     87b85368-9487-4967-a4e4-5970d2e0ec94</pre></td></tr><tr><td data-num="10"></td><td><pre>    health: HEALTH_WARN</pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token number">1</span> mgr modules have recently crashed</pre></td></tr><tr><td data-num="12"></td><td><pre> </pre></td></tr><tr><td data-num="13"></td><td><pre>  services:</pre></td></tr><tr><td data-num="14"></td><td><pre>    mon: <span class="token number">3</span> daemons, quorum b,c <span class="token punctuation">(</span>age 12s<span class="token punctuation">)</span>, out of quorum: a</pre></td></tr><tr><td data-num="15"></td><td><pre>    mgr: a<span class="token punctuation">(</span>active, since 7m<span class="token punctuation">)</span>, standbys: b</pre></td></tr><tr><td data-num="16"></td><td><pre>    osd: <span class="token number">3</span> osds: <span class="token number">3</span> up <span class="token punctuation">(</span>since 8m<span class="token punctuation">)</span>, <span class="token number">3</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>since 3h<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre> </pre></td></tr><tr><td data-num="18"></td><td><pre>  data:</pre></td></tr><tr><td data-num="19"></td><td><pre>    pools:   <span class="token number">0</span> pools, <span class="token number">0</span> pgs</pre></td></tr><tr><td data-num="20"></td><td><pre>    objects: <span class="token number">0</span> objects, <span class="token number">0</span> B</pre></td></tr><tr><td data-num="21"></td><td><pre>    usage:   <span class="token number">82</span> MiB used, <span class="token number">60</span> GiB / <span class="token number">60</span> GiB avail</pre></td></tr><tr><td data-num="22"></td><td><pre>    pgs: </pre></td></tr><tr><td data-num="23"></td><td><pre>	</pre></td></tr><tr><td data-num="24"></td><td><pre>bash-4.4$  ceph osd status</pre></td></tr><tr><td data-num="25"></td><td><pre>ID  HOST           USED  AVAIL  WR OPS  WR DATA  RD OPS  RD DATA  STATE      </pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token number">0</span>  k8s-master03  <span class="token number">20</span>.6M  <span class="token number">19</span>.9G      <span class="token number">0</span>        <span class="token number">0</span>       <span class="token number">0</span>        <span class="token number">0</span>   exists,up  </pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token number">1</span>  k8s-node01    <span class="token number">20</span>.6M  <span class="token number">19</span>.9G      <span class="token number">0</span>        <span class="token number">0</span>       <span class="token number">0</span>        <span class="token number">0</span>   exists,up  </pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token number">2</span>  k8s-node02    <span class="token number">20</span>.6M  <span class="token number">19</span>.9G      <span class="token number">0</span>        <span class="token number">0</span>       <span class="token number">0</span>        <span class="token number">0</span>   exists,up </pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>bash-4.4$ ceph <span class="token function">df</span></pre></td></tr><tr><td data-num="31"></td><td><pre>--- RAW STORAGE ---</pre></td></tr><tr><td data-num="32"></td><td><pre>CLASS    SIZE   AVAIL    USED  RAW USED  %RAW USED</pre></td></tr><tr><td data-num="33"></td><td><pre>hdd    <span class="token number">60</span> GiB  <span class="token number">60</span> GiB  <span class="token number">62</span> MiB    <span class="token number">62</span> MiB       <span class="token number">0.10</span></pre></td></tr><tr><td data-num="34"></td><td><pre>TOTAL  <span class="token number">60</span> GiB  <span class="token number">60</span> GiB  <span class="token number">62</span> MiB    <span class="token number">62</span> MiB       <span class="token number">0.10</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>--- POOLS ---</pre></td></tr><tr><td data-num="37"></td><td><pre>POOL  ID  PGS   STORED  OBJECTS     USED  %USED  MAX AVAIL</pre></td></tr><tr><td data-num="38"></td><td><pre>.mgr   <span class="token number">1</span>    <span class="token number">1</span>  <span class="token number">449</span> KiB        <span class="token number">2</span>  <span class="token number">1.3</span> MiB      <span class="token number">0</span>     <span class="token number">19</span> GiB</pre></td></tr></table></figure><h4 id="6-ceph-dashboard"><a class="anchor" href="#6-ceph-dashboard">#</a> 6. Ceph dashboard</h4><h5 id="61-暴露服务"><a class="anchor" href="#61-暴露服务">#</a> 6.1 暴露服务</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n rook-ceph</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>             AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>rook-ceph-mgr             ClusterIP   <span class="token number">10.96</span>.54.15     <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">9283</span>/TCP            133m</pre></td></tr><tr><td data-num="4"></td><td><pre>rook-ceph-mgr-dashboard   ClusterIP   <span class="token number">10.96</span>.97.117    <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">7000</span>/TCP            133m        <span class="token comment">#暴露 ingresss 也可</span></pre></td></tr><tr><td data-num="5"></td><td><pre>rook-ceph-mon-a           ClusterIP   <span class="token number">10.96</span>.125.216   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">6789</span>/TCP,3300/TCP   170m</pre></td></tr><tr><td data-num="6"></td><td><pre>rook-ceph-mon-b           ClusterIP   <span class="token number">10.96</span>.34.183    <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">6789</span>/TCP,3300/TCP   133m</pre></td></tr><tr><td data-num="7"></td><td><pre>rook-ceph-mon-c           ClusterIP   <span class="token number">10.96</span>.232.252   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">6789</span>/TCP,3300/TCP   133m</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl create -f dashboard-external-http.yaml           #暴露 nodeport</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n rook-ceph rook-ceph-mgr-dashboard-external-http</span></pre></td></tr><tr><td data-num="12"></td><td><pre>NAME                                     TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE</pre></td></tr><tr><td data-num="13"></td><td><pre>rook-ceph-mgr-dashboard-external-https   NodePort   <span class="token number">10.96</span>.11.120   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8443</span>:32611/TCP   45s</pre></td></tr></table></figure><h5 id="62-配置ingress访问ceph"><a class="anchor" href="#62-配置ingress访问ceph">#</a> 6.2 配置 ingress 访问 ceph</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># cat dashboard-ingress-https.yaml </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># This example is for Kubernetes running an nginx-ingress</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># and an ACME (e.g. Let's Encrypt) certificate service</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># The nginx-ingress annotations support the dashboard</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># running using HTTPS with a self-signed certificate</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="9"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num="10"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num="11"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="12"></td><td><pre>  name: rook-ceph-mgr-dashboard</pre></td></tr><tr><td data-num="13"></td><td><pre>  namespace: rook-ceph <span class="token comment"># namespace:cluster</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#  annotations:</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#    kubernetes.io/ingress.class: "nginx"</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#    kubernetes.io/tls-acme: "true"</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#    nginx.ingress.kubernetes.io/server-snippet: |</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#      proxy_ssl_verify off;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>spec:</pre></td></tr><tr><td data-num="22"></td><td><pre>  ingressClassName: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">#  tls:</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">#    - hosts:</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">#        - rook-ceph.hmallleasing.com</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">#      secretName: rook-ceph.example.com</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="28"></td><td><pre>    - host: rook-ceph.hmallleasing.com</pre></td></tr><tr><td data-num="29"></td><td><pre>      http:</pre></td></tr><tr><td data-num="30"></td><td><pre>        paths:</pre></td></tr><tr><td data-num="31"></td><td><pre>          - path: /</pre></td></tr><tr><td data-num="32"></td><td><pre>            pathType: Prefix</pre></td></tr><tr><td data-num="33"></td><td><pre>            backend:</pre></td></tr><tr><td data-num="34"></td><td><pre>              service:</pre></td></tr><tr><td data-num="35"></td><td><pre>                name: rook-ceph-mgr-dashboard</pre></td></tr><tr><td data-num="36"></td><td><pre>                port:</pre></td></tr><tr><td data-num="37"></td><td><pre>                  name: http-dashboard</pre></td></tr></table></figure><h5 id="63-登录"><a class="anchor" href="#63-登录">#</a> 6.3 登录</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>http://192.168.40.100:32611</pre></td></tr><tr><td data-num="2"></td><td><pre>用户名：admin</pre></td></tr><tr><td data-num="3"></td><td><pre>密码：kubectl <span class="token parameter variable">-n</span> rook-ceph get secret rook-ceph-dashboard-password <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"&#123;['data']['password']&#125;"</span> <span class="token operator">|</span> base64 <span class="token parameter variable">--decode</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span></pre></td></tr></table></figure><h4 id="7-ceph-块存储的使用"><a class="anchor" href="#7-ceph-块存储的使用">#</a> 7. Ceph 块存储的使用</h4><p>块存储一般用于一个 Pod 挂载一块存储使用，相当于一个服务器新挂了一个盘，只给一个应用使用。</p><h5 id="71-创建-storageclass-和-ceph-的存储池"><a class="anchor" href="#71-创建-storageclass-和-ceph-的存储池">#</a> 7.1 创建 StorageClass 和 ceph 的存储池</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get csidriver</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME                            ATTACHREQUIRED   PODINFOONMOUNT   STORAGECAPACITY   TOKENREQUESTS   REQUIRESREPUBLISH   MODES        AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>rook-ceph.cephfs.csi.ceph.com   <span class="token boolean">true</span>             <span class="token boolean">false</span>            <span class="token boolean">false</span>             <span class="token operator">&lt;</span>unset<span class="token operator">></span>         <span class="token boolean">false</span>               Persistent   15h       <span class="token comment">#文件存储 csi</span></pre></td></tr><tr><td data-num="4"></td><td><pre>rook-ceph.rbd.csi.ceph.com      <span class="token boolean">true</span>             <span class="token boolean">false</span>            <span class="token boolean">false</span>             <span class="token operator">&lt;</span>unset<span class="token operator">></span>         <span class="token boolean">false</span>               Persistent   15h       <span class="token comment">#块存储 csi</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/rook/deploy/examples/</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># vim csi/rbd/storageclass.yaml</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="9"></td><td><pre>apiVersion: ceph.rook.io/v1</pre></td></tr><tr><td data-num="10"></td><td><pre>kind: CephBlockPool</pre></td></tr><tr><td data-num="11"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="12"></td><td><pre>  name: replicapool</pre></td></tr><tr><td data-num="13"></td><td><pre>  namespace: rook-ceph <span class="token comment"># namespace:cluster</span></pre></td></tr><tr><td data-num="14"></td><td><pre>spec:</pre></td></tr><tr><td data-num="15"></td><td><pre>  failureDomain: <span class="token function">host</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  replicated:</pre></td></tr><tr><td data-num="17"></td><td><pre>    size: <span class="token number">3</span>                <span class="token comment">#数据保存几份，测试环境可以将副本数设置成了 2（不能设置为 1），生产环境最少为 3，且要小于等于 osd 的数量</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="19"></td><td><pre>allowVolumeExpansion: <span class="token boolean">true</span>     <span class="token comment">#是否可以扩容</span></pre></td></tr><tr><td data-num="20"></td><td><pre>reclaimPolicy: Delete          <span class="token comment">#pv 回收策略</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl create -f csi/rbd/storageclass.yaml -n rook-ceph</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get cephblockpool -n rook-ceph</span></pre></td></tr><tr><td data-num="25"></td><td><pre>NAME          PHASE</pre></td></tr><tr><td data-num="26"></td><td><pre>replicapool   Ready</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get sc</span></pre></td></tr><tr><td data-num="28"></td><td><pre>NAME              PROVISIONER                  RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</pre></td></tr><tr><td data-num="29"></td><td><pre>nfs-storage       nfzl.com/nfs                 Delete          Immediate           <span class="token boolean">false</span>                  16h</pre></td></tr><tr><td data-num="30"></td><td><pre>rook-ceph-block   rook-ceph.rbd.csi.ceph.com   Delete          Immediate           <span class="token boolean">true</span>                   37s</pre></td></tr></table></figure><h5 id="72-挂载测试"><a class="anchor" href="#72-挂载测试">#</a> 7.2 挂载测试</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat ceph-block-pvc.yaml        #创建 PVC</span></pre></td></tr><tr><td data-num="2"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="3"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num="4"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="5"></td><td><pre>  name: ceph-block-pvc</pre></td></tr><tr><td data-num="6"></td><td><pre>spec:</pre></td></tr><tr><td data-num="7"></td><td><pre>  storageClassName: <span class="token string">"rook-ceph-block"</span>     <span class="token comment"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num="9"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num="10"></td><td><pre>  resources:</pre></td></tr><tr><td data-num="11"></td><td><pre>    requests:</pre></td></tr><tr><td data-num="12"></td><td><pre>      storage: 1Gi                      <span class="token comment"># 根据业务实际大小进行资源申请</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f ceph-block-pvc.yaml </span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc</span></pre></td></tr><tr><td data-num="17"></td><td><pre>NAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE</pre></td></tr><tr><td data-num="18"></td><td><pre>ceph-block-pvc   Bound    pvc-86c94d8d-c359-47b8-b5d3-31dcdaf86551   1Gi        RWO            rook-ceph-block   3s</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv</span></pre></td></tr><tr><td data-num="21"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS      REASON   AGE</pre></td></tr><tr><td data-num="22"></td><td><pre>pvc-86c94d8d-c359-47b8-b5d3-31dcdaf86551   1Gi        RWO            Delete           Bound    default/ceph-block-pvc   rook-ceph-block</pre></td></tr><tr><td data-num="23"></td><td><pre>	  </pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat ceph-block-pvc-pod.yaml    #挂载 PVC 测试 </span></pre></td></tr><tr><td data-num="25"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="26"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num="27"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="28"></td><td><pre>  name: ceph-block-pvc-pod</pre></td></tr><tr><td data-num="29"></td><td><pre>spec:</pre></td></tr><tr><td data-num="30"></td><td><pre>  containers:</pre></td></tr><tr><td data-num="31"></td><td><pre>  - name: ceph-block-pvc-pod</pre></td></tr><tr><td data-num="32"></td><td><pre>    image: nginx</pre></td></tr><tr><td data-num="33"></td><td><pre>    volumeMounts:</pre></td></tr><tr><td data-num="34"></td><td><pre>    - name: nginx-page</pre></td></tr><tr><td data-num="35"></td><td><pre>      mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num="36"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num="37"></td><td><pre>  - name: nginx-page</pre></td></tr><tr><td data-num="38"></td><td><pre>    persistentVolumeClaim:      </pre></td></tr><tr><td data-num="39"></td><td><pre>      claimName: ceph-block-pv</pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f ceph-block-pvc-pod.yaml</span></pre></td></tr></table></figure><h5 id="73-statefulset-volumeclaimtemplates"><a class="anchor" href="#73-statefulset-volumeclaimtemplates">#</a> 7.3 StatefulSet volumeClaimTemplates</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat ceph-block-pvc-sts.yaml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="3"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num="4"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="5"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num="6"></td><td><pre>  labels:</pre></td></tr><tr><td data-num="7"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num="8"></td><td><pre>spec:</pre></td></tr><tr><td data-num="9"></td><td><pre>  ports:</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  - port: <span class="token number">80</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    name: web</pre></td></tr><tr><td data-num="13"></td><td><pre>      clusterIP: None</pre></td></tr><tr><td data-num="14"></td><td><pre>      selector:</pre></td></tr><tr><td data-num="15"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num="16"></td><td><pre>---</pre></td></tr><tr><td data-num="17"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num="18"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num="19"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="20"></td><td><pre>  name: web</pre></td></tr><tr><td data-num="21"></td><td><pre>spec:</pre></td></tr><tr><td data-num="22"></td><td><pre>  selector:</pre></td></tr><tr><td data-num="23"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num="24"></td><td><pre>      app: nginx <span class="token comment"># 必须匹配 .spec.template.metadata.labels</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  serviceName: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  replicas: <span class="token number">3</span> <span class="token comment"># 默认值是 1</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  template:</pre></td></tr><tr><td data-num="28"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num="29"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="30"></td><td><pre>        app: nginx <span class="token comment"># 必须匹配 .spec.selector.matchLabels</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    spec:</pre></td></tr><tr><td data-num="32"></td><td><pre>      containers:</pre></td></tr><tr><td data-num="33"></td><td><pre>      - name: nginx</pre></td></tr><tr><td data-num="34"></td><td><pre>        image: nginx:1.20</pre></td></tr><tr><td data-num="35"></td><td><pre>        ports:</pre></td></tr><tr><td data-num="36"></td><td><pre>        - containerPort: <span class="token number">80</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          name: web</pre></td></tr><tr><td data-num="38"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num="39"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num="40"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num="41"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num="42"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num="43"></td><td><pre>    name: www</pre></td></tr><tr><td data-num="44"></td><td><pre>    spec:</pre></td></tr><tr><td data-num="45"></td><td><pre>      accessModes: <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      storageClassName: <span class="token string">"rook-ceph-block"</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      resources:</pre></td></tr><tr><td data-num="48"></td><td><pre>        requests:</pre></td></tr><tr><td data-num="49"></td><td><pre>          storage: 1Gi</pre></td></tr><tr><td data-num="50"></td><td><pre>    	  </pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f ceph-block-pvc-sts.yaml </span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span></pre></td></tr><tr><td data-num="54"></td><td><pre>NAME                                      READY   STATUS    RESTARTS       AGE</pre></td></tr><tr><td data-num="55"></td><td><pre>web-0                                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4m19s</pre></td></tr><tr><td data-num="56"></td><td><pre>web-1                                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4m10s</pre></td></tr><tr><td data-num="57"></td><td><pre>web-2                                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>              2m21s</pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc</span></pre></td></tr><tr><td data-num="60"></td><td><pre>NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE</pre></td></tr><tr><td data-num="61"></td><td><pre>www-web-0   Bound    pvc-27cab5bf-f989-4050-aa84-1b2dac9fa745   1Gi        RWO            rook-ceph-block   4m23s</pre></td></tr><tr><td data-num="62"></td><td><pre>www-web-1   Bound    pvc-76fb08f4-2195-4678-b6b8-286c2f722cc9   1Gi        RWO            rook-ceph-block   4m14s</pre></td></tr><tr><td data-num="63"></td><td><pre>www-web-2   Bound    pvc-6b858cd9-288f-48bc-bc96-33e6eb519613   1Gi        RWO            rook-ceph-block   2m25s</pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv</span></pre></td></tr><tr><td data-num="66"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS      REASON   AGE</pre></td></tr><tr><td data-num="67"></td><td><pre>pvc-27cab5bf-f989-4050-aa84-1b2dac9fa745   1Gi        RWO            Delete           Bound    default/www-web-0   rook-ceph-block            4m25s</pre></td></tr><tr><td data-num="68"></td><td><pre>pvc-6b858cd9-288f-48bc-bc96-33e6eb519613   1Gi        RWO            Delete           Bound    default/www-web-2   rook-ceph-block            2m27s</pre></td></tr><tr><td data-num="69"></td><td><pre>pvc-76fb08f4-2195-4678-b6b8-286c2f722cc9   1Gi        RWO            Delete           Bound    default/www-web-1   rook-ceph-block            4m16s</pre></td></tr></table></figure><h4 id="8-共享文件系统的使用"><a class="anchor" href="#8-共享文件系统的使用">#</a> 8. 共享文件系统的使用</h4><p>共享文件系统一般用于多个 Pod 共享一个存储</p><h5 id="81-创建共享类型的文件系统"><a class="anchor" href="#81-创建共享类型的文件系统">#</a> 8.1 创建共享类型的文件系统</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/rook/deploy/examples/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f filesystem.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -l app=rook-ceph-mds -n rook-ceph</span></pre></td></tr><tr><td data-num="4"></td><td><pre>NAME                                    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="5"></td><td><pre>rook-ceph-mds-myfs-a-7d76cb5988-9nz9p   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          36s</pre></td></tr><tr><td data-num="6"></td><td><pre>rook-ceph-mds-myfs-b-76ff7c784c-vs8nm   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          33s</pre></td></tr></table></figure><h5 id="82-创建共享类型文件系统的-storageclass"><a class="anchor" href="#82-创建共享类型文件系统的-storageclass">#</a> 8.2 创建共享类型文件系统的 StorageClass</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># cd csi/cephfs</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 cephfs<span class="token punctuation">]</span><span class="token comment"># kubectl create -f storageclass.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 cephfs<span class="token punctuation">]</span><span class="token comment"># kubectl get sc</span></pre></td></tr><tr><td data-num="4"></td><td><pre>NAME              PROVISIONER                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</pre></td></tr><tr><td data-num="5"></td><td><pre>nfs-storage       nfzl.com/nfs                    Delete          Immediate           <span class="token boolean">false</span>                  17h</pre></td></tr><tr><td data-num="6"></td><td><pre>rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           <span class="token boolean">true</span>                   82m</pre></td></tr><tr><td data-num="7"></td><td><pre>rook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           <span class="token boolean">true</span>                   13s</pre></td></tr></table></figure><h5 id="83-挂载测试"><a class="anchor" href="#83-挂载测试">#</a> 8.3 挂载测试</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat cephfs-pvc-deploy.yaml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="3"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num="4"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="5"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num="6"></td><td><pre>  labels:</pre></td></tr><tr><td data-num="7"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num="8"></td><td><pre>spec:</pre></td></tr><tr><td data-num="9"></td><td><pre>  ports:</pre></td></tr><tr><td data-num="10"></td><td><pre>  - port: <span class="token number">80</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    name: web</pre></td></tr><tr><td data-num="12"></td><td><pre>  selector:</pre></td></tr><tr><td data-num="13"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num="14"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num="15"></td><td><pre>---</pre></td></tr><tr><td data-num="16"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num="17"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="18"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="19"></td><td><pre>  name: nginx-share-pvc</pre></td></tr><tr><td data-num="20"></td><td><pre>spec:</pre></td></tr><tr><td data-num="21"></td><td><pre>  storageClassName: rook-cephfs </pre></td></tr><tr><td data-num="22"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num="23"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num="24"></td><td><pre>  resources:</pre></td></tr><tr><td data-num="25"></td><td><pre>    requests:</pre></td></tr><tr><td data-num="26"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num="27"></td><td><pre>---</pre></td></tr><tr><td data-num="28"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num="29"></td><td><pre>kind: Deployment </pre></td></tr><tr><td data-num="30"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="31"></td><td><pre>  name: web</pre></td></tr><tr><td data-num="32"></td><td><pre>spec:</pre></td></tr><tr><td data-num="33"></td><td><pre>  selector:</pre></td></tr><tr><td data-num="34"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num="35"></td><td><pre>      app: nginx <span class="token comment"># has to match .spec.template.metadata.labels</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  replicas: <span class="token number">3</span> <span class="token comment"># by default is 1</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  template:</pre></td></tr><tr><td data-num="38"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num="39"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="40"></td><td><pre>        app: nginx <span class="token comment"># has to match .spec.selector.matchLabels</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    spec:</pre></td></tr><tr><td data-num="42"></td><td><pre>      containers:</pre></td></tr><tr><td data-num="43"></td><td><pre>      - name: nginx</pre></td></tr><tr><td data-num="44"></td><td><pre>        image: nginx </pre></td></tr><tr><td data-num="45"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num="46"></td><td><pre>        ports:</pre></td></tr><tr><td data-num="47"></td><td><pre>        - containerPort: <span class="token number">80</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          name: web</pre></td></tr><tr><td data-num="49"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num="50"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num="51"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num="52"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num="53"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num="54"></td><td><pre>          persistentVolumeClaim:</pre></td></tr><tr><td data-num="55"></td><td><pre>            claimName: nginx-share-pvc</pre></td></tr><tr><td data-num="56"></td><td><pre>			</pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f cephfs-pvc-deploy.yaml</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span></pre></td></tr><tr><td data-num="59"></td><td><pre>NAME                                      READY   STATUS    RESTARTS        AGE</pre></td></tr><tr><td data-num="60"></td><td><pre>cluster-test-84dfc9c68b-5q4ng             <span class="token number">1</span>/1     Running   <span class="token number">84</span> <span class="token punctuation">(</span>4m2s ago<span class="token punctuation">)</span>   16d</pre></td></tr><tr><td data-num="61"></td><td><pre>nfs-client-provisioner-5dbbd8d796-lhdgw   <span class="token number">1</span>/1     Running   <span class="token number">5</span> <span class="token punctuation">(</span>123m ago<span class="token punctuation">)</span>    18h</pre></td></tr><tr><td data-num="62"></td><td><pre>web-6c59f8559-g5xzb                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>               46s</pre></td></tr><tr><td data-num="63"></td><td><pre>web-6c59f8559-ns77q                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>               46s</pre></td></tr><tr><td data-num="64"></td><td><pre>web-6c59f8559-qxb5f                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>               46s</pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc</span></pre></td></tr><tr><td data-num="67"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num="68"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   2Gi        RWX            rook-cephfs    52s</pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv</span></pre></td></tr><tr><td data-num="71"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                     STORAGECLASS   REASON   AGE</pre></td></tr><tr><td data-num="72"></td><td><pre>pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   2Gi        RWX            Delete           Bound    default/nginx-share-pvc   rook-cephfs             53s</pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it web-6c59f8559-g5xzb -- bash</span></pre></td></tr><tr><td data-num="75"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class="token comment"># cd /usr/share/nginx/html/</span></pre></td></tr><tr><td data-num="76"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class="token comment"># echo "hello cephfs" >> index.html</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span></pre></td></tr><tr><td data-num="79"></td><td><pre>NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE</pre></td></tr><tr><td data-num="80"></td><td><pre>kubernetes           ClusterIP   <span class="token number">10.96</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP    16d</pre></td></tr><tr><td data-num="81"></td><td><pre>mysql-svc-external   ClusterIP   None          <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">3306</span>/TCP   9d</pre></td></tr><tr><td data-num="82"></td><td><pre>nginx                ClusterIP   <span class="token number">10.96</span>.58.17   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP     4m34s</pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.96.58.17</span></pre></td></tr><tr><td data-num="84"></td><td><pre>hello cephfs</pre></td></tr></table></figure><h4 id="9pvc-扩容"><a class="anchor" href="#9pvc-扩容">#</a> 9.PVC 扩容</h4><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get sc</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME              PROVISIONER                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>nfs-storage       nfzl.com/nfs                    Delete          Immediate           <span class="token boolean">false</span>                  18h</pre></td></tr><tr><td data-num="4"></td><td><pre>rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           <span class="token boolean">true</span>                   104m     <span class="token comment">#true 允许扩容</span></pre></td></tr><tr><td data-num="5"></td><td><pre>rook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           <span class="token boolean">true</span>                   22m      <span class="token comment">#true 允许扩容</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc</span></pre></td></tr><tr><td data-num="8"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num="9"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   2Gi        RWX            rook-cephfs    13m</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit pvc nginx-share-pvc</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="12"></td><td><pre>  - ReadWriteMany</pre></td></tr><tr><td data-num="13"></td><td><pre>  resources:</pre></td></tr><tr><td data-num="14"></td><td><pre>    requests:</pre></td></tr><tr><td data-num="15"></td><td><pre>      storage: 5Gi         <span class="token comment">#更改 pvc 大小</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  storageClassName: rook-cephfs</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc       #查看 PVC 是否扩容</span></pre></td></tr><tr><td data-num="20"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num="21"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    15m</pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv         #查看 PV 是否扩容</span></pre></td></tr><tr><td data-num="24"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                     STORAGECLASS   REASON   AGE</pre></td></tr><tr><td data-num="25"></td><td><pre>pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            Delete           Bound    default/nginx-share-pvc   rook-cephfs             15m</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it web-6c59f8559-g5xzb -- bash       #进入容器，查看 pod 是否扩容  </span></pre></td></tr><tr><td data-num="28"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class="token comment"># df -h </span></pre></td></tr><tr><td data-num="29"></td><td><pre>Filesystem                                                                                                                                             Size  Used Avail Use% Mounted on</pre></td></tr><tr><td data-num="30"></td><td><pre>overlay                                                                                                                                                 17G   13G  <span class="token number">4</span>.1G  <span class="token number">76</span>% /</pre></td></tr><tr><td data-num="31"></td><td><pre>tmpfs                                                                                                                                                   64M     <span class="token number">0</span>   64M   <span class="token number">0</span>% /dev</pre></td></tr><tr><td data-num="32"></td><td><pre>tmpfs                                                                                                                                                  <span class="token number">2</span>.0G     <span class="token number">0</span>  <span class="token number">2</span>.0G   <span class="token number">0</span>% /sys/fs/cgroup</pre></td></tr><tr><td data-num="33"></td><td><pre>/dev/sda3                                                                                                                                               17G   13G  <span class="token number">4</span>.1G  <span class="token number">76</span>% /etc/hosts</pre></td></tr><tr><td data-num="34"></td><td><pre>shm                                                                                                                                                     64M     <span class="token number">0</span>   64M   <span class="token number">0</span>% /dev/shm</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token number">10.96</span>.121.140:6789,10.96.131.130:6789,10.96.62.64:6789:/volumes/csi/csi-vol-3b645a11-58f4-475a-9404-5d84964f5291/e4bdf743-eb18-42c8-b04f-41964f76de4f  <span class="token number">5</span>.0G     <span class="token number">0</span>  <span class="token number">5</span>.0G   <span class="token number">0</span>% /usr/share/nginx/html</pre></td></tr><tr><td data-num="36"></td><td><pre>tmpfs                                                                                                                                                  <span class="token number">3</span>.8G   12K  <span class="token number">3</span>.8G   <span class="token number">1</span>% /run/secrets/kubernetes.io/serviceaccount</pre></td></tr><tr><td data-num="37"></td><td><pre>tmpfs                                                                                                                                                  <span class="token number">2</span>.0G     <span class="token number">0</span>  <span class="token number">2</span>.0G   <span class="token number">0</span>% /proc/asound</pre></td></tr><tr><td data-num="38"></td><td><pre>tmpfs                                                                                                                                                  <span class="token number">2</span>.0G     <span class="token number">0</span>  <span class="token number">2</span>.0G   <span class="token number">0</span>% /proc/acpi</pre></td></tr><tr><td data-num="39"></td><td><pre>tmpfs                                                                                                                                                  <span class="token number">2</span>.0G     <span class="token number">0</span>  <span class="token number">2</span>.0G   <span class="token number">0</span>% /proc/scsi</pre></td></tr><tr><td data-num="40"></td><td><pre>tmpfs                                                                                                                                                  <span class="token number">2</span>.0G     <span class="token number">0</span>  <span class="token number">2</span>.0G   <span class="token number">0</span>% /sys/firmware</pre></td></tr></table></figure><h4 id="10-pvc-快照"><a class="anchor" href="#10-pvc-快照">#</a> 10. PVC 快照</h4><h5 id="101-文件共享类型快照"><a class="anchor" href="#101-文件共享类型快照">#</a> 10.1 文件共享类型快照</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd rook/deploy/examples</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl create -f csi/cephfs/snapshotclass.yaml </span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get volumesnapshotclass</span></pre></td></tr><tr><td data-num="5"></td><td><pre>NAME                         DRIVER                          DELETIONPOLICY   AGE</pre></td></tr><tr><td data-num="6"></td><td><pre>csi-cephfsplugin-snapclass   rook-ceph.cephfs.csi.ceph.com   Delete           25s</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#拍摄快照	</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it web-6c59f8559-g5xzb -- bash         #pvc 新增数据</span></pre></td></tr><tr><td data-num="11"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class="token comment"># cd /usr/share/nginx/html/</span></pre></td></tr><tr><td data-num="12"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class="token comment"># touch &#123;1..10&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class="token comment"># ls</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">1</span>  <span class="token number">10</span>  <span class="token number">2</span>  <span class="token number">3</span>  <span class="token number">4</span>	<span class="token number">5</span>  <span class="token number">6</span>  <span class="token number">7</span>  <span class="token number">8</span>  <span class="token number">9</span>  index.html</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc       #查看 pvs 并对 nginx-share-pvc 拍摄快照</span></pre></td></tr><tr><td data-num="17"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num="18"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    4h23m</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># cat csi/cephfs/snapshot.yaml         #拍摄快照</span></pre></td></tr><tr><td data-num="21"></td><td><pre>---</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 1.17 &lt;= K8s &lt;= v1.19</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># apiVersion: snapshot.storage.k8s.io/v1beta1</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># K8s >= v1.20</span></pre></td></tr><tr><td data-num="25"></td><td><pre>apiVersion: snapshot.storage.k8s.io/v1</pre></td></tr><tr><td data-num="26"></td><td><pre>kind: VolumeSnapshot</pre></td></tr><tr><td data-num="27"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="28"></td><td><pre>  name: cephfs-pvc-snapshot</pre></td></tr><tr><td data-num="29"></td><td><pre>spec:</pre></td></tr><tr><td data-num="30"></td><td><pre>  volumeSnapshotClassName: csi-cephfsplugin-snapclass</pre></td></tr><tr><td data-num="31"></td><td><pre>  source:</pre></td></tr><tr><td data-num="32"></td><td><pre>    persistentVolumeClaimName: nginx-share-pvc         <span class="token comment">#基于那个 PVC 拍摄快照</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f csi/cephfs/snapshot.yaml</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get volumesnapshot</span></pre></td></tr><tr><td data-num="36"></td><td><pre>NAME                  READYTOUSE   SOURCEPVC         SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS                SNAPSHOTCONTENT                                    CREATIONTIME   AGE</pre></td></tr><tr><td data-num="37"></td><td><pre>cephfs-pvc-snapshot   <span class="token boolean">true</span>         nginx-share-pvc                           5Gi           csi-cephfsplugin-snapclass   snapcontent-bdaddb97-debe-4f42-9423-13bf1c5b5402   4m6s           4m8s</pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">#删除 pvc 数据</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it web-6c59f8559-g5xzb -- bash</span></pre></td></tr><tr><td data-num="41"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class="token comment"># cd /usr/share/nginx/html/</span></pre></td></tr><tr><td data-num="42"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class="token comment"># ls</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token number">1</span>  <span class="token number">10</span>  <span class="token number">2</span>  <span class="token number">3</span>  <span class="token number">4</span>	<span class="token number">5</span>  <span class="token number">6</span>  <span class="token number">7</span>  <span class="token number">8</span>  <span class="token number">9</span>  index.html</pre></td></tr><tr><td data-num="44"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class="token comment"># rm -rf &#123;1..10&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class="token comment"># ls</span></pre></td></tr><tr><td data-num="46"></td><td><pre>index.html</pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">#pvc 回滚数据</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get volumesnapshot</span></pre></td></tr><tr><td data-num="50"></td><td><pre>NAME                  READYTOUSE   SOURCEPVC         SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS                SNAPSHOTCONTENT                                    CREATIONTIME   AGE</pre></td></tr><tr><td data-num="51"></td><td><pre>cephfs-pvc-snapshot   <span class="token boolean">true</span>         nginx-share-pvc                           5Gi           csi-cephfsplugin-snapclass   snapcontent-bdaddb97-debe-4f42-9423-13bf1c5b5402   7m39s          7m41s</pre></td></tr><tr><td data-num="52"></td><td><pre>	</pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># cat csi/cephfs/pvc-restore.yaml </span></pre></td></tr><tr><td data-num="54"></td><td><pre>---</pre></td></tr><tr><td data-num="55"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="56"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num="57"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="58"></td><td><pre>  name: cephfs-pvc-restore</pre></td></tr><tr><td data-num="59"></td><td><pre>spec:</pre></td></tr><tr><td data-num="60"></td><td><pre>  storageClassName: rook-cephfs       <span class="token comment">#创建 pv 的 storageclass 名称相同</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  dataSource:</pre></td></tr><tr><td data-num="62"></td><td><pre>    name: cephfs-pvc-snapshot         <span class="token comment">#volumesnapshot 数据源</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    kind: VolumeSnapshot</pre></td></tr><tr><td data-num="64"></td><td><pre>    apiGroup: snapshot.storage.k8s.io</pre></td></tr><tr><td data-num="65"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num="66"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num="67"></td><td><pre>  resources:</pre></td></tr><tr><td data-num="68"></td><td><pre>    requests:</pre></td></tr><tr><td data-num="69"></td><td><pre>      storage: 5Gi      <span class="token comment">#大小等于 snapshot 大小</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f csi/cephfs/pvc-restore.yaml</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc</span></pre></td></tr><tr><td data-num="74"></td><td><pre>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num="75"></td><td><pre>cephfs-pvc-restore   Bound    pvc-9e845f2b-df1f-450d-8aa2-f9a46db6adb6   5Gi        RWX            rook-cephfs    54s          </pre></td></tr><tr><td data-num="76"></td><td><pre>nginx-share-pvc      Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    4h50m</pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment">#挂载 PVC 测试数据是否恢复</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># cat csi/cephfs/pod.yaml </span></pre></td></tr><tr><td data-num="80"></td><td><pre>---</pre></td></tr><tr><td data-num="81"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="82"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num="83"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="84"></td><td><pre>  name: csicephfs-demo-pod</pre></td></tr><tr><td data-num="85"></td><td><pre>spec:</pre></td></tr><tr><td data-num="86"></td><td><pre>  containers:</pre></td></tr><tr><td data-num="87"></td><td><pre>    - name: web-server</pre></td></tr><tr><td data-num="88"></td><td><pre>      image: nginx</pre></td></tr><tr><td data-num="89"></td><td><pre>      volumeMounts:</pre></td></tr><tr><td data-num="90"></td><td><pre>        - name: mypvc</pre></td></tr><tr><td data-num="91"></td><td><pre>          mountPath: /var/lib/www/html</pre></td></tr><tr><td data-num="92"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num="93"></td><td><pre>    - name: mypvc</pre></td></tr><tr><td data-num="94"></td><td><pre>      persistentVolumeClaim:</pre></td></tr><tr><td data-num="95"></td><td><pre>        claimName: cephfs-pvc-restore        <span class="token comment">#挂载恢复 pvc</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        readOnly: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f csi/cephfs/pod.yaml</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span></pre></td></tr><tr><td data-num="100"></td><td><pre>NAME                                      READY   STATUS    RESTARTS        AGE</pre></td></tr><tr><td data-num="101"></td><td><pre>cluster-test-84dfc9c68b-5q4ng             <span class="token number">1</span>/1     Running   <span class="token number">88</span> <span class="token punctuation">(</span>57m ago<span class="token punctuation">)</span>    16d</pre></td></tr><tr><td data-num="102"></td><td><pre>csicephfs-demo-pod                        <span class="token number">1</span>/1     Running   <span class="token number">0</span>               24s</pre></td></tr><tr><td data-num="103"></td><td><pre>nfs-client-provisioner-5dbbd8d796-lhdgw   <span class="token number">1</span>/1     Running   <span class="token number">5</span> <span class="token punctuation">(</span>6h57m ago<span class="token punctuation">)</span>   23h</pre></td></tr><tr><td data-num="104"></td><td><pre>web-6c59f8559-g5xzb                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>               4h54m</pre></td></tr><tr><td data-num="105"></td><td><pre>web-6c59f8559-ns77q                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>               4h54m</pre></td></tr><tr><td data-num="106"></td><td><pre>web-6c59f8559-qxb5f                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>               4h54m</pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it csicephfs-demo-pod -- bash</span></pre></td></tr><tr><td data-num="108"></td><td><pre>root@csicephfs-demo-pod:/<span class="token comment"># ls /var/lib/www/html/               #s 删除数据已经恢复</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token number">1</span>  <span class="token number">10</span>  <span class="token number">2</span>  <span class="token number">3</span>  <span class="token number">4</span>	<span class="token number">5</span>  <span class="token number">6</span>  <span class="token number">7</span>  <span class="token number">8</span>  <span class="token number">9</span>  index.html</pre></td></tr></table></figure><h5 id="102-pvc-克隆"><a class="anchor" href="#102-pvc-克隆">#</a> 10.2 PVC 克隆</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc</span></pre></td></tr><tr><td data-num="2"></td><td><pre>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num="3"></td><td><pre>cephfs-pvc-restore   Bound    pvc-9e845f2b-df1f-450d-8aa2-f9a46db6adb6   5Gi        RWX            rook-cephfs    11m</pre></td></tr><tr><td data-num="4"></td><td><pre>nginx-share-pvc      Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    5h1m</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># cat csi/cephfs/pvc-clone.yaml </span></pre></td></tr><tr><td data-num="8"></td><td><pre>---</pre></td></tr><tr><td data-num="9"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="10"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num="11"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="12"></td><td><pre>  name: cephfs-pvc-clone</pre></td></tr><tr><td data-num="13"></td><td><pre>spec:</pre></td></tr><tr><td data-num="14"></td><td><pre>  storageClassName: rook-cephfs      <span class="token comment"># pvc 的 storageClass 名称</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  dataSource:</pre></td></tr><tr><td data-num="16"></td><td><pre>    name: nginx-share-pvc          <span class="token comment">#克隆的 PVC 名称</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num="18"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num="19"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num="20"></td><td><pre>  resources:</pre></td></tr><tr><td data-num="21"></td><td><pre>    requests:</pre></td></tr><tr><td data-num="22"></td><td><pre>      storage: 5Gi                 <span class="token comment">#大小等于所克隆的 PVC 大小</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f csi/cephfs/pvc-clone.yaml</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc</span></pre></td></tr><tr><td data-num="27"></td><td><pre>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num="28"></td><td><pre>cephfs-pvc-clone     Bound    pvc-0a19b65e-cb5e-4379-a7f7-e0783fcf8ddf   5Gi        RWX            rook-cephfs    22s</pre></td></tr><tr><td data-num="29"></td><td><pre>cephfs-pvc-restore   Bound    pvc-9e845f2b-df1f-450d-8aa2-f9a46db6adb6   5Gi        RWX            rook-cephfs    15m</pre></td></tr><tr><td data-num="30"></td><td><pre>nginx-share-pvc      Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    5h4m</pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#挂载克隆 PVC 测试</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># cat csi/cephfs/pod.yaml </span></pre></td></tr><tr><td data-num="34"></td><td><pre>---</pre></td></tr><tr><td data-num="35"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="36"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num="37"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="38"></td><td><pre>  name: csicephfs-demo-pod</pre></td></tr><tr><td data-num="39"></td><td><pre>spec:</pre></td></tr><tr><td data-num="40"></td><td><pre>  containers:</pre></td></tr><tr><td data-num="41"></td><td><pre>    - name: web-server</pre></td></tr><tr><td data-num="42"></td><td><pre>      image: nginx</pre></td></tr><tr><td data-num="43"></td><td><pre>      volumeMounts:</pre></td></tr><tr><td data-num="44"></td><td><pre>        - name: mypvc</pre></td></tr><tr><td data-num="45"></td><td><pre>          mountPath: /var/lib/www/html</pre></td></tr><tr><td data-num="46"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num="47"></td><td><pre>    - name: mypvc</pre></td></tr><tr><td data-num="48"></td><td><pre>      persistentVolumeClaim:</pre></td></tr><tr><td data-num="49"></td><td><pre>        claimName: cephfs-pvc-clone      <span class="token comment">#挂载克隆的 pvc</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        readOnly: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f csi/cephfs/pod.yaml          </span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span></pre></td></tr><tr><td data-num="54"></td><td><pre>NAME                                      READY   STATUS    RESTARTS         AGE</pre></td></tr><tr><td data-num="55"></td><td><pre>cluster-test-84dfc9c68b-5q4ng             <span class="token number">1</span>/1     Running   <span class="token number">89</span> <span class="token punctuation">(</span>9m54s ago<span class="token punctuation">)</span>   16d</pre></td></tr><tr><td data-num="56"></td><td><pre>csicephfs-demo-pod                        <span class="token number">1</span>/1     Running   <span class="token number">0</span>                17s</pre></td></tr><tr><td data-num="57"></td><td><pre>nfs-client-provisioner-5dbbd8d796-lhdgw   <span class="token number">1</span>/1     Running   <span class="token number">5</span> <span class="token punctuation">(</span>7h9m ago<span class="token punctuation">)</span>     23h</pre></td></tr><tr><td data-num="58"></td><td><pre>web-6c59f8559-g5xzb                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>                5h6m</pre></td></tr><tr><td data-num="59"></td><td><pre>web-6c59f8559-ns77q                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>                5h6m</pre></td></tr><tr><td data-num="60"></td><td><pre>web-6c59f8559-qxb5f                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>                5h6m</pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 examples<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it csicephfs-demo-pod -- bash</span></pre></td></tr><tr><td data-num="63"></td><td><pre>root@csicephfs-demo-pod:/<span class="token comment"># cat /var/lib/www/html/index.html </span></pre></td></tr><tr><td data-num="64"></td><td><pre>hello cephfs</pre></td></tr></table></figure><h4 id="11-测试数据清理"><a class="anchor" href="#11-测试数据清理">#</a> 11. 测试数据清理</h4><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>参考文档：https://rook.io/docs/rook/v1.11/Getting-Started/ceph-teardown/<span class="token comment">#delete-the-cephcluster-crd</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete deploy web</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pods csicephfs-demo-pod</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pvc --all</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc</span></pre></td></tr><tr><td data-num="8"></td><td><pre>No resources found <span class="token keyword">in</span> default namespace.</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv</span></pre></td></tr><tr><td data-num="10"></td><td><pre>No resources found</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get volumesnapshot</span></pre></td></tr><tr><td data-num="14"></td><td><pre>NAME                  READYTOUSE   SOURCEPVC         SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS                SNAPSHOTCONTENT                                    CREATIONTIME   AGE</pre></td></tr><tr><td data-num="15"></td><td><pre>cephfs-pvc-snapshot   <span class="token boolean">true</span>         nginx-share-pvc                           5Gi           csi-cephfsplugin-snapclass   snapcontent-bdaddb97-debe-4f42-9423-13bf1c5b5402   61m            61m</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete volumesnapshot cephfs-pvc-snapshot</span></pre></td></tr><tr><td data-num="17"></td><td><pre>volumesnapshot.snapshot.storage.k8s.io <span class="token string">"cephfs-pvc-snapshot"</span> deleted</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>kubectl delete <span class="token parameter variable">-n</span> rook-ceph cephblockpool replicapool</pre></td></tr><tr><td data-num="20"></td><td><pre>kubectl delete <span class="token parameter variable">-n</span> rook-ceph cephfilesystem myfs</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>kubectl delete storageclass rook-ceph-block</pre></td></tr><tr><td data-num="23"></td><td><pre>kubectl delete storageclass rook-cephfs</pre></td></tr><tr><td data-num="24"></td><td><pre>kubectl delete <span class="token parameter variable">-f</span> csi/cephfs/kube-registry.yaml</pre></td></tr><tr><td data-num="25"></td><td><pre>kubectl delete storageclass csi-cephfs</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>kubectl <span class="token parameter variable">-n</span> rook-ceph delete cephcluster rook-ceph</pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>kubectl delete <span class="token parameter variable">-f</span> operator.yaml</pre></td></tr><tr><td data-num="30"></td><td><pre>kubectl delete <span class="token parameter variable">-f</span> common.yaml</pre></td></tr><tr><td data-num="31"></td><td><pre>kubectl delete <span class="token parameter variable">-f</span> crds.yaml</pre></td></tr></table></figure><p><em>本文出自于：<a target="_blank" rel="noopener" href="https://edu.51cto.com/course/23845.html">https://edu.51cto.com/course/23845.html</a></em></p><div class="tags"><a href="/tags/Kubernetes/" rel="tag"><i class="ic i-tag"></i>Kubernetes</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/posts/3030097036.html">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2025-06-15 14:21:13" itemprop="dateModified" datetime="2025-06-15T14:21:13+08:00">2025-06-15</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Xu Yong 微信支付"><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Xu Yong 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Xu Yong<i class="ic i-at"><em>@</em></i>LinuxSre云原生</li><li class="link"><strong>本文链接：</strong><a href="http://ixuyong.cn/posts/3030097036.html" title="K8S云原生存储Rook-Ceph">http://ixuyong.cn/posts/3030097036.html</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/posts/3890389502.html" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;MrtgBDG.jpeg" title="K8S持久化存储NFS+StorageClass"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Kubernetes</span><h3>K8S持久化存储NFS+StorageClass</h3></a></div><div class="item right"><a href="/posts/3364424907.html" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;q5MesmM.jpeg" title="阿里云+Github构建镜像仓库"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>Docker</span><h3>阿里云+Github构建镜像仓库</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AD%98%E5%82%A8rook-ceph"><span class="toc-number">1.</span> <span class="toc-text">K8S 云原生存储 Rook-Ceph</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-storageclass%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8"><span class="toc-number">1.1.</span> <span class="toc-text">1. StorageClass 动态存储</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AD%98%E5%82%A8rook"><span class="toc-number">1.2.</span> <span class="toc-text">2. 云原生存储 Rook</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-rook-%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.</span> <span class="toc-text">3. Rook 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#31-%E4%B8%8B%E8%BD%BD-rook-%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 下载 Rook 安装文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#32-%E9%85%8D%E7%BD%AE%E6%9B%B4%E6%94%B9"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 配置更改</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#33-%E9%83%A8%E7%BD%B2-rook"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 部署 rook</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E5%88%9B%E5%BB%BA-ceph-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.</span> <span class="toc-text">4. 创建 Ceph 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#41-%E9%85%8D%E7%BD%AE%E6%9B%B4%E6%94%B9"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 配置更改</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#42-%E5%88%9B%E5%BB%BA-ceph-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 创建 Ceph 集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#43-%E5%AE%89%E8%A3%85-ceph-snapshot-%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 安装 ceph snapshot 控制器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%AE%89%E8%A3%85-ceph-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B7%A5%E5%85%B7"><span class="toc-number">1.5.</span> <span class="toc-text">5. 安装 ceph 客户端工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-ceph-dashboard"><span class="toc-number">1.6.</span> <span class="toc-text">6. Ceph dashboard</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#61-%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 暴露服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#62-%E9%85%8D%E7%BD%AEingress%E8%AE%BF%E9%97%AEceph"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 配置 ingress 访问 ceph</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#63-%E7%99%BB%E5%BD%95"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 登录</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-ceph-%E5%9D%97%E5%AD%98%E5%82%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.</span> <span class="toc-text">7. Ceph 块存储的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#71-%E5%88%9B%E5%BB%BA-storageclass-%E5%92%8C-ceph-%E7%9A%84%E5%AD%98%E5%82%A8%E6%B1%A0"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 创建 StorageClass 和 ceph 的存储池</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#72-%E6%8C%82%E8%BD%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 挂载测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#73-statefulset-volumeclaimtemplates"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 StatefulSet volumeClaimTemplates</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.8.</span> <span class="toc-text">8. 共享文件系统的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#81-%E5%88%9B%E5%BB%BA%E5%85%B1%E4%BA%AB%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 创建共享类型的文件系统</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#82-%E5%88%9B%E5%BB%BA%E5%85%B1%E4%BA%AB%E7%B1%BB%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84-storageclass"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 创建共享类型文件系统的 StorageClass</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#83-%E6%8C%82%E8%BD%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.8.3.</span> <span class="toc-text">8.3 挂载测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9pvc-%E6%89%A9%E5%AE%B9"><span class="toc-number">1.9.</span> <span class="toc-text">9.PVC 扩容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-pvc-%E5%BF%AB%E7%85%A7"><span class="toc-number">1.10.</span> <span class="toc-text">10. PVC 快照</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#101-%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B1%BB%E5%9E%8B%E5%BF%AB%E7%85%A7"><span class="toc-number">1.10.1.</span> <span class="toc-text">10.1 文件共享类型快照</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#102-pvc-%E5%85%8B%E9%9A%86"><span class="toc-number">1.10.2.</span> <span class="toc-text">10.2 PVC 克隆</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E6%B8%85%E7%90%86"><span class="toc-number">1.11.</span> <span class="toc-text">11. 测试数据清理</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/posts/3166738000.html" rel="bookmark" title="Kubeadm高可用安装K8s集群">Kubeadm高可用安装K8s集群</a></li><li><a href="/posts/2771271649.html" rel="bookmark" title="云原生K8s安全专家CKS认证考题详解">云原生K8s安全专家CKS认证考题详解</a></li><li><a href="/posts/985149017.html" rel="bookmark" title="二进制高可用安装K8S集群">二进制高可用安装K8S集群</a></li><li><a href="/posts/1771242682.html" rel="bookmark" title="K8s零宕机服务发布-探针">K8s零宕机服务发布-探针</a></li><li><a href="/posts/108692210.html" rel="bookmark" title="K8s资源调度deployment、statefulset、daemonset">K8s资源调度deployment、statefulset、daemonset</a></li><li><a href="/posts/858611107.html" rel="bookmark" title="K8s服务发布Service">K8s服务发布Service</a></li><li><a href="/posts/3992668367.html" rel="bookmark" title="K8s配置管理Configmap">K8s配置管理Configmap</a></li><li><a href="/posts/169153047.html" rel="bookmark" title="K8s持久化存储">K8s持久化存储</a></li><li><a href="/posts/3833778957.html" rel="bookmark" title="K8s计划任务Job、Cronjob">K8s计划任务Job、Cronjob</a></li><li><a href="/posts/3142072607.html" rel="bookmark" title="K8s初始化容器、临时容器">K8s初始化容器、临时容器</a></li><li><a href="/posts/3254599477.html" rel="bookmark" title="K8s容忍和污点">K8s容忍和污点</a></li><li><a href="/posts/312010518.html" rel="bookmark" title="K8s亲和力Affinity">K8s亲和力Affinity</a></li><li><a href="/posts/176412055.html" rel="bookmark" title="K8s准入控制ResourceQuota、LimitRange、QoS服务质量">K8s准入控制ResourceQuota、LimitRange、QoS服务质量</a></li><li><a href="/posts/722512536.html" rel="bookmark" title="K8s细粒度权限控制RBAC">K8s细粒度权限控制RBAC</a></li><li><a href="/posts/3890389502.html" rel="bookmark" title="K8S持久化存储NFS+StorageClass">K8S持久化存储NFS+StorageClass</a></li><li class="active"><a href="/posts/3030097036.html" rel="bookmark" title="K8S云原生存储Rook-Ceph">K8S云原生存储Rook-Ceph</a></li><li><a href="/posts/170573601.html" rel="bookmark" title="K8s服务发布Ingress">K8s服务发布Ingress</a></li><li><a href="/posts/626047790.html" rel="bookmark" title="消费租赁系统微服务应用交付实践">消费租赁系统微服务应用交付实践</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Xu Yong" src="/assets/avatar.png"><p class="name" itemprop="name">Xu Yong</p><div class="description" itemprop="description">专注于 Linux 运维、云计算、云原⽣等技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">48</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">15</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">18</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/xyapples" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;xyapples"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://gitee.com/chinagei" class="item gitee" title="https:&#x2F;&#x2F;gitee.com&#x2F;chinagei"><i class="ic i-gitee"></i></a><a href="mailto:373370405@qq.com" class="item email" title="mailto:373370405@qq.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-about"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/posts/3364424907.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/posts/3890389502.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Redis/" title="分类于Redis">Redis</a></div><span><a href="/posts/1490514396.html">Redis Cluster集群部署</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/DevOps/" title="分类于DevOps">DevOps</a></div><span><a href="/posts/2330853882.html">K8S基于Jenkins实现微服务应用CICD实践（四）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3142072607.html">K8s初始化容器、临时容器</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/2771271649.html">云原生K8s安全专家CKS认证考题详解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/108692210.html">K8s资源调度deployment、statefulset、daemonset</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Harbor/" title="分类于Harbor">Harbor</a></div><span><a href="/posts/3071070978.html">企业级私有仓库Harbor搭建</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/722512536.html">K8s细粒度权限控制RBAC</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/MySQL/" title="分类于MySQL">MySQL</a></div><span><a href="/posts/2628187572.html">MySQL运维DBA应用与实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3833778957.html">K8s计划任务Job、Cronjob</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3030097036.html">K8S云原生存储Rook-Ceph</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Xu Yong @ LinuxSre云原生</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.4m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">21:46</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `posts/3030097036.html`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hrmmi -->