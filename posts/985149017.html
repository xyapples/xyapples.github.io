<!-- build time:Thu Jun 05 2025 21:55:11 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico"><link rel="alternate" href="/rss.xml" title="LinuxSre云原生" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="LinuxSre云原生" type="application/atom+xml"><link rel="alternate" type="application/json" title="LinuxSre云原生" href="http://ixuyong.cn/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.17"><link rel="modulepreload" href="/js/chunk-GV364XSK.js"><link rel="modulepreload" href="/js/chunk-NYSE5UKM.js"><link rel="modulepreload" href="/js/chunk-RONCYO2S.js"><link rel="modulepreload" href="/js/chunk-THHXCRSX.js"><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/js/comments-DL2IYMPZ.js"><link rel="modulepreload" href="/js/copy-tex-NADCTXPG.js"><link rel="modulepreload" href="/js/post-DA635IH6.js"><link rel="modulepreload" href="/js/quicklink-WEDHL4BA.js"><link rel="modulepreload" href="/js/search-VCZRKTM5.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/waline-NNBYRQEE.js"><link rel="stylesheet" href="/css/comments-F4ZGS7LD.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/waline-IDNZKML2.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="preload" href="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" as="image" fetchpriority="high"><meta name="keywords" content="Kubernetes"><meta name="description" content="专注于 Linux 运维、云计算、云原⽣等技术"><link rel="canonical" href="http://ixuyong.cn/posts/985149017.html"><title>二进制高可用安装K8S集群</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">二进制高可用安装K8S集群</h1><div class="meta"><span class="item" title="创建时间：2025-04-10 20:58:40"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-04-10T20:58:40+08:00">2025-04-10</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>55k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>50 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">LinuxSre云原生</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" loading="eager" decoding="async" fetchpriority="high" alt="LinuxSre云原生"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Kubernetes/" itemprop="item" rel="index" title="分类于Kubernetes"><span itemprop="name">Kubernetes<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://ixuyong.cn/posts/985149017.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"><meta itemprop="name" content="Xu Yong"><meta itemprop="description" content="致力于技术布道、普及前沿技术、打造云原生系列标杆博客, 专注于 Linux 运维、云计算、云原⽣等技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LinuxSre云原生"></span><div class="body md" itemprop="articleBody"><h2 id="二进制高可用安装k8s集群"><a class="anchor" href="#二进制高可用安装k8s集群">#</a> 二进制高可用安装 K8s 集群</h2><h4 id="1-基本配置"><a class="anchor" href="#1-基本配置">#</a> 1. 基本配置</h4><h5 id="11-基本环境配置"><a class="anchor" href="#11-基本环境配置">#</a> 1.1 基本环境配置</h5><table><thead><tr><th>主机名</th><th>IP 地址</th><th>说明</th></tr></thead><tbody><tr><td>k8s-master01 ~ 03</td><td>192.168.1.71 ~ 73</td><td>master 节点 * 3</td></tr><tr><td>/</td><td>192.168.1.70</td><td>keepalived 虚拟 IP（不占用机器）</td></tr><tr><td>k8s-node01 ~ 02</td><td>192.168.1.74/75</td><td>worker 节点 * 2</td></tr></tbody></table><p><em>请统一替换这些网段，Pod 网段和 service 和宿主机网段不要重复！！！</em></p><table><thead><tr><th><em><strong>* 配置信息 *</strong></em></th><th>备注</th></tr></thead><tbody><tr><td>系统版本</td><td>Rocky Linux 8/9</td></tr><tr><td>Containerd</td><td>latest</td></tr><tr><td>Pod 网段</td><td>172.16.0.0/16</td></tr><tr><td>Service 网段</td><td>10.96.0.0/16</td></tr></tbody></table><p><mark>所有节点</mark>更改主机名（其它节点按需修改）：</p><pre><code>hostnamectl set-hostname k8s-master01 
</code></pre><p><mark>所有节点</mark>配置 hosts，修改 /etc/hosts 如下：</p><pre><code>[root@k8s-master01 ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.1.71 k8s-master01
192.168.1.72 k8s-master02
192.168.1.73 k8s-master03
192.168.1.74 k8s-node01
192.168.1.75 k8s-node02
</code></pre><p><mark>所有节点</mark>配置 yum 源：</p><pre><code># 配置基础源
sed -e 's|^mirrorlist=|#mirrorlist=|g' \
    -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g' \
    -i.bak \
    /etc/yum.repos.d/*.repo

yum makecache
</code></pre><p><mark>所有节点</mark>必备工具安装：</p><pre><code>yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git rsyslog -y
</code></pre><p><mark>所有节点</mark>关闭防火墙、selinux、dnsmasq、swap、开启 rsyslog。服务器配置如下：</p><pre><code>systemctl disable --now firewalld 
systemctl disable --now dnsmasq
setenforce 0
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/sysconfig/selinux
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config
systemctl enable --now rsyslog
</code></pre><p><mark>所有节点</mark>关闭 swap 分区：</p><pre><code>swapoff -a &amp;&amp; sysctl -w vm.swappiness=0
sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab
</code></pre><p><mark>所有节点</mark>安装 ntpdate：</p><pre><code>sudo dnf install epel-release -y
sudo dnf config-manager --set-enabled epel
sudo dnf install ntpsec
</code></pre><p><mark>所有节点</mark>同步时间并配置上海时区：</p><pre><code>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
echo 'Asia/Shanghai' &gt;/etc/timezone
ntpdate time2.aliyun.com
# 加入到crontab
crontab -e
*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com
</code></pre><p><mark>所有节点</mark>配置 limit：</p><pre><code>ulimit -SHn 65535
vim /etc/security/limits.conf
# 末尾添加如下内容
* soft nofile 65536
* hard nofile 131072
* soft nproc 65535
* hard nproc 655350
* soft memlock unlimited
* hard memlock unlimited
</code></pre><p><mark>所有节点</mark>升级系统：</p><pre><code>yum update -y
</code></pre><p><mark>Master01 节点</mark>免密钥登录其他节点，安装过程中生成配置文件和证书均在 Master01 上操作，集群管理也在 Master01 上操作：</p><pre><code>ssh-keygen -t rsa
for i in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh/id_rsa.pub $i;done
</code></pre><p><em>注意：公有云环境，可能需要把 kubectl 放在一个非 Master 节点上</em></p><p><mark>Master01 节点</mark>下载安装所有的源码文件：</p><pre><code>cd /root/ ; git clone https://gitee.com/chinagei/k8s-ha-install
</code></pre><h5 id="12-内核配置"><a class="anchor" href="#12-内核配置">#</a> 1.2 内核配置</h5><p><mark>所有节点</mark>安装 ipvsadm：</p><pre><code>yum install ipvsadm ipset sysstat conntrack libseccomp -y
</code></pre><p><mark>所有节点</mark>配置 ipvs 模块：</p><pre><code>modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
</code></pre><p><mark>所有节点</mark>创建 ipvs.conf，并配置开机自动加载：</p><pre><code>vim /etc/modules-load.d/ipvs.conf 
# 加入以下内容
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
</code></pre><p><mark>所有节点</mark>然后执行 systemctl enable --now systemd-modules-load.service 即可（报错不用管）</p><pre><code>systemctl enable --now systemd-modules-load.service
</code></pre><p><mark>所有节点</mark>内核优化配置：</p><pre><code>cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
net.ipv4.conf.all.route_localnet = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
EOF
</code></pre><p><mark>所有节点</mark>应用配置：</p><pre><code>sysctl --system
</code></pre><p><mark>所有节点</mark>配置完内核后，重启机器，之后查看内核模块是否已自动加载：</p><pre><code>reboot
lsmod | grep --color=auto -e ip_vs -e nf_conntrack
</code></pre><h4 id="2-高可用组件安装"><a class="anchor" href="#2-高可用组件安装">#</a> 2. 高可用组件安装</h4><p><em>注意：如果安装的不是高可用集群，haproxy 和 keepalived 无需安装</em></p><p><em>注意：公有云要用公有云自带的负载均衡，比如阿里云的 SLB、NLB，腾讯云的 ELB，用来替代 haproxy 和 keepalived，因为公有云大部分都是不支持 keepalived 的。</em></p><p><mark>所有 Master 节点</mark>通过 yum 安装 HAProxy 和 KeepAlived：</p><pre><code>yum install keepalived haproxy -y
</code></pre><p><mark>所有 Master 节点</mark>配置 HAProxy，需要注意黄色部分的 IP：</p><pre><code>[root@k8s-master01 etc]# mkdir /etc/haproxy
[root@k8s-master01 etc]# vim /etc/haproxy/haproxy.cfg 
global
  maxconn  2000
  ulimit-n  16384
  log  127.0.0.1 local0 err
  stats timeout 30s

defaults
  log global
  mode  http
  option  httplog
  timeout connect 5000
  timeout client  50000
  timeout server  50000
  timeout http-request 15s
  timeout http-keep-alive 15s

frontend monitor-in
  bind *:33305
  mode http
  option httplog
  monitor-uri /monitor

frontend k8s-master
  bind 0.0.0.0:8443       #HAProxy监听端口
  bind 127.0.0.1:8443     #HAProxy监听端口
  mode tcp
  option tcplog
  tcp-request inspect-delay 5s
  default_backend k8s-master

backend k8s-master
  mode tcp
  option tcplog
  option tcp-check
  balance roundrobin
  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
  server k8s-master01	192.168.1.71:6443  check       #API Server IP地址
  server k8s-master02	192.168.1.72:6443  check       #API Server IP地址
  server k8s-master03	192.168.1.73:6443  check       #API Server IP地址
</code></pre><p><mark>所有 Master 节点</mark>配置 KeepAlived，需要注意黄色部分的配置。</p><p><mark>Master01 节点</mark>的配置：</p><pre><code>[root@k8s-master01 etc]# mkdir /etc/keepalived

[root@k8s-master01 ~]# vim /etc/keepalived/keepalived.conf 
! Configuration File for keepalived
global_defs &#123;
    router_id LVS_DEVEL
script_user root
    enable_script_security
&#125;
vrrp_script chk_apiserver &#123;
    script &quot;/etc/keepalived/check_apiserver.sh&quot;
    interval 5
    weight -5
    fall 2  
rise 1
&#125;
vrrp_instance VI_1 &#123;
    state MASTER
    interface ens160               #网卡名称
    mcast_src_ip 192.168.1.71      #K8s-master01 IP地址
    virtual_router_id 51
    priority 101
    advert_int 2
    authentication &#123;
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    &#125;
    virtual_ipaddress &#123;
        192.168.1.70        #VIP地址
    &#125;
    track_script &#123;
       chk_apiserver
    &#125;
&#125;	
</code></pre><p><mark>Master02 节点</mark>的配置：</p><pre><code># vim /etc/keepalived/keepalived.conf 

! Configuration File for keepalived
global_defs &#123;
    router_id LVS_DEVEL
script_user root
    enable_script_security
&#125;
vrrp_script chk_apiserver &#123;
    script &quot;/etc/keepalived/check_apiserver.sh&quot;
   interval 5
    weight -5
    fall 2  
rise 1
&#125;
vrrp_instance VI_1 &#123;
    state BACKUP
    interface ens160                #网卡名称
    mcast_src_ip 192.168.1.72       #K8s-master02 IP地址
    virtual_router_id 51
    priority 100
    advert_int 2
    authentication &#123;
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    &#125;
    virtual_ipaddress &#123;
        192.168.1.70              #VIP地址
    &#125;
    track_script &#123;
       chk_apiserver
    &#125;
&#125;
</code></pre><p><mark>Master03 节点</mark>的配置：</p><pre><code># vim /etc/keepalived/keepalived.conf 

! Configuration File for keepalived
global_defs &#123;
    router_id LVS_DEVEL
script_user root
    enable_script_security
&#125;
vrrp_script chk_apiserver &#123;
    script &quot;/etc/keepalived/check_apiserver.sh&quot;
 interval 5
    weight -5
    fall 2  
rise 1
&#125;
vrrp_instance VI_1 &#123;
    state BACKUP
    interface ens160                 #网卡名称
    mcast_src_ip 192.168.1.73        #K8s-master03 IP地址
    virtual_router_id 51
    priority 100
    advert_int 2
    authentication &#123;
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    &#125;
    virtual_ipaddress &#123;
        192.168.1.70          #VIP地址
    &#125;
    track_script &#123;
       chk_apiserver
    &#125;
&#125;
</code></pre><p><mark>所有 master 节点</mark>配置 KeepAlived 健康检查文件：</p><pre><code>[root@k8s-master01 keepalived]# vim /etc/keepalived/check_apiserver.sh 
#!/bin/bash

err=0
for k in $(seq 1 3)
do
    check_code=$(pgrep haproxy)
    if [[ $check_code == &quot;&quot; ]]; then
        err=$(expr $err + 1)
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ $err != &quot;0&quot; ]]; then
    echo &quot;systemctl stop keepalived&quot;
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi
</code></pre><p><mark>所有 master 节点</mark>配置健康检查文件添加执行权限：</p><pre><code>chmod +x /etc/keepalived/check_apiserver.sh
</code></pre><p><mark>所有 master 节点</mark>启动 haproxy 和 keepalived：</p><pre><code>[root@k8s-master01 keepalived]# systemctl daemon-reload
[root@k8s-master01 keepalived]# systemctl enable --now haproxy
[root@k8s-master01 keepalived]# systemctl enable --now keepalived
</code></pre><p>重要：如果安装了 keepalived 和 haproxy，需要测试 keepalived 是否是正常的</p><pre><code>所有节点测试VIP
[root@k8s-master01 ~]# ping 192.168.1.70 -c 4
PING 192.168.1.70 (192.168.1.70) 56(84) bytes of data.
64 bytes from 192.168.1.70: icmp_seq=1 ttl=64 time=0.464 ms
64 bytes from 192.168.1.70: icmp_seq=2 ttl=64 time=0.063 ms
64 bytes from 192.168.1.70: icmp_seq=3 ttl=64 time=0.062 ms
64 bytes from 192.168.1.70: icmp_seq=4 ttl=64 time=0.063 ms

[root@k8s-master01 ~]# telnet 192.168.1.70 16443
Trying 192.168.1.70...
Connected to 192.168.1.70.
Escape character is '^]'.
Connection closed by foreign host.
</code></pre><p>如果 ping 不通且 telnet 没有出现 ] ，则认为 VIP 不可以，不可在继续往下执行，需要排查 keepalived 的问题，比如防火墙和 selinux，haproxy 和 keepalived 的状态，监听端口等</p><ul><li>所有节点查看防火墙状态必须为 disable 和 inactive：systemctl status firewalld</li><li>所有节点查看 selinux 状态，必须为 disable：getenforce</li><li>master 节点查看 haproxy 和 keepalived 状态：systemctl status keepalived haproxy</li><li>master 节点查看监听端口：netstat -lntp</li></ul><p>如果以上都没有问题，需要确认：</p><ol><li><p>是否是公有云机器</p></li><li><p>是否是私有云机器（类似 OpenStack）</p></li></ol><p>上述公有云一般都是不支持 keepalived，私有云可能也有限制，需要和自己的私有云管理员咨询</p><h4 id="3-runtime安装"><a class="anchor" href="#3-runtime安装">#</a> 3. Runtime 安装</h4><p>如果安装的版本低于 1.24，选择 Docker 和 Containerd 均可，高于 1.24 建议选择 Containerd 作为 Runtime，不再推荐使用 Docker 作为 Runtime。</p><h5 id="31-安装containerd"><a class="anchor" href="#31-安装containerd">#</a> 3.1 安装 Containerd</h5><p><mark>所有节点</mark>配置安装源：</p><pre><code>yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre><p><mark>所有节点</mark>安装 docker-ce（如果在以前已经安装过，需要重新安装更新一下）：</p><pre><code># yum install docker-ce containerd -y
</code></pre><p><em>可以无需启动 Docker，只需要配置和启动 Containerd 即可。</em></p><p>首先配置 Containerd 所需的模块（<mark>所有节点</mark>）：</p><pre><code># cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF
</code></pre><p><mark>所有节点</mark>加载模块：</p><pre><code># modprobe -- overlay
# modprobe -- br_netfilter
</code></pre><p><mark>所有节点</mark>，配置 Containerd 所需的内核：</p><pre><code># cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
</code></pre><p><mark>所有节点</mark>加载内核：</p><pre><code># sysctl --system
</code></pre><p><mark>所有节点</mark>生成 Containerd 的配置文件：</p><pre><code># mkdir -p /etc/containerd
# containerd config default | tee /etc/containerd/config.toml
</code></pre><p><mark>所有节点</mark>更改 Containerd 的 Cgroup 和 Pause 镜像配置：</p><pre><code>sed -i 's#SystemdCgroup = false#SystemdCgroup = true#g' /etc/containerd/config.toml
sed -i 's#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'  /etc/containerd/config.toml
sed -i 's#registry.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'  /etc/containerd/config.toml
sed -i 's#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'  /etc/containerd/config.toml
</code></pre><p><mark>所有节点</mark>启动 Containerd，并配置开机自启动：</p><pre><code># systemctl daemon-reload
# systemctl enable --now containerd
</code></pre><p><mark>所有节点</mark>配置 crictl 客户端连接的运行时位置（可选）：</p><pre><code># cat &gt; /etc/crictl.yaml &lt;&lt;EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF
</code></pre><h4 id="4-k8s及etcd安装"><a class="anchor" href="#4-k8s及etcd安装">#</a> 4 . K8S 及 etcd 安装</h4><p><mark>Master01</mark> 下载 kubernetes 安装包（1.32.3 需要更改为你看到的最新版本）：</p><pre><code>[root@k8s-master01 ~]# wget https://dl.k8s.io/v1.32.0/kubernetes-server-linux-amd64.tar.gz
</code></pre><p>最新版获取地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.31.md">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/</a></p><p><mark>以下操作都在 master01 执行</mark></p><p>下载 etcd 安装包：<a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases/">https://github.com/etcd-io/etcd/releases/</a></p><pre><code>[root@k8s-master01 ~]# wget https://github.com/etcd-io/etcd/releases/download/v3.5.16/etcd-v3.5.16-linux-amd64.tar.gz
</code></pre><p>解压 kubernetes 安装文件：</p><pre><code>[root@k8s-master01 ~]# tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;
</code></pre><p>解压 etcd 安装文件：</p><pre><code>[root@k8s-master01 ~]#  tar -zxvf etcd-v3.5.16-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.16-linux-amd64/etcd&#123;,ctl&#125;
</code></pre><p>版本查看：</p><pre><code>[root@k8s-master01 ~]# kubelet --version
Kubernetes v1.32.3
[root@k8s-master01 ~]# etcdctl version
etcdctl version: 3.5.16
API version: 3.5
</code></pre><p>将组件发送到其他节点</p><pre><code>MasterNodes='k8s-master02 k8s-master03'
WorkNodes='k8s-node01 k8s-node02'
for NODE in $MasterNodes; do echo $NODE; scp /usr/local/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done
for NODE in $WorkNodes; do     scp /usr/local/bin/kube&#123;let,-proxy&#125; $NODE:/usr/local/bin/ ; done
</code></pre><p><mark>Master01 节点</mark>切换到 1.32.x 分支（其他版本可以切换到其他分支，.x 即可，不需要更改为具体的小版本）：</p><pre><code>cd /root/k8s-ha-install &amp;&amp; git checkout manual-installation-v1.32.x
</code></pre><h4 id="5-生成证书"><a class="anchor" href="#5-生成证书">#</a> 5 . 生成证书</h4><p><em><mark>二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的</mark></em></p><p><mark>Master01</mark> 下载生成证书工具（下载不成功可以去百度网盘）</p><pre><code>wget &quot;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&quot; -O /usr/local/bin/cfssl
wget &quot;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&quot; -O /usr/local/bin/cfssljson
chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</code></pre><h5 id="51-etcd证书"><a class="anchor" href="#51-etcd证书">#</a> 5.1 Etcd 证书</h5><p><mark>所有 Master 节点</mark>创建 etcd 证书目录：</p><pre><code>mkdir /etc/etcd/ssl -p
</code></pre><p><mark>所有节点</mark>创建 kubernetes 相关目录：</p><pre><code>mkdir -p /etc/kubernetes/pki
</code></pre><p><mark>Master01 节点</mark>生成 etcd 证书</p><p>生成证书的 CSR（证书签名请求文件，配置了一些域名、公司、单位）文件：</p><pre><code>[root@k8s-master01 pki]# cd /root/k8s-ha-install/pki

# 生成etcd CA证书和CA证书的key
cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca


cfssl gencert \
   -ca=/etc/etcd/ssl/etcd-ca.pem \
   -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \
   -config=ca-config.json \
   -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.71,192.168.1.72,192.168.1.73 \
   -profile=kubernetes \
   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd

执行结果
[INFO] generate received request
 	[INFO] received CSR
     [INFO] generating key: rsa-2048
     [INFO] encoded CSR
     [INFO] signed certificate with serial number     250230878926052708909595617022917808304837732033
</code></pre><p>将证书复制到其他 master 节点</p><pre><code>MasterNodes='k8s-master02 k8s-master03'

for NODE in $MasterNodes; do
     ssh $NODE &quot;mkdir -p /etc/etcd/ssl&quot;
     for FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; do
       scp /etc/etcd/ssl/$&#123;FILE&#125; $NODE:/etc/etcd/ssl/$&#123;FILE&#125;
     done
 done
</code></pre><h5 id="52-k8s组件证书"><a class="anchor" href="#52-k8s组件证书">#</a> 5.2 K8s 组件证书</h5><p><mark>Master01</mark> 生成 kubernetes CA 证书：</p><pre><code>[root@k8s-master01 pki]# cd /root/k8s-ha-install/pki

cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca
</code></pre><h6 id="521-apiserver证书"><a class="anchor" href="#521-apiserver证书">#</a> 5.2.1 APIServer 证书</h6><p>注意：10.96.0. 是 k8s service 的网段，如果说需要更改 k8s service 网段，那就需要更改 10.96.0.1</p><pre><code>cfssl gencert   -ca=/etc/kubernetes/pki/ca.pem   -ca-key=/etc/kubernetes/pki/ca-key.pem   -config=ca-config.json   -hostname=10.96.0.1,192.168.1.70,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.1.71,192.168.1.72,192.168.1.73   -profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver
</code></pre><p>生成 apiserver 的聚合证书：：</p><pre><code>cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca 

cfssl gencert   -ca=/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   -config=ca-config.json   -profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client
</code></pre><p>返回结果（忽略警告）：</p><pre><code>2020/12/11 18:15:28 [INFO] generate received request
2020/12/11 18:15:28 [INFO] received CSR
2020/12/11 18:15:28 [INFO] generating key: rsa-2048

2020/12/11 18:15:28 [INFO] encoded CSR
2020/12/11 18:15:28 [INFO] signed certificate with serial number 597484897564859295955894546063479154194995827845
2020/12/11 18:15:28 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for
websites. For more information see the Baseline Requirements for the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);
specifically, section 10.2.3 (&quot;Information Requirements&quot;).
</code></pre><h6 id="522-controllermanager"><a class="anchor" href="#522-controllermanager">#</a> 5.2.2 ControllerManager</h6><p>生成 controller-manage 的证书：</p><pre><code class="language-\">cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager

注意：修改黄色部分的IP地址
# set-cluster：设置一个集群项，

kubectl config set-cluster kubernetes \
     --certificate-authority=/etc/kubernetes/pki/ca.pem \
     --embed-certs=true \
     --server=https://192.168.1.70:8443 \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig

# 设置一个环境项，一个上下文
kubectl config set-context system:kube-controller-manager@kubernetes \
    --cluster=kubernetes \
    --user=system:kube-controller-manager \
    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig

# set-credentials 设置一个用户项

kubectl config set-credentials system:kube-controller-manager \
     --client-certificate=/etc/kubernetes/pki/controller-manager.pem \
     --client-key=/etc/kubernetes/pki/controller-manager-key.pem \
     --embed-certs=true \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig


# 使用某个环境当做默认环境

kubectl config use-context system:kube-controller-manager@kubernetes \
     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
</code></pre><h6 id="523-scheduler证书"><a class="anchor" href="#523-scheduler证书">#</a> 5.2.3 Scheduler 证书</h6><pre><code>cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler

注意：修改黄色部分的IP地址

kubectl config set-cluster kubernetes \
     --certificate-authority=/etc/kubernetes/pki/ca.pem \
     --embed-certs=true \
     --server=https://192.168.1.70:8443 \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig


kubectl config set-credentials system:kube-scheduler \
     --client-certificate=/etc/kubernetes/pki/scheduler.pem \
     --client-key=/etc/kubernetes/pki/scheduler-key.pem \
     --embed-certs=true \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

kubectl config set-context system:kube-scheduler@kubernetes \
     --cluster=kubernetes \
     --user=system:kube-scheduler \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

kubectl config use-context system:kube-scheduler@kubernetes \
     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
</code></pre><h6 id="524-生成管理员证书"><a class="anchor" href="#524-生成管理员证书">#</a> 5.2.4 生成管理员证书</h6><p>Kubectl /etc/Kubernetes/admin.conf ~/.kube/config</p><pre><code>cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin

注意：修改黄色部分的IP

kubectl config set-cluster kubernetes     --certificate-authority=/etc/kubernetes/pki/ca.pem     --embed-certs=true     --server=https://192.168.1.70:8443     --kubeconfig=/etc/kubernetes/admin.kubeconfig
kubectl config set-credentials kubernetes-admin     --client-certificate=/etc/kubernetes/pki/admin.pem     --client-key=/etc/kubernetes/pki/admin-key.pem     --embed-certs=true     --kubeconfig=/etc/kubernetes/admin.kubeconfig

kubectl config set-context kubernetes-admin@kubernetes     --cluster=kubernetes     --user=kubernetes-admin     --kubeconfig=/etc/kubernetes/admin.kubeconfig

kubectl config use-context kubernetes-admin@kubernetes     --kubeconfig=/etc/kubernetes/admin.kubeconfig
</code></pre><h6 id="525-创建serviceaccount证书"><a class="anchor" href="#525-创建serviceaccount证书">#</a> 5.2.5 创建 ServiceAccount 证书</h6><p>创建一对公钥，用来签发 ServiceAccount 的 Token：</p><pre><code>openssl genrsa -out /etc/kubernetes/pki/sa.key 2048
</code></pre><p>返回结果：</p><pre><code>Generating RSA private key, 2048 bit long modulus (2 primes)
...................................................................................+++++
...............+++++
e is 65537 (0x010001)
</code></pre><pre><code> openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
</code></pre><p>发送证书至其他节点：</p><pre><code>for NODE in k8s-master02 k8s-master03; do 
  for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do 
    scp /etc/kubernetes/pki/$&#123;FILE&#125; $NODE:/etc/kubernetes/pki/$&#123;FILE&#125;;
  done; 
  for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do 
    scp /etc/kubernetes/$&#123;FILE&#125; $NODE:/etc/kubernetes/$&#123;FILE&#125;;
  done;
done
</code></pre><p>查看证书文件：</p><pre><code>[root@k8s-master01 pki]# ls /etc/kubernetes/pki/
admin.csr      apiserver.csr      ca.csr      controller-manager.csr      front-proxy-ca.csr      front-proxy-client.csr      sa.key         scheduler-key.pem
admin-key.pem  apiserver-key.pem  ca-key.pem  controller-manager-key.pem  front-proxy-ca-key.pem  front-proxy-client-key.pem  sa.pub         scheduler.pem
admin.pem      apiserver.pem      ca.pem      controller-manager.pem      front-proxy-ca.pem      front-proxy-client.pem      scheduler.csr
[root@k8s-master01 pki]# ls /etc/kubernetes/pki/ |wc -l
23
</code></pre><h4 id="6-kubernetes组件配置"><a class="anchor" href="#6-kubernetes组件配置">#</a> 6. Kubernetes 组件配置</h4><h5 id="61-ecd配置"><a class="anchor" href="#61-ecd配置">#</a> 6.1 Ecd 配置</h5><p>Etcd 配置大致相同，注意修改每个 Master 节点的 etcd 配置的主机名和 IP 地址</p><h6 id="611-master01"><a class="anchor" href="#611-master01">#</a> 6.1.1 Master01</h6><pre><code># vim /etc/etcd/etcd.config.yml
name: 'k8s-master01'     # k8s-master01名称
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.1.71:2380'            # k8s-master01 IP
listen-client-urls: 'https://192.168.1.71:2379,http://127.0.0.1:2379'   # k8s-master01 IP
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.1.71:2380'  # k8s-master01 IP
advertise-client-urls: 'https://192.168.1.71:2379'        # k8s-master01 IP
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.1.71:2380,k8s-master02=https://192.168.1.72:2380,k8s-master03=https://192.168.1.73:2380'     # k8s-master01、k8s-master02、k8s-master03 IP 
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
</code></pre><h6 id="612-master02"><a class="anchor" href="#612-master02">#</a> 6.1.2 Master02</h6><pre><code># vim /etc/etcd/etcd.config.yml	
name: 'k8s-master02'   # k8s-master02名称
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.1.72:2380'      # k8s-master02 IP
listen-client-urls: 'https://192.168.1.72:2379,http://127.0.0.1:2379'    # k8s-master02 IP
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.1.72:2380'    # k8s-master02 IP
advertise-client-urls: 'https://192.168.1.72:2379'     # k8s-master02 IP
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.1.71:2380,k8s-master02=https://192.168.1.72:2380,k8s-master03=https://192.168.1.73:2380'             # k8s-master01、k8s-master02、k8s-master03 IP 
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
</code></pre><h6 id="613-master03"><a class="anchor" href="#613-master03">#</a> 6.1.3 Master03</h6><pre><code># vim /etc/etcd/etcd.config.yml
name: 'k8s-master03'           # k8s-master03名称
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.1.73:2380'           # k8s-master03 IP
listen-client-urls: 'https://192.168.1.73:2379,http://127.0.0.1:2379'       # k8s-master03 IP
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.1.73:2380'      # k8s-master03 IP
advertise-client-urls: 'https://192.168.1.73:2379'            # k8s-master03 IP
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.1.71:2380,k8s-master02=https://192.168.1.72:2380,k8s-master03=https://192.168.1.73:2380'                # k8s-master01、k8s-master02、k8s-master03 IP
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
</code></pre><h6 id="614-启动etcd"><a class="anchor" href="#614-启动etcd">#</a> 6.1.4 启动 Etcd</h6><p><mark>所有 Master 节点</mark>创建 etcd service 并启动</p><pre><code># vim /usr/lib/systemd/system/etcd.service
[Unit]
Description=Etcd Service
Documentation=https://coreos.com/etcd/docs/latest/
After=network.target

[Service]
Type=notify
ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml
Restart=on-failure
RestartSec=10
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
Alias=etcd3.service
</code></pre><p><mark>所有 Master 节点</mark>创建 etcd 的证书目录：</p><pre><code>mkdir /etc/kubernetes/pki/etcd
ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
systemctl daemon-reload
systemctl enable --now etcd
</code></pre><p>查看 etcd 状态：</p><pre><code>export ETCDCTL_API=3
etcdctl --endpoints=&quot;192.168.1.73:2379,192.168.1.72:2379,192.168.1.71:2379&quot; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table
</code></pre><h5 id="62-apiserver配置"><a class="anchor" href="#62-apiserver配置">#</a> 6.2 APIServer 配置</h5><h6 id="621-master01"><a class="anchor" href="#621-master01">#</a> 6.2.1 Master01</h6><p>注意：本文档使用的 k8s service 网段为 10.96.0.0/16，该网段不能和宿主机的网段、Pod 网段的重复，请按需修改：</p><pre><code>[root@k8s-master01 pki]# vim /usr/lib/systemd/system/kube-apiserver.service 

[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \
      --v=2  \
      --allow-privileged=true  \
      --bind-address=0.0.0.0  \
      --secure-port=6443  \
      --advertise-address=192.168.1.71 \
      --service-cluster-ip-range=10.96.0.0/16  \
      --service-node-port-range=30000-32767  \
      --etcd-servers=https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 \
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
      --authorization-mode=Node,RBAC  \
      --enable-bootstrap-token-auth=true  \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \
      --requestheader-allowed-names=aggregator  \
      --requestheader-group-headers=X-Remote-Group  \
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \
      --requestheader-username-headers=X-Remote-User
      # --token-auth-file=/etc/kubernetes/token.csv

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
</code></pre><h6 id="622-master02"><a class="anchor" href="#622-master02">#</a> 6.2.2 Master02</h6><p>注意：本文档使用的 k8s service 网段为 10.96.0.0/16，该网段不能和宿主机的网段、Pod 网段的重复，请按需修改：</p><pre><code>[root@k8s-master01 pki]# vim  /usr/lib/systemd/system/kube-apiserver.service 

[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \
      --v=2  \
      --allow-privileged=true  \
      --bind-address=0.0.0.0  \
      --secure-port=6443  \
      --advertise-address=192.168.1.72 \
      --service-cluster-ip-range=10.96.0.0/16  \
      --service-node-port-range=30000-32767  \
      --etcd-servers=https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 \
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
      --authorization-mode=Node,RBAC  \
      --enable-bootstrap-token-auth=true  \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \
      --requestheader-allowed-names=aggregator  \
      --requestheader-group-headers=X-Remote-Group  \
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \
      --requestheader-username-headers=X-Remote-User

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
</code></pre><h6 id="623-master03"><a class="anchor" href="#623-master03">#</a> 6.2.3 Master03</h6><p>注意：本文档使用的 k8s service 网段为 10.96.0.0/16，该网段不能和宿主机的网段、Pod 网段的重复，请按需修改：</p><pre><code>[root@k8s-master01 pki]# vim  /usr/lib/systemd/system/kube-apiserver.service 

[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \
      --v=2  \
      --allow-privileged=true  \
      --bind-address=0.0.0.0  \
      --secure-port=6443  \
      --advertise-address=192.168.1.73 \
      --service-cluster-ip-range=10.96.0.0/16  \
      --service-node-port-range=30000-32767  \
      --etcd-servers=https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 \
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
      --authorization-mode=Node,RBAC  \
      --enable-bootstrap-token-auth=true  \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \
      --requestheader-allowed-names=aggregator  \
      --requestheader-group-headers=X-Remote-Group  \
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \
      --requestheader-username-headers=X-Remote-User
      # --token-auth-file=/etc/kubernetes/token.csv

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
</code></pre><h6 id="624-启动apiserver"><a class="anchor" href="#624-启动apiserver">#</a> 6.2.4 启动 apiserver</h6><p><mark>所有 Master 节点</mark>开启 kube-apiserver：</p><pre><code>systemctl daemon-reload &amp;&amp; systemctl enable --now kube-apiserver
</code></pre><p>检测 kube-server 状态：</p><pre><code># systemctl status kube-apiserver

● kube-apiserver.service – Kubernetes API Server
   Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)
   Active: active (running) since Sat 2020-08-22 21:26:49 CST; 26s ago 
</code></pre><p>如果系统日志有这些提示可以忽略:</p><pre><code>Dec 11 20:51:15 k8s-master01 kube-apiserver: I1211 20:51:15.004739    7450 clientconn.go:948] ClientConn switching balancer to “pick_first”
Dec 11 20:51:15 k8s-master01 kube-apiserver: I1211 20:51:15.004843    7450 balancer_conn_wrappers.go:78] pickfirstBalancer: HandleSubConnStateChange: 0xc011bd4c80, &#123;CONNECTING &lt;nil&gt;&#125;
Dec 11 20:51:15 k8s-master01 kube-apiserver: I1211 20:51:15.010725    7450 balancer_conn_wrappers.go:78] pickfirstBalancer: HandleSubConnStateChange: 0xc011bd4c80, &#123;READY &lt;nil&gt;&#125;
Dec 11 20:51:15 k8s-master01 kube-apiserver: I1211 20:51:15.011370    7450 controlbuf.go:508] transport: loopyWriter.run returning. Connection error: desc = “transport is closing”
</code></pre><h5 id="63-controllermanage"><a class="anchor" href="#63-controllermanage">#</a> 6.3 ControllerManage</h5><p><mark>所有 Master 节点</mark>配置 kube-controller-manager service（所有 master 节点配置一样）</p><p>注意：本文档使用的 k8s Pod 网段为 172.16.0.0/16，该网段不能和宿主机的网段、k8s Service 网段的重复，请按需修改：</p><pre><code>[root@k8s-master01 pki]# vim /usr/lib/systemd/system/kube-controller-manager.service
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \
      --v=2 \
      --root-ca-file=/etc/kubernetes/pki/ca.pem \
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \
      --authentication-kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \
      --authorization-kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \
      --leader-elect=true \
      --use-service-account-credentials=true \
      --node-monitor-grace-period=40s \
      --node-monitor-period=5s \
      --controllers=*,bootstrapsigner,tokencleaner \
      --allocate-node-cidrs=true \
      --cluster-cidr=172.16.0.0/16 \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \
      --node-cidr-mask-size=24
      
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
</code></pre><p><mark>所有 Master 节点</mark>启动 kube-controller-manager</p><pre><code>[root@k8s-master01 pki]# systemctl daemon-reload

[root@k8s-master01 pki]# systemctl enable --now kube-controller-manager
Created symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service → /usr/lib/systemd/system/kube-controller-manager.service.
</code></pre><p>查看启动状态</p><pre><code>[root@k8s-master01 pki]# systemctl  status kube-controller-manager
● kube-controller-manager.service – Kubernetes Controller Manager
   Loaded: loaded (/usr/lib/ ubern/system/kube-controller-manager.service; enabled; vendor preset: disabled)
 Active: active (running) since Fri 2020-12-11 20:53:05 CST; 8s ago
     Docs: https://github.com/  ubernetes/  ubernetes
 Main PID: 7518 (kube-controller)
</code></pre><h5 id="64-scheduler"><a class="anchor" href="#64-scheduler">#</a> 6.4 Scheduler</h5><p>所有 Master 节点配置 kube-scheduler service（所有 master 节点配置一样）</p><pre><code>[root@k8s-master01 pki]# vim /usr/lib/systemd/system/kube-scheduler.service 
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-scheduler \
      --v=2 \
      --leader-elect=true \
      --authentication-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \
      --authorization-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \
      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
</code></pre><p>启动 scheduler：</p><pre><code>[root@k8s-master01 pki]# systemctl daemon-reload

[root@k8s-master01 pki]# systemctl enable --now kube-scheduler
Created symlink /etc/systemd/system/multi-user.target.wants/kube-scheduler.service → /usr/lib/systemd/system/kube-scheduler.service.
[root@k8s-master01 pki]# systemctl status kube-scheduler
● kube-scheduler.service - Kubernetes Scheduler
   Loaded: loaded (/usr/lib/systemd/system/kube-scheduler.service; enabled; vendor preset: disabled)
   Active: active (running) since Wed 2022-05-04 17:31:13 CST; 6s ago
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: 5815 (kube-scheduler)
    Tasks: 9
   Memory: 19.8M
</code></pre><h4 id="7-tls-bootstrapping配置"><a class="anchor" href="#7-tls-bootstrapping配置">#</a> 7. TLS Bootstrapping 配置</h4><p>只需要在<mark> Master01</mark> 创建 bootstrap</p><p>注意： 修改黄色部分的 IP 地址</p><pre><code>cd /root/k8s-ha-install/bootstrap
kubectl config set-cluster kubernetes     --certificate-authority=/etc/kubernetes/pki/ca.pem     --embed-certs=true     --server=https://192.168.1.70:8443     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-credentials tls-bootstrap-token-user     --token=c8ad9c.2e4d610cf3e7426e --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-context tls-bootstrap-token-user@kubernetes     --cluster=kubernetes     --user=tls-bootstrap-token-user     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config use-context tls-bootstrap-token-user@kubernetes     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig

[root@k8s-master01 bootstrap]# mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config
</code></pre><p>可以正常查询集群状态，才可以继续往下，否则不行，需要排查 k8s 组件是否有故障（只要有结果即可，如果返回不一样不影响）</p><pre><code># kubectl get cs
Warning: v1 ComponentStatus is deprecated in v1.19+
NAME                 STATUS    MESSAGE   ERROR
controller-manager   Healthy   ok        
scheduler            Healthy   ok        
etcd-0               Healthy   ok
</code></pre><p>创建 bootstrap 相关资源：</p><pre><code>[root@k8s-master01 bootstrap]# kubectl create -f bootstrap.secret.yaml 
secret/bootstrap-token-c8ad9c created
clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created
clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</code></pre><h4 id="8-node节点配置"><a class="anchor" href="#8-node节点配置">#</a> 8. Node 节点配置</h4><h5 id="81-复制证书"><a class="anchor" href="#81-复制证书">#</a> 8.1 复制证书</h5><p><mark>Master01 节点</mark>复制证书至其他节点：</p><pre><code>cd /etc/kubernetes/

for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do
     ssh $NODE mkdir -p /etc/kubernetes/pki
     for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; do
       scp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/$&#123;FILE&#125;
 done
 done
</code></pre><p>执行结果：</p><pre><code>ca.pem                                                                                                                                                                         100% 1407   459.5KB/s   00:00    
…
bootstrap-kubelet.kubeconfig                                                                                                                                                   100% 2291   685.4KB/s   00:00
</code></pre><h5 id="82-kubelet配置"><a class="anchor" href="#82-kubelet配置">#</a> 8.2 Kubelet 配置</h5><p><mark>所有节点</mark>创建 Kubelet 配置目录</p><pre><code>mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/
</code></pre><p><mark>所有节点</mark>配置 kubelet service</p><pre><code>[root@k8s-master01 bootstrap]# vim  /usr/lib/systemd/system/kubelet.service

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kubelet

Restart=always
StartLimitInterval=0
RestartSec=10

[Install]
WantedBy=multi-user.target
</code></pre><p><mark>所有节点</mark>配置 kubelet service 的配置文件（也可以写到 kubelet.service）：</p><pre><code># Runtime为Containerd
# vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf

[Service]
Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&quot;
Environment=&quot;KUBELET_SYSTEM_ARGS=--container-runtime-endpoint=unix:///run/containerd/containerd.sock&quot;
Environment=&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml&quot;
Environment=&quot;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' &quot;
ExecStart=
ExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS
</code></pre><p><mark>所有节点</mark>创建 kubelet 的配置文件</p><p><em>注意：如果更改了 k8s 的 service 网段，需要更改 kubelet-conf.yml 的 clusterDNS: 配置，改成 k8s Service 网段的第十个地址，比如 10.96.0.10</em></p><pre><code>[root@k8s-master01 bootstrap]# vim /etc/kubernetes/kubelet-conf.yml

apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: true
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: true
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: true
enableDebuggingHandlers: true
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: true
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 20s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
iptablesDropBit: 15
iptablesMasqueradeBit: 14
kubeAPIBurst: 10
kubeAPIQPS: 5
makeIPTablesUtilChains: true
maxOpenFiles: 1000000
maxPods: 110
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: 10
registryPullQPS: 5
resolvConf: /etc/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 2m0s
serializeImagePulls: true
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s
</code></pre><p>启动<mark>所有节点</mark> kubelet</p><pre><code>systemctl daemon-reload
systemctl enable --now kubelet
</code></pre><p>此时系统日志 /var/log/messages**** 显示只有如下两种信息为正常 ****，安装 calico 后即可恢复</p><pre><code>Unable to update cni config: no networks found in /etc/cni/net.d
</code></pre><p><a target="_blank" rel="noopener" href="https://imgse.com/i/pE2ZkVK"><img loading="lazy" data-src="https://s21.ax1x.com/2025/04/10/pE2ZkVK.png" alt="pE2ZkVK.png"></a></p><p><em>如果有很多报错日志，或者有大量看不懂的报错，说明 kubelet 的配置有误，需要检查 kubelet 配置</em></p><p>Master01 查看集群状态 (Ready 或 NotReady 都正常)</p><pre><code>[root@k8s-master01 bootstrap]# kubectl get node
</code></pre><h5 id="83-kube-proxy配置"><a class="anchor" href="#83-kube-proxy配置">#</a> 8.3 kube-proxy 配置</h5><p><em>注意，如果不是高可用集群，192.168.1.70:8443 改为 master01 的地址，8443 改为 apiserver 的端口，默认是 6443</em></p><p>生成 kube-proxy 的证书，以下操作只在<mark> Master01</mark> 执行</p><pre><code>cd /root/k8s-ha-install/pki
cfssl gencert \
   -ca=/etc/kubernetes/pki/ca.pem \
   -ca-key=/etc/kubernetes/pki/ca-key.pem \
   -config=ca-config.json \
   -profile=kubernetes \
   kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy

kubectl config set-cluster kubernetes \
     --certificate-authority=/etc/kubernetes/pki/ca.pem \
     --embed-certs=true \
     --server=https://192.168.1.70:8443 \
     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig


kubectl config set-credentials system:kube-proxy \
     --client-certificate=/etc/kubernetes/pki/kube-proxy.pem \
     --client-key=/etc/kubernetes/pki/kube-proxy-key.pem \
     --embed-certs=true \
     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig

kubectl config set-context system:kube-proxy@kubernetes \
     --cluster=kubernetes \
     --user=system:kube-proxy \
     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig


kubectl config use-context system:kube-proxy@kubernetes \
     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig
</code></pre><p>将 kubeconfig 发送至其他节点</p><pre><code>for NODE in k8s-master02 k8s-master03; do
     scp /etc/kubernetes/kube-proxy.kubeconfig  $NODE:/etc/kubernetes/kube-proxy.kubeconfig
 done

for NODE in k8s-node01 k8s-node02; do
     scp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig
 done
</code></pre><p><mark>所有节点</mark>添加 kube-proxy 的配置和 service 文件：</p><pre><code>vim /usr/lib/systemd/system/kube-proxy.service

[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-proxy \
  --config=/etc/kubernetes/kube-proxy.yaml \
  --v=2

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
</code></pre><p>如果更改了集群 Pod 的网段，需要更改 kube-proxy.yaml 的 clusterCIDR 为自己的 Pod 网段：</p><pre><code>vim /etc/kubernetes/kube-proxy.yaml

apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
clientConnection:
  acceptContentTypes: &quot;&quot;
  burst: 10
  contentType: application/vnd.kubernetes.protobuf
  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
  qps: 5
clusterCIDR: 172.16.0.0/16 
configSyncPeriod: 15m0s
conntrack:
  max: null
  maxPerCore: 32768
  min: 131072
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
enableProfiling: false
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: &quot;&quot;
iptables:
  masqueradeAll: false
  masqueradeBit: 14
  minSyncPeriod: 0s
  syncPeriod: 30s
ipvs:
  masqueradeAll: true
  minSyncPeriod: 5s
  scheduler: &quot;rr&quot;
  syncPeriod: 30s
kind: KubeProxyConfiguration
metricsBindAddress: 127.0.0.1:10249
mode: &quot;ipvs&quot;
nodePortAddresses: null
oomScoreAdj: -999
portRange: &quot;&quot;
udpIdleTimeout: 250ms
</code></pre><p><mark>所有节点</mark>启动 kube-proxy</p><pre><code>[root@k8s-master01 k8s-ha-install]# systemctl daemon-reload
[root@k8s-master01 k8s-ha-install]# systemctl enable --now kube-proxy
Created symlink /etc/systemd/system/multi-user.target.wants/kube-proxy.service → /usr/lib/systemd/system/kube-proxy.service.
</code></pre><p>此时系统日志 /var/log/messages**** 显示只有如下两种信息为正常 ****，安装 calico 后即可恢复</p><pre><code>Unable to update cni config: no networks found in /etc/cni/net.d
</code></pre><p><a target="_blank" rel="noopener" href="https://imgse.com/i/pE2ZkVK"><img loading="lazy" data-src="https://s21.ax1x.com/2025/04/10/pE2ZkVK.png" alt="pE2ZkVK.png"></a></p><h4 id="9-calico组件的安装"><a class="anchor" href="#9-calico组件的安装">#</a> 9. Calico 组件的安装</h4><p>以下步骤只在 master01 执行：</p><pre><code>cd /root/k8s-ha-install/calico/
</code></pre><p>更改 calico 的网段，主要需要将红色部分的网段，改为自己的 Pod 网段</p><pre><code>sed -i &quot;s#POD_CIDR#172.16.0.0/16#g&quot; calico.yaml
</code></pre><p><em>检查网段是自己的 Pod 网段， grep &quot;IPV4POOL_CIDR&quot; calico.yaml -A 1</em></p><p>查看容器和节点状态：</p><pre><code>[root@k8s-master01 calico]# kubectl get po -n kube-system
NAME                                       READY   STATUS    RESTARTS      AGE
calico-kube-controllers-66686fdb54-mk2g6   1/1     Running   1 (20s ago)   85s
calico-node-8fxqp                          1/1     Running   0             85s
calico-node-8nkfl                          1/1     Running   0             86s
calico-node-pmpf4                          1/1     Running   0             86s
calico-node-vnlk7                          1/1     Running   0             86s
calico-node-xpchb                          1/1     Running   0             85s
calico-typha-67c6dc57d6-259t8              1/1     Running   0             86s
</code></pre><p><em>如果容器状态异常可以使用 kubectl describe 或者 kubectl logs 查看容器的日志</em></p><ol><li>Kubectl logs -f POD_NAME -n kube-system</li><li>Kubectl logs -f POD_NAME -c upgrade-ipam -n kube-system</li></ol><h4 id="10-安装coredns"><a class="anchor" href="#10-安装coredns">#</a> 10. 安装 CoreDNS</h4><pre><code>cd /root/k8s-ha-install/
</code></pre><p>如果更改了 k8s service 的网段需要将 coredns 的 serviceIP 改成 k8s service 网段的第十个 IP</p><pre><code>COREDNS_SERVICE_IP=`kubectl get svc | grep kubernetes | awk '&#123;print $3&#125;'`0
sed -i &quot;s#KUBEDNS_SERVICE_IP#$&#123;COREDNS_SERVICE_IP&#125;#g&quot; CoreDNS/coredns.yaml
</code></pre><p>安装 coredns</p><pre><code>[root@k8s-master01 k8s-ha-install]# kubectl  create -f CoreDNS/coredns.yaml 
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
</code></pre><h4 id="11-metrics部署"><a class="anchor" href="#11-metrics部署">#</a> 11. Metrics 部署</h4><p>在新版的 Kubernetes 中系统资源的采集均使用 Metrics-server，可以通过 Metrics 采集节点和 Pod 的内存、磁盘、CPU 和网络的使用率。</p><p>以下操作均在<mark> master01 节点</mark>执行，安装 metrics server:</p><pre><code>cd /root/k8s-ha-install/metrics-server
kubectl  create -f . 

serviceaccount/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
service/metrics-server created
deployment.apps/metrics-server created
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
</code></pre><p>等待 metrics server 启动然后查看状态：</p><pre><code># kubectl  top node
NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
k8s-master01   231m         5%     1620Mi          42%       
k8s-master02   274m         6%     1203Mi          31%       
k8s-master03   202m         5%     1251Mi          32%       
k8s-node01     69m          1%     667Mi           17%       
k8s-node02     73m          1%     650Mi           16%
</code></pre><p>如果有如下报错，可以等待 10 分钟后，再次查看：</p><pre><code>Error from server (ServiceUnavailable): the server is currently unable to handle the request (get nodes.metrics.k8s.io)
</code></pre><h4 id="12-dashboard部署"><a class="anchor" href="#12-dashboard部署">#</a> 12. Dashboard 部署</h4><h5 id="121-安装dashboard"><a class="anchor" href="#121-安装dashboard">#</a> 12.1 安装 Dashboard</h5><p>Dashboard 用于展示集群中的各类资源，同时也可以通过 Dashboard 实时查看 Pod 的日志和在容器中执行一些命令等。</p><pre><code>cd /root/k8s-ha-install/dashboard/

[root@k8s-master01 dashboard]# kubectl  create -f .
serviceaccount/admin-user created
clusterrolebinding.rbac.authorization.k8s.io/admin-user created
namespace/kubernetes-dashboard created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created
</code></pre><h5 id="122-登录dashboard"><a class="anchor" href="#122-登录dashboard">#</a> 12.2 登录 dashboard</h5><p>在谷歌浏览器（Chrome）启动文件中加入启动参数，用于解决无法访问 Dashboard 的问题，参考下图：</p><pre><code>--test-type --ignore-certificate-errors
</code></pre><p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEgWfHJ"><img loading="lazy" data-src="https://s21.ax1x.com/2025/04/09/pEgWfHJ.png" alt="pEgWfHJ.png"></a></p><p>更改 dashboard 的 svc 为 NodePort:</p><pre><code>kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
</code></pre><p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEgW5NR"><img loading="lazy" data-src="https://s21.ax1x.com/2025/04/09/pEgW5NR.png" alt="pEgW5NR.png"></a></p><p><em>将 ClusterIP 更改为 NodePort（如果已经为 NodePort 忽略此步骤）</em></p><p>查看端口号：</p><pre><code>[root@k8s-master01 ~]# kubectl get svc kubernetes-dashboard -n kubernetes-dashboard
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE
kubernetes-dashboard   NodePort   10.96.139.11   &lt;none&gt;        443:32409/TCP   24h
</code></pre><p>根据自己的实例端口号，通过任意安装了 kube-proxy 的宿主机的 IP + 端口即可访问到 dashboard：</p><p>访问 Dashboard：<a target="_blank" rel="noopener" href="https://192.168.181.129:31106">https://192.168.1.71:32409</a> （把 IP 地址和端口改成你自己的）选择登录方式为令牌（即 token 方式），参考下图：</p><p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEgW736"><img loading="lazy" data-src="https://s21.ax1x.com/2025/04/09/pEgW736.png" alt="pEgW736.png"></a></p><p>创建登录 Token：</p><pre><code>kubectl create token admin-user -n kube-system
</code></pre><p>将 token 值输入到令牌后，单击登录即可访问 Dashboard，参考下图：</p><p><a target="_blank" rel="noopener" href="https://imgse.com/i/pEgfPv8"><img loading="lazy" data-src="https://s21.ax1x.com/2025/04/09/pEgfPv8.png" alt="pEgfPv8.png"></a></p><h4 id="14-containerd配置镜像加速"><a class="anchor" href="#14-containerd配置镜像加速">#</a> 14. Containerd 配置镜像加速</h4><pre><code># vim /etc/containerd/config.toml
#添加以下配置镜像加速服务
       [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]
        endpoint=[&quot;https://dockerproxy.com&quot;, &quot;https://mirror.baidubce.com&quot;,&quot;https://ccr.ccs.tencentyun.com&quot;,&quot;https://docker.m.daocloud.io&quot;,&quot;https://docker.nju.edu.cn&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://registry-1.docker.io&quot;, &quot;https://hbv0b596.mirror.aliyuncs.com&quot;]
       [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;registry.k8s.io&quot;]
        endpoint=[&quot;https://dockerproxy.com&quot;, &quot;https://mirror.baidubce.com&quot;,&quot;https://ccr.ccs.tencentyun.com&quot;,&quot;https://docker.m.daocloud.io&quot;,&quot;https://docker.nju.edu.cn&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://hbv0b596.mirror.aliyuncs.com&quot;, &quot;https://k8s.m.daocloud.io&quot;, &quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://hub-mirror.c.163.com&quot;]
</code></pre><p>所有节点重新启动 Containerd：</p><pre><code># systemctl daemon-reload
# systemctl restart containerd
</code></pre><h4 id="15-docker配置镜像加速"><a class="anchor" href="#15-docker配置镜像加速">#</a> 15. Docker 配置镜像加速</h4><pre><code># sudo mkdir -p /etc/docker
# sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'
&#123;
  &quot;registry-mirrors&quot;: [
	  &quot;https://docker.credclouds.com&quot;,
	  &quot;https://k8s.credclouds.com&quot;,
	  &quot;https://quay.credclouds.com&quot;,
	  &quot;https://gcr.credclouds.com&quot;,
	  &quot;https://k8s-gcr.credclouds.com&quot;,
	  &quot;https://ghcr.credclouds.com&quot;,
	  &quot;https://do.nark.eu.org&quot;,
	  &quot;https://docker.m.daocloud.io&quot;,
	  &quot;https://docker.nju.edu.cn&quot;,
	  &quot;https://docker.mirrors.sjtug.sjtu.edu.cn&quot;,
	  &quot;https://docker.1panel.live&quot;,
	  &quot;https://docker.rainbond.cc&quot;
  ], 
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;] 
&#125;
EOF
</code></pre><p>所有节点重新启动 Docker：</p><pre><code># systemctl daemon-reload
# systemctl enable --now docker
</code></pre><p><em>本文出自于：<a target="_blank" rel="noopener" href="https://edu.51cto.com/course/23845.html">https://edu.51cto.com/course/23845.html</a></em></p><div class="tags"><a href="/tags/Kubernetes/" rel="tag"><i class="ic i-tag"></i>Kubernetes</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/posts/985149017.html">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2025-04-20 08:39:55" itemprop="dateModified" datetime="2025-04-20T08:39:55+08:00">2025-04-20</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Xu Yong 微信支付"><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Xu Yong 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Xu Yong<i class="ic i-at"><em>@</em></i>LinuxSre云原生</li><li class="link"><strong>本文链接：</strong><a href="http://ixuyong.cn/posts/985149017.html" title="二进制高可用安装K8S集群">http://ixuyong.cn/posts/985149017.html</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/posts/2628187572.html" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;s21.ax1x.com&#x2F;2025&#x2F;04&#x2F;09&#x2F;pEgOYIf.jpg" title="MySQL运维DBA应用与实践"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>MySQL</span><h3>MySQL运维DBA应用与实践</h3></a></div><div class="item right"><a href="/posts/3071070979.html" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;ZCErObQ.jpeg" title="一键永久激活Window、office教程"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>Windows</span><h3>一键永久激活Window、office教程</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">二进制高可用安装 K8s 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.1.</span> <span class="toc-text">1. 基本配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">1.1 基本环境配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">1.2 内核配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%AB%98%E5%8F%AF%E7%94%A8%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.0.2.</span> <span class="toc-text">2. 高可用组件安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-runtime%E5%AE%89%E8%A3%85"><span class="toc-number">1.0.3.</span> <span class="toc-text">3. Runtime 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#31-%E5%AE%89%E8%A3%85containerd"><span class="toc-number">1.0.3.1.</span> <span class="toc-text">3.1 安装 Containerd</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-k8s%E5%8F%8Aetcd%E5%AE%89%E8%A3%85"><span class="toc-number">1.0.4.</span> <span class="toc-text">4 . K8S 及 etcd 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-number">1.0.5.</span> <span class="toc-text">5 . 生成证书</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#51-etcd%E8%AF%81%E4%B9%A6"><span class="toc-number">1.0.5.1.</span> <span class="toc-text">5.1 Etcd 证书</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#52-k8s%E7%BB%84%E4%BB%B6%E8%AF%81%E4%B9%A6"><span class="toc-number">1.0.5.2.</span> <span class="toc-text">5.2 K8s 组件证书</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#521-apiserver%E8%AF%81%E4%B9%A6"><span class="toc-number">1.0.5.2.1.</span> <span class="toc-text">5.2.1 APIServer 证书</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#522-controllermanager"><span class="toc-number">1.0.5.2.2.</span> <span class="toc-text">5.2.2 ControllerManager</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#523-scheduler%E8%AF%81%E4%B9%A6"><span class="toc-number">1.0.5.2.3.</span> <span class="toc-text">5.2.3 Scheduler 证书</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#524-%E7%94%9F%E6%88%90%E7%AE%A1%E7%90%86%E5%91%98%E8%AF%81%E4%B9%A6"><span class="toc-number">1.0.5.2.4.</span> <span class="toc-text">5.2.4 生成管理员证书</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#525-%E5%88%9B%E5%BB%BAserviceaccount%E8%AF%81%E4%B9%A6"><span class="toc-number">1.0.5.2.5.</span> <span class="toc-text">5.2.5 创建 ServiceAccount 证书</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-kubernetes%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.6.</span> <span class="toc-text">6. Kubernetes 组件配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#61-ecd%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.6.1.</span> <span class="toc-text">6.1 Ecd 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#611-master01"><span class="toc-number">1.0.6.1.1.</span> <span class="toc-text">6.1.1 Master01</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#612-master02"><span class="toc-number">1.0.6.1.2.</span> <span class="toc-text">6.1.2 Master02</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#613-master03"><span class="toc-number">1.0.6.1.3.</span> <span class="toc-text">6.1.3 Master03</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#614-%E5%90%AF%E5%8A%A8etcd"><span class="toc-number">1.0.6.1.4.</span> <span class="toc-text">6.1.4 启动 Etcd</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#62-apiserver%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.6.2.</span> <span class="toc-text">6.2 APIServer 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#621-master01"><span class="toc-number">1.0.6.2.1.</span> <span class="toc-text">6.2.1 Master01</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#622-master02"><span class="toc-number">1.0.6.2.2.</span> <span class="toc-text">6.2.2 Master02</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#623-master03"><span class="toc-number">1.0.6.2.3.</span> <span class="toc-text">6.2.3 Master03</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#624-%E5%90%AF%E5%8A%A8apiserver"><span class="toc-number">1.0.6.2.4.</span> <span class="toc-text">6.2.4 启动 apiserver</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#63-controllermanage"><span class="toc-number">1.0.6.3.</span> <span class="toc-text">6.3 ControllerManage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#64-scheduler"><span class="toc-number">1.0.6.4.</span> <span class="toc-text">6.4 Scheduler</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-tls-bootstrapping%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.7.</span> <span class="toc-text">7. TLS Bootstrapping 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-node%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.8.</span> <span class="toc-text">8. Node 节点配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#81-%E5%A4%8D%E5%88%B6%E8%AF%81%E4%B9%A6"><span class="toc-number">1.0.8.1.</span> <span class="toc-text">8.1 复制证书</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#82-kubelet%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.8.2.</span> <span class="toc-text">8.2 Kubelet 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#83-kube-proxy%E9%85%8D%E7%BD%AE"><span class="toc-number">1.0.8.3.</span> <span class="toc-text">8.3 kube-proxy 配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-calico%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">1.0.9.</span> <span class="toc-text">9. Calico 组件的安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-%E5%AE%89%E8%A3%85coredns"><span class="toc-number">1.0.10.</span> <span class="toc-text">10. 安装 CoreDNS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-metrics%E9%83%A8%E7%BD%B2"><span class="toc-number">1.0.11.</span> <span class="toc-text">11. Metrics 部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-dashboard%E9%83%A8%E7%BD%B2"><span class="toc-number">1.0.12.</span> <span class="toc-text">12. Dashboard 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#121-%E5%AE%89%E8%A3%85dashboard"><span class="toc-number">1.0.12.1.</span> <span class="toc-text">12.1 安装 Dashboard</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#122-%E7%99%BB%E5%BD%95dashboard"><span class="toc-number">1.0.12.2.</span> <span class="toc-text">12.2 登录 dashboard</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-containerd%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F"><span class="toc-number">1.0.13.</span> <span class="toc-text">14. Containerd 配置镜像加速</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-docker%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F"><span class="toc-number">1.0.14.</span> <span class="toc-text">15. Docker 配置镜像加速</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/posts/3166738000.html" rel="bookmark" title="Kubeadm高可用安装K8s集群">Kubeadm高可用安装K8s集群</a></li><li><a href="/posts/2771271649.html" rel="bookmark" title="云原生K8s安全专家CKS认证考题详解">云原生K8s安全专家CKS认证考题详解</a></li><li class="active"><a href="/posts/985149017.html" rel="bookmark" title="二进制高可用安装K8S集群">二进制高可用安装K8S集群</a></li><li><a href="/posts/1771242682.html" rel="bookmark" title="K8s零宕机服务发布-探针">K8s零宕机服务发布-探针</a></li><li><a href="/posts/108692210.html" rel="bookmark" title="K8s资源调度deployment、statefulset、daemonset">K8s资源调度deployment、statefulset、daemonset</a></li><li><a href="/posts/858611107.html" rel="bookmark" title="K8s服务发布Service">K8s服务发布Service</a></li><li><a href="/posts/3992668367.html" rel="bookmark" title="K8s配置管理Configmap">K8s配置管理Configmap</a></li><li><a href="/posts/169153047.html" rel="bookmark" title="K8s持久化存储">K8s持久化存储</a></li><li><a href="/posts/3833778957.html" rel="bookmark" title="K8s计划任务Job、Cronjob">K8s计划任务Job、Cronjob</a></li><li><a href="/posts/3142072607.html" rel="bookmark" title="K8s初始化容器、临时容器">K8s初始化容器、临时容器</a></li><li><a href="/posts/3254599477.html" rel="bookmark" title="K8s容忍和污点">K8s容忍和污点</a></li><li><a href="/posts/312010518.html" rel="bookmark" title="K8s亲和力Affinity">K8s亲和力Affinity</a></li><li><a href="/posts/176412055.html" rel="bookmark" title="K8s准入控制ResourceQuota、LimitRange、QoS服务质量">K8s准入控制ResourceQuota、LimitRange、QoS服务质量</a></li><li><a href="/posts/722512536.html" rel="bookmark" title="K8s细粒度权限控制RBAC">K8s细粒度权限控制RBAC</a></li><li><a href="/posts/3890389502.html" rel="bookmark" title="K8S持久化存储NFS+StorageClass">K8S持久化存储NFS+StorageClass</a></li><li><a href="/posts/3030097036.html" rel="bookmark" title="K8S云原生存储Rook-Ceph">K8S云原生存储Rook-Ceph</a></li><li><a href="/posts/170573601.html" rel="bookmark" title="K8s服务发布Ingress">K8s服务发布Ingress</a></li><li><a href="/posts/626047790.html" rel="bookmark" title="消费租赁系统微服务应用交付实践">消费租赁系统微服务应用交付实践</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Xu Yong" src="/assets/avatar.png"><p class="name" itemprop="name">Xu Yong</p><div class="description" itemprop="description">专注于 Linux 运维、云计算、云原⽣等技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">31</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">10</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">10</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/xyapples" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;xyapples"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://gitee.com/chinagei" class="item gitee" title="https:&#x2F;&#x2F;gitee.com&#x2F;chinagei"><i class="ic i-gitee"></i></a><a href="mailto:373370405@qq.com" class="item email" title="mailto:373370405@qq.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-about"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/posts/3071070979.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/posts/2628187572.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/722512536.html">K8s细粒度权限控制RBAC</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/170573601.html">K8s服务发布Ingress</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/1771242682.html">K8s零宕机服务发布-探针</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/858611107.html">K8s服务发布Service</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3833778957.html">K8s计划任务Job、Cronjob</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Rabbitmq/" title="分类于Rabbitmq">Rabbitmq</a></div><span><a href="/posts/1384812626.html">Kubenetes部署Rabbitmq集群</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Redis/" title="分类于Redis">Redis</a></div><span><a href="/posts/1490514396.html">Redis Cluster集群部署</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3166738000.html">Kubeadm高可用安装K8s集群</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/176412055.html">K8s准入控制ResourceQuota、LimitRange、QoS服务质量</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于Linux">Linux</a></div><span><a href="/posts/1922841233.html">Rsync服务实践</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Xu Yong @ LinuxSre云原生</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">610k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">9:14</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `posts/985149017.html`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hrmmi -->