<!-- build time:Sat Nov 08 2025 16:17:07 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico"><link rel="alternate" href="/rss.xml" title="LinuxSre云原生" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="LinuxSre云原生" type="application/atom+xml"><link rel="alternate" type="application/json" title="LinuxSre云原生" href="http://ixuyong.cn/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.17"><link rel="modulepreload" href="/js/chunk-GV364XSK.js"><link rel="modulepreload" href="/js/chunk-NYSE5UKM.js"><link rel="modulepreload" href="/js/chunk-RONCYO2S.js"><link rel="modulepreload" href="/js/chunk-THHXCRSX.js"><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/js/comments-DL2IYMPZ.js"><link rel="modulepreload" href="/js/copy-tex-NADCTXPG.js"><link rel="modulepreload" href="/js/post-DA635IH6.js"><link rel="modulepreload" href="/js/quicklink-WEDHL4BA.js"><link rel="modulepreload" href="/js/search-VCZRKTM5.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/waline-NNBYRQEE.js"><link rel="stylesheet" href="/css/comments-F4ZGS7LD.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/waline-IDNZKML2.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="preload" href="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" as="image" fetchpriority="high"><meta name="keywords" content="Ansible"><meta name="description" content="专注于 Linux 运维、云计算、云原⽣等技术"><link rel="canonical" href="http://ixuyong.cn/posts/4269570224.html"><title>Ansible Variables（三）</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Ansible Variables（三）</h1><div class="meta"><span class="item" title="创建时间：2025-10-30 21:12:34"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-10-30T21:12:34+08:00">2025-10-30</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>21k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>19 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">LinuxSre云原生</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" loading="eager" decoding="async" fetchpriority="high" alt="LinuxSre云原生"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Ansible/" itemprop="item" rel="index" title="分类于Ansible"><span itemprop="name">Ansible<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://ixuyong.cn/posts/4269570224.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"><meta itemprop="name" content="Xu Yong"><meta itemprop="description" content="致力于技术布道、普及前沿技术、打造云原生系列标杆博客, 专注于 Linux 运维、云计算、云原⽣等技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LinuxSre云原生"></span><div class="body md" itemprop="articleBody"><h3 id="ansible-variables"><a class="anchor" href="#ansible-variables">#</a> Ansible Variables</h3><h4 id="1-ansible-variables"><a class="anchor" href="#1-ansible-variables">#</a> 1. Ansible Variables</h4><h5 id="11-什么是变量"><a class="anchor" href="#11-什么是变量">#</a> 1.1 什么是变量</h5><p>变量提供了便捷的方式来管理 ansible 项目中的动态值。 比如 nginx-1.12，可能后期会反复的使用到这个版本的值，那么如果将此值设置为变量，后续使用和修改都将变得非常方便。</p><h5 id="12-变量定义的方式"><a class="anchor" href="#12-变量定义的方式">#</a> 1.2 变量定义的方式</h5><p>在 Ansible 中定义变量分为如下三种方式：</p><ul><li><p>1. 通过命令行传递变量参数定义</p></li><li><p>2. 在 play 文件中进行定义变量</p><ul><li><p>2.1) 通过 vars 定义变量</p></li><li><p>2.2) 通过 vars_files 定义变量</p></li></ul></li><li><p>3. 通过 inventory 在主机组或单个主机中设置变量</p><ul><li><p>3.1) 通过 host_vars 对主机进行定义</p></li><li><p>3.2) 通过 group_vars 对主机组进行定义</p></li></ul></li></ul><p>问题：如果定义的变量出现重复，造成冲突，如何解决？</p><h5 id="13-在playbook中定义变量"><a class="anchor" href="#13-在playbook中定义变量">#</a> 1.3 在 Playbook 中定义变量</h5><h6 id="131-vars方式定义变量"><a class="anchor" href="#131-vars方式定义变量">#</a> 1.3.1 vars 方式定义变量</h6><p>在 playbook 的文件中开头通过 vars 关键字进行变量定义</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat var1.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  vars: </pre></td></tr><tr><td data-num="4"></td><td><pre>    - web_packages: httpd_2</pre></td></tr><tr><td data-num="5"></td><td><pre>    - ftp_packages: vsftpd_2</pre></td></tr><tr><td data-num="6"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="7"></td><td><pre>    - name: Output Vaiables</pre></td></tr><tr><td data-num="8"></td><td><pre>      debug: </pre></td></tr><tr><td data-num="9"></td><td><pre>        msg: </pre></td></tr><tr><td data-num="10"></td><td><pre>          - <span class="token string">""</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          - <span class="token string">""</span></pre></td></tr></table></figure><h6 id="132-vars_files方式定义变量"><a class="anchor" href="#132-vars_files方式定义变量">#</a> 1.3.2 vars_files 方式定义变量</h6><p>在 playbook 中使用 vars_files 指定文件作为变量文件，好处就是其他的 playbook 也可以调用；</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/gL1z1Mx.png" alt="1.png"></p><p>1. 准备一个用于存储变量的文件，后缀为 .yml 文件内容：vars_name: value</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat var.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>ansible_cfg: /etc/ansible/ansible.cfg</pre></td></tr><tr><td data-num="3"></td><td><pre>ansible_exe: /usr/bin/ansible/sbin/ansible</pre></td></tr><tr><td data-num="4"></td><td><pre>ansible_vars: playbook_vars_files</pre></td></tr></table></figure><p>2. 使用 Playbook 调用变量文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat var1.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  vars: </pre></td></tr><tr><td data-num="4"></td><td><pre>    - web_packages: httpd_2</pre></td></tr><tr><td data-num="5"></td><td><pre>    - ftp_packages: vsftpd_2</pre></td></tr><tr><td data-num="6"></td><td><pre>  vars_files: </pre></td></tr><tr><td data-num="7"></td><td><pre>    - ./var.yml</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="10"></td><td><pre>    - name: Output Vaiables</pre></td></tr><tr><td data-num="11"></td><td><pre>      debug: </pre></td></tr><tr><td data-num="12"></td><td><pre>        msg: </pre></td></tr><tr><td data-num="13"></td><td><pre>          - <span class="token string">""</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          - <span class="token string">""</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          - <span class="token string">""</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          - <span class="token string">""</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          - <span class="token string">""</span></pre></td></tr></table></figure><h5 id="14-在inventory中定义变量"><a class="anchor" href="#14-在inventory中定义变量">#</a> 1.4 在 Inventory 中定义变量</h5><h6 id="141-inventory文件中定义变量"><a class="anchor" href="#141-inventory文件中定义变量">#</a> 1.4.1 Inventory 文件中定义变量</h6><p>1. 设定主机变量和组变量</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/hosts</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>webservers<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">192.168</span>.1.7 <span class="token assign-left variable">priority</span><span class="token operator">=</span><span class="token number">100</span> <span class="token assign-left variable">state</span><span class="token operator">=</span>master</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">192.168</span>.1.8 <span class="token assign-left variable">priority</span><span class="token operator">=</span><span class="token number">50</span> <span class="token assign-left variable">state</span><span class="token operator">=</span>backup</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>webservers:vars<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">80</span>  <span class="token comment"># 组变量</span></pre></td></tr></table></figure><p>2.playbook 调用变量</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat var3.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - name: Output Vaiables</pre></td></tr><tr><td data-num="5"></td><td><pre>      debug: </pre></td></tr><tr><td data-num="6"></td><td><pre>        msg: </pre></td></tr><tr><td data-num="7"></td><td><pre>          - <span class="token string">"  "</span></pre></td></tr></table></figure><p>3.playbook 执行结果</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># ansible-playbook var3.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>PLAY <span class="token punctuation">[</span>webservers<span class="token punctuation">]</span> ********************************************************************************************************************</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>TASK <span class="token punctuation">[</span>Gathering Facts<span class="token punctuation">]</span> ***************************************************************************************************************</pre></td></tr><tr><td data-num="6"></td><td><pre>ok: <span class="token punctuation">[</span><span class="token number">192.168</span>.1.7<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>ok: <span class="token punctuation">[</span><span class="token number">192.168</span>.1.8<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>TASK <span class="token punctuation">[</span>Output Vaiables<span class="token punctuation">]</span> ***************************************************************************************************************</pre></td></tr><tr><td data-num="10"></td><td><pre>ok: <span class="token punctuation">[</span><span class="token number">192.168</span>.1.7<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token string">"100 master 80"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>ok: <span class="token punctuation">[</span><span class="token number">192.168</span>.1.8<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token string">"50 backup 80"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>PLAY RECAP ***************************************************************************************************************************</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token number">192.168</span>.1.7                <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>   </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token number">192.168</span>.1.8                <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span></pre></td></tr></table></figure><h6 id="142-使用host_vars定义变量"><a class="anchor" href="#142-使用host_vars定义变量">#</a> 1.4.2 使用 host_vars 定义变量</h6><p>1. 在项目目录中创建 host_vars 目录，然后在创建一个文件，文件的文件名称要与 inventory 清单中的主机名称要保持完全一致，如果是 ip 地址，则创建相同 ip 地址的文件即可。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/hosts </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>webservers<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">192.168</span>.1.7</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">192.168</span>.1.8</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># mkdir host_vars</span></pre></td></tr></table></figure><p>2. 在 host_vars 目录中创建文件，给 192.168.1.7、 192.168.1.8 主机定义变量</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat host_vars/192.168.1.7</span></pre></td></tr><tr><td data-num="2"></td><td><pre>state: MASTER</pre></td></tr><tr><td data-num="3"></td><td><pre>priority: <span class="token number">200</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat host_vars/192.168.1.8</span></pre></td></tr><tr><td data-num="5"></td><td><pre>state: BACKUP</pre></td></tr><tr><td data-num="6"></td><td><pre>priority: <span class="token number">100</span></pre></td></tr></table></figure><p>3. 准备一个 playbook 文件调用 host_vars 目录中定义的主机变量</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat var4.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - name: Copy Keeplaived Configure </pre></td></tr><tr><td data-num="5"></td><td><pre>      template:</pre></td></tr><tr><td data-num="6"></td><td><pre>        src: ./keepalived.conf.j2</pre></td></tr><tr><td data-num="7"></td><td><pre>        dest: /tmp/keepalived.conf</pre></td></tr></table></figure><p>4. 准备 playbook 中配置文件 keepalived.conf.j2</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat keepalived.conf.j2 </span></pre></td></tr><tr><td data-num="2"></td><td><pre>vrrp_instance VI_1 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    state <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼10--<span class="token operator">></span> </pre></td></tr><tr><td data-num="4"></td><td><pre>    interface eth0 eth1             <span class="token comment"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    virtual_router_id <span class="token number">50</span>            <span class="token comment"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    priority <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼11--<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    advert_int <span class="token number">3</span>                    <span class="token comment"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    authentication <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        auth_type PASS              <span class="token comment"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        auth_pass <span class="token number">1111</span>              <span class="token comment"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>5. 执行 playbook 结果</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># ansible-playbook var4.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># web01 执行结果</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@web01 ~<span class="token punctuation">]</span><span class="token comment"># cat /tmp/keepalived.conf </span></pre></td></tr><tr><td data-num="5"></td><td><pre>vrrp_instance VI_1 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    state MASTER </pre></td></tr><tr><td data-num="7"></td><td><pre>    interface eth0 eth1             <span class="token comment"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    virtual_router_id <span class="token number">50</span>            <span class="token comment"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    priority <span class="token number">200</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    advert_int <span class="token number">3</span>                    <span class="token comment"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    authentication <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        auth_type PASS              <span class="token comment"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        auth_pass <span class="token number">1111</span>              <span class="token comment"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># web02 执行结果</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@web02 ~<span class="token punctuation">]</span><span class="token comment"># cat /tmp/keepalived.conf </span></pre></td></tr><tr><td data-num="18"></td><td><pre>vrrp_instance VI_1 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    state BACKUP </pre></td></tr><tr><td data-num="20"></td><td><pre>    interface eth0 eth1             <span class="token comment"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    virtual_router_id <span class="token number">50</span>            <span class="token comment"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    priority <span class="token number">100</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    advert_int <span class="token number">3</span>                    <span class="token comment"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    authentication <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        auth_type PASS              <span class="token comment"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        auth_pass <span class="token number">1111</span>              <span class="token comment"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="143-使用group_vars定义变量"><a class="anchor" href="#143-使用group_vars定义变量">#</a> 1.4.3 使用 group_vars 定义变量</h6><p>1. 在项目目录中创建 group_vars 目录，然后在创建一个文件，文件的文件名称要与 inventory 清单中的组名称保持完全一致；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/hosts </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>webservers<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">192.168</span>.1.7</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">192.168</span>.1.8</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># mkdir group_vars</span></pre></td></tr></table></figure><p>2. 在 group_vars 目录中创建 webservers 文件，为 webservers 主机组设定变量；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat group_vars/webservers </span></pre></td></tr><tr><td data-num="2"></td><td><pre>virtual_router_id: <span class="token number">100</span></pre></td></tr></table></figure><p>3. 编写 playbook，只需在 playbook 文件中使用变量即可；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat var4.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - name: Copy Keeplaived Configure </pre></td></tr><tr><td data-num="5"></td><td><pre>      template:</pre></td></tr><tr><td data-num="6"></td><td><pre>        src: ./keepalived.conf.j2</pre></td></tr><tr><td data-num="7"></td><td><pre>        dest: /tmp/keepalived.conf</pre></td></tr></table></figure><p>4. 准备 playbook 中配置文件 keepalived.conf.j2</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat keepalived.conf.j2 </span></pre></td></tr><tr><td data-num="2"></td><td><pre>vrrp_instance VI_1 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    state <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼12--<span class="token operator">></span> </pre></td></tr><tr><td data-num="4"></td><td><pre>    interface eth0 eth1             <span class="token comment"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    virtual_router_id <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼13--<span class="token operator">></span>            <span class="token comment"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    priority <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼14--<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    advert_int <span class="token number">3</span>                    <span class="token comment"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    authentication <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        auth_type PASS              <span class="token comment"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        auth_pass <span class="token number">1111</span>              <span class="token comment"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>5. 执行 playbook 结果</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># ansible-playbook var4.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># web01 执行结果</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@web01 ~<span class="token punctuation">]</span><span class="token comment"># cat /tmp/keepalived.conf </span></pre></td></tr><tr><td data-num="5"></td><td><pre>vrrp_instance VI_1 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    state MASTER </pre></td></tr><tr><td data-num="7"></td><td><pre>    interface eth0 eth1             <span class="token comment"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    virtual_router_id <span class="token number">100</span>            <span class="token comment"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    priority <span class="token number">200</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    advert_int <span class="token number">3</span>                    <span class="token comment"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    authentication <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        auth_type PASS              <span class="token comment"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        auth_pass <span class="token number">1111</span>              <span class="token comment"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># web02 执行结果</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@web02 ~<span class="token punctuation">]</span><span class="token comment"># cat /tmp/keepalived.conf </span></pre></td></tr><tr><td data-num="18"></td><td><pre>vrrp_instance VI_1 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    state BACKUP </pre></td></tr><tr><td data-num="20"></td><td><pre>    interface eth0 eth1             <span class="token comment"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    virtual_router_id <span class="token number">100</span>            <span class="token comment"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    priority <span class="token number">100</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    advert_int <span class="token number">3</span>                    <span class="token comment"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    authentication <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        auth_type PASS              <span class="token comment"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        auth_pass <span class="token number">1111</span>              <span class="token comment"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>6. 测试其他组能否使用 webservers 组中定义的变量；测试后会发现无法调用；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat var4.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: lbservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - name: Copy Keeplaived Configure </pre></td></tr><tr><td data-num="5"></td><td><pre>      template:</pre></td></tr><tr><td data-num="6"></td><td><pre>        src: ./keepalived.conf.j2</pre></td></tr><tr><td data-num="7"></td><td><pre>        dest: /tmp/keepalived.conf</pre></td></tr></table></figure><p>7. 但是系统提供了特殊的 all 组，也就说在 group_vars 目录下创建一个 all 文件，定义变量对所有的主机组都生效；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 在 group_vars 目录下创建一个 all 文件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat group_vars/all</span></pre></td></tr><tr><td data-num="3"></td><td><pre>web_packages: <span class="token function">wget</span></pre></td></tr><tr><td data-num="4"></td><td><pre>ftp_packages: tree</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#2. 编写 playbook 文件</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat var6.yml </span></pre></td></tr><tr><td data-num="8"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="9"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="10"></td><td><pre>    - name: debug</pre></td></tr><tr><td data-num="11"></td><td><pre>      debug:</pre></td></tr><tr><td data-num="12"></td><td><pre>        msg: <span class="token string">" "</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#3. 执行 playbook</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># ansible-playbook var6.yml</span></pre></td></tr></table></figure><h5 id="15-执行playbook传递变量"><a class="anchor" href="#15-执行playbook传递变量">#</a> 1.5 执行 Playbook 传递变量</h5><p>在执行 Playbook 时，可以通过命令行 --extra-vars 或 -e 外置传参设定变量；</p><p>1. 准备 playbook 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager project<span class="token punctuation">]</span><span class="token comment"># cat var5.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webserver</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - name: Output Vaiables</pre></td></tr><tr><td data-num="5"></td><td><pre>      debug:</pre></td></tr><tr><td data-num="6"></td><td><pre>        msg:</pre></td></tr><tr><td data-num="7"></td><td><pre>          - <span class="token string">""</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          - <span class="token string">""</span></pre></td></tr></table></figure><p>2. 执行 playbook 时进行变量的传递</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># ansible-playbook var5.yml -e "web_packages=GeoIP"</span></pre></td></tr></table></figure><p>3. 传递多个外置变量的方式</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># ansible-playbook var5.yml -e "web_packages=GeoIP"  -e "ftp_packages=ftpIP"</span></pre></td></tr></table></figure><h5 id="16-变量优先级测试"><a class="anchor" href="#16-变量优先级测试">#</a> 1.6 变量优先级测试</h5><p>定义相同的变量不同的值，来测试变量的优先级。操作步骤如下</p><ul><li>1）在 plabook 中定义 vars 变量</li><li>2）在 playbook 中定义 vars_files 变量</li><li>3）在 Inventory_host 中定义变量</li><li>4）在 group_vars 中定义变量</li><li>5）通过执行命令传递变量</li></ul><p><strong>结果: 1️⃣命令行传参 --&gt;2️⃣playbook 中的 vars_files--&gt;3️⃣playbook 中的 vars--&gt;4️⃣ Inventory_host 变量 --&gt;5️⃣group_vars--&gt;6️⃣group_vars/all --&gt;7️⃣ Inventory_group</strong></p><h5 id="17-项目实战将nfs项目改造为变量方式"><a class="anchor" href="#17-项目实战将nfs项目改造为变量方式">#</a> 1.7 项目实战将 NFS 项目改造为变量方式</h5><p>1. 准备 playbook 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat nfs_server_variables.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  vars_files: ./nfs_variables.yml</pre></td></tr><tr><td data-num="4"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    - name: <span class="token number">1</span>.Installed NFS Server</pre></td></tr><tr><td data-num="7"></td><td><pre>      yum:</pre></td></tr><tr><td data-num="8"></td><td><pre>        name: nfs-utils</pre></td></tr><tr><td data-num="9"></td><td><pre>        state: present</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    - name: <span class="token number">2</span>.Configure NFS Server</pre></td></tr><tr><td data-num="12"></td><td><pre>      template:</pre></td></tr><tr><td data-num="13"></td><td><pre>        src: ./exports.j2</pre></td></tr><tr><td data-num="14"></td><td><pre>        dest: /etc/exports</pre></td></tr><tr><td data-num="15"></td><td><pre>      notify: Restart NFS Server</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    - name: <span class="token number">3</span>.Init Group </pre></td></tr><tr><td data-num="18"></td><td><pre>      group:</pre></td></tr><tr><td data-num="19"></td><td><pre>        name: <span class="token string">""</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        gid: <span class="token string">""</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    - name: <span class="token number">4</span>.Init User</pre></td></tr><tr><td data-num="23"></td><td><pre>      user:</pre></td></tr><tr><td data-num="24"></td><td><pre>        name: <span class="token string">""</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        uid: <span class="token string">""</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        group: <span class="token string">""</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        shell: /sbin/nologin</pre></td></tr><tr><td data-num="28"></td><td><pre>        create_home: no</pre></td></tr><tr><td data-num="29"></td><td><pre>        </pre></td></tr><tr><td data-num="30"></td><td><pre>    - name: <span class="token number">5</span>.Init Create Directory</pre></td></tr><tr><td data-num="31"></td><td><pre>      file:</pre></td></tr><tr><td data-num="32"></td><td><pre>        path: <span class="token string">""</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num="34"></td><td><pre>        owner: <span class="token string">""</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        group: <span class="token string">""</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        mode: <span class="token string">"0755"</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    - name: <span class="token number">6</span>.Started NFS Server</pre></td></tr><tr><td data-num="39"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num="40"></td><td><pre>        name: nfs</pre></td></tr><tr><td data-num="41"></td><td><pre>        state: started</pre></td></tr><tr><td data-num="42"></td><td><pre>        enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num="45"></td><td><pre>    - name: Restart NFS Server</pre></td></tr><tr><td data-num="46"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num="47"></td><td><pre>        name: nfs</pre></td></tr><tr><td data-num="48"></td><td><pre>        state: restarted</pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>- hosts: localhost</pre></td></tr><tr><td data-num="51"></td><td><pre>  vars_files: ./nfs_variables.yml</pre></td></tr><tr><td data-num="52"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="53"></td><td><pre>    - name: Mount </pre></td></tr><tr><td data-num="54"></td><td><pre>      mount:</pre></td></tr><tr><td data-num="55"></td><td><pre>        src: <span class="token string">":"</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        path: /mnt</pre></td></tr><tr><td data-num="57"></td><td><pre>        fstype: nfs</pre></td></tr><tr><td data-num="58"></td><td><pre>        opts: defaults</pre></td></tr><tr><td data-num="59"></td><td><pre>        state: mounted</pre></td></tr></table></figure><p>2. 准备 NFS 配置文件 exports.j2</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat exports.j2 </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼29--<span class="token operator">></span> <span class="token number">172.16</span>.1.0/24<span class="token punctuation">(</span>rw,all_squash,anonuid<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼30--<span class="token operator">></span>,anongid<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼31--<span class="token operator">></span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>3. 准备 playbook 变量文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat nfs_variables.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>nfs_share_data: /data</pre></td></tr><tr><td data-num="3"></td><td><pre>nfs_uid: <span class="token number">666</span></pre></td></tr><tr><td data-num="4"></td><td><pre>nfs_gid: <span class="token number">666</span></pre></td></tr><tr><td data-num="5"></td><td><pre>nfs_user: www</pre></td></tr><tr><td data-num="6"></td><td><pre>nfs_group: www</pre></td></tr><tr><td data-num="7"></td><td><pre>nfs_server: <span class="token number">172.16</span>.1.7</pre></td></tr></table></figure><p>4. 执行 playbook 并测试</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># ansible-playbook nfs_server_variables.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># df -h |grep mnt</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">172.16</span>.1.7:/data   17G   11G  <span class="token number">6</span>.5G  <span class="token number">62</span>% /mnt</pre></td></tr></table></figure><h4 id="2ansible-register"><a class="anchor" href="#2ansible-register">#</a> 2.Ansible Register</h4><h5 id="21-什么是register"><a class="anchor" href="#21-什么是register">#</a> 2.1 什么是 Register</h5><p>register 可以将 task 执行的任务结果存储至某个变量中，便于后续的引用；</p><h5 id="22-register场景示例1"><a class="anchor" href="#22-register场景示例1">#</a> 2.2 Register 场景示例 1</h5><p>需求：使用 Register 获取被控节点的端口信息</p><p>1. 准备 playbook 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat register_1.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    - name: Get Network Port </pre></td></tr><tr><td data-num="6"></td><td><pre>      shell: <span class="token function">netstat</span> <span class="token parameter variable">-lntp</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      register: System_Port</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    - name: debug </pre></td></tr><tr><td data-num="10"></td><td><pre>      debug:</pre></td></tr><tr><td data-num="11"></td><td><pre>        msg: </pre></td></tr><tr><td data-num="12"></td><td><pre>          - <span class="token string">"执行了  命令"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          - <span class="token string">""</span></pre></td></tr></table></figure><p>2.playbook 执行结果</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># ansible-playbook register_1.yml</span></pre></td></tr></table></figure><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/nQsUrXx.jpeg" alt="1.jpg"></p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/RDAWJub.jpeg" alt="2.jpg"></p><h5 id="23-register场景示例2"><a class="anchor" href="#23-register场景示例2">#</a> 2.3 Register 场景示例 2</h5><p>需求：批量修改 200 台主机名称</p><p>1. 准备 playbook 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat register_2.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - name: String</pre></td></tr><tr><td data-num="5"></td><td><pre>      shell: <span class="token builtin class-name">echo</span> <span class="token environment constant">$RANDOM</span> <span class="token operator">|</span>md5sum <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-c</span> <span class="token number">2</span>-10</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#      shell: echo $((RANDOM%200))</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      register: systemd_sj</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    - name: debug</pre></td></tr><tr><td data-num="10"></td><td><pre>      debug:</pre></td></tr><tr><td data-num="11"></td><td><pre>        msg: <span class="token string">""</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    - name: Chanage Hostname</pre></td></tr><tr><td data-num="14"></td><td><pre>      hostname:</pre></td></tr><tr><td data-num="15"></td><td><pre>        name: <span class="token string">"web_"</span></pre></td></tr></table></figure><p>2. 执行 playbook 并测试</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># ansible-playbook register_2.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@web01 ~<span class="token punctuation">]</span><span class="token comment"># hostnamectl</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   Static hostname: web_8ccbbb7ce</pre></td></tr><tr><td data-num="4"></td><td><pre>         Icon name: computer-vm</pre></td></tr><tr><td data-num="5"></td><td><pre>           Chassis: vm</pre></td></tr><tr><td data-num="6"></td><td><pre>        Machine ID: bd353f63eda44afab936db8ef2974eb1</pre></td></tr><tr><td data-num="7"></td><td><pre>           Boot ID: 63559abc84684641ac245ad94e9c8e55</pre></td></tr><tr><td data-num="8"></td><td><pre>    Virtualization: vmware</pre></td></tr><tr><td data-num="9"></td><td><pre>  Operating System: CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>       CPE OS Name: cpe:/o:centos:centos:7</pre></td></tr><tr><td data-num="11"></td><td><pre>            Kernel: Linux <span class="token number">3.10</span>.0-957.el7.x86_64</pre></td></tr><tr><td data-num="12"></td><td><pre>      Architecture: x86-64</pre></td></tr></table></figure><p>2.4 Register 场景示例 3</p><p>需求：使用 register 关键字完成 jumpserver key 的创建</p><p>1. 准备 playbook 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@web01 ~<span class="token punctuation">]</span><span class="token comment"># cat register_3.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - name: BOOTSTRAP_TOKEN</pre></td></tr><tr><td data-num="5"></td><td><pre>      shell: <span class="token string">'if grep "BOOTSTRAP_TOKEN" ~/.bashrc ;then</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                echo $BOOTSTRAP_TOKEN;</pre></td></tr><tr><td data-num="7"></td><td><pre>             else</pre></td></tr><tr><td data-num="8"></td><td><pre>                BOOTSTRAP_TOKEN=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 24`;   </pre></td></tr><tr><td data-num="9"></td><td><pre>                echo "BOOTSTRAP_TOKEN=$BOOTSTRAP_TOKEN" >> ~/.bashrc;   </pre></td></tr><tr><td data-num="10"></td><td><pre>                echo "BOOTSTRAP_TOKEN=$BOOTSTRAP_TOKEN";</pre></td></tr><tr><td data-num="11"></td><td><pre>             fi'</pre></td></tr><tr><td data-num="12"></td><td><pre>      register: JMS_BOOTSTRAP_TOKEN</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    - name: SECRET_KEY</pre></td></tr><tr><td data-num="15"></td><td><pre>      shell: <span class="token string">'if grep "SECRET_KEY" ~/.bashrc ;then </span></pre></td></tr><tr><td data-num="16"></td><td><pre>                echo $SECRET_KEY;</pre></td></tr><tr><td data-num="17"></td><td><pre>             else</pre></td></tr><tr><td data-num="18"></td><td><pre>                SECRET_KEY=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 50`;</pre></td></tr><tr><td data-num="19"></td><td><pre>                echo "SECRET_KEY=$SECRET_KEY" >> ~/.bashrc;   </pre></td></tr><tr><td data-num="20"></td><td><pre>                echo "SECRET_KEY=$SECRET_KEY";</pre></td></tr><tr><td data-num="21"></td><td><pre>             fi'</pre></td></tr><tr><td data-num="22"></td><td><pre>      register: JMS_SECRET_KEY</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    - name: Copy JMS Config.yml</pre></td></tr><tr><td data-num="25"></td><td><pre>      template:</pre></td></tr><tr><td data-num="26"></td><td><pre>        src: ./jms.yml</pre></td></tr><tr><td data-num="27"></td><td><pre>        dest: /tmp/jms.yml</pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    - name: Copy KoKo Config.yml</pre></td></tr><tr><td data-num="30"></td><td><pre>      template:</pre></td></tr><tr><td data-num="31"></td><td><pre>        src: ./koko.yml</pre></td></tr><tr><td data-num="32"></td><td><pre>        dest: /tmp/koko.yml</pre></td></tr></table></figure><p>2. 准备 playbook 文件配置文件 jms.yml 、koko.yml</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 模拟 jms 配置文件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat jms.yml </span></pre></td></tr><tr><td data-num="3"></td><td><pre>SECRET_KEY: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼36--<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>BOOTSTRAP_TOKEN: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼37--<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#2. 模拟 koko 配置文件</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat koko.yml </span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># Jumpserver 项目的 url, api 请求注册会使用</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># CORE_HOST: http://127.0.0.1:8080</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>BOOTSTRAP_TOKEN: <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼38--<span class="token operator">></span></pre></td></tr></table></figure><p>3. 执行 playbook 并测试</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 执行 playbook</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># ansible-playbook register_3.yml </span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#2. 验证测试</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@web01 ~<span class="token punctuation">]</span><span class="token comment"># cat /tmp/jms.yml </span></pre></td></tr><tr><td data-num="6"></td><td><pre>SECRET_KEY: tuw13bJFHddReo33qHE36xm9dqp8WNlsoScrCyaIiD894kjhIu</pre></td></tr><tr><td data-num="7"></td><td><pre>BOOTSTRAP_TOKEN: pmEcXW2q7KwVOPUkcbAXoDdu</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@web01 ~<span class="token punctuation">]</span><span class="token comment"># cat /tmp/koko.yml </span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># Jumpserver 项目的 url, api 请求注册会使用</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># CORE_HOST: http://127.0.0.1:8080</span></pre></td></tr><tr><td data-num="12"></td><td><pre>BOOTSTRAP_TOKEN: pmEcXW2q7KwVOPUkcbAXoDdu</pre></td></tr></table></figure><h4 id="3-ansible-facts-variables"><a class="anchor" href="#3-ansible-facts-variables">#</a> 3. Ansible Facts Variables</h4><h5 id="31-什么是facts"><a class="anchor" href="#31-什么是facts">#</a> 3.1 什么是 facts</h5><p>Ansible facts 变量主要用来自动采集，” 被控端主机 “自身的状态信息。</p><p>比如：被动端的，主机名、IP 地址、系统版本、CPU 数量、内存状态、磁盘状态等。</p><h5 id="32-facts使用场景"><a class="anchor" href="#32-facts使用场景">#</a> 3.2 facts 使用场景</h5><p>1. 通过 facts 变量检查被控端硬件 CPU 信息，从而生成不同的 Nginx 配置文件。</p><p>2. 通过 facts 变量检查被控端内存状态信息，从而生成不同的 memcached 的配置文件。</p><p>3. 通过 facts 变量检查被控端主机名称信息，从而生成不同的 Zabbix 配置文件。</p><p>4. 通过 facts 变量检查被控端主机 IP 地址信息，从而生成不同的 redis 配置文件。</p><p>5. 通过 facts 变量........</p><h5 id="33-facts语法示例"><a class="anchor" href="#33-facts语法示例">#</a> 3.3 facts 语法示例</h5><p>1. 查看所有 facts 变量</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># ansible localhost -m setup</span></pre></td></tr></table></figure><p>2. 通过 facts 获取被控端的主机名与 IP 地址，然后通过 debug 输出</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat facts_1.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">#gather_facts: no</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    - name: Print IP</pre></td></tr><tr><td data-num="7"></td><td><pre>      debug:</pre></td></tr><tr><td data-num="8"></td><td><pre>        msg: <span class="token string">"  "</span></pre></td></tr></table></figure><p>3. 获取 facts 变量，可以使用 filter 过滤特定的关键项</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># ansible localhost -m setup -a "filter="ansible_fqdn""</span></pre></td></tr><tr><td data-num="2"></td><td><pre>localhost <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"ansible_fqdn"</span><span class="token builtin class-name">:</span> <span class="token string">"manager"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span>, </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>4. 如果没有使用 facts 变量需求，可以关闭其功能，加速 ansible 执行性能；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat facts_1.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  gather_facts: no</pre></td></tr><tr><td data-num="4"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    - name: Print IP</pre></td></tr><tr><td data-num="7"></td><td><pre>      debug:</pre></td></tr><tr><td data-num="8"></td><td><pre>        msg: <span class="token string">"  "</span></pre></td></tr></table></figure><h5 id="34-案例1-根据主机ip地址生成redis配置"><a class="anchor" href="#34-案例1-根据主机ip地址生成redis配置">#</a> 3.4 案例 1 - 根据主机 IP 地址生成 Redis 配置</h5><p>1. 编写安装配置 redis 服务的 playbook 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat facts_redis.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - name: Installed Redis Server</pre></td></tr><tr><td data-num="5"></td><td><pre>      yum:</pre></td></tr><tr><td data-num="6"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num="7"></td><td><pre>        state: present</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    - name: Configure Redis Server</pre></td></tr><tr><td data-num="10"></td><td><pre>      template:</pre></td></tr><tr><td data-num="11"></td><td><pre>        src: ./redis.conf.j2</pre></td></tr><tr><td data-num="12"></td><td><pre>        dest: /etc/redis.conf</pre></td></tr><tr><td data-num="13"></td><td><pre>      notify: Restart Redis Server</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    - name: Started Redis Server</pre></td></tr><tr><td data-num="16"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num="17"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num="18"></td><td><pre>        state: started</pre></td></tr><tr><td data-num="19"></td><td><pre>        enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num="22"></td><td><pre>    - name: Restart Redis Server</pre></td></tr><tr><td data-num="23"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num="24"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num="25"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 redis.conf.j2 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager web_cluster<span class="token punctuation">]</span><span class="token comment"># cp /etc/redis.conf /root/web_cluster/files/redis.conf.j2</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@manager files<span class="token punctuation">]</span><span class="token comment"># sed -i "/^bind 127.0.0.1/c bind 127.0.0.1 " redis.conf.j2</span></pre></td></tr></table></figure><p>3. 验证测试</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@web01 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 6379</span></pre></td></tr><tr><td data-num="2"></td><td><pre>tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.1.7:6379        <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">15391</span>/redis-server  </pre></td></tr><tr><td data-num="3"></td><td><pre>tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:6379          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">15391</span>/redis-server</pre></td></tr></table></figure><h5 id="35-案例2-根据主机cpu生成nginx配置"><a class="anchor" href="#35-案例2-根据主机cpu生成nginx配置">#</a> 3.5 案例 2 - 根据主机 CPU 生成 Nginx 配置</h5><p>1. 编写安装配置 Nginx 服务的 playbook 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat facts_nginx.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    - name: Installed Nginx Server</pre></td></tr><tr><td data-num="6"></td><td><pre>      yum:</pre></td></tr><tr><td data-num="7"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num="8"></td><td><pre>        state: present</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    - name: Configure Nginx nginx.conf</pre></td></tr><tr><td data-num="11"></td><td><pre>      template:</pre></td></tr><tr><td data-num="12"></td><td><pre>        src: ./nginx.conf.j2</pre></td></tr><tr><td data-num="13"></td><td><pre>        dest: /etc/nginx/nginx.conf</pre></td></tr><tr><td data-num="14"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num="15"></td><td><pre>        group: root</pre></td></tr><tr><td data-num="16"></td><td><pre>        mode: 0644</pre></td></tr><tr><td data-num="17"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    - name: Started Nginx Server</pre></td></tr><tr><td data-num="20"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num="21"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num="22"></td><td><pre>        state: started</pre></td></tr><tr><td data-num="23"></td><td><pre>        enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num="27"></td><td><pre>    - name: Restart Nginx Server</pre></td></tr><tr><td data-num="28"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num="29"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num="30"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 nginx.conf.j2 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># cat nginx.conf.j2 </span></pre></td></tr><tr><td data-num="2"></td><td><pre>user www<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>worker_processes  <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼46--<span class="token operator">></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>error_log  /var/log/nginx/error.log notice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>pid        /var/run/nginx.pid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>events <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>http <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    include       /etc/nginx/mime.types<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    default_type  application/octet-stream<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    log_format  main  <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                      <span class="token string">'$status $body_bytes_sent "$http_referer" '</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                      <span class="token string">'"$http_user_agent" "$http_x_forwarded_for" "$http_x_via"'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    sendfile        on<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>3. 验证测试</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager ~<span class="token punctuation">]</span><span class="token comment"># ansible-playbook facts_nginx.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@web01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/nginx/nginx.conf  | grep worker_processes</span></pre></td></tr><tr><td data-num="3"></td><td><pre>worker_processes  <span class="token number">8</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h5 id="36-案例3-根据主机内存生成memcached配置"><a class="anchor" href="#36-案例3-根据主机内存生成memcached配置">#</a> 3.6 案例 3 - 根据主机内存生成 Memcached 配置</h5><p>1. 编写安装配置 memcached 服务的 playbook 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat facts_memcached.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num="3"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - name: Installed Memcached</pre></td></tr><tr><td data-num="5"></td><td><pre>      yum:</pre></td></tr><tr><td data-num="6"></td><td><pre>        name: memcached</pre></td></tr><tr><td data-num="7"></td><td><pre>        state: present</pre></td></tr><tr><td data-num="8"></td><td><pre>    - name: Configre Memcached</pre></td></tr><tr><td data-num="9"></td><td><pre>      template:</pre></td></tr><tr><td data-num="10"></td><td><pre>        src: ./memcached.j2</pre></td></tr><tr><td data-num="11"></td><td><pre>        dest:  /etc/sysconfig/memcached</pre></td></tr><tr><td data-num="12"></td><td><pre>      notify: Restart Memcache Server</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    - name: Started Memcached</pre></td></tr><tr><td data-num="15"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num="16"></td><td><pre>        name: memcached</pre></td></tr><tr><td data-num="17"></td><td><pre>        state: started</pre></td></tr><tr><td data-num="18"></td><td><pre>  </pre></td></tr><tr><td data-num="19"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num="20"></td><td><pre>    - name: Restart Memcache Server</pre></td></tr><tr><td data-num="21"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num="22"></td><td><pre>        name: memcached</pre></td></tr><tr><td data-num="23"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 memcached.j2 文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat memcached.j2 </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token string">"11211"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token string">"memcached"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">MAXCONN</span><span class="token operator">=</span><span class="token string">"1024"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">CACHESIZE</span><span class="token operator">=</span><span class="token string">"NaN"</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token assign-left variable">OPTIONS</span><span class="token operator">=</span><span class="token string">""</span></pre></td></tr></table></figure><p>3. 验证测试</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># ansible-playbook facts_memcached.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@web_8ccbbb7ce ~<span class="token punctuation">]</span><span class="token comment"># free -m</span></pre></td></tr><tr><td data-num="3"></td><td><pre>              total        used        <span class="token function">free</span>      shared  buff/cache   available</pre></td></tr><tr><td data-num="4"></td><td><pre>Mem:           <span class="token number">1819</span>         <span class="token number">351</span>        <span class="token number">1029</span>          <span class="token number">27</span>         <span class="token number">439</span>        <span class="token number">1300</span></pre></td></tr><tr><td data-num="5"></td><td><pre>Swap:          <span class="token number">2047</span>           <span class="token number">0</span>        <span class="token number">2047</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@web_8ccbbb7ce ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/sysconfig/memcached </span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token string">"11211"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token string">"memcached"</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token assign-left variable">MAXCONN</span><span class="token operator">=</span><span class="token string">"1024"</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token assign-left variable">CACHESIZE</span><span class="token operator">=</span><span class="token string">"909.5"</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token assign-left variable">OPTIONS</span><span class="token operator">=</span><span class="token string">""</span></pre></td></tr></table></figure><h5 id="37-案例6-使用facts批量修改主机名"><a class="anchor" href="#37-案例6-使用facts批量修改主机名">#</a> 3.7 案例 6 - 使用 facts 批量修改主机名</h5><pre><code>[root@manager var]# cat facts_hostname.yml 
- hosts: webservers
  tasks:
    - name: Print IP
      debug:
        # 获取facts变量，然后提取IP地址，以.结尾的最后一列
        msg: &quot;&#123;&#123; ansible_eth0.ipv4.address.split('.')[-1] &#125;&#125;&quot;

    - name: Change Hostname
      hostname:
        name: web_&#123;&#123; ansible_eth0.ipv4.address.split('.')[-1] &#125;&#125;
</code></pre><h5 id="38-facts变量性能优化"><a class="anchor" href="#38-facts变量性能优化">#</a> 3.8 facts 变量性能优化</h5><h6 id="381-关闭facts采集加速执行-方式1"><a class="anchor" href="#381-关闭facts采集加速执行-方式1">#</a> 3.8.1 关闭 facts 采集加速执行 - 方式 1</h6><p>1. 编写 TASK 任务 sleep10 秒，针对 15 台机器同时执行，需要消耗的时间大概是 1m56.980s</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat facts_sleep.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: all</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">#gather_facts: no </span></pre></td></tr><tr><td data-num="4"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="5"></td><td><pre>    - name: <span class="token function">sleep</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      command: <span class="token function">sleep</span> <span class="token number">10</span></pre></td></tr></table></figure><p>2. 使用 gather_facts: no 关闭 facts 信息采集，发现仅花费了 0m38.164s ，整个速度提升了 3 倍；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat facts_sleep.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: all</pre></td></tr><tr><td data-num="3"></td><td><pre>  gather_facts: no </pre></td></tr><tr><td data-num="4"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="5"></td><td><pre>    - name: <span class="token function">sleep</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      command: <span class="token function">sleep</span> <span class="token number">10</span></pre></td></tr></table></figure><h6 id="382-缓存facts变量加速执行-方式2"><a class="anchor" href="#382-缓存facts变量加速执行-方式2">#</a> 3.8.2 缓存 facts 变量加速执行 - 方式 2</h6><p>1. 当我们使用 gather_facts: no 关闭 facts，确实能加速 Ansible 执行，但是有时候又需要使用 facts 中的内容，还希望执行的速度快一点，这时候可以设置 facts 的缓存；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># yum install python-pip -y</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># pip install redis</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@m01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/ansible.cfg</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>defaults<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># smart 表示默认收集 facts，但 facts 已有的情况下不会收集，即使用缓存 facts</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># implicit 表示默认收集 facts，要禁止收集，必须使用 gather_facts: False；</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># explicit 则表示默认不收集，要显式收集，必须使用 gather_facts: Ture。</span></pre></td></tr><tr><td data-num="9"></td><td><pre>gathering <span class="token operator">=</span> smart <span class="token comment">#在使用 facts 缓存时设置为 smart</span></pre></td></tr><tr><td data-num="10"></td><td><pre>fact_caching_timeout <span class="token operator">=</span> <span class="token number">86400</span></pre></td></tr><tr><td data-num="11"></td><td><pre>fact_caching <span class="token operator">=</span> redis</pre></td></tr><tr><td data-num="12"></td><td><pre>fact_caching_connection <span class="token operator">=</span> <span class="token number">172.16</span>.1.41:6379</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 若 redis 设置了密码，1 表示 redis1 号库</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># fact_caching_connection = 172.16.1.41:6379:1:passwd</span></pre></td></tr></table></figure><p>2. 编写 Playbook 测试；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@manager var<span class="token punctuation">]</span><span class="token comment"># cat facts_sleep.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>- hosts: all</pre></td></tr><tr><td data-num="3"></td><td><pre>  gather_facts: no </pre></td></tr><tr><td data-num="4"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num="5"></td><td><pre>    - name: <span class="token function">sleep</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      command: <span class="token function">sleep</span> <span class="token number">10</span></pre></td></tr></table></figure><p>3. 测试结果如下：</p><ul><li>执行第一次花费了 1m49.881s 因为第一次需要将 facts 信息缓存至 Redis</li><li>执行第二次花费了 0m38.130s 可以看出使用 Redis 缓存 facts 变量，整体执行时间提高了 3 倍</li></ul><div class="tags"><a href="/tags/Ansible/" rel="tag"><i class="ic i-tag"></i>Ansible</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/posts/4269570224.html">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2025-11-01 20:03:27" itemprop="dateModified" datetime="2025-11-01T20:03:27+08:00">2025-11-01</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Xu Yong 微信支付"><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Xu Yong 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Xu Yong<i class="ic i-at"><em>@</em></i>LinuxSre云原生</li><li class="link"><strong>本文链接：</strong><a href="http://ixuyong.cn/posts/4269570224.html" title="Ansible Variables（三）">http://ixuyong.cn/posts/4269570224.html</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/posts/2304648507.html" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;qKWtVEE.jpeg" title="Ansible Playbook入门（二）"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Ansible</span><h3>Ansible Playbook入门（二）</h3></a></div><div class="item right"><a href="/posts/3091159370.html" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;kZVoVpj.jpeg" title="Ansible Task Control（四）"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>Ansible</span><h3>Ansible Task Control（四）</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-variables"><span class="toc-number">1.</span> <span class="toc-text">Ansible Variables</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-ansible-variables"><span class="toc-number">1.1.</span> <span class="toc-text">1. Ansible Variables</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 什么是变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 变量定义的方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#13-%E5%9C%A8playbook%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 在 Playbook 中定义变量</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#131-vars%E6%96%B9%E5%BC%8F%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">1.3.1 vars 方式定义变量</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#132-vars_files%E6%96%B9%E5%BC%8F%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">1.3.2 vars_files 方式定义变量</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#14-%E5%9C%A8inventory%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 在 Inventory 中定义变量</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#141-inventory%E6%96%87%E4%BB%B6%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">1.4.1 Inventory 文件中定义变量</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#142-%E4%BD%BF%E7%94%A8host_vars%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">1.4.2 使用 host_vars 定义变量</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#143-%E4%BD%BF%E7%94%A8group_vars%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">1.4.3 使用 group_vars 定义变量</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#15-%E6%89%A7%E8%A1%8Cplaybook%E4%BC%A0%E9%80%92%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5 执行 Playbook 传递变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-%E5%8F%98%E9%87%8F%E4%BC%98%E5%85%88%E7%BA%A7%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.6.</span> <span class="toc-text">1.6 变量优先级测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#17-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E5%B0%86nfs%E9%A1%B9%E7%9B%AE%E6%94%B9%E9%80%A0%E4%B8%BA%E5%8F%98%E9%87%8F%E6%96%B9%E5%BC%8F"><span class="toc-number">1.1.7.</span> <span class="toc-text">1.7 项目实战将 NFS 项目改造为变量方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2ansible-register"><span class="toc-number">1.2.</span> <span class="toc-text">2.Ansible Register</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-%E4%BB%80%E4%B9%88%E6%98%AFregister"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 什么是 Register</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-register%E5%9C%BA%E6%99%AF%E7%A4%BA%E4%BE%8B1"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 Register 场景示例 1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23-register%E5%9C%BA%E6%99%AF%E7%A4%BA%E4%BE%8B2"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 Register 场景示例 2</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-ansible-facts-variables"><span class="toc-number">1.3.</span> <span class="toc-text">3. Ansible Facts Variables</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#31-%E4%BB%80%E4%B9%88%E6%98%AFfacts"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 什么是 facts</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#32-facts%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 facts 使用场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#33-facts%E8%AF%AD%E6%B3%95%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 facts 语法示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#34-%E6%A1%88%E4%BE%8B1-%E6%A0%B9%E6%8D%AE%E4%B8%BB%E6%9C%BAip%E5%9C%B0%E5%9D%80%E7%94%9F%E6%88%90redis%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 案例 1 - 根据主机 IP 地址生成 Redis 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#35-%E6%A1%88%E4%BE%8B2-%E6%A0%B9%E6%8D%AE%E4%B8%BB%E6%9C%BAcpu%E7%94%9F%E6%88%90nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.5.</span> <span class="toc-text">3.5 案例 2 - 根据主机 CPU 生成 Nginx 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#36-%E6%A1%88%E4%BE%8B3-%E6%A0%B9%E6%8D%AE%E4%B8%BB%E6%9C%BA%E5%86%85%E5%AD%98%E7%94%9F%E6%88%90memcached%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.6.</span> <span class="toc-text">3.6 案例 3 - 根据主机内存生成 Memcached 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#37-%E6%A1%88%E4%BE%8B6-%E4%BD%BF%E7%94%A8facts%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-number">1.3.7.</span> <span class="toc-text">3.7 案例 6 - 使用 facts 批量修改主机名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#38-facts%E5%8F%98%E9%87%8F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.3.8.</span> <span class="toc-text">3.8 facts 变量性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#381-%E5%85%B3%E9%97%ADfacts%E9%87%87%E9%9B%86%E5%8A%A0%E9%80%9F%E6%89%A7%E8%A1%8C-%E6%96%B9%E5%BC%8F1"><span class="toc-number">1.3.8.1.</span> <span class="toc-text">3.8.1 关闭 facts 采集加速执行 - 方式 1</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#382-%E7%BC%93%E5%AD%98facts%E5%8F%98%E9%87%8F%E5%8A%A0%E9%80%9F%E6%89%A7%E8%A1%8C-%E6%96%B9%E5%BC%8F2"><span class="toc-number">1.3.8.2.</span> <span class="toc-text">3.8.2 缓存 facts 变量加速执行 - 方式 2</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/posts/2794181051.html" rel="bookmark" title="Ansible快速入门（一）">Ansible快速入门（一）</a></li><li><a href="/posts/2304648507.html" rel="bookmark" title="Ansible Playbook入门（二）">Ansible Playbook入门（二）</a></li><li class="active"><a href="/posts/4269570224.html" rel="bookmark" title="Ansible Variables（三）">Ansible Variables（三）</a></li><li><a href="/posts/3091159370.html" rel="bookmark" title="Ansible Task Control（四）">Ansible Task Control（四）</a></li><li><a href="/posts/3345873995.html" rel="bookmark" title="Ansible delegate Jinja2 Roles（五）">Ansible delegate Jinja2 Roles（五）</a></li><li><a href="/posts/2316355427.html" rel="bookmark" title="Ansible项目实战（六）">Ansible项目实战（六）</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Xu Yong" src="/assets/avatar.png"><p class="name" itemprop="name">Xu Yong</p><div class="description" itemprop="description">专注于 Linux 运维、云计算、云原⽣等技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">80</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">19</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">22</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/xyapples" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;xyapples"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://gitee.com/chinagei" class="item gitee" title="https:&#x2F;&#x2F;gitee.com&#x2F;chinagei"><i class="ic i-gitee"></i></a><a href="mailto:373370405@qq.com" class="item email" title="mailto:373370405@qq.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-about"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/posts/3091159370.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/posts/2304648507.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Nginx/" title="分类于Nginx">Nginx</a></div><span><a href="/posts/2170503498.html">Nginx高可用-Keepalived（十三）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Docker/" title="分类于Docker">Docker</a></div><span><a href="/posts/3364424907.html">阿里云+Github构建镜像仓库</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Prometheus/" title="分类于Prometheus">Prometheus</a></div><span><a href="/posts/3386060324.html">PromQL快速入门（二）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Prometheus/" title="分类于Prometheus">Prometheus</a></div><span><a href="/posts/4081185381.html">Prometheus监控实战（三）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/DevOps/" title="分类于DevOps">DevOps</a></div><span><a href="/posts/2330853882.html">K8S基于Jenkins实现微服务应用CICD实践（四）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/LVS/" title="分类于LVS">LVS</a></div><span><a href="/posts/1598774589.html">企业级负载均衡LVS场景实战（二）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Ansible/" title="分类于Ansible">Ansible</a></div><span><a href="/posts/2316355427.html">Ansible项目实战（六）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ELKStack/" title="分类于ELKStack">ELKStack</a></div><span><a href="/posts/170066797.html">消费租赁项目Kubernetes基于ELK日志分析与实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="分类于Linux">Linux</a></div><span><a href="/posts/2889248111.html">Vsftp服务实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Shell/" title="分类于Shell">Shell</a></div><span><a href="/posts/2633625892.html">Shell文本处理工具awk</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Xu Yong @ LinuxSre云原生</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">2.1m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">31:54</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `posts/4269570224.html`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hrmmi -->