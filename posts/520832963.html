<!-- build time:Sun Dec 28 2025 19:35:54 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico"><link rel="alternate" href="/rss.xml" title="LinuxSre云原生" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="LinuxSre云原生" type="application/atom+xml"><link rel="alternate" type="application/json" title="LinuxSre云原生" href="http://ixuyong.cn/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.17"><link rel="modulepreload" href="/js/chunk-GV364XSK.js"><link rel="modulepreload" href="/js/chunk-NYSE5UKM.js"><link rel="modulepreload" href="/js/chunk-RONCYO2S.js"><link rel="modulepreload" href="/js/chunk-THHXCRSX.js"><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/js/comments-DL2IYMPZ.js"><link rel="modulepreload" href="/js/copy-tex-NADCTXPG.js"><link rel="modulepreload" href="/js/post-DA635IH6.js"><link rel="modulepreload" href="/js/quicklink-WEDHL4BA.js"><link rel="modulepreload" href="/js/search-VCZRKTM5.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/waline-NNBYRQEE.js"><link rel="stylesheet" href="/css/comments-F4ZGS7LD.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/waline-IDNZKML2.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="preload" href="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" as="image" fetchpriority="high"><meta name="keywords" content="DevOps"><meta name="description" content="专注于 Linux 运维、云计算、云原⽣等技术"><link rel="canonical" href="http://ixuyong.cn/posts/520832963.html"><title>Docker应用的CICD（九）</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Docker应用的CICD（九）</h1><div class="meta"><span class="item" title="创建时间：2025-11-30 19:36:32"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-11-30T19:36:32+08:00">2025-11-30</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>25k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>23 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">LinuxSre云原生</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" loading="eager" decoding="async" fetchpriority="high" alt="LinuxSre云原生"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/DevOps/" itemprop="item" rel="index" title="分类于DevOps"><span itemprop="name">DevOps<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://ixuyong.cn/posts/520832963.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"><meta itemprop="name" content="Xu Yong"><meta itemprop="description" content="致力于技术布道、普及前沿技术、打造云原生系列标杆博客, 专注于 Linux 运维、云计算、云原⽣等技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LinuxSre云原生"></span><div class="body md" itemprop="articleBody"><h3 id="09-docker应用的cicd"><a class="anchor" href="#09-docker应用的cicd">#</a> 09 Docker 应⽤的 CICD</h3><h4 id="1-cicd实现方式"><a class="anchor" href="#1-cicd实现方式">#</a> 1. CI/CD 实现⽅式</h4><h5 id="11-传统环境的cicd"><a class="anchor" href="#11-传统环境的cicd">#</a> 1.1 传统环境的 CI/CD</h5><p>CI：开发⼈员 -&gt; 提交代码 -&gt;Gitlab 仓库 -&gt;Jenkins/CI 抓取代码 -&gt; 漏洞扫描 -&gt; 编译 --&gt; 推送 nexus 仓库 --&gt; 部署⾄测试环境；</p><p>CD：jenkins 拉取 Nexus 仓库代码 --&gt; 部署⽣产环境；</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/QOZ1TRn.jpeg" alt="1.jpg"></p><h5 id="12-docker实现cicd"><a class="anchor" href="#12-docker实现cicd">#</a> 1.2 Docker 实现 CI/CD</h5><p>CI：开发⼈员 -&gt; 提交代码 -&gt;gitlab 仓库 -&gt;Jenkins/CI 抓取代码 -&gt; 漏洞扫描 -&gt; 编译 -&gt; 构建镜像 -&gt; 推送 Harbor-&gt; 部署应⽤⾄ Docker 测试环境；</p><p>CD：Jenkins/CD-&gt; 获取 Harbor 仓库对应项⽬镜像 -&gt; 部署应⽤⾄ Docker ⽣产环境；</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/JUSZy1l.jpeg" alt="2.jpg"></p><h4 id="2-部署服务组件"><a class="anchor" href="#2-部署服务组件">#</a> 2. 部署服务组件</h4><h5 id="21-服务地址规划"><a class="anchor" href="#21-服务地址规划">#</a> 2.1 服务地址规划</h5><table><thead><tr><th>⻆⾊名称</th><th>系统</th><th>IP 地址</th><th>部署⽅式</th></tr></thead><tbody><tr><td>gitlab</td><td>Centos 7.6</td><td>192.168.40.110</td><td>容器部署</td></tr><tr><td>jenkins</td><td>Centos 7.6</td><td>192.168.40.120</td><td>容器部署</td></tr><tr><td>nexus</td><td>Centos 7.6</td><td>192.168.40.121</td><td>容器部署</td></tr><tr><td>sonarqube</td><td>Centos 7.6</td><td>192.168.40.130</td><td>容器部署</td></tr><tr><td>harbor</td><td>Centos 7.6</td><td>192.168.40.134</td><td></td></tr><tr><td>docker-test</td><td>Centos 7.6</td><td>192.168.40.181</td><td>8888</td></tr><tr><td>docker-prod</td><td>Centos 7.6</td><td>192.168.40.182</td><td>80</td></tr></tbody></table><p>1 、所有节点部署 docker</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@harbor ~<span class="token punctuation">]</span><span class="token comment"># yum install -y yum-utils device-mapper-persistent-data lvm2</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@harbor ~<span class="token punctuation">]</span><span class="token comment"># curl -o /etc/yum.repos.d/docker-ce.repo  https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@harbor ~<span class="token punctuation">]</span><span class="token comment"># yum list docker-ce --showduplicates |sort -r </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@harbor ~<span class="token punctuation">]</span><span class="token comment"># yum install docker-ce docker-compose -y</span></pre></td></tr></table></figure><p>2、配置 Docker 加速</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@harbor ~<span class="token punctuation">]</span><span class="token comment"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@harbor ~<span class="token punctuation">]</span><span class="token comment"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token string">"https://docker.credclouds.com"</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token string">"https://k8s.credclouds.com"</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token string">"https://quay.credclouds.com"</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token string">"https://gcr.credclouds.com"</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token string">"https://k8s-gcr.credclouds.com"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token string">"https://ghcr.credclouds.com"</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token string">"https://do.nark.eu.org"</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token string">"https://docker.m.daocloud.io"</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token string">"https://docker.nju.edu.cn"</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token string">"https://docker.mirrors.sjtug.sjtu.edu.cn"</span>,</pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token string">"https://docker.1panel.live"</span>,</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token string">"https://docker.rainbond.cc"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">]</span>, </pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token string">"exec-opts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>EOF</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">[</span>root@harbor ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable docker --now</span></pre></td></tr></table></figure><p>3、安装 Harbor</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@harbor ~<span class="token punctuation">]</span><span class="token comment"># cd /soft/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@harbor ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/goharbor/harbor/releases/download/v2.6.1/harbor-offline-installer-v2.6.1.tgz</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@harbor soft<span class="token punctuation">]</span><span class="token comment"># tar xf harbor-offline-installer-v2.6.1.tgz</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@harbor soft<span class="token punctuation">]</span><span class="token comment"># cd harbor</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment"># vim harbor.yml</span></pre></td></tr><tr><td data-num="6"></td><td><pre>hostname: harbor.hmallleasing.com</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#https:</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#  # https port for harbor, default is 443</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#  port: 443</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#  # The path of cert and key files for nginx</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#  certificate: /your/certificate/path</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#  private_key: /your/private/key/path</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="15"></td><td><pre>harbor_admin_password: Harbor12345</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment">#  ./install.sh</span></pre></td></tr></table></figure><p>4、推送镜像至 Harbor</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment"># docker tag beae173ccac6 harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment"># docker push harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment"># docker login harbor.hmallleasing.com</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment"># docker push harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr></table></figure><p>5、Harbor 停止与启动</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#停用 Harbor</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="3"></td><td><pre>/soft/harbor</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment"># docker-compose stop</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#启动 Harbor</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment"># docker-compose up -d</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@harbor harbor<span class="token punctuation">]</span><span class="token comment"># docker-compose start</span></pre></td></tr></table></figure><h5 id="22-部署gitlab"><a class="anchor" href="#22-部署gitlab">#</a> 2.2 部署 Gitlab</h5><p>1、部署 gitlab</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> gitlab <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">-p</span> <span class="token number">9022</span>:22 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">--restart</span> always <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">--hostname</span> <span class="token string">"gitlab.hmallleasing.com"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>--add-host jenkins.hmallleasing.com:192.168.40.120 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token parameter variable">-v</span> /data/gitlab/etc:/etc/gitlab <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token parameter variable">-v</span> /data/gitlab/log:/var/log/gitlab <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token parameter variable">-v</span> /data/gitlab/opt:/var/opt/gitlab <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>registry.cn-hangzhou.aliyuncs.com/old_xu/gitlab-ce:16.10.0-ce.0</pre></td></tr></table></figure><p>2、获取 gitlab 的密码</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token comment"># cat /data/gitlab/etc/initial_root_password</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Password: b//+rFJv06YO83ANK1MRLvFj9ygC1dvqq2Lr4DjNj6Y<span class="token operator">=</span></pre></td></tr></table></figure><p>3、准备项⽬代码</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/jenkins/springboot-devops-demo-jar-java17.tar.gz</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token comment"># tar xf springboot-devops-demo-jar-java17.tar.gz</span></pre></td></tr></table></figure><p>4、为项⽬源代码注⼊ Dockerfile ⽂件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@gitlab springboot-devops-demo-jar-java17<span class="token punctuation">]</span><span class="token comment"># cat Dockerfile</span></pre></td></tr><tr><td data-num="2"></td><td><pre>FROM openjdk:17-jdk-alpine</pre></td></tr><tr><td data-num="3"></td><td><pre>COPY ./target/*.jar /oldxu-jar.jar</pre></td></tr><tr><td data-num="4"></td><td><pre>EXPOSE <span class="token number">8080</span></pre></td></tr><tr><td data-num="5"></td><td><pre>ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"sh"</span>,<span class="token string">"-c"</span>,<span class="token string">"java -jar /oldxu-jar.jar --server.port=8080"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>5、提交代码⾄ gitlab 服务器</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.name <span class="token string">"Xu Yong"</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.email <span class="token string">"373370405@qq.com"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">git</span> init</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"first"</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">git</span> remote <span class="token function">add</span> origin http://gitlab.hmallleasing.com/root/springboot-devops-demo-jar.git</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">git</span> push origin master</pre></td></tr></table></figure><p>6、检查 gitlab 仓库的代码</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/ZUuf7Z0.jpeg" alt="1.jpg"></p><h5 id="23-部署jenkins"><a class="anchor" href="#23-部署jenkins">#</a> 2.3 部署 Jenkins</h5><p>因为 Jenkins 需要调⽤ Docker 构建镜像，但默认的 Jenkins 没有内置 docker 命令，也⽆法访问宿主机的 Docker，因此我们需要对 Jenkins 进⾏如下配置:</p><ul><li>1、挂在宿主机 docker 命令⾄ jenkins 容器内；</li><li>2、挂载宿主机的 docker.sock ⽂件，确保 jenkins 容器能通过宿主机的 docker 进⾏镜像的构建；</li><li>3、设置 jenkins 的时区，确保获取的时间是准确的；</li><li>4、由于 gitlab、harbor 等服务都需要通过域名进⾏访问，因此可以通过 --add-host 明确指定对应的解析；</li><li>5、jenkins 的数据⽬录需要挂载到宿主机的某个⽬录存储；</li></ul><p>1、部署 Jenkins</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> jenkins <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">--hostname</span> <span class="token string">"jenkins.hmallleasing.com"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">50000</span>:50000 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token parameter variable">-u</span> root <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token parameter variable">-e</span> <span class="token assign-left variable">TZ</span><span class="token operator">=</span>Asia/Shanghai <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token parameter variable">-v</span> /etc/localtime:/etc/localtime:ro <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token parameter variable">-v</span> jenkins_home:/var/jenkins_home <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token parameter variable">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token parameter variable">-v</span> /usr/bin/docker:/usr/bin/docker <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>--add-host gitlab.hmallleasing.com:192.168.40.110 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="14"></td><td><pre>--add-host nexus.hmallleasing.com:192.168.40.121 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="15"></td><td><pre>--add-host sonar.hmallleasing.com:192.168.40.130 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="16"></td><td><pre>--add-host harbor.hmallleasing.com:192.168.40.134 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="17"></td><td><pre>jenkins/jenkins:2.528.2-lts-jdk17</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># nerdctl</span></pre></td></tr><tr><td data-num="20"></td><td><pre>nerdctl run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> jenkins <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token parameter variable">--hostname</span> <span class="token string">"jenkins.oldxu.net"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">50000</span>:50000 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token parameter variable">-u</span> root <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token parameter variable">-e</span> <span class="token assign-left variable">TZ</span><span class="token operator">=</span>Asia/Shanghai <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token parameter variable">-v</span> /etc/localtime:/etc/localtime:ro <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token parameter variable">-v</span> jenkins_home:/var/jenkins_home <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token parameter variable">-v</span> /usr/local/bin/nerdctl:/usr/local/bin/nerdctl <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token parameter variable">-v</span> /run/containerd/containerd.sock:/run/containerd/containerd.sock <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token parameter variable">-v</span> /usr/local/bin/buildctl:/usr/local/bin/buildctl <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token parameter variable">-v</span> /run/buildkit/buildkitd.sock:/run/buildkit/buildkitd.sock <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="34"></td><td><pre>--add-host gitlab.hmallleasing.com:192.168.40.110 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="35"></td><td><pre>--add-host nexus.hmallleasing.com:192.168.40.121 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="36"></td><td><pre>--add-host sonar.hmallleasing.com:192.168.40.130 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="37"></td><td><pre>--add-host harbor.hmallleasing.com:192.168.40.34 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="38"></td><td><pre>jenkins/jenkins:2.528.2-lts-jdk17</pre></td></tr></table></figure><p>2、获取 Jenkins 的初始密码</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@jenkins ~<span class="token punctuation">]</span><span class="token comment">#  cat /var/lib/docker/volumes/jenkins_home/_data/secrets/initialAdminPassword</span></pre></td></tr><tr><td data-num="2"></td><td><pre>90da771dfbdb4b0db4125137fef409e8</pre></td></tr></table></figure><p>3、安装 jenkins 插件</p><ul><li>1、安装 docker、Docker Pipeline 插件，⽤于调⽤ docker 容器；</li><li>2、安装 pipeline、Pipeline Stage View、Blue Ocean，⽤于执⾏流⽔线语法</li><li>3、安装 git、gitlab 插件</li><li>4、安装 Active Choices 插件</li><li>5、安装 Localization: Chinese 中⽂插件</li></ul><h4 id="3-获取代码"><a class="anchor" href="#3-获取代码">#</a> 3. 获取代码</h4><h5 id="31-创建凭据"><a class="anchor" href="#31-创建凭据">#</a> 3.1 创建凭据</h5><p>点击系统管理 -&gt;Manage Credentials-&gt; 全局凭据，创建⽤户访问 gitlab 的凭据，填写⽤户名、密码、ID 和描述</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/raIxGb0.jpeg" alt="1.jpg"></p><h5 id="32-编写stage"><a class="anchor" href="#32-编写stage">#</a> 3.2 编写 Stage</h5><p>创建流水线项目 devops_demo_docker-CI</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pipeline <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    agent any</pre></td></tr><tr><td data-num="3"></td><td><pre>	</pre></td></tr><tr><td data-num="4"></td><td><pre>	//将workspace工作目录赋予给WORK_SPACES变量，后续stage能正常找到工作目录</pre></td></tr><tr><td data-num="5"></td><td><pre>	environment <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        Git_Id <span class="token operator">=</span> <span class="token string">"gitlab-root-token"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        Git_Url <span class="token operator">=</span> <span class="token string">"http://gitlab.hmallleasing.com/root/springboot-devops-demo-jar.git"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		WORK_SPACES <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;WORKSPACE&#125;</span>"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		Harbor_Url <span class="token operator">=</span> <span class="token string">"harbor.hmallleasing.com"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		Pro <span class="token operator">=</span> <span class="token string">"app"</span> //Harbor镜像存储的目录</pre></td></tr><tr><td data-num="11"></td><td><pre>		ImageName <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;Harbor_Url&#125;</span>/<span class="token variable">$&#123;Pro&#125;</span>/springboot"</span> //镜像的完整名称</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    stages <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'获取代码'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>				<span class="token function">git</span> branch: <span class="token string">'master'</span>, credentialsId: <span class="token string">"<span class="token variable">$&#123;Git_Id &#125;</span>"</span>, url: <span class="token string">"<span class="token variable">$&#123;Git_Url&#125;</span>"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num="19"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#125;</span>		</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="33-检查结果"><a class="anchor" href="#33-检查结果">#</a> 3.3 检查结果</h5><p>代码被获取到 /var/jenkins_home/workspace ⼯作路径下</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/dCQVCI1.jpeg" alt="2.jpg"></p><h4 id="4-编译代码"><a class="anchor" href="#4-编译代码">#</a> 4. 编译代码</h4><p>由于 Jenkins 是通过 Docker 运⾏的，因此 Jenkins 容器内并不包含 Maven 相关的命令。如果需要在 Jenkins 中编译代码，可以选择如下两种⽅法：</p><p>1、在宿主机上安装 Maven，并将 Maven 安装⽬录挂载到 Jenkins 容器内。这样，Jenkins 容器可以访问并使⽤宿主机上的 Maven 命令。</p><p>2、让 jenkins 在编译时运⾏⼀个 Maven 的容器作为构建环境。这样，每次运⾏构建任务时，Jenkins 会⾃动启动⼀个 Maven 容器来执⾏项⽬编译。</p><h5 id="41-maven环境"><a class="anchor" href="#41-maven环境">#</a> 4.1 maven 环境</h5><p>1、下载 maven 镜像</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@docker-node1 ~<span class="token punctuation">]</span><span class="token comment"># docker pull maven:3.8.5-openjdk-17-slim</span></pre></td></tr></table></figure><p>2、准备 maven 配置⽂件，可以在配置⽂件中注⼊阿⾥云加速地址，或是 Nexus 制品库地址（避免私有依赖的 jar 包⽆法获取）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@docker-node1 ~<span class="token punctuation">]</span><span class="token comment"># wget -O /etc/maven_settings.xml https://linux.oldxu.net/settings_docker.xml</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 配置 nexus 仓库认证</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">&lt;</span>servers<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token operator">&lt;</span>server<span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token operator">&lt;</span>id<span class="token operator">></span>maven-central<span class="token operator">&lt;</span>/id<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token operator">&lt;</span>username<span class="token operator">></span>admin<span class="token operator">&lt;</span>/username<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token operator">&lt;</span>password<span class="token operator">></span>talent<span class="token operator">&lt;</span>/password<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token operator">&lt;</span>/server<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token operator">&lt;</span>server<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token operator">&lt;</span>id<span class="token operator">></span>nexus-snapshots<span class="token operator">&lt;</span>/id<span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token operator">&lt;</span>username<span class="token operator">></span>admin<span class="token operator">&lt;</span>/username<span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token operator">&lt;</span>password<span class="token operator">></span>talent<span class="token operator">&lt;</span>/password<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token operator">&lt;</span>/server<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token operator">&lt;</span>server<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token operator">&lt;</span>id<span class="token operator">></span>nexus-releases<span class="token operator">&lt;</span>/id<span class="token operator">></span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token operator">&lt;</span>username<span class="token operator">></span>admin<span class="token operator">&lt;</span>/username<span class="token operator">></span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token operator">&lt;</span>password<span class="token operator">></span>talent<span class="token operator">&lt;</span>/password<span class="token operator">></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token operator">&lt;</span>/server<span class="token operator">></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token operator">&lt;</span>/servers<span class="token operator">></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 配置 nexus 仓库地址</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token operator">&lt;</span>mirrors<span class="token operator">></span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token operator">&lt;</span>mirror<span class="token operator">></span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token operator">&lt;</span>id<span class="token operator">></span>maven-central<span class="token operator">&lt;</span>/id<span class="token operator">></span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token operator">&lt;</span>mirrorOf<span class="token operator">></span>*<span class="token operator">&lt;</span>/mirrorOf<span class="token operator">></span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token operator">&lt;</span>url<span class="token operator">></span>http://nexus.hmallleasing.com/repository/maven-central/<span class="token operator">&lt;</span>/url<span class="token operator">></span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token operator">&lt;</span>/mirror<span class="token operator">></span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token operator">&lt;</span>mirror<span class="token operator">></span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token operator">&lt;</span>id<span class="token operator">></span>nexus-snapshots<span class="token operator">&lt;</span>/id<span class="token operator">></span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token operator">&lt;</span>mirrorOf<span class="token operator">></span>*<span class="token operator">&lt;</span>/mirrorOf<span class="token operator">></span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token operator">&lt;</span>url<span class="token operator">></span>http://nexus.hmallleasing.com/repository/maven-snapshots/<span class="token operator">&lt;</span>/url<span class="token operator">></span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token operator">&lt;</span>/mirror<span class="token operator">></span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token operator">&lt;</span>mirror<span class="token operator">></span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token operator">&lt;</span>id<span class="token operator">></span>nexus-releases<span class="token operator">&lt;</span>/id<span class="token operator">></span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token operator">&lt;</span>mirrorOf<span class="token operator">></span>*<span class="token operator">&lt;</span>/mirrorOf<span class="token operator">></span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token operator">&lt;</span>url<span class="token operator">></span>http://nexus.hmallleasing.com/repository/maven-releases/<span class="token operator">&lt;</span>/url<span class="token operator">></span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token operator">&lt;</span>/mirror<span class="token operator">></span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token operator">&lt;</span>/mirrors<span class="token operator">></span></pre></td></tr></table></figure><h5 id="42-编写stage"><a class="anchor" href="#42-编写stage">#</a> 4.2 编写 Stage</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pipeline <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    agent any</pre></td></tr><tr><td data-num="3"></td><td><pre>	</pre></td></tr><tr><td data-num="4"></td><td><pre>	//将workspace工作目录赋予给WORK_SPACES变量，后续stage能正常找到工作目录</pre></td></tr><tr><td data-num="5"></td><td><pre>	environment <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        Git_Id <span class="token operator">=</span> <span class="token string">"gitlab-root-token"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        Git_Url <span class="token operator">=</span> <span class="token string">"http://gitlab.hmallleasing.com/root/springboot-devops-demo-jar.git"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		WORK_SPACES <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;WORKSPACE&#125;</span>"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		Harbor_Url <span class="token operator">=</span> <span class="token string">"harbor.hmallleasing.com"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		Pro <span class="token operator">=</span> <span class="token string">"app"</span> //Harbor镜像存储的目录</pre></td></tr><tr><td data-num="11"></td><td><pre>		ImageName <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;Harbor_Url&#125;</span>/<span class="token variable">$&#123;Pro&#125;</span>/springboot"</span> //镜像的完整名称</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    stages <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'获取代码'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>				<span class="token function">git</span> branch: <span class="token string">'master'</span>, credentialsId: <span class="token string">"<span class="token variable">$&#123;Git_Id &#125;</span>"</span>, url: <span class="token string">"<span class="token variable">$&#123;Git_Url&#125;</span>"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num="19"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		</pre></td></tr><tr><td data-num="22"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'编译代码'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>			agent <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>				<span class="token function">docker</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>					image <span class="token string">'maven:3.8.5-openjdk-17-slim'</span></pre></td></tr><tr><td data-num="26"></td><td><pre>					args <span class="token string">'-v $HOME/.m2:/root/.m2 -v /etc/maven_settings.xml:/usr/share/maven/conf/settings.xml'</span></pre></td></tr><tr><td data-num="27"></td><td><pre>					//当链接的镜像是私有仓库时，我们需要传递私有仓库的地址和认证信息</pre></td></tr><tr><td data-num="28"></td><td><pre>					//registryUrl <span class="token string">"https://<span class="token variable">$&#123;Url&#125;</span>"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>					//registryCredentialsId <span class="token string">'harbor-auth'</span></pre></td></tr><tr><td data-num="30"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; mvn package -Dmaven.test.skip=true'</span></pre></td></tr><tr><td data-num="34"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; ls -l &amp;&amp; ls -l target/'</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token punctuation">&#125;</span>			</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="43-检查结果"><a class="anchor" href="#43-检查结果">#</a> 4.3 检查结果</h5><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/Az8kYqk.jpeg" alt="3.jpg"></p><h4 id="5-构建镜像"><a class="anchor" href="#5-构建镜像">#</a> 5. 构建镜像</h4><p>镜像构建通过镜像名称 + 镜像 Tag 组成，所以我们可以先定义⼀个阶段完成镜像 Tag 的⽣成；</p><h5 id="51-定义镜像tag"><a class="anchor" href="#51-定义镜像tag">#</a> 5.1 定义镜像 Tag</h5><p>1、创建新的 Stage 来定义镜像 Tag 相关内容</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pipeline <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    agent any</pre></td></tr><tr><td data-num="3"></td><td><pre>	</pre></td></tr><tr><td data-num="4"></td><td><pre>	//将workspace工作目录赋予给WORK_SPACES变量，后续stage能正常找到工作目录</pre></td></tr><tr><td data-num="5"></td><td><pre>	environment <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        Git_Id <span class="token operator">=</span> <span class="token string">"gitlab-root-token"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        Git_Url <span class="token operator">=</span> <span class="token string">"http://gitlab.hmallleasing.com/root/springboot-devops-demo-jar.git"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		WORK_SPACES <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;WORKSPACE&#125;</span>"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		Harbor_Url <span class="token operator">=</span> <span class="token string">"harbor.hmallleasing.com"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		Pro <span class="token operator">=</span> <span class="token string">"app"</span> //Harbor镜像存储的目录</pre></td></tr><tr><td data-num="11"></td><td><pre>		ImageName <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;Harbor_Url&#125;</span>/<span class="token variable">$&#123;Pro&#125;</span>/springboot"</span> //镜像的完整名称</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    stages <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'获取代码'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>				<span class="token function">git</span> branch: <span class="token string">'master'</span>, credentialsId: <span class="token string">"<span class="token variable">$&#123;Git_Id &#125;</span>"</span>, url: <span class="token string">"<span class="token variable">$&#123;Git_Url&#125;</span>"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num="19"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		</pre></td></tr><tr><td data-num="22"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'编译代码'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>			agent <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>				<span class="token function">docker</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>					image <span class="token string">'maven:3.8.5-openjdk-17-slim'</span></pre></td></tr><tr><td data-num="26"></td><td><pre>					args <span class="token string">'-v $HOME/.m2:/root/.m2 -v /etc/maven_settings.xml:/usr/share/maven/conf/settings.xml'</span></pre></td></tr><tr><td data-num="27"></td><td><pre>					//当链接的镜像是私有仓库时，我们需要传递私有仓库的地址和认证信息</pre></td></tr><tr><td data-num="28"></td><td><pre>					//registryUrl <span class="token string">"https://<span class="token variable">$&#123;Url&#125;</span>"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>					//registryCredentialsId <span class="token string">'harbor-auth'</span></pre></td></tr><tr><td data-num="30"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; mvn package -Dmaven.test.skip=true'</span></pre></td></tr><tr><td data-num="34"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; ls -l &amp;&amp; ls -l target/'</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		</pre></td></tr><tr><td data-num="38"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'生成成镜像Tag'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>				script <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>					//镜像本次的CommitID</pre></td></tr><tr><td data-num="42"></td><td><pre>					env.COMMITID <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"git log -n1 --pretty=format:'%h'"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>					//镜像构建的时间</pre></td></tr><tr><td data-num="44"></td><td><pre>					env.BuildTime <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"date +%Y%m%d_%H%M%S"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>					//镜像Tag</pre></td></tr><tr><td data-num="46"></td><td><pre>					env.ImageTag <span class="token operator">=</span> COMMITID + <span class="token string">"_"</span> + BuildTime </pre></td></tr><tr><td data-num="47"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'echo $&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num="49"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		</pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2、检查镜像 Tag 标签格式 commit + 年⽉⽇ + 时分秒</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/fQfp2WR.jpeg" alt="4.jpg"></p><h5 id="52-编写stage"><a class="anchor" href="#52-编写stage">#</a> 5.2 编写 Stage</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pipeline <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    agent any</pre></td></tr><tr><td data-num="3"></td><td><pre>	</pre></td></tr><tr><td data-num="4"></td><td><pre>	//将workspace工作目录赋予给WORK_SPACES变量，后续stage能正常找到工作目录</pre></td></tr><tr><td data-num="5"></td><td><pre>	environment <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        Git_Id <span class="token operator">=</span> <span class="token string">"gitlab-root-token"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        Git_Url <span class="token operator">=</span> <span class="token string">"http://gitlab.hmallleasing.com/root/springboot-devops-demo-jar.git"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		WORK_SPACES <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;WORKSPACE&#125;</span>"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		Harbor_Url <span class="token operator">=</span> <span class="token string">"harbor.hmallleasing.com"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		Pro <span class="token operator">=</span> <span class="token string">"app"</span> //Harbor镜像存储的目录</pre></td></tr><tr><td data-num="11"></td><td><pre>		ImageName <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;Harbor_Url&#125;</span>/<span class="token variable">$&#123;Pro&#125;</span>/springboot"</span> //镜像的完整名称</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    stages <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'获取代码'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>				<span class="token function">git</span> branch: <span class="token string">'master'</span>, credentialsId: <span class="token string">"<span class="token variable">$&#123;Git_Id &#125;</span>"</span>, url: <span class="token string">"<span class="token variable">$&#123;Git_Url&#125;</span>"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num="19"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		</pre></td></tr><tr><td data-num="22"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'编译代码'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>			agent <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>				<span class="token function">docker</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>					image <span class="token string">'maven:3.8.5-openjdk-17-slim'</span></pre></td></tr><tr><td data-num="26"></td><td><pre>					args <span class="token string">'-v $HOME/.m2:/root/.m2 -v /etc/maven_settings.xml:/usr/share/maven/conf/settings.xml'</span></pre></td></tr><tr><td data-num="27"></td><td><pre>					//当链接的镜像是私有仓库时，我们需要传递私有仓库的地址和认证信息</pre></td></tr><tr><td data-num="28"></td><td><pre>					//registryUrl <span class="token string">"https://<span class="token variable">$&#123;Url&#125;</span>"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>					//registryCredentialsId <span class="token string">'harbor-auth'</span></pre></td></tr><tr><td data-num="30"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; mvn package -Dmaven.test.skip=true'</span></pre></td></tr><tr><td data-num="34"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; ls -l &amp;&amp; ls -l target/'</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		</pre></td></tr><tr><td data-num="38"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'生成成镜像Tag'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>				script <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>					//镜像本次的CommitID</pre></td></tr><tr><td data-num="42"></td><td><pre>					env.COMMITID <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"git log -n1 --pretty=format:'%h'"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>					//镜像构建的时间</pre></td></tr><tr><td data-num="44"></td><td><pre>					env.BuildTime <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"date +%Y%m%d_%H%M%S"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>					//镜像Tag</pre></td></tr><tr><td data-num="46"></td><td><pre>					env.ImageTag <span class="token operator">=</span> COMMITID + <span class="token string">"_"</span> + BuildTime </pre></td></tr><tr><td data-num="47"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'echo $&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num="49"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		</pre></td></tr><tr><td data-num="52"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'制作镜像'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num="55"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>		</pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="53-检查结果"><a class="anchor" href="#53-检查结果">#</a> 5.3 检查结果</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@jenkins ~<span class="token punctuation">]</span><span class="token comment"># docker images|grep harbor.hmallleasing.com</span></pre></td></tr><tr><td data-num="2"></td><td><pre>harbor.hmallleasing.com/app/springboot             aeacd46_20251130_165729   aa41b44e5aaf   <span class="token number">7</span> minutes ago   345MB</pre></td></tr></table></figure><h4 id="6-推送镜像至仓库"><a class="anchor" href="#6-推送镜像至仓库">#</a> 6. 推送镜像⾄仓库</h4><h5 id="61-创建凭据"><a class="anchor" href="#61-创建凭据">#</a> 6.1 创建凭据</h5><p>由于推送镜像⾄ Harbor 私有仓库，需要身份认证，为此我们可以创建⼀个凭据，存储 Harbor 对应的⽤户名以及密码，⽽后在 Pipeline 中进⾏使⽤。</p><p>点击系统管理 -&gt;Manage Credentials-&gt; 全局凭据</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/cTyz3W1.jpeg" alt="5.jpg"></p><h5 id="62-编写stage"><a class="anchor" href="#62-编写stage">#</a> 6.2 编写 Stage</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pipeline <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    agent any</pre></td></tr><tr><td data-num="3"></td><td><pre>	</pre></td></tr><tr><td data-num="4"></td><td><pre>	//将workspace工作目录赋予给WORK_SPACES变量，后续stage能正常找到工作目录</pre></td></tr><tr><td data-num="5"></td><td><pre>	environment <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        Git_Id <span class="token operator">=</span> <span class="token string">"gitlab-root-token"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        Git_Url <span class="token operator">=</span> <span class="token string">"http://gitlab.hmallleasing.com/root/springboot-devops-demo-jar.git"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		WORK_SPACES <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;WORKSPACE&#125;</span>"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		Harbor_Url <span class="token operator">=</span> <span class="token string">"harbor.hmallleasing.com"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		Pro <span class="token operator">=</span> <span class="token string">"app"</span> //Harbor镜像存储的目录</pre></td></tr><tr><td data-num="11"></td><td><pre>		ImageName <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;Harbor_Url&#125;</span>/<span class="token variable">$&#123;Pro&#125;</span>/springboot"</span> //镜像的完整名称</pre></td></tr><tr><td data-num="12"></td><td><pre>        HARBOR_ID <span class="token operator">=</span> <span class="token string">"harbor-auth"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    stages <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'获取代码'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				<span class="token function">git</span> branch: <span class="token string">'master'</span>, credentialsId: <span class="token string">"<span class="token variable">$&#123;Git_Id &#125;</span>"</span>, url: <span class="token string">"<span class="token variable">$&#123;Git_Url&#125;</span>"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num="20"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		</pre></td></tr><tr><td data-num="23"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'编译代码'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>			agent <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>				<span class="token function">docker</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>					image <span class="token string">'maven:3.8.5-openjdk-17-slim'</span></pre></td></tr><tr><td data-num="27"></td><td><pre>					args <span class="token string">'-v $HOME/.m2:/root/.m2 -v /etc/maven_settings.xml:/usr/share/maven/conf/settings.xml'</span></pre></td></tr><tr><td data-num="28"></td><td><pre>					//当链接的镜像是私有仓库时，我们需要传递私有仓库的地址和认证信息</pre></td></tr><tr><td data-num="29"></td><td><pre>					//registryUrl <span class="token string">"https://<span class="token variable">$&#123;Url&#125;</span>"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>					//registryCredentialsId <span class="token string">'harbor-auth'</span></pre></td></tr><tr><td data-num="31"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; mvn package -Dmaven.test.skip=true'</span></pre></td></tr><tr><td data-num="35"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; ls -l &amp;&amp; ls -l target/'</span></pre></td></tr><tr><td data-num="36"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		</pre></td></tr><tr><td data-num="39"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'生成成镜像Tag'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>				script <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>					//镜像本次的CommitID</pre></td></tr><tr><td data-num="43"></td><td><pre>					env.COMMITID <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"git log -n1 --pretty=format:'%h'"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>					//镜像构建的时间</pre></td></tr><tr><td data-num="45"></td><td><pre>					env.BuildTime <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"date +%Y%m%d_%H%M%S"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>					//镜像Tag</pre></td></tr><tr><td data-num="47"></td><td><pre>					env.ImageTag <span class="token operator">=</span> COMMITID + <span class="token string">"_"</span> + BuildTime </pre></td></tr><tr><td data-num="48"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'echo $&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num="50"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>		</pre></td></tr><tr><td data-num="53"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'制作镜像'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num="56"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>		</pre></td></tr><tr><td data-num="59"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'推送镜像至Harbor'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                withCredentials<span class="token punctuation">(</span><span class="token punctuation">[</span>usernamePassword<span class="token punctuation">(</span>credentialsId: <span class="token string">"<span class="token variable">$&#123;HARBOR_ID&#125;</span>"</span>, passwordVariable: <span class="token string">'HARBOR_PASSWORD'</span>, usernameVariable: <span class="token string">'HARBOR_USER'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    //登陆harbor</pre></td></tr><tr><td data-num="63"></td><td><pre>                    <span class="token function">sh</span> <span class="token string">'echo "$&#123;HARBOR_PASSWORD&#125;" | docker login $&#123;Harbor_Url&#125; -u "$&#123;HARBOR_USER&#125;" --password-stdin'</span></pre></td></tr><tr><td data-num="64"></td><td><pre>					<span class="token function">sh</span> <span class="token string">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num="65"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>		</pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="63-检查结果"><a class="anchor" href="#63-检查结果">#</a> 6.3 检查结果</h5><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/CgmXkjQ.jpeg" alt="1.jpg"></p><h4 id="7-交付应用至docker"><a class="anchor" href="#7-交付应用至docker">#</a> 7. 交付应⽤⾄ Docker</h4><p>由于 Jenkins 容器内封装了 Docker 命令，并且挂载了宿主机的 socket ⽂件，我们可以直接在 Jenkins 任务中使⽤容器内的 Docker 命令来构建和运⾏容器。</p><h5 id="71-编写stage"><a class="anchor" href="#71-编写stage">#</a> 7.1 编写 Stage</h5><p>1、编写 pipeline 流水线</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pipeline <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    agent any</pre></td></tr><tr><td data-num="3"></td><td><pre>	</pre></td></tr><tr><td data-num="4"></td><td><pre>	//将workspace工作目录赋予给WORK_SPACES变量，后续stage能正常找到工作目录</pre></td></tr><tr><td data-num="5"></td><td><pre>	environment <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        Git_Id <span class="token operator">=</span> <span class="token string">"gitlab-root-token"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        Git_Url <span class="token operator">=</span> <span class="token string">"http://gitlab.hmallleasing.com/root/springboot-devops-demo-jar.git"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		WORK_SPACES <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;WORKSPACE&#125;</span>"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		Harbor_Url <span class="token operator">=</span> <span class="token string">"harbor.hmallleasing.com"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		Pro <span class="token operator">=</span> <span class="token string">"app"</span> //Harbor镜像存储的目录</pre></td></tr><tr><td data-num="11"></td><td><pre>		ImageName <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;Harbor_Url&#125;</span>/<span class="token variable">$&#123;Pro&#125;</span>/springboot"</span> //镜像的完整名称</pre></td></tr><tr><td data-num="12"></td><td><pre>        HARBOR_ID <span class="token operator">=</span> <span class="token string">"harbor-auth"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    stages <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'获取代码'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				<span class="token function">git</span> branch: <span class="token string">'master'</span>, credentialsId: <span class="token string">"<span class="token variable">$&#123;Git_Id &#125;</span>"</span>, url: <span class="token string">"<span class="token variable">$&#123;Git_Url&#125;</span>"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num="20"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		</pre></td></tr><tr><td data-num="23"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'编译代码'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>			agent <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>				<span class="token function">docker</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>					image <span class="token string">'maven:3.8.5-openjdk-17-slim'</span></pre></td></tr><tr><td data-num="27"></td><td><pre>					args <span class="token string">'-v $HOME/.m2:/root/.m2 -v /etc/maven_settings.xml:/usr/share/maven/conf/settings.xml'</span></pre></td></tr><tr><td data-num="28"></td><td><pre>					//当链接的镜像是私有仓库时，我们需要传递私有仓库的地址和认证信息</pre></td></tr><tr><td data-num="29"></td><td><pre>					//registryUrl <span class="token string">"https://<span class="token variable">$&#123;Url&#125;</span>"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>					//registryCredentialsId <span class="token string">'harbor-auth'</span></pre></td></tr><tr><td data-num="31"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; mvn package -Dmaven.test.skip=true'</span></pre></td></tr><tr><td data-num="35"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; ls -l &amp;&amp; ls -l target/'</span></pre></td></tr><tr><td data-num="36"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		</pre></td></tr><tr><td data-num="39"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'生成成镜像Tag'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>				script <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>					//镜像本次的CommitID</pre></td></tr><tr><td data-num="43"></td><td><pre>					env.COMMITID <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"git log -n1 --pretty=format:'%h'"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>					//镜像构建的时间</pre></td></tr><tr><td data-num="45"></td><td><pre>					env.BuildTime <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"date +%Y%m%d_%H%M%S"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>					//镜像Tag</pre></td></tr><tr><td data-num="47"></td><td><pre>					env.ImageTag <span class="token operator">=</span> COMMITID + <span class="token string">"_"</span> + BuildTime </pre></td></tr><tr><td data-num="48"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'echo $&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num="50"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>		</pre></td></tr><tr><td data-num="53"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'制作镜像'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num="56"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>		</pre></td></tr><tr><td data-num="59"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'推送镜像至Harbor'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                withCredentials<span class="token punctuation">(</span><span class="token punctuation">[</span>usernamePassword<span class="token punctuation">(</span>credentialsId: <span class="token string">"<span class="token variable">$&#123;HARBOR_ID&#125;</span>"</span>, passwordVariable: <span class="token string">'HARBOR_PASSWORD'</span>, usernameVariable: <span class="token string">'HARBOR_USER'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    //登陆harbor</pre></td></tr><tr><td data-num="63"></td><td><pre>                    <span class="token function">sh</span> <span class="token string">'echo "$&#123;HARBOR_PASSWORD&#125;" | docker login $&#123;Harbor_Url&#125; -u "$&#123;HARBOR_USER&#125;" --password-stdin'</span></pre></td></tr><tr><td data-num="64"></td><td><pre>					<span class="token function">sh</span> <span class="token string">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num="65"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>		</pre></td></tr><tr><td data-num="69"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'交付镜像测试测试环境'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>				<span class="token function">sh</span> <span class="token string">"export DOCKER_HOST=tcp://192.168.40.181:2375 &amp;&amp; \</span></pre></td></tr><tr><td data-num="72"></td><td><pre>					docker rm -f spring_test &amp;&amp; \</pre></td></tr><tr><td data-num="73"></td><td><pre>					docker run -d --name spring_test -p8888:8080 <span class="token variable">$&#123;ImageName&#125;</span>:<span class="token variable">$&#123;ImageTag&#125;</span>"</pre></td></tr><tr><td data-num="74"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>			</pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2、在测试服务器上，开启 Docker 的远程访问功能；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@docker_test ~<span class="token punctuation">]</span><span class="token comment"># cat /lib/systemd/system/docker.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/dockerd <span class="token parameter variable">-H</span> fd:// <span class="token parameter variable">--containerd</span><span class="token operator">=</span>/run/containerd/containerd.sock <span class="token parameter variable">-H</span> tcp://0.0.0.0:2375</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr></table></figure><p>3、使⽤方法</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">DOCKER_HOST</span><span class="token operator">=</span>tcp://10.0.0.182:2375</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker</span> run <span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr></table></figure><h5 id="72-检查结果"><a class="anchor" href="#72-检查结果">#</a> 7.2 检查结果</h5><p>1、检查容器的运⾏结果</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@docker_test ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span></pre></td></tr><tr><td data-num="2"></td><td><pre>CONTAINER ID   IMAGE                                                            COMMAND                  CREATED              STATUS              PORTS                                       NAMES</pre></td></tr><tr><td data-num="3"></td><td><pre>f1333491e731   harbor.hmallleasing.com/app/springboot:aeacd46_20251130_182807   <span class="token string">"sh -c 'java -jar /o…"</span>   About a minute ago   Up About a minute   <span class="token number">0.0</span>.0.0:8888-<span class="token operator">></span><span class="token number">8080</span>/tcp, :::8888-<span class="token operator">></span><span class="token number">8080</span>/tcp   spring_test</pre></td></tr></table></figure><p>2、访问测试</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/5yCRN1p.jpeg" alt="2.jpg"></p><h4 id="8-实现自动化ci"><a class="anchor" href="#8-实现自动化ci">#</a> 8. 实现⾃动化 CI</h4><p>⾃动化 CI，就是通过 webhook 来实现，所谓 webhook 就是当开发⼀提交代码，则⾃定对项⽬进⾏构建操作；</p><h5 id="81-配置jenkins"><a class="anchor" href="#81-配置jenkins">#</a> 8.1 配置 Jenkins</h5><p>1、点击 jenkins 中对应的项⽬，找到构建触发器 --&gt;Build when a change ispushed to GitLab；</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/qJxP4eK.jpeg" alt="2.jpg"></p><p>2、找到⾼级，然后找到 Secret token，点击 Generate ⽣成 token</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/Be7jo2y.jpeg" alt="3.jpg"></p><h5 id="82-配置gitlab"><a class="anchor" href="#82-配置gitlab">#</a> 8.2 配置 Gitlab</h5><p>1、配置 gitlab ， 菜单 -&gt; 管理员 -&gt; 设置 -&gt; ⽹络 -&gt; 出站请求 -&gt; 允许 webhooks 集成对本地⽹络的请求 (勾选)</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/pbdYZ8g.jpeg" alt="4.jpg"></p><p>2、找到对应要实现⾃动化发布的项⽬， 点击设置 --&gt;webhook--&gt; 添加新的 webhook</p><ul><li>URL--&gt; 通知 jenkins 的哪个项⽬地址</li><li>令牌 --&gt; jenkins 针对项⽬⽣成的 token 令牌</li><li>触发来源 --&gt; 推送事件</li></ul><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/UFBwT3d.jpeg" alt="5.jpg"></p><h5 id="83-验证结果"><a class="anchor" href="#83-验证结果">#</a> 8.3 验证结果</h5><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/Jl30JF4.jpeg" alt="6.jpg"></p><h4 id="9-实现cd阶段"><a class="anchor" href="#9-实现cd阶段">#</a> 9. 实现 CD 阶段</h4><p>CI 与 CD 两个流⽔线</p><ul><li>CI：拉取代码 -&gt; 漏洞检测 -&gt; 代码编译 -&gt; 镜像制作 -&gt; 推送私有仓库 -&gt; 交付测试环境</li><li>CD：获取 Harbor 仓库对应项⽬镜像的 tags-&gt; 部署⾄⽣产环境</li></ul><h5 id="91-cd实现思路"><a class="anchor" href="#91-cd实现思路">#</a> 9.1 CD 实现思路</h5><ul><li>1、获取 Harbor 对应项⽬的 tag；</li><li>2、编写 Stage 拼接完整的镜像名称；</li><li>3、调⽤ docker 命令在远程⽣产服务器上运⾏对应的容器实例；</li></ul><p>注意：获取镜像 Tag 可以使⽤ 级联变量 ⽅式实现，因为镜像可能存储在不同的 Harbor 或不同的项⽬路径中，写死后期修改麻烦；</p><ul><li>1、使⽤ Active Choices Parameter 定义 Harbor 仓库地址（变量名：Harbor_Url）；</li><li>2、使⽤ Active Choices Parameter 定义 Harbor 项⽬名称（变量名：Harbor_Pro）；</li><li>3、使⽤ Active Choices Parameter 定义 Harbor 镜像名称（变量名：Image_Name）；</li><li>4、使⽤ Active Choices Reactive Parameter 引⽤并参考此前变量，最终获取镜像 Tag（变量名：Image_tags）</li></ul><p>需要安装： Active Choices 插件才可以实现；</p><h5 id="92-命令获取镜像tag"><a class="anchor" href="#92-命令获取镜像tag">#</a> 9.2 命令获取镜像 Tag</h5><p>1、创建流水线项目 devops_demo_docker-CD</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@jenkins ~<span class="token punctuation">]</span><span class="token comment"># curl -s -u admin:talent -H 'Content-Type: application/json' -X GET https://harbor.hmallleasing.com/v2/app/springboot/tags/list| sed -r 's#(\&#123;.*\[)(.*)(.*\]\&#125;)#\2#g' | xargs -d "," -n1|xargs -n1</span></pre></td></tr><tr><td data-num="2"></td><td><pre>aeacd46_20251130_180212</pre></td></tr><tr><td data-num="3"></td><td><pre>aeacd46_20251130_180702</pre></td></tr><tr><td data-num="4"></td><td><pre>aeacd46_20251130_181934</pre></td></tr><tr><td data-num="5"></td><td><pre>aeacd46_20251130_182658</pre></td></tr><tr><td data-num="6"></td><td><pre>aeacd46_20251130_182807</pre></td></tr></table></figure><h5 id="93-创建级联变量"><a class="anchor" href="#93-创建级联变量">#</a> 9.3 创建级联变量</h5><p>1、添加⼀个 Active Choices Parameter 的参数化构建，创建 Harbor_Url 变量，变量值 return [&quot;<a target="_blank" rel="noopener" href="http://harbor.hmallleasing.com">harbor.hmallleasing.com</a>&quot;,&quot;harbor-dev..hmallleasing.com&quot;,&quot;harbor-prod..hmallleasing.com&quot;] ，然后点击 Approve script</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/F2hBFZL.jpeg" alt="3.jpg"></p><p>2、添加⼀个 Active Choices Parameter 的参数化构建，创建 Harbor_Pro 变量，变量值 return [&quot;app&quot;,&quot;ops&quot;,&quot;base&quot;,&quot;library&quot;] ，然后点击 Approve script</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/Zl5rWp6.jpeg" alt="4.jpg"></p><p>3、添加⼀个 Active Choices Parameter 的参数化构建，创建 Image_Name 变量，变量值 return [&quot;springboot&quot;,&quot;nginx&quot;,&quot;tomcat&quot;] ，然后点击 Approve script</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/J91Fazz.jpeg" alt="5.jpg"></p><p>4、添加⼀个 Active Choices Reactive Parameter 的参数化构建</p><p>变量名为：Image_tags</p><p>变量值：此前获取 tags 的脚本</p><p>除此外，它还需要级联之前的变量 Harbor_Url,Harbor_Pro,Image_Name</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>def get_tag <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"bash"</span>,<span class="token string">"-c"</span>,<span class="token string">"curl -s -u admin:talent -H 'Content-Type: application/json' -X GET https://<span class="token variable">$&#123;Harbor_Url&#125;</span>/v2/<span class="token variable">$&#123;Harbor_Pro&#125;</span>/<span class="token variable">$&#123;Image_Name&#125;</span>/tags/list | sed -r 's#(<span class="token entity" title="\\">\\</span>&#123;.*<span class="token entity" title="\\">\\</span>[)(.*)(.*<span class="token entity" title="\\">\\</span>]<span class="token entity" title="\\">\\</span>&#125;)#<span class="token entity" title="\\">\\</span>2#g'| xargs -d ',' -n1|xargs -n1 | sort -t '_' -k2 -k3 -nr|head -n5"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">return</span> get_tag.execute<span class="token punctuation">(</span><span class="token punctuation">)</span>.text.tokenize<span class="token punctuation">(</span><span class="token string">"<span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/ZZ6JInF.jpeg" alt="6.jpg"></p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/T2DXw1I.jpeg" alt="7.jpg"></p><p>5、验证结果（根据选择的不同，Image_Tags 也会列出不同的结果）</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/XHeGgJa.jpeg" alt="8.jpg"></p><h5 id="94-编写stage"><a class="anchor" href="#94-编写stage">#</a> 9.4 编写 Stage</h5><p>1、编写 stage</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pipeline <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	agent any</pre></td></tr><tr><td data-num="3"></td><td><pre> </pre></td></tr><tr><td data-num="4"></td><td><pre>	//将传参的内容设定为变量</pre></td></tr><tr><td data-num="5"></td><td><pre>	environment <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token assign-left variable">Full_Images</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;Harbor_Url&#125;</span>/<span class="token variable">$&#123;Harbor_Pro&#125;</span>/<span class="token variable">$&#123;Image_Name&#125;</span>:<span class="token variable">$&#123;Image_tags&#125;</span>"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> </pre></td></tr><tr><td data-num="9"></td><td><pre>	stages <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'获取完整镜像名称'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'echo 镜像名称: $&#123;Full_Images&#125;'</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		</pre></td></tr><tr><td data-num="16"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'交付应用至Docker'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				//这个地址可以通过传参的方式设定</pre></td></tr><tr><td data-num="19"></td><td><pre>				<span class="token function">sh</span> <span class="token string">"export DOCKER_HOST=tcp://192.168.40.182:2375 &amp;&amp; \</span></pre></td></tr><tr><td data-num="20"></td><td><pre>				docker rm -f springboot_prod &amp;&amp; \</pre></td></tr><tr><td data-num="21"></td><td><pre>				docker run -d -p 80:8080 --name springboot_prod <span class="token variable">$&#123;Full_Images&#125;</span>"</pre></td></tr><tr><td data-num="22"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2、在测试服务器上，开启 Docker 的远程访问功能；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@docker_prod ~<span class="token punctuation">]</span><span class="token comment"># cat /lib/systemd/system/docker.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/dockerd <span class="token parameter variable">-H</span> fd:// <span class="token parameter variable">--containerd</span><span class="token operator">=</span>/run/containerd/containerd.sock <span class="token parameter variable">-H</span> tcp://0.0.0.0:2375</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr></table></figure><p>3、使⽤方法</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@docker_prod ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@docker_prod ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart docker</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">DOCKER_HOST</span><span class="token operator">=</span>tcp://10.0.0.182:2375</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">docker</span> run <span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr></table></figure><p>4、部署后检查结果</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@docker_prod ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/hosts</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</pre></td></tr><tr><td data-num="3"></td><td><pre>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">192.168</span>.40.134 harbor.hmallleasing.com</pre></td></tr></table></figure><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/keieLH7.jpeg" alt="9.jpg"></p><h4 id="10-完整pipeline"><a class="anchor" href="#10-完整pipeline">#</a> 10. 完整 Pipeline</h4><h5 id="101-pipeline-ci"><a class="anchor" href="#101-pipeline-ci">#</a> 10.1 Pipeline-CI</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pipeline <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    agent any</pre></td></tr><tr><td data-num="3"></td><td><pre>	</pre></td></tr><tr><td data-num="4"></td><td><pre>	//将workspace工作目录赋予给WORK_SPACES变量，后续stage能正常找到工作目录</pre></td></tr><tr><td data-num="5"></td><td><pre>	environment <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        Git_Id <span class="token operator">=</span> <span class="token string">"gitlab-root-token"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        Git_Url <span class="token operator">=</span> <span class="token string">"http://gitlab.hmallleasing.com/root/springboot-devops-demo-jar.git"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		WORK_SPACES <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;WORKSPACE&#125;</span>"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		Harbor_Url <span class="token operator">=</span> <span class="token string">"harbor.hmallleasing.com"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		Pro <span class="token operator">=</span> <span class="token string">"app"</span> //Harbor镜像存储的目录</pre></td></tr><tr><td data-num="11"></td><td><pre>		ImageName <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;Harbor_Url&#125;</span>/<span class="token variable">$&#123;Pro&#125;</span>/springboot"</span> //镜像的完整名称</pre></td></tr><tr><td data-num="12"></td><td><pre>        HARBOR_ID <span class="token operator">=</span> <span class="token string">"harbor-auth"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    stages <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'获取代码'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				<span class="token function">git</span> branch: <span class="token string">'master'</span>, credentialsId: <span class="token string">"<span class="token variable">$&#123;Git_Id &#125;</span>"</span>, url: <span class="token string">"<span class="token variable">$&#123;Git_Url&#125;</span>"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num="20"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		</pre></td></tr><tr><td data-num="23"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'编译代码'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>			agent <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>				<span class="token function">docker</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>					image <span class="token string">'maven:3.8.5-openjdk-17-slim'</span></pre></td></tr><tr><td data-num="27"></td><td><pre>					args <span class="token string">'-v $HOME/.m2:/root/.m2 -v /etc/maven_settings.xml:/usr/share/maven/conf/settings.xml'</span></pre></td></tr><tr><td data-num="28"></td><td><pre>					//当链接的镜像是私有仓库时，我们需要传递私有仓库的地址和认证信息</pre></td></tr><tr><td data-num="29"></td><td><pre>					//registryUrl <span class="token string">"https://<span class="token variable">$&#123;Url&#125;</span>"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>					//registryCredentialsId <span class="token string">'harbor-auth'</span></pre></td></tr><tr><td data-num="31"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; mvn package -Dmaven.test.skip=true'</span></pre></td></tr><tr><td data-num="35"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; ls -l &amp;&amp; ls -l target/'</span></pre></td></tr><tr><td data-num="36"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		</pre></td></tr><tr><td data-num="39"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'生成成镜像Tag'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>				script <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>					//镜像本次的CommitID</pre></td></tr><tr><td data-num="43"></td><td><pre>					env.COMMITID <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"git log -n1 --pretty=format:'%h'"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>					//镜像构建的时间</pre></td></tr><tr><td data-num="45"></td><td><pre>					env.BuildTime <span class="token operator">=</span> sh<span class="token punctuation">(</span>returnStdout: true, script: <span class="token string">"date +%Y%m%d_%H%M%S"</span><span class="token punctuation">)</span>.trim<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>					//镜像Tag</pre></td></tr><tr><td data-num="47"></td><td><pre>					env.ImageTag <span class="token operator">=</span> COMMITID + <span class="token string">"_"</span> + BuildTime </pre></td></tr><tr><td data-num="48"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'echo $&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num="50"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>		</pre></td></tr><tr><td data-num="53"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'制作镜像'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'cd $&#123;WORK_SPACES&#125; &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num="56"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>		</pre></td></tr><tr><td data-num="59"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'推送镜像至Harbor'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                withCredentials<span class="token punctuation">(</span><span class="token punctuation">[</span>usernamePassword<span class="token punctuation">(</span>credentialsId: <span class="token string">"<span class="token variable">$&#123;HARBOR_ID&#125;</span>"</span>, passwordVariable: <span class="token string">'HARBOR_PASSWORD'</span>, usernameVariable: <span class="token string">'HARBOR_USER'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    //登陆harbor</pre></td></tr><tr><td data-num="63"></td><td><pre>                    <span class="token function">sh</span> <span class="token string">'echo "$&#123;HARBOR_PASSWORD&#125;" | docker login $&#123;Harbor_Url&#125; -u "$&#123;HARBOR_USER&#125;" --password-stdin'</span></pre></td></tr><tr><td data-num="64"></td><td><pre>					<span class="token function">sh</span> <span class="token string">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num="65"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>		</pre></td></tr><tr><td data-num="69"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'交付镜像测试测试环境'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>				<span class="token function">sh</span> <span class="token string">"export DOCKER_HOST=tcp://192.168.40.181:2375 &amp;&amp; \</span></pre></td></tr><tr><td data-num="72"></td><td><pre>					docker rm -f spring_test &amp;&amp; \</pre></td></tr><tr><td data-num="73"></td><td><pre>					docker run -d --name spring_test -p8888:8080 <span class="token variable">$&#123;ImageName&#125;</span>:<span class="token variable">$&#123;ImageTag&#125;</span>"</pre></td></tr><tr><td data-num="74"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>			</pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="102-pipeline-cd"><a class="anchor" href="#102-pipeline-cd">#</a> 10.2 Pipeline-CD</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>pipeline <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	agent any</pre></td></tr><tr><td data-num="3"></td><td><pre> </pre></td></tr><tr><td data-num="4"></td><td><pre>	//将传参的内容设定为变量</pre></td></tr><tr><td data-num="5"></td><td><pre>	environment <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token assign-left variable">Full_Images</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;Harbor_Url&#125;</span>/<span class="token variable">$&#123;Harbor_Pro&#125;</span>/<span class="token variable">$&#123;Image_Name&#125;</span>:<span class="token variable">$&#123;Image_tags&#125;</span>"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> </pre></td></tr><tr><td data-num="9"></td><td><pre>	stages <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'获取完整镜像名称'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>				<span class="token function">sh</span> <span class="token string">'echo 镜像名称: $&#123;Full_Images&#125;'</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		</pre></td></tr><tr><td data-num="16"></td><td><pre>		stage<span class="token punctuation">(</span><span class="token string">'交付应用至Docker'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			steps <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				//这个地址可以通过传参的方式设定</pre></td></tr><tr><td data-num="19"></td><td><pre>				<span class="token function">sh</span> <span class="token string">"export DOCKER_HOST=tcp://192.168.40.182:2375 &amp;&amp; \</span></pre></td></tr><tr><td data-num="20"></td><td><pre>				docker rm -f springboot_prod &amp;&amp; \</pre></td></tr><tr><td data-num="21"></td><td><pre>				docker run -d -p 80:8080 --name springboot_prod <span class="token variable">$&#123;Full_Images&#125;</span>"</pre></td></tr><tr><td data-num="22"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/DevOps/" rel="tag"><i class="ic i-tag"></i>DevOps</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/posts/520832963.html">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2025-11-30 19:38:58" itemprop="dateModified" datetime="2025-11-30T19:38:58+08:00">2025-11-30</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Xu Yong 微信支付"><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Xu Yong 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Xu Yong<i class="ic i-at"><em>@</em></i>LinuxSre云原生</li><li class="link"><strong>本文链接：</strong><a href="http://ixuyong.cn/posts/520832963.html" title="Docker应用的CICD（九）">http://ixuyong.cn/posts/520832963.html</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/posts/516368927.html" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;REEOQig.jpeg" title="Jenkins分布式与权限（八）"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>DevOps</span><h3>Jenkins分布式与权限（八）</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#09-docker%E5%BA%94%E7%94%A8%E7%9A%84cicd"><span class="toc-number">1.</span> <span class="toc-text">09 Docker 应⽤的 CICD</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-cicd%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">1. CI&#x2F;CD 实现⽅式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E4%BC%A0%E7%BB%9F%E7%8E%AF%E5%A2%83%E7%9A%84cicd"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 传统环境的 CI&#x2F;CD</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-docker%E5%AE%9E%E7%8E%B0cicd"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 Docker 实现 CI&#x2F;CD</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">2. 部署服务组件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-%E6%9C%8D%E5%8A%A1%E5%9C%B0%E5%9D%80%E8%A7%84%E5%88%92"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 服务地址规划</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-%E9%83%A8%E7%BD%B2gitlab"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 部署 Gitlab</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23-%E9%83%A8%E7%BD%B2jenkins"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 部署 Jenkins</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%8E%B7%E5%8F%96%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.</span> <span class="toc-text">3. 获取代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#31-%E5%88%9B%E5%BB%BA%E5%87%AD%E6%8D%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 创建凭据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#32-%E7%BC%96%E5%86%99stage"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 编写 Stage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#33-%E6%A3%80%E6%9F%A5%E7%BB%93%E6%9E%9C"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 检查结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81"><span class="toc-number">1.4.</span> <span class="toc-text">4. 编译代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#41-maven%E7%8E%AF%E5%A2%83"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 maven 环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#42-%E7%BC%96%E5%86%99stage"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 编写 Stage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#43-%E6%A3%80%E6%9F%A5%E7%BB%93%E6%9E%9C"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 检查结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-number">1.5.</span> <span class="toc-text">5. 构建镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#51-%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8Ftag"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 定义镜像 Tag</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#52-%E7%BC%96%E5%86%99stage"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 编写 Stage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#53-%E6%A3%80%E6%9F%A5%E7%BB%93%E6%9E%9C"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 检查结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F%E8%87%B3%E4%BB%93%E5%BA%93"><span class="toc-number">1.6.</span> <span class="toc-text">6. 推送镜像⾄仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#61-%E5%88%9B%E5%BB%BA%E5%87%AD%E6%8D%AE"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 创建凭据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#62-%E7%BC%96%E5%86%99stage"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 编写 Stage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#63-%E6%A3%80%E6%9F%A5%E7%BB%93%E6%9E%9C"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 检查结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E4%BA%A4%E4%BB%98%E5%BA%94%E7%94%A8%E8%87%B3docker"><span class="toc-number">1.7.</span> <span class="toc-text">7. 交付应⽤⾄ Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#71-%E7%BC%96%E5%86%99stage"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 编写 Stage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#72-%E6%A3%80%E6%9F%A5%E7%BB%93%E6%9E%9C"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 检查结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%8C%96ci"><span class="toc-number">1.8.</span> <span class="toc-text">8. 实现⾃动化 CI</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#81-%E9%85%8D%E7%BD%AEjenkins"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 配置 Jenkins</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#82-%E9%85%8D%E7%BD%AEgitlab"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 配置 Gitlab</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#83-%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-number">1.8.3.</span> <span class="toc-text">8.3 验证结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-%E5%AE%9E%E7%8E%B0cd%E9%98%B6%E6%AE%B5"><span class="toc-number">1.9.</span> <span class="toc-text">9. 实现 CD 阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#91-cd%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">1.9.1.</span> <span class="toc-text">9.1 CD 实现思路</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#92-%E5%91%BD%E4%BB%A4%E8%8E%B7%E5%8F%96%E9%95%9C%E5%83%8Ftag"><span class="toc-number">1.9.2.</span> <span class="toc-text">9.2 命令获取镜像 Tag</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#93-%E5%88%9B%E5%BB%BA%E7%BA%A7%E8%81%94%E5%8F%98%E9%87%8F"><span class="toc-number">1.9.3.</span> <span class="toc-text">9.3 创建级联变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#94-%E7%BC%96%E5%86%99stage"><span class="toc-number">1.9.4.</span> <span class="toc-text">9.4 编写 Stage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-%E5%AE%8C%E6%95%B4pipeline"><span class="toc-number">1.10.</span> <span class="toc-text">10. 完整 Pipeline</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#101-pipeline-ci"><span class="toc-number">1.10.1.</span> <span class="toc-text">10.1 Pipeline-CI</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#102-pipeline-cd"><span class="toc-number">1.10.2.</span> <span class="toc-text">10.2 Pipeline-CD</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/posts/1208493697.html" rel="bookmark" title="K8S基于Jenkins实现SpringCloud微服务CI与CD实践（一）">K8S基于Jenkins实现SpringCloud微服务CI与CD实践（一）</a></li><li><a href="/posts/1366748664.html" rel="bookmark" title="K8S基于Jenkins实现Java项目CI与CD实践（二）">K8S基于Jenkins实现Java项目CI与CD实践（二）</a></li><li><a href="/posts/889219339.html" rel="bookmark" title="K8S基于Jenkins实现SpringCloud微服务CI与CD实践（三）">K8S基于Jenkins实现SpringCloud微服务CI与CD实践（三）</a></li><li><a href="/posts/2330853882.html" rel="bookmark" title="K8S基于Jenkins实现微服务应用CICD实践（四）">K8S基于Jenkins实现微服务应用CICD实践（四）</a></li><li><a href="/posts/1283421134.html" rel="bookmark" title="分布式版本控制系统Git（一）">分布式版本控制系统Git（一）</a></li><li><a href="/posts/3430284798.html" rel="bookmark" title="Jenkins快速入门实践（二））">Jenkins快速入门实践（二））</a></li><li><a href="/posts/2150338938.html" rel="bookmark" title="Jenkins FreeStyle实践（三）">Jenkins FreeStyle实践（三）</a></li><li><a href="/posts/2897649757.html" rel="bookmark" title="Jenkins Maven实践（四）">Jenkins Maven实践（四）</a></li><li><a href="/posts/1694028289.html" rel="bookmark" title="Jenkins Nexus实践（五）">Jenkins Nexus实践（五）</a></li><li><a href="/posts/2561708653.html" rel="bookmark" title="Jenkins SonarQube实践（六）">Jenkins SonarQube实践（六）</a></li><li><a href="/posts/3198692923.html" rel="bookmark" title="Jenkins Pipeine实践（七）">Jenkins Pipeine实践（七）</a></li><li><a href="/posts/516368927.html" rel="bookmark" title="Jenkins分布式与权限（八）">Jenkins分布式与权限（八）</a></li><li class="active"><a href="/posts/520832963.html" rel="bookmark" title="Docker应用的CICD（九）">Docker应用的CICD（九）</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Xu Yong" src="/assets/avatar.png"><p class="name" itemprop="name">Xu Yong</p><div class="description" itemprop="description">专注于 Linux 运维、云计算、云原⽣等技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">89</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">19</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">22</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/xyapples" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;xyapples"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://gitee.com/chinagei" class="item gitee" title="https:&#x2F;&#x2F;gitee.com&#x2F;chinagei"><i class="ic i-gitee"></i></a><a href="mailto:373370405@qq.com" class="item email" title="mailto:373370405@qq.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-about"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/posts/516368927.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Prometheus/" title="分类于Prometheus">Prometheus</a></div><span><a href="/posts/4081185382.html">Prometheus监控实战（四）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Nginx/" title="分类于Nginx">Nginx</a></div><span><a href="/posts/3682494305.html">Nginx常用模块（二）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3890389502.html">K8S持久化存储NFS+StorageClass</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Rabbitmq/" title="分类于Rabbitmq">Rabbitmq</a></div><span><a href="/posts/2692178654.html">Rabbitmq集群部署</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Docker/" title="分类于Docker">Docker</a></div><span><a href="/posts/3364424907.html">阿里云+Github构建镜像仓库</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3992668367.html">K8s配置管理Configmap</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ELKStack/" title="分类于ELKStack">ELKStack</a></div><span><a href="/posts/570469260.html">ELK收集Kubernetes组件日志分析与实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Iptables/" title="分类于Iptables">Iptables</a></div><span><a href="/posts/3327248306.html">Firewalld防火墙实战</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Shell/" title="分类于Shell">Shell</a></div><span><a href="/posts/4281775956.html">Shell循环控制-for-while</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/176412055.html">K8s准入控制ResourceQuota、LimitRange、QoS服务质量</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Xu Yong @ LinuxSre云原生</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">2.2m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">33:57</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `posts/520832963.html`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hrmmi -->