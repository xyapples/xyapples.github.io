<!-- build time:Sun Aug 24 2025 21:31:33 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico"><link rel="alternate" href="/rss.xml" title="LinuxSre云原生" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="LinuxSre云原生" type="application/atom+xml"><link rel="alternate" type="application/json" title="LinuxSre云原生" href="http://ixuyong.cn/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.17"><link rel="modulepreload" href="/js/chunk-GV364XSK.js"><link rel="modulepreload" href="/js/chunk-NYSE5UKM.js"><link rel="modulepreload" href="/js/chunk-RONCYO2S.js"><link rel="modulepreload" href="/js/chunk-THHXCRSX.js"><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/js/comments-DL2IYMPZ.js"><link rel="modulepreload" href="/js/copy-tex-NADCTXPG.js"><link rel="modulepreload" href="/js/post-DA635IH6.js"><link rel="modulepreload" href="/js/quicklink-WEDHL4BA.js"><link rel="modulepreload" href="/js/search-VCZRKTM5.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/waline-NNBYRQEE.js"><link rel="stylesheet" href="/css/comments-F4ZGS7LD.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/waline-IDNZKML2.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="preload" href="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" as="image" fetchpriority="high"><meta name="keywords" content="Prometheus"><meta name="description" content="专注于 Linux 运维、云计算、云原⽣等技术"><link rel="canonical" href="http://ixuyong.cn/posts/3386060324.html"><title>PromQL快速入门（二）</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">PromQL快速入门（二）</h1><div class="meta"><span class="item" title="创建时间：2025-08-11 22:16:53"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-08-11T22:16:53+08:00">2025-08-11</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>34k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>31 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">LinuxSre云原生</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" loading="eager" decoding="async" fetchpriority="high" alt="LinuxSre云原生"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Prometheus/" itemprop="item" rel="index" title="分类于Prometheus"><span itemprop="name">Prometheus<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://ixuyong.cn/posts/3386060324.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"><meta itemprop="name" content="Xu Yong"><meta itemprop="description" content="致力于技术布道、普及前沿技术、打造云原生系列标杆博客, 专注于 Linux 运维、云计算、云原⽣等技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LinuxSre云原生"></span><div class="body md" itemprop="articleBody"><h3 id="promql快速入门二"><a class="anchor" href="#promql快速入门二">#</a> PromQL 快速入门（二）</h3><h4 id="一-promql基础概念"><a class="anchor" href="#一-promql基础概念">#</a> 一. PromQL 基础概念</h4><h5 id="11-什么是promeql"><a class="anchor" href="#11-什么是promeql">#</a> 1.1 什么是 PromeQL</h5><p>Prometheus 内置了⼀种强⼤的查询语⾔：PromQL，即 PrometheusQuery Language。PromQL 允许⽤户实时查询监控数据，并对这些数据执⾏复杂的聚合和计算操作。</p><p>在 PromQL 中，查询的结果被称为 “向量（vector）”，分为两种类型：</p><p>1、即时向量（Instant vector）：即时向量查询返回的是⼀组时间序列数据，但每个时间序列中只包含单个的最新数据点。例如：查询当前时刻服务器 1 分钟的负载，所得到的结果就是⼀个即时向量。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/M18NeIk.jpeg" alt="1.jpg"></p><p>2、范围向量（Range vector）：范围向量查询的结果包含了⼀个时间范围内的所有数据点。例如：查询过去 1 分钟内服务器负载的变化情况，返回的数据集就是⼀个范围向量。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/VlsLPMD.jpeg" alt="2.jpg"></p><p>在 PromQL 中，除了有向量类型的数据，还有其他的数据类型，具体有：</p><p>标量（Scalar）：标量仅代表⼀个单⼀的浮点数值。可以将向量的某⼀个值通过 scalar () 函数转为标量，然后进⾏数值运算，但使⽤较少。</p><p>字符串（String）：在 PromQL 查询结果中，每个时间序列都伴随着⼀组标签，这些标签和标签值，就是使⽤字符串类型来定义。这些标签为时间序列提供了元数据信息，例如 {job=&quot;nginx&quot;,instance=&quot;<a target="_blank" rel="noopener" href="http://prom-node01.oldxu.net">prom-node01.oldxu.net</a>&quot;, method=&quot;get&quot;, url=&quot;/api&quot;} ，通过标签能很好的对数据进⾏分类和识别。</p><h5 id="12-promql应用场景"><a class="anchor" href="#12-promql应用场景">#</a> 1.2 PromQL 应⽤场景</h5><p>Prometheus 的核⼼就是 PromQL，PromQL 在⽇常的数据可视化，查询、定义告警规则都会是⽤到，因此掌握 PromQL 基本上就掌握了 Prometheus；</p><p>1、临时查询：使⽤ PromQL，你可以实时地查询监控数据，这对于调试和诊断问题⾮常有帮助。通常，我们通过 Prometheus ⾃带的表达式浏览器来执⾏这些查询。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/AJVZFdO.jpeg" alt="3.jpg"></p><p>2、数据可视化，PromQL 可以帮助我们创建数据的可视化展示，这些可视化通常是通过集成⼯具如 Grafana 来实现的，可以将我们 PromQL 查询的结果展示得更直观。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/oqN9oVU.jpeg" alt="2.jpg"></p><p>3、监控告警：Prometheus 可以直接使⽤ PromQL 对指标的查询结果来设置告警。⼀旦查询结果满⾜指定的条件，就会触发告警，⼀个完整的报警规则如下所示：</p><p>⼀个告警规则包括了告警的名称、条件、持续时间等信息。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>groups:</pre></td></tr><tr><td data-num="2"></td><td><pre>- name: 告警组</pre></td></tr><tr><td data-num="3"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="4"></td><td><pre>  - alert: 节点宕机   <span class="token comment"># 告警名称</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    expr: up <span class="token operator">==</span> <span class="token number">0</span>   <span class="token comment"># 告警条件</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    for: 1m         <span class="token comment"># 持续时间</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="8"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="9"></td><td><pre>    annotations: <span class="token comment"># 定义邮件中收到的告警详细内容</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      summary: <span class="token string">"节点宕机警告 - 实例："</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      description: <span class="token string">"作业  的节点⽆法访问，已经持续超过1分钟。"</span></pre></td></tr></table></figure><h4 id="二-promql基础使用"><a class="anchor" href="#二-promql基础使用">#</a> 二. PromQL 基础使⽤</h4><h5 id="21-指标查询"><a class="anchor" href="#21-指标查询">#</a> 2.1 指标查询</h5><p>1、查询指标的最直接⽅式是输⼊ “指标的名称”。⽐如，你想知道系统的⼀分钟负载（node_load1）情况：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查询表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_load1<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查询结果（结果展示了所有被监控节点的⼀分钟负载。）</span></pre></td></tr><tr><td data-num="5"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">0.02</span></pre></td></tr><tr><td data-num="7"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">0.13</span></pre></td></tr></table></figure><p>2、但是，在实际监控时，我们通常只需要关注 “特定节点” 的指标数据。例如，如果我只想查看 <a target="_blank" rel="noopener" href="http://prom-node01.oldxu.net">prom-node01.oldxu.net</a> 这个节点的⼀分钟负载情况，那么就可需要是⽤ “标签匹配器” 来筛选出所需的指标。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查询表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查询结果（由于指定了过滤条件，因此只会展示 node01 节点的 1 分钟负载）</span></pre></td></tr><tr><td data-num="5"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">0.35</span></pre></td></tr></table></figure><p>3、因此，标签匹配器就是通过标签和标签值，来筛选出我们所需要的指标数据。使⽤标签匹配器时，可以按照以下语法构造查询表达式：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>metric_name<span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token operator">&lt;</span>label_name<span class="token operator">>=</span><span class="token operator">&lt;</span>label_value<span class="token operator">></span>, <span class="token operator">&lt;</span>label_name<span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token operator">=~</span><span class="token operator">&lt;</span>regex<span class="token operator">></span>, <span class="token punctuation">..</span>.<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>其中各个部分的含义如下：</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># = 表示⼀个标签必须严格等于⼀个给定的值。</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># != 表示排除等于特定值的标签。</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># =~ 表示标签的值必须匹配⼀个正则表达式。</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># !~ 表示标签的值不应匹配⼀个正则表达式。</span></pre></td></tr></table></figure><p>实例 1：查询所有实例，CPU 的第 0 个核⼼，中的 user ⽤户空间所占⽤ CPU 的时间，指标名称：node_cpu_seconds_total</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>cpu<span class="token operator">=</span><span class="token string">"0"</span>,mode<span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>实例 2：查询所有实例，eth0 ⽹卡发送总⼤⼩，指标名称：node_network_transmit_bytes_total</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>node_network_transmit_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 转为 GB</span></pre></td></tr><tr><td data-num="4"></td><td><pre>node_network_transmit_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span><span class="token punctuation">&#125;</span> / <span class="token number">1024</span> /1024 /1024</pre></td></tr></table></figure><p>实例 3：查询所有实例的⽹卡接收字节数，排除 lo 接⼝，指标名称：node_network_receive_bytes_total</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>node_network_receive_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"lo"</span>,device<span class="token operator">!=</span><span class="token string">"docker0"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_network_receive_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">!</span>~<span class="token string">"lo|docker0"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 转为 GB</span></pre></td></tr><tr><td data-num="5"></td><td><pre>node_network_receive_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"lo"</span>,device<span class="token operator">!=</span><span class="token string">"docker0"</span><span class="token punctuation">&#125;</span> /1024 /102</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">4</span> /1024</pre></td></tr></table></figure><p>实例 4：查询：挂载点以 /run 开头的⽂件系统可⽤字节数，指标名称 node_filesystem_avail_bytes</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>mountpoint<span class="token operator">=~</span><span class="token string">"^/run.*"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 字节转 MB</span></pre></td></tr><tr><td data-num="4"></td><td><pre>node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>mountpoint<span class="token operator">=~</span><span class="token string">"^/run.*"</span><span class="token punctuation">&#125;</span> /1024/1024</pre></td></tr></table></figure><p>实例 5：块设备名字不包含 vda 和 sr0 的读字节数，指标名称 node_disk_read_bytes_total</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>node_disk_read_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">!</span>~<span class="token string">".*sr0.*"</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="22-时间范围查询"><a class="anchor" href="#22-时间范围查询">#</a> 2.2 时间范围查询</h5><p>在 Prometheus 中，范围向量选择器使我们能够提取时间序列中⼀段时间范围内的数据点。要定义⼀个范围向量选择器，你只需要在指标名称后⾯加上⽅括号 []，并在其中指定⼀个时间⻓度。时间⻓度有：s 秒，m 分钟，h ⼩时，d 天，w 周，y 年。使⽤范围向量选择器，你可以灵活查询从最近⼏分钟到⼏年的数据，便于分析和监控指标随时间的变化。</p><p>1、例如，我们想查询 prom-node01.oldxu.net 这个实例，在过去 2 分钟，负载所有数据点。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>2m<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">0</span> @1751165619.66</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">0</span> @1751165634.66</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">0</span> @1751165649.66</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">0</span> @1751165664.66</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">0</span> @1751165679.66</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">0</span> @1751165694.66</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">0</span> @1751165709.66</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">0</span> @1751165724.66</pre></td></tr></table></figure><p>2、在 Prometheus 中，通常使⽤相对时间（如过去⼏分钟、⼩时或天）来查询数据。但是，如果你需要查询⼀个绝对时间点的数据，您可以直接使⽤ UNIX 时间戳来指定查询的具体时间。（在 Prometheus 中通常是以毫秒为单位的）</p><p>例如，查询 2025 年 6 ⽉ 29 ⽇上午 10:58:10 的 <a target="_blank" rel="noopener" href="http://prom-node01.oldxu.net">prom-node01.oldxu.net</a> 实例的负载状态。需要先将时间转为 UNIX 时间戳，然后执⾏如下查询语句。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#指定时间查询表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> @ <span class="token number">1751165890</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 查询结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span>  <span class="token number">0.27</span></pre></td></tr></table></figure><h5 id="23-时间偏移查询"><a class="anchor" href="#23-时间偏移查询">#</a> 2.3 时间偏移查询</h5><p>除了能够查询过去⼏分钟或⼏⼩时的数据，以及查询指定时间点的数据，同时 Prometheus 也允许您通过 offset 修饰符来指定查询从当前时间往回推某个具体的时间段。这种⽅式常⽤于⽐较，例如：今天 QPS 是 10000，昨天这个时间是 5000，我们就可以计算它们的增⻓率之类的。</p><p>1、如果您想要查看昨天整天的数据，可以使⽤以下查询表达式：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 假设是⽤如下表达式查询的结果是 2023-12-26 17:20</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_load1</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 那么如下表达式查询的数据将返回：(2023-12-24 17:20 - 2023-12-25 17:20)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>node_load1<span class="token punctuation">[</span>1d<span class="token punctuation">]</span> offset 1d</pre></td></tr></table></figure><p>2、如果想要查看⼀周前的 “时间范围内” 的数据，可以使⽤如下查询：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查询表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_load1<span class="token punctuation">[</span>5m<span class="token punctuation">]</span> offset 1w</pre></td></tr></table></figure><p>这个查询会返回当前时间往回推⼀周，并从那个时间点开始，持续 5 分钟的数据范围内的 node_load1 指标。例如，如果现在是 12 ⽉ 26 ⽇星期⼀下午 17:30，那么该查询将返回 12 ⽉ 19 ⽇星期⼀下午 17:25 到 17:30 这 5 分钟范围内的所有数据点。</p><p>3、对⽐分析实战：对⽐ “当前时间点接收的⽹络流量” 与 “1 ⼩时前的流量” 进⾏⽐对分析，以判断流量是增⻓还是减少。</p><ul><li>计算同环⽐的增⻓率或减少率的公式：同环⽐率 =(当前流量−过去 1 ⼩时的流量) / 过去 1 ⼩时的流量 ×100</li><li>例如，如果当前总接收流量是 6000MB，⽽ 1 ⼩时前接收的总流量是 5000MB，</li><li>那么计算公式为： （6000 - 5000） / 5000 * 100 = 20% （意味着相⽐ 1 ⼩时前，当前流量增⻓了 20%）</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>node_network_receive_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span><span class="token punctuation">&#125;</span> - node_network_receive_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span><span class="token punctuation">&#125;</span> offset 1h<span class="token punctuation">)</span> / node_network_receive_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span><span class="token punctuation">&#125;</span> offset 1h * <span class="token number">100</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token parameter variable">-87.68874820331817</span> <span class="token comment"># 负增⻓ 80%</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">4231.893284128109</span>  <span class="token comment"># 增⻓ 4231%</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">24.658781604740295</span> <span class="token comment"># 增⻓ 24%</span></pre></td></tr></table></figure><h4 id="三-promql常用函数"><a class="anchor" href="#三-promql常用函数">#</a> 三. PromQL 常⽤函数</h4><h5 id="31-count类型常用函数"><a class="anchor" href="#31-count类型常用函数">#</a> 3.1 Count 类型常⽤函数</h5><p>前⾯我们讲过，Counter 类型的监控指标只增不减，因此其样本值应该是不断增⼤的。因此单纯的 Counter 总数并没有直接作⽤，⽽是需要借助于 rate、irate、increase 和等函数来计算样本数据的变化状况（增⻓率）；</p><p>1、rate ⽤于计算平均增⻓速率：计算公式：通过指定时间范围内的样本，使⽤最后⼀个样本的值减去第⼀个样本的值，⽽后除以这两个样本之间的间隔时⻓。</p><p>例如： rate (nginx_http_requests_total [1m]) ，表示要获取 1 分钟内，该指标上的 http 总请求数的平均增⻓速率；</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/luPGWpV.jpeg" alt="1.jpg"></p><p>2、irate ⽤于计算瞬时的增⻓速率（灵敏度较⾼）：计算公式：通过指定时间范围内的样本最后⼀个样本的值减去前⼀个样本的值，⽽后除以这两个样本之间的间隔时⻓。</p><p>例如： irate (nginx_http_requests_total [1m]) ，表示要获取 1 分钟内，该指标上的 http 总请求数的瞬时增⻓速率；</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/yCfZc4S.jpeg" alt="4.jpg"></p><p>3、increase ⽤于计算指定时间范围内样本值的增加量：计算公式：通过指定时间范围内的样本最后⼀个样本的值减去第⼀个样本的值。注意：increase 可能会引⽤时间范围边界之前的样本值，以便于计算能覆盖到指定的整个时间范围。</p><p>例如： increase (nginx_http_requests_total [1m]) ，表示要获取 1 分钟内，http 请求的增量；</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/lwmN3vP.jpeg" alt="2.jpg"></p><h5 id="32-gauge类型常用函数"><a class="anchor" href="#32-gauge类型常用函数">#</a> 3.2 Gauge 类型常⽤函数</h5><p>Gauge 类型的指标，存储的值是随着时间会变发⽣变化的，它常⽤求和、取平均值、最⼩值、最⼤值等；也会结合 PromQL 的 predict_linear 和 delta 函数使⽤；</p><p>1、predict_linear (v range-vector, t, scalar)：预测时间序列 v 在 t 秒后的值，它通过线性回归的⽅式来预测样本数据的变化趋势；</p><p>例如： predict_linear (node_filesystem_avail_bytes [4h], 60*60*24*30) ，使⽤过去 4 ⼩时的数据来预测接下来 30 天（60*60*24*30）</p><p>的磁盘空间趋势。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>predict_linear<span class="token punctuation">(</span>node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>mountpoint<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>4h<span class="token punctuation">]</span>, <span class="token number">60</span>*60*24*30<span class="token punctuation">)</span> /1024 /1024 /1024</pre></td></tr></table></figure><p>2、delta (v range-vector)：计算范围向量中每个时间序列上的第⼀个样本值与最后⼀个样本值之差；其计算结果与 increase 函数相同；但 delta 更适⽤于没有重置的场景，或者⽤来监控那些可能上升或下降的指标，例如温度、磁盘空间等。</p><p>例如： delta (cpu_temp_celsius {host=&quot;<a target="_blank" rel="noopener" href="http://prom01.oldxu.net">prom01.oldxu.net</a>&quot;}[2h]) ，返回该服务器上的 CPU 温度与 2 ⼩时之前的差异；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>delta<span class="token punctuation">(</span>cpu_temp_celsius<span class="token punctuation">&#123;</span>host<span class="token operator">=</span><span class="token string">"prom01.oldxu.net"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>2h<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>例如： delta (node_filesystem_avail_bytes [10m]) /1024 /1024 ，返回服务器上磁盘可⽤空间与 10 分钟之前的差异；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>delta<span class="token punctuation">(</span>node_filesystem_avail_bytes<span class="token punctuation">[</span>10m<span class="token punctuation">]</span><span class="token punctuation">)</span> /1024 /1024</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#创建大文件</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># dd if=/dev/zero of=/bigdata count=1 bs=200M</span></pre></td></tr></table></figure><p>3、changes () ：计算监控时间范围内某个时间序列的数据变化的次数。它只关⼼变化的次数，⽽不关⼼具体变化的值是什么。</p><p>例如： changes (nginx_up [10m]) 监控 Nginx 服务在给定时间内变化的次数，如果停⽌了变化次数 + 1，启动了变化次数 + 1。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>changes<span class="token punctuation">(</span>up<span class="token punctuation">[</span>10m<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#模式测试</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node02 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop node_exporter</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@prom-node02 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start node_exporter</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:3000"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"grafana"</span><span class="token punctuation">&#125;</span>         <span class="token number">0</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9090"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"prometheus"</span><span class="token punctuation">&#125;</span>      <span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span>   <span class="token number">0</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span>   <span class="token number">2</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span>   <span class="token number">0</span></pre></td></tr></table></figure><h4 id="四-promql二元运算符"><a class="anchor" href="#四-promql二元运算符">#</a> 四. PromQL ⼆元运算符</h4><p>PromQL 提供了⼀系列⼆元运算符，包括算术运算 (+ - * /)、⽐较运算 ( == &lt;= &gt;=)、以及集合运算 ( and or unless)。在 PromQL 中，⽤户可以执⾏以下类型的运算：</p><ul><li><p>1、标量与标量之间的运算</p></li><li><p>2、即时向量与标量之间的运算</p></li><li><p>3、两个即时向量之间的运算。（当涉及到两个即时向量的运算时标签必须一致，PromQL 遵循向量匹配机制（Vector Matching），定义其运算逻辑）</p></li></ul><h5 id="41-算术运算符介绍"><a class="anchor" href="#41-算术运算符介绍">#</a> 4.1 算术运算符介绍</h5><p>在 PromQL 中算术运算符，是⽤来对指标数据执⾏基本的数学运算。⽀持的运算符有：+（加）、-（减）、*（乘）、/（除）、%（取模）和 ^（幂运算）</p><p>1、标量与标量之间进⾏数学运算，其最终得到的也是标量（使⽤较少）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 标量与标量算数运算表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">5</span> + <span class="token number">5</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre>scalar <span class="token number">10</span></pre></td></tr></table></figure><p>2、即时向量与标量进⾏运算，例如将 node_memory_MemTotal_bytes （节点内存总⼤⼩）的默认 bytes 单位转为 MB</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 即时向量与标量算数运算表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_memory_MemTotal_bytes / <span class="token number">1024</span> /1024</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">1970.05859375</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">1970.05859375</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">1970.05859375</span></pre></td></tr></table></figure><p>3、即时向量与即时向量进⾏运算，它们需要遵循向量的匹配逻辑，也就是向量与向量的标签必须完全匹配⼀致才可以进⾏运算，如果它们的标签不⼀致，则不会执⾏这个运算。例如：我们想计算内存的可⽤百分⽐，计算公式为 “（内存可⽤空间 / 内存总空间 * 100）= 内存可⽤百分⽐” 这两个向量的标签是完全⼀致的，因此可以直接进⾏运算，否则⽆法正常进⾏运算，除⾮进⾏向量匹配特殊的处理。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 即时向量与即时向量算数运算表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * <span class="token number">100</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">52.0608325815</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">18234</span> <span class="token comment"># 可⽤内存还有 52%</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">70.7339367682</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">1954</span> <span class="token comment"># 可⽤内存还有 70%</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">41.0098446469</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">1128</span> <span class="token comment"># 可⽤内存还有 41%</span></pre></td></tr></table></figure><h5 id="42-算术运算符实践"><a class="anchor" href="#42-算术运算符实践">#</a> 4.2 算术运算符实践</h5><p>实例 1：计算所有实例节点的 eth0 ⽹卡，接收的总流量和发送的总流量之和（以 GB 显示）</p><ul><li>node_network_receive_bytes_total ：节点⽹络接收的总⼤⼩（以字节为单位）</li><li>node_network_transmit_bytes_total ：节点⽹络发送的总⼤⼩（以字节为单位）</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式（ 计算公式：(eth0 接收的总流量 + eth0 发送的总流量) /1024 / 1024 /1024 ）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>node_network_receive_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span><span class="token punctuation">&#125;</span> + node_network_transmit_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> /1024 /1024 /1024</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">65.10437232814729</span> <span class="token comment"># 65GB</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">19.22064190544188</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">35.516745982691646</span></pre></td></tr></table></figure><p>实例 2：计算所有实例节点的 / 分区 已经使⽤了，多少空间（以 GB 显示）</p><ul><li>node_filesystem_size_bytes ：⽂件系统总⼤⼩（以字节为单位）</li><li>node_filesystem_avail_bytes ：⽂件系统可⽤空间（以字节为单位）</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式（ 计算公式：(总空间 - 剩余空间) /1024 / 1024 /1024 ）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>node_filesystem_size_bytes<span class="token punctuation">&#123;</span>mountpoint<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> - node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>mountpoint<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> /1024 /1024 /1024</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"/dev/mapper/rl-root"</span>, <span class="token assign-left variable">fstype</span><span class="token operator">=</span><span class="token string">"xfs"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mountpoint</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> <span class="token number">7.806545257568359</span>  <span class="token comment"># 已使⽤ 7.8G</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"/dev/mapper/rl-root"</span>, <span class="token assign-left variable">fstype</span><span class="token operator">=</span><span class="token string">"xfs"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mountpoint</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> <span class="token number">3.9103240966796875</span> <span class="token comment"># 已使⽤ 3.9G</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"/dev/mapper/rl-root"</span>, <span class="token assign-left variable">fstype</span><span class="token operator">=</span><span class="token string">"xfs"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mountpoint</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> <span class="token number">5.496803283691406</span>  <span class="token comment"># 已使⽤ 5.4G</span></pre></td></tr></table></figure><p>实例 3：计算所有实例节点的 / 分区 &quot;已⽤空间百分⽐&quot;</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式（ 计算公式：(总空间 - 可⽤的空间) / 总空间 * 100 ）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>node_filesystem_size_bytes<span class="token punctuation">&#123;</span>mountpoint<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> - node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>mountpoint<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> / node_filesystem_size_bytes<span class="token punctuation">&#123;</span>mountpoint<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> * <span class="token number">100</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"/dev/mapper/rl-root"</span>, <span class="token assign-left variable">fstype</span><span class="token operator">=</span><span class="token string">"xfs"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mountpoint</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> <span class="token number">3.965885742336228</span>  <span class="token comment"># 已⽤空间占⽐百分之 3.96G</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"/dev/mapper/rl-root"</span>, <span class="token assign-left variable">fstype</span><span class="token operator">=</span><span class="token string">"xfs"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mountpoint</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> <span class="token number">1.9864746546908878</span> <span class="token comment"># 已⽤空间占⽐百分之 1.98G</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"/dev/mapper/rl-root"</span>, <span class="token assign-left variable">fstype</span><span class="token operator">=</span><span class="token string">"xfs"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mountpoint</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> <span class="token number">2.792465443218097</span>  <span class="token comment"># 已⽤空间占⽐百分之 2.79G</span></pre></td></tr></table></figure><p>实例 4：计算所有节点内存的 “已⽤百分⽐”</p><ul><li>node_memory_MemTotal_bytes ：总内存⼤⼩（单位字节）</li><li>node_memory_MemAvailable_bytes ：内存可⽤⼤⼩（单位字节）</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式（ 计算公式：(总内存 - 可⽤内存) / 总内存 * 100 ）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes<span class="token punctuation">)</span> / node_memory_MemTotal_bytes * <span class="token number">100</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">48.12356865972023</span>  <span class="token comment"># 已⽤ 48% 内存</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">29.767713920310907</span> <span class="token comment"># 已⽤ 29% 内存</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">58.8624624505537</span>   <span class="token comment"># 已⽤ 58% 内存</span></pre></td></tr></table></figure><h5 id="43-比较运算符介绍"><a class="anchor" href="#43-比较运算符介绍">#</a> 4.3 ⽐较运算符介绍</h5><p>在 PromQL 中⽐较运算符，是⽤来对指标的数据进⾏条件判断，⼀般在告警规则中定义何时应该触发告警。PromQL ⽀持的⽐较运算符有如下⼏个：</p><ul><li>== ：等于，当两边的数值相等时为真。</li><li>!= ：不等于，当两边的数值不相等时为真。</li><li>&gt; ：⼤于，当左边的数值⼤于右边时为真。</li><li>&lt; ：⼩于，当左边的数值⼩于右边时为真。</li><li>&gt;= ：⼤于等于，当左边的数值⼤于或等于右边时为真。</li><li>&lt;= ：⼩于等于，当左边的数值⼩于或等于右边时为真。</li></ul><p><em>在 PromQL 中，使⽤⽐较运算符时，默认情况下，如果⽐较结果为假（即条件不满⾜），则相关的时间序列不会出现在结果中。但是，如果在测试时，想要明确地看到哪些时间序列满⾜条件（为真）和哪些不满⾜（为假），可以使⽤ bool 修饰符，这个修饰符会将所有的时间序列都显示在结果中，满⾜条件的序列会有⼀个值为 1（true），不满⾜的序列会有⼀个值为 0（false）。</em></p><p>1、标量与标量之间进⾏⽐较运算</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 标量与标量⽐较表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">5</span> <span class="token operator">==</span> bool <span class="token number">5</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre>scalar <span class="token number">1</span> <span class="token comment"># 说明条件成⽴</span></pre></td></tr></table></figure><p>2、即时向量与标量进⾏⽐较运算，例如判断服务器 1 分钟的负载，是否有⼤于 0 以上的节点</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 即时向量与标量进⾏⽐较表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_load1 <span class="token operator">></span> <span class="token number">0</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">0.01</span></pre></td></tr><tr><td data-num="6"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">0.01</span></pre></td></tr></table></figure><p>3、即时向量与即时向量进⾏⽐较运算，它们需要遵循向量的匹配逻辑，也就是向量与向量的标签必须完全匹配⼀致才可以进⾏运算，如果它们的标签不⼀致，则不会执⾏这个运算。例如：我们可以⽐较 “可⽤内存” 是否⼤于 “空闲内存”，如果满⾜该条件，那么会显示左侧的指标名称和指标当前的值。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 即时向量与即时向量⽐较表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_memory_MemAvailable_bytes <span class="token operator">></span> node_memory_MemFree_bytes</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre>node_memory_MemAvailable_bytes<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">1092820992</span> </pre></td></tr><tr><td data-num="6"></td><td><pre>node_memory_MemAvailable_bytes<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">1456451584</span></pre></td></tr><tr><td data-num="7"></td><td><pre>node_memory_MemAvailable_bytes<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">867491840</span></pre></td></tr></table></figure><h5 id="44-比较运算符实践"><a class="anchor" href="#44-比较运算符实践">#</a> 4.4 ⽐较运算符实践</h5><p>实例 1：查询 node_exporter 这个 job 中，⽬前不存活实例有哪些（1 为存活、0 为不存活）。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>up<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token operator">!=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre>up<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">0</span> <span class="token comment"># 0 表</span></pre></td></tr><tr><td data-num="6"></td><td><pre>示该节点⽬前不存活</pre></td></tr></table></figure><p>实例 2：查询所有实例 “已使⽤内存” 超过 30%</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式：（计算公式：（总内存 - 可⽤内存）/ 总内存 * 100 ⼤于 30 ）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes<span class="token punctuation">)</span> / node_memory_MemTotal_bytes * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">30</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">48.04405801699267</span> <span class="token comment"># 该节点已使⽤内存达到 48%</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">58.090753170015965</span> <span class="token comment"># 该节点已使⽤内存达到 58%</span></pre></td></tr></table></figure><p>实例 3：查询所有的实例 “磁盘可⽤空间” 不⾜ 30% 的实例</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式：（计算公式：（可⽤空间 / 总磁盘空间） * 100 ⼩于 30 ）</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_filesystem_avail_bytes / node_filesystem_size_bytes * <span class="token number">100</span> <span class="token operator">&lt;</span> <span class="token number">30</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"/dev/mapper/rl-root"</span>, <span class="token assign-left variable">fstype</span><span class="token operator">=</span><span class="token string">"xfs"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mountpoint</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span> <span class="token number">26.02939746145283</span> <span class="token comment"># 剩余空间仅剩 26%，意味着磁盘空间快⽤完了</span></pre></td></tr></table></figure><p>实例 4：查询所有实例中 eth0 设备的⽹络带宽，每秒发送速率超过 200Mb/s 兆 的实例</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1、在两个测试的节点上安装：yum install iperf -y</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 2、服务端运⾏并指定端⼝：iperf -s -p 9999</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 3、客户端模拟带宽发送命令，-b 指定发送⼤⼩，-t 指定发送持续时⻓：iperf -c &lt;ip> -p 9999 -b 300M -t 60</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 表达式（计算公式：rate (总的传输 [1m]) * 8 /1024/1024) > 200） ⽹络速度或带宽通常以位每秒（如 Mbps, Gbps）为单位。因此需要将字节乘以 8，能够将字节转换为位，这样可以更准确地描述传输速率</span></pre></td></tr><tr><td data-num="5"></td><td><pre>rate<span class="token punctuation">(</span>node_network_transmit_bytes_total<span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> * <span class="token number">8</span> /1024 /1024 <span class="token operator">></span> <span class="token number">200</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"eth0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">286.0319371541341</span> <span class="token comment"># 该节点每秒达到了 286Mb/s 的带宽（如果不乘以 8 则单位是 MB/s）</span></pre></td></tr></table></figure><p>实例 5：查询所有 https 的域名，检查域名证书的过期时间，将还剩不到 90 天的域名列出来（需要借助后⾯的 blackbox ⿊盒监控，才能获取到对应的指标）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式，计算公式（ (过期时间 - 当前时间) / 天 (24*60*60) ）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>probe_ssl_earliest_cert_expiry - time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> / <span class="token number">86400</span> <span class="token operator">&lt;</span> <span class="token number">90</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"http://hmallleasing.com"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"blackbox_http"</span><span class="token punctuation">&#125;</span> <span class="token number">43.74673421296256</span>       <span class="token comment"># 还剩 43 天过期</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"https://ixuyong.cn"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"blackbox_http"</span><span class="token punctuation">&#125;</span> <span class="token number">87.74673421296256</span>            <span class="token comment"># 还剩 87 天过期</span></pre></td></tr></table></figure><h5 id="45-集合运算符介绍"><a class="anchor" href="#45-集合运算符介绍">#</a> 4.5 集合运算符介绍</h5><p>在 Prometheus 的查询语⾔中，集合运算符主要⽤到的运算符包括 and（并且）、or（或者）和 unless（排除）</p><p>例如：我们有两个关键指标：backup_duration_seconds ⽤于记录每次备份操作的持续时间，⽽ backup_success 则指示备份操作是否成功（1 表示成功，0 表示失败）</p><p><strong>场景 1：备份成功但时间超过 9s</strong></p><p>当备份操作成功完成（backup_success == 1），并且执⾏时间超过 9 秒（backup_duration_seconds &gt; 9）时，我们需要发出告警通知 “备份成功但备份时间过⻓”。这就需要使⽤ and 运算符来确保只有当这两个条件都满⾜时，才触发告警。对应的表达式为：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>backup_duration_seconds <span class="token operator">></span> <span class="token number">9</span> and backup_success <span class="token operator">==</span> <span class="token number">1</span></pre></td></tr></table></figure><p><strong>场景 2：备份失败或时间超过 9s</strong></p><p>如果备份时⻓超过了 9 秒（backup_duration_seconds &gt; 9），或者备份操作失败（backup_success == 0），则同样需要发出告警通知 “备份失败或时间过⻓”。在这种情况下，是⽤ or 运算符可以帮助我们在任⼀条件满⾜时触发告警。对应的表达式为：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>backup_duration_seconds <span class="token operator">></span> <span class="token number">9</span> or backup_success <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr></table></figure><p><strong>场景 3：查询成功的备份，但排除耗时超过 9s</strong></p><p>查询所有成功的备份任务，同时排除那些执⾏时间超过 9 秒的任务，这样我们就可以只关注于那些成功备份的任务，并且备份效率较⾼的。我们可以利⽤ unless 运算符来实现，对应的表达式为：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>backup_success <span class="token operator">==</span> <span class="token number">1</span> unless backup_duration_seconds <span class="token operator">></span> <span class="token number">9</span></pre></td></tr></table></figure><p>1、and 运算符示例，查询当前实例 “1 分钟负载⼤于 2，并且 5 分钟负载⼩于</p><p>2、如果满⾜条件说明当前发了了突增的负载压⼒。注意：and 运算需要遵循向量的匹配逻辑，也就是向量与向量的标签必须完全匹配⼀致才可以进⾏匹配，如果它们的标签不⼀致，则不会执⾏匹配逻辑，除⾮使⽤ ignore 忽略不⼀致的标签来进⾏匹配。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 模拟负载⾼命令 stress --cpu 8 --timeout 60</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="3"></td><td><pre>node_load1 <span class="token operator">></span> <span class="token number">2</span> and</pre></td></tr><tr><td data-num="4"></td><td><pre>node_load5 <span class="token operator">&lt;</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="7"></td><td><pre>node_load1<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">4.19</span> <span class="token comment"># 说明当前 node03 节点 1 分钟负载⽐较⾼，⽽ 5 分钟负载并不⾼</span></pre></td></tr></table></figure><p>2、or 示例，查询 <a target="_blank" rel="noopener" href="http://prom-node01.oldxu.net:9100">prom-node01.oldxu.net:9100</a> 上 CPU 编号为 0 的 idle 时间或 user 时间</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,mode<span class="token operator">=</span><span class="token string">"idle"</span>,cpu<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">&#125;</span> or</pre></td></tr><tr><td data-num="3"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,mode<span class="token operator">=</span><span class="token string">"user"</span>,cpu<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="6"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>cpu<span class="token operator">=</span><span class="token string">"0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mode</span><span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span> <span class="token number">6429449.35</span></pre></td></tr><tr><td data-num="7"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>cpu<span class="token operator">=</span><span class="token string">"0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mode</span><span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">&#125;</span> <span class="token number">26207.44</span></pre></td></tr></table></figure><p>3、unless 示例，查询 node_cpu_seconds_total 指标上 CPU 编号为 0 的，但要排除 node02 和 node03 节点，同时还要排除模式为 idle|user|system|steal|nice</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>cpu<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">&#125;</span> unless</pre></td></tr><tr><td data-num="3"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> unless</pre></td></tr><tr><td data-num="4"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> unless</pre></td></tr><tr><td data-num="5"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=~</span><span class="token string">"idle|user|system|steal|nice"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="8"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>cpu<span class="token operator">=</span><span class="token string">"0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mode</span><span class="token operator">=</span><span class="token string">"iowait"</span><span class="token punctuation">&#125;</span> <span class="token number">3243.97</span></pre></td></tr><tr><td data-num="9"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>cpu<span class="token operator">=</span><span class="token string">"0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mode</span><span class="token operator">=</span><span class="token string">"irq"</span><span class="token punctuation">&#125;</span> <span class="token number">7236.66</span></pre></td></tr><tr><td data-num="10"></td><td><pre>node_cpu_seconds_total<span class="token punctuation">&#123;</span>cpu<span class="token operator">=</span><span class="token string">"0"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">mode</span><span class="token operator">=</span><span class="token string">"softirq"</span><span class="token punctuation">&#125;</span> <span class="token number">4117.61</span></pre></td></tr></table></figure><h5 id="46-集合运算符实践"><a class="anchor" href="#46-集合运算符实践">#</a> 4.6 集合运算符实践</h5><p>实例 1：查询实例的⽹络接收流量 “并且” ⽹络发送流量，每秒传输超过 200Mb/s</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#模拟接收和发送流量⽐较⾼："需要在同⼀节点" 模拟服务端和客户端，执⾏如下命令</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 1、模拟服务端：iperf -s -p 9999</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 2、模拟客户端：iperf -c prom-node01.oldxu.net -p 9999 -b 300M -t 60</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="5"></td><td><pre>rate<span class="token punctuation">(</span>node_network_receive_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> *8 /1024 /1024 <span class="token operator">></span><span class="token number">200</span> and</pre></td></tr><tr><td data-num="6"></td><td><pre>rate<span class="token punctuation">(</span>node_network_transmit_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> *8 /1024 /1024 <span class="token operator">></span><span class="token number">200</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span>device<span class="token operator">=</span><span class="token string">"lo"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">300.4421537611219</span> <span class="token comment"># 这个实例发送和接收同时达到了 300Mb/s</span></pre></td></tr></table></figure><p>实例 2：查询当前磁盘，可⽤空间不⾜ 20GB “或者” 当前磁盘可⽤空间不⾜ 30%</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式，计算公式： 可⽤空间 / 1024/1024/1024 &lt;= 20 OR （可⽤空间 / 总磁盘空间） *100 &lt; 30 </span></pre></td></tr><tr><td data-num="2"></td><td><pre>node_filesystem_avail_bytes /1024 /1024 /1024 <span class="token operator">&lt;=</span><span class="token number">20</span> or </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span> node_filesystem_avail_bytes / node_filesystem_size_bytes<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">&lt;</span> <span class="token number">30</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr></table></figure><p>实例 3：通过 probe_http_status_code 指标获取当前监控的⽹站返回的状态码，并从中筛选出⼩于 200 的状态码 “或者” ⼤于 400 的状态码</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>probe_http_status_code <span class="token operator">&lt;=</span> <span class="token number">199</span> or</pre></td></tr><tr><td data-num="3"></td><td><pre>probe_http_status_code <span class="token operator">>=</span> <span class="token number">400</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="6"></td><td><pre>probe_http_status_code<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"https://httpstat.us/102"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"blackbox_http"</span><span class="token punctuation">&#125;</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre>probe_http_status_code<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"http://httpbin.org/status/400"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"blackbox_http"</span><span class="token punctuation">&#125;</span> <span class="token number">400</span></pre></td></tr><tr><td data-num="8"></td><td><pre>probe_http_status_code<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"https://httpstat.us/421"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"blackbox_http"</span><span class="token punctuation">&#125;</span> <span class="token number">421</span></pre></td></tr><tr><td data-num="9"></td><td><pre>probe_http_status_code<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"https://httpstat.us/500"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"blackbox_http"</span><span class="token punctuation">&#125;</span> <span class="token number">500</span></pre></td></tr><tr><td data-num="10"></td><td><pre>probe_http_status_code<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"https://httpstat.us/502"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"blackbox_http"</span><span class="token punctuation">&#125;</span> <span class="token number">502</span></pre></td></tr></table></figure><h4 id="五-promql聚合操作"><a class="anchor" href="#五-promql聚合操作">#</a> 五. PromQL 聚合操作</h4><h5 id="51-promql聚合介绍"><a class="anchor" href="#51-promql聚合介绍">#</a> 5.1 PromQL 聚合介绍</h5><p>聚合运算，是数据处理中的⽐较常⻅操作，例如统计公司所有⼈员的年龄，求公司整体的平均年龄，最⼤年龄，或最⼩年龄等。因此聚合操作它是从⼀组数据值中，计算出⼀个单⼀的值。</p><p>Prometheus 的聚合操作与此前刚才所描述的常规聚合在本质上是相似的，只不过它⽀持多种聚合运算函数，包括:</p><ul><li><p>max ：计算⼀组时间序列中的最⼤值。</p></li><li><p>min ：计算⼀组时间序列中的最⼩值。</p></li><li><p>avg ：计算时间序列的平均值。</p></li><li><p>sum ：计算时间序列值的总和。</p></li><li><p>count ：它不考虑时间序列的具体值，仅⽤来统计时间序列的数量。例如统计不同 OS 的数量，或者统计有多少个正在运⾏的 Pod 等等。</p></li><li><p>count_vaules ：对每个样本的值进⾏数量统计，例如：http 请求的状</p></li><li><p>态码，200 出现了多少次，404 出现了多少次，500 出现了多少次；</p></li><li><p>topk ：</p></li><li><p>bottomk ：</p></li></ul><p>除了这些基本聚合功能外，Prometheus 也提供了分组聚合的功能，它是基于时间序列的标签进⾏分组聚合：</p><ul><li>by ：通过 by 关键字，明确指定保留哪些标签进⾏聚合，其他的标签将被忽略。</li><li>without ：与 by 相反， without 关键字⽤于指定要排除的标签，⽽剩下的标签则⽤于聚合和分组。</li></ul><h5 id="52-promql聚合示例"><a class="anchor" href="#52-promql聚合示例">#</a> 5.2 PromQL 聚合示例</h5><p>为了加深 PromQL 聚合操作的理解，我们使⽤前⾯提到的城市天⽓温度数据，并通过聚合操作来展示如何获取整体的最⾼温度、最低温度以及按城市维度进⾏分组求取平均温度等。</p><p>1、下载并运⾏程序，提供天⽓温度相关的指标数据</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/prometheus/exporter/weather_exporter_oldxu</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># mv weather_exporter_oldxu /usr/local/bin/</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /usr/local/bin/weather_exporter_oldxu</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 启动脚本</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># vim /usr/lib/systemd/system/weather_exporter.service</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>weather_exporter</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/weather_exporter_oldxu <span class="token parameter variable">--port</span> <span class="token number">7001</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start weather_exporter.service</span></pre></td></tr></table></figure><p>2、编辑 Prometheus 配置⽂件，抓取对应的指标数据</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  - job_name: <span class="token string">"weather-exporter"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    scrape_interval: 1m <span class="token comment"># 抓取指标频率</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="5"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 重新加载 prometheus</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><p>示例 1：获取所有城市的整体温度总和</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sum<span class="token punctuation">(</span>weather_oldxu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token number">210</span></pre></td></tr></table></figure><p>示例 2：分别展示不同城市的最⼤温度</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>max<span class="token punctuation">(</span>weather_oldxu<span class="token punctuation">)</span> by <span class="token punctuation">(</span>city<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"上海"</span><span class="token punctuation">&#125;</span> <span class="token number">30</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"北京"</span><span class="token punctuation">&#125;</span> <span class="token number">25</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"⼴州"</span><span class="token punctuation">&#125;</span> <span class="token number">29</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span><span class="token punctuation">&#125;</span> <span class="token number">2</span></pre></td></tr></table></figure><p>示例 3：分别展示不同城市的最⼩温度</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>min<span class="token punctuation">(</span>weather_oldxu<span class="token punctuation">)</span> by <span class="token punctuation">(</span>city<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"上海"</span><span class="token punctuation">&#125;</span> <span class="token number">12</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"北京"</span><span class="token punctuation">&#125;</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"⼴州"</span><span class="token punctuation">&#125;</span> <span class="token number">11</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span><span class="token punctuation">&#125;</span> <span class="token parameter variable">-3</span></pre></td></tr></table></figure><p>示例 4：仅展示 “武汉” 城市的平均温度</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>avg<span class="token punctuation">(</span>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token number">22.666666666666664</span></pre></td></tr></table></figure><p>示例 5：是⽤ topk 获取前三个的⾼温城市。topk 的结果按温度值从⾼到低排序</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>topk<span class="token punctuation">(</span><span class="token number">3</span>,weather_oldxu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"上海"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"浦东新区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7001"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">27</span></pre></td></tr><tr><td data-num="6"></td><td><pre>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"⼴州"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"越秀区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7001"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">15</span></pre></td></tr><tr><td data-num="7"></td><td><pre>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"⼴州"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"天河区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7001"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">14</span></pre></td></tr></table></figure><p>示例 6：使⽤ bottomk 获取排名靠前三的低温城市。bottomk 的结果按温度值从低到⾼排列</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bottomk<span class="token punctuation">(</span><span class="token number">3</span>,weather_oldxu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"武昌区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7001"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token parameter variable">-6</span></pre></td></tr><tr><td data-num="6"></td><td><pre>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"汉⼝区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7001"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token parameter variable">-5</span></pre></td></tr><tr><td data-num="7"></td><td><pre>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"北京"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"海淀区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7001"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">2</span></pre></td></tr></table></figure><p>示例 7：统计天⽓温度的数量，按城市进⾏区分</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>count<span class="token punctuation">(</span>weather_oldxu<span class="token punctuation">)</span> by <span class="token punctuation">(</span>city<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"上海"</span><span class="token punctuation">&#125;</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"北京"</span><span class="token punctuation">&#125;</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"⼴州"</span><span class="token punctuation">&#125;</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span><span class="token punctuation">&#125;</span> <span class="token number">3</span></pre></td></tr></table></figure><p>示例 8：统计各温度值出现的频次，按城市进⾏区分</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式 count_values ("value_count", &lt;metrics_name>) by (&lt;label>)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>count_values<span class="token punctuation">(</span><span class="token string">"status"</span>,weather_oldxu<span class="token punctuation">)</span> by <span class="token punctuation">(</span>city<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"上海"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"12"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"上海"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"13"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"上海"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"14"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"北京"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"-3"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"北京"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"6"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"北京"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"-10"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"⼴州"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"20"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"⼴州"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"24"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"⼴州"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"17"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"15"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">"17"</span><span class="token punctuation">&#125;</span> <span class="token number">2</span> <span class="token comment"># 17 度出现了 2 次，这意味着武汉城市有 2 个不同地域报告了 17 度的温度。</span></pre></td></tr></table></figure><h5 id="53-promql聚合实践"><a class="anchor" href="#53-promql聚合实践">#</a> 5.3 PromQL 聚合实践</h5><p>实例 1：查询所有节点，最近 1 分钟的负载，是否⾼于 cpu 核⼼的 2 倍</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 模拟 cpu 使⽤率⾼于核⼼数：stress --cpu 6</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 获取每个节点的负载表达式</span></pre></td></tr><tr><td data-num="4"></td><td><pre>sum<span class="token punctuation">(</span>node_load1<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># CPU 核⼼的 2 倍表达式 [核⼼数 * 2]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>count<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> * <span class="token number">2</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 整体表达式</span></pre></td></tr><tr><td data-num="10"></td><td><pre>sum<span class="token punctuation">(</span>node_load1<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token operator">></span> count<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> * <span class="token number">2</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">4.06</span> <span class="token comment"># 该节点的使⽤率超过核⼼数的 2 倍了</span></pre></td></tr></table></figure><p>实例 2：查询每个节点的 CPU 的使⽤率，指标名称： node_cpu_seconds_total</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 模拟 cpu 使⽤率达到 50%：stress --cpu 1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 表达式: (1 - CPU 整体空闲使⽤率) * 100 = CPU 使⽤率</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token punctuation">(</span><span class="token number">1</span> - avg<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance<span class="token punctuation">))</span> *100</pre></td></tr><tr><td data-num="4"></td><td><pre> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">1.1555555555484487</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">51.144444444459324</span> <span class="token comment"># 使⽤率在 50% 左右</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">2.3333333333236395</span></pre></td></tr></table></figure><p>实例 3：查询所有节点，最近 1 分钟磁盘的最⼤写⼊速率，以 MB/s 为单位，指标名称： node_disk_written_bytes_total</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 模拟数据写⼊，复制 2G 的数据，控制每秒 20M 左右的速度写</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># yum install pv -y</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># dd if=/dev/zero bs=1M count=2000 | pv -L 20M > /tmp/bigdata</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 表达式： 获取每分钟的磁盘速率，然后提取最⼤的值，最后 / 1024/1024 得到 MB/s</span></pre></td></tr><tr><td data-num="6"></td><td><pre>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_written_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> /1024 /1024</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">0.007052951388888888</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">19.724283854166664</span> <span class="token comment">#每秒写⼊速度在 19MB/s</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">0.011946614583333333</span></pre></td></tr></table></figure><p>实例 4：查询所有节点，最近 1 分钟磁盘的读取写⼊速率，以 MB/s 为单位，指标名称： node_disk_read_bytes_total</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 模拟数据读取，读取 /tmp/bigdata ⽂件，然后以每秒 15MB 的速度读取</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># yum install pv -y</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># pv -L 15M /tmp/bigdata > /dev/null</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="6"></td><td><pre>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_read_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> /1024 /1024</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">15.006076388888888</span> <span class="token comment">#每秒读取速度在 15MB/s</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">0</span></pre></td></tr></table></figure><p>实例 5：计算 Prometheus 服务器的 HTTP 请求成功率，指标名称： prometheus_http_requests_total</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 计算公式： 请求成功的 (2xx|3xx) / 总的请求 * 100 = 请求成功率</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">sum</span> <span class="token punctuation">(</span>prometheus_http_requests_total<span class="token punctuation">&#123;</span>code<span class="token operator">=~</span><span class="token string">"2.*|3.*"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> / sum<span class="token punctuation">(</span>prometheus_http_requests_total<span class="token punctuation">)</span> * <span class="token number">100</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token number">99.59027974003956</span> <span class="token comment"># ⽹站整体请求成功率在 99.5%</span></pre></td></tr></table></figure><p>实例 6：查询请求排名前三的 URL，指标名称： prometheus_http_requests_total</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sum</span> <span class="token punctuation">(</span>topk<span class="token punctuation">(</span><span class="token number">3</span>,prometheus_http_requests_total<span class="token punctuation">)</span> <span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,handler<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>handler<span class="token operator">=</span><span class="token string">"/metrics"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">&#125;</span> <span class="token number">5483</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>handler<span class="token operator">=</span><span class="token string">"/api/v1/query"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">&#125;</span> <span class="token number">1576</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span>handler<span class="token operator">=</span><span class="token string">"/api/v1/metadata"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">&#125;</span> <span class="token number">113</span></pre></td></tr></table></figure><h4 id="六-promql时间聚合操作"><a class="anchor" href="#六-promql时间聚合操作">#</a> 六. PromQL 时间聚合操作</h4><h5 id="61-promql时间聚合介绍"><a class="anchor" href="#61-promql时间聚合介绍">#</a> 6.1 PromQL 时间聚合介绍</h5><p>在 Prometheus 中，除了可以 “纵向的聚合” 以外，还可以基于时间聚合也就是 “横向聚合”。</p><p>时间聚合不是在不同的序列上进⾏聚合操作，⽽是在 “单个序列” 的不同时间点之间进⾏聚合，这意味着，对于单个序列，我们可以计算过去⼀段时间内的最⼤值，最⼩值，以及平均值等。</p><ul><li>avg_over_time (range-vector) ：区间向量内每个指标的平均值。</li><li>min_over_time (range-vector) ：区间向量内每个指标的最⼩值。</li><li>max_over_time (range-vector) ：区间向量内每个指标的最⼤值。</li><li>sum_over_time (range-vector) ：区间向量内每个指标的求和。</li><li>count_over_time (range-vector) ：区间向量内指标样本的总个数。</li></ul><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/qAuRqKU.jpeg" alt="3.jpg"></p><h5 id="62-promql时间聚合示例"><a class="anchor" href="#62-promql时间聚合示例">#</a> 6.2 PromQL 时间聚合示例</h5><p>1、获取武汉城市中武昌区，最近 5 分钟的温度数据</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>,dist<span class="token operator">=</span><span class="token string">"武昌区"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"武昌区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:5000"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">12</span> @1704269783.3</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">22</span> @1704269843.3</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">17</span> @1704269903.3</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">17</span> @1704269963.3</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">5</span>  @1704270023.3</pre></td></tr></table></figure><p>2、获取武汉城市中武昌区，最近 5 分钟温度的最⼤值</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>max_over_time<span class="token punctuation">(</span>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>,dist<span class="token operator">=</span><span class="token string">"武昌区"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"武昌区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:5000"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">22</span></pre></td></tr></table></figure><p>3、获取武汉城市中武昌区，最近 5 分钟温度的最⼩值</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>min_over_time<span class="token punctuation">(</span>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>,dist<span class="token operator">=</span><span class="token string">"武昌区"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"武昌区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:5000"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">5</span></pre></td></tr></table></figure><p>4、获取武汉城市中武昌区，最近 5 分钟温度的平均值</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>min_over_time<span class="token punctuation">(</span>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>,dist<span class="token operator">=</span><span class="token string">"武昌区"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"武昌区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:5000"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">14.6</span></pre></td></tr></table></figure><p>5、获取武汉城市中武昌区，当前数据总共来⾃多少个样本</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>count_over_time<span class="token punctuation">(</span>weather_oldxu<span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>,dist<span class="token operator">=</span><span class="token string">"武昌区"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>city<span class="token operator">=</span><span class="token string">"武汉"</span>, <span class="token assign-left variable">dist</span><span class="token operator">=</span><span class="token string">"武昌区"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:5000"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"weather-exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">5</span> <span class="token comment"># 说明 5 分钟的样本数有 5 个</span></pre></td></tr></table></figure><h5 id="63-promql时间聚合实践"><a class="anchor" href="#63-promql时间聚合实践">#</a> 6.3 PromQL 时间聚合实践</h5><p state="time_wait">实例 1：查询最近 1 分钟内 tcp_timewait 连接数的最⼤值，并检查是否超过 1000 个，指标名称： node_tcp_connection_states</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 模拟⼤量 tcp_timewait：ab -n 1000 -c 2 http://localhost:9090/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="3"></td><td><pre>max_over_time<span class="token punctuation">(</span>node_tcp_connection_states<span class="token punctuation">&#123;</span>state<span class="token operator">=</span><span class="token string">"time_wait"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span><span class="token number">1000</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">state</span><span class="token operator">=</span><span class="token string">"time_wait"</span><span class="token punctuation">&#125;</span> <span class="token number">1769</span> <span class="token comment"># 最近 1 分钟最⼤的值是 1769</span></pre></td></tr></table></figure><p state="established">实例 2：查询最近 1 分钟内 tcp_established 连接数的最⼤值，并检查是否超过 100 个，指标名称： node_tcp_connection_states</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 模拟 established：</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 服务端（node01）：nc -lk 2345</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 客户端（node02）：for i in &#123;1..1000&#125;; do nc prom-node01.oldxu.net 2345 >/dev/null 2>&amp;1 &amp; done</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="6"></td><td><pre>max_over_time<span class="token punctuation">(</span>node_tcp_connection_states<span class="token punctuation">&#123;</span>state<span class="token operator">=</span><span class="token string">"established"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">100</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">state</span><span class="token operator">=</span><span class="token string">"established"</span><span class="token punctuation">&#125;</span> <span class="token number">133</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"node_exporter"</span>, <span class="token assign-left variable">state</span><span class="token operator">=</span><span class="token string">"established"</span><span class="token punctuation">&#125;</span> <span class="token number">106</span></pre></td></tr></table></figure><p>实例 3：查询⽹站平均请求延迟 1 分钟⼤于 3s 的站点，指标名称： probe_duration_seconds（需要 blackbox)</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>avg_over_time<span class="token punctuation">(</span>probe_duration_seconds<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">3</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"https://httpstat.us/102"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"blackbox_http"</span><span class="token punctuation">&#125;</span> <span class="token number">14.501046884666668</span></pre></td></tr></table></figure><p>实例 4：查询 MySQL 服务器在最近 1 分钟内平均运⾏线程数超过 50 的。指标名称： mysql_global_status_threads_running</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 模拟 MySQL 线程数</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">120</span><span class="token punctuation">&#125;</span> <span class="token punctuation">;</span> <span class="token keyword">do</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   mysql <span class="token parameter variable">-e</span> <span class="token string">"SELECT SLEEP(60);"</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">done</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="7"></td><td><pre>avg_over_time<span class="token punctuation">(</span>mysql_global_status_threads_running<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">50</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9104"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"mysqld_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">62</span> <span class="token comment"># 平均线程数在 62，超过阈值定义的 50</span></pre></td></tr></table></figure><p>实例 5：查询以监控 MySQL 服务器过去 1 分钟内的线程当前打开的最⼤连接数。如果这个数值超过了服务器配置的最⼤连接数的 80% 则触发告警。指标名称</p><ul><li>mysql_global_status_threads_connected （表示当前打开的连接数）</li><li>mysql_global_variables_max_connections （表示配置允许的最⼤连接数）</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 模拟 MySQL 连接数</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">120</span><span class="token punctuation">&#125;</span> <span class="token punctuation">;</span> <span class="token keyword">do</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    mysql <span class="token parameter variable">-e</span> <span class="token string">"SELECT SLEEP(60);"</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">done</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="7"></td><td><pre>max_over_time<span class="token punctuation">(</span>mysql_global_status_threads_connected<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> / mysql_global_variables_max_connections * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node03.oldxu.net:9104"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"mysqld_exporter"</span><span class="token punctuation">&#125;</span> <span class="token number">80.79470198675497</span> <span class="token comment"># 当前最⼤连接数已经超过了 80%</span></pre></td></tr></table></figure><h4 id="七-promql向量匹配"><a class="anchor" href="#七-promql向量匹配">#</a> 七. PromQL 向量匹配</h4><h5 id="71-promql向量匹配介绍"><a class="anchor" href="#71-promql向量匹配介绍">#</a> 7.1 PromQL 向量匹配介绍</h5><p>在 Prometheus 中，执⾏ “向量与向量之间的运算” 时，需要遵循向量匹配的规则。这意味着两个向量必须具有 “相同的标签”，且对应的 “标签值也必须完全相同”，这才能进⾏运算。如果有任何⼀个标签或标签值不匹配，那么此次的运算将不会执⾏。这种匹配规则也被称为 “向量的⼀对⼀匹配”。例如，下⾯两个时间序列可以成功进⾏⼀对⼀匹配，⽽后可以正常执⾏各种运算：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>http_requests_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"promnode01.oldxu.net:9100"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>http_requests_duration_seconds<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>,instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>因为它们的标签以及标签值完全⼀致，所以它们可以直接进⾏运算操作。</p><h5 id="72-promql一对一向量匹配"><a class="anchor" href="#72-promql一对一向量匹配">#</a> 7.2 PromQL ⼀对⼀向量匹配</h5><p>但是在实际监控场景中，我们会经常遇到 “标签不完全相同” 的两个向量，但它们任然需要进⾏运算。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>oldxu_requests_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span><span class="token punctuation">&#125;</span> <span class="token number">3200</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#表示该实例的 HTTP 请求总数。</span></pre></td></tr><tr><td data-num="3"></td><td><pre>oldxu_requests_status_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"GET"</span><span class="token punctuation">&#125;</span> <span class="token number">500</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#表示该实例中使⽤ GET ⽅法的 HTTP 请求总数。</span></pre></td></tr></table></figure><p>假设我们想要计算使⽤ GET ⽅法的请求总数，占总请求数的⽐例是多少。理想的计算公式是： GET ⽅法的请求总数 / 总的请求数 * 100 = GET 请求所占的⽐例。 但由于两个向量的标签不完全相同（⼀个有 method 标签，⼀个没有），因此⽆法进⾏直接进⾏计算。</p><p>为了解决这个问题，我们可以借助 PromQL 的向量匹配选项：</p><ul><li>基于标签的匹配（on）：指定基于哪些标签进⾏匹配。只有当指定的 ” 标签及其值 “ 在两个向量中都相同，向量之间才能进⾏运算。</li><li>忽略标签的匹配（ignoring）：指定忽略某些标签，也就是在运算时不考虑这些标签，只要其他标签以及标签的值相同，向量之间就可以进⾏运算。</li></ul><p>⽅式 1：使⽤ on 关键字匹配特定标签，明明确指定仅基于 job 和 instance 标签进⾏匹配</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>oldxu_requests_status_total<span class="token punctuation">&#123;</span>method<span class="token operator">=</span><span class="token string">"GET"</span><span class="token punctuation">&#125;</span> / on <span class="token punctuation">(</span>job, instance<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>oldxu_requests_total * <span class="token number">100</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"webserver"</span><span class="token punctuation">&#125;</span> <span class="token number">15.625</span> <span class="token comment"># GET ⽅法占⽐总请求 15%</span></pre></td></tr></table></figure><p>⽅式 2：使⽤ ignoring 关键字忽略特定标签，忽略不希望参与匹配的 method 标签</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>oldxu_requests_status_total<span class="token punctuation">&#123;</span>method<span class="token operator">=</span><span class="token string">"GET"</span><span class="token punctuation">&#125;</span> / ignoring <span class="token punctuation">(</span>method<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>oldxu_requests_total * <span class="token number">100</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:9100"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"webserver"</span><span class="token punctuation">&#125;</span> <span class="token number">15.625</span> <span class="token comment"># GET ⽅法占⽐总请求 15%</span></pre></td></tr></table></figure><h5 id="73-promql一对多向量匹配"><a class="anchor" href="#73-promql一对多向量匹配">#</a> 7.3 PromQL ⼀对多向量匹配</h5><p>在实际监控中，我们还会遇到需要进⾏ “⼀对多向量匹配” 的情况，即 “⼀个时间序列中的数据点” 需要与 “另⼀个时间序列中的多个数据点” 进⾏匹配运算。</p><p>举个例⼦：假设我们有如下两个指标：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 第⼀个时间序列：记录了不同 HTTP ⽅法和状态码的错误请求总数。</span></pre></td></tr><tr><td data-num="2"></td><td><pre>oldxu_requests_error_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"GET"</span>,code<span class="token operator">=</span><span class="token string">"500"</span><span class="token punctuation">&#125;</span> <span class="token number">220</span></pre></td></tr><tr><td data-num="3"></td><td><pre>oldxu_requests_error_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"GET"</span>,code<span class="token operator">=</span><span class="token string">"404"</span><span class="token punctuation">&#125;</span> <span class="token number">130</span></pre></td></tr><tr><td data-num="4"></td><td><pre>oldxu_requests_error_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"PUT"</span>,code<span class="token operator">=</span><span class="token string">"501"</span><span class="token punctuation">&#125;</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="5"></td><td><pre>oldxu_requests_error_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"POST"</span>,code<span class="token operator">=</span><span class="token string">"500"</span><span class="token punctuation">&#125;</span> <span class="token number">34</span></pre></td></tr><tr><td data-num="6"></td><td><pre>oldxu_requests_error_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"POST"</span>,code<span class="token operator">=</span><span class="token string">"502"</span><span class="token punctuation">&#125;</span> <span class="token number">48</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 第⼆个时间序列：记录了每种 HTTP ⽅法的请求总数。</span></pre></td></tr><tr><td data-num="9"></td><td><pre>oldxu_requests_instance_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>,method<span class="token operator">=</span><span class="token string">"GET"</span><span class="token punctuation">&#125;</span> <span class="token number">600</span></pre></td></tr><tr><td data-num="10"></td><td><pre>oldxu_requests_instance_total<span class="token punctuation">&#123;</span>job<span class="token operator">=</span><span class="token string">"webserver"</span>,<span class="token string">"method"</span><span class="token operator">=</span><span class="token string">"POST"</span><span class="token punctuation">&#125;</span> <span class="token number">120</span></pre></td></tr></table></figure><p>我们的⽬标是计算每种 HTTP ⽅法（GET 和 POST）对应不同状态码（404 和 500）的请求占该⽅法总请求的⽐例。⼤体计算公式如下：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1、GET ⽅法为 500 的请求总数 / GET 的总请求数 * 100 = GET 500 错误⽐例。 (220 /600 * 100 = 21.666666666666668)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 2、GET ⽅法为 404 的请求总数 / GET 的总请求数 * 100 = GET 404 错误⽐例。 (130 /600 * 100 = 36.666666666666664)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 3、POST ⽅法为 500 的请求总数 / POST 的总请求数 * 100 = POST 500 错误⽐例。 (34 / 120 * 100 = 28.333333333333332)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 4、POST ⽅法为 502 的请求总数 / POST 的总请求数 * 100 = POST 502 错误⽐例。 (48 / 120 * 100 = 40)</span></pre></td></tr></table></figure><p>为了实现这⼀⽬标，我们有两个问题需要解决：</p><p>1、标签不⼀致：</p><ul><li>具体问题：两个时间序列的标签集合不完全⼀致， oldxu_requests_error_total 包含 code 标签，⽽ oldxu_requests_instance_total 不包含。</li><li>解决⽅法：使⽤ ignoring (code) 来忽略 code 标签，从⽽使得两个时间序列在没有 code 标签的情况下可以匹配。</li></ul><p>2、⼀对多匹配：</p><ul><li>具体问题： oldxu_requests_error_total 中的每个数据点，都需要与 oldxu_requests_instance_total 中的总请求数相除。</li><li>解决办法：必须明确左侧还是右侧为多的⼀边，因此我们可以使⽤ group_left 或 group_right 来指明哪个是 “多”，然后进⾏匹配。</li></ul><p>因此完整的 PromQL 查询如下：</p><ul><li>1、使⽤ ignoring (code) 忽略左侧查询（ oldxu_requests_error_total ）中的 code 标签。</li><li>2、使⽤ group_left 修饰符来确保它能够与标签较少的右侧进⾏匹配。</li><li>3、将匹配后的结果相除，并乘以 100 得到百分⽐。</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre>oldxu_requests_error_total</pre></td></tr><tr><td data-num="3"></td><td><pre> / ignoring <span class="token punctuation">(</span>code<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   group_left</pre></td></tr><tr><td data-num="5"></td><td><pre>oldxu_requests_instance_total * <span class="token number">100</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 结果</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span>code<span class="token operator">=</span><span class="token string">"404"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7002"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"GET"</span><span class="token punctuation">&#125;</span> <span class="token number">21.666666666666668</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span>code<span class="token operator">=</span><span class="token string">"500"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7002"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"GET"</span><span class="token punctuation">&#125;</span> <span class="token number">36.666666666666664</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span>code<span class="token operator">=</span><span class="token string">"500"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7002"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"POST"</span><span class="token punctuation">&#125;</span> <span class="token number">28.333333333333332</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span>code<span class="token operator">=</span><span class="token string">"502"</span>, <span class="token assign-left variable">instance</span><span class="token operator">=</span><span class="token string">"prom-node01.oldxu.net:7002"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"webserver"</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span><span class="token string">"POST"</span><span class="token punctuation">&#125;</span> <span class="token number">40</span></pre></td></tr></table></figure><h5 id="74-promql向量匹配示例"><a class="anchor" href="#74-promql向量匹配示例">#</a> 7.4 PromQL 向量匹配示例</h5><p>1、下载并运⾏程序，该程序⽤于模拟 “向量匹配相关的” 指标数据；</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/prometheus/exporter/vectormatch_exporter_oldxu</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># mv vectormatch_exporter_oldxu /usr/local/bin</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /usr/local/bin/vectormatch_exporter_oldxu</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 启动脚本</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># vim /usr/lib/systemd/system/vectormatch_exporter.service</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>vectormatch_exporter</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/vectormatch_exporter_oldxu <span class="token parameter variable">--port</span> <span class="token number">7002</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start vectormatch_exporter.service</span></pre></td></tr></table></figure><p>2、编辑 Prometheus 配置⽂件，抓取对应的指标数据</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="4"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 重新加载 prometheus</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><p>示例 1：⼀对⼀向量匹配</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/kxSPXou.jpeg" alt="1.jpg"></p><p>示例 2：⼀对多向量匹配</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/sEj96xP.jpeg" alt="2.jpg"></p><h5 id="75-promql向量匹配实践"><a class="anchor" href="#75-promql向量匹配实践">#</a> 7.5 PromQL 向量匹配实践</h5><p>实例 1：查询每个实例 CPU 的各个模式使⽤的时间占 “总 CPU 的时间” ⽐例是多少，也是就占多少百分⽐。</p><ul><li>1、获取每个实例各个模式占⽤ CPU 的时间，按照（instance、mode）进⾏分组并求和；</li><li>2、获取每个实例总占⽤ CPU 时间，按照（instance）进⾏分组求和；</li><li>3、将每种模式所使⽤的 CPU 时间 / CPU 总的时间 * 100 = 每种模式占总 CPU 时间的百分⽐；</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sum</span> <span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job,mode<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>/ ignoring <span class="token punctuation">(</span>mode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  group_left</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">sum</span> <span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> * <span class="token number">100</span></pre></td></tr></table></figure><p>实例 2：查询 “每个 CPU 核⼼” 上不同模式的时间，占总 CPU 时间的⽐率是多少，也就是占多少百分⽐。</p><ul><li>1、计算 “每个 CPU 核⼼” 在 “各个模式下” 的累计 CPU 使⽤时间，按照（instance、cpu、mode）进⾏分组并求和；</li><li>2、计算 “每个 CPU 核⼼的总 CPU 时间” 不区分模式。按照（instance、cpu）进⾏分组并求和；</li><li>3、每个 CPU 核⼼的各个模式 / CPU 核⼼的总时间 * 100 = 每个 CPU 核⼼的各个模式时间占⽤百分⽐</li></ul><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 表达式</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sum</span> <span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,cpu,mode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre> / on <span class="token punctuation">(</span>instance,cpu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   group_left</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">sum</span> <span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,cpu<span class="token punctuation">)</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/Prometheus/" rel="tag"><i class="ic i-tag"></i>Prometheus</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/posts/3386060324.html">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2025-08-19 21:24:00" itemprop="dateModified" datetime="2025-08-19T21:24:00+08:00">2025-08-19</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Xu Yong 微信支付"><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Xu Yong 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Xu Yong<i class="ic i-at"><em>@</em></i>LinuxSre云原生</li><li class="link"><strong>本文链接：</strong><a href="http://ixuyong.cn/posts/3386060324.html" title="PromQL快速入门（二）">http://ixuyong.cn/posts/3386060324.html</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/posts/1595025559.html" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;o1ceeNN.jpeg" title="Prometheus监控实战（一）"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Prometheus</span><h3>Prometheus监控实战（一）</h3></a></div><div class="item right"><a href="/posts/4081185381.html" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;o1ceeNN.jpeg" title="Prometheus监控实战（三）"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>Prometheus</span><h3>Prometheus监控实战（三）</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#promql%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E4%BA%8C"><span class="toc-number">1.</span> <span class="toc-text">PromQL 快速入门（二）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-promql%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">一. PromQL 基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E4%BB%80%E4%B9%88%E6%98%AFpromeql"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 什么是 PromeQL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-promql%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 PromQL 应⽤场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-promql%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">二. PromQL 基础使⽤</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-%E6%8C%87%E6%A0%87%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 指标查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-%E6%97%B6%E9%97%B4%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 时间范围查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23-%E6%97%B6%E9%97%B4%E5%81%8F%E7%A7%BB%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 时间偏移查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-promql%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.</span> <span class="toc-text">三. PromQL 常⽤函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#31-count%E7%B1%BB%E5%9E%8B%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 Count 类型常⽤函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#32-gauge%E7%B1%BB%E5%9E%8B%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 Gauge 类型常⽤函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B-promql%E4%BA%8C%E5%85%83%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">1.4.</span> <span class="toc-text">四. PromQL ⼆元运算符</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#41-%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 算术运算符介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#42-%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E7%AC%A6%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 算术运算符实践</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#43-%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 ⽐较运算符介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#44-%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 ⽐较运算符实践</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#45-%E9%9B%86%E5%90%88%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.5.</span> <span class="toc-text">4.5 集合运算符介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#46-%E9%9B%86%E5%90%88%E8%BF%90%E7%AE%97%E7%AC%A6%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.4.6.</span> <span class="toc-text">4.6 集合运算符实践</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94-promql%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">1.5.</span> <span class="toc-text">五. PromQL 聚合操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#51-promql%E8%81%9A%E5%90%88%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 PromQL 聚合介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#52-promql%E8%81%9A%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 PromQL 聚合示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#53-promql%E8%81%9A%E5%90%88%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 PromQL 聚合实践</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AD-promql%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">1.6.</span> <span class="toc-text">六. PromQL 时间聚合操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#61-promql%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 PromQL 时间聚合介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#62-promql%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 PromQL 时间聚合示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#63-promql%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 PromQL 时间聚合实践</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%83-promql%E5%90%91%E9%87%8F%E5%8C%B9%E9%85%8D"><span class="toc-number">1.7.</span> <span class="toc-text">七. PromQL 向量匹配</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#71-promql%E5%90%91%E9%87%8F%E5%8C%B9%E9%85%8D%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 PromQL 向量匹配介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#72-promql%E4%B8%80%E5%AF%B9%E4%B8%80%E5%90%91%E9%87%8F%E5%8C%B9%E9%85%8D"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 PromQL ⼀对⼀向量匹配</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#73-promql%E4%B8%80%E5%AF%B9%E5%A4%9A%E5%90%91%E9%87%8F%E5%8C%B9%E9%85%8D"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 PromQL ⼀对多向量匹配</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#74-promql%E5%90%91%E9%87%8F%E5%8C%B9%E9%85%8D%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.7.4.</span> <span class="toc-text">7.4 PromQL 向量匹配示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#75-promql%E5%90%91%E9%87%8F%E5%8C%B9%E9%85%8D%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.7.5.</span> <span class="toc-text">7.5 PromQL 向量匹配实践</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/posts/2041568856.html" rel="bookmark" title="Prometheus监控Kubernetes">Prometheus监控Kubernetes</a></li><li><a href="/posts/1595025559.html" rel="bookmark" title="Prometheus监控实战（一）">Prometheus监控实战（一）</a></li><li class="active"><a href="/posts/3386060324.html" rel="bookmark" title="PromQL快速入门（二）">PromQL快速入门（二）</a></li><li><a href="/posts/4081185381.html" rel="bookmark" title="Prometheus监控实战（三）">Prometheus监控实战（三）</a></li><li><a href="/posts/4081185382.html" rel="bookmark" title="Prometheus监控实战（四）">Prometheus监控实战（四）</a></li><li><a href="/posts/737291847.html" rel="bookmark" title="Prometheus监控实战（五）">Prometheus监控实战（五）</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Xu Yong" src="/assets/avatar.png"><p class="name" itemprop="name">Xu Yong</p><div class="description" itemprop="description">专注于 Linux 运维、云计算、云原⽣等技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">54</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">16</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">19</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/xyapples" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;xyapples"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://gitee.com/chinagei" class="item gitee" title="https:&#x2F;&#x2F;gitee.com&#x2F;chinagei"><i class="ic i-gitee"></i></a><a href="mailto:373370405@qq.com" class="item email" title="mailto:373370405@qq.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-about"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/posts/4081185381.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/posts/1595025559.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Windows/" title="分类于Windows">Windows</a></div><span><a href="/posts/3071070979.html">一键永久激活Window、office教程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Prometheus/" title="分类于Prometheus">Prometheus</a></div><span><a href="/posts/3386060324.html">PromQL快速入门（二）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/176412055.html">K8s准入控制ResourceQuota、LimitRange、QoS服务质量</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3142072607.html">K8s初始化容器、临时容器</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/2771271649.html">云原生K8s安全专家CKS认证考题详解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Prometheus/" title="分类于Prometheus">Prometheus</a></div><span><a href="/posts/2041568856.html">Prometheus监控Kubernetes</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/3890389502.html">K8S持久化存储NFS+StorageClass</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Nginx/" title="分类于Nginx">Nginx</a></div><span><a href="/posts/3682494305.html">Nginx基础架构LNMP</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Kubernetes/" title="分类于Kubernetes">Kubernetes</a></div><span><a href="/posts/312010518.html">K8s亲和力Affinity</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Tomcat/" title="分类于Tomcat">Tomcat</a></div><span><a href="/posts/754945111.html">Tomcat JVM调优实践</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Xu Yong @ LinuxSre云原生</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.5m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">23:22</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `posts/3386060324.html`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hrmmi -->