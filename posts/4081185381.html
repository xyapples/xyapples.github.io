<!-- build time:Sat Oct 25 2025 20:15:43 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon.ico"><link rel="alternate" href="/rss.xml" title="LinuxSre云原生" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="LinuxSre云原生" type="application/atom+xml"><link rel="alternate" type="application/json" title="LinuxSre云原生" href="http://ixuyong.cn/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.17"><link rel="modulepreload" href="/js/chunk-GV364XSK.js"><link rel="modulepreload" href="/js/chunk-NYSE5UKM.js"><link rel="modulepreload" href="/js/chunk-RONCYO2S.js"><link rel="modulepreload" href="/js/chunk-THHXCRSX.js"><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/js/comments-DL2IYMPZ.js"><link rel="modulepreload" href="/js/copy-tex-NADCTXPG.js"><link rel="modulepreload" href="/js/post-DA635IH6.js"><link rel="modulepreload" href="/js/quicklink-WEDHL4BA.js"><link rel="modulepreload" href="/js/search-VCZRKTM5.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/waline-NNBYRQEE.js"><link rel="stylesheet" href="/css/comments-F4ZGS7LD.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/waline-IDNZKML2.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="preload" href="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" as="image" fetchpriority="high"><meta name="keywords" content="Prometheus"><meta name="description" content="专注于 Linux 运维、云计算、云原⽣等技术"><link rel="canonical" href="http://ixuyong.cn/posts/4081185381.html"><title>Prometheus监控实战（三）</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Prometheus监控实战（三）</h1><div class="meta"><span class="item" title="创建时间：2025-08-12 22:17:01"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-08-12T22:17:01+08:00">2025-08-12</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>93k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>1:24</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">LinuxSre云原生</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://s21.ax1x.com/2025/03/29/pEsS0hD.png" loading="eager" decoding="async" fetchpriority="high" alt="LinuxSre云原生"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Prometheus/" itemprop="item" rel="index" title="分类于Prometheus"><span itemprop="name">Prometheus<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://ixuyong.cn/posts/4081185381.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"><meta itemprop="name" content="Xu Yong"><meta itemprop="description" content="致力于技术布道、普及前沿技术、打造云原生系列标杆博客, 专注于 Linux 运维、云计算、云原⽣等技术"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LinuxSre云原生"></span><div class="body md" itemprop="articleBody"><h3 id="prometheus监控实战三"><a class="anchor" href="#prometheus监控实战三">#</a> Prometheus 监控实战（三）</h3><h4 id="一-promtheus节点监控"><a class="anchor" href="#一-promtheus节点监控">#</a> 一. Promtheus 节点监控</h4><h5 id="11-配置prometheus"><a class="anchor" href="#11-配置prometheus">#</a> 1.1 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># rules 配置文件路径</span></pre></td></tr><tr><td data-num="7"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="8"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="11"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="12"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span>   <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    static_configs:          <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="20"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="25"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><h5 id="12-创建rules目录并重载prometheus"><a class="anchor" href="#12-创建rules目录并重载prometheus">#</a> 1.2 创建 rules 目录并重载 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/prometheus/rules</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="13-promtheus配置告警规则"><a class="anchor" href="#13-promtheus配置告警规则">#</a> 1.3 Promtheus 配置告警规则</h5><h6 id="131-配置cpu告警规则"><a class="anchor" href="#131-配置cpu告警规则">#</a> 1.3.1 配置 CPU 告警规则</h6><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 配置 CPU 告警规则</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/node_rules.yml </span></pre></td></tr><tr><td data-num="3"></td><td><pre>groups:</pre></td></tr><tr><td data-num="4"></td><td><pre>- name: CPU告警规则</pre></td></tr><tr><td data-num="5"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="6"></td><td><pre>  - alert: 节点处于Down状态</pre></td></tr><tr><td data-num="7"></td><td><pre>    expr: up <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="9"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="10"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="11"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="12"></td><td><pre>      summary: <span class="token string">"节点处于Down状态,实例:"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      description: <span class="token string">" 节点已关闭"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      </pre></td></tr><tr><td data-num="15"></td><td><pre>  - alert: 节点CPU使率超过80%</pre></td></tr><tr><td data-num="16"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - avg<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> <span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="18"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="19"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="20"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="21"></td><td><pre>      summary: <span class="token string">"主机CPU利率过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      description: <span class="token string">"该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。"</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  - alert: CPU饱和度过⾼</pre></td></tr><tr><td data-num="25"></td><td><pre>    expr: sum<span class="token punctuation">(</span>node_load1<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token punctuation">(</span>count<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> * <span class="token number">2</span><span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="27"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="28"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="29"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="30"></td><td><pre>      summary: <span class="token string">"CPU饱和度过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      description: <span class="token string">"该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      </pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h6 id="132-配置内存告警规则"><a class="anchor" href="#132-配置内存告警规则">#</a> 1.3.2 配置内存告警规则</h6><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 配置内存告警规则</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/node_rules.yml </span></pre></td></tr><tr><td data-num="3"></td><td><pre>groups:</pre></td></tr><tr><td data-num="4"></td><td><pre>- name: CPU告警规则</pre></td></tr><tr><td data-num="5"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="6"></td><td><pre>  - alert: 节点处于Down状态</pre></td></tr><tr><td data-num="7"></td><td><pre>    expr: up <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="9"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="10"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="11"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="12"></td><td><pre>      summary: <span class="token string">"节点处于Down状态,实例:"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      description: <span class="token string">" 节点已关闭"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      </pre></td></tr><tr><td data-num="15"></td><td><pre>  - alert: 节点CPU使率超过80%</pre></td></tr><tr><td data-num="16"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - avg<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> <span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="18"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="19"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="20"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="21"></td><td><pre>      summary: <span class="token string">"主机CPU利率过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      description: <span class="token string">"该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。"</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  - alert: CPU饱和度过⾼</pre></td></tr><tr><td data-num="25"></td><td><pre>    expr: sum<span class="token punctuation">(</span>node_load1<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token punctuation">(</span>count<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> * <span class="token number">2</span><span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="27"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="28"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="29"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="30"></td><td><pre>      summary: <span class="token string">"CPU饱和度过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      description: <span class="token string">"该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。"</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>- name: 内存告警规则</pre></td></tr><tr><td data-num="34"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="35"></td><td><pre>  - alert: 主机内存不⾜</pre></td></tr><tr><td data-num="36"></td><td><pre>    expr: <span class="token punctuation">(</span>node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes<span class="token punctuation">)</span> / node_memory_MemTotal_bytes * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="38"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="39"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="40"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="41"></td><td><pre>      summary: <span class="token string">"主机内存使用率较高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      description: <span class="token string">"该实例的内存使用率持续2分钟高于80%，当前利用率：%"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      </pre></td></tr><tr><td data-num="44"></td><td><pre>  - alert: 内存饱和度⾼</pre></td></tr><tr><td data-num="45"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">10</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="47"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="48"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="49"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="50"></td><td><pre>      summary: <span class="token string">"主机内存内存饱和度高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      description: <span class="token string">"SWAP内存使用率已连续2分钟超过10%，表明内存饱和度过⾼，当前SWAP使用率为：%。"</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      </pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h6 id="133-配置磁盘告警规则"><a class="anchor" href="#133-配置磁盘告警规则">#</a> 1.3.3 配置磁盘告警规则</h6><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/node_rules.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>groups:</pre></td></tr><tr><td data-num="3"></td><td><pre>- name: CPU告警规则</pre></td></tr><tr><td data-num="4"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="5"></td><td><pre>  - alert: 节点处于Down状态</pre></td></tr><tr><td data-num="6"></td><td><pre>    expr: up <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="8"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="10"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="11"></td><td><pre>      summary: <span class="token string">"节点处于Down状态,实例:"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      description: <span class="token string">" 节点已关闭"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      </pre></td></tr><tr><td data-num="14"></td><td><pre>  - alert: 节点CPU使率超过80%</pre></td></tr><tr><td data-num="15"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - avg<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> <span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="17"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="18"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="19"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="20"></td><td><pre>      summary: <span class="token string">"主机CPU利率过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      description: <span class="token string">"该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。"</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  - alert: CPU饱和度过⾼</pre></td></tr><tr><td data-num="24"></td><td><pre>    expr: sum<span class="token punctuation">(</span>node_load1<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token punctuation">(</span>count<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> * <span class="token number">2</span><span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="26"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="27"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="28"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="29"></td><td><pre>      summary: <span class="token string">"CPU饱和度过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      description: <span class="token string">"该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。"</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  - alert: 主机内存不⾜</pre></td></tr><tr><td data-num="33"></td><td><pre>    expr: <span class="token punctuation">(</span>node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes<span class="token punctuation">)</span> / node_memory_MemTotal_bytes * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="35"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="36"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="37"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="38"></td><td><pre>      summary: <span class="token string">"主机内存使用率较高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      description: <span class="token string">"该实例的内存使用率持续2分钟高于80%，当前利用率：%"</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - alert: 内存饱和度⾼</pre></td></tr><tr><td data-num="42"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">10</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="44"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="45"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="46"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="47"></td><td><pre>      summary: <span class="token string">"主机内存内存饱和度高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      description: <span class="token string">"SWAP内存使用率已连续2分钟超过10%，表明内存饱和度过⾼，当前SWAP使用率为：%。"</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>- name: 磁盘告警规则</pre></td></tr><tr><td data-num="51"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="52"></td><td><pre>  - alert: 磁盘空间告急</pre></td></tr><tr><td data-num="53"></td><td><pre>    expr: <span class="token punctuation">(</span> node_filesystem_size_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> - node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> / node_filesystem_size_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">70</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="55"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="56"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="57"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="58"></td><td><pre>      summary: <span class="token string">"实例  磁盘 分区空间不足"</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      description: <span class="token string">"实例  磁盘  分区空间使用率已超过 70%，当前使用率为 %，请及时处理。"</span></pre></td></tr><tr><td data-num="60"></td><td><pre>          </pre></td></tr><tr><td data-num="61"></td><td><pre>  - alert: 磁盘Inode空间告急</pre></td></tr><tr><td data-num="62"></td><td><pre>    expr: <span class="token punctuation">(</span>node_filesystem_files<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> - node_filesystem_files_free<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> / node_filesystem_files<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">70</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="64"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="65"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="66"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="67"></td><td><pre>      summary: <span class="token string">"实例  磁盘 分区Inode空间不足"</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      description: <span class="token string">"实例  磁盘  分区的Inode空间使用率已超过 70%，，当前使用率为 %，请及时处理。"</span></pre></td></tr><tr><td data-num="69"></td><td><pre>          </pre></td></tr><tr><td data-num="70"></td><td><pre>  - alert: 磁盘IOPS写入较高</pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token comment">#expr: sum(rate(node_disk_writes_completed_total[1m])) by (instance,job) / 120 * 100 >60</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">#round 函数可以对值进行四舍五入，磁盘最大 IOPS 为 120 次 /s</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_disk_writes_completed_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">120</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="75"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="76"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="77"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="78"></td><td><pre>      summary: <span class="token string">"实例  IOPS每秒写入次数超过120次/s"</span></pre></td></tr><tr><td data-num="79"></td><td><pre>      description: </pre></td></tr><tr><td data-num="80"></td><td><pre>        当前磁盘IOPS写入饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼47--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="81"></td><td><pre>        当前磁盘IOPS每秒写入最大 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼48--<span class="token operator">></span> 次/s</pre></td></tr><tr><td data-num="82"></td><td><pre>                </pre></td></tr><tr><td data-num="83"></td><td><pre>  - alert: 磁盘IOPS读取较高</pre></td></tr><tr><td data-num="84"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_disk_reads_completed_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">120</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="86"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="87"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="88"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="89"></td><td><pre>      summary: <span class="token string">"实例  IOPS每秒读取次数超过120次/s"</span></pre></td></tr><tr><td data-num="90"></td><td><pre>      description:</pre></td></tr><tr><td data-num="91"></td><td><pre>        当前磁盘IOPS读取饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼50--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="92"></td><td><pre>        当前磁盘IOPS每秒读取最⼤ <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼51--<span class="token operator">></span> 次/s</pre></td></tr><tr><td data-num="93"></td><td><pre>  </pre></td></tr><tr><td data-num="94"></td><td><pre>  - alert: 磁盘IO写入吞吐较高</pre></td></tr><tr><td data-num="95"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_written_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">1024</span> /1024 / <span class="token number">30</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="97"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="98"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="99"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="100"></td><td><pre>      summary: <span class="token string">"实例  磁盘IO写入每秒超过最高30MB/s"</span></pre></td></tr><tr><td data-num="101"></td><td><pre>      description:</pre></td></tr><tr><td data-num="102"></td><td><pre>        当前磁盘IO写入吞吐量的饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼53--<span class="token operator">></span>%。</pre></td></tr><tr><td data-num="103"></td><td><pre>        当前磁盘IO写入吞吐量每秒最大是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼54--<span class="token operator">></span>MB/s</pre></td></tr><tr><td data-num="104"></td><td><pre></pre></td></tr><tr><td data-num="105"></td><td><pre>  - alert: 磁盘IO读取吞吐较高</pre></td></tr><tr><td data-num="106"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_read_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">1024</span> /1024 /30 * <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="108"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="109"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="110"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="111"></td><td><pre>      summary: <span class="token string">"实例  磁盘IO读取每秒超过最大30MB/s"</span></pre></td></tr><tr><td data-num="112"></td><td><pre>      description:</pre></td></tr><tr><td data-num="113"></td><td><pre>        当前磁盘IO读取吞吐量的饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼56--<span class="token operator">></span>%。</pre></td></tr><tr><td data-num="114"></td><td><pre>        当前磁盘IO读取吞吐量每秒最大是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼57--<span class="token operator">></span>MB/s</pre></td></tr><tr><td data-num="115"></td><td><pre>.instance <span class="token variable">$labels</span>.job <span class="token operator">|</span> query <span class="token operator">|</span> first <span class="token operator">|</span> value <span class="token operator">|</span> <span class="token builtin class-name">printf</span> <span class="token string">"%.2f"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>MB/s</pre></td></tr><tr><td data-num="116"></td><td><pre></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr><tr><td data-num="122"></td><td><pre></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token comment">#根据过去 24 小时磁盘使用情况，计算未来 30 天磁盘使用空间</span></pre></td></tr><tr><td data-num="124"></td><td><pre>predict_linear<span class="token punctuation">(</span>node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!</span>~<span class="token string">"tmpfs|rootfs"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>24h<span class="token punctuation">]</span>,60*60*24*30<span class="token punctuation">)</span> /1024/1024/1024</pre></td></tr></table></figure><h6 id="134-配置网络告警规则"><a class="anchor" href="#134-配置网络告警规则">#</a> 1.3.4 配置⽹络告警规则</h6><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/node_rules.yml </span></pre></td></tr><tr><td data-num="2"></td><td><pre>groups:</pre></td></tr><tr><td data-num="3"></td><td><pre>- name: 节点告警规则</pre></td></tr><tr><td data-num="4"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="5"></td><td><pre>  - alert: 节点处于Down状态</pre></td></tr><tr><td data-num="6"></td><td><pre>    expr: up <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="8"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="10"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="11"></td><td><pre>      summary: <span class="token string">"节点处于Down状态,实例:"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      description: <span class="token string">" 节点已关闭"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      </pre></td></tr><tr><td data-num="14"></td><td><pre>  - alert: 节点CPU使率超过80%</pre></td></tr><tr><td data-num="15"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - avg<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> <span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="17"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="18"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="19"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="20"></td><td><pre>      summary: <span class="token string">"主机CPU利率过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      description: <span class="token string">"该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。"</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  - alert: CPU饱和度过高</pre></td></tr><tr><td data-num="24"></td><td><pre>    expr: sum<span class="token punctuation">(</span>node_load1<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token punctuation">(</span>count<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">&#123;</span>mode<span class="token operator">=</span><span class="token string">"idle"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> * <span class="token number">2</span><span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="26"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="27"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="28"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="29"></td><td><pre>      summary: <span class="token string">"CPU饱和度过高，实例：, 任务:"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      description: <span class="token string">"该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。"</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  - alert: 主机内存不足</pre></td></tr><tr><td data-num="33"></td><td><pre>    expr: <span class="token punctuation">(</span>node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes<span class="token punctuation">)</span> / node_memory_MemTotal_bytes * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="35"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="36"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="37"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="38"></td><td><pre>      summary: <span class="token string">"主机内存使用率较高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      description: <span class="token string">"该实例的内存使用率持续2分钟高于80%，当前利用率：%"</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - alert: 内存饱和度高</pre></td></tr><tr><td data-num="42"></td><td><pre>    expr: <span class="token punctuation">(</span> <span class="token number">1</span> - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">10</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    for: 2m</pre></td></tr><tr><td data-num="44"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="45"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="46"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="47"></td><td><pre>      summary: <span class="token string">"主机内存内存饱和度高, 实例:, 任务:"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      description: <span class="token string">"SWAP内存使用率已连续2分钟超过10%，表明内存饱和度过高，当前SWAP使用率为：%。"</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>  - alert: 磁盘空间告急</pre></td></tr><tr><td data-num="51"></td><td><pre>    expr: <span class="token punctuation">(</span> node_filesystem_size_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> - node_filesystem_avail_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> / node_filesystem_size_bytes<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">70</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="53"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="54"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="55"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="56"></td><td><pre>      summary: <span class="token string">"实例  磁盘 分区空间不足"</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      description: <span class="token string">"实例  磁盘  分区空间使用率已超过 70%，当前使用率为 %，请及时处理。"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>          </pre></td></tr><tr><td data-num="59"></td><td><pre>  - alert: 磁盘Inode空间告急</pre></td></tr><tr><td data-num="60"></td><td><pre>    expr: <span class="token punctuation">(</span>node_filesystem_files<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> - node_filesystem_files_free<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> / node_filesystem_files<span class="token punctuation">&#123;</span>device<span class="token operator">!=</span><span class="token string">"tmpfs"</span><span class="token punctuation">&#125;</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">70</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="62"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="63"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="64"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="65"></td><td><pre>      summary: <span class="token string">"实例  磁盘 分区Inode空间不足"</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      description: <span class="token string">"实例  磁盘  分区的Inode空间使用率已超过 70%，，当前使用率为 %，请及时处理。"</span></pre></td></tr><tr><td data-num="67"></td><td><pre>          </pre></td></tr><tr><td data-num="68"></td><td><pre>  - alert: 磁盘IOPS写入较高</pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">#expr: sum(rate(node_disk_writes_completed_total[1m])) by (instance,job) / 120 * 100 >60</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token comment">#round 函数可以对值进行四舍五入，磁盘最大 IOPS 为 120 次 /s</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_disk_writes_completed_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">120</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="73"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="74"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="75"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="76"></td><td><pre>      summary: <span class="token string">"实例  IOPS每秒写入次数超过120次/s"</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      description: </pre></td></tr><tr><td data-num="78"></td><td><pre>        当前磁盘IOPS写入饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼83--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="79"></td><td><pre>        当前磁盘IOPS每秒写入最大 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼84--<span class="token operator">></span> 次/s</pre></td></tr><tr><td data-num="80"></td><td><pre>                </pre></td></tr><tr><td data-num="81"></td><td><pre>  - alert: 磁盘IOPS读取较高</pre></td></tr><tr><td data-num="82"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_disk_reads_completed_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">120</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="84"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="85"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="86"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="87"></td><td><pre>      summary: <span class="token string">"实例  IOPS每秒读取次数超过120次/s"</span></pre></td></tr><tr><td data-num="88"></td><td><pre>      description:</pre></td></tr><tr><td data-num="89"></td><td><pre>        当前磁盘IOPS读取饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼86--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="90"></td><td><pre>        当前磁盘IOPS每秒读取最⼤ <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼87--<span class="token operator">></span> 次/s</pre></td></tr><tr><td data-num="91"></td><td><pre>  </pre></td></tr><tr><td data-num="92"></td><td><pre>  - alert: 磁盘IO写入吞吐较高</pre></td></tr><tr><td data-num="93"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_written_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">1024</span> /1024 / <span class="token number">30</span> * <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="95"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="96"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="97"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="98"></td><td><pre>      summary: <span class="token string">"实例  磁盘IO写入每秒超过最高30MB/s"</span></pre></td></tr><tr><td data-num="99"></td><td><pre>      description:</pre></td></tr><tr><td data-num="100"></td><td><pre>        当前磁盘IO写入吞吐量的饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼89--<span class="token operator">></span>%。</pre></td></tr><tr><td data-num="101"></td><td><pre>        当前磁盘IO写入吞吐量每秒最大是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼90--<span class="token operator">></span>MB/s</pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>  - alert: 磁盘IO读取吞吐较高</pre></td></tr><tr><td data-num="104"></td><td><pre>    expr: round<span class="token punctuation">(</span>max<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>node_disk_read_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> / <span class="token number">1024</span> /1024 /30 * <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="106"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="107"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="108"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="109"></td><td><pre>      summary: <span class="token string">"实例  磁盘IO读取每秒超过最大30MB/s"</span></pre></td></tr><tr><td data-num="110"></td><td><pre>      description:</pre></td></tr><tr><td data-num="111"></td><td><pre>        当前磁盘IO读取吞吐量的饱和度是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼92--<span class="token operator">></span>%。</pre></td></tr><tr><td data-num="112"></td><td><pre>        当前磁盘IO读取吞吐量每秒最大是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼93--<span class="token operator">></span>MB/s</pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>  - alert: 网络下载带宽异常</pre></td></tr><tr><td data-num="115"></td><td><pre>    expr: max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_network_receive_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> * <span class="token number">8</span> / <span class="token number">1024</span> / <span class="token number">1024</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job,device<span class="token punctuation">)</span> / <span class="token number">50</span> * <span class="token number">100</span> <span class="token operator">>=</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="117"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="118"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="119"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="120"></td><td><pre>      summary: <span class="token string">"实例  的  接口下载流量已经超过公司实际50Mbps"</span></pre></td></tr><tr><td data-num="121"></td><td><pre>      description:</pre></td></tr><tr><td data-num="122"></td><td><pre>        当前下载带宽已经达到 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼96--<span class="token operator">></span> Mbps/s</pre></td></tr><tr><td data-num="123"></td><td><pre>        当前下载带宽使用率在 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼97--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="124"></td><td><pre>  </pre></td></tr><tr><td data-num="125"></td><td><pre>  - alert: 网络上传带宽异常</pre></td></tr><tr><td data-num="126"></td><td><pre>    expr: max<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_network_transmit_bytes_total<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">)</span> * <span class="token number">8</span> / <span class="token number">1024</span> / <span class="token number">1024</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job,device<span class="token punctuation">)</span> / <span class="token number">50</span> * <span class="token number">100</span> <span class="token operator">>=</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="128"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="129"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="130"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="131"></td><td><pre>      summary: <span class="token string">"实例  的  接口上传流量已经超过公司实际50Mbps"</span></pre></td></tr><tr><td data-num="132"></td><td><pre>      description:</pre></td></tr><tr><td data-num="133"></td><td><pre>        当前上传带宽已经达到 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼100--<span class="token operator">></span> Mbps/s</pre></td></tr><tr><td data-num="134"></td><td><pre>        当前上传带宽使用率在 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼101--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml</span></pre></td></tr><tr><td data-num="138"></td><td><pre></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="14-检查告警规则文件"><a class="anchor" href="#14-检查告警规则文件">#</a> 1.4 检查告警规则⽂件</h5><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/fAluZFK.jpeg" alt="1.jpg"></p><h5 id="15-导入-grafana-模板"><a class="anchor" href="#15-导入-grafana-模板">#</a> 1.5 导入 Grafana 模板</h5><p>在 Grafana 的官方插件库中，有很多 Node-exporter 模板。其中相对受欢的模板的 ID 是： ﻿11074、1860﻿。</p><p>11074﻿：模板包括了 CPU、内存、磁盘、网络、温度传感器等指标（常用）。</p><p>1860﻿：模板包括 CPU、内存、磁盘、网络等。这运行状况，及时发现潜在问题并进行调优。</p><h4 id="二-prometheus监控rabbitmq"><a class="anchor" href="#二-prometheus监控rabbitmq">#</a> 二. Prometheus 监控 RabbitmQ</h4><h5 id="21-配置prometheus"><a class="anchor" href="#21-配置prometheus">#</a> 2.1 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="7"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="10"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="11"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="19"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="24"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="29"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="34"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="39"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">#2. 重载 Prometheus</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="22-rabbitmq告警规则文件"><a class="anchor" href="#22-rabbitmq告警规则文件">#</a> 2.2 RabbitMQ 告警规则文件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 配置 rabbitmq 告警规则</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/rabbitmq_rules.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>groups:</pre></td></tr><tr><td data-num="4"></td><td><pre>- name: rabbitmq告警规则</pre></td></tr><tr><td data-num="5"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="6"></td><td><pre>  - alert: RabbitMQDown</pre></td></tr><tr><td data-num="7"></td><td><pre>    expr: up<span class="token punctuation">&#123;</span>instance<span class="token operator">=</span><span class="token string">"prom-node02.oldxu.net:15692"</span>, <span class="token assign-left variable">job</span><span class="token operator">=</span><span class="token string">"rabbitmq"</span><span class="token punctuation">&#125;</span> <span class="token operator">!=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>      severity: High</pre></td></tr><tr><td data-num="10"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="11"></td><td><pre>      summary: <span class="token string">"Rabbitmq Down,实例:"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      description: <span class="token string">"Rabbitmq_exporter连不上RabbitMQ!"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  </pre></td></tr><tr><td data-num="14"></td><td><pre>  - alert: RabbitMQ队列已就绪的消息过多</pre></td></tr><tr><td data-num="15"></td><td><pre>    expr: avg_over_time<span class="token punctuation">(</span>rabbitmq_queue_messages_ready<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">500</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="17"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="18"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="19"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="20"></td><td><pre>      summary: <span class="token string">' RabbitMQ实例的队列消息准备过多'</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      description: <span class="token string">'实例中平均准备好待消费的消息数量超过500，当前平均值为。'</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          </pre></td></tr><tr><td data-num="23"></td><td><pre>  - alert: RabbitMQ队列中已消费但未确认的消息过多</pre></td></tr><tr><td data-num="24"></td><td><pre>    expr: avg_over_time<span class="token punctuation">(</span>rabbitmq_queue_messages_unacked<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">500</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="26"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="27"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="28"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="29"></td><td><pre>      summary: <span class="token string">' RabbitMQ实例的队列消息确认存在延迟'</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      description: <span class="token string">' 实例中平均已被消费但未被确认的消息数量超过500，当前平均值为。'</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          </pre></td></tr><tr><td data-num="32"></td><td><pre>  - alert: RabbitMQ磁盘空间预测不足</pre></td></tr><tr><td data-num="33"></td><td><pre>    expr: predict_linear<span class="token punctuation">(</span>rabbitmq_disk_space_available_bytes<span class="token punctuation">[</span>24h<span class="token punctuation">]</span>, <span class="token number">60</span>*60*24*10<span class="token punctuation">)</span> <span class="token operator">&lt;</span> rabbitmq_disk_space_available_limit_bytes</pre></td></tr><tr><td data-num="34"></td><td><pre>    for: 1h</pre></td></tr><tr><td data-num="35"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="36"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="37"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="38"></td><td><pre>      summary: <span class="token string">' RabbitMQ实例的磁盘空间预测不足。'</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      description: <span class="token string">'基于过去24小时磁盘可用空间数据预测，未来10天内磁盘的可用空间可能低于默认配置的50MB。'</span></pre></td></tr><tr><td data-num="40"></td><td><pre> </pre></td></tr><tr><td data-num="41"></td><td><pre>  - alert: RabbitMQ文件描述符使用率过高</pre></td></tr><tr><td data-num="42"></td><td><pre>    expr: max_over_time<span class="token punctuation">(</span>rabbitmq_process_open_fds<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> / rabbitmq_process_max_fds * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="44"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="45"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="46"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="47"></td><td><pre>      summary: <span class="token string">' RabbitMQ实例的文件描述符使用率过高'</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      description: <span class="token string">' 实例打开的文件描述符数量最大值，占文件描述限制的比率超过80%，当前比率为%。'</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          </pre></td></tr><tr><td data-num="50"></td><td><pre>  - alert: RabbitMQ TCP套接字使用率过高</pre></td></tr><tr><td data-num="51"></td><td><pre>    expr: max_over_time<span class="token punctuation">(</span>rabbitmq_process_open_tcp_sockets<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> / rabbitmq_process_max_tcp_sockets * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="53"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="54"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="55"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="56"></td><td><pre>      summary: <span class="token string">' RabbitMQ实例的TCP套接字使用率过高'</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      description: <span class="token string">' 实例打开的TCP套接字数量最大值，占操作系统允许的TCP连接数限制的比率超过80%，当前比率为%。'</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      </pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/rabbitmq_rules.yml </span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="23-导入-grafana-模板"><a class="anchor" href="#23-导入-grafana-模板">#</a> 2.3 导入 Grafana 模板</h5><p>导⼊ RabbitMQ 的 Grafana 模板。ID 为 10991</p><h4 id="三-prometheus监控nginx"><a class="anchor" href="#三-prometheus监控nginx">#</a> 三. Prometheus 监控 Nginx</h4><h5 id="31-安装并配置nginx"><a class="anchor" href="#31-安装并配置nginx">#</a> 3.1 安装并配置 Nginx</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 安装 Nginx</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># yum install nginx -y</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/nginx/conf.d/mointor.oldxu.net.conf</span></pre></td></tr><tr><td data-num="4"></td><td><pre>server <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	 listen <span class="token number">8888</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	 server_name monitor.oldxu.net<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	 location /nginx_status <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		 stub_status on<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> 	 <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># nginx -t</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable nginx &amp;&amp; systemctl start nginx</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#2. 检查 Nginx 的状态⻚⾯</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment">#  curl http://localhost:8888/nginx_status</span></pre></td></tr><tr><td data-num="16"></td><td><pre>Active connections: <span class="token number">1</span> </pre></td></tr><tr><td data-num="17"></td><td><pre>server accepts handled requests</pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> </pre></td></tr><tr><td data-num="19"></td><td><pre>Reading: <span class="token number">0</span> Writing: <span class="token number">1</span> Waiting: <span class="token number">0</span></pre></td></tr></table></figure><h5 id="32-安装并配置nginx-exporter"><a class="anchor" href="#32-安装并配置nginx-exporter">#</a> 3.2 安装并配置 Nginx-exporter</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 下载 Nginx-exporter</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v1.1.0/nginx-prometheus-exporter_1.1.0_linux_amd64.tar.gz</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#加速地址</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.ghproxy.com/https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v1.1.0/nginx-prometheus-exporter_1.1.0_linux_amd64.tar.gz</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#2. 将 Nginx_exporter 安装到指定的路径</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/nginx_exporter_1.1.0</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># tar xf nginx-prometheus-exporter_1.1.0_linux_amd64.tar.gz -C /etc/nginx_exporter_1.1.0/</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/nginx_exporter_1.1.0/ /etc/nginx_exporter</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 nginx_exporter<span class="token punctuation">]</span><span class="token comment"># ./nginx-prometheus-exporter --web.listen-address=:9113 --nginx.scrape-uri=http://127.0.0.1:8888/nginx_status</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#3. 为 nginx_exporter 准备 system 启停⽂件</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/nginx_exporter.service</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>nginx-exporter</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/etc/nginx_exporter/nginx-prometheus-exporter <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  --web.listen-address<span class="token operator">=</span>:9113 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  --web.telemetry-path<span class="token operator">=</span><span class="token string">"/metrics"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  --nginx.scrape-uri<span class="token operator">=</span>http://127.0.0.1:8888/nginx_status</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">20</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">#4. 启动 nginx_exporter 服务，它默认监听在 9113 端⼝上</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment">#  systemctl daemon-reload &amp;&amp; systemctl enable nginx_exporter &amp;&amp; systemctl start nginx_exporter</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 9113</span></pre></td></tr><tr><td data-num="32"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::9113                 :::*                    LISTEN      <span class="token number">1829</span>/nginx-promethe </pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">#5. 访问 nginx_exporter 暴露的 metrics，检查是否能获取到对应的指标数据</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 nginx_exporter<span class="token punctuation">]</span><span class="token comment">#  curl http://127.0.0.1:9113/metrics</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># TYPE go_gc_duration_seconds summary</span></pre></td></tr><tr><td data-num="38"></td><td><pre>go_gc_duration_seconds<span class="token punctuation">&#123;</span>quantile<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">&#125;</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="39"></td><td><pre>go_gc_duration_seconds<span class="token punctuation">&#123;</span>quantile<span class="token operator">=</span><span class="token string">"0.25"</span><span class="token punctuation">&#125;</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="40"></td><td><pre>go_gc_duration_seconds<span class="token punctuation">&#123;</span>quantile<span class="token operator">=</span><span class="token string">"0.5"</span><span class="token punctuation">&#125;</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="41"></td><td><pre>go_gc_duration_seconds<span class="token punctuation">&#123;</span>quantile<span class="token operator">=</span><span class="token string">"0.75"</span><span class="token punctuation">&#125;</span> <span class="token number">0</span></pre></td></tr></table></figure><h5 id="33-配置prometheus"><a class="anchor" href="#33-配置prometheus">#</a> 3.3 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="7"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="10"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="11"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="19"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="24"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="29"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="34"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="39"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="44"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">#2. 重载 Prometheus</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="34-nginx告警规则文件"><a class="anchor" href="#34-nginx告警规则文件">#</a> 3.4 Nginx 告警规则⽂件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 具体的告警规则示例⽂件（需要根据公司实际情况进⾏调整）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/nginx_rules.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>groups:</pre></td></tr><tr><td data-num="4"></td><td><pre>- name: nginx告警规则</pre></td></tr><tr><td data-num="5"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="6"></td><td><pre>  - alert: Nginx Server Down</pre></td></tr><tr><td data-num="7"></td><td><pre>    expr: nginx_up <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="9"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="10"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="11"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="12"></td><td><pre>      summary: <span class="token string">"Nginx 服务不存活, 实例:"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      description: <span class="token string">"nginx_exporter连不上Nginx了，当前状态为: "</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          </pre></td></tr><tr><td data-num="15"></td><td><pre>  - alert: Nginx活跃连接数过高</pre></td></tr><tr><td data-num="16"></td><td><pre>    expr: avg_over_time<span class="token punctuation">(</span>nginx_connections_active<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">500</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="18"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="19"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="20"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="21"></td><td><pre>      summary: <span class="token string">"Nginx 活跃连接数过高, 实例:"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      description: <span class="token string">" Nginx 的平均活跃连接数超过了设定的500阈值，当前值为 。"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          </pre></td></tr><tr><td data-num="24"></td><td><pre>  - alert: Nginx等待连接数高</pre></td></tr><tr><td data-num="25"></td><td><pre>    expr: max_over_time<span class="token punctuation">(</span>nginx_connections_waiting<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">100</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="27"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="28"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="29"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="30"></td><td><pre>      summary: <span class="token string">"Nginx 等待连接数过高, 实例:"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      description: <span class="token string">"Nginx 的等待连接数超过了设定的100阈值，当前最大值为 。可能后端服务存在瓶颈。"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          </pre></td></tr><tr><td data-num="33"></td><td><pre>  - alert: Nginx读写入率异常</pre></td></tr><tr><td data-num="34"></td><td><pre>    expr: <span class="token punctuation">(</span>nginx_connections_reading - nginx_connections_writing<span class="token punctuation">)</span> / nginx_connections_reading * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">10</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="36"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="37"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="38"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="39"></td><td><pre>      summary: <span class="token string">"Nginx 读写入率异常, 实例:"</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      description: <span class="token string">"Nginx 读取请求的数量高于写请求的数量，当前读请求高于写请求比率是: "</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  - alert: Nginx⼤量TCP连接处理失败</pre></td></tr><tr><td data-num="42"></td><td><pre>    expr: nginx_connections_accepted - nginx_connections_handled <span class="token operator">></span> <span class="token number">50</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="44"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="45"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="46"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="47"></td><td><pre>      summary: <span class="token string">"Nginx 大量TCP连接处理失败, 实例:"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      description: <span class="token string">"Nginx 接受的连接数与处理成功的连接数之差超过了50，当前差值为"</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      </pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="35-导入-grafana-模板"><a class="anchor" href="#35-导入-grafana-模板">#</a> 3.5 导入 Grafana 模板</h5><p>导⼊ nginx 的 Grafana 模板。ID 为 12708</p><h4 id="四-prometheus监控tomcat"><a class="anchor" href="#四-prometheus监控tomcat">#</a> 四. Prometheus 监控 Tomcat</h4><h5 id="41-安装并配置tomcat"><a class="anchor" href="#41-安装并配置tomcat">#</a> 4.1 安装并配置 Tomcat</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 安装 tomcat</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 nginx_exporter<span class="token punctuation">]</span><span class="token comment"># yum install tomcat tomcat-webapps -y</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#2. 下载所依赖的 jar 包</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient/0.12.0/simpleclient-0.12.0.jar</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_common/0.12.0/simpleclient_common-0.12.0.jar</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_hotspot/0.12.0/simpleclient_hotspot-0.12.0.jar</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_servlet/0.12.0/simpleclient_servlet-0.12.0.jar</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_servlet_common/0.12.0/simpleclient_servlet_common-0.12.0.jar</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://search.maven.org/remotecontent?filepath=nl/nlighten/tomcat_exporter_client/0.0.15/tomcat_exporter_client-0.0.15.jar</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://search.maven.org/remotecontent?filepath=nl/nlighten/tomcat_exporter_servlet/0.0.15/tomcat_exporter_servlet-0.0.15.war</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 整合包的下载地址</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.ghproxy.com/https://github.com/Im-oldxu/tomcat-exporter/releases/download/tomcat_exporter-0.0.17/tomcat_exporter.tar.gz</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#3. 将 jar 包和 war 包分别拷⻉⾄对应的⽬录下</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># cp tomcat_exporter/*.jar /usr/share/tomcat/lib/</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># cp tomcat_exporter/*.war /usr/share/tomcat/webapps/</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#4. 启动 Tomcat</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start tomcat &amp;&amp; systemctl enable tomcat</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">#5. 访问 tomcat 的 metrics</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># curl http://localhost:8080/metrics/</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># TYPE process_cpu_seconds_total counter</span></pre></td></tr><tr><td data-num="26"></td><td><pre>process_cpu_seconds_total <span class="token number">7.37</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># HELP process_start_time_seconds Start time of the process since unix epoch in seconds.</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># TYPE process_start_time_seconds gauge</span></pre></td></tr><tr><td data-num="29"></td><td><pre>process_start_time_seconds <span class="token number">1</span>.70921425481E9</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># HELP process_open_fds Number of open file descriptors.</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># TYPE process_open_fds gauge</span></pre></td></tr><tr><td data-num="32"></td><td><pre>process_open_fds <span class="token number">65.0</span></pre></td></tr></table></figure><h5 id="42-配置prometheus"><a class="anchor" href="#42-配置prometheus">#</a> 4.2 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="7"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="10"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="11"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="19"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="24"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="29"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="34"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="39"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="44"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="49"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">#. 重载 Prometheus</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="43-tomcat告警规则文件"><a class="anchor" href="#43-tomcat告警规则文件">#</a> 4.3 Tomcat 告警规则⽂件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 具体的告警规则示例⽂件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/tomcat_rules.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>groups:</pre></td></tr><tr><td data-num="4"></td><td><pre>- name: tomcat告警规则</pre></td></tr><tr><td data-num="5"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="6"></td><td><pre>  - alert: Tomcat活跃连接数过⾼</pre></td></tr><tr><td data-num="7"></td><td><pre>    expr: tomcat_connections_active_total / tomcat_connections_active_max* <span class="token number">100</span> <span class="token operator">>=</span><span class="token number">80</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="9"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="10"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="11"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="12"></td><td><pre>      summary: <span class="token string">"Tomcat服务器活跃连接数过高, 实例:"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      description:</pre></td></tr><tr><td data-num="14"></td><td><pre>        Tomcat最大连接数是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼127--<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>        Tomcat目前连接数是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼128--<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre>        Tomcat活跃连接数已超过最大活跃连接数的80%, 当前值为 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼129--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="17"></td><td><pre>                </pre></td></tr><tr><td data-num="18"></td><td><pre>  - alert: Tomcat处理请求超过5秒</pre></td></tr><tr><td data-num="19"></td><td><pre>    expr: rate<span class="token punctuation">(</span>tomcat_requestprocessor_time_seconds<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">5</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="21"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="22"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="23"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="24"></td><td><pre>      summary: <span class="token string">"Tomcat处理请求时间过长, 实例:"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      description: <span class="token string">"Tomcat在过去5分钟的平均处理请求时间超过5秒，当前值 。"</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          </pre></td></tr><tr><td data-num="27"></td><td><pre>  - alert: <span class="token string">"Tomcat会话拒绝率超过20%"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    expr: <span class="token punctuation">(</span>tomcat_session_rejected_total / <span class="token punctuation">(</span>tomcat_session_created_total +tomcat_session_rejected_total<span class="token punctuation">))</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">20</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="30"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="31"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="32"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="33"></td><td><pre>      summary: <span class="token string">"Tomcat会话拒绝率过高, 实例:"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      description: <span class="token string">"Tomcat在Host: 的  的上下文中的会话拒绝率超过20%，当前值 。"</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          </pre></td></tr><tr><td data-num="36"></td><td><pre>  - alert: <span class="token string">"Tomcat线程使用率过高"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    expr: <span class="token punctuation">(</span>tomcat_threads_active_total / tomcat_threads_max<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="39"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="40"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="41"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="42"></td><td><pre>      summary: <span class="token string">"Tomcat线程使⽤率过⾼, 实例:"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      description:</pre></td></tr><tr><td data-num="44"></td><td><pre>        Tmcat最大线程数是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼137--<span class="token operator">></span></pre></td></tr><tr><td data-num="45"></td><td><pre>        Tomcat目前线程数是 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼138--<span class="token operator">></span></pre></td></tr><tr><td data-num="46"></td><td><pre>        Tomcat线程数已超过最大活跃连接数的80%, 当前值为 <span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼139--<span class="token operator">></span>%</pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="44-导入-grafana-模板"><a class="anchor" href="#44-导入-grafana-模板">#</a> 4.4 导入 Grafana 模板</h5><p>1、下载对应的 dashboard</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> https://mirror.ghproxy.com/https://github.com/nlighten/tomcat_exporter/blob/master/dashboard/example.json</pre></td></tr></table></figure><h4 id="五-prometheus监控springboot"><a class="anchor" href="#五-prometheus监控springboot">#</a> 五. Prometheus 监控 SpringBoot</h4><h5 id="51-下载jmx-exporter"><a class="anchor" href="#51-下载jmx-exporter">#</a> 5.1 下载 jmx-exporter</h5><p>1、访问 github， <a target="_blank" rel="noopener" href="https://github.com/prometheus/jmx_exporter/releases">https://github.com/prometheus/jmx_exporter/releases</a> ，下载 java-expoter</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/jmx_exporter</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/jmx_exporter</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 springboot<span class="token punctuation">]</span><span class="token comment"># wget https://repo.maven.apache.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.20.0/jmx_prometheus_javaagent-0.20.0.jar</span></pre></td></tr></table></figure><p>2、准备 config.yml 配置⽂件（规则⽂件可以定义要暴露哪些指标给 Prometheus）</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/jmx_exporter/config.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>rules:</pre></td></tr><tr><td data-num="3"></td><td><pre>- pattern: <span class="token string">".*"</span></pre></td></tr></table></figure><h5 id="52-运行springboot应用"><a class="anchor" href="#52-运行springboot应用">#</a> 5.2 运⾏ SpringBoot 应⽤</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、安装 java 基础环境</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment">#  yum install java-11-openjdk maven -y</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget -O /etc/maven/settings.xml https://linux.oldxu.net/settings.xml</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#2、下载 java 应⽤然后进⾏编译</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget http://file.oldxu.net/jenkins/springboot-devops-myapp-java11-jar.tar.gz</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># tar xf springboot-devops-myapp-java11-jar.tar.gz</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># cd springboot-devops-myapp-jar/</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 springboot-devops-myapp-jar<span class="token punctuation">]</span><span class="token comment"># mvn package</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#3、运⾏ java 应⽤，并加载 jmx 监控，监听 12345 端⼝， &lt;path_to_jmx_exporter.jar>=&lt;exporter_port>:&lt;path_to_config.yaml></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 springboot-devops-myapp-jar<span class="token punctuation">]</span><span class="token comment"># java \</span></pre></td></tr><tr><td data-num="13"></td><td><pre> -javaagent:/etc/jmx_exporter/jmx_prometheus_javaagent-0.20.0.jar<span class="token operator">=</span><span class="token number">12345</span>:/etc/jmx_exporter/config.yaml <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token parameter variable">-jar</span> <span class="token parameter variable">-Xms50m</span> <span class="token parameter variable">-Xmx50m</span> target/devops-myapp-1.0.jar <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token parameter variable">--server.port</span><span class="token operator">=</span><span class="token number">8081</span> <span class="token operator">&amp;></span>/var/log/springboot.log <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token comment">#4、检查对应的端⼝是否正常</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">[</span>root@prom-node03 springboot-devops-myapp-jar<span class="token punctuation">]</span><span class="token comment"># curl http://localhost:12345/metrics</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># HELP jmx_scrape_error Non-zero if this scrape failed.</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># TYPE jmx_scrape_error gauge</span></pre></td></tr><tr><td data-num="21"></td><td><pre>jmx_scrape_error <span class="token number">0.0</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># HELP jmx_scrape_cached_beans Number of beans with their matching rule cached</span></pre></td></tr></table></figure><h5 id="53-配置prometheus"><a class="anchor" href="#53-配置prometheus">#</a> 5.3 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="7"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="10"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="11"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="19"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="24"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="29"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="34"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="39"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="44"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="49"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="54"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">#2. 重载 Prometheus</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="54-jmx告警规则文件"><a class="anchor" href="#54-jmx告警规则文件">#</a> 5.4 JMX 告警规则⽂件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/jvm_rules.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>groups:</pre></td></tr><tr><td data-num="3"></td><td><pre>- name: <span class="token string">"JVM告警规则"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="5"></td><td><pre>  - alert: JVM堆内存使用率过高</pre></td></tr><tr><td data-num="6"></td><td><pre>    expr: jvm_memory_bytes_used<span class="token punctuation">&#123;</span>area<span class="token operator">=</span><span class="token string">"heap"</span>,<span class="token punctuation">&#125;</span> / jvm_memory_bytes_max<span class="token punctuation">&#123;</span>area<span class="token operator">=</span><span class="token string">"heap"</span>,<span class="token punctuation">&#125;</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="8"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="10"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="11"></td><td><pre>      summary: <span class="token string">"JVM 堆内存使用率过高, 实例:, job: "</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      description: <span class="token string">"JVM堆内存使用率超过80%, 当前值 %"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          </pre></td></tr><tr><td data-num="14"></td><td><pre>  - alert: JVMGC时间过长</pre></td></tr><tr><td data-num="15"></td><td><pre>    expr: <span class="token function">sum</span> <span class="token punctuation">(</span>rate<span class="token punctuation">(</span>jvm_gc_collection_seconds_sum<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> / rate<span class="token punctuation">(</span>jvm_gc_collection_seconds_count<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>gc, instance, job<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="17"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="18"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="19"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="20"></td><td><pre>      summary: <span class="token string">"JVM GC时间过长, 实例:, job: "</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      description: <span class="token string">"JVM  的回收时间超过1s，当前值 s"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          </pre></td></tr><tr><td data-num="23"></td><td><pre>  - alert: JVM死锁线程过多</pre></td></tr><tr><td data-num="24"></td><td><pre>    expr: min_over_time<span class="token punctuation">(</span>jvm_threads_deadlocked<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="26"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="27"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="28"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="29"></td><td><pre>      summary: <span class="token string">"JVM检测到死锁线程"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      description: <span class="token string">"在过去5分钟内JVM检测到存在死锁线程, 当前值 。"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      </pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/jvm_rules.yml </span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="55-导入-grafana-模板"><a class="anchor" href="#55-导入-grafana-模板">#</a> 5.5 导入 Grafana 模板</h5><p>导⼊⼀个 JVM 的 Grafana 模板。Dashboard ID 为 14845</p><h4 id="六-安装并配置mysql_master"><a class="anchor" href="#六-安装并配置mysql_master">#</a> 六。安装并配置 mysql_master</h4><h5 id="61-安装并配置mysql_master"><a class="anchor" href="#61-安装并配置mysql_master">#</a> 6.1 安装并配置 mysql_master</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、安装 Mysql5.7</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y mysql-community-server</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>mysql<span class="token operator">></span>  ALTER <span class="token environment constant">USER</span> <span class="token string">'root'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'Superman*2023'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#2、创建⼀个 mysql_exporter 专属的监控账户</span></pre></td></tr><tr><td data-num="8"></td><td><pre>mysql<span class="token operator">></span> create user <span class="token string">'exporter'</span>@<span class="token string">'localhost'</span> identified by <span class="token string">'Superman*2023'</span> WITH MAX_USER_CONNECTIONS <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>mysql<span class="token operator">></span> grant process,replication client,select on *.* to <span class="token string">'exporter'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#3、创建 MySQL 从库复制的账户</span></pre></td></tr><tr><td data-num="12"></td><td><pre>mysql<span class="token operator">></span> grant replication slave on *.* to <span class="token string">'repl'</span>@<span class="token string">'%'</span> identified by <span class="token string">'Superman*2023'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>mysql<span class="token operator">></span> flush privileges<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#4. 配置主库</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/my.cnf</span></pre></td></tr><tr><td data-num="17"></td><td><pre>server-id<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="18"></td><td><pre>log-bin<span class="token operator">=</span>mysql-bin</pre></td></tr><tr><td data-num="19"></td><td><pre>read-only<span class="token operator">=</span><span class="token number">0</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart mysqld</span></pre></td></tr></table></figure><h5 id="62-安装并配置mysql_slave"><a class="anchor" href="#62-安装并配置mysql_slave">#</a> 6.2 安装并配置 mysql_slave</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、从库配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y mysql-community-server</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@db02 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/my.cnf</span></pre></td></tr><tr><td data-num="4"></td><td><pre>server-id<span class="token operator">=</span><span class="token number">2</span></pre></td></tr><tr><td data-num="5"></td><td><pre>read-only<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#2、创建⼀个 mysql_exporter 专属的监控账户</span></pre></td></tr><tr><td data-num="8"></td><td><pre>grant all on *.* to <span class="token string">'exporter'</span>@<span class="token string">'localhost'</span> identified by <span class="token string">'Superman*2023'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#3、获取主库的信息，⽽后配置从库的 change master</span></pre></td></tr><tr><td data-num="11"></td><td><pre>mysql<span class="token operator">></span> show master status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>+------------------+----------+--------------+------------------+-------------------+</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">|</span> File             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span></pre></td></tr><tr><td data-num="14"></td><td><pre>+------------------+----------+--------------+------------------+-------------------+</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">|</span> mysql-bin.000007 <span class="token operator">|</span>      <span class="token number">154</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span></pre></td></tr><tr><td data-num="16"></td><td><pre>+------------------+----------+--------------+------------------+-------------------+</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#4、配置从服务器，连接主服务器</span></pre></td></tr><tr><td data-num="20"></td><td><pre>mysql<span class="token operator">></span> change master to <span class="token assign-left variable">master_host</span><span class="token operator">=</span><span class="token string">'192.168.40.223'</span>,master_user<span class="token operator">=</span><span class="token string">'repl'</span>,master_password<span class="token operator">=</span><span class="token string">'Superman*2023'</span>,master_log_file<span class="token operator">=</span><span class="token string">'mysql-bin.000007'</span>,master_log_pos<span class="token operator">=</span><span class="token number">154</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">#5. 开启从库</span></pre></td></tr><tr><td data-num="23"></td><td><pre>mysql<span class="token operator">></span> start slave<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">#6. 检查主从复制状态</span></pre></td></tr><tr><td data-num="26"></td><td><pre>mysql<span class="token operator">></span> show slave status<span class="token punctuation">\</span>G</pre></td></tr></table></figure><h5 id="63-安装并配置mysqld_exporter"><a class="anchor" href="#63-安装并配置mysqld_exporter">#</a> 6.3 安装并配置 mysqld_exporter</h5><p>1、访问 mysqld_exporter 的 github 地址， <a target="_blank" rel="noopener" href="https://github.com/prometheus/mysqld_exporter/releases">https://github.com/prometheus/mysqld_exporter/releases</a> 下载 mysqld-exporter</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、下载 mysqld_expor</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.0/mysqld_exporter-0.15.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 加速地址</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.ghproxy.com/https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.0/mysqld_exporter-0.15.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#2、解压 mysqld_expor</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># tar xf mysqld_exporter-0.15.0.linux-amd64.tar.gz -C /etc/</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/mysqld_exporter-0.15.0.linux-amd64/ /etc/mysqld_exporter</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#3、启动 mysqld_expor</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># export MYSQLD_EXPORTER_PASSWORD=Superman*2023</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># /etc/mysqld_exporter/mysqld_exporter --mysqld.address=localhost:3306 --mysqld.username=exporter</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#4、编写 mysqld_exporter 启动⽂件</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/mysqld_exporter.service</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>mysqld_exporter</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">'MYSQLD_EXPORTER_PASSWORD=Superman*2023'</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/etc/mysqld_exporter/mysqld_exporter <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token parameter variable">--mysqld.address</span><span class="token operator">=</span>localhost:3306 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token parameter variable">--mysqld.username</span><span class="token operator">=</span>exporter <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        --web.listen-address<span class="token operator">=</span>:9104 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        --web.telemetry-path<span class="token operator">=</span><span class="token string">"/metrics"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token parameter variable">--collect.info_schema.processlist</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token parameter variable">--collect.info_schema.innodb_tablespaces</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token parameter variable">--collect.info_schema.innodb_metrics</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token parameter variable">--collect.info_schema.query_response_time</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token parameter variable">--collect.info_schema.userstats</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token parameter variable">--collect.info_schema.tables</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token parameter variable">--collect.global_status</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token parameter variable">--collect.global_variables</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token parameter variable">--collect.slave_status</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token parameter variable">--collect.binlog_size</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token parameter variable">--collect.engine_innodb_status</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span> <span class="token variable">$MAINPID</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">#4、启动 mysqld_exporter，并检查服务</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start mysqld_exporter</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">#5、测试 mysqld_exporter 能否获取到对应的指标</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp |grep 9104</span></pre></td></tr><tr><td data-num="52"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::9104                 :::*                    LISTEN      <span class="token number">2863</span>/mysqld_exporte </pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment">#  curl http://localhost:9104/metrics</span></pre></td></tr></table></figure><h5 id="64-配置prometheus"><a class="anchor" href="#64-配置prometheus">#</a> 6.4 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="7"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="10"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="11"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="19"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="24"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="29"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="34"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="39"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="44"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="49"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="54"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>  - job_name: <span class="token string">"mysqld_exporter"</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="59"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="61"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="62"></td><td><pre>        role: master</pre></td></tr><tr><td data-num="63"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="65"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="66"></td><td><pre>        role: slave</pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment">#2. 重载 Prometheus</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="65-mysql告警规则文件"><a class="anchor" href="#65-mysql告警规则文件">#</a> 6.5 MySQL 告警规则⽂件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、编写 MySQL 告警规则⽂件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/mysql_rules.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>groups:</pre></td></tr><tr><td data-num="4"></td><td><pre>- name: mysql告警规则</pre></td></tr><tr><td data-num="5"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="6"></td><td><pre>  - alert: MySQL主库实例宕机</pre></td></tr><tr><td data-num="7"></td><td><pre>    expr: mysql_up<span class="token punctuation">&#123;</span>role<span class="token operator">=</span><span class="token string">"master"</span><span class="token punctuation">&#125;</span> <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    for: 0m</pre></td></tr><tr><td data-num="9"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="10"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="11"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="12"></td><td><pre>      summary: <span class="token string">"MySQL实例宕机, 实例: "</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      description: <span class="token string">"服务: ⻆⾊:  已经宕机。"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          </pre></td></tr><tr><td data-num="15"></td><td><pre>  - alert: MySQL从库实例宕机</pre></td></tr><tr><td data-num="16"></td><td><pre>    expr: mysql_up<span class="token punctuation">&#123;</span>role<span class="token operator">=</span><span class="token string">"slave"</span><span class="token punctuation">&#125;</span> <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    for: 0m</pre></td></tr><tr><td data-num="18"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="19"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="20"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="21"></td><td><pre>      summary: <span class="token string">"MySQL实例宕机, 实例: "</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      description: <span class="token string">"服务: ⻆⾊:  已经宕机。"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          </pre></td></tr><tr><td data-num="24"></td><td><pre>  - alert: MySQL实例重启</pre></td></tr><tr><td data-num="25"></td><td><pre>    expr: sum<span class="token punctuation">(</span>mysql_global_status_uptime<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,job,service,role<span class="token punctuation">)</span><span class="token operator">&lt;</span> <span class="token number">60</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    for: 0m</pre></td></tr><tr><td data-num="27"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="28"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="29"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="30"></td><td><pre>      summary: <span class="token string">"MySQL实例重启, 实例 "</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      description: <span class="token string">"服务: ⻆⾊:  运行时间小于60s。当前值 "</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>  - alert: MySQL连接数使用率超过80%</pre></td></tr><tr><td data-num="34"></td><td><pre>    expr: max_over_time<span class="token punctuation">(</span>mysql_global_status_threads_connected<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> / mysql_global_variables_max_connections * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="36"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="37"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="38"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="39"></td><td><pre>      summary: <span class="token string">"MySQL连接数过高, 实例 ,服务: ⻆⾊: "</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      description: <span class="token string">"该实例MySQL的连接数在过去5分钟内超过了最大连接数的80%, 当前值 %。"</span></pre></td></tr><tr><td data-num="41"></td><td><pre>          </pre></td></tr><tr><td data-num="42"></td><td><pre>  - alert: MySQL活跃线程数高</pre></td></tr><tr><td data-num="43"></td><td><pre>    expr: avg_over_time<span class="token punctuation">(</span>mysql_global_status_threads_running<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> / mysql_global_variables_max_connections * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="45"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="46"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="47"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="48"></td><td><pre>      summary: <span class="token string">"MySQL活跃线程数过高, 实例 ,服务: 角色: "</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      description: <span class="token string">"该实例MySQL的活跃线程数在过去5分钟内持续超过了最大连接数的60%, 当前值 %。"</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          </pre></td></tr><tr><td data-num="51"></td><td><pre>  - alert: MySQL查询率<span class="token punctuation">(</span>QPS<span class="token punctuation">)</span>过高</pre></td></tr><tr><td data-num="52"></td><td><pre>    expr: irate<span class="token punctuation">(</span>mysql_global_status_queries<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1000</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="54"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="55"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="56"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="57"></td><td><pre>      summary: <span class="token string">"MySQL查询率(QPS)超标, 实例 ,服务: 角色: "</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      description: <span class="token string">"该实例MySQL的查询率(QPS)在过去5分钟内超过1000, 当前值 。"</span></pre></td></tr><tr><td data-num="59"></td><td><pre>          </pre></td></tr><tr><td data-num="60"></td><td><pre>  - alert: MySQL事务率<span class="token punctuation">(</span>TPS<span class="token punctuation">)</span>过高</pre></td></tr><tr><td data-num="61"></td><td><pre>    expr: sum<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>mysql_global_status_commands_total<span class="token punctuation">&#123;</span>command<span class="token operator">=~</span><span class="token string">"(commit|rollback)"</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">))</span> without <span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">100</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="63"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="64"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="65"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="66"></td><td><pre>      summary: <span class="token string">"MySQL事务率(TPS)超标, 实例 ,服务: 角色: "</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      description: <span class="token string">"该实例MySQL的事务率(TPS)在过去5分钟内超过100, 当前值 。"</span></pre></td></tr><tr><td data-num="68"></td><td><pre>          </pre></td></tr><tr><td data-num="69"></td><td><pre>  - alert: MySQL文件描述符使用率过高</pre></td></tr><tr><td data-num="70"></td><td><pre>    expr: mysql_global_status_open_files / mysql_global_variables_open_files_limit * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="72"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="73"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="74"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="75"></td><td><pre>      summary: <span class="token string">"MySQL活跃线程数过高, 实例 ,服务: 角色: "</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      description: <span class="token string">"该实例MySQL的文件描述符使用率超过80%，当前值 %可能需要增加文件描述符限制。"</span></pre></td></tr><tr><td data-num="77"></td><td><pre>          </pre></td></tr><tr><td data-num="78"></td><td><pre>  - alert: Mysql从库IO线程未运行</pre></td></tr><tr><td data-num="79"></td><td><pre>    expr: mysql_slave_status_slave_io_running <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="81"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="82"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="83"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="84"></td><td><pre>      summary: <span class="token string">"MySQL从库IO线程已停止, 实例 "</span></pre></td></tr><tr><td data-num="85"></td><td><pre>      description: <span class="token string">"该MySQL实例IO线程已停止，当前值 "</span></pre></td></tr><tr><td data-num="86"></td><td><pre>          </pre></td></tr><tr><td data-num="87"></td><td><pre>  - alert: Mysql从库SQL线程未运行</pre></td></tr><tr><td data-num="88"></td><td><pre>    expr: mysql_slave_status_slave_sql_running <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="90"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="91"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="92"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="93"></td><td><pre>      summary: <span class="token string">"MySQL从库SQL线程已停止, 实例 "</span></pre></td></tr><tr><td data-num="94"></td><td><pre>      description: <span class="token string">"该MySQL实例SQL线程已停止，当前值 "</span></pre></td></tr><tr><td data-num="95"></td><td><pre>          </pre></td></tr><tr><td data-num="96"></td><td><pre>  - alert: Mysql从库复制延迟过高</pre></td></tr><tr><td data-num="97"></td><td><pre>    expr: mysql_slave_status_seconds_behind_master - mysql_slave_status_sql_delay <span class="token operator">></span> <span class="token number">5</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="99"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="100"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="101"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="102"></td><td><pre>      summary: <span class="token string">"MySQL从库复制延迟过高, 实例 "</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      description: <span class="token string">"该实例MySQL的复制延迟超过5s，当前值 s"</span></pre></td></tr><tr><td data-num="104"></td><td><pre></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/mysql_rules.yml </span></pre></td></tr><tr><td data-num="107"></td><td><pre>Checking /etc/prometheus/rules/mysql_rules.yml</pre></td></tr><tr><td data-num="108"></td><td><pre>  SUCCESS: <span class="token number">11</span> rules found</pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="66-导入-grafana-模板"><a class="anchor" href="#66-导入-grafana-模板">#</a> 6.6 导入 Grafana 模板</h5><p>导⼊⼀个 MySQL 的 Grafana 模板。Dashboard ID 为 7362、9625 ，⽽监控 MySQL 主从的 Dashboard 可以使⽤ 11323</p><h4 id="七-prometheus监控redis"><a class="anchor" href="#七-prometheus监控redis">#</a> 七. Prometheus 监控 Redis</h4><h5 id="71-安装并配置redis"><a class="anchor" href="#71-安装并配置redis">#</a> 7.1 安装并配置 Redis</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># yum install redis -y</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/redis.conf </span></pre></td></tr><tr><td data-num="3"></td><td><pre>maxmemory 200mb</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start redis &amp;&amp; systemctl enable redis</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep redis</span></pre></td></tr><tr><td data-num="6"></td><td><pre>tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:6379          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">2532</span>/redis-server <span class="token number">1</span></pre></td></tr></table></figure><h5 id="72-安装并配置redis_exporter"><a class="anchor" href="#72-安装并配置redis_exporter">#</a> 7.2 安装并配置 redis_exporter</h5><p>1、访问 redis_exporter 的 github 地址， <a target="_blank" rel="noopener" href="https://github.com/oliver006/redis_exporter/releases">https://github.com/oliver006/redis_exporter/releases</a> ，下载 redis_exporter</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、下载 redis_exporter</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/oliver006/redis_exporter/releases/download/v1.57.0/redis_exporter-v1.57.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#加速地址</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.ghproxy.com/https://github.com/oliver006/redis_exporter/releases/download/v1.57.0/redis_exporter-v1.57.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#2、解压 redis_exporter</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># tar xf redis_exporter-v1.57.0.linux-amd64.tar.gz -C /etc</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/redis_exporter-v1.57.0.linux-amd64/ /etc/redis_exporter</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#3、配置 redis_exporter 启动⽂件</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/redis_exporter.service</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>redis_exporter</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/etc/redis_exporter/redis_exporter <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token parameter variable">-redis.addr</span><span class="token operator">=</span><span class="token string">"redis://localhost:6379"</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token parameter variable">-redis.password</span><span class="token operator">=</span><span class="token string">""</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  -web.listen-address<span class="token operator">=</span><span class="token string">":9121"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  -web.telemetry-path<span class="token operator">=</span><span class="token string">"/metrics"</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span> <span class="token variable">$MAINPID</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#4、启动 redis_exporter</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start redis_exporter</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable redis_exporter</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 9121</span></pre></td></tr><tr><td data-num="35"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::9121                 :::*                    LISTEN      <span class="token number">2600</span>/redis_exporter </pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">#5、访问 redis 的 metrics</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># curl http://localhost:9121/metrics</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment"># TYPE go_gc_duration_seconds summary</span></pre></td></tr><tr><td data-num="41"></td><td><pre>go_gc_duration_seconds<span class="token punctuation">&#123;</span>quantile<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">&#125;</span> <span class="token number">4</span>.7772e-05</pre></td></tr><tr><td data-num="42"></td><td><pre>go_gc_duration_seconds<span class="token punctuation">&#123;</span>quantile<span class="token operator">=</span><span class="token string">"0.25"</span><span class="token punctuation">&#125;</span> <span class="token number">4</span>.7772e-05</pre></td></tr><tr><td data-num="43"></td><td><pre>go_gc_duration_seconds<span class="token punctuation">&#123;</span>quantile<span class="token operator">=</span><span class="token string">"0.5"</span><span class="token punctuation">&#125;</span> <span class="token number">9</span>.3206e-05</pre></td></tr><tr><td data-num="44"></td><td><pre>go_gc_duration_seconds<span class="token punctuation">&#123;</span>quantile<span class="token operator">=</span><span class="token string">"0.75"</span><span class="token punctuation">&#125;</span> <span class="token number">9</span>.3206e-05</pre></td></tr><tr><td data-num="45"></td><td><pre>go_gc_duration_seconds<span class="token punctuation">&#123;</span>quantile<span class="token operator">=</span><span class="token string">"1"</span><span class="token punctuation">&#125;</span> <span class="token number">9</span>.3206e-05</pre></td></tr><tr><td data-num="46"></td><td><pre>go_gc_duration_seconds_sum <span class="token number">0.000140978</span></pre></td></tr><tr><td data-num="47"></td><td><pre>go_gc_duration_seconds_count <span class="token number">2</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment"># HELP go_goroutines Number of goroutines that currently exist.</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment"># TYPE go_goroutines gauge</span></pre></td></tr><tr><td data-num="50"></td><td><pre>go_goroutines <span class="token number">8</span></pre></td></tr></table></figure><h5 id="73-配置prometheus"><a class="anchor" href="#73-配置prometheus">#</a> 7.3 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、修改 Prometheus 配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="4"></td><td><pre>global:</pre></td></tr><tr><td data-num="5"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="8"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="11"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="12"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="20"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="25"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="30"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="35"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="40"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="45"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="50"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="55"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  - job_name: <span class="token string">"mysqld_exporter"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="60"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="61"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="62"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="63"></td><td><pre>        role: master</pre></td></tr><tr><td data-num="64"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="66"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="67"></td><td><pre>        role: slave</pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>  - job_name: <span class="token string">"redis_exporter"</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="72"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9121"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment">#2. 重载 Prometheus</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="74-redis告警规则文件"><a class="anchor" href="#74-redis告警规则文件">#</a> 7.4 Redis 告警规则⽂件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、编写 Redis 告警规则⽂件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/redis_rules.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>groups:</pre></td></tr><tr><td data-num="4"></td><td><pre>- name: redis告警规则</pre></td></tr><tr><td data-num="5"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="6"></td><td><pre>  - alert: Redis实例宕机</pre></td></tr><tr><td data-num="7"></td><td><pre>    expr: sum<span class="token punctuation">(</span>redis_up<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance, job<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="9"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="10"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="11"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="12"></td><td><pre>      summary: <span class="token string">"Redis实例宕机,  "</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      description: <span class="token string">"Redis实例  在过去1分钟内无法连接。"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          </pre></td></tr><tr><td data-num="15"></td><td><pre>  - alert: Redis实例重启</pre></td></tr><tr><td data-num="16"></td><td><pre>    expr: sum<span class="token punctuation">(</span>redis_uptime_in_seconds<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance, job<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">60</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    for: 0m</pre></td></tr><tr><td data-num="18"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="19"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="20"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="21"></td><td><pre>      summary: <span class="token string">"Redis实例  重启"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      description: <span class="token string">"Redis实例  出现重启。当前运行时间: 秒。"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          </pre></td></tr><tr><td data-num="24"></td><td><pre>  - alert: Redis连接数过高</pre></td></tr><tr><td data-num="25"></td><td><pre>    expr: redis_connected_clients / redis_config_maxclients * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="27"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="28"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="29"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="30"></td><td><pre>      summary: <span class="token string">"Redis实例  连接数超过80%"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      description: <span class="token string">"Redis实例  当前连接数占最大连接数的比率超过80%。当前比率: %。"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          </pre></td></tr><tr><td data-num="33"></td><td><pre>  - alert: Redis连接被拒绝</pre></td></tr><tr><td data-num="34"></td><td><pre>    expr: increase<span class="token punctuation">(</span>redis_rejected_connections_total<span class="token punctuation">[</span>1h<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="36"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="37"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="38"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="39"></td><td><pre>      summary: <span class="token string">"Redis实例  有连接被拒绝"</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      description: <span class="token string">"Redis实例  在过去1小时内有连接被拒绝。当前被拒绝的连接数: 。"</span></pre></td></tr><tr><td data-num="41"></td><td><pre>          </pre></td></tr><tr><td data-num="42"></td><td><pre>  - alert: Redis内存使用率过高</pre></td></tr><tr><td data-num="43"></td><td><pre>    expr: redis_memory_used_bytes / redis_memory_max_bytes * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span> </pre></td></tr><tr><td data-num="44"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="45"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="46"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="47"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="48"></td><td><pre>      summary: <span class="token string">"Redis实例  内存使用率超过80%"</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      description: <span class="token string">"Redis实例  当前内存使用率超过配置的最大内存值的80%。当前内存使用率: %。"</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          </pre></td></tr><tr><td data-num="51"></td><td><pre>  - alert: Redis缓存命中率低</pre></td></tr><tr><td data-num="52"></td><td><pre>    expr: <span class="token operator">|</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      irate<span class="token punctuation">(</span>redis_keyspace_hits_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> /</pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token punctuation">(</span>irate<span class="token punctuation">(</span>redis_keyspace_hits_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span> + irate<span class="token punctuation">(</span>redis_keyspace_misses_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">))</span> * <span class="token number">100</span> <span class="token operator">&lt;</span> <span class="token number">90</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    for: 10m</pre></td></tr><tr><td data-num="56"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="57"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="58"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="59"></td><td><pre>      summary: <span class="token string">"Redis实例  缓存命中率低于90%"</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      description: <span class="token string">"Redis实例  最近5分钟内的缓存命中率低于90%。当前命中率: %。"</span></pre></td></tr><tr><td data-num="61"></td><td><pre>          </pre></td></tr><tr><td data-num="62"></td><td><pre>  - alert: Redis即将过期的Key数量过多</pre></td></tr><tr><td data-num="63"></td><td><pre>    expr: <span class="token operator">|</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      sum<span class="token punctuation">(</span>redis_db_keys_expiring<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance, job, db<span class="token punctuation">)</span> /</pre></td></tr><tr><td data-num="65"></td><td><pre>      sum<span class="token punctuation">(</span>redis_db_keys<span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance, job, db<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">50</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="67"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="68"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="69"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="70"></td><td><pre>      summary: <span class="token string">"Redis实例  中的数据库  有过多即将过期的Key"</span></pre></td></tr><tr><td data-num="71"></td><td><pre>      description: <span class="token string">"Redis实例  中的数据库  有超过50%的Key即将过期。当前比率: %。"</span></pre></td></tr><tr><td data-num="72"></td><td><pre>          </pre></td></tr><tr><td data-num="73"></td><td><pre>  - alert: RedisRDB备份失败</pre></td></tr><tr><td data-num="74"></td><td><pre>    expr: redis_rdb_last_bgsave_status <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="76"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="77"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="78"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="79"></td><td><pre>      summary: <span class="token string">"Redis实例  RDB备份失败"</span></pre></td></tr><tr><td data-num="80"></td><td><pre>      description: <span class="token string">"Redis实例  最近的RDB备份尝试失败。"</span></pre></td></tr><tr><td data-num="81"></td><td><pre>          </pre></td></tr><tr><td data-num="82"></td><td><pre>  - alert: RedisRDB备份时间过长</pre></td></tr><tr><td data-num="83"></td><td><pre>    expr: redis_rdb_last_bgsave_duration_sec <span class="token operator">></span> <span class="token number">3</span> and redis_rdb_last_bgsave_status <span class="token operator">==</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="85"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="86"></td><td><pre>       severity: warning</pre></td></tr><tr><td data-num="87"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="88"></td><td><pre>      summary: <span class="token string">"Redis实例  RDB备份成功但耗时超过3秒"</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      description: <span class="token string">"Redis实例  RDB备份成功，但备份耗时超过了3秒。持续时间: 秒。"</span></pre></td></tr><tr><td data-num="90"></td><td><pre>   </pre></td></tr><tr><td data-num="91"></td><td><pre>  - alert: RedisRDB备份过期</pre></td></tr><tr><td data-num="92"></td><td><pre>    expr: <span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> - redis_rdb_last_save_timestamp_seconds<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">36000</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="94"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="95"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="96"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="97"></td><td><pre>      summary: <span class="token string">"Redis实例  超过10小时未进行RDB备份"</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      description: <span class="token string">"Redis实例  已超过10小时没有生成新的RDB备份文件。"</span></pre></td></tr><tr><td data-num="99"></td><td><pre>          </pre></td></tr><tr><td data-num="100"></td><td><pre>  - alert: Redis命令拒绝率过高</pre></td></tr><tr><td data-num="101"></td><td><pre>    expr: <span class="token operator">|</span></pre></td></tr><tr><td data-num="102"></td><td><pre>      sum<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>redis_commands_rejected_calls_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance, job<span class="token punctuation">)</span> /</pre></td></tr><tr><td data-num="103"></td><td><pre>      sum<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>redis_commands_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance, job<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">25</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="105"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="106"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="107"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="108"></td><td><pre>      summary: <span class="token string">"Redis实例  命令拒绝率超过25%"</span></pre></td></tr><tr><td data-num="109"></td><td><pre>      description: <span class="token string">"Redis实例  的命令拒绝率超过了25%。当前拒绝率: %。"</span></pre></td></tr><tr><td data-num="110"></td><td><pre>          </pre></td></tr><tr><td data-num="111"></td><td><pre>  - alert: Redis命令平均响应时间过长</pre></td></tr><tr><td data-num="112"></td><td><pre>    expr: <span class="token operator">|</span></pre></td></tr><tr><td data-num="113"></td><td><pre>      sum<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>redis_commands_duration_seconds_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> /</pre></td></tr><tr><td data-num="114"></td><td><pre>      sum<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>redis_commands_processed_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance, job<span class="token punctuation">)</span> <span class="token operator">></span><span class="token number">0.250</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="116"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="117"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="118"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="119"></td><td><pre>      summary: <span class="token string">"Redis实例  命令平均响应时间超过250ms"</span></pre></td></tr><tr><td data-num="120"></td><td><pre>      description: <span class="token string">"Redis实例  的执⾏命令平均响应时间超过了250毫秒。当前平均响应时间: 秒。"</span></pre></td></tr><tr><td data-num="121"></td><td><pre></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/redis_rules.yml </span></pre></td></tr><tr><td data-num="124"></td><td><pre>Checking /etc/prometheus/rules/redis_rules.yml</pre></td></tr><tr><td data-num="125"></td><td><pre>  SUCCESS: <span class="token number">12</span> rules found</pre></td></tr><tr><td data-num="126"></td><td><pre></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="75-导入-grafana-模板"><a class="anchor" href="#75-导入-grafana-模板">#</a> 7.5 导入 Grafana 模板</h5><p>导⼊⼀个 Redis 的 Grafana 模板。Dashboard ID 为 763</p><h4 id="八-prometheus监控docker"><a class="anchor" href="#八-prometheus监控docker">#</a> 八. Prometheus 监控 Docker</h4><p>Docker 的监控，可以使⽤ Docker ⾃带的 stats 命令来获取当前主机上运⾏中的容器的资源使⽤情况。例如：容器的 CPU 使⽤率、内存占⽤、⽹络 IO 以及磁盘 IO 等指标。</p><h5 id="81-安装docker"><a class="anchor" href="#81-安装docker">#</a> 8.1 安装 Docker</h5><p>1、添加 yum 源</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># yum remove docker* -y &amp;&amp; yum install -y yum-utils</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># yum install docker-ce -y</span></pre></td></tr></table></figure><p>2、安装并 docker</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	  <span class="token string">"https://docker.credclouds.com"</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>	  <span class="token string">"https://k8s.credclouds.com"</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>	  <span class="token string">"https://quay.credclouds.com"</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>	  <span class="token string">"https://gcr.credclouds.com"</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>	  <span class="token string">"https://k8s-gcr.credclouds.com"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>	  <span class="token string">"https://ghcr.credclouds.com"</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>	  <span class="token string">"https://do.nark.eu.org"</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>	  <span class="token string">"https://docker.m.daocloud.io"</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>	  <span class="token string">"https://docker.nju.edu.cn"</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>	  <span class="token string">"https://docker.mirrors.sjtug.sjtu.edu.cn"</span>,</pre></td></tr><tr><td data-num="15"></td><td><pre>	  <span class="token string">"https://docker.1panel.live"</span>,</pre></td></tr><tr><td data-num="16"></td><td><pre>	  <span class="token string">"https://docker.rainbond.cc"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">]</span>, </pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token string">"exec-opts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>EOF</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable docker --now</span></pre></td></tr></table></figure><p>4、运⾏两个容器应⽤</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># docker run -d -p3811:80 --name demoapp --memory="100m" oldxu3957/demoapp:v1.0</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># docker run -d -p3812:80 --name nginx --memory="50m" nginx:1.16</span></pre></td></tr></table></figure><h5 id="82-运行cadvisor"><a class="anchor" href="#82-运行cadvisor">#</a> 8.2 运⾏ Cadvisor</h5><p>1、启动 Cadvisor 容器</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node03 ~<span class="token punctuation">]</span><span class="token comment"># docker run -d --name=cadvisor \</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-p</span> <span class="token number">8082</span>:8080 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">-v</span> /:/rootfs:ro <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token parameter variable">-v</span> /var/run:/var/run:ro <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token parameter variable">-v</span> /sys:/sys:ro <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token parameter variable">-v</span> /dev/disk/:/dev/disk:ro <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token parameter variable">-v</span> /sys/fs/cgroup:/sys/fs/cgroup:ro <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token parameter variable">-v</span> /var/lib/docker/:/var/lib/docker:ro <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token parameter variable">--privileged</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>uhub.service.ucloud.cn/oldxu/cadvisor:v0.47.2</pre></td></tr></table></figure><p>2、Cadvisor 提供的 metrics 地址为 <a target="_blank" rel="noopener" href="http://IP:8082/metrics">http://IP:8082/metrics</a></p><h5 id="83-配置prometheus"><a class="anchor" href="#83-配置prometheus">#</a> 8.3 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="3"></td><td><pre>  - job_name: <span class="token string">"docker"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="6"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8082"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/jT1DDkm.jpeg" alt="1.jpg"></p><h5 id="84-docker告警规则文件"><a class="anchor" href="#84-docker告警规则文件">#</a> 8.4 Docker 告警规则⽂件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、编写 Docker 告警规则⽂件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/docker_rules.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>groups:</pre></td></tr><tr><td data-num="4"></td><td><pre>- name: Docker的告警规则</pre></td></tr><tr><td data-num="5"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="6"></td><td><pre>  - alert: 容器CPU利用率高</pre></td></tr><tr><td data-num="7"></td><td><pre>    expr: sum<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>container_cpu_usage_seconds_total<span class="token punctuation">&#123;</span>name<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,name<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="9"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="10"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="11"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="12"></td><td><pre>      summary: <span class="token string">"实例的容器CPU利用率高"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      description: <span class="token string">"容器的CPU利用率当前为%，超过了80%的阈值。"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      </pre></td></tr><tr><td data-num="15"></td><td><pre>  - alert: 容器内存利用率高</pre></td></tr><tr><td data-num="16"></td><td><pre>    expr: <span class="token operator">|</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      sum<span class="token punctuation">(</span>container_memory_working_set_bytes<span class="token punctuation">&#123;</span>name<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,name<span class="token punctuation">)</span> /</pre></td></tr><tr><td data-num="18"></td><td><pre>      sum<span class="token punctuation">(</span>container_spec_memory_limit_bytes<span class="token punctuation">&#123;</span>name<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,name<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="20"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="21"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="22"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="23"></td><td><pre>      summary: <span class="token string">"实例的容器内存利用率高"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      description: 容器<span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼225--<span class="token operator">></span>的内存最大限制是<span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼226--<span class="token operator">></span>MB , 目前利用率已达<span class="token operator">&lt;</span><span class="token operator">!</span>--swig￼227--<span class="token operator">></span>%，超过限制的80%。</pre></td></tr><tr><td data-num="25"></td><td><pre>      </pre></td></tr><tr><td data-num="26"></td><td><pre>  - alert: 容器整体内存利用率过高</pre></td></tr><tr><td data-num="27"></td><td><pre>    expr: sum<span class="token punctuation">(</span>container_memory_working_set_bytes<span class="token punctuation">&#123;</span>name<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> / sum<span class="token punctuation">(</span>machine_memory_bytes<span class="token punctuation">)</span> * <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="29"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="30"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="31"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="32"></td><td><pre>      summary: <span class="token string">"所有容器的总内存利用率过高"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      description: <span class="token string">"当前所有容器占用物理内存的总量为%，超过了物理内存的80%阈值。"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      </pre></td></tr><tr><td data-num="35"></td><td><pre>  - alert: 容器网络发送速率过高</pre></td></tr><tr><td data-num="36"></td><td><pre>    expr: sum<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>container_network_transmit_bytes_total<span class="token punctuation">&#123;</span>name<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span>by <span class="token punctuation">(</span>instance,job,name<span class="token punctuation">)</span> * <span class="token number">8</span> / <span class="token number">1024</span> / <span class="token number">1024</span> <span class="token operator">></span> <span class="token number">50</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="38"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="39"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="40"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="41"></td><td><pre>      summary: <span class="token string">"实例的容器网络发送速率过高"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      description: <span class="token string">"容器的网络发送速率达到Mbps，超过了50Mbps的阈值。"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      </pre></td></tr><tr><td data-num="44"></td><td><pre>  - alert: 容器网络接收速率过高</pre></td></tr><tr><td data-num="45"></td><td><pre>    expr: sum<span class="token punctuation">(</span>rate<span class="token punctuation">(</span>container_network_receive_bytes_total<span class="token punctuation">&#123;</span>name<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job,name<span class="token punctuation">)</span> * <span class="token number">8</span> / <span class="token number">1024</span> / <span class="token number">1024</span> <span class="token operator">></span> <span class="token number">50</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="47"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="48"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="49"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="50"></td><td><pre>      summary: <span class="token string">"实例的容器网络接收速率过高"</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      description: <span class="token string">"容器的网络接收速率达到Mbps，超过了50Mbps的阈值。"</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      </pre></td></tr><tr><td data-num="53"></td><td><pre>  - alert: 容器停止时间过长</pre></td></tr><tr><td data-num="54"></td><td><pre>    expr: sum<span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> - container_last_seen<span class="token punctuation">&#123;</span>name<span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance,name<span class="token punctuation">)</span><span class="token operator">></span> <span class="token number">60</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="56"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="57"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="58"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="59"></td><td><pre>      summary: <span class="token string">"实例的容器已停止"</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      description: <span class="token string">"容器已停止运行超过60秒。当前停止时长 s"</span></pre></td></tr><tr><td data-num="61"></td><td><pre>     </pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment">#  /etc/prometheus/promtool check rules /etc/prometheus/rules/docker_rules.yml </span></pre></td></tr><tr><td data-num="64"></td><td><pre>Checking /etc/prometheus/rules/docker_rules.yml</pre></td></tr><tr><td data-num="65"></td><td><pre>  SUCCESS: <span class="token number">6</span> rules found</pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="85-导入-grafana-模板"><a class="anchor" href="#85-导入-grafana-模板">#</a> 8.5 导入 Grafana 模板</h5><p>导⼊⼀个 Docker Container 的 Grafana 模板。Dashboard ID 为 11600</p><h4 id="九-blackbox_exporter黑盒监控"><a class="anchor" href="#九-blackbox_exporter黑盒监控">#</a> 九. Blackbox_exporter ⿊盒监控</h4><p>Blackbox_exporter 是⼀个专⻔⽤于⿊盒监控的⼯具，它⽀持多种⽹络协议对⽬标对象进⾏检测，⽐如 HTTP、HTTPS、TCP 和 ICMP。这意味着我们可以⽤它来监控⽹站响应状态和响应时间、以及通过端⼝来判断服务是否正常运⾏。此外⽤户还可以通过设置不同的检查模块来定制 blackbox_exporter，以便它能够适应不同的检测需求。</p><h5 id="91-安装blackbox_exporter"><a class="anchor" href="#91-安装blackbox_exporter">#</a> 9.1 安装 Blackbox_exporter</h5><p>1、访问 blackbox_exporter 的 github 地址， <a target="_blank" rel="noopener" href="https://github.com/prometheus/blackbox_exporter/releases">https://github.com/prometheus/blackbox_exporter/releases</a> ，下载 blackbox_exporter</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 下载 blackbox_exporter</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.24.0/blackbox_exporter-0.24.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#加速地址</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.ghproxy.com/https://github.com/prometheus/blackbox_exporter/releases/download/v0.24.0/blackbox_exporter-0.24.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#2、解压 blackbox_exporter</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># tar xf blackbox_exporter-0.24.0.linux-amd64.tar.gz -C /etc</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/blackbox_exporter-0.24.0.linux-amd64/ /etc/blackbox_exporter</span></pre></td></tr></table></figure><p>2、编辑 /etc/blackbox_exporter/blackbox.yml 默认配置⽂件，可以⾃⾏定义对应的模块，blackbox_exporter/example.yml</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/blackbox_exporter/blackbox.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>modules:</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment"># http 检查模块</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  http_2xx:</pre></td></tr><tr><td data-num="5"></td><td><pre>    prober: http</pre></td></tr><tr><td data-num="6"></td><td><pre>    http:</pre></td></tr><tr><td data-num="7"></td><td><pre>      preferred_ip_protocol: <span class="token string">"ip4"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      valid_http_versions: <span class="token punctuation">[</span> <span class="token string">"HTTP/1.1"</span>, <span class="token string">"HTTP/2.0"</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          </pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment"># Http Post 检查模块</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  http_post_2xx:</pre></td></tr><tr><td data-num="12"></td><td><pre>    prober: http</pre></td></tr><tr><td data-num="13"></td><td><pre>    http:</pre></td></tr><tr><td data-num="14"></td><td><pre>      method: POST</pre></td></tr><tr><td data-num="15"></td><td><pre>      preferred_ip_protocol: <span class="token string">"ip4"</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      valid_http_versions: <span class="token punctuation">[</span> <span class="token string">"HTTP/1.1"</span>, <span class="token string">"HTTP/2.0"</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          </pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment"># TCP 检查模块</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  tcp_connect:</pre></td></tr><tr><td data-num="20"></td><td><pre>    prober: tcp</pre></td></tr><tr><td data-num="21"></td><td><pre>    timeout: 5s</pre></td></tr><tr><td data-num="22"></td><td><pre>        </pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment"># ICMP 检查模块</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  icmp:</pre></td></tr><tr><td data-num="25"></td><td><pre>    prober: icmp</pre></td></tr><tr><td data-num="26"></td><td><pre>    timeout: 5s</pre></td></tr><tr><td data-num="27"></td><td><pre>    icmp:</pre></td></tr><tr><td data-num="28"></td><td><pre>      preferred_ip_protocol: <span class="token string">"ip4"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          </pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token comment"># DNS 检查模块</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  dns_tcp: </pre></td></tr><tr><td data-num="32"></td><td><pre>    prober: dns</pre></td></tr><tr><td data-num="33"></td><td><pre>    dns:</pre></td></tr><tr><td data-num="34"></td><td><pre>      transport_protocol: <span class="token string">"tcp"</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      preferred_ip_protocol: <span class="token string">"ip4"</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      query_name: <span class="token string">"www.oldxu.net"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          </pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment"># SSH 检查模块</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  ssh_banner:</pre></td></tr><tr><td data-num="40"></td><td><pre>    prober: tcp</pre></td></tr><tr><td data-num="41"></td><td><pre>    tcp:</pre></td></tr><tr><td data-num="42"></td><td><pre>      query_response:</pre></td></tr><tr><td data-num="43"></td><td><pre>      - expect: <span class="token string">"^SSH-2.0-"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      - send: <span class="token string">"SSH-2.0-blackbox-ssh-check"</span></pre></td></tr></table></figure><p>3、配置 blackbox_exporter 启动⽂件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/blackbox_exporter.service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>blackbox_exporter</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/etc/blackbox_exporter/blackbox_exporter <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token parameter variable">--config.file</span><span class="token operator">=</span>/etc/blackbox_exporter/blackbox.yml <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  --web.listen-address<span class="token operator">=</span>:9115</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span> <span class="token variable">$MAINPID</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr></table></figure><p>4、启动 blackbox_exporter</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start blackbox_exporter</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable blackbox_exporter</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 9115</span></pre></td></tr><tr><td data-num="5"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::9115                 :::*                    LISTEN      <span class="token number">1879</span>/blackbox_expor</pre></td></tr></table></figure><p>5、访问 Blackbox_exporter</p><p>1、访问 Blackbox_exporter，通过 <a target="_blank" rel="noopener" href="http://IP:9115">http://IP:9115</a></p><p>2、使⽤ blackbox_exporter 监控站点，需要传递⽬标 target ，以及检测⽅法 module</p><p>具体的 Url 地址：<a href="http://192.168.40.224:9115/probe?target=https://www.baidu.com&amp;module=http_2xx&amp;debug=true">http://192.168.40.224:9115/probe?target=https://www.baidu.com&amp;module=http_2xx&amp;debug=true</a></p><p>3、针对 blackbox_exporter 的探测过程进⾏解读</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>Logs <span class="token keyword">for</span> the probe:</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T13:00:22.422589861Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>main.go:181 <span class="token assign-left variable">module</span><span class="token operator">=</span>http_2xx <span class="token assign-left variable">target</span><span class="token operator">=</span>https://www.baidu.com <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Beginning probe"</span> <span class="token assign-left variable">probe</span><span class="token operator">=</span>http <span class="token assign-left variable">timeout_seconds</span><span class="token operator">=</span><span class="token number">119.5</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T13:00:22.422705868Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>http.go:328 <span class="token assign-left variable">module</span><span class="token operator">=</span>http_2xx <span class="token assign-left variable">target</span><span class="token operator">=</span>https://www.baidu.com <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Resolving target address"</span> <span class="token assign-left variable">target</span><span class="token operator">=</span>www.baidu.com <span class="token assign-left variable">ip_protocol</span><span class="token operator">=</span>ip4</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T13:00:22.45404596Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>http.go:328 <span class="token assign-left variable">module</span><span class="token operator">=</span>http_2xx <span class="token assign-left variable">target</span><span class="token operator">=</span>https://www.baidu.com <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Resolved target address"</span> <span class="token assign-left variable">target</span><span class="token operator">=</span>www.baidu.com <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token number">183.2</span>.172.17</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T13:00:22.454537363Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>client.go:252 <span class="token assign-left variable">module</span><span class="token operator">=</span>http_2xx <span class="token assign-left variable">target</span><span class="token operator">=</span>https://www.baidu.com <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Making HTTP request"</span> <span class="token assign-left variable">url</span><span class="token operator">=</span>https://183.2.172.17 <span class="token assign-left variable">host</span><span class="token operator">=</span>www.baidu.com</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T13:00:22.604504723Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>handler.go:120 <span class="token assign-left variable">module</span><span class="token operator">=</span>http_2xx <span class="token assign-left variable">target</span><span class="token operator">=</span>https://www.baidu.com <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Received HTTP response"</span> <span class="token assign-left variable">status_code</span><span class="token operator">=</span><span class="token number">200</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T13:00:22.658174121Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>handler.go:120 <span class="token assign-left variable">module</span><span class="token operator">=</span>http_2xx <span class="token assign-left variable">target</span><span class="token operator">=</span>https://www.baidu.com <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Response timings for roundtrip"</span> <span class="token assign-left variable">roundtrip</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T21:00:22.454597016+08:00 <span class="token assign-left variable">dnsDone</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T21:00:22.454597016+08:00 <span class="token assign-left variable">connectDone</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T21:00:22.47947711+08:00 <span class="token assign-left variable">gotConn</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T21:00:22.587945635+08:00 <span class="token assign-left variable">responseStart</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T21:00:22.604420439+08:00 <span class="token assign-left variable">tlsStart</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T21:00:22.479503968+08:00 <span class="token assign-left variable">tlsDone</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T21:00:22.58792749+08:00 <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T21:00:22.658024376+08:00</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-07-10T13:00:22.658287803Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>main.go:181 <span class="token assign-left variable">module</span><span class="token operator">=</span>http_2xx <span class="token assign-left variable">target</span><span class="token operator">=</span>https://www.baidu.com <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Probe succeeded"</span> <span class="token assign-left variable">duration_seconds</span><span class="token operator">=</span><span class="token number">0.23567288</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 1、开始探测（msg="Beginning probe"） 使⽤的是 http_2xx 模块，超时设置为 119.5 秒。</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 2、解析⽬标地址（msg="Resolving target address"） 正在尝试解析⽬标 www..com 的 IP 地址，使⽤的是 IPv4 协议。</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 3、已解析⽬标地址（msg="Resolved target address"） 成功解析为 183.2.172.17。</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 4、发出 HTTP 请求（msg="Making HTTP request"） 向 http://183.2.172.17 发出 HTTP 请求，请求中的 host 头设置为 www.baidu.com。</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 5、收到 HTTP 响应（msg="Received HTTP response"） 已收到状态码为 200 的 HTTP 响应，这意味着⽹⻚正常，服务器成功处理了请求。</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 6、响应时间（msg="Response timings for roundtrip"） 提供了对于整个请求 - 响应周期中每个步骤的具体时间点，包括 DNS 解析完成、TLS 握⼿开始和完成、连接建⽴、获得连接、响应开始等时间点。</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># 7、探测成功（msg="Probe succeeded"） 探测操作成功完成，总耗时为 0.23567288 秒。</span></pre></td></tr></table></figure><h5 id="92-配置prometheus"><a class="anchor" href="#92-配置prometheus">#</a> 9.2 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="7"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="10"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="11"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="19"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="24"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="29"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="34"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="39"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="44"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="49"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="54"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>  - job_name: <span class="token string">"mysqld_exporter"</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="59"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="61"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="62"></td><td><pre>        role: master</pre></td></tr><tr><td data-num="63"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="65"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="66"></td><td><pre>        role: slave</pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>  - job_name: <span class="token string">"redis_exporter"</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="71"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9121"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  - job_name: <span class="token string">'blackbox_http'</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 这次不是 /metrics，⽽是 /probe</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    params: <span class="token comment"># 传递参数</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      module: <span class="token punctuation">[</span>http_2xx<span class="token punctuation">]</span> <span class="token comment"># 调⽤哪个模块进⾏探测</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="78"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"https://www.xuliangwei.com"</span>,<span class="token string">"http://www.oldxu.net"</span>,<span class="token string">"https://www.baidu.com"</span>,<span class="token string">"http://httpbin.org/status/400"</span>,<span class="token string">"https://httpstat.us/500"</span>,<span class="token string">"https://httpstat.us/502"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="80"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="81"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="82"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="84"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="85"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="86"></td><td><pre>      </pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment"># relabel_configs 是标签重写的配置，这⾥进⾏了三次操作：</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment"># 1、将⽬标地址（__address__）赋予给__param_target，这是 Blackbox Exporter 需要的⽬标 target 参数。</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment"># 2、将__param_target 的内容复制到 instance 标签，这样 Prometheus UI 中显示的 instance 实例名称会是⽬标站点地址，⽽不是 Blackbox 的地址。</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment"># 3、最后，将实际发送探测请求的地址（__address__）设置为运⾏ Blackbox Exporter 的节点地址和端⼝（prom-node04.oldxu.net:9115），这样 Prometheus 就会向这个地址发送探测请求。</span></pre></td></tr><tr><td data-num="91"></td><td><pre>      </pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment">#. 重载 Prometheus</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="93-配置tcp-ssh-icmp监控"><a class="anchor" href="#93-配置tcp-ssh-icmp监控">#</a> 9.3 配置 tcp、ssh、icmp 监控</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1、修改 Prometheus 配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="4"></td><td><pre>global:</pre></td></tr><tr><td data-num="5"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="8"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="11"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="12"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="20"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="25"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="30"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="35"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="40"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="45"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="50"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="55"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  - job_name: <span class="token string">"mysqld_exporter"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="60"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="61"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="62"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="63"></td><td><pre>        role: master</pre></td></tr><tr><td data-num="64"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="66"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="67"></td><td><pre>        role: slave</pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>  - job_name: <span class="token string">"redis_exporter"</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="72"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9121"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>  - job_name: <span class="token string">'blackbox_http'</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 这次不是 /metrics，是 /probe</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    params: <span class="token comment"># 传递参数</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      module: <span class="token punctuation">[</span>http_2xx<span class="token punctuation">]</span> <span class="token comment"># 调哪个模块进探测</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="79"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"https://www.xuliangwei.com"</span>,<span class="token string">"http://www.oldxu.net"</span>,<span class="token string">"https://www.baidu.com"</span>,<span class="token string">"http://httpbin.org/status/400"</span>,<span class="token string">"https://httpstat.us/500"</span>,<span class="token string">"https://httpstat.us/502"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="81"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="83"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="84"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="85"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="86"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>  - job_name: <span class="token string">'blackbox_tcp'</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="90"></td><td><pre>    params:</pre></td></tr><tr><td data-num="91"></td><td><pre>      module: <span class="token punctuation">[</span>tcp_connect<span class="token punctuation">]</span> <span class="token comment"># 使 tcp_connect 模块</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="93"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:3306"</span>,<span class="token string">"prom-node03.oldxu.net:6379"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="95"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="96"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="97"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="99"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="100"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>  - job_name: <span class="token string">'blackbox_icmp'</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="104"></td><td><pre>    params:</pre></td></tr><tr><td data-num="105"></td><td><pre>      module: <span class="token punctuation">[</span>icmp<span class="token punctuation">]</span> <span class="token comment"># 使 icmp 模块</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="107"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net"</span>,<span class="token string">"prom-node02.oldxu.net"</span>,<span class="token string">"prom-node03.oldxu.net"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="109"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="110"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="111"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="112"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="113"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="114"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>  - job_name: <span class="token string">'blackbox_ssh'</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="118"></td><td><pre>    params:</pre></td></tr><tr><td data-num="119"></td><td><pre>      module: <span class="token punctuation">[</span>ssh_banner<span class="token punctuation">]</span> <span class="token comment"># 使⽤ ssh_banner 模块</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="121"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:22"</span>,<span class="token string">"prom-node02.oldxu.net:22"</span>,<span class="token string">"prom-node03.oldxu.net:22"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="123"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="124"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="125"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="126"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="127"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="128"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="129"></td><td><pre></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token comment">#2. 重载 Prometheus</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="94-blackbox告警规则文件"><a class="anchor" href="#94-blackbox告警规则文件">#</a> 9.4 Blackbox 告警规则⽂件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/blackbox_rules.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>groups:</pre></td></tr><tr><td data-num="3"></td><td><pre>- name: Blackbox告警规则文件</pre></td></tr><tr><td data-num="4"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="5"></td><td><pre>  - alert: 探测失败</pre></td></tr><tr><td data-num="6"></td><td><pre>    expr: sum<span class="token punctuation">(</span>probe_success <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance, job<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="8"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="10"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="11"></td><td><pre>      summary: <span class="token string">"实例  探测失败"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      description: <span class="token string">"探测目标  在 job  中失败。"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          </pre></td></tr><tr><td data-num="14"></td><td><pre>  - alert: 站点整体平均请求时间过长</pre></td></tr><tr><td data-num="15"></td><td><pre>    expr: sum<span class="token punctuation">(</span>avg_over_time<span class="token punctuation">(</span>probe_http_duration_seconds<span class="token punctuation">[</span>1m<span class="token punctuation">]</span><span class="token punctuation">))</span> by <span class="token punctuation">(</span>instance,job<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">3</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="17"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="18"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="19"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="20"></td><td><pre>      summary: <span class="token string">"实例  请求时间过长"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      description: <span class="token string">"实例  最近1分钟的平均请求时间超过3秒。当前平均请求时间：秒。"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          </pre></td></tr><tr><td data-num="23"></td><td><pre>  - alert: 重定向次数过多</pre></td></tr><tr><td data-num="24"></td><td><pre>    expr: probe_http_redirects <span class="token operator">></span> <span class="token number">5</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="26"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="27"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="28"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="29"></td><td><pre>      summary: <span class="token string">"实例  重定向次数过多"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      description: <span class="token string">"实例  在最近的探测中重定向次数超过5次。当前次数：次。"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          </pre></td></tr><tr><td data-num="32"></td><td><pre>  - alert: 站点阶段耗时过⻓</pre></td></tr><tr><td data-num="33"></td><td><pre>    expr: <span class="token operator">|</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        probe_http_duration_seconds<span class="token punctuation">&#123;</span>phase<span class="token operator">=</span><span class="token string">"connect"</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> <span class="token number">0.5</span> or</pre></td></tr><tr><td data-num="36"></td><td><pre>        probe_http_duration_seconds<span class="token punctuation">&#123;</span>phase<span class="token operator">=</span><span class="token string">"processing"</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> <span class="token number">0.5</span> or</pre></td></tr><tr><td data-num="37"></td><td><pre>        probe_http_duration_seconds<span class="token punctuation">&#123;</span>phase<span class="token operator">=</span><span class="token string">"resolve"</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> <span class="token number">0.5</span> or</pre></td></tr><tr><td data-num="38"></td><td><pre>        probe_http_duration_seconds<span class="token punctuation">&#123;</span>phase<span class="token operator">=</span><span class="token string">"tls"</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> <span class="token number">0.5</span> or</pre></td></tr><tr><td data-num="39"></td><td><pre>        probe_http_duration_seconds<span class="token punctuation">&#123;</span>phase<span class="token operator">=</span><span class="token string">"transfer"</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> <span class="token number">0.5</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="42"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="43"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="44"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="45"></td><td><pre>      summary: <span class="token string">"实例  阶段 '' 耗时过长"</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      description: <span class="token string">"实例  在阶段 '' 的耗时超过0.5秒。当前耗时：秒。"</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          </pre></td></tr><tr><td data-num="48"></td><td><pre>  - alert: 站点响应状态码异常</pre></td></tr><tr><td data-num="49"></td><td><pre>    expr: probe_http_status_code <span class="token operator">&lt;=</span> <span class="token number">199</span> or probe_http_status_code <span class="token operator">>=</span> <span class="token number">400</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="51"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="52"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="53"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="54"></td><td><pre>      summary: <span class="token string">"实例  返回异常状态码"</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      description: <span class="token string">"实例  返回的状态码为 ，表明请求可能存在问题。"</span></pre></td></tr><tr><td data-num="56"></td><td><pre>          </pre></td></tr><tr><td data-num="57"></td><td><pre>  - alert: 证书即将过期<span class="token operator">&lt;</span><span class="token number">30</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    expr: <span class="token punctuation">(</span>probe_ssl_earliest_cert_expiry - time<span class="token punctuation">(</span><span class="token punctuation">))</span> /86400 <span class="token operator">&lt;</span> <span class="token number">30</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    for: 24h</pre></td></tr><tr><td data-num="60"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="61"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="62"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="63"></td><td><pre>      summary: <span class="token string">"实例  的 SSL 证书即将过期"</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      description: <span class="token string">"实例  的 SSL 证书将在  天内过期。"</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          </pre></td></tr><tr><td data-num="66"></td><td><pre>  - alert: 证书即将过期<span class="token operator">&lt;</span><span class="token number">7</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    expr: <span class="token punctuation">(</span>probe_ssl_earliest_cert_expiry - time<span class="token punctuation">(</span><span class="token punctuation">))</span> /86400 <span class="token operator">&lt;</span> <span class="token number">7</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    for: 24h</pre></td></tr><tr><td data-num="69"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="70"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="71"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="72"></td><td><pre>      summary: <span class="token string">"实例  的 SSL 证书即将过期"</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      description: <span class="token string">"实例  的 SSL 证书将在  天内过期."</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/blackbox_rules.yml </span></pre></td></tr><tr><td data-num="77"></td><td><pre>Checking /etc/prometheus/rules/blackbox_rules.yml</pre></td></tr><tr><td data-num="78"></td><td><pre>  SUCCESS: <span class="token number">7</span> rules found</pre></td></tr><tr><td data-num="79"></td><td><pre>  </pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="95-导入blackbox图形"><a class="anchor" href="#95-导入blackbox图形">#</a> 9.5 导⼊ Blackbox 图形</h5><p>1、专⽤于针对 HTTP 的图形，导⼊ ID13659 ；</p><p>2、也可以使⽤ ID 为 7587 的图形；</p><p>3、以及 ID 为 9965 的图形；</p><h4 id="十-domain_exporter域名监控"><a class="anchor" href="#十-domain_exporter域名监控">#</a> 十. domain_exporter 域名监控</h4><p>domain_exporter 主要⽤来监控⽹站域名的过期时间。这对于企业和个⼈都是⽐较重要的，因为域名过期可能会导致⽹站⽆法访问，进⽽影响业务的正常运⾏。因此监控 “域名的过期时间” 就显得⽐较重要了。</p><p>domain_exporter 的⼯作逻辑有如下⼏步：</p><ul><li>1、收集域名信息：通过 WHOIS 协议收集 “target 参数定义的域名” 信息。</li><li>2、解析域名信息：从收集到的数据中解析出域名的过期时间。</li><li>3、导出指标：将解析出的域名过期时间等信息格式化为 Prometheus 兼容的格式，⽽后通过 /probe 接⼝输出指标。</li></ul><h5 id="101-安装domain_exporter"><a class="anchor" href="#101-安装domain_exporter">#</a> 10.1 安装 domain_exporter</h5><p>1、访问 domain_exporter 的 github 地址， <a target="_blank" rel="noopener" href="https://github.com/caarlos0/domain_exporter/releases">https://github.com/caarlos0/domain_exporter/releases</a> ，下载 domain_exporter</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 下载 domain_exporte</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/caarlos0/domain_exporter/releases/download/v1.23.0/domain_exporter_1.23.0_linux_amd64.tar.gz</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#2. 加速地址</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.ghproxy.com/https://github.com/caarlos0/domain_exporter/releases/download/v1.23.0/domain_exporter_1.23.0_linux_amd64.tar.gz</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#3. 解压 domain_exporter</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/domain_exporter_1.23.0</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># tar xf domain_exporter_1.23.0_linux_amd64.tar.gz -C /etc/domain_exporter_1.23.0</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/domain_exporter_1.23.0/ /etc/domain_exporter</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#4. 配置 domain_exporter 启动⽂件</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 domain_exporter<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/domain_exporter.service</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>domain_exporter</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/etc/domain_exporter/domain_exporter </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span> <span class="token variable">$MAINPID</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">#5. 动 domain_exporter</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start domain_exporter.service</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable domain_exporter.service</span></pre></td></tr><tr><td data-num="31"></td><td><pre>Created symlink from /etc/systemd/system/multi-user.target.wants/domain_exporter.service to /usr/lib/systemd/system/domain_exporter.service.</pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 9222</span></pre></td></tr><tr><td data-num="33"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::9222                 :::*                    LISTEN      <span class="token number">1880</span>/domain_exporte</pre></td></tr></table></figure><p>2、通过 domain_exporter 获取域名过期时间，访问 URL <a href="http://localhost:9222/probe?target=oldxu.net">http://localhost:9222/probe?target=oldxu.net</a> 来获取特定域名（如 <a target="_blank" rel="noopener" href="http://oldxu.net">oldxu.net</a>）的过期时间。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment">#  curl http://localhost:9222/probe?target=hmallleasing.com</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># HELP domain_expiry_days time in days until the domain expires</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># TYPE domain_expiry_days gauge</span></pre></td></tr><tr><td data-num="4"></td><td><pre>domain_expiry_days<span class="token punctuation">&#123;</span>domain<span class="token operator">=</span><span class="token string">"hmallleasing.com"</span><span class="token punctuation">&#125;</span> <span class="token number">741</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># HELP domain_probe_duration_seconds returns how long the probe took to complete in seconds</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># TYPE domain_probe_duration_seconds gauge</span></pre></td></tr><tr><td data-num="7"></td><td><pre>domain_probe_duration_seconds<span class="token punctuation">&#123;</span>domain<span class="token operator">=</span><span class="token string">"hmallleasing.com"</span><span class="token punctuation">&#125;</span> <span class="token number">1.036303946</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># HELP domain_probe_success whether the probe was successful or not</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># TYPE domain_probe_success gauge</span></pre></td></tr><tr><td data-num="10"></td><td><pre>domain_probe_success<span class="token punctuation">&#123;</span>domain<span class="token operator">=</span><span class="token string">"hmallleasing.com"</span><span class="token punctuation">&#125;</span> <span class="token number">1</span></pre></td></tr></table></figure><h5 id="102-配置prometheus"><a class="anchor" href="#102-配置prometheus">#</a> 10.2 配置 Prometheus</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="7"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="10"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="11"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="19"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="24"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="29"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="34"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="39"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="44"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="49"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="54"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>  - job_name: <span class="token string">"mysqld_exporter"</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="59"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="61"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="62"></td><td><pre>        role: master</pre></td></tr><tr><td data-num="63"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="65"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="66"></td><td><pre>        role: slave</pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>  - job_name: <span class="token string">"redis_exporter"</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="71"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9121"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  - job_name: <span class="token string">'blackbox_http'</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 这次不是 /metrics，是 /probe</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    params: <span class="token comment"># 传递参数</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      module: <span class="token punctuation">[</span>http_2xx<span class="token punctuation">]</span> <span class="token comment"># 调哪个模块进探测</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="78"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"https://www.xuliangwei.com"</span>,<span class="token string">"http://www.oldxu.net"</span>,<span class="token string">"https://www.baidu.com"</span>,<span class="token string">"http://httpbin.org/status/400"</span>,<span class="token string">"https://httpstat.us/500"</span>,<span class="token string">"https://httpstat.us/502"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="80"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="81"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="82"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="84"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="85"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>  - job_name: <span class="token string">'blackbox_tcp'</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="89"></td><td><pre>    params:</pre></td></tr><tr><td data-num="90"></td><td><pre>      module: <span class="token punctuation">[</span>tcp_connect<span class="token punctuation">]</span> <span class="token comment"># 使 tcp_connect 模块</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="92"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:3306"</span>,<span class="token string">"prom-node03.oldxu.net:6379"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="94"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="96"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="97"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="98"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="99"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>  - job_name: <span class="token string">'blackbox_icmp'</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="103"></td><td><pre>    params:</pre></td></tr><tr><td data-num="104"></td><td><pre>      module: <span class="token punctuation">[</span>icmp<span class="token punctuation">]</span> <span class="token comment"># 使 icmp 模块</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="106"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net"</span>,<span class="token string">"prom-node02.oldxu.net"</span>,<span class="token string">"prom-node03.oldxu.net"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="108"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="109"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="110"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="111"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="112"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="113"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="114"></td><td><pre></pre></td></tr><tr><td data-num="115"></td><td><pre>  - job_name: <span class="token string">'blackbox_ssh'</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="117"></td><td><pre>    params:</pre></td></tr><tr><td data-num="118"></td><td><pre>      module: <span class="token punctuation">[</span>ssh_banner<span class="token punctuation">]</span> <span class="token comment"># 使⽤ ssh_banner 模块</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="120"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:22"</span>,<span class="token string">"prom-node02.oldxu.net:22"</span>,<span class="token string">"prom-node03.oldxu.net:22"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="122"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="123"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="124"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="125"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="126"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="127"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="128"></td><td><pre></pre></td></tr><tr><td data-num="129"></td><td><pre>  - job_name: <span class="token string">'domain_exporter'</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 不是 /metrics，⽽是 /probe</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="132"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"nf-leasing.com"</span>,<span class="token string">"ixuyong.cn"</span>,<span class="token string">"hmallleasing.com"</span>,<span class="token string">"jd.com"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="134"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="135"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="136"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="137"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="138"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="139"></td><td><pre>      replacement: prom-node04.oldxu.net:9222</pre></td></tr><tr><td data-num="140"></td><td><pre></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token comment">#. 重载 Prometheus</span></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="103-domain告警规则文件"><a class="anchor" href="#103-domain告警规则文件">#</a> 10.3 domain 告警规则⽂件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/domain_rules.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>groups:</pre></td></tr><tr><td data-num="3"></td><td><pre>- name: domain告警规则文件</pre></td></tr><tr><td data-num="4"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="5"></td><td><pre>  - alert: 域名即将过期 <span class="token operator">&lt;</span><span class="token number">100</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    expr: domain_expiry_days <span class="token operator">&lt;</span> <span class="token number">100</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="8"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="10"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="11"></td><td><pre>      summary: <span class="token string">"域名即将过期 (实例 )"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      description: <span class="token string">"域名  还有少于100天即将过期。当前剩余天数：。"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          </pre></td></tr><tr><td data-num="14"></td><td><pre>  - alert: 域名即将过期<span class="token operator">&lt;</span><span class="token number">30</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    expr: domain_expiry_days <span class="token operator">&lt;</span> <span class="token number">30</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="17"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="18"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="19"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="20"></td><td><pre>      summary: <span class="token string">"域名即将过期 (实例 )"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      description: <span class="token string">"域名  还有少于30天即将过期。当前剩余天数：。"</span></pre></td></tr><tr><td data-num="22"></td><td><pre> </pre></td></tr><tr><td data-num="23"></td><td><pre>  - alert: 域名检测失败</pre></td></tr><tr><td data-num="24"></td><td><pre>    expr: sum<span class="token punctuation">(</span>domain_probe_success<span class="token punctuation">)</span> by <span class="token punctuation">(</span>domain, instance, job<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    for: 5m</pre></td></tr><tr><td data-num="26"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="27"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="28"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="29"></td><td><pre>      summary: <span class="token string">"域名检测失败 (实例 )"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      description: <span class="token string">"域名  在  上的检测失败。当前值：。"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      </pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/domain_rules.yml </span></pre></td></tr><tr><td data-num="34"></td><td><pre>Checking /etc/prometheus/rules/domain_rules.yml</pre></td></tr><tr><td data-num="35"></td><td><pre>  SUCCESS: <span class="token number">3</span> rules found</pre></td></tr><tr><td data-num="36"></td><td><pre>  </pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="104-导入domain_exporter图形"><a class="anchor" href="#104-导入domain_exporter图形">#</a> 10.4 导⼊ domain_exporter 图形</h5><p>查看域名的状态，以及连通性和过期时间，导⼊ ID 13924</p><h4 id="十一-pushgateway推送网关服务"><a class="anchor" href="#十一-pushgateway推送网关服务">#</a> 十一. PushGateway 推送⽹关服务</h4><p>Pushgateway 允许脚本通过 Push 的⽅式来推送指标数据，但它不会像 Prometheus 那样主动去抓取指标数据。</p><p>Pushgateway 作为中间存储，仅负责接收数据，等待 Prometheus Server 进⾏数据抓取，它⾃身并不具备抓取功能。默认情况下，数据保存在内存中，但可以通过 --persistence.file 参数持久化数据⾄⽂件中，同时通过 --persistence.interval=5m 设置数据持久化间隔。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/WUzZt2R.jpeg" alt="1.jpg"></p><p>使⽤ Pushgateway 时需要注意以下⼏点：</p><ul><li>1、若使⽤单个 Pushgateway 接收多个不同实例、或者是脚本推送的数据，它会成为单点。</li><li>2、Pushgateway 不会⾃动删除已推送的数据，⼀旦数据推送到 Pushgateway， Prometheus 会持续从中抓取数据。</li><li>3、删除 Pushgateway 中的数据不会影响 Prometheus 已经抓取的历史数据，但之后 Prometheus 将不会有新的数据更新，直到有新的数据被推送到 Pushgateway。</li></ul><h5 id="111-安装pushgateway"><a class="anchor" href="#111-安装pushgateway">#</a> 11.1 安装 pushGateway</h5><p>1、访问 PushGateway 官⽹ <a target="_blank" rel="noopener" href="https://github.com/prometheus/pushgateway">https://github.com/prometheus/pushgateway</a> ，下载 PushGateway</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#1. 下载 Pushgateway </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/prometheus/pushgateway/releases/download/v1.7.0/pushgateway-1.7.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 加速地址</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># wget https://mirror.ghproxy.com/https://github.com/prometheus/pushgateway/releases/download/v1.7.0/pushgateway-1.7.0.linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#2. 解压 PushGateway</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># tar xf pushgateway-1.7.0.linux-amd64.tar.gz -C /etc/</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /etc/pushgateway-1.7.0.linux-amd64/ /etc/pushgateway</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#3. 编写 pushgateway 启动⽂件</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/pushgateway.service </span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token assign-left variable">Description</span><span class="token operator">=</span>pushgateway</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://prometheus.io/</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token assign-left variable">After</span><span class="token operator">=</span>network.target</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/etc/pushgateway/pushgateway <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="19"></td><td><pre> --web.listen-address<span class="token operator">=</span>:9091 <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="20"></td><td><pre> --web.telemetry-path<span class="token operator">=</span>/metrics <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="21"></td><td><pre> --web.enable-lifecycle</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>20s</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token assign-left variable">Restart</span><span class="token operator">=</span>always</pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">#4. 启动 PushGateway</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start pushgateway</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable pushgateway</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntp|grep 9091</span></pre></td></tr><tr><td data-num="34"></td><td><pre>tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::9091                 :::*                    LISTEN      <span class="token number">2421</span>/pushgateway</pre></td></tr></table></figure><p>2、是⽤ Curl 给 pushgateway 推送⼀个 some_metric 的指标，值为 3.14</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># echo "some_metric 3.14" | curl --data-binary @- http://localhost:9091/metrics/job/some_job</span></pre></td></tr></table></figure><p>3、访问 pushgateway 的 web ⻚⾯，通过 <a target="_blank" rel="noopener" href="http://IP:9091">http://IP:9091</a></p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/RwuXAZe.png" alt="2.png"></p><h5 id="112-配置promethues"><a class="anchor" href="#112-配置promethues">#</a> 11.2 配置 Promethues</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/prometheus.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 全局段定义</span></pre></td></tr><tr><td data-num="3"></td><td><pre>global:</pre></td></tr><tr><td data-num="4"></td><td><pre>  scrape_interval: 15s <span class="token comment"># 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>rule_files:</pre></td></tr><tr><td data-num="7"></td><td><pre>  - <span class="token string">"/etc/prometheus/rules/*.yml"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 抓取指定的目标</span></pre></td></tr><tr><td data-num="10"></td><td><pre>scrape_configs:</pre></td></tr><tr><td data-num="11"></td><td><pre>  - job_name: <span class="token string">"prometheus"</span> <span class="token comment"># 定义一个抓取任务，名为 'prometheus'。</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span> <span class="token comment"># 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 '/metrics'。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    static_configs: <span class="token comment"># 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9090"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  - job_name: <span class="token string">"grafana"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="19"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:3000"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  - job_name: <span class="token string">"node_exporter"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="24"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:9100"</span>,<span class="token string">"prom-node02.oldxu.net:9100"</span>,<span class="token string">"prom-node03.oldxu.net:9100"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  - job_name: <span class="token string">"weather_exporter"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="29"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7001"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  - job_name: <span class="token string">"webserver"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="34"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:7002"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  - job_name: <span class="token string">"rabbitmq"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="39"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node02.oldxu.net:15692"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  - job_name: <span class="token string">"nginx"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="44"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9113"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>  - job_name: <span class="token string">"tomcat"</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="49"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:8080"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  - job_name: <span class="token string">"jmx_exporter"</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="54"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:12345"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>  - job_name: <span class="token string">"mysqld_exporter"</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="59"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="61"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="62"></td><td><pre>        role: master</pre></td></tr><tr><td data-num="63"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9104"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      labels:</pre></td></tr><tr><td data-num="65"></td><td><pre>        service: database</pre></td></tr><tr><td data-num="66"></td><td><pre>        role: slave</pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>  - job_name: <span class="token string">"redis_exporter"</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="71"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:9121"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  - job_name: <span class="token string">'blackbox_http'</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 这次不是 /metrics，是 /probe</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    params: <span class="token comment"># 传递参数</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      module: <span class="token punctuation">[</span>http_2xx<span class="token punctuation">]</span> <span class="token comment"># 调哪个模块进探测</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="78"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"https://www.xuliangwei.com"</span>,<span class="token string">"http://www.oldxu.net"</span>,<span class="token string">"https://www.baidu.com"</span>,<span class="token string">"http://httpbin.org/status/400"</span>,<span class="token string">"https://httpstat.us/500"</span>,<span class="token string">"https://httpstat.us/502"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="80"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="81"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="82"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="84"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="85"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>  - job_name: <span class="token string">'blackbox_tcp'</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="89"></td><td><pre>    params:</pre></td></tr><tr><td data-num="90"></td><td><pre>      module: <span class="token punctuation">[</span>tcp_connect<span class="token punctuation">]</span> <span class="token comment"># 使 tcp_connect 模块</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="92"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node03.oldxu.net:3306"</span>,<span class="token string">"prom-node03.oldxu.net:6379"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="94"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="96"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="97"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="98"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="99"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>  - job_name: <span class="token string">'blackbox_icmp'</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="103"></td><td><pre>    params:</pre></td></tr><tr><td data-num="104"></td><td><pre>      module: <span class="token punctuation">[</span>icmp<span class="token punctuation">]</span> <span class="token comment"># 使 icmp 模块</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="106"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net"</span>,<span class="token string">"prom-node02.oldxu.net"</span>,<span class="token string">"prom-node03.oldxu.net"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="108"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="109"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="110"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="111"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="112"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="113"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="114"></td><td><pre></pre></td></tr><tr><td data-num="115"></td><td><pre>  - job_name: <span class="token string">'blackbox_ssh'</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    metrics_path: /probe</pre></td></tr><tr><td data-num="117"></td><td><pre>    params:</pre></td></tr><tr><td data-num="118"></td><td><pre>      module: <span class="token punctuation">[</span>ssh_banner<span class="token punctuation">]</span> <span class="token comment"># 使⽤ ssh_banner 模块</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="120"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node01.oldxu.net:22"</span>,<span class="token string">"prom-node02.oldxu.net:22"</span>,<span class="token string">"prom-node03.oldxu.net:22"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="122"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="123"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="124"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="125"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="126"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="127"></td><td><pre>      replacement: prom-node04.oldxu.net:9115</pre></td></tr><tr><td data-num="128"></td><td><pre></pre></td></tr><tr><td data-num="129"></td><td><pre>  - job_name: <span class="token string">'domain_exporter'</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    metrics_path: /probe <span class="token comment"># metrics 的 path 不是 /metrics，⽽是 /probe</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="132"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"nf-leasing.com"</span>,<span class="token string">"hmallleasing.com"</span>,<span class="token string">"jd.com"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    relabel_configs:</pre></td></tr><tr><td data-num="134"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="135"></td><td><pre>      target_label: __param_target</pre></td></tr><tr><td data-num="136"></td><td><pre>    - source_labels: <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="137"></td><td><pre>      target_label: instance</pre></td></tr><tr><td data-num="138"></td><td><pre>    - target_label: __address__</pre></td></tr><tr><td data-num="139"></td><td><pre>      replacement: prom-node04.oldxu.net:9222</pre></td></tr><tr><td data-num="140"></td><td><pre></pre></td></tr><tr><td data-num="141"></td><td><pre>  - job_name: <span class="token string">"pushgateway"</span></pre></td></tr><tr><td data-num="142"></td><td><pre>    metrics_path: <span class="token string">"/metrics"</span></pre></td></tr><tr><td data-num="143"></td><td><pre>    static_configs:</pre></td></tr><tr><td data-num="144"></td><td><pre>    - targets: <span class="token punctuation">[</span><span class="token string">"prom-node04.oldxu.net:9091"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="145"></td><td><pre></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token comment">#. 重载 Prometheus</span></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="113-编写脚本并推送指标"><a class="anchor" href="#113-编写脚本并推送指标">#</a> 11.3 编写脚本并推送指标</h5><p>假设我们有⼀个备份脚本，它每天执⾏⼀次并且很快就完成了。但是我们需要知道它是否每次都成功执⾏了，以及每次执⾏花了多少时间。为了捕获这些信息，我们可以在脚本执⾏完成之后，将其成功状态和执⾏时间推送到 PushGateway。之后 Prometheus 就会定期从 PushGateway 中拉取这些数据，以此来监控这个脚本的状态。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># cat pushgateway_backup.sh</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#!/bin/bash</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"给定一个备份的应用名称"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># PushGateway 地址</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token assign-left variable">PUSH_ADDR</span><span class="token operator">=</span><span class="token string">"prom-node04.oldxu.net"</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 应用名称</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable">APP_NAME</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$1</span>"</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 备份脚本示例</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token assign-left variable">START_TIME</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%s<span class="token variable">)</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 模拟备份任务，随机睡眠时间 1-10 秒</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token assign-left variable">SLEEP_TIME</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span><span class="token number">1</span> <span class="token operator">+</span> RANDOM <span class="token operator">%</span> <span class="token number">10</span><span class="token variable">))</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token function">sleep</span> <span class="token variable">$SLEEP_TIME</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 随机决定备份操作是否成功</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$((</span>RANDOM <span class="token operator">%</span> <span class="token number">10</span><span class="token variable">))</span></span> <span class="token parameter variable">-lt</span> <span class="token number">5</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token assign-left variable">STATUS</span><span class="token operator">=</span><span class="token number">1</span> <span class="token comment"># 成功</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token assign-left variable">STATUS</span><span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># 失败</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">fi</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token assign-left variable">END_TIME</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%s<span class="token variable">)</span></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token assign-left variable">DURATION</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>END_TIME <span class="token operator">-</span> START_TIME<span class="token variable">))</span></span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># 推送指标至 PushGateway</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">curl</span> --data-binary @- http://<span class="token variable">$PUSH_ADDR</span>:9091/metrics/job/backup/instance/<span class="token variable">$APP_NAME</span></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre># HELP backup_duration_seconds The duration of the last backup in seconds.</pre></td></tr><tr><td data-num="31"></td><td><pre># TYPE backup_duration_seconds gauge</pre></td></tr><tr><td data-num="32"></td><td><pre>backup_duration_seconds&#123;application="<span class="token variable">$APP_NAME</span>"&#125; <span class="token variable">$DURATION</span></pre></td></tr><tr><td data-num="33"></td><td><pre># HELP backup_success Last backup was success(1) or ERROR(0).</pre></td></tr><tr><td data-num="34"></td><td><pre># TYPE backup_success gauge</pre></td></tr><tr><td data-num="35"></td><td><pre>backup_success&#123;application="<span class="token variable">$APP_NAME</span>"&#125; <span class="token variable">$STATUS</span></pre></td></tr><tr><td data-num="36"></td><td><pre>EOF</pre></td></tr></table></figure><p>1、执⾏脚本，需要传递⼀个应⽤的名称</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># sh pushgateway_backup.sh shop</span></pre></td></tr></table></figure><p>2、在 Prometheus UI 中检查 backup_duration_seconds 和 backup_success 指标</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/wKv8ybJ.png" alt="1.png"></p><h5 id="114-配置告警规则文件"><a class="anchor" href="#114-配置告警规则文件">#</a> 11.4 配置告警规则⽂件</h5><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/prometheus/rules/backup_rules.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>groups:</pre></td></tr><tr><td data-num="3"></td><td><pre>- name: backup_alerts</pre></td></tr><tr><td data-num="4"></td><td><pre>  rules:</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment"># 警告：在备份成功情况在，如果备份任务耗时超过了 9 秒则触发告警</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  - alert: 备份告警超时</pre></td></tr><tr><td data-num="7"></td><td><pre>    expr: backup_duration_seconds <span class="token operator">></span> <span class="token number">6</span> and backup_success <span class="token operator">==</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="9"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="10"></td><td><pre>      severity: warning</pre></td></tr><tr><td data-num="11"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="12"></td><td><pre>      summary: <span class="token string">"备份任务耗时过长"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      description: <span class="token string">" 应⽤备份任务成功完成，但耗时超过了6秒。实际耗时:  秒。"</span></pre></td></tr><tr><td data-num="14"></td><td><pre> </pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment"># 严重警告：备份任务失败，并且不考虑耗时</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  - alert: 备份任务失败</pre></td></tr><tr><td data-num="17"></td><td><pre>    expr: backup_success <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    for: 1m</pre></td></tr><tr><td data-num="19"></td><td><pre>    labels:</pre></td></tr><tr><td data-num="20"></td><td><pre>      severity: critical</pre></td></tr><tr><td data-num="21"></td><td><pre>    annotations:</pre></td></tr><tr><td data-num="22"></td><td><pre>      summary: <span class="token string">"备份失败"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      description: <span class="token string">" 任务中  应用备份失败。"</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">#2. 检查告警规则语法</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># /etc/prometheus/promtool check rules /etc/prometheus/rules/backup_rules.yml </span></pre></td></tr><tr><td data-num="27"></td><td><pre>Checking /etc/prometheus/rules/backup_rules.yml</pre></td></tr><tr><td data-num="28"></td><td><pre>  SUCCESS: <span class="token number">2</span> rules found</pre></td></tr><tr><td data-num="29"></td><td><pre>  </pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#3. 重载 Prometheus</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">[</span>root@prom-node01 ~<span class="token punctuation">]</span><span class="token comment"># curl -v -X POST http://localhost:9090/-/reload</span></pre></td></tr></table></figure><h5 id="115-清理pushgateway"><a class="anchor" href="#115-清理pushgateway">#</a> 11.5 清理 pushGateway</h5><p>清理 PushGateway 中的数据，有两种⽅式，⼀种⼿动清理、⼀种⾃动清理</p><p>1、⼿动清理：访问 PushGateway 的 web 界⾯，找到你要清理的指标，然后点击 “Delete Group” 进⾏删除。</p><p><img loading="lazy" data-src="https://wp-cdn.4ce.cn/v2/vu55T71.jpeg" alt="2.jpg"></p><p>2、⾃动清理：设置⼀个定时任务（如 cron job），定期通过 API 调⽤删除过时的指标。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># cat clear_pushgateway_job.sh</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#!/bin/bash</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"给定要清理的 [Job_name名称]和 [instance名称]"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token assign-left variable">JOB_NAME</span><span class="token operator">=</span><span class="token variable">$1</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token assign-left variable">INSTANCE_NAME</span><span class="token operator">=</span><span class="token variable">$2</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 清理特定 job 名称的指标</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">curl</span> <span class="token parameter variable">-X</span> DELETE http://prom-node04.oldxu.net:9091/metrics/job/<span class="token variable">$&#123;JOB_NAME&#125;</span>/instance/<span class="token variable">$&#123;INSTANCE_NAME&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 设定 crontab</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@prom-node04 ~<span class="token punctuation">]</span><span class="token comment"># crontab -e</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">59</span> <span class="token number">23</span> * * * /bin/bash /root/clear_pushgateway_job.sh backup shop</pre></td></tr></table></figure><div class="tags"><a href="/tags/Prometheus/" rel="tag"><i class="ic i-tag"></i>Prometheus</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/posts/4081185381.html">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2025-08-19 21:24:08" itemprop="dateModified" datetime="2025-08-19T21:24:08+08:00">2025-08-19</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Xu Yong 微信支付"><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Xu Yong 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Xu Yong<i class="ic i-at"><em>@</em></i>LinuxSre云原生</li><li class="link"><strong>本文链接：</strong><a href="http://ixuyong.cn/posts/4081185381.html" title="Prometheus监控实战（三）">http://ixuyong.cn/posts/4081185381.html</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/posts/3386060324.html" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;oApfFnU.jpeg" title="PromQL快速入门（二）"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Prometheus</span><h3>PromQL快速入门（二）</h3></a></div><div class="item right"><a href="/posts/4081185382.html" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;wp-cdn.4ce.cn&#x2F;v2&#x2F;o1ceeNN.jpeg" title="Prometheus监控实战（四）"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>Prometheus</span><h3>Prometheus监控实战（四）</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E6%88%98%E4%B8%89"><span class="toc-number">1.</span> <span class="toc-text">Prometheus 监控实战（三）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-promtheus%E8%8A%82%E7%82%B9%E7%9B%91%E6%8E%A7"><span class="toc-number">1.1.</span> <span class="toc-text">一. Promtheus 节点监控</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-%E5%88%9B%E5%BB%BArules%E7%9B%AE%E5%BD%95%E5%B9%B6%E9%87%8D%E8%BD%BDprometheus"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 创建 rules 目录并重载 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#13-promtheus%E9%85%8D%E7%BD%AE%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 Promtheus 配置告警规则</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#131-%E9%85%8D%E7%BD%AEcpu%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">1.3.1 配置 CPU 告警规则</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#132-%E9%85%8D%E7%BD%AE%E5%86%85%E5%AD%98%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">1.3.2 配置内存告警规则</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#133-%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">1.3.3 配置磁盘告警规则</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#134-%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">1.3.4 配置⽹络告警规则</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#14-%E6%A3%80%E6%9F%A5%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 检查告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#15-%E5%AF%BC%E5%85%A5-grafana-%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5 导入 Grafana 模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-prometheus%E7%9B%91%E6%8E%A7rabbitmq"><span class="toc-number">1.2.</span> <span class="toc-text">二. Prometheus 监控 RabbitmQ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-rabbitmq%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 RabbitMQ 告警规则文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23-%E5%AF%BC%E5%85%A5-grafana-%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 导入 Grafana 模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-prometheus%E7%9B%91%E6%8E%A7nginx"><span class="toc-number">1.3.</span> <span class="toc-text">三. Prometheus 监控 Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#31-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEnginx"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 安装并配置 Nginx</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#32-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEnginx-exporter"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 安装并配置 Nginx-exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#33-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#34-nginx%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 Nginx 告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#35-%E5%AF%BC%E5%85%A5-grafana-%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.3.5.</span> <span class="toc-text">3.5 导入 Grafana 模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B-prometheus%E7%9B%91%E6%8E%A7tomcat"><span class="toc-number">1.4.</span> <span class="toc-text">四. Prometheus 监控 Tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#41-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEtomcat"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 安装并配置 Tomcat</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#42-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#43-tomcat%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 Tomcat 告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#44-%E5%AF%BC%E5%85%A5-grafana-%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 导入 Grafana 模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94-prometheus%E7%9B%91%E6%8E%A7springboot"><span class="toc-number">1.5.</span> <span class="toc-text">五. Prometheus 监控 SpringBoot</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#51-%E4%B8%8B%E8%BD%BDjmx-exporter"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 下载 jmx-exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#52-%E8%BF%90%E8%A1%8Cspringboot%E5%BA%94%E7%94%A8"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 运⾏ SpringBoot 应⽤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#53-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#54-jmx%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.4.</span> <span class="toc-text">5.4 JMX 告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#55-%E5%AF%BC%E5%85%A5-grafana-%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.5.5.</span> <span class="toc-text">5.5 导入 Grafana 模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AD-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEmysql_master"><span class="toc-number">1.6.</span> <span class="toc-text">六。安装并配置 mysql_master</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#61-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEmysql_master"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 安装并配置 mysql_master</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#62-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEmysql_slave"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 安装并配置 mysql_slave</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#63-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEmysqld_exporter"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 安装并配置 mysqld_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#64-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.6.4.</span> <span class="toc-text">6.4 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#65-mysql%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.5.</span> <span class="toc-text">6.5 MySQL 告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#66-%E5%AF%BC%E5%85%A5-grafana-%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.6.6.</span> <span class="toc-text">6.6 导入 Grafana 模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%83-prometheus%E7%9B%91%E6%8E%A7redis"><span class="toc-number">1.7.</span> <span class="toc-text">七. Prometheus 监控 Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#71-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEredis"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 安装并配置 Redis</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#72-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEredis_exporter"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 安装并配置 redis_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#73-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#74-redis%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.4.</span> <span class="toc-text">7.4 Redis 告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#75-%E5%AF%BC%E5%85%A5-grafana-%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.7.5.</span> <span class="toc-text">7.5 导入 Grafana 模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AB-prometheus%E7%9B%91%E6%8E%A7docker"><span class="toc-number">1.8.</span> <span class="toc-text">八. Prometheus 监控 Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#81-%E5%AE%89%E8%A3%85docker"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 安装 Docker</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#82-%E8%BF%90%E8%A1%8Ccadvisor"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 运⾏ Cadvisor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#83-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.8.3.</span> <span class="toc-text">8.3 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#84-docker%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.8.4.</span> <span class="toc-text">8.4 Docker 告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#85-%E5%AF%BC%E5%85%A5-grafana-%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.8.5.</span> <span class="toc-text">8.5 导入 Grafana 模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%9D-blackbox_exporter%E9%BB%91%E7%9B%92%E7%9B%91%E6%8E%A7"><span class="toc-number">1.9.</span> <span class="toc-text">九. Blackbox_exporter ⿊盒监控</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#91-%E5%AE%89%E8%A3%85blackbox_exporter"><span class="toc-number">1.9.1.</span> <span class="toc-text">9.1 安装 Blackbox_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#92-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.9.2.</span> <span class="toc-text">9.2 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#93-%E9%85%8D%E7%BD%AEtcp-ssh-icmp%E7%9B%91%E6%8E%A7"><span class="toc-number">1.9.3.</span> <span class="toc-text">9.3 配置 tcp、ssh、icmp 监控</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#94-blackbox%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.9.4.</span> <span class="toc-text">9.4 Blackbox 告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#95-%E5%AF%BC%E5%85%A5blackbox%E5%9B%BE%E5%BD%A2"><span class="toc-number">1.9.5.</span> <span class="toc-text">9.5 导⼊ Blackbox 图形</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81-domain_exporter%E5%9F%9F%E5%90%8D%E7%9B%91%E6%8E%A7"><span class="toc-number">1.10.</span> <span class="toc-text">十. domain_exporter 域名监控</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#101-%E5%AE%89%E8%A3%85domain_exporter"><span class="toc-number">1.10.1.</span> <span class="toc-text">10.1 安装 domain_exporter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#102-%E9%85%8D%E7%BD%AEprometheus"><span class="toc-number">1.10.2.</span> <span class="toc-text">10.2 配置 Prometheus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#103-domain%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.10.3.</span> <span class="toc-text">10.3 domain 告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#104-%E5%AF%BC%E5%85%A5domain_exporter%E5%9B%BE%E5%BD%A2"><span class="toc-number">1.10.4.</span> <span class="toc-text">10.4 导⼊ domain_exporter 图形</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%81%E4%B8%80-pushgateway%E6%8E%A8%E9%80%81%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.11.</span> <span class="toc-text">十一. PushGateway 推送⽹关服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#111-%E5%AE%89%E8%A3%85pushgateway"><span class="toc-number">1.11.1.</span> <span class="toc-text">11.1 安装 pushGateway</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#112-%E9%85%8D%E7%BD%AEpromethues"><span class="toc-number">1.11.2.</span> <span class="toc-text">11.2 配置 Promethues</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#113-%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC%E5%B9%B6%E6%8E%A8%E9%80%81%E6%8C%87%E6%A0%87"><span class="toc-number">1.11.3.</span> <span class="toc-text">11.3 编写脚本并推送指标</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#114-%E9%85%8D%E7%BD%AE%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99%E6%96%87%E4%BB%B6"><span class="toc-number">1.11.4.</span> <span class="toc-text">11.4 配置告警规则⽂件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#115-%E6%B8%85%E7%90%86pushgateway"><span class="toc-number">1.11.5.</span> <span class="toc-text">11.5 清理 pushGateway</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/posts/2041568856.html" rel="bookmark" title="Prometheus监控Kubernetes">Prometheus监控Kubernetes</a></li><li><a href="/posts/1595025559.html" rel="bookmark" title="Prometheus监控实战（一）">Prometheus监控实战（一）</a></li><li><a href="/posts/3386060324.html" rel="bookmark" title="PromQL快速入门（二）">PromQL快速入门（二）</a></li><li class="active"><a href="/posts/4081185381.html" rel="bookmark" title="Prometheus监控实战（三）">Prometheus监控实战（三）</a></li><li><a href="/posts/4081185382.html" rel="bookmark" title="Prometheus监控实战（四）">Prometheus监控实战（四）</a></li><li><a href="/posts/737291847.html" rel="bookmark" title="Prometheus监控实战（五）">Prometheus监控实战（五）</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Xu Yong" src="/assets/avatar.png"><p class="name" itemprop="name">Xu Yong</p><div class="description" itemprop="description">专注于 Linux 运维、云计算、云原⽣等技术</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">75</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">19</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">22</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/xyapples" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;xyapples"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://gitee.com/chinagei" class="item gitee" title="https:&#x2F;&#x2F;gitee.com&#x2F;chinagei"><i class="ic i-gitee"></i></a><a href="mailto:373370405@qq.com" class="item email" title="mailto:373370405@qq.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-about"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/posts/4081185382.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/posts/3386060324.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Aliyun/" title="分类于Aliyun">Aliyun</a></div><span><a href="/posts/1528713798.html">阿里云ECS、SLB、RDS、CDN、ESS应用与实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Shell/" title="分类于Shell">Shell</a></div><span><a href="/posts/1361162481.html">Shell脚本基础与变量</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Nginx/" title="分类于Nginx">Nginx</a></div><span><a href="/posts/3682494305.html">Nginx常用模块（二）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Nginx/" title="分类于Nginx">Nginx</a></div><span><a href="/posts/1979768636.html">Nginx代理-负载均衡实践（五）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/DevOps/" title="分类于DevOps">DevOps</a></div><span><a href="/posts/1208493697.html">K8S基于Jenkins实现SpringCloud微服务CI与CD实践（一）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/DevOps/" title="分类于DevOps">DevOps</a></div><span><a href="/posts/889219339.html">K8S基于Jenkins实现SpringCloud微服务CI与CD实践（三）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/LVS/" title="分类于LVS">LVS</a></div><span><a href="/posts/3106546893.html">企业级负载均衡LVS（一）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Prometheus/" title="分类于Prometheus">Prometheus</a></div><span><a href="/posts/4081185382.html">Prometheus监控实战（四）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Nginx/" title="分类于Nginx">Nginx</a></div><span><a href="/posts/245964480.html">Nginx Rewrite场景实战（十一）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Ansible/" title="分类于Ansible">Ansible</a></div><span><a href="/posts/2794181051.html">Ansible快速入门</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Xu Yong @ LinuxSre云原生</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">1.9m 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">28:52</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `posts/4081185381.html`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hrmmi -->