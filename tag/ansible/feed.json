{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"ansible\" tag",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/3091159370.html",
            "url": "http://ixuyong.cn/posts/3091159370.html",
            "title": "Ansible Task Control",
            "date_published": "2025-10-30T13:12:40.000Z",
            "content_html": "<h3 id=\"ansible-task-control\"><a class=\"anchor\" href=\"#ansible-task-control\">#</a> Ansible Task Control</h3>\n<h4 id=\"1ansible-task-control\"><a class=\"anchor\" href=\"#1ansible-task-control\">#</a> 1.Ansible Task Control</h4>\n<h5 id=\"11-when条件语句\"><a class=\"anchor\" href=\"#11-when条件语句\">#</a> 1.1 when 条件语句</h5>\n<p>when 关键字主要针对 TASK 任务进行判断，对于此前我们使用过的 yum 模块是可以自动检测软件包是否已被安装，无需人为干涉；但对于有些任务则是需要进行判断才可以实现的。</p>\n<ul>\n<li>比如：web 节点都需要配置 nginx 仓库，但其他节点并不需要，此时就会用到 when 判断。</li>\n<li>比如: Centos 与 Ubuntu 都需要安装 Apache，而 Centos 系统软件包为 httpd，而 Ubuntu 系统软件包为 httpd2，那么此时就需要判断主机系统，然后为不同的主机系统安装不同的软件包。</li>\n</ul>\n<h6 id=\"111-案例1-根据不同操作系统安装相同的软件\"><a class=\"anchor\" href=\"#111-案例1-根据不同操作系统安装相同的软件\">#</a> 1.1.1 案例 1 - 根据不同操作系统安装相同的软件</h6>\n<p>需求：为所有主机安装 Apache 软件</p>\n<ul>\n<li>系统为 CentOS：安装 httpd</li>\n<li>系统为 Ubuntu：安装 httpd2</li>\n</ul>\n<p>1. 通过 fact 变量判断系统</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible localhost -m setup | less</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"ansible_distribution\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"CentOS\"</span>, </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>2. 编写 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_when.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Centos Install httpd <span class=\"token comment\"># 通过 fact 变量判断系统为 centos 才会安装 httpd</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      yum: </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        name: httpd</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      when: <span class=\"token punctuation\">(</span>ansible_distribution <span class=\"token operator\">==</span> <span class=\"token string\">\"CentOS\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    - name: Ubuntu Install httpd <span class=\"token comment\"># 通过 fact 变量判断系统为 ubuntu 才会安装 httpd2</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      yum: </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        name: apache2</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      when: <span class=\"token punctuation\">(</span>ansible_distribution <span class=\"token operator\">==</span> <span class=\"token string\">\"Ubuntu\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>3. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_when.yml</span></pre></td></tr></table></figure><h6 id=\"112-案例2-为特定的主机添加nginx仓库\"><a class=\"anchor\" href=\"#112-案例2-为特定的主机添加nginx仓库\">#</a> 1.1.2 案例 2 - 为特定的主机添加 Nginx 仓库</h6>\n<p>为所有主机添加 Nginx 仓库</p>\n<ul>\n<li>主机名为 web：添加 Nginx 仓库</li>\n<li>主机名不为 web：不做任何处理</li>\n</ul>\n<p>1. 编写 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_when_2.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: all</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  - name: Add Nginx Yum Repository</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    yum_repository:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      name: ansible_web_nginx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      description: Nginx Repository</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      baseurl: http://nginx.org/packages/centos/7/<span class=\"token variable\">$basearch</span>/</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      gpgcheck: no</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    when: <span class=\"token punctuation\">(</span>ansible_hostname is match<span class=\"token punctuation\">(</span><span class=\"token string\">\"web*\"</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#    when: (ansible_hostname is match(\"web*\")) or (ansible_hostname is match(\"lb*\"))</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 当然 when 也可以使用 and 与 or 方式</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># when: (ansible_hostname is match(\"web*\")) or (ansible_hostname is match(\"lb*\"))</span></pre></td></tr></table></figure><p>2. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_when_2.yml</span></pre></td></tr></table></figure><h6 id=\"113-案例3-判断服务是否正常运行\"><a class=\"anchor\" href=\"#113-案例3-判断服务是否正常运行\">#</a> 1.1.3 案例 3 - 判断服务是否正常运行</h6>\n<p>判断 Nginx 服务是否处于运行状态</p>\n<ul>\n<li>已运行：则重启服务</li>\n<li>未运行：则不做处理</li>\n</ul>\n<p>1. 通过 register 将命令执行结果保存至变量，然后通过 when 语句进行判断</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_when_3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Get Nginx Server Status</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      shell: </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        cmd: systemctl status nginx <span class=\"token operator\">&amp;></span>/dev/null</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      register: Nginx_Check</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - name: Debug</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        msg: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - name: Restart Ngxin Server</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        state: restarted</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      when: Nginx_Check.rc <span class=\"token operator\">==</span> <span class=\"token number\">0</span></pre></td></tr></table></figure><p>2. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_when_3.yml</span></pre></td></tr></table></figure><h6 id=\"114-案例4-为特定的主机执行任务\"><a class=\"anchor\" href=\"#114-案例4-为特定的主机执行任务\">#</a> 1.1.4 案例 4 - 为特定的主机执行任务</h6>\n<p>有 2 台 server</p>\n<ul>\n<li>第一台：192.168.1.7 安装了 nginx</li>\n<li>第二台：192.168.1.51 没有安装 nginx</li>\n</ul>\n<p>现在需要在没有安装 nginx 的节点上做操作创建文件，需要通过 when 条件语句实现</p>\n<p>1. 通过 register 将命令执行结果保存至变量，然后通过 when 语句进行判断</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_when_4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: all</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Get System Install Nginx</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      shell:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        cmd: <span class=\"token function\">rpm</span> <span class=\"token parameter variable\">-qa</span> nginx <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      register: get_nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: Debug</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        msg: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    - name: Create Nginx File</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        path: /tmp/nginx_not_install.txt</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        state: <span class=\"token function\">touch</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      when: get_nginx.stdout <span class=\"token operator\">==</span> <span class=\"token string\">'0'</span></pre></td></tr></table></figure><p>2. 执行 playbook 并测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_when_4.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /tmp/nginx_not_install.txt </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Oct <span class=\"token number\">29</span> <span class=\"token number\">11</span>:00 /tmp/nginx_not_install.txt</pre></td></tr></table></figure><h5 id=\"12-loop循环语句\"><a class=\"anchor\" href=\"#12-loop循环语句\">#</a> 1.2 loop 循环语句</h5>\n<p>在写 playbook 的时候发现了很多 task 都要重复引用某个相同的模块，比如一次启动 10 个服务，或者一次拷贝 10 个文件，如果按照传统的写法最少要写 10 次，这样会显得 playbook 很臃肿。如果使用循环的方式来编写 playbook，这样可以减少重复编写 task 带来的臃肿；</p>\n<h6 id=\"121-案例1-使用循环批量启动服务\"><a class=\"anchor\" href=\"#121-案例1-使用循环批量启动服务\">#</a> 1.2.1 案例 1 - 使用循环批量启动服务</h6>\n<p>1. 在没有使用循环的场景下，启动多个服务需要写多条 task 任务。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat loop_1-1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Systemd Nginx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - name: Systemd PHP</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        name: php-fpm</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        state: started</pre></td></tr></table></figure><p>2. 我们将如上的 playbook 修改为循环的方式，减少重复编写多条 task 任务。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat loop_1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Systemd Nginx php</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        name: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      loop:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        - nginx</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        - php-fpm</pre></td></tr></table></figure><p>3. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook loop_1.yml</span></pre></td></tr></table></figure><h6 id=\"122-案例2-使用循环批量安装软件\"><a class=\"anchor\" href=\"#122-案例2-使用循环批量安装软件\">#</a> 1.2.2 案例 2 - 使用循环批量安装软件</h6>\n<p>1. 批量安装软件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat loop_2.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Installed Httpd Mariadb Package</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      yum: </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        name: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        state: latest</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      loop:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>         - httpd</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>         - mariadb-server</pre></td></tr></table></figure><p>2. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook loop_2.yml</span></pre></td></tr></table></figure><h6 id=\"123-案例3-使用循环批量拷贝文件\"><a class=\"anchor\" href=\"#123-案例3-使用循环批量拷贝文件\">#</a> 1.2.3 案例 3 - 使用循环批量拷贝文件</h6>\n<p>1. 批量拷贝文件，使用 key values 字典的方式</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat loop_3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Rsync rsyncd.conf</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        src: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        dest: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        mode: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      loop:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        - <span class=\"token punctuation\">&#123;</span> src: rsyncd.conf , dest: /tmp/rsyncd.conf , mode: <span class=\"token string\">\"0644\"</span>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        - <span class=\"token punctuation\">&#123;</span> src: rsyncd.pass , dest: /root/rsync.pass , mode: <span class=\"token string\">\"0600\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        - <span class=\"token punctuation\">&#123;</span> src: rsynnd.test , dest: /mnt/rsync.test , mode: <span class=\"token string\">\"0000\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2. 执行 playbook 并验证</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook loop_3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web_7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /tmp/rsyncd.conf</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Oct <span class=\"token number\">29</span> <span class=\"token number\">20</span>:01 /tmp/rsyncd.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web_7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /root/rsync.pass</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>-rw------- <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Oct <span class=\"token number\">29</span> <span class=\"token number\">20</span>:03 /root/rsync.pass</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web_7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /mnt/rsync.test</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>---------- <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Oct <span class=\"token number\">29</span> <span class=\"token number\">20</span>:02 /mnt/rsync.test</pre></td></tr></table></figure><h6 id=\"124-案例4-使用循环批量创建用户\"><a class=\"anchor\" href=\"#124-案例4-使用循环批量创建用户\">#</a> 1.2.4 案例 4 - 使用循环批量创建用户</h6>\n<p>1. 批量创建用户，使用 key values 字典的方式</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat loop_4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Add Users</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      user: </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        groups: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      loop:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        - <span class=\"token punctuation\">&#123;</span> name: <span class=\"token string\">'testuser1'</span>, groups: <span class=\"token string\">'bin'</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        - <span class=\"token punctuation\">&#123;</span> name: <span class=\"token string\">'testuser2'</span>, groups: <span class=\"token string\">'root'</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook loop_4.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web_7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># id testuser1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>testuser1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>testuser1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>testuser1<span class=\"token punctuation\">)</span>,1<span class=\"token punctuation\">(</span>bin<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h6 id=\"125-案例5-使用循环批量创建目录\"><a class=\"anchor\" href=\"#125-案例5-使用循环批量创建目录\">#</a> 1.2.5 案例 5 - 使用循环批量创建目录</h6>\n<p>1. 批量创建目录，使用 key values 字典的方式</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat loop_5.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Create /data /backup</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        path: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      loop:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        - /data</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        - /backup</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        - /ttt</pre></td></tr></table></figure><p>2. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook loop_5.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web_7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /data</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>total <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web_7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /backup/</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>total <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> www www <span class=\"token number\">1160</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">22</span>:04 install_rsync_server.yml</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web_7 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /ttt/</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>total <span class=\"token number\">0</span></pre></td></tr></table></figure><h5 id=\"13handlers与notify\"><a class=\"anchor\" href=\"#13handlers与notify\">#</a> 1.3.Handlers 与 Notify</h5>\n<p>Handlers 是一个触发器，同时是一个特殊的 tasks，它无法直接运行，它需要被 tasks 通知后才会运行。比如：httpd 服务配置文件发生变更，我们则可通过 Notify 通知给指定的 handlers 触发器，然后执行相应重启服务的操作，如果配置文件不发生变更操作，则不会触发 Handlers 任务的执行；</p>\n<h6 id=\"131-案例1-变更服务配置触发重启\"><a class=\"anchor\" href=\"#131-案例1-变更服务配置触发重启\">#</a> 1.3.1 案例 1 - 变更服务配置触发重启</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat redis_server.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: dbservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Installed Redis Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: Configure Redis Server</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        src: ./files/redis.conf.j2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        dest: /etc/redis.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        owner: redis</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        mode: 0640</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      notify: Restart Redis Server</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - name: Systemd Redis Server</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    - name: Restart Redis Server</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><h6 id=\"132-handlers注意事项与说明\"><a class=\"anchor\" href=\"#132-handlers注意事项与说明\">#</a> 1.3.2 Handlers 注意事项与说明</h6>\n<p>handlers 注意事项:</p>\n<ul>\n<li>1. 无论多少个 task 通知了相同的 handlers，handlers 仅会在所有 tasks 结束后运行一次。</li>\n<li>2. 只有 task 发生改变了才会通知 handlers ，没有改变则不会触发 handlers</li>\n<li>3. 不能使用 handlers 替代 tasks、因为 handlers 是一个特殊的 tasks</li>\n</ul>\n<h5 id=\"14-tags任务标签\"><a class=\"anchor\" href=\"#14-tags任务标签\">#</a> 1.4 tags 任务标签</h5>\n<p>默认情况下，Ansible 在执行一个 playbook 时，会执行 playbook 中所有的任务。而标签功能是用来指定要运行 playbook 中的某个特定的任务；</p>\n<p>1. 为 playbook 添加标签的方式有如下几种：</p>\n<ul>\n<li>对一个 task 打一个标签</li>\n<li>对一个 task 打多个标签</li>\n<li>对多个 task 打一个标签</li>\n</ul>\n<p>2.task 打完标签使用的几种方式</p>\n<ul>\n<li>-t 执行指定 tag 标签对应的任务</li>\n<li>--skip-tags 执行除 --skip-tags 标签之外的所有任务</li>\n</ul>\n<h6 id=\"141-案例1-指定执行某个tags\"><a class=\"anchor\" href=\"#141-案例1-指定执行某个tags\">#</a> 1.4.1 案例 1 - 指定执行某个 tags</h6>\n<p>1. 给 playbook 指定的 task 打 tags 标签</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat install_nfs_server.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: <span class=\"token number\">1</span>.Installed NFS Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: nfs-utils</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      tags:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        - install_nfs</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        - install_nfs-server</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    - name: <span class=\"token number\">2</span>.Configure NFS Server</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        src: ./exports.j2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        dest: /etc/exports</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      notify: Restart NFS Server</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - name: <span class=\"token number\">3</span>.Init Group </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      group:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        name: www</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        gid: <span class=\"token number\">666</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    - name: <span class=\"token number\">4</span>.Init User</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      user:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        name: www</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        uid: <span class=\"token number\">666</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        group: www</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        shell: /sbin/nologin</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        create_home: no</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      tags: Configure_nfs-server</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    - name: <span class=\"token number\">5</span>.Init Create Directory</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        path: /data</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        owner: www</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        group: www</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        mode: <span class=\"token string\">\"0755\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      tags: Configure_nfs-server</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    - name: <span class=\"token number\">6</span>.Started NFS Server</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        name: nfs</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    - name: Restart NFS Server</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        name: nfs</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 使用 -t 执行指定的 tags 标签对应的任务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook install_nfs_server.yml  -t Configure_nfs-server</span></pre></td></tr></table></figure><h6 id=\"142-案例2-指定排除某个tags\"><a class=\"anchor\" href=\"#142-案例2-指定排除某个tags\">#</a> 1.4.2 案例 2 - 指定排除某个 tags</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook install_nfs_server.yml  --skip-tag install_nfs-server</span></pre></td></tr></table></figure><h5 id=\"15-include任务复用\"><a class=\"anchor\" href=\"#15-include任务复用\">#</a> 1.5 include 任务复用</h5>\n<p>有时，我们发现大量的 Playbook 内容需要重复编写，各 Tasks 之间功能需相互调用才能完成各自功能，Playbook 庞大到维护困难，这时我们需要使用 include</p>\n<p>比如：A 项目需要用到重启 httpd，B 项目需要用到，重启 httpd，那么我们可以使用 Include 来减少重复编写</p>\n<h6 id=\"151-案例1-多个项目调用相同task\"><a class=\"anchor\" href=\"#151-案例1-多个项目调用相同task\">#</a> 1.5.1 案例 1 - 多个项目调用相同 task</h6>\n<p>1. 编写 restart_nginx.yml 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 注意这是一个 tasks 所有没有 play 的任何信息</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_restart_nginx.yml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>- name: Restart Nginx Server</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  systemd:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    name: nginx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state: restarted</pre></td></tr></table></figure><p>2.A Project 的 playbook 如下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_a_project.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: A Project</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      command: <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"a\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    - name: Restart Nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      include: ./task_restart_nginx.yml</pre></td></tr></table></figure><p>3.B Project 的 playbook 如下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_b_project.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: B Project</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      command: <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"b\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    - name: Restart Nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      include: ./task_restart_nginx.yml</pre></td></tr></table></figure><p>4.A Project 和 B Project 执行后的测试结果如下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_a_project.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_b_project.yml</span></pre></td></tr></table></figure><h6 id=\"152-案例2-inlcude结合tags应用\"><a class=\"anchor\" href=\"#152-案例2-inlcude结合tags应用\">#</a> 1.5.2 案例 2-Inlcude 结合 tags 应用</h6>\n<p>通过指定标签 tags，来说明是安装 tomcat8 还是 tomcat9</p>\n<ul>\n<li>1. 准备入口 main.yml 文件，然后包含 install_tomcat8.yml 以及 install_tomcat9.yml</li>\n<li>2. 在执行 main.yml 时，需要通过 --tags 指明要安装的版本</li>\n</ul>\n<p>1. 编写 main.yml 入口文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat main.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- name: Install Tomcat8 Server</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  include: install_tomcat_8.yml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tags: install_tomcat_8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>- name: Install Tomcat9 Server</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  include: install_tomcat_9.yml</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  tags: install_tomcat_9</pre></td></tr></table></figure><p>2. 编写 install_tomcat8.yml</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat install_tomcat_8.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  vars:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - tomcat_data: /data</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - tomcat_version: <span class=\"token number\">8.5</span>.70</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - name: Create Tomcat Directory</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        name: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    - name: Copy Tomcat Server</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      unarchive:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        src: <span class=\"token string\">\"./files/apache-tomcat-.tar.gz\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        dest: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - name: Create Links</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        src: <span class=\"token string\">\"/apache-tomcat-\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        dest: <span class=\"token string\">\"/tomcat8\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        state: <span class=\"token function\">link</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    - name: Started Tomcat Server</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      shell:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        cmd: <span class=\"token string\">\"nohup /tomcat8/bin/startup.sh &amp;>/dev/null &amp;\"</span></pre></td></tr></table></figure><p>3. 编写 install_tomcat9.yml</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat install_tomcat_9.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  vars:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - tomcat_data: /data</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - tomcat_version: <span class=\"token number\">9.0</span>.53</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - name: Create Tomcat Directory</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        name: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    - name: Copy Tomcat Server</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      unarchive:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        src: <span class=\"token string\">\"./files/apache-tomcat-.tar.gz\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        dest: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - name: Create Links</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        src: <span class=\"token string\">\"/apache-tomcat-\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        dest: <span class=\"token string\">\"/tomcat9\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        state: <span class=\"token function\">link</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    - name: Started Tomcat Server</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      shell:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        cmd: <span class=\"token string\">\"nohup /tomcat9/bin/startup.sh &amp;>/dev/null &amp;\"</span></pre></td></tr></table></figure><p>4. 安装 tomcat 安装包</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll files/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>total <span class=\"token number\">21628</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">10564666</span> Oct <span class=\"token number\">30</span> <span class=\"token number\">10</span>:44 apache-tomcat-8.5.70.tar.gz</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">11575393</span> Oct <span class=\"token number\">30</span> <span class=\"token number\">10</span>:44 apache-tomcat-9.0.53.tar.gz</pre></td></tr></table></figure><p>5. 执行 main.yml 文件，然后通过 --tags 执行对应的版本</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook main.yml --tags install_tomcat_8</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook main.yml --tags install_tomcat_9</span></pre></td></tr></table></figure><h5 id=\"16-playbook异常处理\"><a class=\"anchor\" href=\"#16-playbook异常处理\">#</a> 1.6 Playbook 异常处理</h5>\n<h6 id=\"161-案例1-playbook错误忽略\"><a class=\"anchor\" href=\"#161-案例1-playbook错误忽略\">#</a> 1.6.1 案例 1-Playbook 错误忽略</h6>\n<p>在 playbook 执行的过程中，难免会遇到一些错误。由于 playbook 遇到错误后，不会执行之后的任务，不便于调试，此时，可以使用 ignore_errors 来暂时忽略错误，使得 playbook 继续执行。</p>\n<p>1. 编写 playbook，当有 task 执行失败则会立即终止后续 task 运行</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_error_1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  remote_user: root</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Ignore False</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      command: /bin/false</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#      ignore_errors: yes</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: <span class=\"token function\">touch</span> new <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      file: <span class=\"token assign-left variable\">path</span><span class=\"token operator\">=</span>/tmp/oldxu_ignore <span class=\"token assign-left variable\">state</span><span class=\"token operator\">=</span>touch</pre></td></tr></table></figure><p>2. 执行 playbook，会报错，后续的任务也没有执行。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_error_1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PLAY <span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span> ********************************************************************************************************************</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Gathering Facts<span class=\"token punctuation\">]</span> ***************************************************************************************************************</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Ignore False<span class=\"token punctuation\">]</span> ******************************************************************************************************************</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>fatal: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span>: FAILED<span class=\"token operator\">!</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> true, <span class=\"token string\">\"cmd\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/false\"</span><span class=\"token punctuation\">]</span>, <span class=\"token string\">\"delta\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"0:00:00.002689\"</span>, <span class=\"token string\">\"end\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2025-10-30 11:09:51.210356\"</span>, <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"non-zero return code\"</span>, <span class=\"token string\">\"rc\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"start\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2025-10-30 11:09:51.207667\"</span>, <span class=\"token string\">\"stderr\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>, <span class=\"token string\">\"stderr_lines\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, <span class=\"token string\">\"stdout\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>, <span class=\"token string\">\"stdout_lines\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>fatal: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span>: FAILED<span class=\"token operator\">!</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> true, <span class=\"token string\">\"cmd\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/false\"</span><span class=\"token punctuation\">]</span>, <span class=\"token string\">\"delta\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"0:00:00.002650\"</span>, <span class=\"token string\">\"end\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2025-10-30 11:09:47.189233\"</span>, <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"non-zero return code\"</span>, <span class=\"token string\">\"rc\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"start\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2025-10-30 11:09:47.186583\"</span>, <span class=\"token string\">\"stderr\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>, <span class=\"token string\">\"stderr_lines\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, <span class=\"token string\">\"stdout\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>, <span class=\"token string\">\"stdout_lines\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>PLAY RECAP ***************************************************************************************************************************</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">192.168</span>.1.7                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>   </pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">192.168</span>.1.8                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><p>3. 再次执行 playbook 如果碰到指定的 tasks 错误，会自动忽略，继续执行剩下的 tasks</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_error_1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  remote_user: root</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Ignore False</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      command: /bin/false</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      ignore_errors: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: <span class=\"token function\">touch</span> new <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      file: <span class=\"token assign-left variable\">path</span><span class=\"token operator\">=</span>/tmp/oldxu_ignore <span class=\"token assign-left variable\">state</span><span class=\"token operator\">=</span>touch</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_error_1.yml </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /tmp/oldxu_ignore </span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Oct <span class=\"token number\">30</span> <span class=\"token number\">11</span>:10 /tmp/oldxu_ignore</pre></td></tr></table></figure><h6 id=\"162-案例2-task执行失败强制调用handlers\"><a class=\"anchor\" href=\"#162-案例2-task执行失败强制调用handlers\">#</a> 1.6.2 案例 2-task 执行失败强制调用 handlers</h6>\n<p>通常情况下，当 task 失败后，play 将会终止，任何在前面已经被 tasks notify 的 handlers 都不会被执行。如果你在 play 中设置了 force_handlers: yes 参数，被通知的 handlers 就会被强制执行。(有些特殊场景可能会使用到)</p>\n<p>1. 编写 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_error_2.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  force_handlers: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - name: Create</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        path: /tmp/test.txt</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        state: <span class=\"token function\">touch</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    - name: Installed Packages</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        name: xxxxx</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - name: Restart Nginx Server</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_error_2.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PLAY <span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span> ********************************************************************************************************************</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Gathering Facts<span class=\"token punctuation\">]</span> ***************************************************************************************************************</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Create<span class=\"token punctuation\">]</span> ************************************************************************************************************************</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>changed: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>changed: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Installed Packages<span class=\"token punctuation\">]</span> ************************************************************************************************************</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>fatal: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span>: FAILED<span class=\"token operator\">!</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"No package matching 'xxxxx' found available, installed or updated\"</span>, <span class=\"token string\">\"rc\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">126</span>, <span class=\"token string\">\"results\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"No package matching 'xxxxx' found available, installed or updated\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>fatal: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span>: FAILED<span class=\"token operator\">!</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"No package matching 'xxxxx' found available, installed or updated\"</span>, <span class=\"token string\">\"rc\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">126</span>, <span class=\"token string\">\"results\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"No package matching 'xxxxx' found available, installed or updated\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#前者 task 报错，也不影响 handlers 的调用</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>RUNNING HANDLER <span class=\"token punctuation\">[</span>Restart Nginx Server<span class=\"token punctuation\">]</span> ***********************************************************************************************</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>changed: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>changed: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>PLAY RECAP ***************************************************************************************************************************</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token number\">192.168</span>.1.7                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">3</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>   </pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token number\">192.168</span>.1.8                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">3</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><h6 id=\"163-案例3-控制tasks报告状态为ok\"><a class=\"anchor\" href=\"#163-案例3-控制tasks报告状态为ok\">#</a> 1.6.3 案例 3 - 控制 Tasks 报告状态为 OK</h6>\n<p>1. 编辑 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_error_3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - name: Get Network Port </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      shell: <span class=\"token function\">netstat</span> <span class=\"token parameter variable\">-lntp</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      register: System_Port</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#      changed_when: false</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    - name: debug </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        msg: </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          - <span class=\"token string\">\"执行了  命令\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><p>2. 执行 playbook 会发现第一个 task 运行 shell 模块报告的改变，即使它没有真正的在远端系统做出改变，如果你一直运行，它会一直处在改变状态。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_error_3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PLAY <span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span> ********************************************************************************************************************</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Gathering Facts<span class=\"token punctuation\">]</span> ***************************************************************************************************************</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Get Network Port<span class=\"token punctuation\">]</span> **************************************************************************************************************</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>changed: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>changed: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>debug<span class=\"token punctuation\">]</span> *************************************************************************************************************************</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token string\">\"执行了 netstat -lntp 命令\"</span>, </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token string\">\"Active Internet connections (only servers)\"</span>, </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token string\">\"Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \"</span>, </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN      5481/php-fpm: maste \"</span>, </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 192.168.1.7:6379        0.0.0.0:*               LISTEN      15391/redis-server  \"</span>, </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      15391/redis-server  \"</span>, </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      5195/rpcbind        \"</span>, </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      26839/nginx: master \"</span>, </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      5478/sshd           \"</span>, </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      5683/master         \"</span>, </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::111                  :::*                    LISTEN      5195/rpcbind        \"</span>, </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::8080                 :::*                    LISTEN      11274/java          \"</span>, </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::22                   :::*                    LISTEN      5478/sshd           \"</span>, </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 ::1:25                  :::*                    LISTEN      5683/master         \"</span>, </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 127.0.0.1:8005          :::*                    LISTEN      11274/java          \"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token string\">\"执行了 netstat -lntp 命令\"</span>, </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token string\">\"Active Internet connections (only servers)\"</span>, </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token string\">\"Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \"</span>, </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN      5483/php-fpm: maste \"</span>, </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 192.168.1.8:6379        0.0.0.0:*               LISTEN      26005/redis-server  \"</span>, </pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      26005/redis-server  \"</span>, </pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      5163/rpcbind        \"</span>, </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      32740/nginx: master \"</span>, </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      5481/sshd           \"</span>, </pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      5693/master         \"</span>, </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::111                  :::*                    LISTEN      5163/rpcbind        \"</span>, </pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::8080                 :::*                    LISTEN      31200/java          \"</span>, </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::22                   :::*                    LISTEN      5481/sshd           \"</span>, </pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 ::1:25                  :::*                    LISTEN      5693/master         \"</span>, </pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 127.0.0.1:8005          :::*                    LISTEN      31200/java          \"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>PLAY RECAP ***************************************************************************************************************************</pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token number\">192.168</span>.1.7                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">3</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>   </pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token number\">192.168</span>.1.8                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">3</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><p>3.shell 任务不应该每次都报告 changed 状态，因为它没有在被管理主机执行后发生变化。添加 changed_when: false 来抑制这个改变</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_error_3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - name: Get Network Port </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      shell: <span class=\"token function\">netstat</span> <span class=\"token parameter variable\">-lntp</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      register: System_Port</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      changed_when: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    - name: debug </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        msg: </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          - <span class=\"token string\">\"执行了  命令\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><p>4. 再次执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_error_3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PLAY <span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span> ********************************************************************************************************************</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Gathering Facts<span class=\"token punctuation\">]</span> ***************************************************************************************************************</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Get Network Port<span class=\"token punctuation\">]</span> **************************************************************************************************************</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>debug<span class=\"token punctuation\">]</span> *************************************************************************************************************************</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token string\">\"执行了 netstat -lntp 命令\"</span>, </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token string\">\"Active Internet connections (only servers)\"</span>, </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token string\">\"Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \"</span>, </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN      5481/php-fpm: maste \"</span>, </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 192.168.1.7:6379        0.0.0.0:*               LISTEN      15391/redis-server  \"</span>, </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      15391/redis-server  \"</span>, </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      5195/rpcbind        \"</span>, </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      26839/nginx: master \"</span>, </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      5478/sshd           \"</span>, </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      5683/master         \"</span>, </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::111                  :::*                    LISTEN      5195/rpcbind        \"</span>, </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::8080                 :::*                    LISTEN      11274/java          \"</span>, </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::22                   :::*                    LISTEN      5478/sshd           \"</span>, </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 ::1:25                  :::*                    LISTEN      5683/master         \"</span>, </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 127.0.0.1:8005          :::*                    LISTEN      11274/java          \"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token string\">\"执行了 netstat -lntp 命令\"</span>, </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token string\">\"Active Internet connections (only servers)\"</span>, </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token string\">\"Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \"</span>, </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN      5483/php-fpm: maste \"</span>, </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 192.168.1.8:6379        0.0.0.0:*               LISTEN      26005/redis-server  \"</span>, </pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      26005/redis-server  \"</span>, </pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      5163/rpcbind        \"</span>, </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      32740/nginx: master \"</span>, </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      5481/sshd           \"</span>, </pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token string\">\"tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      5693/master         \"</span>, </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::111                  :::*                    LISTEN      5163/rpcbind        \"</span>, </pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::8080                 :::*                    LISTEN      31200/java          \"</span>, </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 :::22                   :::*                    LISTEN      5481/sshd           \"</span>, </pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 ::1:25                  :::*                    LISTEN      5693/master         \"</span>, </pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token string\">\"tcp6       0      0 127.0.0.1:8005          :::*                    LISTEN      31200/java          \"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>PLAY RECAP ***************************************************************************************************************************</pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token number\">192.168</span>.1.7                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">3</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>   </pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token number\">192.168</span>.1.8                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">3</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><h6 id=\"164-案例4-changed_when检查任务结果\"><a class=\"anchor\" href=\"#164-案例4-changed_when检查任务结果\">#</a> 1.6.4 案例 4-changed_when 检查任务结果</h6>\n<p>1. 编写 playbook，Nginx 具备配置文件健康检查功能；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_error_4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Configure Nginx Server</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      template: </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        src: ./nginx.conf.j2 </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        dest: /etc/nginx/nginx.conf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    - name: Check Nginx Server</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      shell: /usr/sbin/nginx <span class=\"token parameter variable\">-t</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      register: check_nginx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      changed_when: </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\"># 查找变量返回的结果是否有 ok，如不存在则终止该 tasks</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        - check_nginx.stderr.find<span class=\"token punctuation\">(</span><span class=\"token string\">'successful'</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        - <span class=\"token boolean\">false</span> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    - name: Debug</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        msg: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    - name: Systemd Nginx Server</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    - name: Restart Nginx Server</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 编写 playbook 配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx.conf.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>user www<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>worker_processes  <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>error_log  /var/log/nginx/error.log notice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>pid        /var/run/nginx.pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>events <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    worker_connections  <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    include       /etc/nginx/mime.types<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    default_type  application/octet-stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    log_format  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\" \"$http_x_via\"'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    access_log  /var/log/nginx/access.log  main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    sendfile        on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    keepalive_timeout  <span class=\"token number\">65</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    include /etc/nginx/conf.d/*.conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3. 验证测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_error_4.yml</span></pre></td></tr></table></figure><h4 id=\"2ansible-vault\"><a class=\"anchor\" href=\"#2ansible-vault\">#</a> 2.Ansible vault</h4>\n<h5 id=\"21ansiblevault概述\"><a class=\"anchor\" href=\"#21ansiblevault概述\">#</a> 2.1AnsibleVault 概述</h5>\n<p>Ansib1eVault 可以将敏感的数据文件进行加密，而非存放在明文的 playbooks 中； 比如：部分 playbook 内容中有明文密码信息，可以对其进行加密操作；后期只有输入对应的密码才可以查 看、编辑或执行该文件，如没有密码则无法正常运行；</p>\n<h5 id=\"22ansiblevault应用\"><a class=\"anchor\" href=\"#22ansiblevault应用\">#</a> 2.2AnsibleVault 应用</h5>\n<p>1. 使用 ansible-vaultencrypt 进行加密文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-vault-2 encrypt task_error_4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>New Vault password: </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Confirm New Vault password: </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Encryption successful</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#加密后的结果</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat task_error_4.yml </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token variable\">$ANSIBLE_VAULT</span><span class=\"token punctuation\">;</span><span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span>AES256</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">64316530323535383362666364323130396438346539363735303437303662656638333239643336</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>3838666136323138306333643963343639623735333136630a663037616638666537386339363265</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">62313065646336336461373830356566643932613035393234663463313930653565633464643935</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>3661663566373763330a643338333232383638643732366236623865383366383734623666373536</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">61386337333966356635623130663033653264303234636264316535383730303132626131653461</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">30343636343530323435613631373233663338336538356134353436366663353430336137336535</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">31386131373533333833373265613361316630396535653836343239636631666634356265666463</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">66613837303733623166323930353162366364663330326361363934393839366533366439346536</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">33366635343331303232643963353962666533363066306436636465643139633135643337393239</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">61356662653365366665346139326664353264336164633139343638656465366665376634663262</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token number\">66653433646137336337313862616530616330336532656434343136636539353333343037613266</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token number\">64316338633762376533383730316239336532396131303864323734313638323764656366653164</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token number\">65393731353862356664646463373932653734333039356130383633353330333035306662313532</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token number\">39346261386135333766366336626530323865346535613239653135656131343633343661366361</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token number\">30303236306335383533356137323564373731623364633138306234373465656538393736383038</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token number\">64336339313965363961613436643330643963373861666130623737656166396332383833326335</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token number\">37383462303261363430623931356435333339623366316264646330353865333062653830386366</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token number\">32323439313438303137663332316663383531356336376561656362653261613161326239636235</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token number\">62626362643439313536313764376361656535343262383464306534613764356638303431316239</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token number\">37346661663466663565623332383466323039343232346666306666366663306534383666653163</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token number\">31613436613332653366626564373361336237636431356434306233656266646461316266316663</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token number\">31616263653531653765613938643532653833623030373336633661383732613636316163363938</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token number\">37626161326563626261636538643231383866303563386634646164336661636663376561633430</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token number\">35323864663033346134633162326266623832306666353364313034396663373630616139663663</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token number\">32333036666266646137333735396434633932323163313964633132396334323166303561656366</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token number\">66303136343836646330323838353864373637653235303963376332356339326266646463623731</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token number\">35656661333430633439646131326334326532643035656166343264313134343633643035623632</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token number\">61363366323234363765636431373263626530646339653435373033313237373133396533633234</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token number\">32323739366538393364326463376137316663623435643131343366306563363939646462656634</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token number\">34373561363330343663336466313565313234623463623262653664613736353263323366323633</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token number\">32326265306165356162366632653431353331643330613537663661646333616565316636353734</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token number\">30326431643661306262346237396332656135366564366537623361333166393232646363356632</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token number\">36616365396432626265663635633732393837613661356161633236316266313462386136613437</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token number\">36666332626665393134646462663235393465393038626338303936323731613665306535393832</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token number\">65333863313531303962343536306333343934313433616431316139323235663138303234666232</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token number\">32626235623433636334</span></pre></td></tr></table></figure><p>2. 使用 --ask-vault-pass 参数执行加密的文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_error_4.yml --ask-vault-pass</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Vault password:</pre></td></tr></table></figure><p>3. 使用 ansible-vault view 查看加密的文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-vault view task_error_4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Vault password:   <span class=\"token comment\">#输入密码</span></pre></td></tr></table></figure><p>4. 使用 ansible-vault edit 编辑加密的文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-vault edit task_error_4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Vault password:   <span class=\"token comment\">#输入密码</span></pre></td></tr></table></figure><p>5. 使用 ansible-vault rekey 改变加密的文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-vault rekey task_error_4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Vault password: <span class=\"token comment\">#旧密码</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>New Vault password:  <span class=\"token comment\">#新密码</span></pre></td></tr></table></figure><p>6. 使用密码文件执行加密的 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"talent\" > file_pass</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod 600 file_pass </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll file_pass </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>-rw------- <span class=\"token number\">1</span> root root <span class=\"token number\">7</span> Oct <span class=\"token number\">30</span> <span class=\"token number\">16</span>:52 file_pass</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook task_error_4.yml --vault-password-file=file_pass</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 在 ansible.cfg 里新增 vault_password_file 参数，并指定密码文件路径。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim ansible.cfg</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>defaults<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>vault_password_file <span class=\"token operator\">=</span> file_pass</pre></td></tr></table></figure><p>7. 使用 ansible-vault 移除加密文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager task<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-vault decrypt task_error_4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Vault password: </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Decryption successful</pre></td></tr></table></figure>",
            "tags": [
                "Ansible"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/4269570224.html",
            "url": "http://ixuyong.cn/posts/4269570224.html",
            "title": "Ansible Variables",
            "date_published": "2025-10-30T13:12:34.000Z",
            "content_html": "<h3 id=\"ansible-variables\"><a class=\"anchor\" href=\"#ansible-variables\">#</a> Ansible Variables</h3>\n<h4 id=\"1-ansible-variables\"><a class=\"anchor\" href=\"#1-ansible-variables\">#</a> 1. Ansible Variables</h4>\n<h5 id=\"11-什么是变量\"><a class=\"anchor\" href=\"#11-什么是变量\">#</a> 1.1 什么是变量</h5>\n<p>变量提供了便捷的方式来管理 ansible 项目中的动态值。 比如 nginx-1.12，可能后期会反复的使用到这个版本的值，那么如果将此值设置为变量，后续使用和修改都将变得非常方便。</p>\n<h5 id=\"12-变量定义的方式\"><a class=\"anchor\" href=\"#12-变量定义的方式\">#</a> 1.2 变量定义的方式</h5>\n<p>在 Ansible 中定义变量分为如下三种方式：</p>\n<ul>\n<li>\n<p>1. 通过命令行传递变量参数定义</p>\n</li>\n<li>\n<p>2. 在 play 文件中进行定义变量</p>\n<ul>\n<li>\n<p>2.1) 通过 vars 定义变量</p>\n</li>\n<li>\n<p>2.2) 通过 vars_files 定义变量</p>\n</li>\n</ul>\n</li>\n<li>\n<p>3. 通过 inventory 在主机组或单个主机中设置变量</p>\n<ul>\n<li>\n<p>3.1) 通过 host_vars 对主机进行定义</p>\n</li>\n<li>\n<p>3.2) 通过 group_vars 对主机组进行定义</p>\n</li>\n</ul>\n</li>\n</ul>\n<p>问题：如果定义的变量出现重复，造成冲突，如何解决？</p>\n<h5 id=\"13-在playbook中定义变量\"><a class=\"anchor\" href=\"#13-在playbook中定义变量\">#</a> 1.3 在 Playbook 中定义变量</h5>\n<h6 id=\"131-vars方式定义变量\"><a class=\"anchor\" href=\"#131-vars方式定义变量\">#</a> 1.3.1 vars 方式定义变量</h6>\n<p>在 playbook 的文件中开头通过 vars 关键字进行变量定义</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat var1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  vars: </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - web_packages: httpd_2</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - ftp_packages: vsftpd_2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    - name: Output Vaiables</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      debug: </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        msg: </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h6 id=\"132-vars_files方式定义变量\"><a class=\"anchor\" href=\"#132-vars_files方式定义变量\">#</a> 1.3.2 vars_files 方式定义变量</h6>\n<p>在 playbook 中使用 vars_files 指定文件作为变量文件，好处就是其他的 playbook 也可以调用；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gL1z1Mx.png\" alt=\"1.png\" /></p>\n<p>1. 准备一个用于存储变量的文件，后缀为 .yml 文件内容：vars_name: value</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat var.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ansible_cfg: /etc/ansible/ansible.cfg</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ansible_exe: /usr/bin/ansible/sbin/ansible</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ansible_vars: playbook_vars_files</pre></td></tr></table></figure><p>2. 使用 Playbook 调用变量文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat var1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  vars: </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - web_packages: httpd_2</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - ftp_packages: vsftpd_2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  vars_files: </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    - ./var.yml</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - name: Output Vaiables</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      debug: </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        msg: </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"14-在inventory中定义变量\"><a class=\"anchor\" href=\"#14-在inventory中定义变量\">#</a> 1.4 在 Inventory 中定义变量</h5>\n<h6 id=\"141-inventory文件中定义变量\"><a class=\"anchor\" href=\"#141-inventory文件中定义变量\">#</a> 1.4.1 Inventory 文件中定义变量</h6>\n<p>1. 设定主机变量和组变量</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/ansible/hosts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.1.7 <span class=\"token assign-left variable\">priority</span><span class=\"token operator\">=</span><span class=\"token number\">100</span> <span class=\"token assign-left variable\">state</span><span class=\"token operator\">=</span>master</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.1.8 <span class=\"token assign-left variable\">priority</span><span class=\"token operator\">=</span><span class=\"token number\">50</span> <span class=\"token assign-left variable\">state</span><span class=\"token operator\">=</span>backup</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>webservers:vars<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token number\">80</span>  <span class=\"token comment\"># 组变量</span></pre></td></tr></table></figure><p>2.playbook 调用变量</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat var3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Output Vaiables</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      debug: </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        msg: </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>          - <span class=\"token string\">\"  \"</span></pre></td></tr></table></figure><p>3.playbook 执行结果</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook var3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PLAY <span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span> ********************************************************************************************************************</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Gathering Facts<span class=\"token punctuation\">]</span> ***************************************************************************************************************</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Output Vaiables<span class=\"token punctuation\">]</span> ***************************************************************************************************************</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.7<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token string\">\"100 master 80\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">192.168</span>.1.8<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token string\">\"msg\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token string\">\"50 backup 80\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>PLAY RECAP ***************************************************************************************************************************</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token number\">192.168</span>.1.7                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>   </pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token number\">192.168</span>.1.8                <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><h6 id=\"142-使用host_vars定义变量\"><a class=\"anchor\" href=\"#142-使用host_vars定义变量\">#</a> 1.4.2 使用 host_vars 定义变量</h6>\n<p>1. 在项目目录中创建 host_vars 目录，然后在创建一个文件，文件的文件名称要与 inventory 清单中的主机名称要保持完全一致，如果是 ip 地址，则创建相同 ip 地址的文件即可。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/ansible/hosts </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.1.7</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.1.8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir host_vars</span></pre></td></tr></table></figure><p>2. 在 host_vars 目录中创建文件，给 192.168.1.7、 192.168.1.8 主机定义变量</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat host_vars/192.168.1.7</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>state: MASTER</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>priority: <span class=\"token number\">200</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat host_vars/192.168.1.8</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>state: BACKUP</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>priority: <span class=\"token number\">100</span></pre></td></tr></table></figure><p>3. 准备一个 playbook 文件调用 host_vars 目录中定义的主机变量</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat var4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Copy Keeplaived Configure </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        src: ./keepalived.conf.j2</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        dest: /tmp/keepalived.conf</pre></td></tr></table></figure><p>4. 准备 playbook 中配置文件 keepalived.conf.j2</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat keepalived.conf.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    state <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼10--<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    interface eth0 eth1             <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    priority <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼11--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>5. 执行 playbook 结果</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook var4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># web01 执行结果</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /tmp/keepalived.conf </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state MASTER </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    interface eth0 eth1             <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    priority <span class=\"token number\">200</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># web02 执行结果</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /tmp/keepalived.conf </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    state BACKUP </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    interface eth0 eth1             <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"143-使用group_vars定义变量\"><a class=\"anchor\" href=\"#143-使用group_vars定义变量\">#</a> 1.4.3 使用 group_vars 定义变量</h6>\n<p>1. 在项目目录中创建 group_vars 目录，然后在创建一个文件，文件的文件名称要与 inventory 清单中的组名称保持完全一致；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/ansible/hosts </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.1.7</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.1.8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir group_vars</span></pre></td></tr></table></figure><p>2. 在 group_vars 目录中创建 webservers 文件，为 webservers 主机组设定变量；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat group_vars/webservers </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>virtual_router_id: <span class=\"token number\">100</span></pre></td></tr></table></figure><p>3. 编写 playbook，只需在 playbook 文件中使用变量即可；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat var4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Copy Keeplaived Configure </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        src: ./keepalived.conf.j2</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        dest: /tmp/keepalived.conf</pre></td></tr></table></figure><p>4. 准备 playbook 中配置文件 keepalived.conf.j2</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat keepalived.conf.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    state <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼12--<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    interface eth0 eth1             <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    virtual_router_id <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼13--<span class=\"token operator\">></span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    priority <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼14--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>5. 执行 playbook 结果</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook var4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># web01 执行结果</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /tmp/keepalived.conf </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    state MASTER </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    interface eth0 eth1             <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    virtual_router_id <span class=\"token number\">100</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    priority <span class=\"token number\">200</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># web02 执行结果</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /tmp/keepalived.conf </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    state BACKUP </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    interface eth0 eth1             <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    virtual_router_id <span class=\"token number\">100</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>6. 测试其他组能否使用 webservers 组中定义的变量；测试后会发现无法调用；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat var4.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: lbservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Copy Keeplaived Configure </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        src: ./keepalived.conf.j2</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        dest: /tmp/keepalived.conf</pre></td></tr></table></figure><p>7. 但是系统提供了特殊的 all 组，也就说在 group_vars 目录下创建一个 all 文件，定义变量对所有的主机组都生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 在 group_vars 目录下创建一个 all 文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat group_vars/all</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>web_packages: <span class=\"token function\">wget</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ftp_packages: tree</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#2. 编写 playbook 文件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat var6.yml </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - name: debug</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        msg: <span class=\"token string\">\" \"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#3. 执行 playbook</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook var6.yml</span></pre></td></tr></table></figure><h5 id=\"15-执行playbook传递变量\"><a class=\"anchor\" href=\"#15-执行playbook传递变量\">#</a> 1.5 执行 Playbook 传递变量</h5>\n<p>在执行 Playbook 时，可以通过命令行 --extra-vars 或 -e 外置传参设定变量；</p>\n<p>1. 准备 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat var5.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webserver</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Output Vaiables</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        msg:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><p>2. 执行 playbook 时进行变量的传递</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook var5.yml -e \"web_packages=GeoIP\"</span></pre></td></tr></table></figure><p>3. 传递多个外置变量的方式</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook var5.yml -e \"web_packages=GeoIP\"  -e \"ftp_packages=ftpIP\"</span></pre></td></tr></table></figure><h5 id=\"16-变量优先级测试\"><a class=\"anchor\" href=\"#16-变量优先级测试\">#</a> 1.6 变量优先级测试</h5>\n<p>定义相同的变量不同的值，来测试变量的优先级。操作步骤如下</p>\n<ul>\n<li>1）在 plabook 中定义 vars 变量</li>\n<li>2）在 playbook 中定义 vars_files 变量</li>\n<li>3）在 Inventory_host 中定义变量</li>\n<li>4）在 group_vars 中定义变量</li>\n<li>5）通过执行命令传递变量</li>\n</ul>\n<p><strong>结果: 1️⃣命令行传参 --&gt;2️⃣playbook 中的 vars_files--&gt;3️⃣playbook 中的 vars--&gt;4️⃣ Inventory_host 变量 --&gt;5️⃣group_vars--&gt;6️⃣group_vars/all --&gt;7️⃣ Inventory_group</strong></p>\n<h5 id=\"17-项目实战将nfs项目改造为变量方式\"><a class=\"anchor\" href=\"#17-项目实战将nfs项目改造为变量方式\">#</a> 1.7 项目实战将 NFS 项目改造为变量方式</h5>\n<p>1. 准备 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nfs_server_variables.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  vars_files: ./nfs_variables.yml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - name: <span class=\"token number\">1</span>.Installed NFS Server</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        name: nfs-utils</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    - name: <span class=\"token number\">2</span>.Configure NFS Server</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        src: ./exports.j2</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        dest: /etc/exports</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      notify: Restart NFS Server</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    - name: <span class=\"token number\">3</span>.Init Group </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      group:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        name: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        gid: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    - name: <span class=\"token number\">4</span>.Init User</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      user:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        name: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        uid: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        group: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        shell: /sbin/nologin</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        create_home: no</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    - name: <span class=\"token number\">5</span>.Init Create Directory</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        path: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        owner: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        group: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        mode: <span class=\"token string\">\"0755\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    - name: <span class=\"token number\">6</span>.Started NFS Server</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        name: nfs</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    - name: Restart NFS Server</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        name: nfs</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        state: restarted</pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>- hosts: localhost</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  vars_files: ./nfs_variables.yml</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    - name: Mount </pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      mount:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        src: <span class=\"token string\">\":\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        path: /mnt</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        fstype: nfs</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        opts: defaults</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        state: mounted</pre></td></tr></table></figure><p>2. 准备 NFS 配置文件 exports.j2</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat exports.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼29--<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.0/24<span class=\"token punctuation\">(</span>rw,all_squash,anonuid<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼30--<span class=\"token operator\">></span>,anongid<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼31--<span class=\"token operator\">></span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>3. 准备 playbook 变量文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nfs_variables.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nfs_share_data: /data</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nfs_uid: <span class=\"token number\">666</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nfs_gid: <span class=\"token number\">666</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nfs_user: www</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nfs_group: www</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nfs_server: <span class=\"token number\">172.16</span>.1.7</pre></td></tr></table></figure><p>4. 执行 playbook 并测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook nfs_server_variables.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># df -h |grep mnt</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">172.16</span>.1.7:/data   17G   11G  <span class=\"token number\">6</span>.5G  <span class=\"token number\">62</span>% /mnt</pre></td></tr></table></figure><h4 id=\"2ansible-register\"><a class=\"anchor\" href=\"#2ansible-register\">#</a> 2.Ansible Register</h4>\n<h5 id=\"21-什么是register\"><a class=\"anchor\" href=\"#21-什么是register\">#</a> 2.1 什么是 Register</h5>\n<p>register 可以将 task 执行的任务结果存储至某个变量中，便于后续的引用；</p>\n<h5 id=\"22-register场景示例1\"><a class=\"anchor\" href=\"#22-register场景示例1\">#</a> 2.2 Register 场景示例 1</h5>\n<p>需求：使用 Register 获取被控节点的端口信息</p>\n<p>1. 准备 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat register_1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Get Network Port </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      shell: <span class=\"token function\">netstat</span> <span class=\"token parameter variable\">-lntp</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      register: System_Port</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: debug </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        msg: </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - <span class=\"token string\">\"执行了  命令\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          - <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><p>2.playbook 执行结果</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook register_1.yml</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/nQsUrXx.jpeg\" alt=\"1.jpg\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/RDAWJub.jpeg\" alt=\"2.jpg\" /></p>\n<h5 id=\"23-register场景示例2\"><a class=\"anchor\" href=\"#23-register场景示例2\">#</a> 2.3 Register 场景示例 2</h5>\n<p>需求：批量修改 200 台主机名称</p>\n<p>1. 准备 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat register_2.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: String</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      shell: <span class=\"token builtin class-name\">echo</span> <span class=\"token environment constant\">$RANDOM</span> <span class=\"token operator\">|</span>md5sum <span class=\"token operator\">|</span> <span class=\"token function\">cut</span> <span class=\"token parameter variable\">-c</span> <span class=\"token number\">2</span>-10</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#      shell: echo $((RANDOM%200))</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      register: systemd_sj</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: debug</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        msg: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    - name: Chanage Hostname</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      hostname:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        name: <span class=\"token string\">\"web_\"</span></pre></td></tr></table></figure><p>2. 执行 playbook 并测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook register_2.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   Static hostname: web_8ccbbb7ce</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>         Icon name: computer-vm</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>           Chassis: vm</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        Machine ID: bd353f63eda44afab936db8ef2974eb1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           Boot ID: 63559abc84684641ac245ad94e9c8e55</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    Virtualization: vmware</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Operating System: CentOS Linux <span class=\"token number\">7</span> <span class=\"token punctuation\">(</span>Core<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>       CPE OS Name: cpe:/o:centos:centos:7</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            Kernel: Linux <span class=\"token number\">3.10</span>.0-957.el7.x86_64</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      Architecture: x86-64</pre></td></tr></table></figure><p>2.4 Register 场景示例 3</p>\n<p>需求：使用 register 关键字完成 jumpserver key 的创建</p>\n<p>1. 准备 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat register_3.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: BOOTSTRAP_TOKEN</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      shell: <span class=\"token string\">'if grep \"BOOTSTRAP_TOKEN\" ~/.bashrc ;then</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                echo $BOOTSTRAP_TOKEN;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>             else</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                BOOTSTRAP_TOKEN=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 24`;   </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                echo \"BOOTSTRAP_TOKEN=$BOOTSTRAP_TOKEN\" >> ~/.bashrc;   </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                echo \"BOOTSTRAP_TOKEN=$BOOTSTRAP_TOKEN\";</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>             fi'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      register: JMS_BOOTSTRAP_TOKEN</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - name: SECRET_KEY</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      shell: <span class=\"token string\">'if grep \"SECRET_KEY\" ~/.bashrc ;then </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                echo $SECRET_KEY;</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>             else</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                SECRET_KEY=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 50`;</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                echo \"SECRET_KEY=$SECRET_KEY\" >> ~/.bashrc;   </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                echo \"SECRET_KEY=$SECRET_KEY\";</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>             fi'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      register: JMS_SECRET_KEY</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    - name: Copy JMS Config.yml</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        src: ./jms.yml</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        dest: /tmp/jms.yml</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    - name: Copy KoKo Config.yml</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        src: ./koko.yml</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        dest: /tmp/koko.yml</pre></td></tr></table></figure><p>2. 准备 playbook 文件配置文件 jms.yml 、koko.yml</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 模拟 jms 配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat jms.yml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>SECRET_KEY: <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼36--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>BOOTSTRAP_TOKEN: <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼37--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#2. 模拟 koko 配置文件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat koko.yml </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># Jumpserver 项目的 url, api 请求注册会使用</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># CORE_HOST: http://127.0.0.1:8080</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>BOOTSTRAP_TOKEN: <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼38--<span class=\"token operator\">></span></pre></td></tr></table></figure><p>3. 执行 playbook 并测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 执行 playbook</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook register_3.yml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 验证测试</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /tmp/jms.yml </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>SECRET_KEY: tuw13bJFHddReo33qHE36xm9dqp8WNlsoScrCyaIiD894kjhIu</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>BOOTSTRAP_TOKEN: pmEcXW2q7KwVOPUkcbAXoDdu</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /tmp/koko.yml </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># Jumpserver 项目的 url, api 请求注册会使用</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># CORE_HOST: http://127.0.0.1:8080</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>BOOTSTRAP_TOKEN: pmEcXW2q7KwVOPUkcbAXoDdu</pre></td></tr></table></figure><h4 id=\"3-ansible-facts-variables\"><a class=\"anchor\" href=\"#3-ansible-facts-variables\">#</a> 3. Ansible Facts Variables</h4>\n<h5 id=\"31-什么是facts\"><a class=\"anchor\" href=\"#31-什么是facts\">#</a> 3.1 什么是 facts</h5>\n<p>Ansible facts 变量主要用来自动采集，” 被控端主机 “自身的状态信息。</p>\n<p>比如：被动端的，主机名、IP 地址、系统版本、CPU 数量、内存状态、磁盘状态等。</p>\n<h5 id=\"32-facts使用场景\"><a class=\"anchor\" href=\"#32-facts使用场景\">#</a> 3.2 facts 使用场景</h5>\n<p>1. 通过 facts 变量检查被控端硬件 CPU 信息，从而生成不同的 Nginx 配置文件。</p>\n<p>2. 通过 facts 变量检查被控端内存状态信息，从而生成不同的 memcached 的配置文件。</p>\n<p>3. 通过 facts 变量检查被控端主机名称信息，从而生成不同的 Zabbix 配置文件。</p>\n<p>4. 通过 facts 变量检查被控端主机 IP 地址信息，从而生成不同的 redis 配置文件。</p>\n<p>5. 通过 facts 变量........</p>\n<h5 id=\"33-facts语法示例\"><a class=\"anchor\" href=\"#33-facts语法示例\">#</a> 3.3 facts 语法示例</h5>\n<p>1. 查看所有 facts 变量</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible localhost -m setup</span></pre></td></tr></table></figure><p>2. 通过 facts 获取被控端的主机名与 IP 地址，然后通过 debug 输出</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat facts_1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">#gather_facts: no</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - name: Print IP</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        msg: <span class=\"token string\">\"  \"</span></pre></td></tr></table></figure><p>3. 获取 facts 变量，可以使用 filter 过滤特定的关键项</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible localhost -m setup -a \"filter=\"ansible_fqdn\"\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>localhost <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token string\">\"ansible_facts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"ansible_fqdn\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"manager\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>, </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>4. 如果没有使用 facts 变量需求，可以关闭其功能，加速 ansible 执行性能；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat facts_1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  gather_facts: no</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - name: Print IP</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      debug:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        msg: <span class=\"token string\">\"  \"</span></pre></td></tr></table></figure><h5 id=\"34-案例1-根据主机ip地址生成redis配置\"><a class=\"anchor\" href=\"#34-案例1-根据主机ip地址生成redis配置\">#</a> 3.4 案例 1 - 根据主机 IP 地址生成 Redis 配置</h5>\n<p>1. 编写安装配置 redis 服务的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat facts_redis.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Installed Redis Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: Configure Redis Server</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        src: ./redis.conf.j2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        dest: /etc/redis.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      notify: Restart Redis Server</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    - name: Started Redis Server</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    - name: Restart Redis Server</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 redis.conf.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp /etc/redis.conf /root/web_cluster/files/redis.conf.j2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager files<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"/^bind 127.0.0.1/c bind 127.0.0.1 \" redis.conf.j2</span></pre></td></tr></table></figure><p>3. 验证测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep 6379</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.1.7:6379        <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">15391</span>/redis-server  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:6379          <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">15391</span>/redis-server</pre></td></tr></table></figure><h5 id=\"35-案例2-根据主机cpu生成nginx配置\"><a class=\"anchor\" href=\"#35-案例2-根据主机cpu生成nginx配置\">#</a> 3.5 案例 2 - 根据主机 CPU 生成 Nginx 配置</h5>\n<p>1. 编写安装配置 Nginx 服务的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat facts_nginx.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: Installed Nginx Server</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - name: Configure Nginx nginx.conf</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        src: ./nginx.conf.j2</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        dest: /etc/nginx/nginx.conf</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        mode: 0644</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    - name: Started Nginx Server</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    - name: Restart Nginx Server</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 nginx.conf.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx.conf.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>user www<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>worker_processes  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--swig￼46--<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>error_log  /var/log/nginx/error.log notice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>pid        /var/run/nginx.pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>events <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    worker_connections  <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    include       /etc/nginx/mime.types<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    default_type  application/octet-stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    log_format  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\" \"$http_x_via\"'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    access_log  /var/log/nginx/access.log  main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    sendfile        on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    keepalive_timeout  <span class=\"token number\">65</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    include /etc/nginx/conf.d/*.conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3. 验证测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook facts_nginx.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/nginx.conf  | grep worker_processes</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>worker_processes  <span class=\"token number\">8</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h5 id=\"36-案例3-根据主机内存生成memcached配置\"><a class=\"anchor\" href=\"#36-案例3-根据主机内存生成memcached配置\">#</a> 3.6 案例 3 - 根据主机内存生成 Memcached 配置</h5>\n<p>1. 编写安装配置 memcached 服务的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat facts_memcached.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Installed Memcached</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: memcached</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - name: Configre Memcached</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        src: ./memcached.j2</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        dest:  /etc/sysconfig/memcached</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      notify: Restart Memcache Server</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - name: Started Memcached</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        name: memcached</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    - name: Restart Memcache Server</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: memcached</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 memcached.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat memcached.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token string\">\"11211\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">USER</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"memcached\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">MAXCONN</span><span class=\"token operator\">=</span><span class=\"token string\">\"1024\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">CACHESIZE</span><span class=\"token operator\">=</span><span class=\"token string\">\"NaN\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">OPTIONS</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr></table></figure><p>3. 验证测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook facts_memcached.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web_8ccbbb7ce ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># free -m</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>              total        used        <span class=\"token function\">free</span>      shared  buff/cache   available</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Mem:           <span class=\"token number\">1819</span>         <span class=\"token number\">351</span>        <span class=\"token number\">1029</span>          <span class=\"token number\">27</span>         <span class=\"token number\">439</span>        <span class=\"token number\">1300</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Swap:          <span class=\"token number\">2047</span>           <span class=\"token number\">0</span>        <span class=\"token number\">2047</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web_8ccbbb7ce ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/memcached </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token string\">\"11211\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">USER</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"memcached\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">MAXCONN</span><span class=\"token operator\">=</span><span class=\"token string\">\"1024\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">CACHESIZE</span><span class=\"token operator\">=</span><span class=\"token string\">\"909.5\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">OPTIONS</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"37-案例6-使用facts批量修改主机名\"><a class=\"anchor\" href=\"#37-案例6-使用facts批量修改主机名\">#</a> 3.7 案例 6 - 使用 facts 批量修改主机名</h5>\n<pre><code>[root@manager var]# cat facts_hostname.yml \n- hosts: webservers\n  tasks:\n    - name: Print IP\n      debug:\n        # 获取facts变量，然后提取IP地址，以.结尾的最后一列\n        msg: &quot;&#123;&#123; ansible_eth0.ipv4.address.split('.')[-1] &#125;&#125;&quot;\n\n    - name: Change Hostname\n      hostname:\n        name: web_&#123;&#123; ansible_eth0.ipv4.address.split('.')[-1] &#125;&#125;\n</code></pre>\n<h5 id=\"38-facts变量性能优化\"><a class=\"anchor\" href=\"#38-facts变量性能优化\">#</a> 3.8 facts 变量性能优化</h5>\n<h6 id=\"381-关闭facts采集加速执行-方式1\"><a class=\"anchor\" href=\"#381-关闭facts采集加速执行-方式1\">#</a> 3.8.1 关闭 facts 采集加速执行 - 方式 1</h6>\n<p>1. 编写 TASK 任务 sleep10 秒，针对 15 台机器同时执行，需要消耗的时间大概是 1m56.980s</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat facts_sleep.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: all</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">#gather_facts: no </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: <span class=\"token function\">sleep</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      command: <span class=\"token function\">sleep</span> <span class=\"token number\">10</span></pre></td></tr></table></figure><p>2. 使用 gather_facts: no 关闭 facts 信息采集，发现仅花费了 0m38.164s ，整个速度提升了 3 倍；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat facts_sleep.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: all</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  gather_facts: no </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: <span class=\"token function\">sleep</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      command: <span class=\"token function\">sleep</span> <span class=\"token number\">10</span></pre></td></tr></table></figure><h6 id=\"382-缓存facts变量加速执行-方式2\"><a class=\"anchor\" href=\"#382-缓存facts变量加速执行-方式2\">#</a> 3.8.2 缓存 facts 变量加速执行 - 方式 2</h6>\n<p>1. 当我们使用 gather_facts: no 关闭 facts，确实能加速 Ansible 执行，但是有时候又需要使用 facts 中的内容，还希望执行的速度快一点，这时候可以设置 facts 的缓存；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install python-pip -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># pip install redis</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@m01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/ansible/ansible.cfg</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>defaults<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># smart 表示默认收集 facts，但 facts 已有的情况下不会收集，即使用缓存 facts</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># implicit 表示默认收集 facts，要禁止收集，必须使用 gather_facts: False；</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># explicit 则表示默认不收集，要显式收集，必须使用 gather_facts: Ture。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>gathering <span class=\"token operator\">=</span> smart <span class=\"token comment\">#在使用 facts 缓存时设置为 smart</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>fact_caching_timeout <span class=\"token operator\">=</span> <span class=\"token number\">86400</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>fact_caching <span class=\"token operator\">=</span> redis</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>fact_caching_connection <span class=\"token operator\">=</span> <span class=\"token number\">172.16</span>.1.41:6379</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 若 redis 设置了密码，1 表示 redis1 号库</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># fact_caching_connection = 172.16.1.41:6379:1:passwd</span></pre></td></tr></table></figure><p>2. 编写 Playbook 测试；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager var<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat facts_sleep.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: all</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  gather_facts: no </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - name: <span class=\"token function\">sleep</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      command: <span class=\"token function\">sleep</span> <span class=\"token number\">10</span></pre></td></tr></table></figure><p>3. 测试结果如下：</p>\n<ul>\n<li>执行第一次花费了 1m49.881s 因为第一次需要将 facts 信息缓存至 Redis</li>\n<li>执行第二次花费了 0m38.130s 可以看出使用 Redis 缓存 facts 变量，整体执行时间提高了 3 倍</li>\n</ul>\n",
            "tags": [
                "Ansible"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2304648507.html",
            "url": "http://ixuyong.cn/posts/2304648507.html",
            "title": "Ansible Playbook入门",
            "date_published": "2025-10-25T12:34:11.000Z",
            "content_html": "<h3 id=\"ansible-playbook入门二\"><a class=\"anchor\" href=\"#ansible-playbook入门二\">#</a> Ansible Playbook 入门（二）</h3>\n<h4 id=\"1ansible快速入门\"><a class=\"anchor\" href=\"#1ansible快速入门\">#</a> 1.Ansible 快速入门</h4>\n<h5 id=\"11-什么是playbook\"><a class=\"anchor\" href=\"#11-什么是playbook\">#</a> 1.1 什么是 Playbook</h5>\n<p>playbook 是一个 由 yml 语法编写的文本文件，它由 play 和 task 两部分组成。</p>\n<p>play： 主要定义要操作主机或者主机组</p>\n<p>task：主要定义对主机或主机组具体执行的任务，可以是一个任务，也可以是多个任务（模块）</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WjESyUD.jpeg\" alt=\"1.jpg\" /></p>\n<p>总结: playbook 是由一个或多个 play 组成，一个 play 可以包含多个 task 任务。</p>\n<p>可以理解为：使用多个不同的模块来共同完成一件事情。</p>\n<h5 id=\"12-playbook与ad-hoc区别\"><a class=\"anchor\" href=\"#12-playbook与ad-hoc区别\">#</a> 1.2 Playbook 与 Ad-Hoc 区别</h5>\n<ul>\n<li>playbook 是对 AD-Hoc 的一种编排方式。</li>\n<li>playbook 可以持久运行，而 Ad-Hoc 只能临时运行。</li>\n<li>playbook 适合复杂的任务，而 Ad-Hoc 适合做快速简单的任务。</li>\n<li>playbook 能控制任务执行的先后顺序。</li>\n</ul>\n<h5 id=\"13-playbook书写格式\"><a class=\"anchor\" href=\"#13-playbook书写格式\">#</a> 1.3 Playbook 书写格式</h5>\n<p>playbook 是由 yml 语法书写，结构清晰，可读性强，所以必须掌握 yml 语法</p>\n<table>\n<thead>\n<tr>\n<th><strong>语法</strong></th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>缩进</td>\n<td>YAML 使用固定的缩进风格表示层级结构，每个缩进由两个空格组成，不能使用 tabs</td>\n</tr>\n<tr>\n<td>冒号</td>\n<td>以冒号结尾的除外，其他所有冒号后面所有必须有空格。</td>\n</tr>\n<tr>\n<td>短横线</td>\n<td>表示列表项，使用一个短横杠加一个空格。多个项使用同样的缩进级别作为同一列表。</td>\n</tr>\n</tbody>\n</table>\n<p>1. 下面我们一起来编写一个 playbook 文件，playbook 起步</p>\n<ul>\n<li>host: 对哪些主机进行操作</li>\n<li>remote_user: 我要使用什么用户执行</li>\n<li>tasks: 具体执行什么任务</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat test_p1.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Installed Nginx Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: Systemd Nginx Server</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr></table></figure><p>2. 执行 playbook，注意观察执行返回的状态颜色:</p>\n<ul>\n<li>红色：表示有<em> task</em> 执行失败，通常都会提示错误信息。</li>\n<li>黄色：表示远程主机按照编排的任务执行且进行了改变。</li>\n<li>绿色：表示该主机已经是描述后的状态，无需在次运行。</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 检查语法</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook test_p1.yml --syntax-check</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 模拟执行</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook -C test_p1.yml </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3. 执行 playbook</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook test_p1.yml </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>PLAY <span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span> *****************************************************************************************************************</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Gathering Facts<span class=\"token punctuation\">]</span> ************************************************************************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Installed Nginx Server<span class=\"token punctuation\">]</span> *****************************************************************************************************</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>TASK <span class=\"token punctuation\">[</span>Systemd Nginx Server<span class=\"token punctuation\">]</span> *******************************************************************************************************</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>ok: <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>PLAY RECAP ************************************************************************************************************************</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token number\">172.16</span>.1.7                 <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">3</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>   </pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token number\">172.16</span>.1.8                 <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">ok</span><span class=\"token operator\">=</span><span class=\"token number\">3</span>    <span class=\"token assign-left variable\">changed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">unreachable</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">failed</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">skipped</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">rescued</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>    <span class=\"token assign-left variable\">ignored</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"2playbook案例实战\"><a class=\"anchor\" href=\"#2playbook案例实战\">#</a> 2.Playbook 案例实战</h4>\n<h5 id=\"21-ansible部署nfs示例\"><a class=\"anchor\" href=\"#21-ansible部署nfs示例\">#</a> 2.1 Ansible 部署 NFS 示例</h5>\n<p>1. 编写安装配置 nfs 服务的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat install_nfs_server.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: <span class=\"token number\">1</span>.Installed NFS Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: nfs-utils</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: <span class=\"token number\">2</span>.Configure NFS Server</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        src: ./exports.j2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        dest: /etc/exports</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      notify: Restart NFS Server</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    - name: <span class=\"token number\">3</span>.Init Group </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      group:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        name: www</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        gid: <span class=\"token number\">666</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    - name: <span class=\"token number\">4</span>.Init User</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      user:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: www</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        uid: <span class=\"token number\">666</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        group: www</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        shell: /sbin/nologin</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        create_home: no</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    - name: <span class=\"token number\">5</span>.Init Create Directory</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        path: /data</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        owner: www</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        group: www</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        mode: <span class=\"token string\">\"0755\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    - name: <span class=\"token number\">6</span>.Started NFS Server</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        name: nfs</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    - name: Restart NFS Server</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        name: nfs</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 exports.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"/data 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\" > exports.j2</span></pre></td></tr></table></figure><p>3. 检查 playbook 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook install_nfs_server.yml --syntax-check</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook -C install_nfs_server.yml</span></pre></td></tr></table></figure><p>4. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook install_nfs_server.yml</span></pre></td></tr></table></figure><p>5. 客户端执行命令测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># showmount -e 172.16.1.7</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Export list <span class=\"token keyword\">for</span> <span class=\"token number\">172.16</span>.1.7:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/data <span class=\"token number\">172.16</span>.1.0/24</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># showmount -e 172.16.1.8</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Export list <span class=\"token keyword\">for</span> <span class=\"token number\">172.16</span>.1.8:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>/data <span class=\"token number\">172.16</span>.1.0/24</pre></td></tr></table></figure><h5 id=\"22-ansible部署rsync示例\"><a class=\"anchor\" href=\"#22-ansible部署rsync示例\">#</a> 2.2 Ansible 部署 Rsync 示例</h5>\n<h6 id=\"221-ansible部署rsync服务端\"><a class=\"anchor\" href=\"#221-ansible部署rsync服务端\">#</a> 2.2.1 Ansible 部署 Rsync 服务端</h6>\n<p>1. 编写安装配置 Rsync 服务端的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat install_rsync_server.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Installed Rsync Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: <span class=\"token function\">rsync</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: Configure Rsync Server</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        src: ./rsyncd.conf.j2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        dest: /etc/rsyncd.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      notify: Restart Rsync Server</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    - name: Create Group</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      group:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        name: www</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        gid: <span class=\"token number\">666</span>   </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    - name: Create User</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      user:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        name: www</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        uid: <span class=\"token number\">666</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        group: www</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        shell: /sbin/nologin</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        create_home: no</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    - name: Init Create Directory</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        path: /backup</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        owner: www</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        group: www</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        mode: <span class=\"token string\">\"0755\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        recurse: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    - name: Rsync Server Virtual User Passwd</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        content: <span class=\"token string\">\"rsyncbackup:talent\"</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        dest: /etc/rsync.passwd</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        mode: <span class=\"token string\">\"0600\"</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      notify: Restart Rsync Server</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    - name: Started Rsync Server</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        name: rsyncd</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    - name: Restart Rsync Server</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        name: nfs</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 exports.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat rsyncd.conf.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>uid <span class=\"token operator\">=</span> www</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gid <span class=\"token operator\">=</span> www </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>port <span class=\"token operator\">=</span> <span class=\"token number\">873</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>fake super <span class=\"token operator\">=</span> <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>use <span class=\"token function\">chroot</span> <span class=\"token operator\">=</span> no</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>max connections <span class=\"token operator\">=</span> <span class=\"token number\">200</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">timeout</span> <span class=\"token operator\">=</span> <span class=\"token number\">600</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#ignore errors</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">read</span> only <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>list <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>auth <span class=\"token function\">users</span> <span class=\"token operator\">=</span> rsync_backup</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>secrets <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /etc/rsync.passwd</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>log <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /var/log/rsyncd.log</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#####################################</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>backup<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>path <span class=\"token operator\">=</span> /backup</pre></td></tr></table></figure><p>3. 检查 playbook 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook install_rsync_server.yml --syntax-check</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook -C install_rsync_server.yml</span></pre></td></tr></table></figure><p>4. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook install_rsync_server.yml</span></pre></td></tr></table></figure><p>5. 测试 Rsync</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rsync -avz install_rsync_server.yml rsync_backup@172.16.1.7::backup</span></pre></td></tr></table></figure><h6 id=\"222-ansible部署rsync客户端\"><a class=\"anchor\" href=\"#222-ansible部署rsync客户端\">#</a> 2.2.2 Ansible 部署 Rsync 客户端</h6>\n<p>1. 编写安装配置 Rsync 客户端的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat rsync_client.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: localhost</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Create Scripts Path</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        path: /scripts</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        mode: 0755</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    - name: Push Scripts /scripts</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        src: client_push_data.sh</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        dest: /scripts/client_push_data.sh</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        mode: 0755</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    - name: Configure Contable Job</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cron:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        name: <span class=\"token string\">\"Push Backup Data Remote Rsync Server\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        minute: <span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        hour: <span class=\"token string\">\"3\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        job: <span class=\"token string\">\"/bin/bash/scripts/client_push_data.sh &amp;>/dev/null\"</span></pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 exports.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat client_push_data.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#1、定义变量</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">hostname</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">Ip</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ifconfig</span> ens192 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'NR==2&#123;print $2&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">Date</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%F<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">BackupDir</span><span class=\"token operator\">=</span>/backup/mysql</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">Dest</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;BackupDir&#125;</span>/<span class=\"token variable\">$&#123;Host&#125;</span>_<span class=\"token variable\">$&#123;Ip&#125;</span>_<span class=\"token variable\">$&#123;Date&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">FILE_NAME</span><span class=\"token operator\">=</span>mysql_backup_<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> <span class=\"token string\">'+%Y%m%d%H%M%S'</span><span class=\"token variable\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">OLDBINLOG</span><span class=\"token operator\">=</span>/var/lib/mysql/oldbinlog</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#2、创建备份目录</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-d</span> <span class=\"token variable\">$Dest</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> <span class=\"token variable\">$Dest</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#3、备份目录</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>/usr/bin/mysqldump -u<span class=\"token string\">'root'</span> -p<span class=\"token string\">'your passwd'</span> nf_flms <span class=\"token operator\">></span> <span class=\"token variable\">$Dest</span>/nf-flms_<span class=\"token variable\">$&#123;FILE_NAME&#125;</span>.sql</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-czvf</span> <span class=\"token variable\">$Dest</span>/<span class=\"token variable\">$&#123;FILE_NAME&#125;</span>.tar.gz <span class=\"token variable\">$Dest</span>/nf-flms_<span class=\"token variable\">$&#123;FILE_NAME&#125;</span>.sql</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span> <span class=\"token variable\">$Dest</span>/*<span class=\"token variable\">$&#123;FILE_NAME&#125;</span>.sql</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Your database backup successfully\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#4、校验</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>md5sum <span class=\"token variable\">$Dest</span>/* <span class=\"token operator\">></span><span class=\"token variable\">$Dest</span>/backup_check_<span class=\"token variable\">$Date</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#5、将备份目录推动到 rsync 服务端</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token assign-left variable\">Rsync_Ip</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.145</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">Rsync_user</span><span class=\"token operator\">=</span>rsync_backup</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">Rsync_Module</span><span class=\"token operator\">=</span>backup_mysql</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">RSYNC_PASSWORD</span><span class=\"token operator\">=</span>your <span class=\"token function\">passwd</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token variable\">$Dest</span> <span class=\"token variable\">$Rsync_user</span>@<span class=\"token variable\">$Rsync_Ip</span>::<span class=\"token variable\">$Rsync_Module</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">#6、删除 15 天备份目录</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token function\">find</span> <span class=\"token variable\">$Dest</span> <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-mtime</span> +15 <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"remove file  successfully\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/etc_backup.sh</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>00 03 * * * /bin/bash /scripts/mysql_backup.sh <span class=\"token operator\">&amp;></span> /dev/null</pre></td></tr></table></figure><p>3. 检查 playbook 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook rsync_client.yml --syntax-check</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook -C rsync_client.yml</span></pre></td></tr></table></figure><p>4. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook rsync_client.yml</span></pre></td></tr></table></figure><p>5. 测试 Rsync</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -l</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#Ansible: Push Backup Data Remote Rsync Server</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">0</span> <span class=\"token number\">3</span> * * * /bin/bash/scripts/client_push_data.sh <span class=\"token operator\">&amp;></span>/dev/null</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /scripts/client_push_data.sh </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>-rwxr-xr-x <span class=\"token number\">1</span> root root <span class=\"token number\">1185</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">22</span>:29 /scripts/client_push_data.sh</pre></td></tr></table></figure><h5 id=\"23-playbook部署集群架构\"><a class=\"anchor\" href=\"#23-playbook部署集群架构\">#</a> 2.3 Playbook 部署集群架构</h5>\n<h6 id=\"231-项目需求及规划\"><a class=\"anchor\" href=\"#231-项目需求及规划\">#</a> <strong>2.3.1</strong> <strong>项目需求及规划</strong></h6>\n<ul>\n<li>1. 使用多台节点部署 phpmyadmin</li>\n<li>2. 使用 Nginx 作为负载均衡统一调度</li>\n<li>3. 使用 Redis 实现多台节点会话保持</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Qe0uedl.jpeg\" alt=\"Snipaste_2025-10-26_14-52-41.jpg\" /></p>\n<h6 id=\"232-项目环境准备\"><a class=\"anchor\" href=\"#232-项目环境准备\">#</a> 2.3.2 项目环境准备</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 免密登录</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-keygen </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.41</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.7</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.8</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.6</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.5</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2.Ansibel 配置文件</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir web_cluster</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir files</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp /etc/ansible/ansible.cfg ./</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp /etc/ansible/hosts ./</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#3. 主机清单</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat hosts </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">172.16</span>.1.7</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token number\">172.16</span>.1.8</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>dbservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token number\">172.16</span>.1.41</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>lbservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token number\">172.16</span>.1.5</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token number\">172.16</span>.1.6</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#4. 测试连通性</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible all -m ping</span></pre></td></tr></table></figure><h6 id=\"233-ansible部署rides服务\"><a class=\"anchor\" href=\"#233-ansible部署rides服务\">#</a> 2.3.3 Ansible 部署 Rides 服务</h6>\n<p>1. 编写安装配置 redis 服务的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat redis_server.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: dbservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Installed Redis Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: Configure Redis Server</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        src: ./files/redis.conf.j2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        dest: /etc/redis.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        owner: redis</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        mode: 0640</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      notify: Restart Redis Server</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - name: Systemd Redis Server</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    - name: Restart Redis Server</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        name: redis</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 依赖的 redis.conf.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp /etc/redis.conf /root/web_cluster/files/redis.conf.j2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager files<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"/^bind 127.0.0.1/c bind 127.0.0.1 192.168.40.41\" redis.conf.j2</span></pre></td></tr></table></figure><p>3. 检查 playbook 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook redis_server.yml --syntax-check</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook -C redis_server.yml</span></pre></td></tr></table></figure><p>4. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook redis_server.yml</span></pre></td></tr></table></figure><p>5. 客户端执行命令测试</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -h 192.168.40.41</span></pre></td></tr></table></figure><h6 id=\"234-ansible部署nginxphp服务\"><a class=\"anchor\" href=\"#234-ansible部署nginxphp服务\">#</a> 2.3.4 Ansible 部署 Nginx+PHP 服务</h6>\n<p>1. 编写安装配置 Nginx_Php 服务的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Nginx_Php_server.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Installed Nginx Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: Installed PHP Server</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        name: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      vars:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        pack:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          - php71w-fpm</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          - php71w-gd</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - php71w-mbstring</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          - php71w-mcrypt</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          - php71w-mysqlnd</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          - php71w-opcache</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - php71w-pdo</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          - php71w-pear</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          - php71w-pecl-igbinary</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          - php71w-pecl-memcached</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          - mod_php71w</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          - php71w-pecl-mongodb</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          - php71w-pecl-redis</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          - php71w-cli</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - php71w-process</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          - php71w-common</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          - php71w-xml</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          - php71w-devel</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          - php71w-embedded</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    - name: Configure Nginx Server</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        src: ./files/nginx.conf.j2</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        dest: /etc/nginx/nginx.conf</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        mode: 0644</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    - name: Create Group</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      group:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        name: www</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        gid: <span class=\"token number\">666</span>   </pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    - name: Create User</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      user:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        name: www</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        uid: <span class=\"token number\">666</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        group: www</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        shell: /sbin/nologin</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        create_home: no</pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    - name: Started Nginx Server</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\"># PHP</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    - name: Configure PHP Server php.ini</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        src: ./files/php.ini.j2</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        dest: /etc/php.ini</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        mode: 0644</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      notify: Restart PHP Server</pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    - name: Configure PHP Server php-fpm.d/www.conf </pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        src: ./files/www.conf.j2</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        dest: /etc/php-fpm.d/www.conf</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        mode: 0644</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      notify: Restart PHP Server</pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    - name: Systemd PHP Server</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        name: php-fpm</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token comment\"># Code</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    - name: Copy Nginx Virtual Site</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        src: ./files/ansible.hmallleasing.com.conf.j2</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        dest: /etc/nginx/conf.d/ansible.hmallleasing.com.conf</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        mode: 0644</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    - name: Create Ansible Directory</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        path: /ansible/</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        owner: www</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        group: www</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        mode: <span class=\"token string\">\"0755\"</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        recurse: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    - name: Unarchive PHP Code</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      unarchive:</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        src: files/phpMyAdmin-4.8.4-all-languages.zip </pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        dest: /ansible</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        creates: /ansible/phpMyAdmin-4.8.4-all-languages.zip/config.inc.php</pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    - name: Create Link</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        src: /ansible/phpMyAdmin-4.8.4-all-languages/</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        dest: /ansible/phpmyadmin</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        state: <span class=\"token function\">link</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    - name: Change phpmyadmin Configure</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        src: ./files/config.inc.php.j2</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        dest: /ansible/phpmyadmin/config.inc.php</pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    - name: Restart Nginx Server</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        state: restarted</pre></td></tr><tr><td data-num=\"128\"></td><td><pre></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    - name: Restart PHP Server</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        name: php-fpm</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 中 Nginx 依赖的 nginx.conf.j2、ansible.hmallleasing.com.conf.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置文件 nginx.conf.j2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp root@172.16.1.7:/etc/nginx/nginx.conf ./files/nginx.conf.j2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ./files/nginx.conf.j2 </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>user www<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>worker_processes  auto<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>error_log  /var/log/nginx/error.log notice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pid        /var/run/nginx.pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>events <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    worker_connections  <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    include       /etc/nginx/mime.types<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    default_type  application/octet-stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    log_format  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    access_log  /var/log/nginx/access.log  main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    sendfile        on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">#tcp_nopush     on;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    keepalive_timeout  <span class=\"token number\">65</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">#gzip  on;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    include /etc/nginx/conf.d/*.conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">#2. 配置文件 ansible.hmallleasing.com.conf.j2</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat files/ansible.hmallleasing.com.conf.j2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tserver_name ansible.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\troot /ansible/phpmyadmin<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\tfastcgi_pass <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\tfastcgi_param SCRIPT_FILENAME  <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\">#\t\tfastcgi_param HTTPS on;    #支持前端用 https, 后端用 http</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\tinclude\tfastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3. 准备 playbook 中 PHP 依赖的 php.ini.j2、www .conf.j2 配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp root@172.16.1.7:/etc/php.ini ./files/php.ini.j2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp root@172.16.1.7:/etc/php-fpm.d/www.conf ./files/www.conf.j2</span></pre></td></tr></table></figure><p>4、准备业务代码 phpMyAdmin</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager files<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://files.phpmyadmin.net/phpMyAdmin/4.8.4/phpMyAdmin-4.8.4-all-languages.zip</span></pre></td></tr></table></figure><p>5、准备 phpMyAdmin 连接数据库配置文件 config.inc.php.j2</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager files<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv config.inc.php config.inc.php.j2</span></pre></td></tr></table></figure><p>6. 检查 playbook 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook Nginx_Php_server.yml --syntax-check</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook -C Nginx_Php_server.yml</span></pre></td></tr></table></figure><p>7. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook Nginx_Php_server.yml</span></pre></td></tr></table></figure><p>8. 访问测试</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Nh263Rk.jpeg\" alt=\"1.jpg\" /></p>\n<h6 id=\"235-ansible部署nginx负载均衡\"><a class=\"anchor\" href=\"#235-ansible部署nginx负载均衡\">#</a> 2.3.5 Ansible 部署 Nginx 负载均衡</h6>\n<p>1. 编写安装配置 Nginx 负载均衡的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx_server_lb_http.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: lbservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Installed Nginx Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: nginx </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: Configure Nginx Server nginx.conf</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        src: ./files/nginx_lb.conf.j2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        dest: /etc/nginx/nginx.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    - name: Configure conf.d/proxy.conf </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        src: ./files/proxy_ansible.hmallleasing.com.conf.j2</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        dest: /etc/nginx/conf.d/proxy_ansible.hmallleasing.com.conf</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    - name: Started Nginx Server</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    - name: Restart Nginx Server</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 中 Nginx 依赖的 nginx_lb.conf.j2、proxy_ansible.hmallleasing.com.conf.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置文件 nginx_lb.conf.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat files/nginx_lb.conf.j2 </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>user  nginx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>worker_processes  auto<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>error_log  /var/log/nginx/error.log notice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>pid        /var/run/nginx.pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>events <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    worker_connections  <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    include       /etc/nginx/mime.types<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    default_type  application/octet-stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    log_format  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    access_log  /var/log/nginx/access.log  main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    sendfile        on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">#tcp_nopush     on;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    keepalive_timeout  <span class=\"token number\">65</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">#gzip  on;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    include /etc/nginx/conf.d/*.conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#2. 配置文件 proxy_ansible.hmallleasing.com.conf.j2</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat files/proxy_ansible.hmallleasing.com.conf.j2 </span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>upstream ansible <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tserver_name ansible.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tproxy_pass http://ansible<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\tproxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3. 检查 playbook 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook nginx_server_lb_http.yml --syntax-check</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook -C nginx_server_lb_http.yml</span></pre></td></tr></table></figure><p>4. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook nginx_server_lb_http.yml</span></pre></td></tr></table></figure><p>5. 访问测试</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/fqZIYtf.jpeg\" alt=\"Snipaste_2025-10-26_21-12-17.jpg\" /></p>\n<h6 id=\"236-升级nginx协议为https\"><a class=\"anchor\" href=\"#236-升级nginx协议为https\">#</a> 2.3.6 升级 Nginx 协议为 Https</h6>\n<p>1. 编写安装配置 Nginx 负载均衡的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx_server_lb_https.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: lbservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Installed Nginx Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        name: nginx </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        state: present</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - name: Configure Nginx Server  nginx.conf</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        src: ./files/nginx_lb.conf.j2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        dest: /etc/nginx/nginx.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    - name: Create TLS Directory</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      file:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        path: /ssl</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        state: directory</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        mode: 0755</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    - name: Unarchive TLS Certificate File</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      unarchive:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        src: ./files/SSLKEY.zip</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        dest: /ssl</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        creates: /ssl/SSLKEYhmallleasing.com.key</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        creates: /ssl/SSLKEYhmallleasing.com.pem</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    - name: Configure conf.d/proxy.conf </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        src:  ./files/proxy_ansible.hmallleasing.com.https.conf.j2</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        dest: /etc/nginx/conf.d/proxy_ansible.hmallleasing.com.conf</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      notify: Restart Nginx Server</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    - name: Started Nginx Server</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    - name: Restart Nginx Server</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 中 Nginx 依赖的 nginx_lb.conf.j2、proxy_ansible.hmallleasing.com.https.conf.j2 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat files/proxy_ansible.hmallleasing.com.https.conf.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream ansible_https <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name ansible.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$http_host</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tlisten <span class=\"token number\">443</span> ssl http2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tserver_name ansible.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tssl_certificate /ssl/SSLKEY/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tssl_certificate_key /ssl/SSLKEY/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tproxy_pass http://ansible_https<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tproxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3. 准备 playbook 中 Nginx 依赖的 SSL 证书</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll files/SSLKEY.zip </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">4993</span> Oct <span class=\"token number\">26</span> <span class=\"token number\">21</span>:20 files/SSLKEY.zip</pre></td></tr></table></figure><p>4. 检查 playbook 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\">#  ansible-playbook nginx_server_lb_https.yml --syntax-check</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\">#  ansible-playbook -C nginx_server_lb_https.yml</span></pre></td></tr></table></figure><p>5. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook nginx_server_lb_https.yml</span></pre></td></tr></table></figure><p>6. 访问测试</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/aQSIWwF.jpeg\" alt=\"Snipaste_2025-10-26_21-37-14.jpg\" /></p>\n<h6 id=\"237-替换nginx为haproxy\"><a class=\"anchor\" href=\"#237-替换nginx为haproxy\">#</a> 2.3.7 替换 Nginx 为 Haproxy</h6>\n<p>1. 编写安装配置 Haproxy 负载均衡的 playbook 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat haproxy_server_http.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: lbservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - name: Unarchive /tmp Directory</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      unarchive:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        src: haproxy_cfg/haproxy22.rpm.tar.gz</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        dest: /tmp</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        creates: /tmp/haproxy</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - name: Installed Haproxy</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      yum:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        name: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      vars:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        pack:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          - /tmp/haproxy/haproxy22-2.2.9-3.el7.ius.x86_64.rpm</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - /tmp/haproxy/lua53u-5.3.4-1.ius.el7.x86_64.rpm</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          - /tmp/haproxy/lua53u-devel-5.3.4-1.ius.el7.x86_64.rpm</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          - /tmp/haproxy/lua53u-libs-5.3.4-1.ius.el7.x86_64.rpm</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          - /tmp/haproxy/lua53u-static-5.3.4-1.ius.el7.x86_64.rpm</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        remote_src: no</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    - name: Configure Haproxy Server</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      copy:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        src: ./haproxy_cfg/haproxy_http.cfg.j2</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        dest: /etc/haproxy/haproxy.cfg</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        owner: root</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        group: root</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        mode: 0644</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      notify: Restart Haproxy Server</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    - name: Started Haproxy Server</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        name: haproxy</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        state: started</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  handlers:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    - name: Restart Haproxy Server</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      systemd:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        name: haproxy</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        state: restarted</pre></td></tr></table></figure><p>2. 准备 playbook 中 haproxy 配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat haproxy_cfg/haproxy_http.cfg.j2 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># Global settings</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>global</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    log         <span class=\"token number\">127.0</span>.0.1 local2</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">chroot</span>      /var/lib/haproxy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    pidfile     /var/run/haproxy.pid</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    maxconn     <span class=\"token number\">4000</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    user        haproxy</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    group       haproxy</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    daemon</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\"># turn on stats unix socket</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    stats socket /var/lib/haproxy/stats level admin</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">#nbproc 4</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tnbthread <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    cpu-map <span class=\"token number\">1</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    cpu-map <span class=\"token number\">2</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    cpu-map <span class=\"token number\">3</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    cpu-map <span class=\"token number\">4</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>defaults</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    mode                    http</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    log                     global</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    option                  httplog</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    option                  dontlognull</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    option http-server-close</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    option forwardfor       except <span class=\"token number\">127.0</span>.0.0/8</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    option                  redispatch</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    retries                 <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token function\">timeout</span> http-request    10s</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token function\">timeout</span> queue           1m</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token function\">timeout</span> connect         10s</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">timeout</span> client          1m</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token function\">timeout</span> server          1m</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token function\">timeout</span> http-keep-alive 10s</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token function\">timeout</span> check           10s</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    maxconn                 <span class=\"token number\">3000</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">#---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># main frontend which proxys to the backends</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#---------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>frontend web</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token builtin class-name\">bind</span> *:8080</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tmode http</pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\tacl ansible_domain hdr_reg<span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">)</span> <span class=\"token parameter variable\">-i</span> ansible.oldxu.net</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\tuse_backend ansible_cluster <span class=\"token keyword\">if</span> ansible_domain</pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>backend ansible_cluster</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\tbalance roundrobin</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\toption httpchk HEAD / HTTP/1.1<span class=\"token punctuation\">\\</span>r<span class=\"token punctuation\">\\</span>nHost:<span class=\"token punctuation\">\\</span> ansible.oldxu.net</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.7 <span class=\"token number\">172.16</span>.1.7:80 check port <span class=\"token number\">80</span> inter 3s rise <span class=\"token number\">2</span> fall <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.8 <span class=\"token number\">172.16</span>.1.8:80 check port <span class=\"token number\">80</span> inter 3s rise <span class=\"token number\">2</span> fall <span class=\"token number\">3</span></pre></td></tr></table></figure><p>3. 准备 playbook 中 haproxy 安装包</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll haproxy_cfg/haproxy22.rpm.tar.gz </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">2344836</span> Oct <span class=\"token number\">26</span> <span class=\"token number\">22</span>:07 haproxy_cfg/haproxy22.rpm.tar.gz</pre></td></tr></table></figure><p>4. 检查 playbook 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\">#  ansible-playbook haproxy_server_http.yml  --syntax-check</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\">#  ansible-playbook -C haproxy_server_http.yml</span></pre></td></tr></table></figure><p>5. 执行 playbook</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager web_cluster<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook haproxy_server_http.yml</span></pre></td></tr></table></figure>",
            "tags": [
                "Ansible"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2794181051.html",
            "url": "http://ixuyong.cn/posts/2794181051.html",
            "title": "Ansible快速入门",
            "date_published": "2025-10-25T12:13:11.000Z",
            "content_html": "<h4 id=\"1ansible快速入门\"><a class=\"anchor\" href=\"#1ansible快速入门\">#</a> <strong>1.Ansible</strong> 快速入门</h4>\n<h5 id=\"11-什么是ansible\"><a class=\"anchor\" href=\"#11-什么是ansible\">#</a> <strong>1.1</strong> <strong>什么是</strong> Ansible</h5>\n<p>Ansible 是一个 IT 自动化的配置管理工具，自动化主要体现在 Ansible 集成了丰富模块，以及强大的功能组件，可以通过一个命令行完成一系列的操作。进而能减少我们重复性的工作，以提高工作的效率。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/nc8kngg.png\" alt=\"\" /></p>\n<h5 id=\"12-ansible主要功能\"><a class=\"anchor\" href=\"#12-ansible主要功能\">#</a> <strong>1.2 Ansible</strong> 主要功能</h5>\n<ul>\n<li>批量执行远程命令，可以对 N 多台主机同时进行命令的执行。</li>\n<li>批量配置软件服务，可以进行自动化的方式配置和管理服务。</li>\n<li>实现软件开发功能， jumpserver 底层使用 ansible 来实现的自动化管理。</li>\n<li>编排高级的 IT 任务， Ansible 的 Playbook 是一门编程语言，可以用来描绘一套 IT 架构。</li>\n</ul>\n<h5 id=\"13-ansible的特点\"><a class=\"anchor\" href=\"#13-ansible的特点\">#</a> <strong>1.3 Ansible</strong> 的特点</h5>\n<ul>\n<li>容易学习：无代理，不像 salt 既要学客户端与服务端，还需要学习客户端与服务端中间通讯协议；</li>\n<li>操作灵活： Ansible 有较多的模块，提供了丰富的功能、playbook 则提供类似于编程语言的复杂功能；</li>\n<li>简单易用：体现在 Ansible 一个命令可以完成很多事情；</li>\n<li>安全可靠：因为 Ansible 使用了 SSH 协议进行通讯，既稳定也安全；</li>\n<li>移植性高：可以将写好的 playbook 拷贝至任意机器进行执行；</li>\n<li>幂等性：一个任务执行 1 遍和执行 n 遍效果一样，不会因为重复执行带来意外情况；</li>\n</ul>\n<h5 id=\"14-ansible基础架构\"><a class=\"anchor\" href=\"#14-ansible基础架构\">#</a> <strong>1.4 Ansible</strong> 基础架构</h5>\n<p>Ansible 架构中的控制节点、被控制节点、 inventroy、ad-hoc、playbook、Connection Protocol 是什么？</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/P3IN0Ko.png\" alt=\"\" /></p>\n<h4 id=\"2ansible安装与配置\"><a class=\"anchor\" href=\"#2ansible安装与配置\">#</a> <strong>2.Ansible</strong> 安装与配置</h4>\n<h5 id=\"21-rpm安装\"><a class=\"anchor\" href=\"#21-rpm安装\">#</a> <strong>2.1 rpm</strong> 安装</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 下载 epel 源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install ansible -y</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#2. 查看版本</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible --version</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#3. 测试是否可用</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible localhost -m ping</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>localhost <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"22-pip安装\"><a class=\"anchor\" href=\"#22-pip安装\">#</a> <strong>2.2 pip</strong> 安装</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.pip 安装</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install python3 python3-devel python3-pip -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pip3 install --upgrade pip -i https://pypi.douban.com/simple/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pip3 install ansible -i https://pypi.douban.com/simple/</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># /usr/local/bin/ansible --version</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#2. 查看版本</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible --version</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#3. 测试是否可用</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible localhost -m ping</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>localhost <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"3ansible配置\"><a class=\"anchor\" href=\"#3ansible配置\">#</a> <strong>3.Ansible</strong> 配置</h4>\n<h5 id=\"31-ansible配置路径\"><a class=\"anchor\" href=\"#31-ansible配置路径\">#</a> <strong>3.1 Ansible</strong> 配置路径</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qc ansible</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/etc/ansible/ansible.cfg   <span class=\"token comment\">#主配置文件，配置 ansible 工作特性</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/etc/ansible/hosts         <span class=\"token comment\">#配置主机清单文件</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/etc/ansible/roles/        <span class=\"token comment\">#存放 ansible 角色的目录</span></pre></td></tr></table></figure><h5 id=\"32-ansible主配置文件\"><a class=\"anchor\" href=\"#32-ansible主配置文件\">#</a> <strong>3.2 Ansible</strong> 主配置文件</h5>\n<p>ansible 的主配置文件存在 /etc/anible/ansible.cfg ，其中大部分的配置内容无需进行修改；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#inventory      = /etc/ansible/hosts\t\t\t\t\t\t\t# 主机列表配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#inventory      = ./hosts\t\t\t\t\t\t\t\t\t\t# 路径重新定义</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#library        = /usr/share/my_modules/                        #库文件存放目录</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#module_utils   = /usr/share/my_module_utils/                   #模块件存放目录</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#remote_tmp     = ~/.ansible/tmp                                #临时 py 文件存放在远程主机目录</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#local_tmp      = ~/.ansible/tmp                                #本机的临时执行目录</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#plugin_filters_cfg = /etc/ansible/plugin_filters.yml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#forks          = 5\t\t\t\t\t\t\t\t\t\t\t\t# 默认并发数\t\t\t\t</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#roles_path    = /etc/ansible/roles                             #角色存储路径</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#sudo_user      = root                                          #默认 sudo 用户</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#ask_sudo_pass = True                                           #每次执行是否询问 sudo 的 ssh 密码</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#ask_pass      = True                                           #每次执行是否询问 ssh 密码</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#remote_port    = 22                                            #远程主机端口</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#host_key_checking = False                                      #检查对应服务器的 host_key，建议取消</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#log_path = /var/log/ansible.log                                #ansible 日志，建议启用</span></pre></td></tr></table></figure><h5 id=\"33-ansible配置优先级\"><a class=\"anchor\" href=\"#33-ansible配置优先级\">#</a> <strong>3.3 Ansible</strong> 配置优先级</h5>\n<p>Ansible 的配置文件可以存放在任何位置，但配置文件有读取顺序，查找顺序如下：</p>\n<ul>\n<li>1、最先查找 $ANSIBLE_CONFIG 变量</li>\n<li>2、其次查找当前目录下 ansible.cfg</li>\n<li>3、然后查找用户家目录下的 .ansible.cfg</li>\n<li>4、最后查找 /etc/ansible/ansible.cfg</li>\n</ul>\n<p>通过命令行操作演示，验证结论:</p>\n<p>第一步读取：ANSIBLE_CONFIG</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># export ANSIBLE_CONFIG=/tmp/ansible.cfg</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch /tmp/ansible.cfg</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible --version</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible --version</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ansible <span class=\"token number\">2.9</span>.27</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  config <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /tmp/ansible.cfg</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unset ANSIBLE_CONFIG\t\t\t# 取消</span></pre></td></tr></table></figure><p>第二步读取：当前项目目录下的 ansible.cfg</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir project1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd project1/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project1<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch ansible.cfg</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project1<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible --version</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ansible <span class=\"token number\">2.9</span>.27</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  config <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /root/project1/ansible.cfg</pre></td></tr></table></figure><p>第三步读取：当前用户家目录下的 .ansible.cfg</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch ~/.ansible.cfg</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible --version</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ansible <span class=\"token number\">2.9</span>.27</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  config <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /root/.ansible.cfg</pre></td></tr></table></figure><p>第四步读取: /etc/ansible/ansible.cfg</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project1<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -f ~/.ansible.cfg</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible --version</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ansible <span class=\"token number\">2.9</span>.27</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  config <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /etc/ansible/ansible.cfg</pre></td></tr></table></figure><h4 id=\"4ansible-inventory\"><a class=\"anchor\" href=\"#4ansible-inventory\">#</a> <strong>4.Ansible Inventory</strong></h4>\n<h5 id=\"41-inventory是什么\"><a class=\"anchor\" href=\"#41-inventory是什么\">#</a> <strong>4.1 Inventory</strong> 是什么</h5>\n<ul>\n<li>Inventory 文件主要用来填写被管理主机以及主机组信息；</li>\n<li>默认 Inventory 文件为 /etc/ansible/hosts ；</li>\n<li>当然也可以自定义一个文件，当执行 ansible 命令时使用 -i 选项指定 Inventory 文件位置；</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/ansible/hosts </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">172.16</span>.1.7</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">172.16</span>.1.8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">172.16</span>.1.9</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>dbservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">172.16</span>.1.51\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">172.16</span>.1.41\t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>db<span class=\"token punctuation\">[</span>01:08<span class=\"token punctuation\">]</span>.ixuyong.cn</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>testservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>test<span class=\"token punctuation\">[</span>01:99<span class=\"token punctuation\">]</span>-node.ixuyong.cn</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible dbservers --list-hosts </span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  hosts <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token number\">172.16</span>.1.51</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token number\">172.16</span>.1.41</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    db01.ixuyong.cn</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    db02.ixuyong.cn</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    db03.ixuyong.cn</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    db04.ixuyong.cn</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    db05.ixuyong.cn</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    db06.ixuyong.cn</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    db07.ixuyong.cn</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    db08.ixuyong.cn</pre></td></tr></table></figure><h5 id=\"42-inventory密码连接方式\"><a class=\"anchor\" href=\"#42-inventory密码连接方式\">#</a> <strong>4.2 Inventory</strong> 密码连接方式</h5>\n<p>1. 指定主机 IP，指定主机端口，指定主机用户名、密码；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/ansible/hosts </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">172.16</span>.1.7 <span class=\"token assign-left variable\">ansible_ssh_port</span><span class=\"token operator\">=</span><span class=\"token number\">22</span> <span class=\"token assign-left variable\">ansible_ssh_user</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">ansible_ssh_pass</span><span class=\"token operator\">=</span><span class=\"token string\">'talent'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">172.16</span>.1.8 <span class=\"token assign-left variable\">ansible_ssh_port</span><span class=\"token operator\">=</span><span class=\"token number\">22</span> <span class=\"token assign-left variable\">ansible_ssh_user</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">ansible_ssh_pass</span><span class=\"token operator\">=</span><span class=\"token string\">'talent'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>dbservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">172.16</span>.1.51 <span class=\"token assign-left variable\">ansible_ssh_port</span><span class=\"token operator\">=</span><span class=\"token number\">22</span> <span class=\"token assign-left variable\">ansible_ssh_user</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">ansible_ssh_pass</span><span class=\"token operator\">=</span><span class=\"token string\">'talent'</span>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">172.16</span>.1.41 <span class=\"token assign-left variable\">ansible_ssh_port</span><span class=\"token operator\">=</span><span class=\"token number\">22</span> <span class=\"token assign-left variable\">ansible_ssh_user</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">ansible_ssh_pass</span><span class=\"token operator\">=</span><span class=\"token string\">'talent'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m ping</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">172.16</span>.1.7 <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token string\">\"ansible_facts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"discovered_interpreter_python\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/usr/bin/python\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>, </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">172.16</span>.1.8 <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token string\">\"ansible_facts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token string\">\"discovered_interpreter_python\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/usr/bin/python\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>, </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2. 通过变量方式定义密码；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/ansible/hosts </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">172.16</span>.1.7 <span class=\"token assign-left variable\">ansible_ssh_port</span><span class=\"token operator\">=</span><span class=\"token number\">22</span> <span class=\"token assign-left variable\">ansible_ssh_user</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">ansible_ssh_pass</span><span class=\"token operator\">=</span><span class=\"token string\">'talent'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">172.16</span>.1.8 <span class=\"token assign-left variable\">ansible_ssh_port</span><span class=\"token operator\">=</span><span class=\"token number\">22</span> <span class=\"token assign-left variable\">ansible_ssh_user</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">ansible_ssh_pass</span><span class=\"token operator\">=</span><span class=\"token string\">'talent'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>dbservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">172.16</span>.1.51</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">172.16</span>.1.41</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>dbservers:vars<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">ansible_ssh_port</span><span class=\"token operator\">=</span><span class=\"token number\">22</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">ansible_ssh_user</span><span class=\"token operator\">=</span>root</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">ansible_ssh_pass</span><span class=\"token operator\">=</span><span class=\"token string\">'talent'</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible dbservers -m ping</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">172.16</span>.1.41 <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token string\">\"ansible_facts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token string\">\"discovered_interpreter_python\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/usr/bin/python\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>, </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token number\">172.16</span>.1.51 <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token string\">\"ansible_facts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token string\">\"discovered_interpreter_python\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/usr/bin/python\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>, </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"43-inventory秘钥连接方式\"><a class=\"anchor\" href=\"#43-inventory秘钥连接方式\">#</a> 4.3 Inventory 秘钥连接方式</h5>\n<p>1. 创建秘钥对，然后下发秘钥；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-keygen </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.7</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.8</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.41</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.51</span></pre></td></tr></table></figure><p>2. 测试连通性</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/ansible/hosts </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>webservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">172.16</span>.1.7</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">172.16</span>.1.8</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>dbservers<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">172.16</span>.1.51</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">172.16</span>.1.41</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible all -m ping</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">172.16</span>.1.41 <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token string\">\"ansible_facts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"discovered_interpreter_python\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/usr/bin/python\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>, </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">172.16</span>.1.7 <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token string\">\"ansible_facts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token string\">\"discovered_interpreter_python\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/usr/bin/python\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>, </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token number\">172.16</span>.1.51 <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token string\">\"ansible_facts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token string\">\"discovered_interpreter_python\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/usr/bin/python\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>, </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token number\">172.16</span>.1.8 <span class=\"token operator\">|</span> SUCCESS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token string\">\"ansible_facts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token string\">\"discovered_interpreter_python\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/usr/bin/python\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>, </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token string\">\"changed\"</span><span class=\"token builtin class-name\">:</span> false, </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token string\">\"ping\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pong\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"44-inventory主机匹配方式\"><a class=\"anchor\" href=\"#44-inventory主机匹配方式\">#</a> 4.4 Inventory 主机匹配方式</h5>\n<p>ansible 的 host-pattern 主机匹配使用说明；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 指定操作所有的组</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ansible all <span class=\"token parameter variable\">-m</span> <span class=\"token function\">ping</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 通配符</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ansible <span class=\"token string\">\"*\"</span> <span class=\"token parameter variable\">-m</span> <span class=\"token function\">ping</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ansible web* <span class=\"token parameter variable\">-m</span> <span class=\"token function\">ping</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#3. 与：在 webservers 组；并且在 dbsservers 中的主机；</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ansible <span class=\"token string\">\"webservers:&amp;dbservers\"</span> <span class=\"token parameter variable\">-m</span> <span class=\"token function\">ping</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#4. 或：在 webservers 组，或者在 appservers 中的主机；</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ansible <span class=\"token string\">\"webservers:appservers\"</span> <span class=\"token parameter variable\">-m</span> <span class=\"token function\">ping</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#5. 非：在 webservers 组，但不在 apps 组中的主机</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ansible <span class=\"token string\">'webservers:!apps'</span> <span class=\"token parameter variable\">-m</span> <span class=\"token function\">ping</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#6. 正则表达式；</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ansible <span class=\"token string\">\"~(web|db).*\\.oldxu\\.com\"</span> <span class=\"token parameter variable\">-m</span> <span class=\"token function\">ping</span></pre></td></tr></table></figure><h5 id=\"45-普通用户管理被控端\"><a class=\"anchor\" href=\"#45-普通用户管理被控端\">#</a> 4.5 普通用户管理被控端</h5>\n<p>场景说明： ansible 使用 xuyong 普通用户统一管理所有的被控端节点</p>\n<p>1. 首先控制端，被控端，都需要有 olxu 用户</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd xuyong</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"talent\" | passwd --stdin xuyong</span></pre></td></tr></table></figure><p>2. 将控制端 xuyong 用户的公钥推送到被控端 xuyong 用户下，使普通用户能进行免密码登录</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># su xuyong</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>xuyong@manager root<span class=\"token punctuation\">]</span>$ ssh-keygen </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>xuyong@manager root<span class=\"token punctuation\">]</span>$ ssh-copy-id <span class=\"token parameter variable\">-i</span> ~/.ssh/id_rsa.pub xuyong@172.16.1.7</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>xuyong@manager root<span class=\"token punctuation\">]</span>$ ssh-copy-id <span class=\"token parameter variable\">-i</span> ~/.ssh/id_rsa.pub xuyong@172.16.1.8</pre></td></tr></table></figure><p>3. 所有主机的 xuyong 用户都必须添加 sudo 权限。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/sudoers</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>xuyong  <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span>       NOPASSWD: ALL</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 检查语法</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># visudo -csf /etc/sudoers</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>/etc/sudoers: parsed OK</pre></td></tr></table></figure><p>4. 修改控制端 /etc/ansible/ansible.cfg 主配置文件，配置普通用户提权</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/ansible/ansible.cfg</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>privilege_escalation<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">become</span><span class=\"token operator\">=</span>True</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">become_method</span><span class=\"token operator\">=</span>sudo</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">become_user</span><span class=\"token operator\">=</span>root</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">become_ask_pass</span><span class=\"token operator\">=</span>False</pre></td></tr></table></figure><p>5. 使用 xuyong 用户测试是否能执行任务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>xuyong@manager root<span class=\"token punctuation\">]</span>$ ansible webservers <span class=\"token parameter variable\">-m</span> shell <span class=\"token parameter variable\">-a</span> <span class=\"token string\">\"mkdir /opt/test\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>WARNING<span class=\"token punctuation\">]</span>: Consider using the <span class=\"token function\">file</span> module with <span class=\"token assign-left variable\">state</span><span class=\"token operator\">=</span>directory rather than running <span class=\"token string\">'mkdir'</span><span class=\"token builtin class-name\">.</span>  If you need to use <span class=\"token builtin class-name\">command</span> because</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">file</span> is insufficient you can <span class=\"token function\">add</span> <span class=\"token string\">'warn: false'</span> to this <span class=\"token builtin class-name\">command</span> task or <span class=\"token builtin class-name\">set</span> <span class=\"token string\">'command_warnings=False'</span> <span class=\"token keyword\">in</span> ansible.cfg to get rid of</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>this message.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">172.16</span>.1.7 <span class=\"token operator\">|</span> CHANGED <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">rc</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token operator\">>></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">172.16</span>.1.8 <span class=\"token operator\">|</span> CHANGED <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">rc</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token operator\">>></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /opt/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>drwxr-xr-x <span class=\"token number\">2</span> root root <span class=\"token number\">6</span> Oct <span class=\"token number\">22</span> <span class=\"token number\">20</span>:56 <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /opt/</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>drwxr-xr-x <span class=\"token number\">2</span> root root <span class=\"token number\">6</span> Oct <span class=\"token number\">22</span> <span class=\"token number\">20</span>:56 <span class=\"token builtin class-name\">test</span></pre></td></tr></table></figure><h4 id=\"5ansible-ad-hoc\"><a class=\"anchor\" href=\"#5ansible-ad-hoc\">#</a> 5.Ansible ad-hoc</h4>\n<h5 id=\"51-ad-hoc是什么\"><a class=\"anchor\" href=\"#51-ad-hoc是什么\">#</a> <strong>5.1 ad-hoc</strong> 是什么</h5>\n<p>ad-hoc 简而言之就是 “临时命令”，执行完即结束，并不会保存；</p>\n<ul>\n<li>应用场景 1：查看多台节点的进程是否存在；</li>\n<li>应用场景 2：拷贝指定的文件至本地；</li>\n</ul>\n<h5 id=\"52-ad-hoc命令使用\"><a class=\"anchor\" href=\"#52-ad-hoc命令使用\">#</a> <strong>5.2 ad-hoc</strong> 命令使用</h5>\n<p>命令示例： ansible 'groups' -m command -a 'df -h' ，含义如下图所示；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/lkvDn50.jpeg\" alt=\"\" /></p>\n<h5 id=\"53-ad-hoc执行过程\"><a class=\"anchor\" href=\"#53-ad-hoc执行过程\">#</a> <strong>5.3 ad-hoc</strong> 执行过程</h5>\n<ul>\n<li>1. 加载自己的配置文件，默认 /etc/ansible/ansible.cfg ；</li>\n<li>2. 查找对应的主机配置文件，找到要执行的主机或者组；</li>\n<li>3. 加载自己对应的模块文件，如 command ；</li>\n<li>4. 通过 ansible 将模块或命令生成对应的临时 py 文件，并将该文件传输至远程服务器对应执行用户 $HOME/.ansible/tmp/ansible-tmp-number/xxx.py；</li>\n<li>5. 执行用户家目录的 py 文件；</li>\n<li>6. 给文件 +x 执行；</li>\n<li>7. 执行并返回结果；</li>\n<li>8. 删除临时 py 文件， sleep 0 退出</li>\n</ul>\n<h5 id=\"54-ad-hoc执行状态\"><a class=\"anchor\" href=\"#54-ad-hoc执行状态\">#</a> <strong>5.4 ad-hoc</strong> 执行状态</h5>\n<p>使用 ad-hoc 执行一次远程命令，注意观察返回结果的颜色；</p>\n<ul>\n<li>绿色：代表被管理端主机没有被修改</li>\n<li>黄色：代表被管理端主机发现变更</li>\n<li>红色：代表出现了故障，注意查看提示</li>\n</ul>\n<h4 id=\"6ansible常用模块\"><a class=\"anchor\" href=\"#6ansible常用模块\">#</a> <strong>6.Ansible</strong> 常用模块</h4>\n<p>ansible 有着诸多的模块，虽然模块众多，但最为常用的模块也就 20-30 个左右；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-doc yum</span></pre></td></tr></table></figure><h5 id=\"61-command模块\"><a class=\"anchor\" href=\"#61-command模块\">#</a> <strong>6.1 command</strong> 模块</h5>\n<p>功能：在远程主机执行 Shell 命令；此为默认模块，可忽略 -m 选项；</p>\n<p><em>注意：shell 支持  | 管道符号，command 不支持管道命令 |</em></p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>chdir</td>\n<td>chdir /opt</td>\n<td>执行 ansible 时，切换到指定的目录</td>\n</tr>\n<tr>\n<td>creates</td>\n<td>creates /data/file</td>\n<td>如果文件存在，则跳过执行</td>\n</tr>\n<tr>\n<td>removes</td>\n<td>removes /data/file</td>\n<td>如果文件存在，则执行</td>\n</tr>\n</tbody>\n</table>\n<p>1.chdir 切换目录执行 Shell 命令；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m command -a \"creates=/tmp/log ifconfig ens192\"</span></pre></td></tr></table></figure><p>2.creates 如果 /data/file 文件存在，则不执行，如果不存在，就不执行；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m command -a 'creates=/data/file ifconfig ens192'</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>removes 如果 /data/file 文件存在，则执行；</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m command -a 'removes=/data/file ifconfig ens192'</span></pre></td></tr></table></figure><h5 id=\"62-shell模块\"><a class=\"anchor\" href=\"#62-shell模块\">#</a> <strong>6.2 shell</strong> 模块</h5>\n<p>功能：在远程主机执行 Shell 命令，执行管道等特殊符号的操作；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>chdir</td>\n<td>chdir /opt</td>\n<td>执行 ansible 时，切换到指定的目录</td>\n</tr>\n<tr>\n<td>creates</td>\n<td>creates /data/file</td>\n<td>如果文件存在，则跳过执行</td>\n</tr>\n<tr>\n<td>removes</td>\n<td>removes /data/file</td>\n<td>如果文件存在，则执行</td>\n</tr>\n</tbody>\n</table>\n<p>1. 使用 Shell 命令过滤被控端主机的 IP 地址；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m shell -a \"ifconfig ens192 | awk 'NR==2'\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">192.168</span>.1.8 <span class=\"token operator\">|</span> CHANGED <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">rc</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token operator\">>></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.8  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.1.255</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.1.7 <span class=\"token operator\">|</span> CHANGED <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">rc</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token operator\">>></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.7  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.1.255</pre></td></tr></table></figure><h5 id=\"63-yum模块\"><a class=\"anchor\" href=\"#63-yum模块\">#</a> <strong>6.3 yum</strong> 模块</h5>\n<p>功能：管理各个操作系统的软件包；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>name</td>\n<td>httpd、nginx、 ...</td>\n<td>指定安装软件包名或软件包 URL</td>\n</tr>\n<tr>\n<td>state</td>\n<td>present (安装)-(default)、absent (删除)、latest (最新版)</td>\n<td>指定 yum 对应的方法</td>\n</tr>\n<tr>\n<td>enablerepo</td>\n<td>epel、base、...</td>\n<td>允许从哪些仓库获取软件</td>\n</tr>\n<tr>\n<td>disablerepo</td>\n<td>epel、base、...</td>\n<td>禁止从哪些仓库获取软件</td>\n</tr>\n<tr>\n<td>exclude</td>\n<td>kernel、...</td>\n<td>排除某些软件包</td>\n</tr>\n<tr>\n<td>download_only</td>\n<td>yes、no</td>\n<td>仅下载软件包，不安装</td>\n</tr>\n</tbody>\n</table>\n<p>1. 安装当前最新的 Apache 软件，如果存在则不安装</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m yum -a \"name=httpd state=present\"</span></pre></td></tr></table></figure><p>2. 安装当前最新的 Apache 软件，通过 epel 仓库安装</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m yum -a \"name=httpd state=present enablerepo=epel\"</span></pre></td></tr></table></figure><p>3. 通过公网 URL 安装 rpm 软件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m yum -a \"name=https://xx.rpm state=present\"</span></pre></td></tr></table></figure><p>4. 安装最新版本的 Apache 软件，如果存在则更新 Apache</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m yum -a \"name=httpd state=latest\"</span></pre></td></tr></table></figure><p>5. 更新所有的软件包，但排除和 kernel 相关的</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m yum -a \"name=* state=latest exclude=kernel\"</span></pre></td></tr></table></figure><p>6. 删除 Apache 软件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m yum -a \"name=httpd state=absent\"</span></pre></td></tr></table></figure><h5 id=\"64-copy模块\"><a class=\"anchor\" href=\"#64-copy模块\">#</a> <strong>6.4 copy</strong> 模块</h5>\n<p>功能：从 ansible 服务端主控端复制文件到远程主机；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>src</td>\n<td></td>\n<td>复制本地目录下的文件至远程服务器</td>\n</tr>\n<tr>\n<td>dest</td>\n<td></td>\n<td>文件复制到远程的绝对路径</td>\n</tr>\n<tr>\n<td>owner</td>\n<td>root(Defaults)</td>\n<td>文件复制到远程并设定属主</td>\n</tr>\n<tr>\n<td>group</td>\n<td>root(Defaults)</td>\n<td>文件复制到远程并设定属组</td>\n</tr>\n<tr>\n<td>mode</td>\n<td>file=644，directory=755</td>\n<td>文件复制到远程并设定权限</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>yes</td>\n<td>备份被修改前的配置文件</td>\n</tr>\n<tr>\n<td>content</td>\n<td></td>\n<td>新建文件并给文件添加内容</td>\n</tr>\n</tbody>\n</table>\n<p>1. 将本地的 httpd.conf 文件 Listen 端口修改为 8080 ，推送至远程服务器</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m copy -a \"src=./httpd.conf dest=/etc/httpd/conf/httpd.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">owner</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">group</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">mode</span><span class=\"token operator\">=</span><span class=\"token number\">644</span>\"</pre></td></tr></table></figure><p>2. 将本地的 httpd.conf 文件 Listen 端口修改为 9090 ，推送至远程服务器，然后检查远端是否存在上一次的备份文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m copy -a \"src=./httpd.conf dest=/etc/httpd/conf/httpd.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">owner</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">group</span><span class=\"token operator\">=</span>root <span class=\"token assign-left variable\">mode</span><span class=\"token operator\">=</span><span class=\"token number\">644</span> <span class=\"token assign-left variable\">backup</span><span class=\"token operator\">=</span>yes\"</pre></td></tr></table></figure><p>3. 往远程的主机文件中写入内容，如果文件不存在则创建</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m copy -a 'content=\"oldxu.net123\" dest=/etc/rsync.pass owner=root group=root mode=\"0600\" backup=yes</span></pre></td></tr></table></figure><p>4. 验证 sudo 配置是否正确（adhoc 测试失败）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat sudoers.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>- hosts: webservers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tasks:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  - name: Copy a <span class=\"token string\">\"sudoers\"</span> <span class=\"token function\">file</span> on the remote machine <span class=\"token keyword\">for</span> editing</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    copy:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      src: ./sudoers</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      dest: /etc/sudoers</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      validate: /usr/sbin/visudo <span class=\"token parameter variable\">-csf</span> %s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible-playbook sudoers.yaml</span></pre></td></tr></table></figure><h5 id=\"65-systemd模块\"><a class=\"anchor\" href=\"#65-systemd模块\">#</a> <strong>6.5 systemd</strong> 模块</h5>\n<p>功能：管理服务启动与停止，与 service 模块用法一致；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>name</td>\n<td>httpd、nginx、...</td>\n<td>定义要启动服务的名称</td>\n</tr>\n<tr>\n<td>state</td>\n<td>started、stopped、restarted、reloaded</td>\n<td>指定服务状态</td>\n</tr>\n<tr>\n<td>enabled</td>\n<td>yes、no</td>\n<td>允许服务开机自启或禁止服务开机自启</td>\n</tr>\n</tbody>\n</table>\n<p>1. 启动 Httpd 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m systemd -a \"name=httpd state=started\"</span></pre></td></tr></table></figure><p>2. 重载 Httpd 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m systemd -a \"name=httpd state=reloaded\"</span></pre></td></tr></table></figure><p>3. 重启 Httpd 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m systemd -a \"name=httpd state=restarted\"</span></pre></td></tr></table></figure><p>4. 停止 Httpd 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m systemd -a \"name=httpd state==stopped\"</span></pre></td></tr></table></figure><p>5. 启动 Httpd 服务，并加入开机自启</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m systemd -a \"name=httpd state=started enabled=yes\"</span></pre></td></tr></table></figure><h5 id=\"66-file模块\"><a class=\"anchor\" href=\"#66-file模块\">#</a> <strong>6.6 file</strong> 模块</h5>\n<p>功能：为被控端创建文件或目录，设定权限属性；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path</td>\n<td></td>\n<td>指定远程服务器的路径</td>\n</tr>\n<tr>\n<td>recurse</td>\n<td></td>\n<td>递归方式 (可以是递归授权)</td>\n</tr>\n<tr>\n<td>state</td>\n<td>touch、directory、link、absent</td>\n<td>类型</td>\n</tr>\n<tr>\n<td>owner</td>\n<td>root(Defaults)</td>\n<td>文件复制到远程并设定属主</td>\n</tr>\n<tr>\n<td>group</td>\n<td>root(Defaults)</td>\n<td>文件复制到远程并设定属组</td>\n</tr>\n<tr>\n<td>mode</td>\n<td>file=644，directory=755</td>\n<td>文件复制到远程并设定权限</td>\n</tr>\n</tbody>\n</table>\n<p>1. 创建一个 /data 目录，授权为 www 身份，递归授权目录</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m file -a 'path=/data owner=www group=www mode=\"0755\" state=directory recurse=yes'</span></pre></td></tr></table></figure><p>2. 在 /data 目录中创建一个文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m file -a 'path=/data/books owner=www group=www mode=\"0644\" state=touch'</span></pre></td></tr></table></figure><h5 id=\"67-group模块\"><a class=\"anchor\" href=\"#67-group模块\">#</a> <strong>6.7 group</strong> 模块</h5>\n<p>功能：管理被控端用户组；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>name</td>\n<td></td>\n<td>指定创建的组名</td>\n</tr>\n<tr>\n<td>gid</td>\n<td></td>\n<td>为组设置可选 gid</td>\n</tr>\n<tr>\n<td>state</td>\n<td>present(Default)、absent</td>\n<td>是否将组创建在远程主机上</td>\n</tr>\n<tr>\n<td>system</td>\n<td>yes、no(Default)</td>\n<td>是否创建系统组</td>\n</tr>\n</tbody>\n</table>\n<p>1. 创建 www 基本组，指定 uid 为 666</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m group -a 'name=www gid=666 state=present'</span></pre></td></tr></table></figure><p>2. 创建 www 系统组</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m group -a 'name=mysqldb system=yes state=present'</span></pre></td></tr></table></figure><p>3. 删除 mysqldb 基本组</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manger ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m group -a \"name=mysqldb state=absent\"</span></pre></td></tr></table></figure><h5 id=\"68-user模块\"><a class=\"anchor\" href=\"#68-user模块\">#</a> <strong>6.8 user</strong> 模块</h5>\n<p>功能：管理被控端用户；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>name</td>\n<td></td>\n<td>创建或删除的用户名</td>\n</tr>\n<tr>\n<td>uid</td>\n<td></td>\n<td>指定 uid</td>\n</tr>\n<tr>\n<td>group</td>\n<td></td>\n<td>为用户设置指定基本组</td>\n</tr>\n<tr>\n<td>groups</td>\n<td></td>\n<td>为用户设置附加组</td>\n</tr>\n<tr>\n<td>append</td>\n<td>yes</td>\n<td>追加</td>\n</tr>\n<tr>\n<td>shell</td>\n<td>present(Default)、absent</td>\n<td>为用户设置登陆时的 Shell</td>\n</tr>\n<tr>\n<td>create_home</td>\n<td>yes(Default)、no</td>\n<td>为用户创建主目录</td>\n</tr>\n<tr>\n<td>state</td>\n<td>present(Default)、absent</td>\n<td>用户是否应该存在</td>\n</tr>\n<tr>\n<td>remove</td>\n<td>yes、no(Default)</td>\n<td>删除与用户关联的目录，只有当 state=absent 时生效</td>\n</tr>\n<tr>\n<td>generate_ssh_key</td>\n<td>yes、no(Default)</td>\n<td>为相关用户生成 ssh 密钥。不会覆盖现有的 ssh 密钥</td>\n</tr>\n<tr>\n<td>ssh_key_bits</td>\n<td>2048</td>\n<td>创建用户 ssh 密钥中位数</td>\n</tr>\n<tr>\n<td>ssh_key_file</td>\n<td>.ssh/id_rsa(Default)</td>\n<td>可以实现 ssh 密钥改名，或变更存放 ssh 密钥位置</td>\n</tr>\n<tr>\n<td>password</td>\n<td></td>\n<td>设定对应的密码，必须是加密后的字符串才行，否则不生效</td>\n</tr>\n</tbody>\n</table>\n<p>1. 创建 www 用户，指定 uid 666，基本组 www</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m user -a 'name=www uid=666 group=www shell=/sbin/nologin create_home=no'</span></pre></td></tr></table></figure><p>2. 创建 db 用户，基本组是 root，附加组，adm，sys</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m user -a 'name=db group=root groups=adm,sys append=yes shell=/bin/bash create_home=yes'</span></pre></td></tr></table></figure><p>3. 创建一个 devops 用户，密码 talent，需要正常登录系统；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m user -a 'name=devops password=$6$salt$MUVhjPhKyI2uE9sPg7185PcBQFlDwLGPbVTx.CsD6GXQbRGsUfmjsSfb9e9ej2.vLgmBI5CtgFq1plbD0a6tM. shell=/bin/bash create_home=yes'</span></pre></td></tr></table></figure><p>4. 创建一个 dev 用户，并为其生成对应的秘钥</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager project<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m user -a 'name=dev generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=~/.ssh/id_rsa'</span></pre></td></tr></table></figure><p>5. 移除 db 用户</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m user -a \"name=db remove=yes state=absent\"</span></pre></td></tr></table></figure><h5 id=\"69-mount模块\"><a class=\"anchor\" href=\"#69-mount模块\">#</a> 6.9 mount 模块</h5>\n<p>功能：管理被控端设备挂载；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>src</td>\n<td></td>\n<td>源设备的路径</td>\n</tr>\n<tr>\n<td>path</td>\n<td></td>\n<td>挂载至本地的路径</td>\n</tr>\n<tr>\n<td>fstype</td>\n<td>xfs、nfs ...</td>\n<td>文件系统类型</td>\n</tr>\n<tr>\n<td>opts</td>\n<td>ydefaults、ro ...</td>\n<td>挂载的参数</td>\n</tr>\n<tr>\n<td>state</td>\n<td>present（永久挂载，不会立即生效）、absent（卸载临时挂载 + 永久挂载）、mounted（临时挂载）、unmounted（临时卸载）</td>\n<td>挂载的状态</td>\n</tr>\n</tbody>\n</table>\n<p>1. 将 172.16.1.7 的 /data 目录挂载到  172.16.1.8 /opt 目录；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible 172.16.1.8 -m mount -a 'src=172.16.1.7:/data path=/opt fstype=nfs opts=defaults state=mounted'</span></pre></td></tr></table></figure><p>2. 临时卸载 nfs 的挂载，但不清理 /etc/fstab</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m mount -a \"src=172.16.1.61:/ops path=/opt fstype=nfs opts=defaults state=unmounted\"</span></pre></td></tr></table></figure><p>3. 永久卸载 nfs 挂载，同时清理 /etc/fstab</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m mount -a \"src=172.16.1.61:/ops path=/opt fstype=nfs opts=defaults state=absent\"</span></pre></td></tr></table></figure><h5 id=\"610-cron模块\"><a class=\"anchor\" href=\"#610-cron模块\">#</a> 6.10 cron 模块</h5>\n<p>功能：管理被控端计划任务；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>name</td>\n<td></td>\n<td>定时任务基本描述</td>\n</tr>\n<tr>\n<td>job</td>\n<td></td>\n<td>定时任务要执行的命令</td>\n</tr>\n<tr>\n<td>minute</td>\n<td>(Default)、0-59</td>\n<td>分</td>\n</tr>\n<tr>\n<td>hour</td>\n<td>(Default)、0-23</td>\n<td>时</td>\n</tr>\n<tr>\n<td>day</td>\n<td>(Default)、1-31</td>\n<td>日</td>\n</tr>\n<tr>\n<td>month</td>\n<td>(Default)、1-12</td>\n<td>月</td>\n</tr>\n<tr>\n<td>weekday</td>\n<td>(Default)、0-6</td>\n<td>周</td>\n</tr>\n</tbody>\n</table>\n<p>1. 每天凌晨 3 点执行 /bin/bash/scripts/client_push_data_server.sh &amp;&gt;/dev/null</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m cron -a 'name=\"backups app data scripts\" hour=03 minute=00 job=\"/bin/bash /scripts/client_push_data_server.sh &amp;>/dev/null\"'</span></pre></td></tr></table></figure><p>2. 添加定时任务， 每天的凌晨 2 点和凌晨 5 点执行一次 ls</p>\n<figure class=\"highlight basic\"><figcaption data-lang=\"BASIC\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[root@manager ~]# ansible webserver <span class=\"token operator\">-</span>m cron <span class=\"token operator\">-</span>a <span class=\"token string\">\"name='cron02' minute=0 hour=2,5 job='ls >/dev/null'\"</span></pre></td></tr></table></figure><p>3. 删除 backups app data script  执行；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m cron -a 'name=\"backups app data scripts\" hour=03 minute=00 job=\"/bin/bash /scripts/client_push_data_server.sh &amp;>/dev/null\" state=absent'</span></pre></td></tr></table></figure><p>4. 注释 backups app data script  执行；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m cron -a 'name=\"backups app data scripts\" hour=03 minute=00 job=\"/bin/bash /scripts/client_push_data_server.sh &amp;>/dev/null\" disabled=yes'</span></pre></td></tr></table></figure><h5 id=\"611-get_url模块\"><a class=\"anchor\" href=\"#611-get_url模块\">#</a> 6.11 get_url 模块</h5>\n<p>功能：通过互联网下载软件至被控端本地；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>url</td>\n<td>HTTP, HTTPS ...</td>\n<td>资源文件在互联网上的具体位置</td>\n</tr>\n<tr>\n<td>dest</td>\n<td></td>\n<td>文件下载位置的绝对路径</td>\n</tr>\n<tr>\n<td>mode</td>\n<td></td>\n<td>文件下载后的权限</td>\n</tr>\n<tr>\n<td>checksum</td>\n<td>md5、sha256</td>\n<td>对下载的资源进行校验</td>\n</tr>\n<tr>\n<td>timeout</td>\n<td>10(Default)</td>\n<td>URL 请求超时时间</td>\n</tr>\n</tbody>\n</table>\n<p>1. 下载一个资源到本地 /tmp 目录；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m get_url -a 'url=http://fj.ixuyong.cn/config_vpn_new.zip dest=/tmp mode=0666'</span></pre></td></tr></table></figure><p>2. 对下载的资源做验证：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># md5sum /tmp/config_vpn_new.zip</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>7107b0e2e01facb067842a6c4c7ffa31 /tmp/config_vpn_new.zip</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m get_url -a 'url=http://fj.ixuyong.cn/config_vpn_new.zip dest=/opt mode=0666 checksum=md5:7107b0e2e01facb067842a6c4c7ffa31'</span></pre></td></tr></table></figure><h5 id=\"612-archive模块\"><a class=\"anchor\" href=\"#612-archive模块\">#</a> 6.12 archive 模块</h5>\n<p>功能：打包与压缩；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path</td>\n<td></td>\n<td>要压缩的文件或目录</td>\n</tr>\n<tr>\n<td>dest</td>\n<td></td>\n<td>压缩后的文件</td>\n</tr>\n<tr>\n<td>format</td>\n<td>bz2、gz、tar、xz、zip</td>\n<td>指定打包压缩的类型</td>\n</tr>\n</tbody>\n</table>\n<p>1. 将被控端 /var/log 目录压缩为 tar 格式，并存储至 /opt 目录下；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m archive -a 'path=/var/log dest=/opt/log.tar.gz format=gz'</span></pre></td></tr></table></figure><h5 id=\"613-unarchive模块\"><a class=\"anchor\" href=\"#613-unarchive模块\">#</a> 6.13 unarchive 模块</h5>\n<p>功能：解包与解压缩；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>src</td>\n<td></td>\n<td>要解压的软件包路径</td>\n</tr>\n<tr>\n<td>dest</td>\n<td></td>\n<td>解压到目标位置</td>\n</tr>\n<tr>\n<td>remote_src</td>\n<td>yes、no(default)</td>\n<td>yes：要解压的包在被控端、no：要解压的包在控制端</td>\n</tr>\n</tbody>\n</table>\n<p>1. 解压控制端的压缩包至被控端；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m unarchive -a 'src=/root/php.zip dest=/tmp/'</span></pre></td></tr></table></figure><p>2. 解压被制端的压缩包至被控端；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m unarchive -a 'src=/log.tar.gz dest=/tmp/ remote_src=yes'</span></pre></td></tr></table></figure><h5 id=\"614-selinux模块\"><a class=\"anchor\" href=\"#614-selinux模块\">#</a> 6.14 selinux 模块</h5>\n<p>功能：管理 SELINUX 防火墙；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>state</td>\n<td>enforcing、permissive、disabled</td>\n<td>Selinux 模式</td>\n</tr>\n</tbody>\n</table>\n<p>1. 设置 selinux 为 enforcing</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m selinux -a \"state=enforcing\"</span></pre></td></tr></table></figure><p>2. 设置 selinux 为 disabled</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m selinux -a \"state=disabled\"</span></pre></td></tr></table></figure><h5 id=\"615-firewalld模块\"><a class=\"anchor\" href=\"#615-firewalld模块\">#</a> 6.15 firewalld 模块</h5>\n<p>功能：管理 firewalld 防火墙；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>service</td>\n<td>HTTP, HTTPS ...</td>\n<td>添加或删除 firewalld 中的服务名称</td>\n</tr>\n<tr>\n<td>port</td>\n<td>80、443 ...</td>\n<td>添加或删除 firewalld 中的端口范围</td>\n</tr>\n<tr>\n<td>masquerade</td>\n<td>yes、no</td>\n<td>启用或禁止防火墙的地址伪装</td>\n</tr>\n<tr>\n<td>immediate</td>\n<td>yes、no(Default)</td>\n<td>防火墙规则当前是否立即生效</td>\n</tr>\n<tr>\n<td>permanent</td>\n<td>yes、no</td>\n<td>防火墙规则当前是否重启后也生效</td>\n</tr>\n<tr>\n<td>state</td>\n<td>enabled、disabled</td>\n<td>启用或禁用当前配置的规则</td>\n</tr>\n<tr>\n<td>rich_rule</td>\n<td></td>\n<td>在防火墙中添加或删除富规则</td>\n</tr>\n<tr>\n<td>source</td>\n<td></td>\n<td>添加或删除防火墙源 IP 网络</td>\n</tr>\n<tr>\n<td>zone</td>\n<td>public(Default)、home ...</td>\n<td>指定防火墙区域</td>\n</tr>\n</tbody>\n</table>\n<p>1. 放行 http 服务流量，设定临时与永久生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m firewalld -a \"service=http immediate=yes permanent=yes</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">state</span><span class=\"token operator\">=</span>enabled\"</pre></td></tr></table></figure><p>2. 放行 tcp/8080-8090 端口，设定临时与永久生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m firewalld -a \"port=8080-8090/tcp immediate=yes permanent=yes</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">state</span><span class=\"token operator\">=</span>enabled\"</pre></td></tr></table></figure><h5 id=\"616-iptables模块\"><a class=\"anchor\" href=\"#616-iptables模块\">#</a> 6.16 Iptables 模块</h5>\n<p>功能：iptables 防火墙模块</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>table</td>\n<td></td>\n<td>表</td>\n</tr>\n<tr>\n<td>chain</td>\n<td></td>\n<td>链</td>\n</tr>\n<tr>\n<td>source</td>\n<td></td>\n<td>来源 IP</td>\n</tr>\n<tr>\n<td>destination</td>\n<td></td>\n<td>目标 IP</td>\n</tr>\n<tr>\n<td>destination_port</td>\n<td></td>\n<td>目标端口</td>\n</tr>\n<tr>\n<td>protocol</td>\n<td>tcp</td>\n<td>协议</td>\n</tr>\n<tr>\n<td>jump</td>\n<td>DROP、ACCEPT</td>\n<td>动作</td>\n</tr>\n<tr>\n<td>action</td>\n<td>insert（插入）、append（追加）</td>\n<td>如何添加规则</td>\n</tr>\n</tbody>\n</table>\n<p>1. 来源 IP 是 192.168.1.1 目标地址 1.1.1.1 目标端口 80  协议 tcp  则拒绝； 规则要写入第一行；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m iptables -a 'table=filter chain=INPUT source=192.168.1.1/32 destination=1.1.1.1 destination_port=80 protocol=tcp jump=DROP action=insert'</span></pre></td></tr></table></figure><p>2.DNAT： 如果请求 1.1.1:80 端口，则 DNAT 到 2.2.2.2:8800;</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m iptables -a 'table=nat chain=PREROUTING protocol=tcp destination=1.1.1.1 destination_port=80 jump=DNAT to_destination=\"2.2.2.2:8800\"'</span></pre></td></tr></table></figure><p>3.DNAT： 如果请求 1.1.1:81 端口，则 DNAT 到 3.3.3.3:8800;</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m iptables -a 'table=nat chain=PREROUTING protocol=tcp destination=1.1.1.1 destination_port=81 jump=DNAT to_destination=\"3.3.3.3:8800\" action=insert'</span></pre></td></tr></table></figure><p>4.SNAT: 源地址 172.16.2.0，SNAT 指定从 6.6.6.6 出去；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m iptables -a 'table=nat chain=POSTROUTING source=172.16.2.0/24 jump=SNAT to_source=6.6.6.6'</span></pre></td></tr></table></figure><p>5.SNAT: 源地址 172.16.3.0，SNAT 指定从 7.7.7.7 出去；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m iptables -a 'table=nat chain=POSTROUTING source=172.16.3.0/24 jump=SNAT to_source=7.7.7.7 action=insert'</span></pre></td></tr></table></figure><h5 id=\"617-yum_repository模块\"><a class=\"anchor\" href=\"#617-yum_repository模块\">#</a> 6.17 yum_repository 模块</h5>\n<p>功能：建立 yum 仓库</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>name</td>\n<td></td>\n<td>名称，文件名称</td>\n</tr>\n<tr>\n<td>description</td>\n<td></td>\n<td>描述，必填</td>\n</tr>\n<tr>\n<td>baseurl</td>\n<td></td>\n<td>仓库的地址</td>\n</tr>\n<tr>\n<td>gpgcheck</td>\n<td>yes，no</td>\n<td>验证开启</td>\n</tr>\n<tr>\n<td>gpgkey</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>1. 配置 Nginx yum 仓库</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m yum_repository -a 'name=ansible_nginx description=nginx_yum baseurl=\"http://nginx.org/packages/centos/$releasever/$basearch/\" gpgcheck=yes gpgkey=\"https://nginx.org/keys/nginx_signing.key\"'</span></pre></td></tr></table></figure><h5 id=\"618-hostname模块\"><a class=\"anchor\" href=\"#618-hostname模块\">#</a> 6.18 hostname 模块</h5>\n<p>功能：管理被控端主机名称；</p>\n<p>1. 设置主机名称为 ansible-hostname</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m hostname -a 'name=ansible-hostname'</span></pre></td></tr></table></figure><h5 id=\"619-sysctl模块\"><a class=\"anchor\" href=\"#619-sysctl模块\">#</a> 6.19 sysctl 模块</h5>\n<p>功能：修改内核参数模块；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>name</td>\n<td></td>\n<td>内核参数名称</td>\n</tr>\n<tr>\n<td>value</td>\n<td></td>\n<td>内核参数值</td>\n</tr>\n<tr>\n<td>state</td>\n<td>present</td>\n<td>状态</td>\n</tr>\n</tbody>\n</table>\n<p>1. 开启 forward 转发</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m sysctl -a 'name=net.ipv4.ip_forward value=1 state=present'</span></pre></td></tr></table></figure><h5 id=\"620-lineinfile模块\"><a class=\"anchor\" href=\"#620-lineinfile模块\">#</a> 6.20 lineinfile 模块</h5>\n<p>功能：修改或删除文件内容，与系统中的 sed 命令类似；</p>\n<table>\n<thead>\n<tr>\n<th><strong>参数</strong></th>\n<th><strong>选项</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path</td>\n<td></td>\n<td>指定要操作的文件</td>\n</tr>\n<tr>\n<td>regexp</td>\n<td></td>\n<td>使用正则表达式匹配对应的行</td>\n</tr>\n<tr>\n<td>line</td>\n<td></td>\n<td>修改为新的内容</td>\n</tr>\n<tr>\n<td>insertafter</td>\n<td></td>\n<td>将文本插入到 “指定的行” 之后</td>\n</tr>\n<tr>\n<td>insertbefore</td>\n<td></td>\n<td>将文本插入到 “指定的行” 之前</td>\n</tr>\n<tr>\n<td>state</td>\n<td>absent、present（Defaults）</td>\n<td>删除对应的文本时，需要 state=absent</td>\n</tr>\n<tr>\n<td>backrefs</td>\n<td>yes、no</td>\n<td>1. 支持后向引用、2. 当未匹配到内容则不操作文件</td>\n</tr>\n<tr>\n<td>backup</td>\n<td></td>\n<td>是否在修改文件之前对文件进行备份</td>\n</tr>\n<tr>\n<td>create</td>\n<td></td>\n<td>当要操作的文件并不存在时，是否创建对应的文件</td>\n</tr>\n</tbody>\n</table>\n<p>1. 将 SELINUX 修改为 disabled 状态；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m lineinfile -a 'path=/etc/selinux/config regexp='^SELINUX='</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">line</span><span class=\"token operator\">=</span>SELINUX<span class=\"token operator\">=</span>disabled'</pre></td></tr></table></figure><p>2. 替换 httpd.conf 文件中， ^Listen   为  Linsten 8080;</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m lineinfile -a 'path=/etc/httpd/conf/httpd.conf regexp=\"^Listen\" line=\"Listen 8080\"'</span></pre></td></tr></table></figure><p>3. 删除 /etc/sudoers 文件中 % wheel 开头的行；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m lineinfile -a 'path=/etc/sudoers regexp='^%wheel' state=absent'</span></pre></td></tr></table></figure><p>4. 替换 /etc/hosts 文件中以 12.0.0.1 的行为 127.0.0.1 <a href=\"http://ansible.ixuyong.com\">ansible.ixuyong.com</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m lineinfile -a 'path=/etc/hosts regex='^127\\.0\\.0\\.1' line=\"127.0.0.1 ansible.ixuyong.com\"'</span></pre></td></tr></table></figure><p>5. 给主机增加一个网关；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-eth1 line=\"GATEWAY=172.16.1.200\"'</span></pre></td></tr></table></figure><p>6. 给主机增加一个网关，但需要增加到 ONBOOT 下面；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-eth1 insertafter=\"ONBOOT=yes\" line=\"GATEWAY=172.16.1.200\"'</span></pre></td></tr></table></figure><p>7. 给主机增加一个网关，但需要增加到 ONBOOT 上面；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-eth1 insertbefore=\"ONBOOT=yes\" line=\"test=172.16.1.200\"'</span></pre></td></tr></table></figure>",
            "tags": [
                "Ansible"
            ]
        }
    ]
}