<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://ixuyong.cn</id>
    <title>LinuxSre云原生 • Posts by &#34;prometheus&#34; tag</title>
    <link href="http://ixuyong.cn" />
    <updated>2025-07-15T02:33:49.000Z</updated>
    <category term="Aliyun" />
    <category term="DevOps" />
    <category term="Docker" />
    <category term="ELKStack" />
    <category term="Harbor" />
    <category term="Kubernetes" />
    <category term="LVS" />
    <category term="Linux" />
    <category term="rsync" />
    <category term="Samba" />
    <category term="Vsftp" />
    <category term="MySQL" />
    <category term="Prometheus" />
    <category term="Rabbitmq" />
    <category term="Openvpn" />
    <category term="Redis" />
    <category term="Tomcat" />
    <category term="Windows" />
    <entry>
        <id>http://ixuyong.cn/posts/2041568856.html</id>
        <title>Prometheus监控Kubernetes</title>
        <link rel="alternate" href="http://ixuyong.cn/posts/2041568856.html"/>
        <content type="html">&lt;h3 id=&#34;prometheus监控kubernetes&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#prometheus监控kubernetes&#34;&gt;#&lt;/a&gt; Prometheus 监控 Kubernetes&lt;/h3&gt;
&lt;h4 id=&#34;一-监控kubernetes环境准备&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#一-监控kubernetes环境准备&#34;&gt;#&lt;/a&gt; 一、监控 Kubernetes 环境准备&lt;/h4&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl get nodes&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;NAME           STATUS   ROLES    AGE   VERSION&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;k8s-master01   Ready    &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;   46d   v1.27.10&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;k8s-master02   Ready    &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;   46d   v1.27.10&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;k8s-master03   Ready    &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;   46d   v1.27.10&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;k8s-node01     Ready    &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;   46d   v1.27.10&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;k8s-node02     Ready    &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;   46d   v1.27.10&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;二-部署alertmanager至kubernetes&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#二-部署alertmanager至kubernetes&#34;&gt;#&lt;/a&gt; 二、部署 AlertManager ⾄ Kubernetes&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;①先交付 webhook_wechat、webhook_dingding；&lt;/li&gt;
&lt;li&gt;②创建 ConfigMap，准备邮件的告警 template 模板；&lt;/li&gt;
&lt;li&gt;③创建 ConfigMap，准备告警路由相关的配置；&lt;/li&gt;
&lt;li&gt;④创建 HeadlessService；&lt;/li&gt;
&lt;li&gt;⑤创建 statefulSet，运⾏ 3 个节点 AlertManager；&lt;/li&gt;
&lt;li&gt;⑥创建 Ingress 对外提供；&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#创建 namespace&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl create ns monitoring&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 01-alert-webhook-wechat&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# sed -i &#34;s#kube-prom#monitoring#g&#34; *.yaml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;21-部署webhook_wechat&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#21-部署webhook_wechat&#34;&gt;#&lt;/a&gt; 2.1 部署 webhook_wechat&lt;/h5&gt;
&lt;p&gt;1、编写 deployment，运⾏ webhook-wechat&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 01-alert-webhook-wechat&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat 01-webhook-wechat-deploy.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;apiVersion: apps/v1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;kind: Deployment&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  name: webhook-wechat&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  namespace: monitoring&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  replicas: &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  selector:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    matchLabels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      app: wechat&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  template:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        app: wechat&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      containers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - name: webchat&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        image: oldxu3957/webhook_wechat_oldxu:v1.0&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        args: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;--port&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;5001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;		&lt;span class=&#34;token comment&#34;&gt;# 默认就是 5001 端口&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        ports:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - containerPort: &lt;span class=&#34;token number&#34;&gt;5001&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 01-alert-webhook-wechat&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl apply -f 01-webhook-wechat-deploy.yaml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 01-alert-webhook-wechat&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl get pods -n monitoring&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;NAME                              READY   STATUS    RESTARTS   AGE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-wechat-54b5bbf677-rmr26   &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;          16s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、编写 Service&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 01-alert-webhook-wechat&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat 02-webhook-wechat-service.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;apiVersion: v1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;kind: Service&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  name: webhook-wechat-svc&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  namespace: monitoring&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  selector:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    app: wechat&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ports:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   - port: &lt;span class=&#34;token number&#34;&gt;5001&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;     targetPort: &lt;span class=&#34;token number&#34;&gt;5001&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;     &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 01-alert-webhook-wechat&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl apply -f 02-webhook-wechat-service.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 01-alert-webhook-wechat&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl get svc -n monitoring&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;S&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;    AGE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-wechat-svc   ClusterIP   &lt;span class=&#34;token number&#34;&gt;10.96&lt;/span&gt;.82.7   &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;        &lt;span class=&#34;token number&#34;&gt;5001&lt;/span&gt;/TCP   13s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、测试 webhook-wechat 是否能正常发送消息 (8e24a24d-3f48-4ea8-bbde-36ca84d857e4)&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://10.96.82.7:5001/alert?token=8e24a24d-3f48-4ea8-bbde-36ca84d857e4 \&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-H&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;Content-Type: application/json&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-d&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;&amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &#34;alerts&#34;: [&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;status&#34;: &#34;firing&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;labels&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;severity&#34;: &#34;critical&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;alertname&#34;: &#34;InstanceDown&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;instance&#34;: &#34;example1&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;annotations&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;summary&#34;: &#34;Instance example1 down&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;description&#34;: &#34;The instance example1 is down.&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;startsAt&#34;: &#34;2024-12-20T15:04:05Z&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;endsAt&#34;: &#34;0001-01-01T00:00:00Z&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;status&#34;: &#34;resolved&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;labels&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;severity&#34;: &#34;critical&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;alertname&#34;: &#34;InstanceDown&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;instance&#34;: &#34;example1&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;annotations&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;summary&#34;: &#34;Instance example1 is back up&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;description&#34;: &#34;The instance example1 has recovered.&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;startsAt&#34;: &#34;2024-12-20T15:04:05Z&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;endsAt&#34;: &#34;2024-12-20T16:04:05Z&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#125;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ]&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&amp;#125;&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;22-部署webhook_dingding&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#22-部署webhook_dingding&#34;&gt;#&lt;/a&gt; 2.2 部署 webhook_dingding&lt;/h5&gt;
&lt;p&gt;1、编写 deployment，运⾏ webhook-dingding&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 02-alert-webhook-dingding&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat 01-webhook-dingding-deploy.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;apiVersion: apps/v1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;kind: Deployment&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  name: webhook-dingding&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  namespace: monitoring&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  replicas: &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  selector:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    matchLabels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      app: dingding&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  template:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        app: dingding&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      containers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - name: dingding&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        image: oldxu3957/webhook_dingding_oldxu:v1.0&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        args: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;--port&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;5002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        ports:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - containerPort: &lt;span class=&#34;token number&#34;&gt;5002&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 02-alert-webhook-dingding&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl apply -f 01-webhook-dingding-deploy.yaml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 02-alert-webhook-dingding&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl get pods -n monitoring&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;NAME                                READY   STATUS    RESTARTS   AGE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-dingding-6d68854649-r6smd   &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;          14s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-wechat-54b5bbf677-rmr26     &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;          13m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、编写 Service&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 02-alert-webhook-dingding&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat 02-webhook-dingding-service.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;apiVersion: v1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;kind: Service&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  name: webhook-dingding-svc&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  namespace: monitoring&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  selector:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    app: dingding&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ports:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - port: &lt;span class=&#34;token number&#34;&gt;5002&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    targetPort: &lt;span class=&#34;token number&#34;&gt;5002&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 02-alert-webhook-dingding&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl apply -f 02-webhook-dingding-service.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 02-alert-webhook-dingding&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl get svc -n monitoring&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;S&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;    AGE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-dingding-svc   ClusterIP   &lt;span class=&#34;token number&#34;&gt;10.96&lt;/span&gt;.241.84   &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;        &lt;span class=&#34;token number&#34;&gt;5002&lt;/span&gt;/TCP   0s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-wechat-svc     ClusterIP   &lt;span class=&#34;token number&#34;&gt;10.96&lt;/span&gt;.82.7     &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;        &lt;span class=&#34;token number&#34;&gt;5001&lt;/span&gt;/TCP   12m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、测试 webhook-wechat 是否能正常发送消息，49989606592d7ff06ee4b83120bf5a81ed1e4c3860696dcd7e663be1c66ef43f&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://10.96.241.84:5002/alert?token=49989606592d7ff06ee4b83120bf5a81ed1e4c3860696dcd7e663be1c66ef43f \&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-H&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;Content-Type: application/json&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-d&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;&amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &#34;alerts&#34;: [&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;status&#34;: &#34;firing&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;labels&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;severity&#34;: &#34;critical&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;alertname&#34;: &#34;InstanceDown&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;instance&#34;: &#34;example1&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;annotations&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;summary&#34;: &#34;Instance example1 down&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;description&#34;: &#34;The instance example1 is down.&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;startsAt&#34;: &#34;2024-12-20T15:04:05Z&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;endsAt&#34;: &#34;0001-01-01T00:00:00Z&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;status&#34;: &#34;resolved&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;labels&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;severity&#34;: &#34;critical&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;alertname&#34;: &#34;InstanceDown&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;instance&#34;: &#34;example1&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;annotations&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;summary&#34;: &#34;Instance example1 is back up&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;description&#34;: &#34;The instance example1 has recovered.&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;startsAt&#34;: &#34;2024-12-20T15:04:05Z&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;endsAt&#34;: &#34;2024-12-20T16:04:05Z&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#125;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ]&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&amp;#125;&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;23-创建alertmanager配置&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#23-创建alertmanager配置&#34;&gt;#&lt;/a&gt; 2.3 创建 AlertManager 配置&lt;/h5&gt;
&lt;p&gt;1、使⽤ ConfigMap 创建 AlertManager 所需的配置⽂件，名称为： alert-configs&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 03-alertmanager]# cat 01-alert-configs-configmap.yaml 
apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-configs
  namespace: monitoring
data:
  alertmanager.yml: |-
    # 全局配置
    global:
      smtp_smarthost: &#39;smtp.qq.com:25&#39;
      smtp_from: &#39;373370405@qq.com&#39;  	
      smtp_auth_username: &#39;373370405@qq.com&#39;
      smtp_auth_password: &#39;******&#39;
      smtp_hello: &#39;qq.com&#39;
      smtp_require_tls: false
    
    # 加载模板的路径
    templates:
      - &#39;/etc/alertmanager/template/*.tmpl&#39;
    
    # 路由规则
    route:
      group_by: [&#39;alertname&#39;]
      group_wait: 30s
      group_interval: 30s
      repeat_interval: 5m
      receiver: webhook-dingding-ops		# 默认发送给钉钉
    
      # 子路由
      routes:
      - match_re:
          job: &#39;kube.*&#39;
        receiver: &#39;webhook-wechat&#39;			# 如果匹配到job=kube.*的都发送给微信
        continue: true
    
      - match_re:
          job: &#39;redis_exporter&#39;
        receiver: &#39;email&#39;		        	# 如果job=domain_exporter则都发送给email
        continue: true
    
    receivers:
    - name: &#39;email&#39;
      email_configs:
      - to: &#39;373370405@qq.com&#39;
        send_resolved: true
        html: &#39;&amp;#123;&amp;#123; template &#34;email.html&#34; . &amp;#125;&amp;#125;&#39;   # 发送邮件内容，调用该模板进行渲染

    - name: &#39;webhook-wechat&#39;
      webhook_configs:
      - url: &#39;http://webhook-wechat-svc:5001/alert?token=8e24a24d-3f48-4ea8-bbde-36ca84d857e4&#39;
      
    - name: &#39;webhook-dingding-ops&#39;
      webhook_configs:
      - url: &#39;http://webhook-dingding-svc:5002/alert?token=49989606592d7ff06ee4b83120bf5a81ed1e4c3860696dcd7e663be1c66ef43f&#39;
      
[root@k8s-master01 03-alertmanager]# kubectl apply -f 01-alert-configs-configmap.yaml
[root@k8s-master01 03-alertmanager]# kubectl get cm -n monitoring
NAME               DATA   AGE
alert-configs      1      25s
alert-template     1      19s
kube-root-ca.crt   1      27m
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、使⽤ configmap 创建 AlertManager 邮件所依赖的模板⽂件，名称为： alert-template&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 03-alertmanager]# cat 02-alert-template-configmap.yaml 
apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-template
  namespace: monitoring
data:
  email.tmpl: |-
    &amp;#123;&amp;#123; define &#34;email.html&#34; &amp;#125;&amp;#125;
    &amp;#123;&amp;#123;- if gt (len .Alerts.Firing) 0 -&amp;#125;&amp;#125;
    &amp;#123;&amp;#123; range .Alerts &amp;#125;&amp;#125;
    &amp;lt;h2 style=&amp;quot;color: red;&amp;quot;&amp;gt;@告警通知&amp;lt;/h2&amp;gt;
    告警程序: AlertManager &amp;lt;br&amp;gt;
    告警级别: &amp;#123;&amp;#123; .Labels.severity &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    告警类型: &amp;#123;&amp;#123; .Labels.alertname &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    故障主机: &amp;#123;&amp;#123; .Labels.instance &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    告警主题: &amp;#123;&amp;#123; .Annotations.summary &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    告警详情: &amp;#123;&amp;#123; .Annotations.description &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    触发时间: &amp;#123;&amp;#123; (.StartsAt.Add 28800e9).Format &#34;2006-01-02 15:04:05&#34; &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    &amp;#123;&amp;#123; end &amp;#125;&amp;#125;&amp;#123;&amp;#123; end -&amp;#125;&amp;#125;
    
    &amp;#123;&amp;#123;- if gt (len .Alerts.Resolved) 0 -&amp;#125;&amp;#125;
    &amp;#123;&amp;#123; range .Alerts &amp;#125;&amp;#125;
    &amp;lt;h2 style=&amp;quot;color: green;&amp;quot;&amp;gt;@告警恢复&amp;lt;/h2&amp;gt;
    告警程序: AlertManager &amp;lt;br&amp;gt;
    告警级别: &amp;#123;&amp;#123; .Labels.severity &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    告警类型: &amp;#123;&amp;#123; .Labels.alertname &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    告警主机: &amp;#123;&amp;#123; .Labels.instance &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    告警主题: &amp;#123;&amp;#123; .Annotations.summary &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    告警详情: &amp;#123;&amp;#123; .Annotations.description &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    触发时间: &amp;#123;&amp;#123; (.StartsAt.Add 28800e9).Format &#34;2006-01-02 15:04:05&#34; &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    恢复时间: &amp;#123;&amp;#123; (.EndsAt.Add 28800e9).Format &#34;2006-01-02 15:04:05&#34; &amp;#125;&amp;#125; &amp;lt;br&amp;gt;
    &amp;#123;&amp;#123; end &amp;#125;&amp;#125;&amp;#123;&amp;#123; end -&amp;#125;&amp;#125;
    &amp;#123;&amp;#123; end &amp;#125;&amp;#125;
    
[root@k8s-master01 03-alertmanager]# kubectl apply -f 02-alert-template-configmap.yaml 
[root@k8s-master01 03-alertmanager]# kubectl get cm -n monitoring
NAME               DATA   AGE
alert-configs      1      25s
alert-template     1      19s
kube-root-ca.crt   1      27m
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;24-创建headlessservice&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#24-创建headlessservice&#34;&gt;#&lt;/a&gt; 2.4 创建 HeadLessService&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 03-alertmanager&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat 03-alertmanager-headlessService.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;apiVersion: v1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;kind: Service&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  name: alertmanager-svc&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  namespace: monitoring&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  clusterIP: &lt;span class=&#34;token string&#34;&gt;&#34;None&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  selector:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    app: alert&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ports:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - name: web&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    port: &lt;span class=&#34;token number&#34;&gt;9093&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    targetPort: &lt;span class=&#34;token number&#34;&gt;9093&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - name: cluster&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    port: &lt;span class=&#34;token number&#34;&gt;9094&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    targetPort: &lt;span class=&#34;token number&#34;&gt;9094&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 03-alertmanager&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl apply -f 03-alertmanager-headlessService.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 03-alertmanager&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl get svc -n monitoring&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;S&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;             AGE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;alertmanager-svc       ClusterIP   None           &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;        &lt;span class=&#34;token number&#34;&gt;9093&lt;/span&gt;/TCP,9094/TCP   6s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-dingding-svc   ClusterIP   &lt;span class=&#34;token number&#34;&gt;10.96&lt;/span&gt;.241.84   &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;        &lt;span class=&#34;token number&#34;&gt;5002&lt;/span&gt;/TCP            12m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-wechat-svc     ClusterIP   &lt;span class=&#34;token number&#34;&gt;10.96&lt;/span&gt;.82.7     &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;none&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;        &lt;span class=&#34;token number&#34;&gt;5001&lt;/span&gt;/TCP            24m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;25-部署alertmanager服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#25-部署alertmanager服务&#34;&gt;#&lt;/a&gt; 2.5 部署 AlertManager 服务&lt;/h5&gt;
&lt;p&gt;使⽤ statefulSet 编写 AlertManager 的⾼可⽤清单⽂件&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、定义 Alertmanager 实例的启动命令，包含了对应的 “配置⽂件路径 “、“数据存储路径” 以及 “Gossip 集群通信” 相关的参数。&lt;/li&gt;
&lt;li&gt;2、定义 AlertManager 实例挂载 “邮件模板” 的 ConfigMap 资源，以及 AlertManager 主配置⽂件的 ConfigMap 资源。&lt;/li&gt;
&lt;li&gt;3、Alertmanager 的每个实例，都需要使⽤ PVC 模板来提供数据持久化；&lt;/li&gt;
&lt;li&gt;4、AlertManager 在启动时可以采⽤并⾏的⽅式，因为集群之间没有先后依赖关系；&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 03-alertmanager&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat 04-alertmanager-statefulset.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;apiVersion: apps/v1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;kind: StatefulSet&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  name: alertmanager&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  namespace: monitoring&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  serviceName: &lt;span class=&#34;token string&#34;&gt;&#34;alertmanager-svc&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  podManagementPolicy: &lt;span class=&#34;token string&#34;&gt;&#34;Parallel&#34;&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;#采用并行方式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  replicas: &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  selector:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    matchLabels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      app: alert&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  template:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        app: alert&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      volumes:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - name: alert-cfg&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        configMap:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          name: alert-configs&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - name: alert-temp-cfg&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        configMap:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          name: alert-template&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      containers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - name: alertmanager&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        image: prom/alertmanager:v0.26.0&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        args:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - &lt;span class=&#34;token string&#34;&gt;&#34;--web.listen-address=:9093&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - &lt;span class=&#34;token string&#34;&gt;&#34;--cluster.listen-address=0.0.0.0:9094&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - &lt;span class=&#34;token string&#34;&gt;&#34;--cluster.peer=alertmanager-0.alertmanager-svc:9094&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - &lt;span class=&#34;token string&#34;&gt;&#34;--cluster.peer=alertmanager-1.alertmanager-svc:9094&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - &lt;span class=&#34;token string&#34;&gt;&#34;--cluster.peer=alertmanager-2.alertmanager-svc:9094&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - &lt;span class=&#34;token string&#34;&gt;&#34;--cluster.peer-timeout=60s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - &lt;span class=&#34;token string&#34;&gt;&#34;--config.file=/etc/alertmanager/alertmanager.yml&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - &lt;span class=&#34;token string&#34;&gt;&#34;--storage.path=/etc/alertmanager/data&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - &lt;span class=&#34;token string&#34;&gt;&#34;--data.retention=120h&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        volumeMounts:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - name: alert-cfg&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          mountPath: /etc/alertmanager/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - name: alert-temp-cfg&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          mountPath: /etc/alertmanager/template&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - name: alert-data&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          mountPath: /etc/alertmanager/data&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        ports:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - name: web&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          containerPort: &lt;span class=&#34;token number&#34;&gt;9093&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        - name: cluster&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          containerPort: &lt;span class=&#34;token number&#34;&gt;9094&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        resources:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          requests:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;            cpu: 200m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;            memory: 200Mi&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          limits:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;            cpu: 300m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;            memory: 300Mi&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  volumeClaimTemplates:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        name: alert-data&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        accessModes: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;ReadWriteMany&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        storageClassName: &lt;span class=&#34;token string&#34;&gt;&#34;nfs-storage&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        resources:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          requests:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;            storage: 3Gi&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 03-alertmanager&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl apply -f 04-alertmanager-statefulset.yaml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 03-alertmanager&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl get pods -n monitoring&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;NAME                                READY   STATUS    RESTARTS   AGE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;alertmanager-0                      &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;          97s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;alertmanager-1                      &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;          97s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;alertmanager-2                      &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;          97s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-dingding-6d68854649-r6smd   &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;          19m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;webhook-wechat-54b5bbf677-rmr26     &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;          32m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;26-发布alertmanager服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#26-发布alertmanager服务&#34;&gt;#&lt;/a&gt; 2.6 发布 AlertManager 服务&lt;/h5&gt;
&lt;p&gt;1、编写 Ingress 资源清单&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 03-alertmanager&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat 05-alertmanager-ingress.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;apiVersion: networking.k8s.io/v1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;kind: Ingress&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;metadata:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  name: alert-ingress&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  namespace: monitoring&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;spec:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ingressClassName: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - host: &lt;span class=&#34;token string&#34;&gt;&#34;k8s-alert.hmallleasing.com&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    http:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      paths:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - path: /&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        pathType: Prefix&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        backend:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          service:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;            name: alertmanager-svc&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;            port:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;              number: &lt;span class=&#34;token number&#34;&gt;9093&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 03-alertmanager&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl apply -f 05-alertmanager-ingress.yaml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 03-alertmanager&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl get ingress -n monitoring&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;NAME            CLASS   HOSTS                        ADDRESS                                        PORTS   AGE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;alert-ingress   nginx   k8s-alert.hmallleasing.com   &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.103,192.168.40.104,192.168.40.105   &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;      21s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、访问 AlertManager 的⻚⾯&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240310213846950.png&#34; alt=&#34;image-20240310213846950&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;27-测试alertmanager告警&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#27-测试alertmanager告警&#34;&gt;#&lt;/a&gt; 2.7 测试 AlertManager 告警&lt;/h5&gt;
&lt;p&gt;1、模拟故障测试 AlertManager 告警是否能正常发送&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl run tools --image=uhub.service.ucloud.cn/oldxu/tools:v1.0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@k8s-master01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# kubectl exec -it tools -- /bin/bash&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 路由给钉钉&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;/alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://alertmanager-svc.monitoring.svc.cluster.local:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=CPU故障,instance=dingding,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 路由给微信&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;/alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://alertmanager-svc.monitoring.svc.cluster.local:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=节点故障,instance=wechat,severity=critical,job=kube-nodes&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 路由给邮件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;/alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://alertmanager-svc.monitoring.svc.cluster.local:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=redis故障,instance=email,severity=critical,job=redis_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;3-部署prometheus至kubernetes&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#3-部署prometheus至kubernetes&#34;&gt;#&lt;/a&gt; 3、部署 Prometheus ⾄ Kubernetes&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;1、创建 ConfigMap，准备 Prometheus 配置⽂件，定义 AlertManager 的地址、以及 Rules 规则⽂件的路径等&lt;/li&gt;
&lt;li&gt;2、创建 ConfigMap，准备 Prometheus 告警相关的规则⽂件；&lt;/li&gt;
&lt;li&gt;3、创建 RBAC 权限，我们需要使⽤ Prometheus 访问 APIServer 来抓取各种资源的指标，这意味着 Prometheus 的 Pod 需要相应的权限来访问 Kubernetes API&lt;/li&gt;
&lt;li&gt;4、创建 HeadlessService；&lt;/li&gt;
&lt;li&gt;5、创建 statefulSet，运⾏单节点的 Prometheus（⽣产环境不建议使⽤ NFS 作为后端存储）；&lt;/li&gt;
&lt;li&gt;6、创建 Ingress，对外提供 Prometheus&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;31-创建prometheus配置文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#31-创建prometheus配置文件&#34;&gt;#&lt;/a&gt; 3.1 创建 Prometheus 配置⽂件&lt;/h5&gt;
&lt;p&gt;1、编辑 Prometheus 配置⽂件，先使⽤最⼩化配置。（后期监控其他组件在进⾏修改或增加。） configMap 资源名称： prom-configs&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]
[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
[root@k8s-master01 04-prometheus]# kubectl get cm -n monitoring
NAME               DATA   AGE
alert-configs      1      25m
alert-template     1      25m
kube-root-ca.crt   1      52m
prom-configs       1      16s
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;32-创建prometheus告警规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#32-创建prometheus告警规则&#34;&gt;#&lt;/a&gt; 3.2 创建 Prometheus 告警规则&lt;/h5&gt;
&lt;p&gt;1、编辑 PrometheusRules 告警规则⽂件 以 node、pods、jvm、redis、blackbox 等告警规则⽂件为例，后续根据情况在添加， configMap 资源名称： prom-rules&lt;/p&gt;
&lt;p&gt;&lt;em&gt;注意：这些 rules 是基于此前节点监控的规则，然后结合 K8S 的标签进⾏了重新修订。&lt;/em&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 02-prom-rules-configmap.yaml 
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-rules
  namespace: monitoring
data:
  node_rules.yml: |-
    groups:
    - name: CPU告警规则
      rules:
      - alert: 节点CPU使用率超过80%
        expr: ( 1 - avg(irate(node_cpu_seconds_total&amp;#123;mode=&amp;quot;idle&amp;quot;&amp;#125;[1m])) by (instance,job) ) * 100 &amp;gt; 80
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;主机CPU利用率过高，实例：&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; , &amp;#123;&amp;#123; $labels.job &amp;#125;&amp;#125;&amp;quot;
          description: &amp;quot;该实例的CPU利用率低于20%，当前利用率：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。可能存在CPU资源浪费情况。&amp;quot;
      - alert: CPU饱和度过高
        expr: sum(node_load1) by (instance,job) / (count(node_cpu_seconds_total&amp;#123;mode=&amp;quot;idle&amp;quot;&amp;#125;) by (instance,job) * 2) * 100 &amp;gt; 80
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;CPU饱和度过高，实例：&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; , &amp;#123;&amp;#123; $labels.job &amp;#125;&amp;#125;&amp;quot;
          description: &amp;quot;该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。需要立即检查系统负载情况。&amp;quot;
    
      - alert: 主机内存不足
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)  / node_memory_MemTotal_bytes * 100 &amp;gt; 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;主机内存使用率较高, 实例:&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;, 任务:&amp;#123;&amp;#123; $labels.job &amp;#125;&amp;#125;&amp;quot;
          description: &amp;quot;该实例的内存使用率持续2分钟高于80%，当前利用率：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%&amp;quot;
    
    
      - alert: 内存饱和度高
        expr: ( 1 - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes ) * 100 &amp;gt; 30
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;主机内存内存饱和度高, 实例:&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;, 任务:&amp;#123;&amp;#123; $labels.job &amp;#125;&amp;#125;&amp;quot;
          description: &amp;quot;SWAP内存使用率已连续2分钟超过30%，表明内存饱和度过高，当前SWAP使用率为：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;
    

      - alert: 磁盘空间告急
        expr: ( node_filesystem_size_bytes&amp;#123;device!=&amp;quot;tmpfs&amp;quot;&amp;#125; - node_filesystem_avail_bytes&amp;#123;device!=&amp;quot;tmpfs&amp;quot;&amp;#125; ) / node_filesystem_size_bytes&amp;#123;device!=&amp;quot;tmpfs&amp;quot;&amp;#125; * 100 &amp;gt; 70
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 磁盘&amp;#123;&amp;#123; $labels.mountpoint &amp;#125;&amp;#125; 分区空间不足&amp;quot;
          description: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的磁盘空间使用率已超过 70%，当前使用率为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%，请及时处理。&amp;quot;
    
    
      - alert: 磁盘Inode空间告急
        expr: (node_filesystem_files&amp;#123;device!=&amp;quot;tmpfs&amp;quot;&amp;#125; - node_filesystem_files_free&amp;#123;device!=&amp;quot;tmpfs&amp;quot;&amp;#125; ) / node_filesystem_files&amp;#123;device!=&amp;quot;tmpfs&amp;quot;&amp;#125; * 100 &amp;gt; 70
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 磁盘空间不足&amp;quot;
          description: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的磁盘Inode空间使用率已超过 70%，当前使用率为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%，请及时处理。&amp;quot;
    
      - alert: 磁盘IOPS写入较高
        #expr: sum(rate(node_disk_writes_completed_total[1m])) by (instance,job) / 120 * 100 &amp;gt;60
        #round函数可以对值进行四舍五入
        expr: round(max(irate(node_disk_writes_completed_total[1m])) by (instance,job) / 120 * 100) &amp;gt; 60
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; IOPS每秒写入次数超过120次/s&amp;quot;
          description: 
            目前磁盘IOPS写入饱和度是 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%
            目前磁盘IOPS每秒写入最大 &amp;#123;&amp;#123; printf `max(rate(node_disk_writes_completed_total&amp;#123;instance=&#34;%s&#34;,job=&#34;%s&#34;&amp;#125;[1m]))` $labels.instance $labels.job | query | first | value | printf &#34;%.2f&#34; &amp;#125;&amp;#125; 次/s
    
      - alert: 磁盘IOPS读取较高
        expr: round(max(irate(node_disk_reads_completed_total[1m])) by (instance,job) / 120 * 100) &amp;gt; 60
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; IOPS每秒读取次数超过120次/s&amp;quot;
          description: 
            目前磁盘IOPS读取饱和度是 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%
            目前磁盘IOPS每秒读取最大 &amp;#123;&amp;#123; printf `max(rate(node_disk_reads_completed_total&amp;#123;instance=&#34;%s&#34;,job=&#34;%s&#34;&amp;#125;[1m]))` $labels.instance $labels.job | query | first | value | printf &#34;%.2f&#34; &amp;#125;&amp;#125; 次/s
    
    
      - alert: 磁盘IO写入吞吐较高
        expr: round(max(rate(node_disk_written_bytes_total[1m])) by (instance,job) / 1024 /1024 / 30 * 100) &amp;gt; 60
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 磁盘IO写入每秒超过最大30MB/s&amp;quot;
          description: 
            目前磁盘IO写入吞吐量的饱和度是 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。
            目前磁盘IO写入吞吐量每秒最大是 &amp;#123;&amp;#123; printf `max(rate(node_disk_written_bytes_total&amp;#123;instance=&#34;%s&#34;,job=&#34;%s&#34;&amp;#125;[1m])) /1024/1024` $labels.instance $labels.job | query | first | value | printf &#34;%.2f&#34; &amp;#125;&amp;#125;MB/s
    
      - alert: 磁盘IO读取吞吐较高
        expr: round(max(rate(node_disk_read_bytes_total[1m])) by (instance,job) / 1024 /1024 /30 * 100 ) &amp;gt; 60
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 磁盘IO读取每秒超过最大30MB/s&amp;quot;
          description:
            目前磁盘IO读取吞吐量的饱和度是 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。
            目前磁盘IO读取吞吐量每秒最大是 &amp;#123;&amp;#123; printf `max(rate(node_disk_read_bytes_total&amp;#123;instance=&#34;%s&#34;,job=&#34;%s&#34;&amp;#125;[1m])) /1024/1024` $labels.instance $labels.job | query | first | value | printf &#34;%.2f&#34; &amp;#125;&amp;#125;MB/s
    
    
      - alert: 网络下载带宽异常
        expr: max(irate(node_network_receive_bytes_total[1m]) * 8 / 1024 / 1024) by (instance,job,device) / 50 * 100  &amp;gt;= 80
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 &amp;#123;&amp;#123; $labels.device &amp;#125;&amp;#125;接口下载流量已经超过公司实际50Mbps&amp;quot;
          description: 
            目前下载带宽已经达到 &amp;#123;&amp;#123; printf `(irate(node_network_receive_bytes_total&amp;#123;instance=&#34;%s&#34;,job=&#34;%s&#34;,device=&#34;%s&#34;&amp;#125;[1m]) * 8 / 1024 / 1024)` $labels.instance $labels.job $labels.device | query | first | value | printf &#34;%.2f&#34; &amp;#125;&amp;#125; Mbps/s
            目前下载带宽使用率在 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%
    
      - alert: 网络上传带宽异常
        expr: max(irate(node_network_transmit_bytes_total[1m]) * 8 / 1024 / 1024) by (instance,job,device) / 50 * 100 &amp;gt;= 80
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 &amp;#123;&amp;#123; $labels.device &amp;#125;&amp;#125;接口上传流量已经超过公司实际50Mbps&amp;quot;
          description: 
            目前上传带宽已经达到 &amp;#123;&amp;#123; printf `(irate(node_network_transmit_bytes_total&amp;#123;instance=&#34;%s&#34;,job=&#34;%s&#34;,device=&#34;%s&#34;&amp;#125;[1m]) * 8 / 1024 / 1024)` $labels.instance $labels.job $labels.device | query | first | value | printf &#34;%.2f&#34; &amp;#125;&amp;#125; Mbps/s
            目前上传带宽使用率在 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%
    
    
      - alert: 网络TCP连接数异常
        expr: node_nf_conntrack_entries / node_nf_conntrack_entries_limit * 100 &amp;gt; 80
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 tcp连接数超过80%&amp;quot;
          description: 
            目前TCP连接数是 &amp;#123;&amp;#123; printf `node_nf_conntrack_entries&amp;#123;instance=&#34;%s&#34;,job=&#34;%s&#34;&amp;#125;` $labels.instance $labels.job | query | first | value | printf &#34;%.2f&#34; &amp;#125;&amp;#125;
            目前TCP连接使用率是 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%
    
      - alert: 节点处于Down状态
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例:&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 处于Down状态&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 节点已连接超时&amp;quot;

  kube_pods_rules.yml: |-
    groups:
    - name: Pods的告警规则文件
      rules:
      - alert: Pod中容器的CPU利用率高
        expr: sum (rate(container_cpu_usage_seconds_total&amp;#123;image!=&amp;quot;&amp;quot;&amp;#125;[5m])) by (instance,job,pod,namespace) * 100 &amp;gt; 80
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod CPU利用率高&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的CPU利用率当前为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%，超过了80%的阈值。&amp;quot;
    
      - alert: Pod中容器内存利用率高
        expr: |
          sum(container_memory_working_set_bytes&amp;#123;name!=&amp;quot;&amp;quot;&amp;#125;) by (instance,job,pod,namespace)
          /
          sum(container_spec_memory_limit_bytes&amp;#123;name!=&amp;quot;&amp;quot;&amp;#125; &amp;gt; 0) by (instance,job,pod,namespace) * 100 &amp;gt; 80
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod内存利用率高&amp;quot;
          description: 在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的内存最大限制是 &amp;#123;&amp;#123; printf `sum (container_spec_memory_limit_bytes&amp;#123;namespace=&#34;%s&#34;,pod=&#34;%s&#34;&amp;#125; &gt; 0 ) /1024 /1024` $labels.namespace $labels.pod | query | first | value &amp;#125;&amp;#125;MB , 目前利用率已达&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%，超过限制的80%。

      - alert: Pod容器网络发送速率过高
        expr: sum(rate(container_network_transmit_bytes_total&amp;#123;image!=&amp;quot;&amp;quot;&amp;#125;[1m])) by (instance,job,pod,namespace) * 8 /1024 /1024 &amp;gt; 50
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod网络发送速率过高&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的网络发送速率达到&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;Mbps，超过了50Mbps的阈值。&amp;quot;
    
      - alert: Pod容器网络接收速率过高
        expr: sum(rate(container_network_receive_bytes_total&amp;#123;image!=&amp;quot;&amp;quot;&amp;#125;[1m])) by (instance,job,pod,namespace) * 8 /1024 /1024 &amp;gt; 50
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod网络发送速率过高&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的网络接收速率达到&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;Mbps，超过了50Mbps的阈值。&amp;quot;
    
      - alert: Pod容器磁盘写入吞吐量过大
        expr: sum (rate(container_fs_writes_bytes_total&amp;#123;name!=&amp;quot;&amp;quot;&amp;#125;[1m])) by (instance,job,pod,namespace) /1024 /1024 &amp;gt; 20
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod磁盘写入吞吐量过大&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的磁盘写入吞吐量达到&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;MB/s，超过了20MB/s的阈值。&amp;quot;
    
      - alert: Pod容器磁盘读取吞吐量过大
        expr: sum (rate(container_fs_reads_bytes_total&amp;#123;name!=&amp;quot;&amp;quot;&amp;#125;[1m])) by (instance,job,pod,namespace) /1024 /1024 &amp;gt; 20
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod磁盘读取吞吐量过大&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的磁盘读取吞吐量达到&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;MB/s，超过了20MB/s的阈值。&amp;quot;


  jvm_rules.yml: |-
    groups:
    - name: &amp;quot;JVM告警规则&amp;quot;
      rules:
      - alert: JVM堆内存使用率过高
        expr: jvm_memory_bytes_used&amp;#123;area=&amp;quot;heap&amp;quot;,&amp;#125; / jvm_memory_bytes_max&amp;#123;area=&amp;quot;heap&amp;quot;,&amp;#125; * 100 &amp;gt; 90
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 实例的JVM 堆内存使用率超过80%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间下的 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; PodJVM堆内存使用率超过80%, 当前使用率是 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%&amp;quot;

      - alert: JVMGC时间过长
        expr: sum (rate(jvm_gc_collection_seconds_sum[5m]) / rate(jvm_gc_collection_seconds_count[5m])) by (instance,job,gc,namespace,pod_name) &amp;gt; 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 实例的JVM  GC时间超过了1秒。&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间下的 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod使用 &amp;#123;&amp;#123; $labels.gc &amp;#125;&amp;#125; GC垃圾回收算法时间超过1s，当前值 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒&amp;quot;

      - alert: JVM死锁线程过多
        expr: min_over_time(jvm_threads_deadlocked[5m]) &amp;gt; 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;JVM检测到&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 实例有死锁线程&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间下的 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod，在过去5分钟检测到死锁线程, 当前死锁线程数是 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;。&amp;quot;


  redis_rules.yml: |-
    groups:
    - name: redis告警规则
      rules:
      - alert: Redis实例宕机
        expr: redis_up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例宕机&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod在过去5分钟内无法连接。&amp;quot;

      - alert: Redis连接数过高
        expr: redis_connected_clients / redis_config_maxclients * 100 &amp;gt; 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例连接数超过80%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod当前连接数占最大连接数的比率超过80%。当前比率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: Redis连接被拒绝
        expr: increase(redis_rejected_connections_total[1h]) &amp;gt; 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例有连接被拒绝&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod在过去1小时内有连接被拒绝。当前被拒绝的连接数: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;。&amp;quot;

      - alert: Redis内存使用率过高
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 &amp;gt; 80
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例内存使用率超过80%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod的内存使用率超过配置的最大内存值的80%。当前内存使用率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: Redis缓存命中率低
        expr: |
          irate(redis_keyspace_hits_total[5m])
          / 
          (irate(redis_keyspace_hits_total[5m]) + irate(redis_keyspace_misses_total[5m])) * 100 &amp;lt; 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例缓存命中率低于90%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod最近5分钟内的缓存命中率低于90%。当前命中率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: Redis即将过期的Key数量过多
        expr: |
          sum(redis_db_keys_expiring) by (instance, job, namespace,pod_name,db)
          / 
          sum(redis_db_keys) by (instance, job, namespace,pod_name,db) * 100 &amp;gt; 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例中的 &#39;&amp;#123;&amp;#123; $labels.db &amp;#125;&amp;#125;&#39; 数据库有大量即将过期的Key&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod中的 &#39;&amp;#123;&amp;#123; $labels.db &amp;#125;&amp;#125;&#39; 数据库有超过50%的Key即将过期。当前过期比率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: RedisRDB备份失败
        expr: redis_rdb_last_bgsave_status == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例 RDB备份失败&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod最近的RDB备份失败。&amp;quot;

      - alert: RedisRDB备份时间过长
        expr: redis_rdb_last_bgsave_duration_sec &amp;gt; 3 and redis_rdb_last_bgsave_status == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例 RDB备份成功但耗时超过3秒&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod, RDB备份成功但耗时超过了3秒。持续时间: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。&amp;quot;

      - alert: RedisRDB备份过期
        expr: (time() - redis_rdb_last_save_timestamp_seconds) &amp;gt; 36000
        for: 24h
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例超过10小时未进行RDB备份&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod已超过10小时没有生成新的RDB备份文件。&amp;quot;

      - alert: Redis命令拒绝率过高
        expr: |
          sum(irate(redis_commands_rejected_calls_total[5m])) by (instance,job,namespace,pod_name)
          / 
          sum(irate(redis_commands_total[5m])) by (instance,job,namespace,pod_name) * 100 &amp;gt; 25
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例命令拒绝率超过25%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod的命令拒绝率超过了25%。当前拒绝率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: Redis命令平均响应时间过长
        expr: |
          sum(rate(redis_commands_duration_seconds_total[5m])) by (instance,job,namespace,pod_name)
          / 
          sum(rate(redis_commands_processed_total[5m])) by (instance,job,namespace,pod_name) &amp;gt; 0.250
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例命令平均响应时间超过250ms&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod的执行命令平均响应时间超过了250毫秒。当前平均响应时间: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。&amp;quot;


  blackbox_tcp_rules.yml: |-
    groups:
    - name: Blackbox_tcp告警规则文件
      rules:
      - alert: Service TCP探测失败
        expr: sum(probe_success&amp;#123;job=~&amp;quot;.*tcp&amp;quot;&amp;#125;) by (instance,job,namespace,service_name) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;探测 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Service 的TCP接口探测失败。&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中的 &#39;&amp;#123;&amp;#123; $labels.service_name &amp;#125;&amp;#125;&#39; Service资源 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 地址探测失败。&amp;quot;
    
      - alert: Service TCP请求的响应时间过长
        expr: probe_duration_seconds&amp;#123;job=~&amp;quot;.*tcp&amp;quot;&amp;#125; &amp;gt; 0.500
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;探测 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Service 的TCP响应时间超过了500毫秒。&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中的 &#39;&amp;#123;&amp;#123; $labels.service_name &amp;#125;&amp;#125;&#39; Service资源 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 当前响应时长为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125; 秒。&amp;quot;

      - alert: Service的DNS解析响应时间过长
        expr: probe_dns_lookup_time_seconds&amp;#123;job=~&amp;quot;.*tcp&amp;quot;&amp;#125; &amp;gt; 0.500
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;探测 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Service 的DNS解析响应时间超过了500毫秒。&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中的 &#39;&amp;#123;&amp;#123; $labels.service_name &amp;#125;&amp;#125;&#39; Service资源 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 当前响应时长为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125; 秒。&amp;quot;	

  blackbox_http_rules.yml: |-
    groups:
    - name: Blackbox_http告警规则文件
      rules:
      - alert: 站点平均请求过长
        expr: sum (avg_over_time(probe_http_duration_seconds[1m])) by (instance,job,namespace,ingress_name) &amp;gt; 3
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名整体请求时间超过了3秒。&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名最近1分钟的平均请求时间超过3秒。当前平均请求时间：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。&amp;quot;

      - alert: 站点阶段耗时过长
        expr: |
          (
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;connect&amp;quot;&amp;#125; &amp;gt; 1 or
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;processing&amp;quot;&amp;#125; &amp;gt; 1 or
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;resolve&amp;quot;&amp;#125; &amp;gt; 1 or
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;tls&amp;quot;&amp;#125; &amp;gt; 1 or
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;transfer&amp;quot;&amp;#125; &amp;gt; 1
          )
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名在 &#39;&amp;#123;&amp;#123; $labels.phase &amp;#125;&amp;#125;&#39; 阶段耗时过长&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名在阶段 &#39;&amp;#123;&amp;#123; $labels.phase &amp;#125;&amp;#125;&#39; 的耗时超过0.5秒。当前耗时：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。&amp;quot;

      - alert: 站点响应状态码异常
        expr: probe_http_status_code &amp;lt;= 199 or probe_http_status_code &amp;gt;= 400
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名返回异常状态码&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名返回的状态码为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;，表明请求可能存在问题。&amp;quot;
    
      - alert: 重定向次数过多
        expr: probe_http_redirects &amp;gt; 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名重定向次数过多&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名在最近的探测中重定向次数超过5次。当前次数：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;次。&amp;quot;

      - alert: 证书即将过期&amp;lt;30
        expr: (probe_ssl_earliest_cert_expiry - time()) /86400 &amp;lt; 30
        for: 24h
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名的 SSL 证书即将过期&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名的 SSL 证书将在 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125; 天内过期。&amp;quot;
    
      - alert: 证书即将过期&amp;lt;7
        expr: (probe_ssl_earliest_cert_expiry - time()) /86400 &amp;lt; 7
        for: 24h
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名的 SSL 证书即将过期&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名的 SSL 证书将在 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125; 天内过期。&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、创建 ConfigMap&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl apply -f 02-prom-rules-configmap.yaml 
[root@k8s-master01 04-prometheus]# kubectl get cm -n monitoring
NAME               DATA   AGE
alert-configs      1      34m
alert-template     1      34m
kube-root-ca.crt   1      61m
prom-configs       1      9m2s
prom-rules         6      13s
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;33-创建prometheusrbac权限&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#33-创建prometheusrbac权限&#34;&gt;#&lt;/a&gt; 3.3 创建 PrometheusRBAC 权限&lt;/h5&gt;
&lt;p&gt;1、创建⼀个 ServiceAccount ⽤户，名称为 prometheus-sa&lt;/p&gt;
&lt;p&gt;2、创建 ClusterRole，设定对应的权限规则，名称为 Prometheus-role 。&lt;/p&gt;
&lt;p&gt;3、创建 ClusterRoleBinding，名称为 prometheus-rolebinding ，将 Prometheus-role ⻆⾊的权限关联⾄ kube-prom&lt;/p&gt;
&lt;p&gt;名称空间 prometheus-sa ⽤户。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 03-prometheus-rbac.yaml 
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-sa
  namespace: monitoring

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-role
rules:
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - nodes
      - services
      - endpoints
      - pods
      - nodes/proxy
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - &amp;quot;networking.k8s.io&amp;quot;
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - configmaps
      - nodes/metrics
    verbs:
      - get
  - nonResourceURLs:
      - /metrics
    verbs:
      - get

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-role
subjects:
  - kind: ServiceAccount
    name: prometheus-sa
    namespace: monitoring
    
[root@k8s-master01 04-prometheus]# kubectl apply -f 03-prometheus-rbac.yaml 
serviceaccount/prometheus-sa created
clusterrole.rbac.authorization.k8s.io/prometheus-role created
clusterrolebinding.rbac.authorization.k8s.io/prometheus-rolebinding created
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;34-创建headlesssevice&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#34-创建headlesssevice&#34;&gt;#&lt;/a&gt; 3.4 创建 headlessSevice&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 04-prometheus-headlessService.yaml 
apiVersion: v1
kind: Service
metadata:
  name: prometheus-svc
  namespace: monitoring
spec:
  clusterIP: &amp;quot;None&amp;quot;
  selector:
    app: prometheus
  ports:
  - name: http
    port: 9090
    targetPort: 9090
    
[root@k8s-master01 04-prometheus]# kubectl apply -f 04-prometheus-headlessService.yaml 
[root@k8s-master01 04-prometheus]# kubectl get svc -n monitoring
NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE
alertmanager-svc       ClusterIP   None           &amp;lt;none&amp;gt;        9093/TCP,9094/TCP   37m
prometheus-svc         ClusterIP   None           &amp;lt;none&amp;gt;        9090/TCP            16s
webhook-dingding-svc   ClusterIP   10.96.241.84   &amp;lt;none&amp;gt;        5002/TCP            49m
webhook-wechat-svc     ClusterIP   10.96.82.7     &amp;lt;none&amp;gt;        5001/TCP            62m
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;35-部署prometheus服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#35-部署prometheus服务&#34;&gt;#&lt;/a&gt; 3.5 部署 Prometheus 服务&lt;/h5&gt;
&lt;p&gt;使⽤ statefulSet 编写 Prometheus 清单⽂件&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、定义 Prometheus 所关联的 ServiceAccount 账户，确保有权限能访问 APIServer&lt;/li&gt;
&lt;li&gt;1、定义 Prometheus 实例的启动命令，包含了对应的 “配置⽂件路径 “、“数据存储路径” 相关的参数。&lt;/li&gt;
&lt;li&gt;2、定义 Prometheus 实例挂载 “配置⽂件” 的 ConfigMap 资源，以及 rules 告警规则⽂件的 ConfigMap 资源。&lt;/li&gt;
&lt;li&gt;3、Prometheus 使⽤ PVC 模板来提供数据持久化；&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 05-prometheus-statefulset.yaml 
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: prometheus
  namespace: monitoring
spec:
  serviceName: &amp;quot;prometheus-svc&amp;quot;
  replicas: 2
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      serviceAccountName: &amp;quot;prometheus-sa&amp;quot;		# sa账号
      volumes:
      - name: prom-cfg
        configMap:
          name: prom-configs
      - name: prom-rules-cfg
        configMap:
          name: prom-rules
      containers:
      - name: prom
        image: prom/prometheus:v2.49.1
        args:
        - &amp;quot;--config.file=/etc/prometheus/prometheus.yml&amp;quot;
        - &amp;quot;--storage.tsdb.path=/etc/prometheus/data&amp;quot;
        - &amp;quot;--storage.tsdb.retention.time=10d&amp;quot;
        - &amp;quot;--web.enable-lifecycle&amp;quot;
        volumeMounts:
        - name: prom-cfg
          mountPath: /etc/prometheus
        - name: prom-rules-cfg
          mountPath: /etc/prometheus/rules
        - name: prom-data
          mountPath: /etc/prometheus/data
        ports:
        - containerPort: 9090
        resources:
          requests:
            cpu: 1000m
            memory: 1024Mi
          limits:
            cpu: 1000m
            memory: 1024Mi
  volumeClaimTemplates:
    - metadata:
        name: prom-data
      spec:
        accessModes: [&amp;quot;ReadWriteMany&amp;quot;]
        storageClassName: &amp;quot;nfs-storage&amp;quot;
        resources:
          requests:
            storage: 3Gi
            
[root@k8s-master01 04-prometheus]# kubectl apply -f 05-prometheus-statefulset.yaml
[root@k8s-master01 04-prometheus]# kubectl get pods -n monitoring
NAME                                READY   STATUS    RESTARTS   AGE
alertmanager-0                      1/1     Running   0          38m
alertmanager-1                      1/1     Running   0          38m
alertmanager-2                      1/1     Running   0          38m
prometheus-0                        1/1     Running   0          2m35s
prometheus-1                        1/1     Running   0          92s
webhook-dingding-6d68854649-r6smd   1/1     Running   0          56m
webhook-wechat-54b5bbf677-rmr26     1/1     Running   0          69m

&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;36-发布prometheus服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#36-发布prometheus服务&#34;&gt;#&lt;/a&gt; 3.6 发布 Prometheus 服务&lt;/h5&gt;
&lt;p&gt;1、编写 Ingress 资源清单&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 06-prometheus-ingress.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prom-ingress
  namespace: monitoring
spec:
  ingressClassName: &amp;quot;nginx&amp;quot;
  rules:
  - host: &amp;quot;k8s-prom.hmallleasing.com&amp;quot;
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: prometheus-svc
            port:
              number: 9090

[root@k8s-master01 04-prometheus]# kubectl apply -f 06-prometheus-ingress.yaml 
[root@k8s-master01 04-prometheus]# kubectl get ingress -n monitoring
NAME            CLASS   HOSTS                        ADDRESS                                        PORTS   AGE
alert-ingress   nginx   k8s-alert.hmallleasing.com   192.168.40.103,192.168.40.104,192.168.40.105   80      38m
prom-ingress    nginx   k8s-prom.hmallleasing.com    192.168.40.103,192.168.40.104,192.168.40.105   80      78s
&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&#34;4-部署grafana至kubernetes&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#4-部署grafana至kubernetes&#34;&gt;#&lt;/a&gt; 4、部署 Grafana ⾄ Kubernetes&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;1、创建 HeadlessService；&lt;/li&gt;
&lt;li&gt;2、部署 Grafana，使⽤ statefulSet；&lt;/li&gt;
&lt;li&gt;3、创建 Ingress，对外提供 Grafana；&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;41-创建headlessservice&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#41-创建headlessservice&#34;&gt;#&lt;/a&gt; 4.1 创建 HeadlessService&lt;/h5&gt;
&lt;p&gt;1、编写 Grafana 的 headlessService&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 05-grafana]# cat 01-grafana-headlessService.yaml 
apiVersion: v1
kind: Service
metadata:
  name: grafana-svc
  namespace: monitoring
spec:
  clusterIP: &amp;quot;None&amp;quot;
  selector:
    app: grafana
  ports:
  - name: http
    port: 3000
    targetPort: 3000
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查 service&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 05-grafana]# kubectl apply -f 01-grafana-headlessService.yaml 
[root@k8s-master01 05-grafana]# kubectl get svc -n monitoring
NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE
alertmanager-svc       ClusterIP   None           &amp;lt;none&amp;gt;        9093/TCP,9094/TCP   23h
grafana-svc            ClusterIP   None           &amp;lt;none&amp;gt;        3000/TCP            5s
prometheus-svc         ClusterIP   None           &amp;lt;none&amp;gt;        9090/TCP            22h
webhook-dingding-svc   ClusterIP   10.96.241.84   &amp;lt;none&amp;gt;        5002/TCP            23h
webhook-wechat-svc     ClusterIP   10.96.82.7     &amp;lt;none&amp;gt;        5001/TCP            23h
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;42-部署grafana服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#42-部署grafana服务&#34;&gt;#&lt;/a&gt; 4.2 部署 Grafana 服务&lt;/h5&gt;
&lt;p&gt;使⽤ statefulSet 编写 Grafana 清单⽂件&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、Grafana 需要通过 GF_SECURITY_ADMIN_USER 传递⽤户名， GF_SECURITY_ADMIN_PASSWORD 传递密码。&lt;/li&gt;
&lt;li&gt;2、Grafana 的实例，需要使⽤ PVC 模板来提供数据持久化；&lt;/li&gt;
&lt;li&gt;3、Grafana 的持久存储需要考虑权限， fsGroup: 472&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 05-grafana]# cat 02-grafana-statefulset.yaml 
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: grafana
  namespace: monitoring
spec:
  serviceName: &amp;quot;grafana-svc&amp;quot;
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      securityContext:
        fsGroup: 472    # 当Pod启动时，Kubernetes会自动将此组ID应用到Pod级别共享的存储上（比如持久卷）。
      containers:
      - name: grafana
        image: grafana/grafana:10.2.2
        env:
        - name: GF_SECURITY_ADMIN_USER
          value: &amp;quot;admin&amp;quot;
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: &amp;quot;talent&amp;quot;
        volumeMounts:
        - name: grafana-data
          mountPath: /var/lib/grafana
        ports:
        - containerPort: 3000
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
            scheme: HTTP
          initialDelaySeconds: 60
          failureThreshold: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 30
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
            scheme: HTTP
          initialDelaySeconds: 60
          failureThreshold: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 30
        resources:
          requests:
            cpu: 500m
            memory: 2048Mi
          limits:
            cpu: 500m
            memory: 2048Mi
  volumeClaimTemplates:
    - metadata:
        name: grafana-data
      spec:
        accessModes: [&amp;quot;ReadWriteMany&amp;quot;]
        storageClassName: &amp;quot;nfs-storage&amp;quot;
        resources:
          requests:
            storage: 3Gi

[root@k8s-master01 05-grafana]# kubectl apply -f 02-grafana-statefulset.yaml 
[root@k8s-master01 ~]# kubectl get pods -n monitoring
NAME                                READY   STATUS    RESTARTS            AGE
alertmanager-0                      1/1     Running   1 (6m18s ago)       23h
alertmanager-1                      1/1     Running   1 (&amp;lt;invalid&amp;gt; ago)   23h
alertmanager-2                      1/1     Running   1 (11m ago)         23h
grafana-0                           1/1     Running   0                   2m22s
prometheus-0                        1/1     Running   1 (4m34s ago)       23h
prometheus-1                        1/1     Running   1 (6m18s ago)       23h
webhook-dingding-6d68854649-r6smd   1/1     Running   1 (4m34s ago)       23h
webhook-wechat-54b5bbf677-rmr26     1/1     Running   1 (6m18s ago)       24h
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;43-发布grafana服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#43-发布grafana服务&#34;&gt;#&lt;/a&gt; 4.3 发布 Grafana 服务&lt;/h5&gt;
&lt;p&gt;1、编辑 Grafana 的 Ingress&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 05-grafana]# cat 03-grafana-ingress.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: monitoring
spec:
  ingressClassName: &amp;quot;nginx&amp;quot;
  rules:
  - host: &amp;quot;k8s-grafana.hmallleasing.com&amp;quot;
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana-svc
            port:
              number: 3000
       
[root@k8s-master01 05-grafana]# kubectl apply -f 03-grafana-ingress.yaml 
[root@k8s-master01 05-grafana]# kubectl get ingress -n monitoring
NAME              CLASS   HOSTS                          ADDRESS                         PORTS   AGE
alert-ingress     nginx   k8s-alert.hmallleasing.com     192.168.40.103,192.168.40.105   80      23h
grafana-ingress   nginx   k8s-grafana.hmallleasing.com   192.168.40.103,192.168.40.105   80      21s
prom-ingress      nginx   k8s-prom.hmallleasing.com      192.168.40.103,192.168.40.105   80      23h
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、访问 Grafana 的 web 界⾯&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240311211754517.png&#34; alt=&#34;image-20240311211754517&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;44-配置grafana连接prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#44-配置grafana连接prometheus&#34;&gt;#&lt;/a&gt; 4.4 配置 Grafana 连接 Prometheus&lt;/h5&gt;
&lt;p&gt;1、点击 Connections--&amp;gt;Add newConnection，搜索 Prometheus，点击添加 DataSource&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240311212003641.png&#34; alt=&#34;image-20240311212003641&#34; /&gt;&lt;/p&gt;
&lt;p&gt;2、点击测试并保存&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240311212027200.png&#34; alt=&#34;image-20240311212027200&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;5-部署blackbox至kubernetes&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#5-部署blackbox至kubernetes&#34;&gt;#&lt;/a&gt; 5、部署 blackbox ⾄ Kubernetes&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;1、创建 ConfigMap，定义 blackbox.yml 中的检测模块；&lt;/li&gt;
&lt;li&gt;2、部署 Blackbox，使⽤ Deployment；&lt;/li&gt;
&lt;li&gt;3、创建 Service、ingress，对外发布 Blackbox；&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;51-创建blackbox的配置文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#51-创建blackbox的配置文件&#34;&gt;#&lt;/a&gt; 5.1 创建 Blackbox 的配置⽂件&lt;/h5&gt;
&lt;p&gt;1、创建 ConfigMap 配置，定义 Blackbox 的检测⽅法，名称为 blackbox-configs&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 06-blackbox]# cat 01-blackbox-configs-configmap.yaml 
apiVersion: v1
kind: ConfigMap
metadata:
  name: blackbox-configs
  namespace: monitoring
data:
  blackbox.yml: |-
    modules:
      # http检查模块
      http_2xx:
        prober: http
        http:
          preferred_ip_protocol: &amp;quot;ip4&amp;quot;
          valid_http_versions: [ &amp;quot;HTTP/1.1&amp;quot;, &amp;quot;HTTP/2.0&amp;quot; ]
      # Http Post检查模块
      http_post_2xx:
        prober: http
        http:
          method: POST
          preferred_ip_protocol: &amp;quot;ip4&amp;quot;
          valid_http_versions: [ &amp;quot;HTTP/1.1&amp;quot;, &amp;quot;HTTP/2.0&amp;quot; ]
    
      # TCP检查模块
      tcp_connect:
        prober: tcp
        timeout: 5s
    
      # ICMP检查模块
      icmp:
        prober: icmp
        timeout: 5s
        icmp:
          preferred_ip_protocol: &amp;quot;ip4&amp;quot;
    
      # DNS检查模块
      dns_tcp:  
        prober: dns
        dns:
          transport_protocol: &amp;quot;tcp&amp;quot;
          preferred_ip_protocol: &amp;quot;ip4&amp;quot;
          query_name: &amp;quot;kubernetes.default.svc.cluster.local&amp;quot;

      # SSH检查模块
      ssh_banner:
        prober: tcp
        tcp:
          query_response:
          - expect: &amp;quot;^SSH-2.0-&amp;quot;
          - send: &amp;quot;SSH-2.0-blackbox-ssh-check&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、创建 configmap&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 06-blackbox]# kubectl apply -f 01-blackbox-configs-configmap.yaml 
configmap/blackbox-configs created
[root@k8s-master01 06-blackbox]# kubectl get cm -n monitoring
NAME               DATA   AGE
alert-configs      1      23h
alert-template     1      23h
blackbox-configs   1      1s
kube-root-ca.crt   1      24h
prom-configs       1      23h
prom-rules         6      23h
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;52-部署blackbox服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#52-部署blackbox服务&#34;&gt;#&lt;/a&gt; 5.2 部署 Blackbox 服务&lt;/h5&gt;
&lt;p&gt;编写 Blackbox 的部署清单⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 06-blackbox]# cat 02-blackbox-deployment.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blackbox
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: blackbox
  template:
    metadata:
      labels:
        app: blackbox
    spec:
      volumes:
      - name: blackbox-cfg
        configMap:
          name: blackbox-configs
      containers:
      - name: blackbox
        image: prom/blackbox-exporter:v0.24.0
        args:
        - &amp;quot;--web.listen-address=:9115&amp;quot;
        - &amp;quot;--config.file=/etc/blackbox_exporter/blackbox.yml&amp;quot;
        volumeMounts:
        - name: blackbox-cfg
          mountPath: /etc/blackbox_exporter
        ports:
        - containerPort: 9115

[root@k8s-master01 06-blackbox]# kubectl apply -f 02-blackbox-deployment.yaml
[root@k8s-master01 06-blackbox]# kubectl get pods -n monitoring
NAME                                READY   STATUS    RESTARTS            AGE
alertmanager-0                      1/1     Running   1 (20m ago)         23h
alertmanager-1                      1/1     Running   1 (&amp;lt;invalid&amp;gt; ago)   23h
alertmanager-2                      1/1     Running   1 (25m ago)         23h
blackbox-7c7c8db4f7-hqs4c           1/1     Running   0                   112s
grafana-0                           1/1     Running   0                   16m
prometheus-0                        1/1     Running   1 (19m ago)         23h
prometheus-1                        1/1     Running   1 (20m ago)         23h
webhook-dingding-6d68854649-r6smd   1/1     Running   1 (19m ago)         24h
webhook-wechat-54b5bbf677-rmr26     1/1     Running   1 (20m ago)         24h
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;53-发布blackbox服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#53-发布blackbox服务&#34;&gt;#&lt;/a&gt; 5.3 发布 blackbox 服务&lt;/h5&gt;
&lt;p&gt;1、创建 Service&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 06-blackbox]# cat 03-blackbox-service.yaml 
apiVersion: v1
kind: Service
metadata:
  name: blackbox-svc
  namespace: monitoring
spec:
  selector:
    app: blackbox
  ports:
  - name: http
    port: 9115
    targetPort: 9115

[root@k8s-master01 06-blackbox]# kubectl apply -f 03-blackbox-service.yaml 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、创建 Ingress&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 06-blackbox]# cat 04-blackbox-ingress.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: blackbox-ingress
  namespace: monitoring
spec:
  ingressClassName: &amp;quot;nginx&amp;quot;
  rules:
  - host: &amp;quot;k8s-blackbox.hmallleasing.com&amp;quot;
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: blackbox-svc
            port:
              number: 9115

[root@k8s-master01 06-blackbox]# kubectl apply -f 04-blackbox-ingress.yaml 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、访问 blackbox ⻚⾯&lt;/p&gt;
&lt;h4 id=&#34;image-202403112132301406-监控kubernetes集群节点&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#image-202403112132301406-监控kubernetes集群节点&#34;&gt;#&lt;/a&gt; &lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240311213230140.png&#34; alt=&#34;image-20240311213230140&#34; /&gt;6、监控 Kubernetes 集群节点&lt;/h4&gt;
&lt;p&gt;使⽤ Prometheus 监控 Kubernetes 集群中的 节点，⼤体需要如下⼏步：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、使⽤ DaemonSet 部署 Node_exporter&lt;/li&gt;
&lt;li&gt;2、使⽤ Prometheus 的 Kubernetes 服务发现功能，⾃动识别集群中的 Node 节点&lt;/li&gt;
&lt;li&gt;3、使⽤ relabeling 功能调整⽬标地址和端⼝：&lt;/li&gt;
&lt;li&gt;4、使⽤ relabel 功能，为节点增加⼀些必要的标签维度；&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;61-部署node-exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#61-部署node-exporter&#34;&gt;#&lt;/a&gt; 6.1 部署 Node-Exporter&lt;/h5&gt;
&lt;p&gt;使⽤ DaemonSet 部署 Node_exporter&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、使⽤ DaemonSet 部署 Node Exporter，确保设置 hostPID、hostIPC 和 hostNetwork 为 true，让 Node Exporter 容器能够访问宿主机的⽹络、进程和 IPC 空间。&lt;/li&gt;
&lt;li&gt;2、需要确保 Node Exporter 可以在所有节点上运⾏，包括 Master 节点，因此需要在 DaemonSet 的 Pod 规范中添加容忍度，允许调度到有污点的节点上运⾏。&lt;/li&gt;
&lt;li&gt;3、通过 volumeMounts，将宿主机的 /proc、/sys 和根⽬录 / 挂载到 Node Exporter 容器的相应位置。确保 Node Exporter 能够直接访问宿主机的系统信息。&lt;/li&gt;
&lt;li&gt;4、最后在 Node Exporter 的启动参数中，指定 /proc、/sys 等挂载后的路径，以便正确读取宿主机的数据。&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 07-node_exporter]# cat 01-node-exporter-daemonset.yaml 
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: node-exporter
  template:
    metadata:
      labels:
        app: node-exporter
    spec:
      hostPID: true
      hostIPC: true
      hostNetwork: true
      # 容忍度
      tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: &amp;quot;Exists&amp;quot;
      volumes:
      - name: proc
        hostPath:
          path: /proc
      - name: sys
        hostPath:
          path: /sys
      - name: root
        hostPath:
          path: /root
      containers:
      - name: node
        image: prom/node-exporter:v1.7.0
        args:
        - &amp;quot;--web.listen-address=:9100&amp;quot;
        - &amp;quot;--web.max-requests=40&amp;quot;
        - &amp;quot;--collector.mountstats&amp;quot;
        - &amp;quot;--collector.systemd&amp;quot;
        - &amp;quot;--collector.ethtool&amp;quot;
        - &amp;quot;--collector.tcpstat&amp;quot;
        - &amp;quot;--path.procfs=/host/proc&amp;quot;
        - &amp;quot;--path.sysfs=/host/sys&amp;quot;
        - &amp;quot;--path.rootfs=/host/root&amp;quot;
        volumeMounts:
        - name: proc
          mountPath: /host/proc
        - name: sys
          mountPath: /host/sys
        - name: root
          mountPath: /host/root
        ports:
        - containerPort: 9100
        resources:
          requests:
            cpu: 200m
            memory: 200Mi
          limits:
            cpu: 200m
            memory: 200Mi
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查 Node_exporter 的部署情况&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 07-node_exporter]# kubectl apply -f 01-node-exporter-daemonset.yaml 
[root@k8s-master01 07-node_exporter]# kubectl get pods -n monitoring -o wide|grep node-exporter
node-exporter-55bsf                 1/1     Running   0                   2m48s   192.168.40.103   k8s-master03   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
node-exporter-5ldbs                 1/1     Running   0                   2m48s   192.168.40.104   k8s-node01     &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
node-exporter-dj269                 1/1     Running   0                   2m48s   192.168.40.101   k8s-master01   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
node-exporter-kqdmg                 1/1     Running   0                   2m48s   192.168.40.102   k8s-master02   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
node-exporter-ml2sk                 1/1     Running   0                   2m48s   192.168.40.105   k8s-node02     &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;62-配置prometheus监控node&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#62-配置prometheus监控node&#34;&gt;#&lt;/a&gt; 6.2 配置 Prometheus 监控 Node&lt;/h5&gt;
&lt;p&gt;1、修改 Prometheus 的配置⽂件中，使⽤ kubernetes_sd_configs 配置项指定服务发现的⻆⾊为 node。这样 Prometheus 将会⾃动发现 Kubernetes 集群中的所有 Node，并获取它们的元数据。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat  01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]
      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]
  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重启 Prometheus，⽽后检查 Prometheus 的 Target&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#确保k8s-prom.hmallleasing.com可以解析
[root@k8s-master01 04-prometheus]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.40.101 k8s-master01
192.168.40.102 k8s-master02
192.168.40.103 k8s-master03 k8s-prom.hmallleasing.com
192.168.40.100 k8s-master-lb # 如果不是高可用集群，该IP为Master01的IP
192.168.40.104 k8s-node01
192.168.40.105 k8s-node02
[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240311222953117.png&#34; alt=&#34;image-20240311222953117&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;63-relabel修改抓取的节点端口&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#63-relabel修改抓取的节点端口&#34;&gt;#&lt;/a&gt; 6.3 relabel 修改抓取的节点端⼝&lt;/h5&gt;
&lt;p&gt;1、重新修改配置，通过 relabel ⽅式将 10250 端⼝，修改为 9100 端⼝&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]
      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
          
[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]
  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，发现端⼝变成了 9100，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240311223411745.png&#34; alt=&#34;image-20240311223411745&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;64-relabel为节点添加新标签&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#64-relabel为节点添加新标签&#34;&gt;#&lt;/a&gt; 6.4 relabel 为节点添加新标签&lt;/h5&gt;
&lt;p&gt;查询节点的元数据标签，发现如下的⼀些 labels，希望保留下来，以便在监控中提供更多的维度和上下⽂。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240311223515199.png&#34; alt=&#34;image-20240311223515199&#34; /&gt;&lt;/p&gt;
&lt;p&gt;1、修改 Prometheus 的配置⽂件，使⽤ labelmap 将标签映射到每个节点上。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]
      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap
          
[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]
  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，⽽后这些元数据是否附加到节点的 Labels 上了。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240311223925408.png&#34; alt=&#34;image-20240311223925408&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;65-导入节点可视化图形&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#65-导入节点可视化图形&#34;&gt;#&lt;/a&gt; 6.5 导⼊节点可视化图形&lt;/h5&gt;
&lt;p&gt;ID：16098&lt;/p&gt;
&lt;h4 id=&#34;7-监控k8s控制组件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#7-监控k8s控制组件&#34;&gt;#&lt;/a&gt; 7、监控 K8S 控制组件&lt;/h4&gt;
&lt;h5 id=&#34;71-监控控制平面组件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#71-监控控制平面组件&#34;&gt;#&lt;/a&gt; 7.1 监控控制平⾯组件&lt;/h5&gt;
&lt;p&gt;监控 Kubernetes 集群的控制平⾯，⾸先需要知道要监控哪些组件，然后了解它们是如何提供 Metrics 指标的，最后确定这些指标的监控⽅法，是通过⼿动配置还是⾃动发现。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;关键组件包括：APIServer、ControllerManager、Scheduler、etcd、CoreDNS、kubelet、kube-proxy&lt;/li&gt;
&lt;li&gt;Metrics 指标获取：这些控制平⾯组件都内建 Metrics 端点。但是某些组件可能默认只在本地接⼝（127.0.0.1）上暴露 Metrics，因此需要修改对应组件的配置，以确保这些 Metrics 可通过远程的⽅式进⾏访问。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;72-监控控制平面组件策略&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#72-监控控制平面组件策略&#34;&gt;#&lt;/a&gt; 7.2 监控控制平⾯组件策略&lt;/h5&gt;
&lt;p&gt;&lt;strong&gt;监控这些组件有两种主要⽅法：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、⼿动配置监控，在 Prometheus 配置⽂件中，⼿动指定每个控制器组件服务的地址和端⼝，来完成监控。很明显这种⽅式⾮常繁琐，且维护成本太⾼。&lt;/li&gt;
&lt;li&gt;2、⾃动化监控，利⽤ Kubernetes 的服务发现机制，来动态发现服务实例。有如下两种常⽤的⽅法&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;⾃动化监控⽅式：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、基于 endpoints 的服务发现，⾃动发现所有的 endpints 端点，然后使⽤ relabel 匹配，来保留符合条件的端点实例。&lt;/li&gt;
&lt;li&gt;2、基于 Pod 的服务发现，⾃动发现所有 Pod，然后使⽤ relabel 匹配，只保留符合标签条件的 Pod 实例。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;注意事项：&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;1、使⽤ endpoints 作为服务发现的⽅式，它要求被监控的⽬标必须有对应的 Service 才可以实现，否则⽆法获取端点。但基于 Pod 的发现⽅式不依赖是否有 Service。&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;2、不论采⽤哪种服务的发现⽅式，最终都必须通过 relabel 来基于标签筛选所需要的端点，因此获取所需要监控的⽬标标签，⾄关重要。&lt;/em&gt;&lt;/p&gt;
&lt;h5 id=&#34;73-监控apiserver&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#73-监控apiserver&#34;&gt;#&lt;/a&gt; 7.3 监控 APIServer&lt;/h5&gt;
&lt;h6 id=&#34;731-获取apiserver的metrics&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#731-获取apiserver的metrics&#34;&gt;#&lt;/a&gt; 7.3.1 获取 APIServer 的 Metrics&lt;/h6&gt;
&lt;p&gt;1、API-Server 在 https 协议的， 6443/metrics 接⼝上提供了指标数据。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]# netstat -lntp|grep 6443
tcp        0      0 127.0.0.1:16443         0.0.0.0:*               LISTEN      1126/haproxy        
tcp        0      0 0.0.0.0:16443           0.0.0.0:*               LISTEN      1126/haproxy        
tcp6       0      0 :::6443                 :::*                    LISTEN      2301/kube-apiserver 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、APIServer 有对应的 Service，所以采⽤ Endpints ⽅式发现服务，因此我们需要获取 APIServer 的 Service 标签（labels），以便 Prometheus 只抓取 APIServer 服务的 Pod 实例&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]#  kubectl describe service -n default kubernet
Name:              kubernetes
Namespace:         default
Labels:            component=apiserver
                   provider=kubernetes
Annotations:       &amp;lt;none&amp;gt;
Selector:          &amp;lt;none&amp;gt;
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.96.0.1
IPs:               10.96.0.1
Port:              https  443/TCP
TargetPort:        6443/TCP
Endpoints:         192.168.40.101:6443,192.168.40.102:6443,192.168.40.103:6443
Session Affinity:  None
Events:            &amp;lt;none&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;732-配置prometheus监控apiserver&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#732-配置prometheus监控apiserver&#34;&gt;#&lt;/a&gt; 7.3.2 配置 Prometheus 监控 APIServer&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： kube-apiserver ，metrics 路径是 /metrics ，协议是 https&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 Endpoints 来实现⾃动发现，由于 APIServer 采⽤的是 HTTPS，因此还需要指定 TLS 相关的配置；&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，仅保留标签名为 __meta_kubernetes_service_label_component ，标签值为 apiserver 。（会查询所有名称空间，意味着范围查询会更⼴）&lt;/li&gt;
&lt;li&gt;4、使⽤ relabel_configs，仅保留 __meta_kubernetes_namespace=default 、 __meta_kubernetes_service_name=kubernetes 并且 __meta_kubernetes_endpoint_port_name=https 的实例（明确名称空间和 service 名称，以及对应的端⼝，这种⽅式会更精准⼀些）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、修改 Prometheus 配置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过值映射获取标签
          replacement: $1
          action: labelmap
          
[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过值映射获取标签
      replacement: $1
      action: labelmap[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查最终结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240313214452728.png&#34; alt=&#34;image-20240313214452728&#34; /&gt;&lt;/p&gt;
&lt;h6 id=&#34;733-apiserver告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#733-apiserver告警规则文件&#34;&gt;#&lt;/a&gt; 7.3.3 APIServer 告警规则⽂件&lt;/h6&gt;
&lt;p&gt;1、编辑 Prometheus 的 Alert 规则⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  kube_apiserver_rules.yml: |-
    groups:
    - name: APIServer告警规则
      rules:
      - alert: APIServer请求错误率过高
        expr: |
          sum by (instance, namespace, job, group, code, resource, verb,subresource) (rate(apiserver_request_total&amp;#123;code=~&amp;quot;5..|4..&amp;quot;&amp;#125;[5m])) 
          /
          sum by (instance, namespace, job, group, code, resource, verb,subresource) (rate(apiserver_request_total[5m])) * 100  &amp;gt; 10
        for: 5m 
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;APIServer请求错误率超过10%&amp;quot;
          description: &amp;quot;APIServer实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 在命名空间 &amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 中的 &amp;#123;&amp;#123; $labels.group &amp;#125;&amp;#125; 组中 &amp;#123;&amp;#123; $labels.resource &amp;#125;&amp;#125; 类型请求错误率超过10%。当前错误率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%，请求类型: &amp;#123;&amp;#123; $labels.verb &amp;#125;&amp;#125;，状态码: &amp;#123;&amp;#123; $labels.code &amp;#125;&amp;#125;。&amp;quot;
    
      - alert: APIServer Mutating请求负载过高
        expr: avg_over_time(apiserver_current_inflight_requests&amp;#123;request_kind=&amp;quot;mutating&amp;quot;&amp;#125;[5m]) &amp;gt; (400 * 0.8)
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;APIServer Mutating请求负载过高&amp;quot;
          description: &amp;quot;APIServer处理变更性请求的平均负载超过了最大限制的80%。当前负载: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;。&amp;quot;
    
      - alert: APIServer ReadOnly请求负载过高
        expr: avg_over_time(apiserver_current_inflight_requests&amp;#123;request_kind=&amp;quot;readOnly&amp;quot;&amp;#125;[5m]) &amp;gt; (800 * 0.8)
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;APIServer ReadOnly请求负载过高&amp;quot;
          description: &amp;quot;APIServer处理只读请求的平均负载超过了最大限制的80%。当前负载: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;，实例: &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;，命名空间: &amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;。&amp;quot;
      
      - alert: APIServer平均延迟过高
        expr: |
          rate(apiserver_request_duration_seconds_sum&amp;#123;verb!=&amp;quot;WATCH&amp;quot;&amp;#125;[5m])
          /
          rate(apiserver_request_duration_seconds_count&amp;#123;verb!=&amp;quot;WATCH&amp;quot;&amp;#125;[5m]) &amp;gt; 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;APIServer平均延迟过高&amp;quot;
          description: &amp;quot;APIServer实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 对资源 &amp;#123;&amp;#123; $labels.resource &amp;#125;&amp;#125; 的 &amp;#123;&amp;#123; $labels.verb &amp;#125;&amp;#125; 请求的平均延迟超过5秒。当前平均延迟: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。&amp;quot;
          
[root@k8s-master01 04-prometheus]# kubectl apply -f 02-prom-rules-configmap.yaml 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]#  kubectl exec -it prometheus-0 -n monitoring -- ls /etc/prometheus/rules/
[root@k8s-master01 04-prometheus]#  kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/rules/kube_apiserver_rules.yml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查告警规则&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240313222355735.png&#34; alt=&#34;image-20240313222355735&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;74-监控k8s核心组件-controller&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#74-监控k8s核心组件-controller&#34;&gt;#&lt;/a&gt; 7.4 监控 K8S 核⼼组件 - Controller&lt;/h5&gt;
&lt;h6 id=&#34;741-获取controller的metrics&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#741-获取controller的metrics&#34;&gt;#&lt;/a&gt; 7.4.1 获取 Controller 的 Metrics&lt;/h6&gt;
&lt;p&gt;Controller Manager 默认在 10257/metrics 接⼝上提供了指标数据，默认情况下，ControllerManager 的 Metrics 接⼝仅在本地（127.0.0.1）地址监听，因此我们需要修改其监听地址的参数，将 --bind-address=127.0.0.1 修改为 --bind-address=0.0.0.0&lt;/p&gt;
&lt;p&gt;1、修改 ControllerManager Pod 的配置清单，所有的 master 节点都需修改，生产环境需分开修改，防止业务不可用。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]#  cat /etc/kubernetes/manifests/kube-controller-manager.yaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    component: kube-controller-manager
    tier: control-plane
  name: kube-controller-manager
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-controller-manager
    - --allocate-node-cidrs=true
    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --bind-address=0.0.0.0
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、在 Kubernetes 1.28 版本中，默认配置不再允许通过 HTTP 访问 ControllerManager 的 metrics 端点，因此必须使⽤ HTTPS。在本地测试访问 Controller Manager 的 Metrics ，我们可以使⽤已存在的 prometheus-sa 服务账户来创建⼀个令牌 (token)，然后在来访问 controllerManager 的 Metrics。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]# TOKEN=$(kubectl create token -n monitoring prometheus-sa)
[root@k8s-master01 ~]# curl -s -k -H &amp;quot;Authorization: Bearer $TOKEN&amp;quot; https://192.168.40.101:10257/metrics |grep kube-controller
leader_election_master_status&amp;#123;name=&amp;quot;kube-controller-manager&amp;quot;&amp;#125; 1
running_managed_controllers&amp;#123;manager=&amp;quot;kube-controller-manager&amp;quot;,name=&amp;quot;nodeipam&amp;quot;&amp;#125; 1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、Controller Manager 没有 Service，因此我们直接获取对应 Pod 的标签（labels），以便 Prometheus 只抓取提供 Controller Manager 服务的 Pod 实例。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# 查看kube-controllerManager的标签
[root@k8s-master01 ~]# kubectl describe pod -n kube-system kube-controller-manager-k8s-master01|grep -i label
Labels:               component=kube-controller-manager
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;742-配置prometheus监控controller&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#742-配置prometheus监控controller&#34;&gt;#&lt;/a&gt; 7.4.2 配置 Prometheus 监控 Controller&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： kube-controller ，metrics 路径是 /metrics ，协议是 https&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 Pod ⽅式实现⾃动发现，由于 ControllerManager 采⽤的是 HTTPS，因此还需要指定 TLS 相关的配置；&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，仅保留标签名为 __meta_kubernetes_pod_label_component ，标签值为 kube-controller-manager&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、修改 Prometheus 配置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap

      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
       
[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查最终结果&lt;/p&gt;
&lt;p&gt;抓取的 ControllerManager 的地址没错，但是端口不是 10257，而是 https 默认的 443，因此我们需要重新&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240314215117208.png&#34; alt=&#34;image-20240314215117208&#34; /&gt;&lt;/p&gt;
&lt;h6 id=&#34;743-relabel修改抓取的pod端口&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#743-relabel修改抓取的pod端口&#34;&gt;#&lt;/a&gt; 7.4.3 relabel 修改抓取的 Pod 端⼝&lt;/h6&gt;
&lt;p&gt;1、修改 Prometheus 配置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
          
[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml     
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查最终结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240314215543314.png&#34; alt=&#34;image-20240314215543314&#34; /&gt;&lt;/p&gt;
&lt;h6 id=&#34;744-relabel为pod添加新标签&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#744-relabel为pod添加新标签&#34;&gt;#&lt;/a&gt; 7.4.4 relabel 为 Pod 添加新标签&lt;/h6&gt;
&lt;p&gt;Pod 的元数据标签，我们希望保留 __meta_kubernetes_namespace、__meta_kubernetes_pod_name ，这两个维度的标签。&lt;/p&gt;
&lt;p&gt;1、修改 Prometheus 配置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name


[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查最终结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240314220057566.png&#34; alt=&#34;image-20240314220057566&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;75-监控k8s核心组件-scheduler&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#75-监控k8s核心组件-scheduler&#34;&gt;#&lt;/a&gt; 7.5 监控 K8S 核⼼组件 - Scheduler&lt;/h5&gt;
&lt;h6 id=&#34;751-获取scheduler的metrics&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#751-获取scheduler的metrics&#34;&gt;#&lt;/a&gt; 7.5.1 获取 Scheduler 的 Metrics&lt;/h6&gt;
&lt;p&gt;Scheduler 默认在 10259/metrics 接⼝上提供了指标数据，默认情况下，Scheduler 的 Metrics 接⼝仅在本地（127.0.0.1）地址监听，因此我们需要修改其监听地址的参数，将 --bind-address=127.0.0.1 修改为 --bind-address=0.0.0.0。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]# netstat -lntp|grep 10259
tcp        0      0 127.0.0.1:10259         0.0.0.0:*               LISTEN      1762/kube-scheduler 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;1、修改 Scheduler Pod 的配置清单，3 台 master 都需修改，生产环境需不要同时修改，避免业务不可用。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]# cat /etc/kubernetes/manifests/kube-scheduler.yaml 
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    component: kube-scheduler
    tier: control-plane
  name: kube-scheduler
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-scheduler
    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf
    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf
    - --bind-address=0.0.0.0
    - --kubeconfig=/etc/kubernetes/scheduler.conf
...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、本地测试访问 Scheduler 的 Metrics ，我们可以使⽤已存在的 prometheussa 服务账户来创建⼀个令牌 (token)，然后在来访问 Scheduler 的 Metrics。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]# TOKEN=$(kubectl create token -n monitoring prometheus-sa)
[root@k8s-master01 ~]# curl -s -k -H &amp;quot;Authorization: Bearer $TOKEN&amp;quot; https://192.168.40.101:10259/metrics |grep kube-scheduler
leader_election_master_status&amp;#123;name=&amp;quot;kube-scheduler&amp;quot;&amp;#125; 1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、Scheduler 没有 Service，因此我们直接获取对应 Pod 的标签（labels），以便 Prometheus 只抓取提供 Scheduler 服务的 Pod 实例。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]# kubectl describe pod kube-scheduler-k8s-master01  -n kube-system
Name:                 kube-scheduler-k8s-master01
Namespace:            kube-system
Priority:             2000001000
Priority Class Name:  system-node-critical
Node:                 k8s-master01/192.168.40.101
Start Time:           Sun, 17 Mar 2024 13:59:17 +0800
Labels:               component=kube-scheduler
                      tier=control-plane
...
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;752-配置prometheus监控scheduler&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#752-配置prometheus监控scheduler&#34;&gt;#&lt;/a&gt; 7.5.2 配置 Prometheus 监控 Scheduler&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： kube-scheduler ，metrics 路径是 /metrics ，协议是 https&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 Pod 来实现⾃动发现，由于 scheduler 采⽤的是 HTTPS，因此还需要指定 TLS 相关的配置；&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，仅保留标签名为 __meta_kubernetes_pod_label_component ，标签值为 kube-scheduler&lt;/li&gt;
&lt;li&gt;4、使⽤ relabel_configs，修改抓取 Pod 的端⼝为 10259，默认 pod ⾃动抓取的实例，使⽤ http80 端⼝和 https443 端⼝；&lt;/li&gt;
&lt;li&gt;5、使⽤ relabel_configs，保留 __meta_kubernetes_namespace、___meta_kubernetes_pod_name ，这两个维度的标签。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、修改 Prometheus 配置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控Scheduler
  - job_name: &amp;quot;kube-schduler&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 基于标签进行过滤
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-scheduler&amp;quot;
      action: keep

    # 修订抓取的端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:10259
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240317141321154.png&#34; alt=&#34;image-20240317141321154&#34; /&gt;&lt;/p&gt;
&lt;h6 id=&#34;753-schedule告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#753-schedule告警规则文件&#34;&gt;#&lt;/a&gt; 7.5.3 Schedule 告警规则⽂件&lt;/h6&gt;
&lt;p&gt;1、编写告警规则⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  kube_scheduler_rules.yml: |-
    groups:
    - name: scheduler告警规则文件
      rules:
      - alert: 调度器每秒调度Pod次数过高
        expr: rate(scheduler_pod_scheduling_attempts_sum[1m]) &amp;gt; 20
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;调度器每秒调度Pod次数过高 (当前值: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;次)&amp;quot;
          description: &amp;quot;调度器实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 在过去的一分钟内每秒调度的Pod次数超过了20次，当前值为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;次。&amp;quot;
    
    
      - alert: Pending状态的Pod数量过多
        expr: avg_over_time(scheduler_pending_pods&amp;#123;queue!=&amp;quot;active&amp;quot;&amp;#125;[5m]) &amp;gt; 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;Pending状态的Pod数量过多 (当前值: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;个)&amp;quot;
          description: &amp;quot;调度器实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 在过去五分钟内处于Pending状态的Pod数量平均超过了10个，当前值为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;个。&amp;quot;
    
    
      - alert: &#39;Pod平均调度尝试次数过多&#39;
        expr: avg(rate(scheduler_pod_scheduling_attempts_sum[5m])) by (instance, job, pod_name) &amp;gt; 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;Pod平均调度尝试次数过多 (当前值: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;次)&amp;quot;
          description: &amp;quot;调度器实例 `&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;` 的Pod在过去五分钟内平均尝试调度次数超过5次，当前值为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;次。&amp;quot;
    
      - alert: &#39;调度器扩展点平均延迟过高&#39;
        expr: | 
          rate(scheduler_framework_extension_point_duration_seconds_sum[5m])
          /
          rate(scheduler_framework_extension_point_duration_seconds_count[5m]) &amp;gt; 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;调度器扩展点平均延迟过高 (当前值: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒)&amp;quot;
          description: &amp;quot;调度器实例 `&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;` 的扩展点 `&amp;#123;&amp;#123; $labels.extension_point &amp;#125;&amp;#125;` 在过去五分钟内平均延迟超过了1秒，当前值为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;76-监控k8s核心组件-etcd&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#76-监控k8s核心组件-etcd&#34;&gt;#&lt;/a&gt; 7.6 监控 K8S 核⼼组件 - Etcd&lt;/h5&gt;
&lt;h6 id=&#34;761-获取etcd的metrics&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#761-获取etcd的metrics&#34;&gt;#&lt;/a&gt; 7.6.1 获取 Etcd 的 Metrics&lt;/h6&gt;
&lt;p&gt;etcd 默认在 2381/metrics 接⼝上提供了指标数据，默认情况下，etcd 的 Metrics 接⼝仅在本地（127.0.0.1）地址监听，因此我们需要修改其监听地址的参数，将 --listen-metrics-urls=http://127.0.0.1:2381 修改为 ---listen-metrics-urls=http://0.0.0.0:2381&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# netstat -lntp|grep 2381
tcp        0      0 127.0.0.1:2381          0.0.0.0:*               LISTEN      1808/etcd 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;1、修改 etcd Pod 的配置清单，3 台 master 都需修改，生产环境需不要同时修改，避免业务不可用。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat /etc/kubernetes/manifests/etcd.yaml 
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubeadm.kubernetes.io/etcd.advertise-client-urls: https://192.168.40.101:2379
  creationTimestamp: null
  labels:
    component: etcd
    tier: control-plane
  name: etcd
  namespace: kube-system
spec:
  containers:
  - command:
    - etcd
    - --advertise-client-urls=https://192.168.40.101:2379
    - --cert-file=/etc/kubernetes/pki/etcd/server.crt
    - --client-cert-auth=true
    - --data-dir=/var/lib/etcd
    - --experimental-initial-corrupt-check=true
    - --experimental-watch-progress-notify-interval=5s
    - --initial-advertise-peer-urls=https://192.168.40.101:2380
    - --initial-cluster=k8s-master01=https://192.168.40.101:2380
    - --key-file=/etc/kubernetes/pki/etcd/server.key
    - --listen-client-urls=https://127.0.0.1:2379,https://192.168.40.101:2379
    - --listen-metrics-urls=http://0.0.0.0:2381
    - --listen-peer-urls=https://192.168.40.101:2380
...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、本地访问 etcd 的 Metrics&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]#  curl -s http://192.168.40.101:2381/metrics |grep etcd|head -n 10
# HELP etcd_cluster_version Which version is running. 1 for &#39;cluster_version&#39; label with current cluster version
# TYPE etcd_cluster_version gauge
etcd_cluster_version&amp;#123;cluster_version=&amp;quot;3.5&amp;quot;&amp;#125; 1
# HELP etcd_debugging_auth_revision The current revision of auth store.
# TYPE etcd_debugging_auth_revision gauge
etcd_debugging_auth_revision 1
# HELP etcd_debugging_disk_backend_commit_rebalance_duration_seconds The latency distributions of commit.rebalance called by bboltdb backend.
# TYPE etcd_debugging_disk_backend_commit_rebalance_duration_seconds histogram
etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&amp;#123;le=&amp;quot;0.001&amp;quot;&amp;#125; 933
etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket&amp;#123;le=&amp;quot;0.002&amp;quot;&amp;#125; 933
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、etcd 没有 Service，因此我们直接获取对应 Pod 的标签（labels），以便 Prometheus 只抓取提供 etcd 服务的 Pod 实例。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl describe pods etcd-k8s-master01 -n kube-system
Name:                 etcd-k8s-master01
Namespace:            kube-system
Priority:             2000001000
Priority Class Name:  system-node-critical
Node:                 k8s-master01/192.168.40.101
Start Time:           Sun, 17 Mar 2024 13:48:58 +0800
Labels:               component=etcd
                      tier=control-plane
...
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;762-配置prometheus监控etcd&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#762-配置prometheus监控etcd&#34;&gt;#&lt;/a&gt; 7.6.2 配置 Prometheus 监控 Etcd&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： kube-etcd ，metrics 路径是 /metrics，协议是 http&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 Pod 来实现⾃动发现；&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，仅保留标签名为 __meta_kubernetes_pod_label_component ，标签值为 etcd&lt;/li&gt;
&lt;li&gt;4、使⽤ relabel_configs，修改抓取 Pod 的端⼝为 2381，默认 pod ⾃动抓取的实例，使⽤ http80 端⼝和 https443 端⼝；&lt;/li&gt;
&lt;li&gt;5、使⽤ relabel_configs，保留 ____meta_kubernetes_namespace、__meta_kubernetes_pod_name ，这两个维度的标签。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、修改 Prometheus 配置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控etcd
      - job_name: &amp;quot;kube-etcd&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;etcd&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:2381
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控Scheduler
  - job_name: &amp;quot;kube-schduler&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 基于标签进行过滤
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-scheduler&amp;quot;
      action: keep

    # 修订抓取的端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:10259
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控etcd
  - job_name: &amp;quot;kube-etcd&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;etcd&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:2381
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240317144233242.png&#34; alt=&#34;image-20240317144233242&#34; /&gt;&lt;/p&gt;
&lt;h6 id=&#34;763-etcd告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#763-etcd告警规则文件&#34;&gt;#&lt;/a&gt; 7.6.3 Etcd 告警规则⽂件&lt;/h6&gt;
&lt;pre&gt;&lt;code&gt;  kube_etcd_rules.yml: |-
    groups:
    - name: etcd告警规则文件
      rules:
      - alert: Etcd成员异常下线
        expr: count(etcd_server_id) by (job) % 2 == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;Etcd成员异常下线&amp;quot;
          description: &amp;quot;Etcd集群成员数量为偶数，可能有成员下线导致集群无法正常提供服务。&amp;quot;
    
      - alert: Etcd通信异常
        expr: etcd_server_has_leader == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;Etcd通信异常 (实例: &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;)&amp;quot;
          description: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的Etcd节点无法与集群中的其它节点通信。&amp;quot;
    
    
      - alert: Etcd领导者变更频繁
        expr: rate(etcd_server_leader_changes_seen_total[5m]) &amp;gt; 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;Etcd领导者变更频繁 (实例: &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;)&amp;quot;
          description: &amp;quot;在过去的5分钟内，实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的Etcd领导者变更次数超过了5次，这可能会影响集群稳定性。&amp;quot;
    
      - alert: Etcd后端提交到磁盘耗时异常
        expr: |
          sum by (instance, job, pod_name) (rate(etcd_disk_backend_commit_duration_seconds_sum[5m])) 
          / 
          sum by (instance, job, pod_name) (rate(etcd_disk_backend_commit_duration_seconds_count[5m])) &amp;gt; 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;Etcd后端提交耗时异常 (实例: &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;)&amp;quot;
          description: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的Etcd后端在过去5分钟内提交到磁盘的操作平均耗时超过了2秒。&amp;quot;
    
    
      - alert: Etcd wal日志fsync耗时异常
        expr: |
          sum by (instance, job, pod_name) (rate(etcd_disk_wal_fsync_duration_seconds_sum[5m]))
          /
          sum by (instance, job, pod_name) (rate(etcd_disk_wal_fsync_duration_seconds_count[5m])) &amp;gt; 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;Etcd wal日志fsync耗时异常 (实例: &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;)&amp;quot;
          description: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的Etcd节点在过去5分钟内日志文件的fsync调用平均耗时超过了2秒。&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;764-导入etcd图形&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#764-导入etcd图形&#34;&gt;#&lt;/a&gt; 7.6.4 导⼊ Etcd 图形&lt;/h6&gt;
&lt;p&gt;导⼊ ID：9733&lt;/p&gt;
&lt;h5 id=&#34;77-监控k8s核心组件-coredns&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#77-监控k8s核心组件-coredns&#34;&gt;#&lt;/a&gt; 7.7 监控 K8S 核⼼组件 - CoreDNS&lt;/h5&gt;
&lt;h6 id=&#34;771-获取coredns的metrics&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#771-获取coredns的metrics&#34;&gt;#&lt;/a&gt; 7.7.1 获取 CoreDNS 的 Metrics&lt;/h6&gt;
&lt;p&gt;1、CoreDNS 通过 9153 端⼝的 /metrics 路径提供指标数据。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl get svc -n kube-system
NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                  AGE
calico-typha     ClusterIP   10.96.237.85   &amp;lt;none&amp;gt;        5473/TCP                 198d
kube-dns         ClusterIP   10.96.0.10     &amp;lt;none&amp;gt;        53/UDP,53/TCP,9153/TCP   198d
metrics-server   ClusterIP   10.96.23.183   &amp;lt;none&amp;gt;        443/TCP                  198d

[root@k8s-master01 04-prometheus]# curl -s http://10.96.0.10:9153/metrics|head -n 10
# HELP coredns_build_info A metric with a constant &#39;1&#39; value labeled by version, revision, and goversion from which CoreDNS was built.
# TYPE coredns_build_info gauge
coredns_build_info&amp;#123;goversion=&amp;quot;go1.20&amp;quot;,revision=&amp;quot;055b2c3&amp;quot;,version=&amp;quot;1.10.1&amp;quot;&amp;#125; 1
# HELP coredns_cache_entries The number of elements in the cache.
# TYPE coredns_cache_entries gauge
coredns_cache_entries&amp;#123;server=&amp;quot;dns://:53&amp;quot;,type=&amp;quot;denial&amp;quot;,view=&amp;quot;&amp;quot;,zones=&amp;quot;.&amp;quot;&amp;#125; 39
coredns_cache_entries&amp;#123;server=&amp;quot;dns://:53&amp;quot;,type=&amp;quot;success&amp;quot;,view=&amp;quot;&amp;quot;,zones=&amp;quot;.&amp;quot;&amp;#125; 12
# HELP coredns_cache_hits_total The count of cache hits.
# TYPE coredns_cache_hits_total counter
coredns_cache_hits_total&amp;#123;server=&amp;quot;dns://:53&amp;quot;,type=&amp;quot;denial&amp;quot;,view=&amp;quot;&amp;quot;,zones=&amp;quot;.&amp;quot;&amp;#125; 878
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、CoreDNS 有对应的 Service，因此我们需要获取 DNS 对应的 Service 的标签（labels），以便 Prometheus 只抓取提供 DNS 服务的 Pod 实例。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl describe svc kube-dns -n kube-system
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
                   kubernetes.io/cluster-service=true
                   kubernetes.io/name=CoreDNS
...
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;772-配置prometheus监控dns&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#772-配置prometheus监控dns&#34;&gt;#&lt;/a&gt; 7.7.2 配置 Prometheus 监控 DNS&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： kube-dns ，metrics 路径是 /metrics ，协议是 http&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 endpoints 来实现⾃动发现；&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，仅保留标签名为 __meta_kubernetes_service_label_k8s_app ，标签值为 kube-dns&lt;/li&gt;
&lt;li&gt;4、使⽤ relabel_configs，重新调整 Pod 的端⼝，将标签 __meta_kubernetes_pod_ip 修改为 IP:9153 端⼝。默认将匹配到的 53、9153 端⼝ ，都视作⼀独⽴的实例。&lt;/li&gt;
&lt;li&gt;5、使⽤ relabel_configs，保留 ___meta_kubernetes_namespace、____meta_kubernetes_pod_name、__meta_kubernetes_service_name ，这三个维度的标签。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、修改 Prometheus 配置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控etcd
      - job_name: &amp;quot;kube-etcd&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;etcd&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:2381
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控CoreDNS
      - job_name: &amp;quot;kube-dns&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-dns&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:9153
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控Scheduler
  - job_name: &amp;quot;kube-schduler&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 基于标签进行过滤
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-scheduler&amp;quot;
      action: keep

    # 修订抓取的端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:10259
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控etcd
  - job_name: &amp;quot;kube-etcd&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;etcd&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:2381
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控CoreDNS
  - job_name: &amp;quot;kube-dns&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-dns&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:9153
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240317151422648.png&#34; alt=&#34;image-20240317151422648&#34; /&gt;&lt;/p&gt;
&lt;h6 id=&#34;773-coredns告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#773-coredns告警规则文件&#34;&gt;#&lt;/a&gt; 7.7.3 CoreDNS 告警规则⽂件&lt;/h6&gt;
&lt;p&gt;1、编写告警规则⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  kube_coredns_rules.yml: |-
    groups:
    - name: CoreDNS告警规则文件
      rules:
      - alert: CoreDNS SERVFAIL响应率过高
        expr: |
          sum(rate(coredns_dns_responses_total&amp;#123;rcode=&amp;quot;SERVFAIL&amp;quot;&amp;#125;[5m])) by (instance, job, server, pod_name, zone) &amp;gt; 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 CoreDNS SERVFAIL 响应率过高&amp;quot;
          description: &amp;quot;在过去5分钟内，实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;，CoreDNS Pod名称 &amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;，服务端点 &amp;#123;&amp;#123; $labels.server &amp;#125;&amp;#125;，区域 &amp;#123;&amp;#123; $labels.zone &amp;#125;&amp;#125; 的SERVFAIL响应率超过了10次，当前值：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;次/秒。请检查CoreDNS服务状态。&amp;quot;
  
      - alert: CoreDNS域名解析时延过高
        expr: |
          sum(rate(coredns_dns_request_duration_seconds_sum[5m])) by (instance, job, server, pod_name, zone)
          /
          sum(rate(coredns_dns_request_duration_seconds_count[5m])) by (instance, job, server, pod_name, zone) &amp;gt; 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 CoreDNS 解析时延超过1秒&amp;quot;
          description: &amp;quot;在过去5分钟内，实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;，CoreDNS Pod名称 &amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;，服务端点 &amp;#123;&amp;#123; $labels.server &amp;#125;&amp;#125;，区域 &amp;#123;&amp;#123; $labels.zone &amp;#125;&amp;#125; 的平均域名解析时延超过了1秒，当前平均时延：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;774-导入coredns图形&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#774-导入coredns图形&#34;&gt;#&lt;/a&gt; 7.7.4 导⼊ CoreDNS 图形&lt;/h6&gt;
&lt;p&gt;导⼊ ID：15762&lt;/p&gt;
&lt;h5 id=&#34;78-监控k8s核心组件-kubeproxy&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#78-监控k8s核心组件-kubeproxy&#34;&gt;#&lt;/a&gt; 7.8 监控 K8S 核⼼组件 - Kubeproxy&lt;/h5&gt;
&lt;h6 id=&#34;781-获取kube-proxy的metrics&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#781-获取kube-proxy的metrics&#34;&gt;#&lt;/a&gt; 7.8.1 获取 kube-proxy 的 Metrics&lt;/h6&gt;
&lt;p&gt;1、Kube-Proxy 在 10249/metrics 接⼝上提供指标数据，默认情况下 kube-proxy 的 Metrics 接⼝仅在本地（127.0.0.1）地址监听，因此我们需要修改其监听地址的参数，将 metricsBindAddress: &amp;quot;&amp;quot;修改 metricsBindAddress:&amp;quot;0.0.0.0&amp;quot; ，然后重启 kube-proxy&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]#  kubectl edit configmap -n kube-system kube-proxy
...
    kind: KubeProxyConfiguration
    metricsBindAddress: &amp;quot;0.0.0.0&amp;quot;
    mode: &amp;quot;ipvs&amp;quot;
    nodePortAddresses: null
    oomScoreAdj: null
    portRange: &amp;quot;&amp;quot;
    showHiddenMetricsForVersion: &amp;quot;&amp;quot;
    winkernel:
...

# 重启kube-proxy的pod
[root@k8s-master01 04-prometheus]#  kubectl rollout restart daemonset -n kube-system kube-proxy
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查 kube-proxy 的监听地址&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]#  netstat -lntp |grep kube-proxy
tcp6       0      0 :::10256                :::*                    LISTEN      60042/kube-proxy    
tcp6       0      0 :::10249                :::*                    LISTEN      60042/kube-proxy 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、kube-proxy 没有 Service，因此我们直接获取对应 Pod 的标签（labels），以便 Prometheus 只抓取提供 kube-proxy 服务的 Pod 实例。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]#  kubectl describe daemonsets.apps -n kube-system kube-proxy
Name:           kube-proxy
Selector:       k8s-app=kube-proxy
Node-Selector:  kubernetes.io/os=linux
Labels:         k8s-app=kube-proxy
Annotations:    deprecated.daemonset.template.generation: 3
...
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;782-配置prometheus监控kube-proxy&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#782-配置prometheus监控kube-proxy&#34;&gt;#&lt;/a&gt; 7.8.2 配置 Prometheus 监控 kube-proxy&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： kube-proxy ，metrics 路径是 /metrics ，协议是 http&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 pod 来实现⾃动发现；&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，仅保留标签名为 __meta_kubernetes_pod_label_k8s_app ，标签值为 kube-proxy&lt;/li&gt;
&lt;li&gt;4、使⽤ relabel_configs，重新调整 Pod 的端⼝，将标签 __meta_kubernetes_pod_ip 修改为 IP:10249 端⼝，默认 Pod 的⾃动发现端⼝ http 是 80，https 是 443。&lt;/li&gt;
&lt;li&gt;5、使⽤ relabel_configs，保留 __meta_kubernetes_namespace、__meta_kubernetes_pod_name ，这两个维度的标签。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、修改 Prometheus 配置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控etcd
      - job_name: &amp;quot;kube-etcd&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;etcd&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:2381
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控CoreDNS
      - job_name: &amp;quot;kube-dns&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-dns&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:9153
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name

      # 监控kube-proxy
      - job_name: &amp;quot;kube-proxy&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-proxy&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:10249
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控Scheduler
  - job_name: &amp;quot;kube-schduler&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 基于标签进行过滤
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-scheduler&amp;quot;
      action: keep

    # 修订抓取的端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:10259
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控etcd
  - job_name: &amp;quot;kube-etcd&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;etcd&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:2381
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控CoreDNS
  - job_name: &amp;quot;kube-dns&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-dns&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:9153
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name

  # 监控kube-proxy
  - job_name: &amp;quot;kube-proxy&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-proxy&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:10249
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240317153148617.png&#34; alt=&#34;image-20240317153148617&#34; /&gt;&lt;/p&gt;
&lt;h6 id=&#34;783-kube-proxy告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#783-kube-proxy告警规则文件&#34;&gt;#&lt;/a&gt; 7.8.3 Kube-Proxy 告警规则⽂件&lt;/h6&gt;
&lt;p&gt;1、编写告警规则⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  kube_proxy_rules.yml: |-
    groups:
    - name: kube-proxy告警规则文件
      rules:
      - alert: KubeProxy同步时间过长
        expr: |
          rate (kubeproxy_sync_proxy_rules_duration_seconds_sum[5m]) /
          rate (kubeproxy_sync_proxy_rules_duration_seconds_count[5m]) &amp;gt; 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;kube-proxy同步时间过长 (实例: &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;)&amp;quot;
          description: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;, kube-proxy同步操作的平均时间超过了3秒。该Pod &amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125; 当前同步延迟：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;/s&amp;quot;
      
      - alert: Iptables规则同步失败次数过多
        expr: rate(kubeproxy_sync_proxy_rules_iptables_restore_failures_total[5m]) &amp;gt; 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;Iptables同步失败告警 (实例: &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;)&amp;quot;
          description: &amp;quot;实例 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;, iptables规则同步失败次数超过10次。该Pod &amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125; 当前失败次数：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;79-监控kubernetes集群资源状态&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#79-监控kubernetes集群资源状态&#34;&gt;#&lt;/a&gt; 7.9 监控 Kubernetes 集群资源状态&lt;/h5&gt;
&lt;h6 id=&#34;791-什么是集群资源状态&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#791-什么是集群资源状态&#34;&gt;#&lt;/a&gt; 7.9.1 什么是集群资源状态&lt;/h6&gt;
&lt;p&gt;集群资源状态是指， Kubernetes 集群中所有资源对象、以及这些资源对象的当前状态信息。这些资源对象，包括 Pod、Deployment、DaemonSet、StatefulSet、Job、CronJob 等 。⽽这些资源状态，则提供了这些资源的详细信息，例如：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、当前集群中资源的数量；&lt;/li&gt;
&lt;li&gt;2、当前集群中总共有多少个 Pod，分别处于什么状态（如 Running、Stopped、Terminated）。&lt;/li&gt;
&lt;li&gt;3、有多少个 Deployment 正在运⾏，以及它们正在运⾏的 Pod 副本数量与实际期望运⾏的 Pod 副本数是否⼀致。&lt;/li&gt;
&lt;li&gt;3、DaemonSet 控制的 Pod 是否已经在所有（或指定的）节点上运⾏。&lt;/li&gt;
&lt;li&gt;4、Job 和 CronJob 是否按预定计划运⾏，以及执⾏成功与否。&lt;/li&gt;
&lt;li&gt;...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;但是在 Kubernetes 中的组件，并不提供关于资源状态的指标。因此我们需要使⽤ kube-state-metrics ，因为 kube-state-metrics 它会主动收集关于 Kubernetes 集群中的各种资源的状态信息。如 Pod、Deployment、Job 以及它们的数量、运⾏状况等，⽽后将些信息转换成 Prometheus 所兼容的指标格式，进⽽让 Prometheus 能抓取这些指标，并进⾏分析与展示。&lt;/p&gt;
&lt;h6 id=&#34;792-安装kube-state-metrics&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#792-安装kube-state-metrics&#34;&gt;#&lt;/a&gt; 7.9.2 安装 Kube-State-Metrics&lt;/h6&gt;
&lt;p&gt;kube-state-metrics 版本与 kubernetes 的版本对应关系（注意版本要兼容）&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;kube-state-metrics&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;Kubernetes client-go Version&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v2.6.0&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v1.24&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v2.7.0&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v1.25&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v2.8.2&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v1.26&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v2.9.2&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v1.26&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v2.10.0&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v1.27&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;main&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;v1.28&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;1、安装 kube-state-metrics，⾸先克隆最新分⽀的源代码&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]# yum install git -y
[root@k8s-master01 ~]#  git clone https://github.com/kubernetes/kube-state-metrics.git
# 加速地址
[root@k8s-master01 ~]# git clone https://mirror.ghproxy.com/https://github.com/kubernetes/kube-state-metrics.git
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、修改 kube-state-metrics/examples/standard/deployment.yaml 镜像为国内的镜像&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]# cat kube-state-metrics/examples/standard/deployment.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: kube-state-metrics
    app.kubernetes.io/version: 2.11.0
  name: kube-state-metrics
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: kube-state-metrics
  template:
    metadata:
      labels:
        app.kubernetes.io/component: exporter
        app.kubernetes.io/name: kube-state-metrics
        app.kubernetes.io/version: 2.11.0
    spec:
      automountServiceAccountToken: true
      containers:
#      - image: registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.11.0
      - image: uhub.service.ucloud.cn/oldxu/kube-state-metrics:v2.10.0
...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、应⽤资源清单⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 ~]#  kubectl apply -f kube-state-metrics/examples/standard/
clusterrolebinding.rbac.authorization.k8s.io/kube-state-metrics created
clusterrole.rbac.authorization.k8s.io/kube-state-metrics created
deployment.apps/kube-state-metrics created
serviceaccount/kube-state-metrics created
service/kube-state-metrics created
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、 Kube-state-metrics 的 Pod 运⾏在 kube-system 名称空间&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 standard]# kubectl get pods,svc -n kube-system -l app.kubernetes.io/name=kube-state-metrics
NAME                                      READY   STATUS    RESTARTS   AGE
pod/kube-state-metrics-5864c7d699-mwbp4   1/1     Running   0          2m15s

NAME                         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE
service/kube-state-metrics   ClusterIP   None         &amp;lt;none&amp;gt;        8080/TCP,8081/TCP   2m15s
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;5、 Kube-state-metrics 有提供 Service ，因此我们需要获取 Service 的标签（labels），以便 Prometheus 只抓取提供 Kube-state-metrics 服务的实例。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 standard]# curl -s http://172.16.85.199:8080/metrics | head -n 10
# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
# TYPE go_gc_duration_seconds summary
go_gc_duration_seconds&amp;#123;quantile=&amp;quot;0&amp;quot;&amp;#125; 2.1866e-05
go_gc_duration_seconds&amp;#123;quantile=&amp;quot;0.25&amp;quot;&amp;#125; 8.7894e-05
go_gc_duration_seconds&amp;#123;quantile=&amp;quot;0.5&amp;quot;&amp;#125; 0.000165906
go_gc_duration_seconds&amp;#123;quantile=&amp;quot;0.75&amp;quot;&amp;#125; 0.000179164
go_gc_duration_seconds&amp;#123;quantile=&amp;quot;1&amp;quot;&amp;#125; 0.000420888
go_gc_duration_seconds_sum 0.001599982
go_gc_duration_seconds_count 10
# HELP go_goroutines Number of goroutines that currently exist.

[root@k8s-master01 standard]#  kubectl describe service -n kube-system kube-state-metrics
Name:              kube-state-metrics
Namespace:         kube-system
Labels:            app.kubernetes.io/component=exporter
                   app.kubernetes.io/name=kube-state-metrics
                   app.kubernetes.io/version=2.11.0
...
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;793-配置prometheus监控ksm&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#793-配置prometheus监控ksm&#34;&gt;#&lt;/a&gt; 7.9.3 配置 Prometheus 监控 KSM&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： kube-state-metrics ，metrics 路径是 /metrics ，协议是 http&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 endpoints 来⾃动发现所有的 endpoints 端点；&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，仅保留标签名 __meta_kubernetes_service_label_app_kubernetes_io_name ，标签值是 kube-state-metrics 的实例。&lt;/li&gt;
&lt;li&gt;4、使⽤ relabel_configs，重新调整 Pod 的端⼝，将标签 __meta_kubernetes_pod_ip 修改为 IP:8080 端⼝。&lt;/li&gt;
&lt;li&gt;5、使⽤ relabel_configs，映射 _&lt;em&gt;meta_kubernetes_service_label&lt;/em&gt; (.*) ，所有的标签以及标签值。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、配置 Prometheus&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控etcd
      - job_name: &amp;quot;kube-etcd&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;etcd&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:2381
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控CoreDNS
      - job_name: &amp;quot;kube-dns&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-dns&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:9153
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name

      # 监控kube-proxy
      - job_name: &amp;quot;kube-proxy&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-proxy&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:10249
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控kube-state-metrics
      - job_name: &amp;quot;kube-state-metrics&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
          regex: &amp;quot;kube-state-metrics&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:8080
          target_label: __address__

        # 添加维度标签
        - regex: __meta_kubernetes_service_label_(.*)
          action: labelmap

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]#  kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控Scheduler
  - job_name: &amp;quot;kube-schduler&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 基于标签进行过滤
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-scheduler&amp;quot;
      action: keep

    # 修订抓取的端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:10259
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控etcd
  - job_name: &amp;quot;kube-etcd&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;etcd&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:2381
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控CoreDNS
  - job_name: &amp;quot;kube-dns&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-dns&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:9153
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name

  # 监控kube-proxy
  - job_name: &amp;quot;kube-proxy&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-proxy&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:10249
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控kube-state-metrics
  - job_name: &amp;quot;kube-state-metrics&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
      regex: &amp;quot;kube-state-metrics&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:8080
      target_label: __address__

    # 添加维度标签
    - regex: __meta_kubernetes_service_label_(.*)
      action: labelmap
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240317205755162.png&#34; alt=&#34;image-20240317205755162&#34; /&gt;&lt;/p&gt;
&lt;h6 id=&#34;794-资源状态告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#794-资源状态告警规则文件&#34;&gt;#&lt;/a&gt; 7.9.4 资源状态告警规则⽂件&lt;/h6&gt;
&lt;p&gt;1、编写告警规则⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  kube_state_metrics_rules.yml: |-
    groups:
    - name: KSM告警规则文件
      rules:
      - alert: 节点kubelet未就绪
        expr: kube_node_status_condition&amp;#123;condition=&amp;quot;Ready&amp;quot;, status=&amp;quot;true&amp;quot;&amp;#125; == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125; kubelet未就绪&amp;quot;
          description: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125; kubelet已经超过5分钟未处于就绪状态，需要立即检查。&amp;quot;

      - alert: 节点内存压力大
        expr: kube_node_status_condition&amp;#123;condition=&amp;quot;MemoryPressure&amp;quot;, status=&amp;quot;true&amp;quot;&amp;#125; == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125; 内存压力过高&amp;quot;
          description: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125; 正在经历内存压力，可能需要增加内存资源或减少工作负载。&amp;quot;

      - alert: 节点网络压力大
        expr: kube_node_status_condition&amp;#123;condition=&amp;quot;NetworkUnavailable&amp;quot;,status=&amp;quot;true&amp;quot;&amp;#125; == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125; 网络压力过高&amp;quot;
          description: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125; 的网络接压力过大，可能存在网络瓶颈。&amp;quot;

      - alert: 节点磁盘压力大
        expr: kube_node_status_condition&amp;#123;condition=&amp;quot;DiskPressure&amp;quot;, status=&amp;quot;true&amp;quot;&amp;#125; == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125;磁盘压力过高&amp;quot;
          description: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125; 正在经历磁盘压力，磁盘空间或inode可能不足。&amp;quot;

      - alert: 节点PID压力大
        expr: kube_node_status_condition&amp;#123;condition=&amp;quot;PIDPressure&amp;quot;, status=&amp;quot;true&amp;quot;&amp;#125; == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125; PID压力过高&amp;quot;
          description: &amp;quot;节点 &amp;#123;&amp;#123; $labels.node &amp;#125;&amp;#125; 上的进程数可能已经达到上限。&amp;quot;

      - alert: 启动失败的Pod
        expr: sum (kube_pod_status_phase&amp;#123;phase=~&amp;quot;Pending|Unknown|Failed&amp;quot;&amp;#125;) by (job,namespace, pod) &amp;gt; 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;Pod启动失败&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中的Pod &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39;启动失败。&amp;quot;
      
      - alert: 因为OOM重启的Pod
        expr: |
          (kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m &amp;gt;= 1)
          and ignoring (reason)
          min_over_time(kube_pod_container_status_last_terminated_reason&amp;#123;reason=&amp;quot;OOMKilled&amp;quot;&amp;#125;[10m]) &amp;gt;= 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125; Pod因OOM重启&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中的Pod &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; 触发了OOM造成Pod重启,触发OOM的容器是 &#39;&amp;#123;&amp;#123; $labels.container &amp;#125;&amp;#125;&#39;。&amp;quot;

      - alert: Deployment副本数不一致
        expr: kube_deployment_spec_replicas - kube_deployment_status_replicas_available &amp;gt; 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;Deployment副本数不一致&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &amp;#123;&amp;#123; $labels.deployment &amp;#125;&amp;#125; 部署副本数与期望副本数不一致，当前偏差了&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;个副本。&amp;quot;
      
      - alert: DaemonSet副本数不一致
        expr: |
          kube_daemonset_status_number_ready / kube_daemonset_status_desired_number_scheduled * 100 &amp;lt; 100
          or
          kube_daemonset_status_desired_number_scheduled - kube_daemonset_status_current_number_scheduled &amp;gt; 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;DaemonSet副本数不一致&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &amp;#123;&amp;#123; $labels.daemonset &amp;#125;&amp;#125; 期望副本数与实际运行副本数不一致。&amp;quot;

      - alert: DaemonSet调度出现错误
        expr: kube_daemonset_status_number_misscheduled &amp;gt; 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;DaemonSet调度错误&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &amp;#123;&amp;#123; $labels.daemonset &amp;#125;&amp;#125; 调度了错误的Pod。&amp;quot;

      - alert: StatefulSet副本数异常
        expr: |
          kube_statefulset_status_replicas_ready  / kube_statefulset_replicas  * 100 &amp;lt; 100
          or
          kube_statefulset_replicas - kube_statefulset_status_replicas_current &amp;gt; 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;StatefulSet副本数异常&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &amp;#123;&amp;#123; $labels.statefulset &amp;#125;&amp;#125; 期望副本数与实际运行副本数不一致。&amp;quot;

      - alert: PV异常
        expr: kube_persistentvolume_status_phase&amp;#123;phase=&amp;quot;Failed&amp;quot;&amp;#125; &amp;gt; 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;PV异常&amp;quot;
          description: &amp;quot;持久卷&#39;&amp;#123;&amp;#123; $labels.persistentvolume &amp;#125;&amp;#125;&#39;处于Failed状态。&amp;quot;

      - alert: PVC异常
        expr: kube_persistentvolumeclaim_status_phase&amp;#123;phase=~&amp;quot;Lost|Pending&amp;quot;&amp;#125; &amp;gt; 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;PVC异常&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &amp;#123;&amp;#123; $labels.persistentvolumeclaim &amp;#125;&amp;#125; 持久卷(PVC)处于 &amp;#123;&amp;#123; $labels.phase &amp;#125;&amp;#125;状态。&amp;quot;

      - alert: Job完成度低
        expr: kube_job_status_succeeded / kube_job_spec_completions * 100 &amp;lt; 75
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;Job完成度低于75%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &amp;#123;&amp;#123; $labels.job_name &amp;#125;&amp;#125; Job任务完成度低于预期的75%。&amp;quot;

      - alert: Job失败次数高
        expr: kube_job_status_failed &amp;gt; 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;Job失败次数过高&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &amp;#123;&amp;#123; $labels.job_name &amp;#125;&amp;#125; Job任务执行失败次数超过5次以上，当前失败 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125; 次。&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;795-导入资源状态图形&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#795-导入资源状态图形&#34;&gt;#&lt;/a&gt; 7.9.5 导⼊资源状态图形&lt;/h6&gt;
&lt;p&gt;ID：13332  或 15757&lt;/p&gt;
&lt;h5 id=&#34;710-监控kubernetes集群pod资源&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#710-监控kubernetes集群pod资源&#34;&gt;#&lt;/a&gt; 7.10 监控 Kubernetes 集群 Pod 资源&lt;/h5&gt;
&lt;h6 id=&#34;7101-pod资源是什么&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#7101-pod资源是什么&#34;&gt;#&lt;/a&gt; 7.10.1 Pod 资源是什么&lt;/h6&gt;
&lt;p&gt;所谓 Pod 资源，指的是，运⾏在 Pod 中的 &amp;quot;容器&amp;quot; 所使⽤的计算资源。这些计算资源指的是 CPU、内存、⽹络以及磁盘 IO 等相关指标。之前我们监控容器的资源时，使⽤的是 cAdvisor ⼯具来监控。不过在 Kubernetes 中，Cadvisor ⼯具已经被内置到了 kubelet 的组件中。因此，我们可以直接监控节点的 kubelet，来收集相关 Pod 的指标数据。&lt;/p&gt;
&lt;p&gt;kubelet 的指标可以通过以下⽅式访问：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;端⼝：10250，kubelet ⽤于指标数据。&lt;/li&gt;
&lt;li&gt;协议：HTTPS，确保数据传输的安全性（因此需要进⾏认证才可以抓取数据）。&lt;/li&gt;
&lt;li&gt;路径： /metrics/cadvisor ，特定的 URL 路径，我们需要从这个路径获取 cAdvisor 提供的指标数据。&lt;/li&gt;
&lt;/ul&gt;
&lt;h6 id=&#34;7102-配置prometheus监控pod&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#7102-配置prometheus监控pod&#34;&gt;#&lt;/a&gt; 7.10.2 配置 Prometheus 监控 Pod&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： kube-kubelet ，metrics 路径是 /metrics/cadvisor ，协议是 https&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 node ⽅式来发现所有的主机实例，由于 kubelet 采⽤的是 HTTPS，因此还需要指定 TLS 相关的配置；&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，映射 _&lt;em&gt;meta_kubernetes_node_label&lt;/em&gt; (.*) ，所有的标签以及标签值。&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# TOKEN=$(kubectl create token -n monitoring prometheus-sa)
[root@k8s-master01 04-prometheus]# curl -s -k -H &amp;quot;Authorization: Bearer $TOKEN&amp;quot; https://192.168.40.101:10250/metrics|head -n 10
# HELP aggregator_discovery_aggregation_count_total [ALPHA] Counter of number of times discovery was aggregated
# TYPE aggregator_discovery_aggregation_count_total counter
aggregator_discovery_aggregation_count_total 0
# HELP apiserver_audit_event_total [ALPHA] Counter of audit events generated and sent to the audit backend.
# TYPE apiserver_audit_event_total counter
apiserver_audit_event_total 0
# HELP apiserver_audit_requests_rejected_total [ALPHA] Counter of apiserver requests rejected due to an error in audit logging backend.
# TYPE apiserver_audit_requests_rejected_total counter
apiserver_audit_requests_rejected_total 0
# HELP apiserver_client_certificate_expiration_seconds [ALPHA] Distribution of the remaining lifetime on the certificate used to authenticate a request.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;1、配置 Prometheus&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控etcd
      - job_name: &amp;quot;kube-etcd&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;etcd&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:2381
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控CoreDNS
      - job_name: &amp;quot;kube-dns&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-dns&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:9153
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name

      # 监控kube-proxy
      - job_name: &amp;quot;kube-proxy&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-proxy&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:10249
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控kube-state-metrics
      - job_name: &amp;quot;kube-state-metrics&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
          regex: &amp;quot;kube-state-metrics&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:8080
          target_label: __address__

        # 添加维度标签
        - regex: __meta_kubernetes_service_label_(.*)
          action: labelmap

      # 监控kubelet(Pod)
      - job_name: &amp;quot;kube-kubelet&amp;quot;
        metrics_path: &amp;quot;/metrics/cadvisor&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: node
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 添加标签的映射
        relabel_configs:
        - regex: __meta_kubernetes_node_label_(.*)
          action: labelmap

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控Scheduler
  - job_name: &amp;quot;kube-schduler&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 基于标签进行过滤
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-scheduler&amp;quot;
      action: keep

    # 修订抓取的端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:10259
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控etcd
  - job_name: &amp;quot;kube-etcd&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;etcd&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:2381
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控CoreDNS
  - job_name: &amp;quot;kube-dns&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-dns&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:9153
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name

  # 监控kube-proxy
  - job_name: &amp;quot;kube-proxy&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-proxy&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:10249
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控kube-state-metrics
  - job_name: &amp;quot;kube-state-metrics&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
      regex: &amp;quot;kube-state-metrics&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:8080
      target_label: __address__

    # 添加维度标签
    - regex: __meta_kubernetes_service_label_(.*)
      action: labelmap

  # 监控kubelet(Pod)
  - job_name: &amp;quot;kube-kubelet&amp;quot;
    metrics_path: &amp;quot;/metrics/cadvisor&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: node
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 添加标签的映射
    relabel_configs:
    - regex: __meta_kubernetes_node_label_(.*)
      action: labelmap
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240317212313946.png&#34; alt=&#34;image-20240317212313946&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3、检查此前创建好的 kube_pods_rules.yml 告警规则⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  kube_pods_rules.yml: |-
    groups:
    - name: Pods的告警规则文件
      rules:
      - alert: Pod中容器的CPU利用率高
        expr: sum (rate(container_cpu_usage_seconds_total&amp;#123;image!=&amp;quot;&amp;quot;&amp;#125;[5m])) by (instance,job,pod,namespace) * 100 &amp;gt; 80
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod CPU利用率高&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的CPU利用率当前为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%，超过了80%的阈值。&amp;quot;
    
      - alert: Pod中容器内存利用率高
        expr: |
          sum(container_memory_working_set_bytes&amp;#123;name!=&amp;quot;&amp;quot;&amp;#125;) by (instance,job,pod,namespace)
          /
          sum(container_spec_memory_limit_bytes&amp;#123;name!=&amp;quot;&amp;quot;&amp;#125; &amp;gt; 0) by (instance,job,pod,namespace) * 100 &amp;gt; 80
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod内存利用率高&amp;quot;
          description: 在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的内存最大限制是 &amp;#123;&amp;#123; printf `sum (container_spec_memory_limit_bytes&amp;#123;namespace=&#34;%s&#34;,pod=&#34;%s&#34;&amp;#125; &gt; 0 ) /1024 /1024` $labels.namespace $labels.pod | query | first | value &amp;#125;&amp;#125;MB , 目前利用率已达&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%，超过限制的80%。

      - alert: Pod容器网络发送速率过高
        expr: sum(rate(container_network_transmit_bytes_total&amp;#123;image!=&amp;quot;&amp;quot;&amp;#125;[1m])) by (instance,job,pod,namespace) * 8 /1024 /1024 &amp;gt; 50
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod网络发送速率过高&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的网络发送速率达到&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;Mbps，超过了50Mbps的阈值。&amp;quot;
    
      - alert: Pod容器网络接收速率过高
        expr: sum(rate(container_network_receive_bytes_total&amp;#123;image!=&amp;quot;&amp;quot;&amp;#125;[1m])) by (instance,job,pod,namespace) * 8 /1024 /1024 &amp;gt; 50
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod网络发送速率过高&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的网络接收速率达到&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;Mbps，超过了50Mbps的阈值。&amp;quot;
    
      - alert: Pod容器磁盘写入吞吐量过大
        expr: sum (rate(container_fs_writes_bytes_total&amp;#123;name!=&amp;quot;&amp;quot;&amp;#125;[1m])) by (instance,job,pod,namespace) /1024 /1024 &amp;gt; 20
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod磁盘写入吞吐量过大&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的磁盘写入吞吐量达到&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;MB/s，超过了20MB/s的阈值。&amp;quot;
    
      - alert: Pod容器磁盘读取吞吐量过大
        expr: sum (rate(container_fs_reads_bytes_total&amp;#123;name!=&amp;quot;&amp;quot;&amp;#125;[1m])) by (instance,job,pod,namespace) /1024 /1024 &amp;gt; 20
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 节点上运行的 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod磁盘读取吞吐量过大&amp;quot;
          description: &amp;quot;在 &#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod &amp;#125;&amp;#125;&#39; Pod的磁盘读取吞吐量达到&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;MB/s，超过了20MB/s的阈值。&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;711-监控kubernetes集群service资源&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#711-监控kubernetes集群service资源&#34;&gt;#&lt;/a&gt; 7.11 监控 Kubernetes 集群 Service 资源&lt;/h5&gt;
&lt;h6 id=&#34;7111-为何需要监控service资源&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#7111-为何需要监控service资源&#34;&gt;#&lt;/a&gt; 7.11.1 为何需要监控 Service 资源&lt;/h6&gt;
&lt;p&gt;监控 Service 资源是为了确保我们的服务，时刻处于持续运⾏状态，通常关注如下两个维度；&lt;/p&gt;
&lt;p&gt;● 1、可⽤性：确保 Service 始终是可以被访问的，从⽽保障服务的连续性。&lt;/p&gt;
&lt;p&gt;● 2、性能：监控 Service 的响应时间，确保其处理请求的速度，始终处于⼀个稳定的时间。&lt;/p&gt;
&lt;p&gt;为了确保 Service 的服务始终可⽤，我们通常会采⽤ Blackbox 的 TCP 探测⽅法来进⾏监控。&lt;/p&gt;
&lt;p&gt;之前 Blackbox 监控⽅式⽐较固定，不够灵活。为了改进这⼀点，在监控 Service 时，我们可以将监控⽬标配置为⾃动发现机制。这样，每当有新的 Service 出现或现有 Service 发⽣变化时，监控系统能够⾃动识别并开始监控，⽽不需要⼿动更新 Prometheus 的配置。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  - job_name: &#39;blackbox_http&#39;
    metrics_path: /probe # metrics的path这次不是/metrics，⽽是/probe
    params: # 传递参数
      module: [http_2xx] # 调⽤哪个模块进⾏探测
    static_configs:
    - targets: [&amp;quot;https://www.xuliangwei.com&amp;quot;,&amp;quot;http://www.oldxu.net&amp;quot;,&amp;quot;https://www.baidu.com&amp;quot;,&amp;quot;http://httpbin.org/status/400&amp;quot;,&amp;quot;https://httpstat.us/500&amp;quot;,&amp;quot;https://httpstat.us/502&amp;quot;]
    relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: prom-node04.oldxu.net:9115
      
# relabel_configs是标签重写的配置，这⾥进⾏了三次操作：
# 1、将⽬标地址（__address__）赋予给__param_target，这是Blackbox Exporter需要的⽬标target参数。
# 2、将__param_target的内容复制到instance标签，这样Prometheus UI中显示的instance实例名称会是⽬标站点地址，⽽不是Blackbox的地址。
# 3、最后，将实际发送探测请求的地址（__address__）设置为运⾏Blackbox Exporter的节点地址和端⼝（prom-node04.oldxu.net:9115），这样Prometheus就会向这个地址发送探测请求。
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;7112-配置prometheus监控service&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#7112-配置prometheus监控service&#34;&gt;#&lt;/a&gt; 7.11.2 配置 Prometheus 监控 Service&lt;/h6&gt;
&lt;p&gt;1、添加⼀个新的 Job，名为： kube-blackbox-tcp ，协议是 tcp ， metrics 路径是 /probe&lt;/p&gt;
&lt;p&gt;2、基于 Kubernetes 的 service 来实现⾃动发现所有的 Service，⽽后进⾏⾃动监控；&lt;/p&gt;
&lt;p&gt;3、使⽤ relabel_configs，保留 __meta_kubernetes_namespace、__meta_kubernetes_service_name 这两个维度的标签。&lt;/p&gt;
&lt;p&gt;1、配置 Prometheus&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控etcd
      - job_name: &amp;quot;kube-etcd&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;etcd&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:2381
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控CoreDNS
      - job_name: &amp;quot;kube-dns&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-dns&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:9153
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name

      # 监控kube-proxy
      - job_name: &amp;quot;kube-proxy&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-proxy&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:10249
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控kube-state-metrics
      - job_name: &amp;quot;kube-state-metrics&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
          regex: &amp;quot;kube-state-metrics&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:8080
          target_label: __address__

        # 添加维度标签
        - regex: __meta_kubernetes_service_label_(.*)
          action: labelmap

      # 监控kubelet(Pod)
      - job_name: &amp;quot;kube-kubelet&amp;quot;
        metrics_path: &amp;quot;/metrics/cadvisor&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: node
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 添加标签的映射
        relabel_configs:
        - regex: __meta_kubernetes_node_label_(.*)
          action: labelmap

      # 监控service
      - job_name: &amp;quot;kube-blackbox-tcp&amp;quot;
        metrics_path: &amp;quot;/probe&amp;quot;
        params:
          module: [tcp_connect]         # 使用tcp_connect模块
        kubernetes_sd_configs:
        - role: service
        relabel_configs:
        - source_labels: [__address__]
          target_label: __param_target
        - source_labels: [__param_target]
          target_label: instance
        - target_label: __address__
          replacement: blackbox-svc:9115
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: (.*)
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_service_name]
          regex: (.*)
          replacement: $1
          target_label: service_name

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]#  kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控Scheduler
  - job_name: &amp;quot;kube-schduler&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 基于标签进行过滤
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-scheduler&amp;quot;
      action: keep

    # 修订抓取的端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:10259
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控etcd
  - job_name: &amp;quot;kube-etcd&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;etcd&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:2381
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控CoreDNS
  - job_name: &amp;quot;kube-dns&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-dns&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:9153
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name

  # 监控kube-proxy
  - job_name: &amp;quot;kube-proxy&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-proxy&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:10249
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控kube-state-metrics
  - job_name: &amp;quot;kube-state-metrics&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
      regex: &amp;quot;kube-state-metrics&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:8080
      target_label: __address__

    # 添加维度标签
    - regex: __meta_kubernetes_service_label_(.*)
      action: labelmap

  # 监控kubelet(Pod)
  - job_name: &amp;quot;kube-kubelet&amp;quot;
    metrics_path: &amp;quot;/metrics/cadvisor&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: node
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 添加标签的映射
    relabel_configs:
    - regex: __meta_kubernetes_node_label_(.*)
      action: labelmap

  # 监控service
  - job_name: &amp;quot;kube-blackbox-tcp&amp;quot;
    metrics_path: &amp;quot;/probe&amp;quot;
    params:
      module: [tcp_connect]         # 使用tcp_connect模块
    kubernetes_sd_configs:
    - role: service
    relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-svc:9115
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: (.*)
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_service_name]
      regex: (.*)
      replacement: $1
      target_label: service_name
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240317214533161.png&#34; alt=&#34;image-20240317214533161&#34; /&gt;&lt;/p&gt;
&lt;p&gt;5、检查此前创建好的 kube_blackbox_tcp_rules.yml 告警规则⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt; blackbox_tcp_rules.yml: |-
    groups:
    - name: Blackbox_tcp告警规则文件
      rules:
      - alert: Service TCP探测失败
        expr: sum(probe_success&amp;#123;job=~&amp;quot;.*tcp&amp;quot;&amp;#125;) by (instance,job,namespace,service_name) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;探测 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Service 的TCP接口探测失败。&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中的 &#39;&amp;#123;&amp;#123; $labels.service_name &amp;#125;&amp;#125;&#39; Service资源 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 地址探测失败。&amp;quot;
    
      - alert: Service TCP请求的响应时间过长
        expr: probe_duration_seconds&amp;#123;job=~&amp;quot;.*tcp&amp;quot;&amp;#125; &amp;gt; 0.500
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;探测 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Service 的TCP响应时间超过了500毫秒。&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中的 &#39;&amp;#123;&amp;#123; $labels.service_name &amp;#125;&amp;#125;&#39; Service资源 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 当前响应时长为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125; 秒。&amp;quot;

      - alert: Service的DNS解析响应时间过长
        expr: probe_dns_lookup_time_seconds&amp;#123;job=~&amp;quot;.*tcp&amp;quot;&amp;#125; &amp;gt; 0.500
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;探测 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Service 的DNS解析响应时间超过了500毫秒。&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中的 &#39;&amp;#123;&amp;#123; $labels.service_name &amp;#125;&amp;#125;&#39; Service资源 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 当前响应时长为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125; 秒。&amp;quot;	
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;712-监控kubernetes集群ingress资源&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#712-监控kubernetes集群ingress资源&#34;&gt;#&lt;/a&gt; 7.12 监控 Kubernetes 集群 Ingress 资源&lt;/h5&gt;
&lt;h6 id=&#34;7121-为何需要监控ingress资源&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#7121-为何需要监控ingress资源&#34;&gt;#&lt;/a&gt; 7.12.1 为何需要监控 Ingress 资源&lt;/h6&gt;
&lt;p&gt;监控 Ingress 对应的域名，主要是为了确保⽤户，能时刻访问到对应域名所提供的服务；监控域名维度如下；&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;HTTP 请求延迟：监控站点处理请求的延迟，如果请求延迟过⾼可以推送告警消息，这样就可以第⼀时间进⾏处理。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;证书过期时间：监控 TLS/SSL 证书的有效期，以便及时更新证书，避免因为证书过期造成访问中断。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;可⽤性：持续检查 Ingress 绑定的域名是否可被持续访问，确保⽤户的访问不会中断。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;为了实现这样的监控，通常会利⽤ Blackbox Exporter 的 HTTP 探测功能来检查 Ingress 对应域名的健康状态和响应时间。&lt;/p&gt;
&lt;p&gt;之前 Blackbox 监控⽅式⽐较固定，不够灵活。为了改进这⼀点，在监控 Ingress 时，我们可以将监控⽬标配置为⾃动发现机制。这样，每当有新的 ingress 出现或现有 ingress 发⽣变化时，监控系统能够⾃动识别并开始监控，⽽不需要⼿动更新 Prometheus 的配置。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  - job_name: &#39;blackbox_http&#39;
    metrics_path: /probe # metrics的path这次不是/metrics，⽽是/probe
    params: # 传递参数
      module: [http_2xx] # 调⽤哪个模块进⾏探测
    static_configs:
    - targets: [&amp;quot;https://www.xuliangwei.com&amp;quot;,&amp;quot;http://www.oldxu.net&amp;quot;,&amp;quot;https://www.baidu.com&amp;quot;,&amp;quot;http://httpbin.org/status/400&amp;quot;,&amp;quot;https://httpstat.us/500&amp;quot;,&amp;quot;https://httpstat.us/502&amp;quot;]
    relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: prom-node04.oldxu.net:9115
      
# relabel_configs是标签重写的配置，这⾥进⾏了三次操作：
# 1、将⽬标地址（__address__）赋予给__param_target，这是Blackbox Exporter需要的⽬标target参数。
# 2、将__param_target的内容复制到instance标签，这样Prometheus UI中显示的instance实例名称会是⽬标站点地址，⽽不是Blackbox的地址。
# 3、最后，将实际发送探测请求的地址（__address__）设置为运⾏Blackbox Exporter的节点地址和端⼝（prom-node04.oldxu.net:9115），这样Prometheus就会向这个地址发送探测请求。
&lt;/code&gt;&lt;/pre&gt;
&lt;h6 id=&#34;7122-配置prometheus监控ingress&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#7122-配置prometheus监控ingress&#34;&gt;#&lt;/a&gt; 7.12.2 配置 Prometheus 监控 Ingress&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： kube-blackbox-http ，协议是 http&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 ingress 来⾃动发现所有的 Ingress 资源，⽽后进⾏监控。&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，保留 __meta_kubernetes_namespace、__meta_kubernetes_ingress_name、__meta_kubernetes_ingress_class_name 这三个维度的标签。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、配置 Prometheus&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控etcd
      - job_name: &amp;quot;kube-etcd&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;etcd&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:2381
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控CoreDNS
      - job_name: &amp;quot;kube-dns&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-dns&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:9153
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name

      # 监控kube-proxy
      - job_name: &amp;quot;kube-proxy&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-proxy&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:10249
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控kube-state-metrics
      - job_name: &amp;quot;kube-state-metrics&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
          regex: &amp;quot;kube-state-metrics&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:8080
          target_label: __address__

        # 添加维度标签
        - regex: __meta_kubernetes_service_label_(.*)
          action: labelmap

      # 监控kubelet(Pod)
      - job_name: &amp;quot;kube-kubelet&amp;quot;
        metrics_path: &amp;quot;/metrics/cadvisor&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: node
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 添加标签的映射
        relabel_configs:
        - regex: __meta_kubernetes_node_label_(.*)
          action: labelmap

      # 监控service
      - job_name: &amp;quot;kube-blackbox-tcp&amp;quot;
        metrics_path: &amp;quot;/probe&amp;quot;
        params:
          module: [tcp_connect]         # 使用tcp_connect模块
        kubernetes_sd_configs:
        - role: service
        relabel_configs:
        - source_labels: [__address__]
          target_label: __param_target
        - source_labels: [__param_target]
          target_label: instance
        - target_label: __address__
          replacement: blackbox-svc:9115
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: (.*)
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_service_name]
          regex: (.*)
          replacement: $1
          target_label: service_name

      # 监控ingress
      - job_name: &amp;quot;kube-blackbox-http&amp;quot;
        metrics_path: &amp;quot;/probe&amp;quot;
        params:
          module: [http_2xx]            # 使用http模块进行探测
        kubernetes_sd_configs:
        - role: ingress
        relabel_configs:
        # 协议有可能是http或https，因此需要根据抓取到的协议+端⼝，拼接出具体的探测示例
        - source_labels: [__meta_kubernetes_ingress_scheme,__address__]
          regex: (.*);(.*)
          replacement: $1://$2
          target_label: __param_target
        - source_labels: [__param_target]
          target_label: instance
        - target_label: __address__
          replacement: blackbox-svc:9115
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - source_labels: [__meta_kubernetes_ingress_name]
          target_label: ingress_name
        - source_labels: [__meta_kubernetes_ingress_class_name]
          target_label: ingress_class_name
          
[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]#  kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控Scheduler
  - job_name: &amp;quot;kube-schduler&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 基于标签进行过滤
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-scheduler&amp;quot;
      action: keep

    # 修订抓取的端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:10259
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控etcd
  - job_name: &amp;quot;kube-etcd&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;etcd&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:2381
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控CoreDNS
  - job_name: &amp;quot;kube-dns&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-dns&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:9153
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name

  # 监控kube-proxy
  - job_name: &amp;quot;kube-proxy&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-proxy&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:10249
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控kube-state-metrics
  - job_name: &amp;quot;kube-state-metrics&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
      regex: &amp;quot;kube-state-metrics&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:8080
      target_label: __address__

    # 添加维度标签
    - regex: __meta_kubernetes_service_label_(.*)
      action: labelmap

  # 监控kubelet(Pod)
  - job_name: &amp;quot;kube-kubelet&amp;quot;
    metrics_path: &amp;quot;/metrics/cadvisor&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: node
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 添加标签的映射
    relabel_configs:
    - regex: __meta_kubernetes_node_label_(.*)
      action: labelmap

  # 监控service
  - job_name: &amp;quot;kube-blackbox-tcp&amp;quot;
    metrics_path: &amp;quot;/probe&amp;quot;
    params:
      module: [tcp_connect]         # 使用tcp_connect模块
    kubernetes_sd_configs:
    - role: service
    relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-svc:9115
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: (.*)
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_service_name]
      regex: (.*)
      replacement: $1
      target_label: service_name

  # 监控ingress
  - job_name: &amp;quot;kube-blackbox-http&amp;quot;
    metrics_path: &amp;quot;/probe&amp;quot;
    params:
      module: [http_2xx]            # 使用http模块进行探测
    kubernetes_sd_configs:
    - role: ingress
    relabel_configs:
    # 协议有可能是http或https，因此需要根据抓取到的协议+端⼝，拼接出具体的探测示例
    - source_labels: [__meta_kubernetes_ingress_scheme,__address__]
      regex: (.*);(.*)
      replacement: $1://$2
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-svc:9115
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      target_label: namespace
    - source_labels: [__meta_kubernetes_ingress_name]
      target_label: ingress_name
    - source_labels: [__meta_kubernetes_ingress_class_name]
      target_label: ingress_class_name
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240317215901654.png&#34; alt=&#34;image-20240317215901654&#34; /&gt;&lt;/p&gt;
&lt;p&gt;5、检查此前创建好的 blackbox_http_rules.yml 告警规则⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt; blackbox_http_rules.yml: |-
    groups:
    - name: Blackbox_http告警规则文件
      rules:
      - alert: 站点平均请求过长
        expr: sum (avg_over_time(probe_http_duration_seconds[1m])) by (instance,job,namespace,ingress_name) &amp;gt; 3
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名整体请求时间超过了3秒。&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名最近1分钟的平均请求时间超过3秒。当前平均请求时间：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。&amp;quot;

      - alert: 站点阶段耗时过长
        expr: |
          (
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;connect&amp;quot;&amp;#125; &amp;gt; 1 or
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;processing&amp;quot;&amp;#125; &amp;gt; 1 or
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;resolve&amp;quot;&amp;#125; &amp;gt; 1 or
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;tls&amp;quot;&amp;#125; &amp;gt; 1 or
            probe_http_duration_seconds&amp;#123;phase=&amp;quot;transfer&amp;quot;&amp;#125; &amp;gt; 1
          )
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名在 &#39;&amp;#123;&amp;#123; $labels.phase &amp;#125;&amp;#125;&#39; 阶段耗时过长&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名在阶段 &#39;&amp;#123;&amp;#123; $labels.phase &amp;#125;&amp;#125;&#39; 的耗时超过0.5秒。当前耗时：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。&amp;quot;

      - alert: 站点响应状态码异常
        expr: probe_http_status_code &amp;lt;= 199 or probe_http_status_code &amp;gt;= 400
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名返回异常状态码&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名返回的状态码为 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;，表明请求可能存在问题。&amp;quot;
    
      - alert: 重定向次数过多
        expr: probe_http_redirects &amp;gt; 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名重定向次数过多&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名在最近的探测中重定向次数超过5次。当前次数：&amp;#123;&amp;#123; $value &amp;#125;&amp;#125;次。&amp;quot;

      - alert: 证书即将过期&amp;lt;30
        expr: (probe_ssl_earliest_cert_expiry - time()) /86400 &amp;lt; 30
        for: 24h
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名的 SSL 证书即将过期&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名的 SSL 证书将在 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125; 天内过期。&amp;quot;
    
      - alert: 证书即将过期&amp;lt;7
        expr: (probe_ssl_earliest_cert_expiry - time()) /86400 &amp;lt; 7
        for: 24h
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名的 SSL 证书即将过期&amp;quot;
          description: &amp;quot;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125; 名称空间 &amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 域名的 SSL 证书将在 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125; 天内过期。&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&#34;8-prometheus监控redis应用的pod&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#8-prometheus监控redis应用的pod&#34;&gt;#&lt;/a&gt; 8、Prometheus 监控 Redis 应⽤的 Pod&lt;/h4&gt;
&lt;h5 id=&#34;81-监控redis应用场景说明&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#81-监控redis应用场景说明&#34;&gt;#&lt;/a&gt; 8.1 监控 Redis 应⽤场景说明&lt;/h5&gt;
&lt;p&gt;运⾏ redis 的 Pod，⽽后为其创建⼀个 Service，我们现在希望监控它的 Pod 状态，Pod 资源的使⽤，redis 的指标、以及 redis 的 Service 的延迟和存活性。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、redis 应⽤指标：可以在 Pod 中注⼊⼀个 redis_exporter 来抓取对应的 redis 指标，并暴露给 Prometheus；&lt;/li&gt;
&lt;li&gt;2、pod 的运⾏状态：kube-state-metrics 能⾃动获取，因此⽆需考虑；&lt;/li&gt;
&lt;li&gt;3、pod 的资源使⽤：kubelet 的 CadVisor 能⾃动获取到每个 Pod 的资源使⽤，因此⽆需考虑；&lt;/li&gt;
&lt;li&gt;4、Pod 的存活性以及延迟：可以通过 Blackbox 来监控 6379、9121 端⼝，在此前创建的 Blackbox-tcp 会⾃动的将这些 Service 资源给监控起来，因此⽆需考虑。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;82-运行redis基础服务pod&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#82-运行redis基础服务pod&#34;&gt;#&lt;/a&gt; 8.2 运⾏ Redis 基础服务 Pod&lt;/h5&gt;
&lt;p&gt;1、在⼀个 Pod 中同时运⾏ Redis 和 Redis_exporter，清单⽂件如下：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 08-redis-exporter]# cat 01-redis-deployment.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: default
spec:
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
      annotations:
        prometheus.io/scrape: &amp;quot;true&amp;quot;
        prometheus.io/scheme: &amp;quot;http&amp;quot;
        prometheus.io/path: &amp;quot;/metrics&amp;quot;
        prometheus.io/port: &amp;quot;9121&amp;quot;
    spec:
      containers:
      - name: redis
        image: redis:6
        # 设定redis最大的内存，默认最大内存为0
        command: [&amp;quot;redis-server&amp;quot;]
        args: [&amp;quot;--maxmemory&amp;quot;, &amp;quot;200mb&amp;quot;]
        ports:
        - containerPort: 6379
      - name: redis-exporter
        image: oliver006/redis_exporter:v1.57.0
        ports:
        - containerPort: 9121
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、创建 Service 资源，需要暴露两个端⼝&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 08-redis-exporter]# cat 02-redis-service.yaml 
kind: Service
apiVersion: v1
metadata:
  name: redis-svc
  namespace: default
  labels:
    app: redis
spec:
  selector:
    app: redis
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
  - name: exporter
    port: 9121
    targetPort: 9121
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、查看 Service 详情&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 08-redis-exporter]# kubectl apply -f .
[root@k8s-master01 08-redis-exporter]#  kubectl describe service redis-svc
Name:              redis-svc
Namespace:         default
Labels:            app=redis
Annotations:       &amp;lt;none&amp;gt;
Selector:          app=redis
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.96.140.137
IPs:               10.96.140.137
# 端点1
Port:              redis  6379/TCP
TargetPort:        6379/TCP
Endpoints:         172.16.85.208:6379
# 端点2
Port:              exporter  9121/TCP
TargetPort:        9121/TCP
Endpoints:         172.16.85.208:9121
Session Affinity:  None
Events:            &amp;lt;none&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;83-配置prometheus监控redis&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#83-配置prometheus监控redis&#34;&gt;#&lt;/a&gt; 8.3 配置 Prometheus 监控 Redis&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： redis-pod&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 endpints 来实现⾃动发现&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，保留 &lt;strong&gt;address&lt;/strong&gt; 地址对应的端⼝是 9121 的实例。&lt;/li&gt;
&lt;li&gt;4、使⽤ relabel_configs，保留 __meta_kubernetes_namespace、__meta_kubernetes_service_name、__meta_kubernetes_pod_name 这三个维度的标签。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、配置 Prometheus&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控etcd
      - job_name: &amp;quot;kube-etcd&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;etcd&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:2381
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控CoreDNS
      - job_name: &amp;quot;kube-dns&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-dns&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:9153
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name

      # 监控kube-proxy
      - job_name: &amp;quot;kube-proxy&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-proxy&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:10249
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控kube-state-metrics
      - job_name: &amp;quot;kube-state-metrics&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
          regex: &amp;quot;kube-state-metrics&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:8080
          target_label: __address__

        # 添加维度标签
        - regex: __meta_kubernetes_service_label_(.*)
          action: labelmap

      # 监控kubelet(Pod)
      - job_name: &amp;quot;kube-kubelet&amp;quot;
        metrics_path: &amp;quot;/metrics/cadvisor&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: node
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 添加标签的映射
        relabel_configs:
        - regex: __meta_kubernetes_node_label_(.*)
          action: labelmap

      # 监控service
      - job_name: &amp;quot;kube-blackbox-tcp&amp;quot;
        metrics_path: &amp;quot;/probe&amp;quot;
        params:
          module: [tcp_connect]         # 使用tcp_connect模块
        kubernetes_sd_configs:
        - role: service
        relabel_configs:
        - source_labels: [__address__]
          target_label: __param_target
        - source_labels: [__param_target]
          target_label: instance
        - target_label: __address__
          replacement: blackbox-svc:9115
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: (.*)
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_service_name]
          regex: (.*)
          replacement: $1
          target_label: service_name

      # 监控ingress
      - job_name: &amp;quot;kube-blackbox-http&amp;quot;
        metrics_path: &amp;quot;/probe&amp;quot;
        params:
          module: [http_2xx]            # 使用http模块进行探测
        kubernetes_sd_configs:
        - role: ingress
        relabel_configs:
        # 协议有可能是http或https，因此需要根据抓取到的协议+端⼝，拼接出具体的探测示例
        - source_labels: [__meta_kubernetes_ingress_scheme,__address__]
          regex: (.*);(.*)
          replacement: $1://$2
          target_label: __param_target
        - source_labels: [__param_target]
          target_label: instance
        - target_label: __address__
          replacement: blackbox-svc:9115
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - source_labels: [__meta_kubernetes_ingress_name]
          target_label: ingress_name
        - source_labels: [__meta_kubernetes_ingress_class_name]
          target_label: ingress_class_name

      # 监控redis
      - job_name: &amp;quot;kube-redis&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints

        # 保留端口为9121的Pod实例
        relabel_configs:
        - source_labels: [__address__]
          regex: (.*):9121
          action: keep

        # 保留特定维度的标签
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - source_labels: [__meta_kubernetes_service_name]
          target_label: service_name
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod_name

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  scrape_timeout:  15s

# 告警地址(填写AlertManager的负载均衡地址即可)
alerting:
  alertmanagers:
  - static_configs:
    - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]

# 告警规则文件
rule_files:
  - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

scrape_configs:
  - job_name: &amp;quot;prometheus&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    static_configs:
    - targets: [&amp;quot;localhost:9090&amp;quot;]

  # 监控Kubernetes的节点
  - job_name: &amp;quot;kube-nodes&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: &amp;quot;(.*):10250&amp;quot;
      replacement: &amp;quot;$1:9100&amp;quot;
      target_label: __address__
      action: replace
    - regex: __meta_kubernetes_node_label_(.*)
      replacement: $1
      action: labelmap

  # 监控APIServer
  - job_name: &amp;quot;kube-apiserver&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      insecure_skip_verify: true   # 跳过证书验证
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 标签重写
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
      regex: &amp;quot;apiserver&amp;quot;
      action: &amp;quot;keep&amp;quot;
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name
    - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
      replacement: $1
      action: labelmap


  # 监控controllerManager
  - job_name: &amp;quot;kube-controller&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    # 仅保留标签名是component 值为kube-controller-manager
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-controller-manager&amp;quot;
      action: keep
    # 替换抓取的实例端口为10257
    - source_labels: [__address__]
      regex: (.*)
      replacement: $1:10257
      target_label: __address__
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控Scheduler
  - job_name: &amp;quot;kube-schduler&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: pod
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 基于标签进行过滤
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;kube-scheduler&amp;quot;
      action: keep

    # 修订抓取的端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:10259
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控etcd
  - job_name: &amp;quot;kube-etcd&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
      regex: &amp;quot;etcd&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__address__&amp;quot;]
      regex: (.*)
      replacement: $1:2381
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控CoreDNS
  - job_name: &amp;quot;kube-dns&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-dns&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:9153
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name
    - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: service_name

  # 监控kube-proxy
  - job_name: &amp;quot;kube-proxy&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: pod

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
      regex: &amp;quot;kube-proxy&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:10249
      target_label: __address__

    # 添加维度标签
    - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: namespace
    - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
      regex: &amp;quot;(.*)&amp;quot;
      replacement: $1
      target_label: pod_name

  # 监控kube-state-metrics
  - job_name: &amp;quot;kube-state-metrics&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    scheme: http
    kubernetes_sd_configs:
    - role: endpoints

    # 保留对应标签的Pod
    relabel_configs:
    - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
      regex: &amp;quot;kube-state-metrics&amp;quot;
      action: keep

    # 修订端口
    - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
      regex: (.*)
      replacement: $1:8080
      target_label: __address__

    # 添加维度标签
    - regex: __meta_kubernetes_service_label_(.*)
      action: labelmap

  # 监控kubelet(Pod)
  - job_name: &amp;quot;kube-kubelet&amp;quot;
    metrics_path: &amp;quot;/metrics/cadvisor&amp;quot;
    scheme: https
    kubernetes_sd_configs:
    - role: node
    tls_config:
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

    # 添加标签的映射
    relabel_configs:
    - regex: __meta_kubernetes_node_label_(.*)
      action: labelmap

  # 监控service
  - job_name: &amp;quot;kube-blackbox-tcp&amp;quot;
    metrics_path: &amp;quot;/probe&amp;quot;
    params:
      module: [tcp_connect]         # 使用tcp_connect模块
    kubernetes_sd_configs:
    - role: service
    relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-svc:9115
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      regex: (.*)
      replacement: $1
      target_label: namespace
    - source_labels: [__meta_kubernetes_service_name]
      regex: (.*)
      replacement: $1
      target_label: service_name

  # 监控ingress
  - job_name: &amp;quot;kube-blackbox-http&amp;quot;
    metrics_path: &amp;quot;/probe&amp;quot;
    params:
      module: [http_2xx]            # 使用http模块进行探测
    kubernetes_sd_configs:
    - role: ingress
    relabel_configs:
    # 协议有可能是http或https，因此需要根据抓取到的协议+端⼝，拼接出具体的探测示例
    - source_labels: [__meta_kubernetes_ingress_scheme,__address__]
      regex: (.*);(.*)
      replacement: $1://$2
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-svc:9115
    # 保留特定标签
    - source_labels: [__meta_kubernetes_namespace]
      target_label: namespace
    - source_labels: [__meta_kubernetes_ingress_name]
      target_label: ingress_name
    - source_labels: [__meta_kubernetes_ingress_class_name]
      target_label: ingress_class_name

  # 监控redis
  - job_name: &amp;quot;kube-redis&amp;quot;
    metrics_path: &amp;quot;/metrics&amp;quot;
    kubernetes_sd_configs:
    - role: endpoints

    # 保留端口为9121的Pod实例
    relabel_configs:
    - source_labels: [__address__]
      regex: (.*):9121
      action: keep

    # 保留特定维度的标签
    - source_labels: [__meta_kubernetes_namespace]
      target_label: namespace
    - source_labels: [__meta_kubernetes_service_name]
      target_label: service_name
    - source_labels: [__meta_kubernetes_pod_name]
      target_label: pod_name
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240318214141751.png&#34; alt=&#34;image-20240318214141751&#34; /&gt;&lt;/p&gt;
&lt;p&gt;5、检查此前创建好的 redis_rules.yml 告警规则⽂件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  redis_rules.yml: |-
    groups:
    - name: redis告警规则
      rules:
      - alert: Redis实例宕机
        expr: redis_up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例宕机&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod在过去5分钟内无法连接。&amp;quot;

      - alert: Redis连接数过高
        expr: redis_connected_clients / redis_config_maxclients * 100 &amp;gt; 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例连接数超过80%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod当前连接数占最大连接数的比率超过80%。当前比率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: Redis连接被拒绝
        expr: increase(redis_rejected_connections_total[1h]) &amp;gt; 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例有连接被拒绝&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod在过去1小时内有连接被拒绝。当前被拒绝的连接数: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;。&amp;quot;

      - alert: Redis内存使用率过高
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 &amp;gt; 80
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例内存使用率超过80%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod的内存使用率超过配置的最大内存值的80%。当前内存使用率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: Redis缓存命中率低
        expr: |
          irate(redis_keyspace_hits_total[5m])
          / 
          (irate(redis_keyspace_hits_total[5m]) + irate(redis_keyspace_misses_total[5m])) * 100 &amp;lt; 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例缓存命中率低于90%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod最近5分钟内的缓存命中率低于90%。当前命中率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: Redis即将过期的Key数量过多
        expr: |
          sum(redis_db_keys_expiring) by (instance, job, namespace,pod_name,db)
          / 
          sum(redis_db_keys) by (instance, job, namespace,pod_name,db) * 100 &amp;gt; 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例中的 &#39;&amp;#123;&amp;#123; $labels.db &amp;#125;&amp;#125;&#39; 数据库有大量即将过期的Key&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod中的 &#39;&amp;#123;&amp;#123; $labels.db &amp;#125;&amp;#125;&#39; 数据库有超过50%的Key即将过期。当前过期比率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: RedisRDB备份失败
        expr: redis_rdb_last_bgsave_status == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例 RDB备份失败&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod最近的RDB备份失败。&amp;quot;

      - alert: RedisRDB备份时间过长
        expr: redis_rdb_last_bgsave_duration_sec &amp;gt; 3 and redis_rdb_last_bgsave_status == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例 RDB备份成功但耗时超过3秒&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod, RDB备份成功但耗时超过了3秒。持续时间: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。&amp;quot;

      - alert: RedisRDB备份过期
        expr: (time() - redis_rdb_last_save_timestamp_seconds) &amp;gt; 36000
        for: 24h
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例超过10小时未进行RDB备份&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod已超过10小时没有生成新的RDB备份文件。&amp;quot;

      - alert: Redis命令拒绝率过高
        expr: |
          sum(irate(redis_commands_rejected_calls_total[5m])) by (instance,job,namespace,pod_name)
          / 
          sum(irate(redis_commands_total[5m])) by (instance,job,namespace,pod_name) * 100 &amp;gt; 25
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例命令拒绝率超过25%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod的命令拒绝率超过了25%。当前拒绝率: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%。&amp;quot;

      - alert: Redis命令平均响应时间过长
        expr: |
          sum(rate(redis_commands_duration_seconds_total[5m])) by (instance,job,namespace,pod_name)
          / 
          sum(rate(redis_commands_processed_total[5m])) by (instance,job,namespace,pod_name) &amp;gt; 0.250
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; Redis实例命令平均响应时间超过250ms&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间中 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod的执行命令平均响应时间超过了250毫秒。当前平均响应时间: &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒。&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&#34;9-prometheus监控java业务应用的pod&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#9-prometheus监控java业务应用的pod&#34;&gt;#&lt;/a&gt; 9、Prometheus 监控 java 业务应⽤的 Pod&lt;/h4&gt;
&lt;h5 id=&#34;91-监控业务应用场景说明&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#91-监控业务应用场景说明&#34;&gt;#&lt;/a&gt; 9.1 监控业务应⽤场景说明&lt;/h5&gt;
&lt;p&gt;运⾏ javaapp 的业务应⽤ Pod，⽽后为其创建⼀个 Service、Ingress，现在我们希望监控 Pod 状态，Pod 资源的使⽤，jvm 内存相关指标、Service 的 TCP 检测、以及域名响应状态、延迟、存活性等检测。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;1、java 应⽤指标：在初始化容器运⾏⼀个 jmx_exporter 的容器，并将相关的 jar 和 config.yaml 共享给主容器，主容器通过 JVM 环境变量传递相关启动参数，完成 jvm 的监控；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;2、pod 的运⾏状态：kube-state-metrics 能⾃动获取，因此⽆需考虑；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;3、pod 的资源使⽤：kubelet 的 CadVisor 能⾃动获取到每个 Pod 的资源使⽤，因此⽆需考虑；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;4、service 的存活性以及延迟：通过此前 kube-blackbox-tcp，能⾃动监控其 Service 的 8080 端⼝和 12345 端⼝；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;5、ingress 的 http 状态监控，通过此前 kube-blackbox-http，能⾃动监控其 ingress 的域名状态；&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;92-运行业务应用容器pod&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#92-运行业务应用容器pod&#34;&gt;#&lt;/a&gt; 9.2 运⾏业务应⽤容器 Pod&lt;/h5&gt;
&lt;p&gt;1、由于官⽅没有提供 jmx_prometheus 的镜像，因此需要先⾃⾏制作镜像。（也可以直接使⽤我制作好的镜像 oldxu3957/jmx_prometheus:v0.20.0 ）&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 dockerfile]# wget https://repo.maven.apache.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.20.0/jmx_prometheus_javaagent-0.20.0.jar

[root@k8s-master01 dockerfile]# cat config.yaml
rules:
- pattern: &amp;quot;.*&amp;quot;

# Dockerfile⽂件
[root@prom-node03 jmx_exporter]# cat Dockerfile
FROM alpine:latest
ENV VERSION=&amp;quot;0.20.0&amp;quot;
ENV DIR=/jmx
COPY ./config.yaml $&amp;#123;DIR&amp;#125;/config.yaml
COPY ./jmx_prometheus_javaagent-$&amp;#123;VERSION&amp;#125;.jar $&amp;#123;DIR&amp;#125;/jmx_prometheus.jar
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、运⾏ java 应⽤ Pod&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 09-java-exporter]# cat 01-javaapp-deployment.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: java-app
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: java
  template:
    metadata:
      labels:
        app: java
    spec:
      volumes:
      - name: javaagent
        emptyDir: &amp;#123;&amp;#125;
      initContainers:                # 运⾏初始化容器（将⽂件夹整体拷⻉⾄javaagent共享卷）
      - name: jmx-prometheus
        image: oldxu3957/jmx_prometheus:v0.20.0
        command: [&amp;quot;sh&amp;quot;,&amp;quot;-c&amp;quot;,&amp;quot;cp -rp /jmx /data/&amp;quot;]
        volumeMounts:
        - name: javaagent
          mountPath: /data
      containers:
      - name: javaapp
        image: oldxu3957/javaapp:v1.0
        env:
        - name: JAVA_TOOL_OPTIONS     # 通过JAVA_TOOL_OPTIONS传递JVM相关参数
          value: &amp;quot;-Xms100m -Xmx100m \
                 -javaagent:/agent/jmx/jmx_prometheus.jar=12345:/agent/jmx/config.yaml&amp;quot;
        volumeMounts:
        - name: javaagent
          mountPath: /agent
        ports:
        - name: java
          containerPort: 8080
        - name: jmx
          containerPort: 12345
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
          limits:
            cpu: 100m
            memory: 200Mi
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;93-对外发布java业务应用&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#93-对外发布java业务应用&#34;&gt;#&lt;/a&gt; 9.3 对外发布 java 业务应⽤&lt;/h5&gt;
&lt;p&gt;1、创建 Service，需要暴露 8080 端⼝和 12345 端⼝&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 09-java-exporter]# cat 02-javaapp-service.yaml 
kind: Service
apiVersion: v1
metadata:
  name: javaapp-svc
  namespace: default
  labels:
    app: java
  annotations:
    prometheus.io/scrape: &amp;quot;true&amp;quot;
    prometheus.io/scheme: &amp;quot;http&amp;quot;
    prometheus.io/path: &amp;quot;/metrics&amp;quot;
    prometheus.io/port: &amp;quot;12345&amp;quot;
spec:
  selector:
    app: java
  ports:
  - name: javaapp
    port: 8080
    targetPort: 8080
  - name: jmx
    port: 12345
    targetPort: 12345
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、创建 Ingress&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 09-java-exporter]# cat 03-javaapp-ingress.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: javaapp-ingress
  namespace: default
spec:
  ingressClassName: &amp;quot;nginx&amp;quot;
  rules:
  - host: &amp;quot;javaapp.hmallleasing.com&amp;quot;
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: javaapp-svc
            port:
              number: 8080
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、更新资源清单&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 09-java-exporter]# kubectl apply -f .
&lt;/code&gt;&lt;/pre&gt;
&lt;h5 id=&#34;94-配置prometheus监控业务应用&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#94-配置prometheus监控业务应用&#34;&gt;#&lt;/a&gt; 9.4 配置 Prometheus 监控业务应⽤&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;1、添加⼀个新的 Job，名为： java-pod&lt;/li&gt;
&lt;li&gt;2、基于 Kubernetes 的 endpints 来实现⾃动发现&lt;/li&gt;
&lt;li&gt;3、使⽤ relabel_configs，仅抓取 &lt;strong&gt;address&lt;/strong&gt; 地址对应的端⼝是 12345 的实例。&lt;/li&gt;
&lt;li&gt;4、使⽤ relabel_configs，保留 __meta_kubernetes_namespace、__meta_kubernetes_service_name、__meta_kubernetes_pod_name 这三个维度的标签。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1、配置 Prometheus&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# cat 01-prom-configs-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-configs
  namespace: monitoring
data:
  prometheus.yml: |-
    global:
      scrape_interval: 15s
      scrape_timeout:  15s
    
    # 告警地址(填写AlertManager的负载均衡地址即可)
    alerting:
      alertmanagers:
      - static_configs:
        - targets: [&amp;quot;alertmanager-svc:9093&amp;quot;]
    
    # 告警规则文件
    rule_files:
      - &amp;quot;/etc/prometheus/rules/*.yml&amp;quot;

    scrape_configs:
      - job_name: &amp;quot;prometheus&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        static_configs:
        - targets: [&amp;quot;localhost:9090&amp;quot;]

      # 监控Kubernetes的节点
      - job_name: &amp;quot;kube-nodes&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: &amp;quot;(.*):10250&amp;quot;
          replacement: &amp;quot;$1:9100&amp;quot;
          target_label: __address__
          action: replace
        - regex: __meta_kubernetes_node_label_(.*)
          replacement: $1
          action: labelmap

      # 监控APIServer
      - job_name: &amp;quot;kube-apiserver&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          insecure_skip_verify: true   # 跳过证书验证
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 标签重写
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_component&amp;quot;]  #保留label为apiserver实例
          regex: &amp;quot;apiserver&amp;quot;
          action: &amp;quot;keep&amp;quot;
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]        #匹配__meta_kubernetes_namespace值，并赋值给namespace
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]    #__meta_kubernetes_service_name值并赋值给service_name
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name
        - regex: __meta_kubernetes_service_label_(.*)        #通过标签映射获取标签
          replacement: $1
          action: labelmap


      # 监控controllerManager
      - job_name: &amp;quot;kube-controller&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # 仅保留标签名是component 值为kube-controller-manager
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-controller-manager&amp;quot;
          action: keep
        # 替换抓取的实例端口为10257
        - source_labels: [__address__]
          regex: (.*)
          replacement: $1:10257
          target_label: __address__
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控Scheduler
      - job_name: &amp;quot;kube-schduler&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: pod
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 基于标签进行过滤
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;kube-scheduler&amp;quot;
          action: keep

        # 修订抓取的端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:10259
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控etcd
      - job_name: &amp;quot;kube-etcd&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_component&amp;quot;]
          regex: &amp;quot;etcd&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__address__&amp;quot;]
          regex: (.*)
          replacement: $1:2381
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控CoreDNS
      - job_name: &amp;quot;kube-dns&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-dns&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:9153
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name
        - source_labels: [&amp;quot;__meta_kubernetes_service_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: service_name

      # 监控kube-proxy
      - job_name: &amp;quot;kube-proxy&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: pod

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_pod_label_k8s_app&amp;quot;]
          regex: &amp;quot;kube-proxy&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:10249
          target_label: __address__

        # 添加维度标签
        - source_labels: [&amp;quot;__meta_kubernetes_namespace&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: namespace
        - source_labels: [&amp;quot;__meta_kubernetes_pod_name&amp;quot;]
          regex: &amp;quot;(.*)&amp;quot;
          replacement: $1
          target_label: pod_name

      # 监控kube-state-metrics
      - job_name: &amp;quot;kube-state-metrics&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints

        # 保留对应标签的Pod
        relabel_configs:
        - source_labels: [&amp;quot;__meta_kubernetes_service_label_app_kubernetes_io_name&amp;quot;]
          regex: &amp;quot;kube-state-metrics&amp;quot;
          action: keep

        # 修订端口
        - source_labels: [&amp;quot;__meta_kubernetes_pod_ip&amp;quot;]
          regex: (.*)
          replacement: $1:8080
          target_label: __address__

        # 添加维度标签
        - regex: __meta_kubernetes_service_label_(.*)
          action: labelmap

      # 监控kubelet(Pod)
      - job_name: &amp;quot;kube-kubelet&amp;quot;
        metrics_path: &amp;quot;/metrics/cadvisor&amp;quot;
        scheme: https
        kubernetes_sd_configs:
        - role: node
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        # 添加标签的映射
        relabel_configs:
        - regex: __meta_kubernetes_node_label_(.*)
          action: labelmap

      # 监控service
      - job_name: &amp;quot;kube-blackbox-tcp&amp;quot;
        metrics_path: &amp;quot;/probe&amp;quot;
        params:
          module: [tcp_connect]         # 使用tcp_connect模块
        kubernetes_sd_configs:
        - role: service
        relabel_configs:
        - source_labels: [__address__]
          target_label: __param_target
        - source_labels: [__param_target]
          target_label: instance
        - target_label: __address__
          replacement: blackbox-svc:9115
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          regex: (.*)
          replacement: $1
          target_label: namespace
        - source_labels: [__meta_kubernetes_service_name]
          regex: (.*)
          replacement: $1
          target_label: service_name

      # 监控ingress
      - job_name: &amp;quot;kube-blackbox-http&amp;quot;
        metrics_path: &amp;quot;/probe&amp;quot;
        params:
          module: [http_2xx]            # 使用http模块进行探测
        kubernetes_sd_configs:
        - role: ingress
        relabel_configs:
        # 协议有可能是http或https，因此需要根据抓取到的协议+端⼝，拼接出具体的探测示例
        - source_labels: [__meta_kubernetes_ingress_scheme,__address__]
          regex: (.*);(.*)
          replacement: $1://$2
          target_label: __param_target
        - source_labels: [__param_target]
          target_label: instance
        - target_label: __address__
          replacement: blackbox-svc:9115
        # 保留特定标签
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - source_labels: [__meta_kubernetes_ingress_name]
          target_label: ingress_name
        - source_labels: [__meta_kubernetes_ingress_class_name]
          target_label: ingress_class_name

      # 监控redis
      - job_name: &amp;quot;kube-redis&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints

        # 保留端口为9121的Pod实例
        relabel_configs:
        - source_labels: [__address__]
          regex: (.*):9121
          action: keep

        # 保留特定维度的标签
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - source_labels: [__meta_kubernetes_service_name]
          target_label: service_name
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod_name

      # 监控java
      - job_name: &amp;quot;kube-java-pod&amp;quot;
        metrics_path: &amp;quot;/metrics&amp;quot;
        kubernetes_sd_configs:
        - role: endpoints

        # 保留端口为12345的Pod实例
        relabel_configs:
        - source_labels: [__address__]
          regex: (.*):12345
          action: keep

        # 保留特定维度的标签
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - source_labels: [__meta_kubernetes_service_name]
          target_label: service_name
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod_name

[root@k8s-master01 04-prometheus]# kubectl apply -f 01-prom-configs-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查配置是否更新&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# kubectl exec -it prometheus-0 -n monitoring -- cat /etc/prometheus/prometheus.yml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、重新加载 Prometheus，然后检查节点的 targets，能正常监控 Kubernets 的节点&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@k8s-master01 04-prometheus]# curl -X POST http://k8s-prom.hmallleasing.com/-/reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;4、检查 Prometheus 抓取的结果&lt;/p&gt;
&lt;h5 id=&#34;95-检查此前创建好的-jvm_rulesyml-告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#95-检查此前创建好的-jvm_rulesyml-告警规则文件&#34;&gt;#&lt;/a&gt; 9.5 检查此前创建好的 jvm_rules.yml 告警规则⽂件&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;  jvm_rules.yml: |-
    groups:
    - name: &amp;quot;JVM告警规则&amp;quot;
      rules:
      - alert: JVM堆内存使用率过高
        expr: jvm_memory_bytes_used&amp;#123;area=&amp;quot;heap&amp;quot;,&amp;#125; / jvm_memory_bytes_max&amp;#123;area=&amp;quot;heap&amp;quot;,&amp;#125; * 100 &amp;gt; 90
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 实例的JVM 堆内存使用率超过80%&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间下的 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; PodJVM堆内存使用率超过80%, 当前使用率是 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;%&amp;quot;

      - alert: JVMGC时间过长
        expr: sum (rate(jvm_gc_collection_seconds_sum[5m]) / rate(jvm_gc_collection_seconds_count[5m])) by (instance,job,gc,namespace,pod_name) &amp;gt; 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 实例的JVM  GC时间超过了1秒。&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间下的 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod使用 &amp;#123;&amp;#123; $labels.gc &amp;#125;&amp;#125; GC垃圾回收算法时间超过1s，当前值 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;秒&amp;quot;

      - alert: JVM死锁线程过多
        expr: min_over_time(jvm_threads_deadlocked[5m]) &amp;gt; 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &amp;quot;JVM检测到&#39;&amp;#123;&amp;#123; $labels.instance &amp;#125;&amp;#125;&#39; 实例有死锁线程&amp;quot;
          description: &amp;quot;&#39;&amp;#123;&amp;#123; $labels.namespace &amp;#125;&amp;#125;&#39; 名称空间下的 &#39;&amp;#123;&amp;#123; $labels.pod_name &amp;#125;&amp;#125;&#39; Pod，在过去5分钟检测到死锁线程, 当前死锁线程数是 &amp;#123;&amp;#123; $value &amp;#125;&amp;#125;。&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
</content>
        <category term="Prometheus" />
        <updated>2025-07-15T02:33:49.000Z</updated>
    </entry>
    <entry>
        <id>http://ixuyong.cn/posts/737291847.html</id>
        <title>Prometheus监控实战（五）</title>
        <link rel="alternate" href="http://ixuyong.cn/posts/737291847.html"/>
        <content type="html">&lt;h3 id=&#34;prometheus服务发现与relabel&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#prometheus服务发现与relabel&#34;&gt;#&lt;/a&gt; Prometheus 服务发现与 Relabel&lt;/h3&gt;
&lt;h4 id=&#34;一-prometheus服务发现&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#一-prometheus服务发现&#34;&gt;#&lt;/a&gt; 一. Prometheus 服务发现&lt;/h4&gt;
&lt;h5 id=&#34;11-为什么需要服务发现&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#11-为什么需要服务发现&#34;&gt;#&lt;/a&gt; 1.1 为什么需要服务发现&lt;/h5&gt;
&lt;p&gt;Prometheus 采⽤ Pull 模型来抓取⽬标主机的指标数据，这就意味着 Prometheus 必须事先知道每个要监控的⽬标的端点地址。然后才能从对应的 Exporter 或 Instrumentation 进⾏数据抓取。对于规模较⼩，且监控的⽬标不会频繁的发⽣变动，直接使⽤ static_configs 静态配置来监控它们，就⾮常简便。&lt;/p&gt;
&lt;p&gt;但是，当我们⾯对容器应⽤的场景时，会发现监控的这些⽬标端点可能会频繁的发⽣变化。因此使⽤静态配置⽅法可能不太适⽤了。那么 Prometheus 为了适应这种动态性，引⼊了多种类型的服务发现机制。这些机制使得 Prometheus 能够动态地从 “服务注册中⼼” ⾃动的发现可被监控的⽬标。即使监控的⽬标端发⽣了变化，Prometheus 也能⾃动的发现这些变化并对相应的配置进⾏⾃动更新，⽽⽆需认为参与。⼤⼤的降低了维护成本。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/YjTVTD7.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;12-服务发现的实现方式&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#12-服务发现的实现方式&#34;&gt;#&lt;/a&gt; 1.2 服务发现的实现⽅式&lt;/h5&gt;
&lt;p&gt;Prometheus 的服务发现（Service Discovery, SD）可以与各种不同的服务发现系统集成，从⽽⾃动发现监控⽬标。以下是⼀些常⻅的服务发现机制的实现⽅式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、静态服务配置：可以通过配置⽂件指定固定地址和端⼝，对⽬标服务进⾏监控。&lt;/li&gt;
&lt;li&gt;2、基于⽂件的发现机制：以配置⽂件作为发现的源头，通过监控这些⽂件的变动来动态调整监控⽬标的增加或减少。通常会配合如像 Ansible 这样的⼯具⼀起使⽤，对配置⽂件进⾏批量更新，只需要让 Prometheus 重新加载这些配置，就能⾃动适应新的监控环境。&lt;/li&gt;
&lt;li&gt;3、基于注册中⼼的发现机制：在微服务架构中，常常会使⽤ Consul 等服务注册中⼼来管理所有的服务。Prometheus 可以读取 Consul 中的服务列表，从⽽⾃动发现并开始监控所有注册的服务。&lt;/li&gt;
&lt;li&gt;4、基于公有云 API 的发现机制：当你需要监控公有云上的 RDS 服务时，⼀条条配置⾮常麻烦，这个时候就可以使⽤ Prometheus 基于公有云的 OpenAPI 进⾏服务发现。例如，配置 Prometheus ⾃动拉取 AWS 账号下所有 RDS 实例的列表，从⽽实现对所有数据库实例的监控。&lt;/li&gt;
&lt;li&gt;5、基于 Kubernetes 的发现机制：在 Kubernetes 环境中，Prometheus 可以通过调⽤ kube-apiserver 获取集群中的 Node、Pod、Endpoint、Ingress 等信息。例如，如果你在 Kubernetes 集群中部署了⼀个新的应⽤，Prometheus 可以⾃动发现并开始监控这个新的 Pod。&lt;/li&gt;
&lt;li&gt;6、基于 DNS、HTTP 等等服务发现，使⽤的不多，就不⼀⼀展开， 更多服务发现⽅式参考地址。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;二-prometheus基于文件服务发现&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#二-prometheus基于文件服务发现&#34;&gt;#&lt;/a&gt; 二. Prometheus 基于⽂件服务发现&lt;/h4&gt;
&lt;h5 id=&#34;21-基于文件服务发现介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#21-基于文件服务发现介绍&#34;&gt;#&lt;/a&gt; 2.1 基于⽂件服务发现介绍&lt;/h5&gt;
&lt;p&gt;Prometheus 基于⽂件的服务发现⾮常的简单，因为它不依赖任何特定的平台或第三⽅服务。&lt;/p&gt;
&lt;p&gt;⽤户只需在 Prometheus 配置⽂件中指定 file_sd_configs 选项来监视⼀个⽂件。这个⽂件包含了要监控的⽬标列表。那么 Prometheus 则会周期性地检查该⽂件，⼀旦发现有任何变更，则会⽴即更新对应的监控⽬标。&lt;/p&gt;
&lt;h5 id=&#34;22-基于文件服务发现实践&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#22-基于文件服务发现实践&#34;&gt;#&lt;/a&gt; 2.2 基于⽂件服务发现实践&lt;/h5&gt;
&lt;p&gt;将此前的 node_exporter 修改为基于⽂件发现的⽅式&lt;/p&gt;
&lt;p&gt;1、配置 Prometheus&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  file_sd_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - /etc/prometheus/targets/node*.yml &lt;span class=&#34;token comment&#34;&gt;# 指定⽂件路径&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    refresh_interval: 1m                &lt;span class=&#34;token comment&#34;&gt;# 刷新间隔，默认 1m&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、定义发现规则⽂件（将 node01 和 node02 添加⼀个 env=prod 的标签，将 node03 添加 env=test 的标签，这样后期就可以基于不同的环境做分析。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mkdir /etc/prometheus/targets&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/targets/node_exporter.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- targets:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - prom-node01.oldxu.net:9100&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - prom-node02.oldxu.net:9100&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    env: prod&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- targets:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - prom-node03.oldxu.net:9100&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    env: &lt;span class=&#34;token builtin class-name&#34;&gt;test&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、重新加载 Prometheus 配置⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;23-基于文件服务发现验证&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#23-基于文件服务发现验证&#34;&gt;#&lt;/a&gt; 2.3 基于⽂件服务发现验证&lt;/h5&gt;
&lt;p&gt;1、检查 Prometheus 的 Status-&amp;gt;Targets ⻚⾯，验证 node_exporter 是否已经成功纳⼊监控&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/vscb875.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;三-prometheus基于consul服务发现&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#三-prometheus基于consul服务发现&#34;&gt;#&lt;/a&gt; 三. Prometheus 基于 Consul 服务发现&lt;/h4&gt;
&lt;h5 id=&#34;31-consul基本介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#31-consul基本介绍&#34;&gt;#&lt;/a&gt; 3.1 Consul 基本介绍&lt;/h5&gt;
&lt;p&gt;Consul 是⼀个开源的服务发现和配置管理系统，任何服务都可以向 Consul 注册⾃⼰的实例信息（例如 Web 服务器、数据库、各种内部 API 等），并且其他服务可以通过 Consul 查询这些已注册的服务信息。&lt;/p&gt;
&lt;p&gt;Prometheus 基于 Consul 的服务发现流程如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、当运⾏⼀个服务时，他会将⾃⼰服务的信息（如服务名称、地址、端⼝等。）注册到 consul 中，当服务不再可⽤时，它会从 Consul 中注销。&lt;/li&gt;
&lt;li&gt;2、 Prometheus 配置基于 consul 的服务发现，那么它会定期向 Consul 查询当前可⽤的服务列表和元数据。&lt;/li&gt;
&lt;li&gt;3、Prometheus 使⽤从 Consul 获取的服务信息，来构建⽬标 URL，然后对这些 URL 进⾏数据采集，以监控服务的运⾏状况。&lt;/li&gt;
&lt;li&gt;4、如果某个服务在 Consul 中被标记为不健康或被注销，Prometheus 会⾃动将这个服务从监控⽬标列表中移除，确保监控⽬标的准确性。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;32-安装consul服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#32-安装consul服务&#34;&gt;#&lt;/a&gt; 3.2 安装 Consul 服务&lt;/h5&gt;
&lt;p&gt;1、访问 consul 官⽅下载地址 &lt;a href=&#34;https://www.consul.io/downloads/&#34;&gt;https://www.consul.io/downloads/&lt;/a&gt; ，下载 consul ⾄ prom-node05.oldxu.net 节点&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node05 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://releases.hashicorp.com/consul/1.17.1/consul_1.17.1_linux_amd64.zip&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、解压 consul&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@prom-node05 ~]# unzip consul_1.17.1_linux_amd64.zip -d /usr/local/bin/
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、准备 consul 启动⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node05 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/consul.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;Consul Service Discovery Agent&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://www.consul.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network-online.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Wants&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network-online.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;simple&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;root&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Group&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;root&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/usr/local/bin/consul agent &lt;span class=&#34;token parameter variable&#34;&gt;-server&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-ui&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;span class=&#34;token parameter variable&#34;&gt;-node&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;consul-server &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      -bootstrap-expect&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      -data-dir&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/var/lib/consul &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;span class=&#34;token parameter variable&#34;&gt;-bind&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.225 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;span class=&#34;token parameter variable&#34;&gt;-client&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;0.0&lt;/span&gt;.0.0&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;on-failure&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node05 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node05 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start consul &amp;amp;&amp;amp; systemctl enable consul&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;agent：执⾏的命令，各参数含义：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;-server ：表示节点是 server 类型&lt;/li&gt;
&lt;li&gt;-ui ：启⽤ consul 的 web ⻚⾯管理&lt;/li&gt;
&lt;li&gt;-node ：节点名称&lt;/li&gt;
&lt;li&gt;-bootstrap-expect ：表示集群中有⼏个 server 节点进⾏ Leader 选举，单节点集群，就为 1&lt;/li&gt;
&lt;li&gt;-data-dir ：数据⽬录&lt;/li&gt;
&lt;li&gt;-bind ：集群内部通信地址，默认是 0.0.0.0&lt;/li&gt;
&lt;li&gt;-client ：客户端地址，默认是 127.0.0.1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;4、访问 consul 的 UI ⻚⾯，通过 &lt;a href=&#34;http://IP:8500&#34;&gt;http://IP:8500&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/aQewRUO.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;33-注册实例至consul&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#33-注册实例至consul&#34;&gt;#&lt;/a&gt; 3.3 注册实例⾄ Consul&lt;/h5&gt;
&lt;p&gt;1、注册节点信息⾄ Consul&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# node01&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node05 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X PUT --data &#39;&amp;#123;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Name&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;ID&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;node01&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Address&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Port&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;9100&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Tags&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;shanghai&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prod&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Checks&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token string&#34;&gt;&#34;HTTP&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;http://prom-node01.oldxu.net:9100/metrics&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token string&#34;&gt;&#34;Interval&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;5s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39; http://localhost:8500/v1/agent/service/register&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;# node02&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;[root@prom-node05 ~]# curl -X PUT --data &#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Name&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;ID&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;node02&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Address&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Port&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;9100&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Tags&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;shanghai&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prod&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Checks&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token string&#34;&gt;&#34;HTTP&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;http://prom-node02.oldxu.net:9100/metrics&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token string&#34;&gt;&#34;Interval&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;5s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39; http://localhost:8500/v1/agent/service/register&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;# node03&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;[root@prom-node05 ~]# curl -X PUT --data &#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Name&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;ID&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;node03&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Address&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Port&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;9100&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Tags&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;beijing&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;test&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token string&#34;&gt;&#34;Checks&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token string&#34;&gt;&#34;HTTP&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;http://prom-node03.oldxu.net:9100/metrics&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token string&#34;&gt;&#34;Interval&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;5s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&#39; http://localhost:8500/v1/agent/service/register&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、检查注册的节点信息&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/prfif3D.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3、如何注销对应实例的注册信息&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;curl&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--request&lt;/span&gt; PUT http://localhost:8500/v1/agent/service/deregister/&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;ID_Name&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;34-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#34-配置prometheus&#34;&gt;#&lt;/a&gt; 3.4 配置 Prometheus&lt;/h5&gt;
&lt;p&gt;1、配置 Prometheus，添加⼀个名为 consul_nodes 的 Job，并使⽤ Consul 进⾏服务发现，步骤如下&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    consul_sd_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - server: &lt;span class=&#34;token string&#34;&gt;&#34;prom-node05.oldxu.net:8500&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;span class=&#34;token comment&#34;&gt;#services: [&#34;node_exporter&#34;] # 限定仅从 Consul 的 node_exporter 这个 Service 发现实例信息（可不配置）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、重新加载 Prometheus 配置⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、检查 Prometheus 的 Status-&amp;gt;Targets ⻚⾯，验证 consul_nodes 是否已经成功纳⼊监控&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/ieOWwC3.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;4、验证，添加和删除 consul 中的实例，检查 Prometheus 是否会⾃动完成更新。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;curl&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--request&lt;/span&gt; PUT http://localhost:8500/v1/agent/service/deregister/node03&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/85BUgQT.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;四-服务发现与relabeling&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#四-服务发现与relabeling&#34;&gt;#&lt;/a&gt; 四。服务发现与 Relabeling&lt;/h4&gt;
&lt;h5 id=&#34;41-为何需要relabel&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#41-为何需要relabel&#34;&gt;#&lt;/a&gt; 4.1 为何需要 Relabel&lt;/h5&gt;
&lt;p&gt;通过前⾯的演示，我们知道 Prometheus 连接 consul，就能⾃动地从 Consul 服务中获取已注册的实例信息，并对这些实例进⾏监控。后续 Prometheus 还会周期性的从 Consul 中获取最新的实例信息，已便能，动态的更新监控的⽬标列表。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/BzUXuJG.jpeg&#34; alt=&#34;5.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;但对于线上环境，我们通常将对服务器集群分成不同的环境，⽐如⽣产环境（prod）和测试环境（test）。这种划分就带来了⼏个额外的需求：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、需要确保从每个实例抓取的监控指标都能够清晰地表明它所属的环境。这就需要在指标的标签中添加 env=prod 或 env=test 来实现，只有这样，我们才能对不同的环境进⾏分析。&lt;/li&gt;
&lt;li&gt;2、研发团队通常只关注测试环境的实例。因此我们需要⼀种⽅式来过滤实例，只将测试环境的实例提供给研发团队。&lt;/li&gt;
&lt;li&gt;3、如果我们为每个团队配置了独⽴的 Prometheus 服务器，我们就需要确保每个服务器只收集与该团队相关环境的监控实例。这意味着，我们需要在服务发现过程中进⾏配置，以便不同的 Prometheus 抓取不同环境的实例。。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;⾯对以上这些场景的需求，我们就希望 Prometheus 能够根据特定的（规则）来筛选⽬标实例、或者是给⽬标实例添加不同维度的标签。具体来说，我们需要在抓取⽬标实例的指标之前，为⽬标实例增加 “标签” 来识别不同的环境。此外，我们还可以只抓取那些能匹配到 “特定标签” 的实例，⽽那些没有匹配到特定标签的实例则直接排除掉，不进⾏抓取。为了满⾜这种需求，Prometheus 设计了⼀个强⼤的特性，叫标签重写，也被称为 Relabel。&lt;/p&gt;
&lt;h5 id=&#34;42-relabel工作逻辑&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#42-relabel工作逻辑&#34;&gt;#&lt;/a&gt; 4.2 Relabel ⼯作逻辑&lt;/h5&gt;
&lt;p&gt;relabel 它可以在抓取⽬标实例数据之前，可以对⽬标实例的标签进⾏ “灵活的改写”。借助 Relabel，⽤户就可以⾃⾏定义复杂的 “标签选择逻辑”，从⽽精准的控制哪些实例应当被监控，哪些实例应当被排除。例如，我们可以设置规则，仅抓取带有 env=prod 标签的⽬标实例数据，⽽那些不含此标签的实例则忽略掉 。&lt;/p&gt;
&lt;p&gt;在 Prometheus 中，每个被监控的⽬标实例都有⼀组默认的元数据标签（Metadata），这些标签详细记录了⽬标实例的⼀些基本信息&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;_&lt;em&gt;address&lt;/em&gt;_ ：记录了当前被监控⽬标实例的⽹络地址，通常由主机名和端⼝号。Prometheus 抓取该⽬标的指标时会使⽤这个地址。&lt;/li&gt;
&lt;li&gt;_&lt;em&gt;scheme&lt;/em&gt;_ ：记录了抓取⽬标实例指标时应使⽤的 HTTP 协议类型，通常是 http 或 https。&lt;/li&gt;
&lt;li&gt;·_&lt;em&gt;metrics_path&lt;/em&gt;_ ：记录了 Prometheus 抓取指标数据时会通过⽬标实例的那个 URI 路径获取指标数据。默认路径通常是 /metrics。&lt;/li&gt;
&lt;li&gt;__param_&lt;name&gt; : 这是⼀种特殊的标签格式，⽤于在抓取时传递给⽬标服务的特定 HTTP 请求参数。&lt;name&gt;是请求参数的名称。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这些以 (双下划线) 开头的，都属于特殊标签，它们主要⽤于内部处理，通常不会出现在采集的指标标签中。不过，默认的 Prometheus 会为采集到的每⼀个实例⾃动添加⼀个 instance 标签，⽽这个 instance 标签的值，其实就是从⽬标实例的内部 address__ 标签那⾥继承来的。这其实是⼀个标签重写的过程，也就是在数据采集之前，已经对⽬标实例的内部标签进⾏了⼀次 Relabel 操作。（Relabel 后会将所有__开头的标签从标签集中删除。）&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/XxTExGr.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;因此，Relabel 功能提供了强⼤的标签定制能⼒，它允许我们对默认提供的元数据标签进⾏定制。我们可以更改标签、增加新的标签，或者保留那些满⾜特定条件标签的实例。从⽽使监控的⽬标实例更符合我们的具体需求。&lt;/p&gt;
&lt;h5 id=&#34;43-relabel配置示例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#43-relabel配置示例&#34;&gt;#&lt;/a&gt; 4.3 Relabel 配置示例&lt;/h5&gt;
&lt;p&gt;在 Prometheus 的配置中，relabel_configs 提供了强⼤的标签重写功能，允许对监控数据中的标签进⾏定制处理。每个 relabel_configs 规则都包含了如下⼏个关键参数，它们共同决定了如何处理标签。以下是⼀个 relabel_configs 的配置示例，它展示了如何提取源标签，进⾏匹配，并根据匹配结果决定保留还是丢弃⽬标&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;my_job&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# ... 其他配置 ...&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;span class=&#34;token comment&#34;&gt;# 规则 1: 重写实例标签的值&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使⽤ __address__ 作为源标签，它通常包含⽬标的 IP 地址和端⼝&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        regex: &lt;span class=&#34;token string&#34;&gt;&#34;(.*):10250&#34;&lt;/span&gt;          &lt;span class=&#34;token comment&#34;&gt;# 正则表达式匹配以 :10250 结尾的地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        replacement: &lt;span class=&#34;token string&#34;&gt;&#34;&lt;span class=&#34;token variable&#34;&gt;$&amp;#123;1&amp;#125;&lt;/span&gt;:9100&#34;&lt;/span&gt;     &lt;span class=&#34;token comment&#34;&gt;# 将匹配到的地址的端⼝替换为 9100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        action: replace              &lt;span class=&#34;token comment&#34;&gt;# 动作，替换&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        target_label: instance       &lt;span class=&#34;token comment&#34;&gt;# 替换后的地址赋值到 instance 标签&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;       &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;span class=&#34;token comment&#34;&gt;# 规则 2: 保留特定端⼝的⽬标实例&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;# 同样使⽤ __address__ 作为源标签&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        regex: &lt;span class=&#34;token string&#34;&gt;&#34;(.*):80&#34;&lt;/span&gt;              &lt;span class=&#34;token comment&#34;&gt;# 正则表达式匹配以 :80 结尾的地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        action: &lt;span class=&#34;token string&#34;&gt;&#34;keep&#34;&lt;/span&gt;                &lt;span class=&#34;token comment&#34;&gt;# 如果地址匹配此正则，则保留该实例（不丢弃）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;span class=&#34;token comment&#34;&gt;# 规则 3: 丢弃特定端⼝的⽬标实例&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;   &lt;span class=&#34;token comment&#34;&gt;# 再次使⽤ __address__ 作为源标签&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        regex: &lt;span class=&#34;token string&#34;&gt;&#34;(.*):8080&#34;&lt;/span&gt;             &lt;span class=&#34;token comment&#34;&gt;# 正则表达式匹配以 :8080 结尾的地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        action: &lt;span class=&#34;token string&#34;&gt;&#34;drop&#34;&lt;/span&gt;                 &lt;span class=&#34;token comment&#34;&gt;# 如果地址匹配此正则，则丢弃该实例（不抓取对应实例）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;relabel_configs 的配置语法&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 这是⼀个标签列表，其值将被⽤于后续的重标记操作。可以从原始⽬标的标签中选择⼀个或多个标签作为源。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; source_labels: &lt;span class=&#34;token string&#34;&gt;&#39;[&#39;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;labelname&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;, &lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;.&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;]&#39;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 当有多个 source_labels 时，这个参数定义了如何将它们的值合并在⼀起。如果没有指定，默认分隔符为分号 (;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; separator: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;string&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; default &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 正则表达式，⽤于匹配 source_labels 的值。如果没有指定，默认情况匹配任何字符串，即&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;.*&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; regex: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;regex&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; default &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;.*&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 如果正则表达式匹配成功，将通过 replacement 提取对应匹配的值。 如果没有指定，默认替换值为 $1，即匹配到的整个字符串。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; replacement: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;string&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; default &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 这定义了如果 regex 成功匹配，应该执⾏什么操作。操作可以是替换 (replace)、保留 (keep)、丢弃 (drop) 等。如果没有指定，默认操作是 replace。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; action: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;relabel_action&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; default &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; replace &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 当执⾏替换操作时，这个参数定义了应该将对应的值写⼊到哪个标签中（可以是 diy 的⼀个名称）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; target_label: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;labelname&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;relabel_action 字段⽤于定义重新标记的⾏为，其可⽤取值如下：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;替换 replace: ⽤于更改标签的值&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、⾸先拼接 source_labels 中指定的所有标签的值。&lt;/li&gt;
&lt;li&gt;2、然后使⽤ regex 字段提供的正则表达式，对这个拼接后的字符串进⾏匹配。&lt;/li&gt;
&lt;li&gt;3、如果匹配成功，就将 regex 匹配的结果，通过 “后向引⽤” 的⽅式赋予给 replacement&lt;/li&gt;
&lt;li&gt;4、最后将 replacement 中保存的值，赋予给 target_label 指定的标签。（可以对原有标签的覆盖，也可以是新创建的标签）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;keep、drop：⽤于删除或保留实例&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;keep：检查 source_labels 指定的标签，对应的值是否与 regex 匹配。当它们匹配时，这个⽬标实例才会被保留。&lt;/li&gt;
&lt;li&gt;drop：检查 source_labels 指定的标签，对应的值是否与 regex 匹配，当它们匹配时，这个⽬标实例才会被删除。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;创建或删除标签&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;labelmap：将 regex 对所有的标签名进⾏匹配判定，⽽后将匹配到的标签的值赋给 replacement 字段指定的标签名之上；通常⽤于取出匹配的标签名的⼀部分⽣成新标签；&lt;/li&gt;
&lt;li&gt;labeldrop：将 regex 对所有的标签名进⾏匹配判定，能够匹配到的标签将从该 target 的标签集中删除；&lt;/li&gt;
&lt;li&gt;labelkeep：将 regex 对所有的标签名进⾏匹配判定，不能匹配到的标签将从该 target 的标签集中删除；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;注意：要确保在 labeldrop 或 labelkeep 操作后，余下的标签集依然能惟⼀标识该指标&lt;/em&gt;&lt;/p&gt;
&lt;h4 id=&#34;五-relabel实践案例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#五-relabel实践案例&#34;&gt;#&lt;/a&gt; 五. Relabel 实践案例&lt;/h4&gt;
&lt;p&gt;Prometheus 从 Consul 中发现端点时，它会获取每个服务实例的元数据标签。以下是⼀些由 Consul 服务发现，提供的元数据标签示例及其⽤途：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;源标签&lt;/th&gt;
&lt;th&gt;标签⽤途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;__meta_consul_address&lt;/td&gt;
&lt;td&gt;Consul 服务的地址。可以⽤来添加⼀个标签，指明服务的地址。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__meta_consul_dc&lt;/td&gt;
&lt;td&gt;表示服务所在的数据中⼼。这可以⽤来创建⼀个标签，以区分不同数据中⼼的指标。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__meta_consul_node&lt;/td&gt;
&lt;td&gt;服务所在的 Consul 节点信息。可以⽤于标识服务属于哪个节点。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__meta_consul_service_address&lt;/td&gt;
&lt;td&gt;服务的访问地址。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__meta_consul_service_id&lt;/td&gt;
&lt;td&gt;服务的唯⼀ ID。这个标签可以⽤来唯⼀标识服务实例。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__meta_consul_service_port&lt;/td&gt;
&lt;td&gt;服务的端⼝。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__meta_consul_service&lt;/td&gt;
&lt;td&gt;服务的名称。这个标签可以⽤来显示服务的友好名称。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__meta_consul_tags&lt;/td&gt;
&lt;td&gt;服务的标签信息。这些标签可以⽤来添加额外的上下⽂信息，⽐如环境、版本号等。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h5 id=&#34;51-标签值替换replace&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#51-标签值替换replace&#34;&gt;#&lt;/a&gt; 5.1 标签值替换 replace&lt;/h5&gt;
&lt;p&gt;场景 1，对 Consul 注册的服务实例添加不同维度的标签。具体来说&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、从服务实例的 __meta_consul_tags 中提取地域信息，然后将对应的值赋予给 region 标签。&lt;/li&gt;
&lt;li&gt;2、从服务实例的 __meta_consul_tags 中提取环境信息，然后将对应的值赋予给 env 标签。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这样做有助于后续的指标分类，还能便于我们基于环境（如⽣产环境、测试环境）进⾏服务实例的筛选。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/rdWtpul.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;1、配置 Prometheus&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    consul_sd_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - server: &lt;span class=&#34;token string&#34;&gt;&#34;prom-node05.oldxu.net:8500&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__meta_consul_tags&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#39;.*(shanghai|beijing).*&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: replace&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: region&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__meta_consul_tags&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#39;.*(prod|test).*&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: replace&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: &lt;span class=&#34;token function&#34;&gt;env&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、验证结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/PJnm4sx.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3、通过指标查询 ，会发现在每个指标上都附着了对应的标签&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;env&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prod&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;region&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;shanghai&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.01&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;env&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prod&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;region&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;shanghai&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.08&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;env&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;test&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;region&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;beijing&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;52-保留实例keep&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#52-保留实例keep&#34;&gt;#&lt;/a&gt; 5.2 保留实例 keep&lt;/h5&gt;
&lt;p&gt;场景 1，保留从 Consul 服务中获取的所有实例，但端⼝是 9100 的节点。&lt;/p&gt;
&lt;p&gt;1、编辑 Prometheus 配置⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    consul_sd_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - server: &lt;span class=&#34;token string&#34;&gt;&#34;prom-node05.oldxu.net:8500&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__meta_consul_tags&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#39;.*(shanghai|beijing).*&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: region&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__meta_consul_tags&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#39;.*(prod|test).*&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: &lt;span class=&#34;token function&#34;&gt;env&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__scheme__,__address__,__metrics_path__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#39;(http|https)(.*)&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token string&#34;&gt;&#34;&lt;span class=&#34;token variable&#34;&gt;$&amp;#123;1&amp;#125;&lt;/span&gt;://&lt;span class=&#34;token variable&#34;&gt;$&amp;#123;2&amp;#125;&lt;/span&gt;&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: replace&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      separator: &lt;span class=&#34;token string&#34;&gt;&#34;&#34;&lt;/span&gt;      &lt;span class=&#34;token comment&#34;&gt;#将默认分割符号；更改为空&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: endpoint&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   &lt;span class=&#34;token comment&#34;&gt;# 仅保留地址为 9100 的节点&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;.*&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;:9100&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: keep&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、验证结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/uFxghhA.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;场景 2，添加⼀个新的 consul_node_prod 的 Job，并配置 Prometheus 只抓取那些在 __meta_consul_tags 标签中被标记为 prod 的服务实例。并丢弃其他所有⾮ Prod 的实例。这样运维团队就可以专注于监控⽣产环境的指标数据。&lt;/p&gt;
&lt;p&gt;1、修改 Prometheus 配置⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes_prod&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    consul_sd_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - server: &lt;span class=&#34;token string&#34;&gt;&#34;prom-node05.oldxu.net:8500&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__meta_consul_tags&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;.*(prod|test).*&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: replace&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: &lt;span class=&#34;token function&#34;&gt;env&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;env&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;prod&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: keep&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、验证结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/0Zm0o0K.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;53-删除实例drop&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#53-删除实例drop&#34;&gt;#&lt;/a&gt; 5.3 删除实例 drop&lt;/h5&gt;
&lt;p&gt;场景 1，将 consul 服务中注册的 8300 端⼝的实例，直接丢弃掉。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/lTJidQz.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;1、配置 Prometheus，匹配源标签 &lt;strong&gt;address&lt;/strong&gt; ，将节点为 8300 的直接丢弃；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    consul_sd_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - server: &lt;span class=&#34;token string&#34;&gt;&#34;prom-node05.oldxu.net:8500&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;.*&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;:8300&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: drop&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、验证结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/EOh3qqR.jpeg&#34; alt=&#34;5.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;场景 2，添加⼀个新的 consul_node_test 的 Job，并配置 Prometheus 只抓取那些在 __meta_consul_tags 标签中被标记为 test 的服务实例。并丢弃其他所有⾮ test 的实例。这样研发团队就可以专注于监控 test 环境实例的指标数据。&lt;/p&gt;
&lt;p&gt;1、编辑 Prometheus 配置⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes_test&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    consul_sd_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - server: &lt;span class=&#34;token string&#34;&gt;&#34;prom-node05.oldxu.net:8500&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__meta_consul_tags&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;.*(prod|test).*&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: replace&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: &lt;span class=&#34;token function&#34;&gt;env&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;     &lt;span class=&#34;token comment&#34;&gt;# env=prod 的删除就相当于只有 test 环境保留 （前提是只有两个环境，不然还是建议使⽤ keep 直接保留所需的环境）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;env&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;prod&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: drop&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、检查结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/hqA7aNi.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;54-标签值映射labelmap&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#54-标签值映射labelmap&#34;&gt;#&lt;/a&gt; 5.4 标签值映射 labelmap&lt;/h5&gt;
&lt;p&gt;场景 1，⽤ regex 正则表达式，对所有实例的标签进⾏匹配，匹配成功的标签将重命名，新标签名称由匹配到标签名，加上⼀个后缀 _name 构成，⽽ “标签值” 保持不变。&lt;/p&gt;
&lt;p&gt;1、编辑 Prometheus 配置&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes_test&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    consul_sd_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - server: &lt;span class=&#34;token string&#34;&gt;&#34;prom-node05.oldxu.net:8500&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__meta_consul_tags&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;.*(prod|test).*&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: replace&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: &lt;span class=&#34;token function&#34;&gt;env&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;env&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;prod&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: drop&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;(.*):9100&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: keep&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - regex: &lt;span class=&#34;token string&#34;&gt;&#34;(job|env)&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token string&#34;&gt;&#34;&lt;span class=&#34;token variable&#34;&gt;$&amp;#123;1&amp;#125;&lt;/span&gt;_name&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: labelmap&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、验证结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/rtYQr12.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;场景 2，在使⽤ Consul 服务发现时，将所有以 __meta_consul_service_ 为前缀的标签提取出来，并⽣成新的标签，但 “标签值” 任然不变。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/oa8VUrH.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;1、编辑 Prometheus 配置&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;consul_nodes_test&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    consul_sd_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - server: &lt;span class=&#34;token string&#34;&gt;&#34;prom-node05.oldxu.net:8500&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__meta_consul_tags&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;.*(prod|test).*&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: &lt;span class=&#34;token function&#34;&gt;env&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;env&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;prod&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: drop&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      regex: &lt;span class=&#34;token string&#34;&gt;&#34;(.*):9100&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: keep&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - regex: &lt;span class=&#34;token string&#34;&gt;&#34;(job|env)&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token string&#34;&gt;&#34;&lt;span class=&#34;token variable&#34;&gt;$&amp;#123;1&amp;#125;&lt;/span&gt;_name&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: labelmap&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - regex: &lt;span class=&#34;token string&#34;&gt;&#34;__meta_consul_service_(.*)&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: &lt;span class=&#34;token string&#34;&gt;&#34;consul_&lt;span class=&#34;token variable&#34;&gt;$&amp;#123;1&amp;#125;&lt;/span&gt;&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 在字段前⾯额外添加⼀个 consul_字符串&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      action: labelmap&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、验证结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/JM2hJWN.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
</content>
        <category term="Prometheus" />
        <updated>2025-07-14T13:48:14.000Z</updated>
    </entry>
    <entry>
        <id>http://ixuyong.cn/posts/4081185382.html</id>
        <title>Prometheus监控实战（四）</title>
        <link rel="alternate" href="http://ixuyong.cn/posts/4081185382.html"/>
        <content type="html">&lt;h3 id=&#34;prometheus告警服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#prometheus告警服务&#34;&gt;#&lt;/a&gt; &lt;strong&gt;Prometheus 告警服务&lt;/strong&gt;&lt;/h3&gt;
&lt;h4 id=&#34;一-什么是aleartmanager&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#一-什么是aleartmanager&#34;&gt;#&lt;/a&gt; 一。什么是 AleartManager&lt;/h4&gt;
&lt;h5 id=&#34;11-什么是-aleartmanager&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#11-什么是-aleartmanager&#34;&gt;#&lt;/a&gt; 1.1 什么是 AleartManager&lt;/h5&gt;
&lt;p&gt;由于 Prometheus 本身⽆法实现告警，因此需要借助 AlertManager 来实现告警的推送。&lt;/p&gt;
&lt;p&gt;Prometheus Server 会对已经设定好的 “告警规则” 进⾏定期评估，当检测到问题时，会⽣成相应的告警通知并发送给 AlertManager。AlertManager 则会根据告警消息所携带的 “标签” 和事先配置的 “路由规则（Routes）”，将告警消息分发⾄不同的接收器 / 接收⼈（receivers）。例如，带有 &amp;quot;system&amp;quot; 标签的告警会通过 Email 发送给运维团队，⽽带有 &amp;quot;database&amp;quot; 标签的告警则通过 WeChat 发给数据库团队。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/UsACANX.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;prometheus---&amp;gt; 评估规则 ---&amp;gt; 持续满⾜触发条件 ---&amp;gt; 触发告警 ---&amp;gt;alertmanager---&amp;gt; 根据路由规则匹配标签 --&amp;gt; 通过不同的媒介 ---&amp;gt; 发送不&lt;/p&gt;
&lt;p&gt;同的接收⼈（邮件 | 钉钉 | 微信）。&lt;/p&gt;
&lt;h5 id=&#34;12-aleartmanager特性&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#12-aleartmanager特性&#34;&gt;#&lt;/a&gt; 1.2 AleartManager 特性&lt;/h5&gt;
&lt;p&gt;除了基本的告警通知能⼒外，Altermanager 还⽀持对告警进⾏去重、分组、抑制、 静默和路由等功能：&lt;/p&gt;
&lt;p&gt;1、去重：prometheus ⼀条报警发送给多个 AlertManager，AlertManager 会对其进⾏去重并发送。&lt;/p&gt;
&lt;p&gt;2、分组（Group）：将相似告警合并为单个告警发送，在系统因⼤⾯积故障⽽触发告警潮时，分组机制能避免⽤户被⼤量的告警淹没，进⽽导致关键信息的隐没；&lt;/p&gt;
&lt;p&gt;例如：我们可能会使⽤ Prometheus 中的 up 指标来检测每台主机的存活状态。如果某台主机不可达，Prometheus 将会为这台主机⽣成⼀个 InstanceDown 的告警。如果多台主机同时出现不存活的问题，那么就会收到⼀连串的告警邮件，每个告警信息都是⼀个独⽴的事件，这样就⽐较难以区分哪些告警是最紧急的。⽽ Alertmanager 的分组功能它允许你定义合并的规则，例如将 alertname 相同的告警合并在⼀起，发送单⼀的通知。这意味着，如果多台主机同时出现不存活的情况，Alertmanager 会将消息合并为⼀个通知发送出去，其中包含受影响的所有主机的信息，⽽不是通知每个主机的故障。&lt;/p&gt;
&lt;p&gt;3、路由（route）：它负责决定告警的分发逻辑。它通过检查告警的属性，使⽤ “预定义的匹配规则” 来判断告警的类别，然后根据这些规则把告警发送到合适的接收器&lt;/p&gt;
&lt;p&gt;例如：我们使⽤ Prometheus 监控了很多服务，包括数据库、web、⽀付系统等。⽽不同类型的服务故障需要通知到不同的团队，这样问题才能得到快速的解决。像数据库问题需要通知 DBA 团队，⽽应⽤层⾯的问题需要通知给运维团队。在 Alertmanager 中，可以为不同类型的告警，设置不同的接收器（receivers），Alertmanager 路由规则会将告警发送到对应的接收器，确保消息能正确的通知到不同的团队。&lt;/p&gt;
&lt;p&gt;4、静默（Silence）：是指在⼀个特定的时间窗⼝内，即便接收到告警通知，Alertmanager 也不会真正向⽤户发送告警信息&lt;/p&gt;
&lt;p&gt;例如：在系统维护或升级过程中，通常会触发⼤量的告警。这些告警往往是维护系统的过程中引起的，⽽⾮真正出现了故障。如果我们不对告警通知进⾏调整，将会收到⼤量的告警信息，造成不必要的⼲扰。为了应对这种情况，在维护期间，我们可以在 Alertmanager 中设置静默（silence）规则。这些规则能够禁⽌对外发送告警通知。等到维护⼯作完成后，我们再取消静默规则，恢复正常的告警通知流程。这样可以保证告警系统的有效性，同时避免了在维护期间产⽣⼤量不必要的告警信息。&lt;/p&gt;
&lt;p&gt;5、抑制（Inhibition）：是⼀种告警管理机制，⽤以减少因组件故障导致的连锁告警。当⼀个核⼼组件发⽣故障时，依赖它的其他组件或服务也可能产⽣告警。启⽤抑制功能后，系统将⾃动抑制这些级联的次要告警，从⽽让⽤户将精⼒集中于真正的故障所在。&lt;/p&gt;
&lt;p&gt;例如：当⼀台主机宕机，主机之上的所有应⽤也会随之宕机，每个应⽤异常都会单独发送告警，从⽽导致告警数量激增。为避免告警泛滥，我们可以通过告警抑制功能来设置告警规则：在主机宕机的情况下，抑制所有由主机引起的其他应⽤的告警。 仅关注主机本身的告警信息。这样我们就能更快的定位到根本的问题并解决该问题。&lt;/p&gt;
&lt;p&gt;6、⾼可⽤（High Availability）：AlertManager 可以使⽤ gossip 留⾔协议实现⾼可⽤性；&lt;/p&gt;
&lt;h5 id=&#34;13-alertmanager配置说明&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#13-alertmanager配置说明&#34;&gt;#&lt;/a&gt; 1.3 AlertManager 配置说明&lt;/h5&gt;
&lt;p&gt;Alertmanager 负责对 Prometheus ⽣成的告警进⾏统⼀处理。常⻅的配置分为以下⼏个主要部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、全局配置 (global): 定义了全局通⽤的参数。例如：（ SMTP 配置（⽤于邮件通知）、Slack 配置（⽤于 Slack 通知）、以及其他第三⽅服务的配置）&lt;/li&gt;
&lt;li&gt;2、模板 (templates): 定义告警通知时使⽤的模板。例如：（HTML 模板、邮件模板）&lt;/li&gt;
&lt;li&gt;3、告警路由 (route): 根据告警的标签进⾏匹配，确定分组逻辑，以及告警通知给谁。&lt;/li&gt;
&lt;li&gt;4、接收⼈ (receivers): 接收⼈可以是邮箱、微信、Slack、Webhook 等。配合告警路由使⽤，确保告警通知到达正确的⽬的地。&lt;/li&gt;
&lt;li&gt;5、抑制规则 (inhibit_rules): 通过设置抑制规则来减少不必要的告警，避免告警泛滥。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# 已经触发了告警的消息，在多⻓时间内没有收到该告警的消息，则会⾃动将该告警标记为已解决。默认值是 5 分钟。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; resolve_timeout: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;duration&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; default &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; 5m &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# 邮件配置&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; smtp_from: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;tmpl_string&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; smtp_smarthost: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;string&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; smtp_hello: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;string&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; default &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;localhost&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; smtp_auth_username: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;string&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; smtp_auth_password: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;secret&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; smtp_auth_identity: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;string&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; smtp_auth_secret: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;secret&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; smtp_require_tls: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;bool&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; default &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token boolean&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# 其他全局配置...&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; wechat_api_url: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;string&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; default &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;https://qyapi.weixin.qq.com/cgi␂bin/&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; wechat_api_secret: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;secret&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; wechat_api_corp_id: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;string&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模板配置&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;templates:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# 路径到告警模板⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; - &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;filepath&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;. &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 告警路由&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;route:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# 告警的⼦路由配置&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;route&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 定义接收告警的接收⼈或服务&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;receivers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;receiver&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;.&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;inhibit_rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# 抑制规则，⽤于减少告警噪声&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; - &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;inhibit_rule&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;. &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;二-aleartmanager部署&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#二-aleartmanager部署&#34;&gt;#&lt;/a&gt; 二. AleartManager 部署&lt;/h4&gt;
&lt;h5 id=&#34;21-aleartmanager安装&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#21-aleartmanager安装&#34;&gt;#&lt;/a&gt; 2.1 AleartManager 安装&lt;/h5&gt;
&lt;p&gt;1、访问 AlertManager 的 github，获取 AlertManager 的下载地址， &lt;a href=&#34;https://github.com/prometheus/alertmanager/releases&#34;&gt;https://github.com/prometheus/alertmanager/releases&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 下载 AlertManager&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 加速地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 解压 AlertManager&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf alertmanager-0.26.0.linux-amd64.tar.gz -C /etc/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/alertmanager-0.26.0.linux-amd64/ /etc/alertmanager&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 查看 AlertManager ⽬录结构&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ll /etc/alertmanager/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;total &lt;span class=&#34;token number&#34;&gt;62504&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-rwxr-xr-x &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;35410965&lt;/span&gt; Aug &lt;span class=&#34;token number&#34;&gt;24&lt;/span&gt;  &lt;span class=&#34;token number&#34;&gt;2023&lt;/span&gt; alertmanager&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-rw-r--r-- &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;356&lt;/span&gt; Aug &lt;span class=&#34;token number&#34;&gt;24&lt;/span&gt;  &lt;span class=&#34;token number&#34;&gt;2023&lt;/span&gt; alertmanager.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-rwxr-xr-x &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;28566971&lt;/span&gt; Aug &lt;span class=&#34;token number&#34;&gt;24&lt;/span&gt;  &lt;span class=&#34;token number&#34;&gt;2023&lt;/span&gt; amtool&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-rw-r--r-- &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt;    &lt;span class=&#34;token number&#34;&gt;11357&lt;/span&gt; Aug &lt;span class=&#34;token number&#34;&gt;24&lt;/span&gt;  &lt;span class=&#34;token number&#34;&gt;2023&lt;/span&gt; LICENSE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-rw-r--r-- &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3434&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;457&lt;/span&gt; Aug &lt;span class=&#34;token number&#34;&gt;24&lt;/span&gt;  &lt;span class=&#34;token number&#34;&gt;2023&lt;/span&gt; NOTICE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;22-aleartmanager配置&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#22-aleartmanager配置&#34;&gt;#&lt;/a&gt; 2.2 AleartManager 配置&lt;/h5&gt;
&lt;p&gt;1、定义的配置⽂件，设定发件⼈的邮箱，以及路由匹配规则，和接收⼈ （group_wait 与 group_interval 区别）&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cp /etc/alertmanager/alertmanager.yml /etc/alertmanager/alertmanager.yml.bak&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/alertmanager/alertmanager.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  resolve_timeout: 2h    &lt;span class=&#34;token comment&#34;&gt;# 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  smtp_smarthost: &lt;span class=&#34;token string&#34;&gt;&#39;smtp.qq.com:587&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  smtp_from: &lt;span class=&#34;token string&#34;&gt;&#39;373370405@qq.com&#39;&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;# 发件人邮件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  smtp_auth_username: &lt;span class=&#34;token string&#34;&gt;&#39;373370405@qq.com&#39;&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;# 发件人用户名&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  smtp_auth_password: &lt;span class=&#34;token string&#34;&gt;&#39;******&#39;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 发件人密码 [授权码]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  smtp_hello: &lt;span class=&#34;token string&#34;&gt;&#39;qq.com&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  smtp_require_tls: &lt;span class=&#34;token boolean&#34;&gt;true&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 所有报警信息进入后的根路由，用来设置报警的分发策略&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;route:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  group_by: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;alertname&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;#告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  group_wait: 30s         &lt;span class=&#34;token comment&#34;&gt;#当一组新告警产生时，系统会等待 30 秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的 30s 内会有新的同校学生上车）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  group_interval: 1m     &lt;span class=&#34;token comment&#34;&gt;#已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少 1 分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  repeat_interval: 5m  &lt;span class=&#34;token comment&#34;&gt;#如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  receiver: default    &lt;span class=&#34;token comment&#34;&gt;#默认的 receiver：如果一个报警没有被一个 route 匹配，则发送给默认的接收器&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;receivers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: &lt;span class=&#34;token string&#34;&gt;&#39;default&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  email_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - to: &lt;span class=&#34;token string&#34;&gt;&#39;373370405@qq.com&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    send_resolved: &lt;span class=&#34;token boolean&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 接受告警恢复的通知&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、检查 AlertManager 的配置⽂件是否正确&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking &lt;span class=&#34;token string&#34;&gt;&#39;/etc/alertmanager/alertmanager.yml&#39;&lt;/span&gt;  SUCCESS&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Found:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - global config&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - route&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; inhibit rules&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; receivers&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; templates&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;23-alertmanager启动&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#23-alertmanager启动&#34;&gt;#&lt;/a&gt; 2.3 AlertManager 启动&lt;/h5&gt;
&lt;p&gt;1、配置 system 管理 alertmanager 启动和停⽌&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/alertmanager.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;alertmanager&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/alertmanager/alertmanager &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --web.listen-address&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;:9093 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--config.file&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/alertmanager/alertmanager.yml &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--storage.path&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/alertmanager/data &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--data.retention&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;120h&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl enable alertmanager &amp;amp;&amp;amp; systemctl start alertmanager&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 9093&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::9093                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;2648&lt;/span&gt;/alertmanager&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、访问 alertmanager，通过 &lt;a href=&#34;http://IP:9093&#34;&gt;http://IP:9093&lt;/a&gt; 访问&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/yuWRORp.png&#34; alt=&#34;image-20240305221644642.png&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;24-alertmanager测试&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#24-alertmanager测试&#34;&gt;#&lt;/a&gt; 2.4 AlertManager 测试&lt;/h5&gt;
&lt;p&gt;1、使⽤ Go 编写的告警测试⼯具来验证告警合并功能。发送具有相同 alertname 名称，但不同内容的告警，以验证 AlertManager 是否会将它们合并成⼀个组。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 下载告警程序&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://file.oldxu.net/prometheus/Alert/alert_test_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# chmod +x alert_test_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# docker run -it --rm -v `pwd`:/app/program ubuntu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;root@4c83c1816d0b:/&lt;span class=&#34;token comment&#34;&gt;# cd /app/program/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# alertname=nodedown（--alertURL 指定 alertmanager 服务器所在的地址、端⼝以及接⼝）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=nodedown,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=nodedown,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# alertname=cpuhigh&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=cpuhigh,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=cpuhigh,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、验证结果，会发现 AlertManager 是根据 group_by 中定义的 alertname 将告警信息进⾏分组，这样能够有效避免了消息重复通知。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/wfEmqC2.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3、登录邮件查看告警信息，理想的结果是收到两封电⼦邮件通知，每封包含两条关联告警，⽽⾮四封单独的邮件。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/Kokh438.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;三-prometheus对接aleartmanager&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#三-prometheus对接aleartmanager&#34;&gt;#&lt;/a&gt; 三. Prometheus 对接 AleartManager&lt;/h4&gt;
&lt;h5 id=&#34;31-配置prom对接aleartmanager&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#31-配置prom对接aleartmanager&#34;&gt;#&lt;/a&gt; 3.1 配置 Prom 对接 AleartManager&lt;/h5&gt;
&lt;p&gt;1、编辑 prometheus.yml ⽂件，然后将告警接⼊⾄ AlertManager 组件；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# Alertmanager 配置&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;alerting:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  alertmanagers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9093&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、由于 AlertManager 也对外提供了 Metrics 接⼝，我们可以直接将 AlertManager 纳⼊监控中来；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# Alertmanager 配置&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;alerting:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  alertmanagers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9093&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;tomcat&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8080&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;jmx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:12345&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;mysqld_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: master&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: slave&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;redis_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9121&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_http&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe &lt;span class=&#34;token comment&#34;&gt;# metrics 的 path 这次不是 /metrics，是 /probe&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params: &lt;span class=&#34;token comment&#34;&gt;# 传递参数&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;http_2xx&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 调哪个模块进探测&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://www.xuliangwei.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://www.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://www.baidu.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://httpbin.org/status/400&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/500&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/502&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_tcp&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;94&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;95&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;96&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;tcp_connect&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使 tcp_connect 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;97&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;98&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:3306&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:6379&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;99&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;100&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;101&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;102&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;103&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;104&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;105&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;106&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;107&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_icmp&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;108&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;109&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;110&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;icmp&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使 icmp 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;111&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;112&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;113&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;114&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;115&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;116&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;117&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;118&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;119&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;120&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;121&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_ssh&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;122&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;123&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;124&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;ssh_banner&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使⽤ ssh_banner 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;125&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;126&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:22&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:22&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:22&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;127&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;128&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;129&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;130&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;131&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;132&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;133&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;134&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;135&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;domain_exporter&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;136&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe &lt;span class=&#34;token comment&#34;&gt;# metrics 的 path 不是 /metrics，⽽是 /probe&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;137&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;138&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;nf-leasing.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;hmallleasing.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;jd.com&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;139&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;140&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;141&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;142&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;143&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;144&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;145&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9222&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;146&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;147&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;pushgateway&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;148&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;149&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;150&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net:9091&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;151&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;152&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;alertmanager&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;153&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;154&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;155&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9093&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、重新加载 Prometheus 服务&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;32-配置prometheus告警规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#32-配置prometheus告警规则&#34;&gt;#&lt;/a&gt; 3.2 配置 Prometheus 告警规则&lt;/h5&gt;
&lt;p&gt;1、在 Prometheus 服务器上编辑⼀个测试的告警规则&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/node_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: 节点告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点处于Down状态&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: up &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;节点处于Down状态,实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34; 节点已关闭&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点CPU使率超过80%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - avg&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机CPU利率过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: CPU饱和度过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;count&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;CPU饱和度过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 主机内存不足&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_memory_MemTotal_bytes * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机内存使用率较高, 实例:, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的内存使用率持续2分钟高于80%，当前利用率：%&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 内存饱和度高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机内存内存饱和度高, 实例:, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;SWAP内存使用率已连续2分钟超过10%，表明内存饱和度过高，当前SWAP使用率为：%。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘空间告急&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; - node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;70&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘 分区空间不足&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘  分区空间使用率已超过 70%，当前使用率为 %，请及时处理。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘Inode空间告急&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_filesystem_files&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; - node_filesystem_files_free&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_filesystem_files&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;70&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘 分区Inode空间不足&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘  分区的Inode空间使用率已超过 70%，，当前使用率为 %，请及时处理。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IOPS写入较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token comment&#34;&gt;#expr: sum(rate(node_disk_writes_completed_total[1m])) by (instance,job) / 120 * 100 &gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token comment&#34;&gt;#round 函数可以对值进行四舍五入，磁盘最大 IOPS 为 120 次 /s&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_writes_completed_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;120&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  IOPS每秒写入次数超过120次/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS写入饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼25--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS每秒写入最大 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼26--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; 次/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;                &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IOPS读取较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_reads_completed_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;120&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  IOPS每秒读取次数超过120次/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS读取饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼28--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS每秒读取最⼤ &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼29--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; 次/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IO写入吞吐较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_written_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; /1024 / &lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;94&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;95&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;96&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;97&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;98&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘IO写入每秒超过最高30MB/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;99&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;100&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO写入吞吐量的饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼31--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;101&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO写入吞吐量每秒最大是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼32--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;MB/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;102&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;103&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IO读取吞吐较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;104&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_read_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; /1024 /30 * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;105&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;106&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;107&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;108&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;109&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘IO读取每秒超过最大30MB/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;110&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;111&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO读取吞吐量的饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼34--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;112&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO读取吞吐量每秒最大是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼35--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;MB/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;113&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;114&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 网络下载带宽异常&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;115&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;8&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job,device&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;50&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;116&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;117&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;118&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;119&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;120&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  的  接口下载流量已经超过公司实际50Mbps&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;121&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;122&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前下载带宽已经达到 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼38--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; Mbps/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;123&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前下载带宽使用率在 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼39--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;124&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;125&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 网络上传带宽异常&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;126&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_network_transmit_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;8&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job,device&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;50&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;127&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;128&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;129&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;130&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;131&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  的  接口上传流量已经超过公司实际50Mbps&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;132&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;133&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前上传带宽已经达到 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼42--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; Mbps/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;134&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前上传带宽使用率在 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼43--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;33-配置prometheus加载规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#33-配置prometheus加载规则&#34;&gt;#&lt;/a&gt; 3.3 配置 Prometheus 加载规则&lt;/h5&gt;
&lt;p&gt;为了能够让 Prometheus 能够定期评估告警规则，我们需要在 Prometheus 全局配置⽂件中通过 rule_files 指定告警规则⽂件的路径，⽽后 Prometheus 会定期评估这些告警规则， 当规则条件满⾜时，会向外部发送通知。&lt;/p&gt;
&lt;p&gt;1、配置 Prometheus 加载告警规则⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# Alertmanager 配置&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;alerting:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  alertmanagers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9093&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、检查 Prometheus 语法&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking /etc/prometheus/rules/node_rules.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS: &lt;span class=&#34;token number&#34;&gt;13&lt;/span&gt; rules found&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、重启 Prometheus 服务&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;curl&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-X&lt;/span&gt; POST http://localhost:9090/-/reload&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;34-触发规则并验证告警通知&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#34-触发规则并验证告警通知&#34;&gt;#&lt;/a&gt; 3.4 触发规则并验证告警通知&lt;/h5&gt;
&lt;p&gt;1、停⽌ node2 和 node03 的 node_exporter 服务，那么就会触发告警&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node02 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl stop node_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl stop node_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、检查 Prometheus 的 Alert ⻚⾯的状态是否处于 Firing&lt;/p&gt;
&lt;p&gt;3、检查 AlertManager 是否收到了告警&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/i9iZoxh.png&#34; alt=&#34;12.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;4、检查邮件是否能看到告警的信息，因为两条告警的 alertname 是一致的，因此它们会合并为一条消息发送出来。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/FwXQPdL.png&#34; alt=&#34;13.png&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;35-自定义邮件告警模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#35-自定义邮件告警模板&#34;&gt;#&lt;/a&gt; 3.5 ⾃定义邮件告警模板&lt;/h5&gt;
&lt;p&gt;1、定义告警的通知模板和恢复模板&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mkdir /etc/alertmanager/template&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/alertmanager/template/email.tmpl&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼44--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼45--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼46--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;h2 &lt;span class=&#34;token assign-left variable&#34;&gt;style&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;color: red;&#34;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;@告警通知&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/h&lt;span class=&#34;token operator&#34;&gt;&lt;span class=&#34;token file-descriptor important&#34;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警程序: AlertManager &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警级别: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼47--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警类型: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼48--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;故障主机: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼49--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警主题: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼50--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警详情: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼51--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;触发时间: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼52--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼53--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼54--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼55--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼56--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;h2 &lt;span class=&#34;token assign-left variable&#34;&gt;style&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;color: green;&#34;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;@告警恢复&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/h&lt;span class=&#34;token operator&#34;&gt;&lt;span class=&#34;token file-descriptor important&#34;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警程序: AlertManager &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警级别: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼57--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警类型: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼58--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警主机: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼59--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警主题: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼60--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;告警详情: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼61--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;触发时间: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼62--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;恢复时间: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼63--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼64--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼65--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼66--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、配置 AlertManager，应用该模板&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml 
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: &#39;smtp.qq.com:587&#39;
  smtp_from: &#39;373370405@qq.com&#39;  # 发件人邮件
  smtp_auth_username: &#39;373370405@qq.com&#39;  # 发件人用户名
  smtp_auth_password: &#39;******&#39; # 发件人密码[授权码]
  smtp_hello: &#39;qq.com&#39;
  smtp_require_tls: true

# 加载模板文件
templates:
  - &#39;/etc/alertmanager/template/email.tmpl&#39;  # 模板文件的实际路径
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: [&#39;alertname&#39;] #告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s         #当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m     #已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m  #如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: default    #默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器
  
receivers:
- name: &#39;default&#39;
  email_configs:
  - to: &#39;373370405@qq.com&#39;
    send_resolved: true # 接受告警恢复的通知
    html: &#39;&amp;#123;&amp;#123; template &#34;email.html&#34; . &amp;#125;&amp;#125;&#39; # 发送邮件内容，调用该模板进行渲染
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3、检查 AlertManager 的配置文件是否正确&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking &lt;span class=&#34;token string&#34;&gt;&#39;/etc/alertmanager/alertmanager.yml&#39;&lt;/span&gt;  SUCCESS&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Found:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - global config&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - route&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; inhibit rules&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; receivers&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; templates&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;4、重新加载 AlertManager&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9093/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;5、触发告警，验证告警模板是否正常渲染&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/oQV6bLR.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;四-alertmanager告警通知方式&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#四-alertmanager告警通知方式&#34;&gt;#&lt;/a&gt; 四. AlertManager 告警通知⽅式&lt;/h4&gt;
&lt;h5 id=&#34;41-配置alert对接微信告警&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#41-配置alert对接微信告警&#34;&gt;#&lt;/a&gt; 4.1 配置 Alert 对接微信告警&lt;/h5&gt;
&lt;p&gt;企业微信告警，需要将发送告警的服务器域名添加到⽩名单，同时该服务器必须运⾏在公⽹，因此常规的企业微信告警没办法很好在本地实现。但是我们可以采⽤ webhook ⽅式来实现： Prometheus--&amp;gt;AlertManager--&amp;gt; 自定义 Webhook 程序 --&amp;gt; 企业微信机器⼈ --&amp;gt; 通知给对应的⽤户&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1. 访问企业微信官⽹， &lt;a href=&#34;https://work.weixin.qq.com/&#34;&gt;https://work.weixin.qq.com/&lt;/a&gt; ，注册⼀个账户。&lt;/li&gt;
&lt;li&gt;2. 创建⼀个群聊，并邀请⾄少两名其他成员加⼊，因为企业微信群聊⾄少需要三名成员才能启⽤。&lt;/li&gt;
&lt;li&gt;3. 在群组聊天中添加⼀个新的机器⼈。&lt;/li&gt;
&lt;li&gt;4. 记录机器⼈的 Webhook URL (Token)&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;47ffbdd9-4308-4db0-aa08-f309546cc92d&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;1、下载并运⾏ webhook_wechat&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://file.oldxu.net/prometheus/Alert/webhook_wechat_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mv webhook_wechat_oldxu /usr/local/bin/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# chmod +x /usr/local/bin/webhook_wechat_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、编辑启动脚本⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/webhook_wechat.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;webhook_wechat&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/usr/local/bin/webhook_wechat_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--port&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5001&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start webhook_wechat &amp;amp;&amp;amp; systemctl enable webhook_wechat&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 5001&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::5001                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;2576&lt;/span&gt;/webhook_wechat&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、测试 webhook_wechat 能否正确发送消息到企业微信&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:5001/alert?token=&amp;lt; 企业微信机器人 token&gt; \&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-H&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;Content-Type: application/json&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-d&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;&amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &#34;alerts&#34;: [&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;status&#34;: &#34;firing&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;labels&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;severity&#34;: &#34;critical&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;alertname&#34;: &#34;InstanceDown&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;instance&#34;: &#34;example1&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;annotations&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;summary&#34;: &#34;Instance example1 down&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;description&#34;: &#34;The instance example1 is down.&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;startsAt&#34;: &#34;2024-12-20T15:04:05Z&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;endsAt&#34;: &#34;0001-01-01T00:00:00Z&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;status&#34;: &#34;resolved&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;labels&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;severity&#34;: &#34;critical&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;alertname&#34;: &#34;InstanceDown&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;instance&#34;: &#34;example1&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;annotations&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;summary&#34;: &#34;Instance example1 is back up&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;description&#34;: &#34;The instance example1 has recovered.&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;startsAt&#34;: &#34;2024-12-20T15:04:05Z&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;endsAt&#34;: &#34;2024-12-20T16:04:05Z&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#125;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ]&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&amp;#125;&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;4、检查企业微信结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306211653486.png&#34; alt=&#34;image-20240306211653486&#34; /&gt;&lt;/p&gt;
&lt;p&gt;5、配置 AlertManager 对接 webhook_wechat&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: &#39;smtp.qq.com:25&#39;
  smtp_from: &#39;373370405@qq.com&#39;  # 发件人邮件
  smtp_auth_username: &#39;373370405@qq.com&#39;  # 发件人用户名
  smtp_auth_password: &#39;******&#39; # 发件人密码[授权码]
  smtp_hello: &#39;qq.com&#39;
  smtp_require_tls: false

# 加载模板文件
templates:
  - &#39;/etc/alertmanager/template/email.tmpl&#39;
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: [&#39;alertname&#39;] # 告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s     # 当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m  # 已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m # 如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: webhook-wechat-ops   # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器
  
receivers:
- name: &#39;webhook-wechat-ops&#39;
  webhook_configs:
  - url: &#39;http://prom-node01.oldxu.net:5001/alert?token=47ffbdd9-4308-4db0-aa08-f309546cc92d&#39;  #http://&amp;lt;你的服务器地址&amp;gt;:5001/alert?token=&amp;lt;企业微信机器人token&amp;gt;&#39;

- name: &#39;default&#39;
  email_configs:
  - to: &#39;373370405@qq.com&#39;
    send_resolved: true # 接受告警恢复的通知
    html: &#39;&amp;#123;&amp;#123; template &#34;email.html&#34; . &amp;#125;&amp;#125;&#39; # 发送邮件内容，调用该模板进行渲染
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;6、检查 AlertManager 的配置⽂件是否正确&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking &lt;span class=&#34;token string&#34;&gt;&#39;/etc/alertmanager/alertmanager.yml&#39;&lt;/span&gt;  SUCCESS&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Found:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - global config&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - route&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; inhibit rules&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; receivers&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; templates&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;7、重新加载 AlertManager&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  curl -X POST http://localhost:9093/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;8、触发告警，验证是否能通过企业微信收到消息&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240306212303561.png&#34; alt=&#34;image-20240306212303561&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;42-配置alert对接钉钉告警&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#42-配置alert对接钉钉告警&#34;&gt;#&lt;/a&gt; 4.2 配置 Alert 对接钉钉告警&lt;/h5&gt;
&lt;p&gt;钉钉告警可以是⽤ Prometheus-webhook-dingtalk ⼯具，github 地址 &lt;a href=&#34;https://github.com/timonwong/prometheus-webhook-dingtalk&#34;&gt;https://github.com/timonwong/prometheus-webhook-dingtalk&lt;/a&gt; 。但在此处，我们使⽤的是自己开发的 webhook 程序来对接钉钉， Prometheus--&amp;gt;AlertManager--&amp;gt; 自定义 Webhook 程序 --&amp;gt; 钉钉机器人 --&amp;gt; 通知给对应的群组&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、访问钉钉开发者后台： &lt;a href=&#34;https://open-dev.dingtalk.com/&#34;&gt;https://open-dev.dingtalk.com/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2、点击应⽤开发，然后创建机器⼈（使⽤旧版），填写机器⼈名称，然后找到创建的机器⼈（版本管理与发布，点击上线），该机器⼈就可以添加到群组。&lt;/li&gt;
&lt;li&gt;3、发起群聊（添加两个⽤户），然后创建⼀个普通群，群归属为个⼈。&lt;/li&gt;
&lt;li&gt;4、紧接着找到对应的群，点击群类型，必须转为 “内部群”，然后在智能群助⼿中添加机器⼈，找到此前在钉钉开发者平台创建的机器⼈添加即可。&lt;/li&gt;
&lt;li&gt;5、最后点击机器⼈，获取对应的 Token 令牌。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;https://oapi.dingtalk.com/robot/send?access_token&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h6 id=&#34;421-配置alert对接钉钉告警1&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#421-配置alert对接钉钉告警1&#34;&gt;#&lt;/a&gt; 4.2.1 配置 Alert 对接钉钉告警 1&lt;/h6&gt;
&lt;p&gt;1、下载并运⾏ webhook_dingding&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://file.oldxu.net/prometheus/Alert/webhook_dingding_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mv webhook_dingding_oldxu /usr/local/bin/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# chmod +x /usr/local/bin/webhook_dingding_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、编辑启动脚本⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/webhook_dingding.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;webhook_dingding&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/usr/local/bin/webhook_dingding_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--port&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5002&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start webhook_dingding &amp;amp;&amp;amp; systemctl enable webhook_dingding &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 5002&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::5002                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;3141&lt;/span&gt;/webhook_dingdi&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、测试 webhook_wechat 能否正确发送消息到钉钉（注意端⼝是 5002）&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:5002/alert?token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db \&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-H&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;Content-Type: application/json&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-d&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;&amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &#34;alerts&#34;: [&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;status&#34;: &#34;firing&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;labels&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;severity&#34;: &#34;critical&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;alertname&#34;: &#34;InstanceDown&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;instance&#34;: &#34;example1&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;annotations&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;summary&#34;: &#34;Instance example1 down&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;description&#34;: &#34;The instance example1 is down.&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;startsAt&#34;: &#34;2024-12-20T15:04:05Z&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;endsAt&#34;: &#34;0001-01-01T00:00:00Z&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;status&#34;: &#34;resolved&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;labels&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;severity&#34;: &#34;critical&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;alertname&#34;: &#34;InstanceDown&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;instance&#34;: &#34;example1&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;annotations&#34;: &amp;#123;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;summary&#34;: &#34;Instance example1 is back up&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &#34;description&#34;: &#34;The instance example1 has recovered.&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &amp;#125;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;startsAt&#34;: &#34;2024-12-20T15:04:05Z&#34;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &#34;endsAt&#34;: &#34;2024-12-20T16:04:05Z&#34;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &amp;#125;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ]&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&amp;#125;&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;4、检查企业微信结果&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/ZKWmmc2.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;5、配置 AlertManager 对接 webhook_dingding&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: &#39;smtp.qq.com:587&#39;
  smtp_from: &#39;373370405@qq.com&#39;  # 发件人邮件
  smtp_auth_username: &#39;373370405@qq.com&#39;  # 发件人用户名
  smtp_auth_password: &#39;******&#39; # 发件人密码[授权码]
  smtp_hello: &#39;qq.com&#39;
  smtp_require_tls: true

# 加载模板文件
templates:
  - &#39;/etc/alertmanager/template/email.tmpl&#39;  # 模板文件的实际路径
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: [&#39;alertname&#39;] #告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭车回家）
  group_wait: 30s         #当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m     #已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m  #如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: webhook-dingding-ops    #默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器

receivers:
- name: &#39;webhook-dingding-ops&#39;
  webhook_configs:
  - url: &#39;http://prom-node01.oldxu.net:5002/alert?token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db&#39;

- name: &#39;default&#39;
  email_configs:
  - to: &#39;373370405@qq.com&#39;
    send_resolved: true # 接受告警恢复的通知
    html: &#39;&amp;#123;&amp;#123; template &#34;email.html&#34; . &amp;#125;&amp;#125;&#39; # 发送邮件内容，调用该模板进行渲染
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;6、检查 AlertManager 的配置⽂件是否正确&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;7、重新加载 AlertManager&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  curl -X POST http://localhost:9093/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;8、触发告警，验证是否能通过钉钉收到消息&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/w8JdsaP.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;h6 id=&#34;422-配置alert对接钉钉告警2&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#422-配置alert对接钉钉告警2&#34;&gt;#&lt;/a&gt; 4.2.2 配置 Alert 对接钉钉告警 2&lt;/h6&gt;
&lt;p&gt;&lt;em&gt;参考链接：&lt;a href=&#34;https://blog.51cto.com/u_13236892/12095979&#34;&gt;https://blog.51cto.com/u_13236892/12095979&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;1、下载 prometheus-webhook-dingtalk&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;https://github.com/timonwong/prometheus-webhook-dingtalk&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、解压安装&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar -xf prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz -C /usr/local/bin/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /usr/local/bin/prometheus-webhook-dingtalk-2.1.0.linux-amd64/ /usr/local/bin/webhook-dingtalk&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、添加告警规则模板&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  cat /usr/local/bin/webhook-dingtalk//template.tmpl&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼70--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼71--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼72--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;:&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼73--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼74--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼75--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼76--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼77--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;---&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼78--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;@&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼79--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼80--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警程序**: AlertManager &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警类型**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼81--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警级别**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼82--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警主机**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼83--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警主题**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼84--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警信息**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼85--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警时间**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;font &lt;span class=&#34;token assign-left variable&#34;&gt;color&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;#FF0000&#39;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼86--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/font&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼87--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼88--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼89--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼90--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;---&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼91--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;@&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼92--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼93--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警程序**: AlertManager &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警类型**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼94--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警级别**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼95--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警主机**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼96--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警主题**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼97--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警信息**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼98--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**告警时间**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;font &lt;span class=&#34;token assign-left variable&#34;&gt;color&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;#FF0000&#39;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼99--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/font&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**恢复时间**: &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;font &lt;span class=&#34;token assign-left variable&#34;&gt;color&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;#FF0000&#39;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼100--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/font&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;br&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼101--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼102--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼103--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼104--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼105--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼106--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼107--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;h&lt;span class=&#34;token operator&#34;&gt;&lt;span class=&#34;token file-descriptor important&#34;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;font &lt;span class=&#34;token assign-left variable&#34;&gt;color&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;#FF7F00&#39;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;侦测到&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼108--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;个故障&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/font&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/h&lt;span class=&#34;token operator&#34;&gt;&lt;span class=&#34;token file-descriptor important&#34;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;**&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼109--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;---&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼110--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼111--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;**&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;h&lt;span class=&#34;token operator&#34;&gt;&lt;span class=&#34;token file-descriptor important&#34;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;font &lt;span class=&#34;token assign-left variable&#34;&gt;color&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;#00FF00&#39;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;恢复&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼112--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;个故障&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/font&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/h&lt;span class=&#34;token operator&#34;&gt;&lt;span class=&#34;token file-descriptor important&#34;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;**&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼113--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼114--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼115--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼116--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼117--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼118--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼119--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼120--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼121--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼122--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼123--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;4、添加启动配置文件&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@prom-node01 soft]# cd /usr/local/bin/webhook-dingtalk/
[root@prom-node01 webhook-dingtalk]# cp config.example.yml config.yml
[root@prom-node01 ~]# cat /usr/local/bin/webhook-dingtalk/config.yml 
## Request timeout
# timeout: 5s

## Uncomment following line in order to write template from scratch (be careful!)
#no_builtin_template: true

## Customizable templates path
templates:
  - /usr/local/bin/webhook-dingtalk/template.tmpl   #告警模板

## You can also override default template using `default_message`
## The following example to use the &#39;legacy&#39; template from v0.3.0
#default_message:
#  title: &#39;&amp;#123;&amp;#123; template &#34;legacy.title&#34; . &amp;#125;&amp;#125;&#39;
#  text: &#39;&amp;#123;&amp;#123; template &#34;legacy.content&#34; . &amp;#125;&amp;#125;&#39;

## Targets, previously was known as &amp;quot;profiles&amp;quot;
targets:
  webhook1:
    url: https://oapi.dingtalk.com/robot/send?access_token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db #钉钉token
    # secret for signature
    secret: SEC000000000000000000000
  webhook2:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx
  webhook_legacy:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx
    # Customize template content
    message:
      # Use legacy template
      title: &#39;&amp;#123;&amp;#123; template &#34;legacy.title&#34; . &amp;#125;&amp;#125;&#39;
      text: &#39;&amp;#123;&amp;#123; template &#34;legacy.content&#34; . &amp;#125;&amp;#125;&#39;
  webhook_mention_all:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx
    mention:
      all: true
  webhook_mention_users:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx
    mention:
      mobiles: [&#39;156xxxx8827&#39;, &#39;189xxxx8325&#39;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;5、编辑启动脚本&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/webhook.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;Prometheus-Server&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/usr/local/bin/webhook-dingtalk/prometheus-webhook-dingtalk &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--config.file&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/usr/local/bin/webhook-dingtalk/config.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;6、启动 webhook&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start webhook.service &amp;amp;&amp;amp; systemctl enable webhook.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 8060&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::8060                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;3008&lt;/span&gt;/prometheus-web&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;7、配置 AlertManager 对接 webhook_dingding&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: &#39;smtp.qq.com:587&#39;
  smtp_from: &#39;373370405@qq.com&#39;  # 发件人邮件
  smtp_auth_username: &#39;373370405@qq.com&#39;  # 发件人用户名
  smtp_auth_password: &#39;******&#39; # 发件人密码[授权码]
  smtp_hello: &#39;qq.com&#39;
  smtp_require_tls: true

# 加载模板文件
templates:
  - &#39;/etc/alertmanager/template/email.tmpl&#39;  # 模板文件的实际路径
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: [&#39;alertname&#39;] #告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s         #当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m     #已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m  #如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: webhook-dingding-ops1    #默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器

  
receivers:
- name: &#39;webhook-dingding-ops&#39;
  webhook_configs:
  - url: &#39;http://prom-node01.oldxu.net:5002/alert?token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db&#39;

- name: &#39;webhook-dingding-ops1&#39;
  webhook_configs:
  - url: &#39;http://prom-node01.oldxu.net:8060/dingtalk/webhook1/send&#39;

- name: &#39;default&#39;
  email_configs:
  - to: &#39;373370405@qq.com&#39;
    send_resolved: true # 接受告警恢复的通知
    html: &#39;&amp;#123;&amp;#123; template &#34;email.html&#34; . &amp;#125;&amp;#125;&#39; # 发送邮件内容，调用该模板进行渲染
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;8、检查 AlertManager 的配置⽂件是否正确&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking &lt;span class=&#34;token string&#34;&gt;&#39;/etc/alertmanager/alertmanager.yml&#39;&lt;/span&gt;  SUCCESS&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Found:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - global config&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - route&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; inhibit rules&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt; receivers&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; templates&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;9、重新加载 AlertManager&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;curl&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-X&lt;/span&gt; POST http://localhost:9093/-/reload&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;10、触发告警，验证是否能通过钉钉收到消息&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/sKrY09u.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;五-alertmanager告警路由&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#五-alertmanager告警路由&#34;&gt;#&lt;/a&gt; 五. AlertManager 告警路由&lt;/h4&gt;
&lt;h5 id=&#34;51-告警路由介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#51-告警路由介绍&#34;&gt;#&lt;/a&gt; 5.1 告警路由介绍&lt;/h5&gt;
&lt;p&gt;所谓的告警路由，就是将不同的告警消息转发给不同的接收⼈，以便故障能快速的被处理和解决。&lt;/p&gt;
&lt;p&gt;Alertmanager 的告警路由配置，使⽤的是树状结构来定义，以确保每条告警消息都能够按照定义好的路径进⾏处理。当⼀条告警消息进来后，会先进⼊根路由，然后逐级的去匹配每个⼦路由的规则，然后将消息通过媒介发送给对应的接收⼈。&lt;/p&gt;
&lt;p&gt;例如，我们可以设置⼀个规则，将标签 severity 级别为 critical 的告警发送到钉钉，⽽剩余其他的告警则全部发送给微信。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;AlertManager 告警路由场景示例：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、mysql_exporter 和 redis_exporter 的 Job 告警时，就将其发送给 “钉钉的 DBA 团队”。&lt;/li&gt;
&lt;li&gt;2、node_exporter 的 Job 告警时，则将告警路由到 “钉钉的 OPS 团队”。&lt;/li&gt;
&lt;li&gt;3、最后，如果告警消息不符合上述任何⼀个规则，它们将默认通过微信发送给 “企业微信运维团队”。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;52-告警路由实践&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#52-告警路由实践&#34;&gt;#&lt;/a&gt; 5.2 告警路由实践&lt;/h5&gt;
&lt;p&gt;1、配置 AlertManager，添加子路由规则&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@prom-node01 ~]# cat /etc/alertmanager/alertmanager.yml
global:
  resolve_timeout: 2h    # 已经触发了告警的消息，在多长时间内没有收到该告警的消息，则会自动将该告警标记为已解决。
  smtp_smarthost: &#39;smtp.qq.com:587&#39;
  smtp_from: &#39;373370405@qq.com&#39;  # 发件人邮件
  smtp_auth_username: &#39;373370405@qq.com&#39;  # 发件人用户名
  smtp_auth_password: &#39;******&#39; # 发件人密码[授权码]
  smtp_hello: &#39;qq.com&#39;
  smtp_require_tls: true

# 加载模板文件
templates:
  - &#39;/etc/alertmanager/template/email.tmpl&#39;  # 模板文件的实际路径
 
# 所有报警信息进入后的根路由，用来设置报警的分发策略
route:
  group_by: [&#39;alertname&#39;] #告警信息会根据告警名称分组，同名的告警消息会被归到一组，然后一起发送。（一个学校的一起搭⻋回家）
  group_wait: 30s         #当一组新告警产生时，系统会等待30秒，以便把这段时间内相同组的其他告警一起合并发送。（发车时间，保不齐在等待的30s内会有新的同校学生上车）
  group_interval: 1m     #已经发送了一个分组的告警通知之后，即使又有新的相同分组的告警到来，也需要等待至少1分钟后才会发送该分组的告警通知。（类似于发车间隔，没赶上就得等）
  repeat_interval: 5m  #如果同一个组中的报警信息已经发送成功了，下一次这个组发送告警的时间间隔（重复发送相同告警的时间间隔）
  receiver: default    #默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器

  # 子路由匹配规则
  routes:
  - match_re:
      job: &#39;(domain_exporter.*|blackbox_http.*)&#39;   #正则匹配
    receiver: &#39;webhook-dingding-ops&#39;
    continue: true

  - match_re:
      job: &#39;node.*&#39;                   #正则匹配
    receiver: &#39;webhook-dingding-ops1&#39;
    continue: true

#  - match:
#      severity: &#39;critical&#39;           #精准匹配
#    receiver: &#39;webhook-wechat&#39;
#    continue: true
  
receivers:
- name: &#39;webhook-dingding-ops&#39;
  webhook_configs:
  - url: &#39;http://prom-node01.oldxu.net:5002/alert?token=906498a49ca8fdd29ae71258393f4ae25aff9ab3d47f007716ebb283f1c8e8db&#39;

- name: &#39;webhook-dingding-ops1&#39;
  webhook_configs:
  - url: &#39;http://prom-node01.oldxu.net:8060/dingtalk/webhook1/send&#39;

- name: &#39;default&#39;
  email_configs:
  - to: &#39;373370405@qq.com&#39;
    send_resolved: true # 接受告警恢复的通知
    html: &#39;&amp;#123;&amp;#123; template &#34;email.html&#34; . &amp;#125;&amp;#125;&#39; # 发送邮件内容，调用该模板进行渲染
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2、检查语法，并重新加载 AlertManager&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking &lt;span class=&#34;token string&#34;&gt;&#39;/etc/alertmanager/alertmanager.yml&#39;&lt;/span&gt;  SUCCESS&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Found:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - global config&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - route&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; inhibit rules&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt; receivers&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; templates&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9093/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;53-告警路由验证&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#53-告警路由验证&#34;&gt;#&lt;/a&gt; 5.3 告警路由验证&lt;/h5&gt;
&lt;p&gt;1、触发 mysql 和 redis 的告警，验证钉钉 - DBA 团队是否能收到告警消息&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl stop mysqld_exporter.service redis_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、触发 node 相关的告警，验证钉钉 - OPS 团队是否能收到告警消息&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node02 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl stop node_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl stop node_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、触发 nginx 相关的告警，验证微信运维团队是否能收到告警消息&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl stop nginx_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;六-alertmanager告警静默&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#六-alertmanager告警静默&#34;&gt;#&lt;/a&gt; 六. AlertManager 告警静默&lt;/h4&gt;
&lt;h5 id=&#34;61-告警静默介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#61-告警静默介绍&#34;&gt;#&lt;/a&gt; 6.1 告警静默介绍&lt;/h5&gt;
&lt;p&gt;在系统维护或升级过程中，通常会触发⼤量的告警。这些告警往往是维护系统的过程中引起的，⽽⾮真正出现了故障。如果我们不对告警通知进⾏调整，将会收到⼤量的告警信息，造成不必要的⼲扰。&lt;/p&gt;
&lt;p&gt;为了应对这种情况，在维护期间，我们可以在 Alertmanager 中设置静默（silence）规则。这些规则能够禁⽌对外发送告警通知。等到维护⼯作完成后，我们再取消静默规则，恢复正常的告警通知流程。这样可以保证告警系统的有效性，同时避免了在维护期间产⽣⼤量不必要的告警信息。&lt;/p&gt;
&lt;p&gt;告警静默配置有两种⽅式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、先告警后静默： 当告警发⽣时，我们可以直接在 WEB UI 界⾯上对其进⾏静默处理，从⽽停⽌持续发送相同告警信息，确保及时终⽌告警。&lt;/li&gt;
&lt;li&gt;2、先配置静默： 在维护时可能会触发⼤量告警，这时我们可以提前创建静默规则，有效地防⽌告警⻛暴的发⽣。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;62-配置告警静默&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#62-配置告警静默&#34;&gt;#&lt;/a&gt; 6.2 配置告警静默&lt;/h5&gt;
&lt;p&gt;1、在 AlertManager 的 silences ⻚⾯，点击 New Silences，然后定义开始时间和结束时间（注意这个时间为 UTC 时间，如果转为北京时间要 + 8 ⼩时）&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/7TjIXYP.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;2、配置 Matchers，来定义静默规则，例如，我不希望在维护期间收到 node_exporter 这个 job 相关的任何告警，（注意：如果编写多个 Matchers 规则，它们是 “并且” 的关系）&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/R72oOZY.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3、检查最终的静默规则（当 State 状态由 Pending 转为 Active 则说明规则已经激活了，如果是 pengding 表示规则未到指定时间，没⽣效。）&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/oc1zPxo.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;63-静默效果验证&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#63-静默效果验证&#34;&gt;#&lt;/a&gt; 6.3 静默效果验证&lt;/h5&gt;
&lt;p&gt;1、通过程序模拟 Prometheus 发送告警信息，确保其中包含 job=~node_exporter ，以便与静默规则匹配。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 下载告警程序&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://file.oldxu.net/prometheus/Alert/alert_test_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# chmod +x alert_test_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# docker run -it --rm -v `pwd`:/app/program ubuntu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;root@4c83c1816d0b:/&lt;span class=&#34;token comment&#34;&gt;# cd /app/program/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# alertname=nodedown（--alertURL 指定 alertmanager 服务器所在的地址、端⼝以及接⼝）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=nodedown,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=nodedown,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# alertname=cpuhigh&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=cpuhigh,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=cpuhigh,instance=prom-node02.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、访问 AlertManager ⻚⾯，点击 Silenced，然后查看被静默的告警信息&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/VWTmDA8.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;七-alertmanager告警抑制&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#七-alertmanager告警抑制&#34;&gt;#&lt;/a&gt; 七. AlertManager 告警抑制&lt;/h4&gt;
&lt;h5 id=&#34;71-告警抑制介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#71-告警抑制介绍&#34;&gt;#&lt;/a&gt; 7.1 告警抑制介绍&lt;/h5&gt;
&lt;p&gt;当⼀个节点发⽣故障后，那么运⾏在该节点上的服务（nginx、tomcat、redis）都会失去响应，并且各⾃触发告警。因此为了避免被⼤量的告警信息淹没，我们可以设定⼀个抑制规则：当检测到节点故障，则⾃动抑制那些因节点故障⽽产⽣的次要告警，从⽽让⽤户将精⼒集中在真正的故障所在。&lt;/p&gt;
&lt;p&gt;要实现告警抑制（Inhibition），就需要定义⼀些规则告诉 Alertmanager 在什么情况下应该阻⽌告警发送通知。避免重复或不必要的告警，抑制规则由以下⼏个关键参数构成：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;source_match 和 source_matchers（正则匹配）：源告警，表示已经触发并且被识别为重要的告警。&lt;/li&gt;
&lt;li&gt;target_match 和 target_matchers（正则匹配）：⽬标告警，则是那些可能 “由源告警所引起的告警”。当源告警被触发时，我们不希望这些⽬标告警发送通知，因为它们是源告警故障引起的告警。&lt;/li&gt;
&lt;li&gt;equal：⽤于指定源告警和⽬标告警之间必须匹配的标签，以确保抑制的相关性。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;示例配置：如果检测到节点故障告警，则⾃动抑制该节点上所有服务的告警。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;inhibit_rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- source_matchers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - alertname &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;NodeDown&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 源告警是节点故障告警。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  target_matchers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - job &lt;span class=&#34;token operator&#34;&gt;=~&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;.*&#34;&lt;/span&gt;     &lt;span class=&#34;token comment&#34;&gt;# ⽬标告警可以是任何 job 产⽣的，因为⼀个节点上的服务会被划分到不同的 job&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  equal: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;instance&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 确保只有当源告警和⽬标告警具有相同的 instance 的值时，⽬标告警才会被抑制。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;72-告警抑制场景-1&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#72-告警抑制场景-1&#34;&gt;#&lt;/a&gt; 7.2 告警抑制场景 - 1&lt;/h5&gt;
&lt;p&gt;1、模拟节点故障，并且模拟因为节点故障从⽽造成的其他级联故障；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 下载告警程序&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://file.oldxu.net/prometheus/Alert/alert_test_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# chmod +x alert_test_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# docker run -it --rm -v `pwd`:/app/program ubuntu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;root@4c83c1816d0b:/&lt;span class=&#34;token comment&#34;&gt;# cd /app/program/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 主要故障&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=NodeDown,instance=prom-node01.oldxu.net,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 级联故障&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=tomcatDown,instance=prom-node01.oldxu.net,job=tomcat_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=NginxDown,instance=prom-node01.oldxu.net,job=nginx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、正常情况下我们会收到 3 条告警消息，但最为重要的就是节点 Down 机，其他告警消息都是因为节点 Down ⽽产⽣的级联故障。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/9F9Z6xx.jpeg&#34; alt=&#34;5.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3、配置抑制规则，当节点出现故障，则抑制该节点上，其他应⽤因为节点故障⽽发出的级联故障&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/alertmanager/alertmanager.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;inhibit_rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- source_matchers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - alertname &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;NodeDown&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 假设当节点故障时，触发的告警名为 &#34;NodeDown&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  target_matchers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - job &lt;span class=&#34;token operator&#34;&gt;=~&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;.*&#34;&lt;/span&gt;            &lt;span class=&#34;token comment&#34;&gt;# 则抑制该节点上所有应⽤发送的故障，不论他是哪个 job 产⽣的&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  equal: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;instance&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;        &lt;span class=&#34;token comment&#34;&gt;# instance 必须相等，才能表示是同⼀个节点上的告警&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/alertmanager/amtool check-config /etc/alertmanager/alertmanager.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9093/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;4、再次模拟节点故障，以及节点故障所造成的应⽤级联故障&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 主要故障&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=NodeDown,instance=prom-node01.oldxu.net,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 级联故障&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=tomcatDown,instance=prom-node01.oldxu.net,job=tomcat_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=NginxDown,instance=prom-node01.oldxu.net,job=nginx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;5、验证最终&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/NO5EVWB.jpeg&#34; alt=&#34;7.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;73-告警抑制场景-2&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#73-告警抑制场景-2&#34;&gt;#&lt;/a&gt; 7.3 告警抑制场景 - 2&lt;/h5&gt;
&lt;p&gt;1、假设我们运⾏了 MySQL 主从，我们的告警规则如下：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: database-alerts&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 主库down机了&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: up&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;service&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;database&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;role&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;master&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: &lt;span class=&#34;token string&#34;&gt;&#39;critical&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      service: &lt;span class=&#34;token string&#34;&gt;&#39;database&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      role: &lt;span class=&#34;token string&#34;&gt;&#39;master&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    summary: &lt;span class=&#34;token string&#34;&gt;&#34;master database down&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; - alert: 从库down机了&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   expr: up&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;service&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;database&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;role&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;slave&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;     severity: &lt;span class=&#34;token string&#34;&gt;&#39;warning&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;     service: &lt;span class=&#34;token string&#34;&gt;&#39;database&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;     role: &lt;span class=&#34;token string&#34;&gt;&#39;slave&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   summary: &lt;span class=&#34;token string&#34;&gt;&#34;slave database down&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、接下来，模拟主库异常和从库异常，看是否会收到两条告警消息。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# alertname = 节点故障（--alertURL 指定 alertmanager 服务器所在的地址、端⼝以及接⼝）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=主库down机了,instance=mysql-master.oldxu.net,severity=critical,role=master,service=database,job=mysql_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=从库down机了,instance=mysql-slave.oldxu.net,severity=critical,role=slave,service=database,job=mysql_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、配置抑制规则，当主库出现故障，则抑制从库的故障&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/alertmanager/alertmanager.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;inhibit_rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- source_match:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    service: &lt;span class=&#34;token string&#34;&gt;&#34;database&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    role: &lt;span class=&#34;token string&#34;&gt;&#34;master&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  target_match:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    role: &lt;span class=&#34;token string&#34;&gt;&#34;slave&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  equal: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;service&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9093/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;八-aleartmanager高可用&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#八-aleartmanager高可用&#34;&gt;#&lt;/a&gt; 八. AleartManager ⾼可⽤&lt;/h4&gt;
&lt;h5 id=&#34;81-alertmanager传统架构&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#81-alertmanager传统架构&#34;&gt;#&lt;/a&gt; 8.1 AlertManager 传统架构&lt;/h5&gt;
&lt;p&gt;在⼤多数情况下，AlertManager 组件通常以单点架构存在，如下图所示。如果单点的 AlertManager 发⽣故障，将导致所有消息都⽆法及时发送，也就意味着系统即使出现了故障，我们也⽆法第⼀时间获取到对应的告警信息。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/IGhyGAQ.jpeg&#34; alt=&#34;8.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;82-alertmanager高可用架构&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#82-alertmanager高可用架构&#34;&gt;#&lt;/a&gt; 8.2 AlertManager ⾼可⽤架构&lt;/h5&gt;
&lt;p&gt;为了解决多个 AlertManager 之间的信息传递问题，AlertManager 引⼊了 Gossip 机制。这种机制类似于⼈们之间的留⾔传递，&lt;/p&gt;
&lt;p&gt;通过 Gossip 多个 AlertManager 之间可以及时共享相同的告警信息。这意味着，即使多个 AlertManager 分别接收到相同的告警信息，系统也能确保只有⼀个告警通知被发送给 Receiver。此外，即便其中⼀台 AlertManager 发⽣故障，也不会对其他节点的消息传递产⽣影响。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/7bf61kj.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;83-alertmanager高可用配置实践&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#83-alertmanager高可用配置实践&#34;&gt;#&lt;/a&gt; 8.3 AlertManager ⾼可⽤配置实践&lt;/h5&gt;
&lt;p&gt;注意：需要保证每台的 /etc/alertmanager/alertmanager.yml 的配置是⾼度⼀致的。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;主机名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;IP 地址&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;角色&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node01.oldxu.net&#34;&gt;prom-node01.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.221&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;AlertManager-1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node02.oldxu.net&#34;&gt;prom-node02.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.222&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;AlertManager-2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node03.oldxu.net&#34;&gt;prom-node03.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.223&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;AlertManager-3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;1、将 node01 节点上的，AlertManager 拷⻉⾄其他两个节点；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# scp -rp /etc/alertmanager-0.26.0.linux-amd64/ root@192.168.40.222:/etc/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# scp -rp /etc/alertmanager-0.26.0.linux-amd64/ root@192.168.40.223:/etc/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# node02 配置软链接&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node02 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/alertmanager-0.26.0.linux-amd64/ /etc/alertmanager&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# node03 配置软链接&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/alertmanager-0.26.0.linux-amd64/ /etc/alertmanager&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、在所有节点上，准备 alertmanager_ha.service 的启动配置⽂件（--cluster.listen-address: 当前实例集群服务监听地址 、--cluster.peer: 关联的其它实例地址&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl stop alertmanager&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;vim&lt;/span&gt; /usr/lib/systemd/system/alertmanager_ha.service&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;alertmanager&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/alertmanager/alertmanager &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --web.listen-address&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;:9093 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --cluster.listen-address&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;0.0&lt;/span&gt;.0.0:9094 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--cluster.peer&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.221:9094 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--cluster.peer&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.222:9094 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--cluster.peer&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.223:9094 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --cluster.peer-timeout&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;15s &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--config.file&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/alertmanager/alertmanager.yml &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--storage.path&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/alertmanager/data &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--data.retention&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;120h&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start alertmanager_ha.service &amp;amp;&amp;amp;  systemctl start alertmanager_ha.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、检查 AlertManager 集群状态&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/mZDdXSL.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;4、配置 Prometheus 对接多个 AlertManager 实例&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;alerting:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  alertmanagers:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - prom-node01.oldxu.net:9093&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - prom-node02.oldxu.net:9093&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - prom-node03.oldxu.net:9093&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;84-alertmanager高可用结果验证&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#84-alertmanager高可用结果验证&#34;&gt;#&lt;/a&gt; 8.4 AlertManager ⾼可⽤结果验证&lt;/h5&gt;
&lt;p&gt;1、测试集群同步状态，当在⼀个节点上创建了⼀个静默（Silence）记录，其他节点的监控⻚⾯能够即时显示该静默的信息。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/WuTLtnr.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;2、通过使⽤ curl 命令模拟 Prometheus，将同⼀条告警消息分别发送到两个 AlertManager 实例，验证最终是否只会收到⼀条消息。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 下载告警程序&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://file.oldxu.net/prometheus/Alert/alert_test_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# chmod +x alert_test_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# docker run -it --rm -v `pwd`:/app/program ubuntu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;root@4c83c1816d0b:/&lt;span class=&#34;token comment&#34;&gt;# cd /app/program/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# alertname=nodedown（--alertURL 指定 alertmanager 服务器所在的地址、端⼝以及接⼝）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.221:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=nodedown,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;./alert_test_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--alertURL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://192.168.40.222:9093/api/v1/alerts&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--label&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;alertname=nodedown,instance=prom-node01.oldxu.net,severity=critical,job=node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、根据此前的规则设定，node 相关的告警，最终会发送到 “钉钉的 OPS 团队”，并且只会有⼀条告警消息，⽽不会出现多条重复才对。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/PPRwiy6.jpeg&#34; alt=&#34;5.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;4、尝试停⽌掉某台 AlertManager 实例，验证消息是否还能正常发送。&lt;/p&gt;
</content>
        <category term="Prometheus" />
        <updated>2025-07-13T14:03:48.000Z</updated>
    </entry>
    <entry>
        <id>http://ixuyong.cn/posts/4081185381.html</id>
        <title>Prometheus监控实战（三）</title>
        <link rel="alternate" href="http://ixuyong.cn/posts/4081185381.html"/>
        <content type="html">&lt;h3 id=&#34;prometheus监控实战三&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#prometheus监控实战三&#34;&gt;#&lt;/a&gt; Prometheus 监控实战（三）&lt;/h3&gt;
&lt;h4 id=&#34;一-promtheus节点监控&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#一-promtheus节点监控&#34;&gt;#&lt;/a&gt; 一. Promtheus 节点监控&lt;/h4&gt;
&lt;h5 id=&#34;11-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#11-配置prometheus&#34;&gt;#&lt;/a&gt; 1.1  配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# rules 配置文件路径&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt;   &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:          &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;12-创建rules目录并重载prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#12-创建rules目录并重载prometheus&#34;&gt;#&lt;/a&gt; 1.2 创建 rules 目录并重载 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mkdir /etc/prometheus/rules&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;13-promtheus配置告警规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#13-promtheus配置告警规则&#34;&gt;#&lt;/a&gt; 1.3 Promtheus 配置告警规则&lt;/h5&gt;
&lt;h6 id=&#34;131-配置cpu告警规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#131-配置cpu告警规则&#34;&gt;#&lt;/a&gt; 1.3.1 配置 CPU 告警规则&lt;/h6&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 配置 CPU 告警规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/node_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: CPU告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点处于Down状态&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: up &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;节点处于Down状态,实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34; 节点已关闭&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点CPU使率超过80%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - avg&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机CPU利率过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: CPU饱和度过⾼&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;count&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;CPU饱和度过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h6 id=&#34;132-配置内存告警规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#132-配置内存告警规则&#34;&gt;#&lt;/a&gt; 1.3.2 配置内存告警规则&lt;/h6&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;figcaption data-lang=&#34;Bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 配置内存告警规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/node_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: CPU告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点处于Down状态&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: up &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;节点处于Down状态,实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34; 节点已关闭&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点CPU使率超过80%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - avg&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机CPU利率过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: CPU饱和度过⾼&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;count&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;CPU饱和度过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: 内存告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 主机内存不⾜&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_memory_MemTotal_bytes * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机内存使用率较高, 实例:, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的内存使用率持续2分钟高于80%，当前利用率：%&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 内存饱和度⾼&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机内存内存饱和度高, 实例:, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;SWAP内存使用率已连续2分钟超过10%，表明内存饱和度过⾼，当前SWAP使用率为：%。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h6 id=&#34;133-配置磁盘告警规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#133-配置磁盘告警规则&#34;&gt;#&lt;/a&gt; 1.3.3 配置磁盘告警规则&lt;/h6&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;figcaption data-lang=&#34;Bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/node_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: CPU告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点处于Down状态&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: up &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;节点处于Down状态,实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34; 节点已关闭&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点CPU使率超过80%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - avg&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机CPU利率过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: CPU饱和度过⾼&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;count&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;CPU饱和度过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 主机内存不⾜&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_memory_MemTotal_bytes * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机内存使用率较高, 实例:, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的内存使用率持续2分钟高于80%，当前利用率：%&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 内存饱和度⾼&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机内存内存饱和度高, 实例:, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;SWAP内存使用率已连续2分钟超过10%，表明内存饱和度过⾼，当前SWAP使用率为：%。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: 磁盘告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘空间告急&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; - node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;70&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘 分区空间不足&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘  分区空间使用率已超过 70%，当前使用率为 %，请及时处理。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘Inode空间告急&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_filesystem_files&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; - node_filesystem_files_free&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_filesystem_files&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;70&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘 分区Inode空间不足&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘  分区的Inode空间使用率已超过 70%，，当前使用率为 %，请及时处理。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IOPS写入较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token comment&#34;&gt;#expr: sum(rate(node_disk_writes_completed_total[1m])) by (instance,job) / 120 * 100 &gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token comment&#34;&gt;#round 函数可以对值进行四舍五入，磁盘最大 IOPS 为 120 次 /s&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_writes_completed_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;120&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  IOPS每秒写入次数超过120次/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS写入饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼47--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS每秒写入最大 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼48--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; 次/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;                &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IOPS读取较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_reads_completed_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;120&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  IOPS每秒读取次数超过120次/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS读取饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼50--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS每秒读取最⼤ &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼51--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; 次/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;94&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IO写入吞吐较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;95&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_written_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; /1024 / &lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;96&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;97&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;98&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;99&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;100&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘IO写入每秒超过最高30MB/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;101&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;102&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO写入吞吐量的饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼53--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;103&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO写入吞吐量每秒最大是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼54--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;MB/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;104&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;105&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IO读取吞吐较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;106&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_read_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; /1024 /30 * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;107&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;108&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;109&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;110&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;111&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘IO读取每秒超过最大30MB/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;112&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;113&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO读取吞吐量的饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼56--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;114&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO读取吞吐量每秒最大是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼57--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;MB/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;115&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;.instance &lt;span class=&#34;token variable&#34;&gt;$labels&lt;/span&gt;.job &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; query &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; first &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; value &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;token builtin class-name&#34;&gt;printf&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;%.2f&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;MB/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;116&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;117&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;118&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;119&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;120&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;121&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;122&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;123&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#根据过去 24 小时磁盘使用情况，计算未来 30 天磁盘使用空间&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;124&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;predict_linear&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;~&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs|rootfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;24h&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;,60*60*24*30&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /1024/1024/1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h6 id=&#34;134-配置网络告警规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#134-配置网络告警规则&#34;&gt;#&lt;/a&gt; 1.3.4 配置⽹络告警规则&lt;/h6&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/node_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: 节点告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点处于Down状态&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: up &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;节点处于Down状态,实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34; 节点已关闭&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点CPU使率超过80%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - avg&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机CPU利率过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的CPU利用率低于20%，当前利用率：%。可能存在CPU资源浪费情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: CPU饱和度过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;count&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;CPU饱和度过高，实例：, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的1分钟平均CPU负载超过了核心数的两倍，已经持续2分钟，当前CPU饱和度：%。需要立即检查系统负载情况。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 主机内存不足&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_memory_MemTotal_bytes * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机内存使用率较高, 实例:, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例的内存使用率持续2分钟高于80%，当前利用率：%&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 内存饱和度高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 2m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;主机内存内存饱和度高, 实例:, 任务:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;SWAP内存使用率已连续2分钟超过10%，表明内存饱和度过高，当前SWAP使用率为：%。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘空间告急&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; - node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;70&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘 分区空间不足&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘  分区空间使用率已超过 70%，当前使用率为 %，请及时处理。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘Inode空间告急&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_filesystem_files&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; - node_filesystem_files_free&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_filesystem_files&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tmpfs&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;70&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘 分区Inode空间不足&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘  分区的Inode空间使用率已超过 70%，，当前使用率为 %，请及时处理。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IOPS写入较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token comment&#34;&gt;#expr: sum(rate(node_disk_writes_completed_total[1m])) by (instance,job) / 120 * 100 &gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token comment&#34;&gt;#round 函数可以对值进行四舍五入，磁盘最大 IOPS 为 120 次 /s&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_writes_completed_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;120&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  IOPS每秒写入次数超过120次/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS写入饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼83--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS每秒写入最大 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼84--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; 次/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;                &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IOPS读取较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_reads_completed_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;120&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  IOPS每秒读取次数超过120次/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS读取饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼86--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IOPS每秒读取最⼤ &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼87--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; 次/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IO写入吞吐较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_written_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; /1024 / &lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;94&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;95&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;96&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;97&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;98&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘IO写入每秒超过最高30MB/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;99&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;100&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO写入吞吐量的饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼89--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;101&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO写入吞吐量每秒最大是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼90--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;MB/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;102&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;103&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 磁盘IO读取吞吐较高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;104&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: round&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_read_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; /1024 /30 * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;105&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;106&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;107&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;108&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;109&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  磁盘IO读取每秒超过最大30MB/s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;110&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;111&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO读取吞吐量的饱和度是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼92--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;112&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前磁盘IO读取吞吐量每秒最大是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼93--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;MB/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;113&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;114&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 网络下载带宽异常&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;115&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;8&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job,device&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;50&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;116&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;117&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;118&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;119&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;120&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  的  接口下载流量已经超过公司实际50Mbps&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;121&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;122&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前下载带宽已经达到 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼96--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; Mbps/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;123&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前下载带宽使用率在 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼97--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;124&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;125&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 网络上传带宽异常&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;126&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_network_transmit_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;8&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job,device&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;50&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;127&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;128&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;129&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;130&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;131&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  的  接口上传流量已经超过公司实际50Mbps&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;132&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;133&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前上传带宽已经达到 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼100--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; Mbps/s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;134&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        当前上传带宽使用率在 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼101--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;135&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;136&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;137&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;138&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;139&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;140&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;14-检查告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#14-检查告警规则文件&#34;&gt;#&lt;/a&gt; 1.4 检查告警规则⽂件&lt;/h5&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/fAluZFK.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;15-导入-grafana-模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#15-导入-grafana-模板&#34;&gt;#&lt;/a&gt; 1.5 导入 Grafana 模板&lt;/h5&gt;
&lt;p&gt;在 Grafana 的官方插件库中，有很多 Node-exporter 模板。其中相对受欢的模板的 ID 是： ﻿11074、1860﻿。&lt;/p&gt;
&lt;p&gt;11074﻿：模板包括了 CPU、内存、磁盘、网络、温度传感器等指标（常用）。&lt;/p&gt;
&lt;p&gt;1860﻿：模板包括 CPU、内存、磁盘、网络等。这运行状况，及时发现潜在问题并进行调优。&lt;/p&gt;
&lt;h4 id=&#34;二-prometheus监控rabbitmq&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#二-prometheus监控rabbitmq&#34;&gt;#&lt;/a&gt; 二. Prometheus 监控 RabbitmQ&lt;/h4&gt;
&lt;h5 id=&#34;21-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#21-配置prometheus&#34;&gt;#&lt;/a&gt; 2.1 配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;22-rabbitmq告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#22-rabbitmq告警规则文件&#34;&gt;#&lt;/a&gt; 2.2 RabbitMQ 告警规则文件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 配置 rabbitmq 告警规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/rabbitmq_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: rabbitmq告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: RabbitMQDown&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: up&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: High&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Rabbitmq Down,实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Rabbitmq_exporter连不上RabbitMQ!&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: RabbitMQ队列已就绪的消息过多&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: avg_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rabbitmq_queue_messages_ready&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;500&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#39; RabbitMQ实例的队列消息准备过多&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#39;实例中平均准备好待消费的消息数量超过500，当前平均值为。&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: RabbitMQ队列中已消费但未确认的消息过多&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: avg_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rabbitmq_queue_messages_unacked&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;500&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#39; RabbitMQ实例的队列消息确认存在延迟&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#39; 实例中平均已被消费但未被确认的消息数量超过500，当前平均值为。&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: RabbitMQ磁盘空间预测不足&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: predict_linear&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rabbitmq_disk_space_available_bytes&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;24h&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;, &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;*60*24*10&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; rabbitmq_disk_space_available_limit_bytes&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1h&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#39; RabbitMQ实例的磁盘空间预测不足。&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#39;基于过去24小时磁盘可用空间数据预测，未来10天内磁盘的可用空间可能低于默认配置的50MB。&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: RabbitMQ文件描述符使用率过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: max_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rabbitmq_process_open_fds&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / rabbitmq_process_max_fds * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#39; RabbitMQ实例的文件描述符使用率过高&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#39; 实例打开的文件描述符数量最大值，占文件描述限制的比率超过80%，当前比率为%。&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: RabbitMQ TCP套接字使用率过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: max_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rabbitmq_process_open_tcp_sockets&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / rabbitmq_process_max_tcp_sockets * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#39; RabbitMQ实例的TCP套接字使用率过高&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#39; 实例打开的TCP套接字数量最大值，占操作系统允许的TCP连接数限制的比率超过80%，当前比率为%。&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/rabbitmq_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;23-导入-grafana-模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#23-导入-grafana-模板&#34;&gt;#&lt;/a&gt; 2.3 导入 Grafana 模板&lt;/h5&gt;
&lt;p&gt;导⼊ RabbitMQ 的 Grafana 模板。ID 为 10991&lt;/p&gt;
&lt;h4 id=&#34;三-prometheus监控nginx&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#三-prometheus监控nginx&#34;&gt;#&lt;/a&gt; 三. Prometheus 监控 Nginx&lt;/h4&gt;
&lt;h5 id=&#34;31-安装并配置nginx&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#31-安装并配置nginx&#34;&gt;#&lt;/a&gt; 3.1 安装并配置 Nginx&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 安装 Nginx&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install nginx -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/nginx/conf.d/mointor.oldxu.net.conf&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;server &lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	 listen &lt;span class=&#34;token number&#34;&gt;8888&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	 server_name monitor.oldxu.net&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	 location /nginx_status &lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;		 stub_status on&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; 	 &lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# nginx -t&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl enable nginx &amp;amp;&amp;amp; systemctl start nginx&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查 Nginx 的状态⻚⾯&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  curl http://localhost:8888/nginx_status&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Active connections: &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;server accepts handled requests&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Reading: &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; Writing: &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; Waiting: &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;32-安装并配置nginx-exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#32-安装并配置nginx-exporter&#34;&gt;#&lt;/a&gt; 3.2 安装并配置 Nginx-exporter&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 下载 Nginx-exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v1.1.0/nginx-prometheus-exporter_1.1.0_linux_amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#加速地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v1.1.0/nginx-prometheus-exporter_1.1.0_linux_amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 将 Nginx_exporter 安装到指定的路径&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mkdir /etc/nginx_exporter_1.1.0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf nginx-prometheus-exporter_1.1.0_linux_amd64.tar.gz -C /etc/nginx_exporter_1.1.0/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/nginx_exporter_1.1.0/ /etc/nginx_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 nginx_exporter&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ./nginx-prometheus-exporter --web.listen-address=:9113 --nginx.scrape-uri=http://127.0.0.1:8888/nginx_status&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 为 nginx_exporter 准备 system 启停⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/nginx_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;nginx-exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/nginx_exporter/nginx-prometheus-exporter &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --web.listen-address&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;:9113 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --web.telemetry-path&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --nginx.scrape-uri&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http://127.0.0.1:8888/nginx_status&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;on-failure&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;RestartSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;20&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4. 启动 nginx_exporter 服务，它默认监听在 9113 端⼝上&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  systemctl daemon-reload &amp;amp;&amp;amp; systemctl enable nginx_exporter &amp;amp;&amp;amp; systemctl start nginx_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 9113&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::9113                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;1829&lt;/span&gt;/nginx-promethe &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#5. 访问 nginx_exporter 暴露的 metrics，检查是否能获取到对应的指标数据&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 nginx_exporter&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  curl http://127.0.0.1:9113/metrics&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE go_gc_duration_seconds summary&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0.25&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0.5&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0.75&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;33-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#33-配置prometheus&#34;&gt;#&lt;/a&gt; 3.3 配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;34-nginx告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#34-nginx告警规则文件&#34;&gt;#&lt;/a&gt; 3.4 Nginx 告警规则⽂件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 具体的告警规则示例⽂件（需要根据公司实际情况进⾏调整）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/nginx_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: nginx告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Nginx Server Down&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: nginx_up &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Nginx 服务不存活, 实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;nginx_exporter连不上Nginx了，当前状态为: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Nginx活跃连接数过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: avg_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;nginx_connections_active&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;500&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Nginx 活跃连接数过高, 实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34; Nginx 的平均活跃连接数超过了设定的500阈值，当前值为 。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Nginx等待连接数高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: max_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;nginx_connections_waiting&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Nginx 等待连接数过高, 实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Nginx 的等待连接数超过了设定的100阈值，当前最大值为 。可能后端服务存在瓶颈。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Nginx读写入率异常&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;nginx_connections_reading - nginx_connections_writing&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / nginx_connections_reading * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Nginx 读写入率异常, 实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Nginx 读取请求的数量高于写请求的数量，当前读请求高于写请求比率是: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Nginx⼤量TCP连接处理失败&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: nginx_connections_accepted - nginx_connections_handled &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;50&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Nginx 大量TCP连接处理失败, 实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Nginx 接受的连接数与处理成功的连接数之差超过了50，当前差值为&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;35-导入-grafana-模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#35-导入-grafana-模板&#34;&gt;#&lt;/a&gt; 3.5 导入 Grafana 模板&lt;/h5&gt;
&lt;p&gt;导⼊ nginx 的 Grafana 模板。ID 为 12708&lt;/p&gt;
&lt;h4 id=&#34;四-prometheus监控tomcat&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#四-prometheus监控tomcat&#34;&gt;#&lt;/a&gt; 四. Prometheus 监控 Tomcat&lt;/h4&gt;
&lt;h5 id=&#34;41-安装并配置tomcat&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#41-安装并配置tomcat&#34;&gt;#&lt;/a&gt; 4.1 安装并配置 Tomcat&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 安装 tomcat&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 nginx_exporter&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install tomcat tomcat-webapps -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 下载所依赖的 jar 包&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient/0.12.0/simpleclient-0.12.0.jar&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_common/0.12.0/simpleclient_common-0.12.0.jar&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_hotspot/0.12.0/simpleclient_hotspot-0.12.0.jar&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_servlet/0.12.0/simpleclient_servlet-0.12.0.jar&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_servlet_common/0.12.0/simpleclient_servlet_common-0.12.0.jar&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://search.maven.org/remotecontent?filepath=nl/nlighten/tomcat_exporter_client/0.0.15/tomcat_exporter_client-0.0.15.jar&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://search.maven.org/remotecontent?filepath=nl/nlighten/tomcat_exporter_servlet/0.0.15/tomcat_exporter_servlet-0.0.15.war&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 整合包的下载地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/Im-oldxu/tomcat-exporter/releases/download/tomcat_exporter-0.0.17/tomcat_exporter.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 将 jar 包和 war 包分别拷⻉⾄对应的⽬录下&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cp tomcat_exporter/*.jar /usr/share/tomcat/lib/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cp tomcat_exporter/*.war /usr/share/tomcat/webapps/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4. 启动 Tomcat&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start tomcat &amp;amp;&amp;amp; systemctl enable tomcat&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#5. 访问 tomcat 的 metrics&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl http://localhost:8080/metrics/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE process_cpu_seconds_total counter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;process_cpu_seconds_total &lt;span class=&#34;token number&#34;&gt;7.37&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP process_start_time_seconds Start time of the process since unix epoch in seconds.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE process_start_time_seconds gauge&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;process_start_time_seconds &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;.70921425481E9&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP process_open_fds Number of open file descriptors.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE process_open_fds gauge&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;process_open_fds &lt;span class=&#34;token number&#34;&gt;65.0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;42-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#42-配置prometheus&#34;&gt;#&lt;/a&gt; 4.2 配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;tomcat&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8080&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;43-tomcat告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#43-tomcat告警规则文件&#34;&gt;#&lt;/a&gt; 4.3 Tomcat 告警规则⽂件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 具体的告警规则示例⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/tomcat_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: tomcat告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Tomcat活跃连接数过⾼&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: tomcat_connections_active_total / tomcat_connections_active_max* &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Tomcat服务器活跃连接数过高, 实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        Tomcat最大连接数是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼127--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        Tomcat目前连接数是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼128--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        Tomcat活跃连接数已超过最大活跃连接数的80%, 当前值为 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼129--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;                &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Tomcat处理请求超过5秒&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;tomcat_requestprocessor_time_seconds&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Tomcat处理请求时间过长, 实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Tomcat在过去5分钟的平均处理请求时间超过5秒，当前值 。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: &lt;span class=&#34;token string&#34;&gt;&#34;Tomcat会话拒绝率超过20%&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;tomcat_session_rejected_total / &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;tomcat_session_created_total +tomcat_session_rejected_total&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;20&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Tomcat会话拒绝率过高, 实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Tomcat在Host: 的  的上下文中的会话拒绝率超过20%，当前值 。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: &lt;span class=&#34;token string&#34;&gt;&#34;Tomcat线程使用率过高&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;tomcat_threads_active_total / tomcat_threads_max&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Tomcat线程使⽤率过⾼, 实例:&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        Tmcat最大线程数是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼137--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        Tomcat目前线程数是 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼138--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        Tomcat线程数已超过最大活跃连接数的80%, 当前值为 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼139--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/node_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;44-导入-grafana-模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#44-导入-grafana-模板&#34;&gt;#&lt;/a&gt; 4.4 导入 Grafana 模板&lt;/h5&gt;
&lt;p&gt;1、下载对应的 dashboard&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;wget&lt;/span&gt; https://mirror.ghproxy.com/https://github.com/nlighten/tomcat_exporter/blob/master/dashboard/example.json&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;五-prometheus监控springboot&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#五-prometheus监控springboot&#34;&gt;#&lt;/a&gt; 五. Prometheus 监控 SpringBoot&lt;/h4&gt;
&lt;h5 id=&#34;51-下载jmx-exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#51-下载jmx-exporter&#34;&gt;#&lt;/a&gt; 5.1 下载 jmx-exporter&lt;/h5&gt;
&lt;p&gt;1、访问 github， &lt;a href=&#34;https://github.com/prometheus/jmx_exporter/releases&#34;&gt;https://github.com/prometheus/jmx_exporter/releases&lt;/a&gt; ，下载 java-expoter&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mkdir /etc/jmx_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cd /etc/jmx_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 springboot&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://repo.maven.apache.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.20.0/jmx_prometheus_javaagent-0.20.0.jar&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、准备 config.yml 配置⽂件（规则⽂件可以定义要暴露哪些指标给 Prometheus）&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/jmx_exporter/config.yaml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- pattern: &lt;span class=&#34;token string&#34;&gt;&#34;.*&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;52-运行springboot应用&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#52-运行springboot应用&#34;&gt;#&lt;/a&gt; 5.2 运⾏ SpringBoot 应⽤&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、安装 java 基础环境&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  yum install java-11-openjdk maven -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget -O /etc/maven/settings.xml https://linux.oldxu.net/settings.xml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2、下载 java 应⽤然后进⾏编译&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://file.oldxu.net/jenkins/springboot-devops-myapp-java11-jar.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf springboot-devops-myapp-java11-jar.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cd springboot-devops-myapp-jar/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 springboot-devops-myapp-jar&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mvn package&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3、运⾏ java 应⽤，并加载 jmx 监控，监听 12345 端⼝， &amp;lt;path_to_jmx_exporter.jar&gt;=&amp;lt;exporter_port&gt;:&amp;lt;path_to_config.yaml&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 springboot-devops-myapp-jar&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# java \&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; -javaagent:/etc/jmx_exporter/jmx_prometheus_javaagent-0.20.0.jar&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;12345&lt;/span&gt;:/etc/jmx_exporter/config.yaml &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-jar&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-Xms50m&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-Xmx50m&lt;/span&gt; target/devops-myapp-1.0.jar &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--server.port&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;8081&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;amp;&gt;&lt;/span&gt;/var/log/springboot.log &lt;span class=&#34;token operator&#34;&gt;&amp;amp;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;span class=&#34;token comment&#34;&gt;#4、检查对应的端⼝是否正常&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 springboot-devops-myapp-jar&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl http://localhost:12345/metrics&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP jmx_scrape_error Non-zero if this scrape failed.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE jmx_scrape_error gauge&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;jmx_scrape_error &lt;span class=&#34;token number&#34;&gt;0.0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP jmx_scrape_cached_beans Number of beans with their matching rule cached&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;53-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#53-配置prometheus&#34;&gt;#&lt;/a&gt; 5.3  配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;tomcat&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8080&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;jmx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:12345&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;54-jmx告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#54-jmx告警规则文件&#34;&gt;#&lt;/a&gt; 5.4 JMX 告警规则⽂件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/jvm_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: &lt;span class=&#34;token string&#34;&gt;&#34;JVM告警规则&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: JVM堆内存使用率过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: jvm_memory_bytes_used&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;area&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;heap&#34;&lt;/span&gt;,&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; / jvm_memory_bytes_max&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;area&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;heap&#34;&lt;/span&gt;,&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;JVM 堆内存使用率过高, 实例:, job: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;JVM堆内存使用率超过80%, 当前值 %&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: JVMGC时间过长&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token function&#34;&gt;sum&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;jvm_gc_collection_seconds_sum&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;jvm_gc_collection_seconds_count&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;gc, instance, job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;JVM GC时间过长, 实例:, job: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;JVM  的回收时间超过1s，当前值 s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: JVM死锁线程过多&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: min_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;jvm_threads_deadlocked&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;JVM检测到死锁线程&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;在过去5分钟内JVM检测到存在死锁线程, 当前值 。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/jvm_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;55-导入-grafana-模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#55-导入-grafana-模板&#34;&gt;#&lt;/a&gt; 5.5 导入 Grafana 模板&lt;/h5&gt;
&lt;p&gt;导⼊⼀个 JVM 的 Grafana 模板。Dashboard ID 为 14845&lt;/p&gt;
&lt;h4 id=&#34;六-安装并配置mysql_master&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#六-安装并配置mysql_master&#34;&gt;#&lt;/a&gt; 六。安装并配置 mysql_master&lt;/h4&gt;
&lt;h5 id=&#34;61-安装并配置mysql_master&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#61-安装并配置mysql_master&#34;&gt;#&lt;/a&gt; 6.1 安装并配置 mysql_master&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、安装 Mysql5.7&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install -y mysql-community-server&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start mysqld &amp;amp;&amp;amp; systemctl enable mysqld&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mysql -uroot -p$(awk &#39;/temporary password/&amp;#123;print $NF&amp;#125;&#39; /var/log/mysqld.log)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;mysql&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;  ALTER &lt;span class=&#34;token environment constant&#34;&gt;USER&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;root&#39;&lt;/span&gt;@&lt;span class=&#34;token string&#34;&gt;&#39;localhost&#39;&lt;/span&gt; IDENTIFIED BY &lt;span class=&#34;token string&#34;&gt;&#39;Superman*2023&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2、创建⼀个 mysql_exporter 专属的监控账户&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;mysql&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; create user &lt;span class=&#34;token string&#34;&gt;&#39;exporter&#39;&lt;/span&gt;@&lt;span class=&#34;token string&#34;&gt;&#39;localhost&#39;&lt;/span&gt; identified by &lt;span class=&#34;token string&#34;&gt;&#39;Superman*2023&#39;&lt;/span&gt; WITH MAX_USER_CONNECTIONS &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;mysql&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; grant process,replication client,select on *.* to &lt;span class=&#34;token string&#34;&gt;&#39;exporter&#39;&lt;/span&gt;@&lt;span class=&#34;token string&#34;&gt;&#39;localhost&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3、创建 MySQL 从库复制的账户&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;mysql&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; grant replication slave on *.* to &lt;span class=&#34;token string&#34;&gt;&#39;repl&#39;&lt;/span&gt;@&lt;span class=&#34;token string&#34;&gt;&#39;%&#39;&lt;/span&gt; identified by &lt;span class=&#34;token string&#34;&gt;&#39;Superman*2023&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;mysql&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; flush privileges&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4. 配置主库&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/my.cnf&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;server-id&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;log-bin&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;mysql-bin&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;read-only&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl restart mysqld&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;62-安装并配置mysql_slave&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#62-安装并配置mysql_slave&#34;&gt;#&lt;/a&gt; 6.2 安装并配置 mysql_slave&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、从库配置&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install -y mysql-community-server&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@db02 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/my.cnf&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;server-id&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;read-only&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2、创建⼀个 mysql_exporter 专属的监控账户&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;grant all on *.* to &lt;span class=&#34;token string&#34;&gt;&#39;exporter&#39;&lt;/span&gt;@&lt;span class=&#34;token string&#34;&gt;&#39;localhost&#39;&lt;/span&gt; identified by &lt;span class=&#34;token string&#34;&gt;&#39;Superman*2023&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3、获取主库的信息，⽽后配置从库的 change master&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;mysql&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; show master status&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;+------------------+----------+--------------+------------------+-------------------+&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; File             &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; Position &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; Binlog_Do_DB &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; Binlog_Ignore_DB &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; Executed_Gtid_Set &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;+------------------+----------+--------------+------------------+-------------------+&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; mysql-bin.000007 &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;154&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;              &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;                  &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;                   &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;+------------------+----------+--------------+------------------+-------------------+&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; row &lt;span class=&#34;token keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;token builtin class-name&#34;&gt;set&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;0.01&lt;/span&gt; sec&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4、配置从服务器，连接主服务器&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;mysql&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; change master to &lt;span class=&#34;token assign-left variable&#34;&gt;master_host&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;192.168.40.223&#39;&lt;/span&gt;,master_user&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;repl&#39;&lt;/span&gt;,master_password&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;Superman*2023&#39;&lt;/span&gt;,master_log_file&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;mysql-bin.000007&#39;&lt;/span&gt;,master_log_pos&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;154&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#5. 开启从库&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;mysql&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; start slave&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#6. 检查主从复制状态&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;mysql&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; show slave status&lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;G&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;63-安装并配置mysqld_exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#63-安装并配置mysqld_exporter&#34;&gt;#&lt;/a&gt; 6.3 安装并配置 mysqld_exporter&lt;/h5&gt;
&lt;p&gt;1、访问 mysqld_exporter 的 github 地址， &lt;a href=&#34;https://github.com/prometheus/mysqld_exporter/releases&#34;&gt;https://github.com/prometheus/mysqld_exporter/releases&lt;/a&gt; 下载 mysqld-exporter&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、下载 mysqld_expor&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.0/mysqld_exporter-0.15.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 加速地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.0/mysqld_exporter-0.15.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2、解压 mysqld_expor&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf mysqld_exporter-0.15.0.linux-amd64.tar.gz -C /etc/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/mysqld_exporter-0.15.0.linux-amd64/ /etc/mysqld_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3、启动 mysqld_expor&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# export MYSQLD_EXPORTER_PASSWORD=Superman*2023&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/mysqld_exporter/mysqld_exporter --mysqld.address=localhost:3306 --mysqld.username=exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4、编写 mysqld_exporter 启动⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/mysqld_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;mysqld_exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Environment&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;MYSQLD_EXPORTER_PASSWORD=Superman*2023&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/mysqld_exporter/mysqld_exporter &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--mysqld.address&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;localhost:3306 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--mysqld.username&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;exporter &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        --web.listen-address&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;:9104 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        --web.telemetry-path&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.info_schema.processlist&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.info_schema.innodb_tablespaces&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.info_schema.innodb_metrics&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.info_schema.query_response_time&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.info_schema.userstats&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.info_schema.tables&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.global_status&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.global_variables&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.slave_status&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.binlog_size&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;span class=&#34;token parameter variable&#34;&gt;--collect.engine_innodb_status&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$MAINPID&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4、启动 mysqld_exporter，并检查服务&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start mysqld_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#5、测试 mysqld_exporter 能否获取到对应的指标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp |grep 9104&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::9104                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;2863&lt;/span&gt;/mysqld_exporte &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  curl http://localhost:9104/metrics&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;64-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#64-配置prometheus&#34;&gt;#&lt;/a&gt; 6.4 配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;tomcat&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8080&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;jmx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:12345&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;mysqld_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: master&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: slave&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;65-mysql告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#65-mysql告警规则文件&#34;&gt;#&lt;/a&gt; 6.5 MySQL 告警规则⽂件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、编写 MySQL 告警规则⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/mysql_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: mysql告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: MySQL主库实例宕机&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: mysql_up&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;role&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;master&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 0m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL实例宕机, 实例: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;服务: ⻆⾊:  已经宕机。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: MySQL从库实例宕机&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: mysql_up&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;role&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;slave&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 0m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL实例宕机, 实例: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;服务: ⻆⾊:  已经宕机。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: MySQL实例重启&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;mysql_global_status_uptime&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job,service,role&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 0m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL实例重启, 实例 &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;服务: ⻆⾊:  运行时间小于60s。当前值 &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: MySQL连接数使用率超过80%&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: max_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;mysql_global_status_threads_connected&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / mysql_global_variables_max_connections * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL连接数过高, 实例 ,服务: ⻆⾊: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例MySQL的连接数在过去5分钟内超过了最大连接数的80%, 当前值 %。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: MySQL活跃线程数高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: avg_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;mysql_global_status_threads_running&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / mysql_global_variables_max_connections * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL活跃线程数过高, 实例 ,服务: 角色: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例MySQL的活跃线程数在过去5分钟内持续超过了最大连接数的60%, 当前值 %。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: MySQL查询率&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;QPS&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;mysql_global_status_queries&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1000&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL查询率(QPS)超标, 实例 ,服务: 角色: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例MySQL的查询率(QPS)在过去5分钟内超过1000, 当前值 。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: MySQL事务率&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;TPS&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;mysql_global_status_commands_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;command&lt;span class=&#34;token operator&#34;&gt;=~&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;(commit|rollback)&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; without &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;command&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL事务率(TPS)超标, 实例 ,服务: 角色: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例MySQL的事务率(TPS)在过去5分钟内超过100, 当前值 。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: MySQL文件描述符使用率过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: mysql_global_status_open_files / mysql_global_variables_open_files_limit * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL活跃线程数过高, 实例 ,服务: 角色: &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例MySQL的文件描述符使用率超过80%，当前值 %可能需要增加文件描述符限制。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Mysql从库IO线程未运行&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: mysql_slave_status_slave_io_running &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL从库IO线程已停止, 实例 &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该MySQL实例IO线程已停止，当前值 &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Mysql从库SQL线程未运行&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: mysql_slave_status_slave_sql_running &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL从库SQL线程已停止, 实例 &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;94&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该MySQL实例SQL线程已停止，当前值 &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;95&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;96&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Mysql从库复制延迟过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;97&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: mysql_slave_status_seconds_behind_master - mysql_slave_status_sql_delay &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;98&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;99&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;100&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;101&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;102&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;MySQL从库复制延迟过高, 实例 &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;103&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;该实例MySQL的复制延迟超过5s，当前值 s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;104&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;105&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;106&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/mysql_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;107&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking /etc/prometheus/rules/mysql_rules.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;108&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS: &lt;span class=&#34;token number&#34;&gt;11&lt;/span&gt; rules found&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;109&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;110&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;111&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;66-导入-grafana-模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#66-导入-grafana-模板&#34;&gt;#&lt;/a&gt; 6.6 导入 Grafana 模板&lt;/h5&gt;
&lt;p&gt;导⼊⼀个 MySQL 的 Grafana 模板。Dashboard ID 为 7362、9625 ，⽽监控 MySQL 主从的 Dashboard 可以使⽤ 11323&lt;/p&gt;
&lt;h4 id=&#34;七-prometheus监控redis&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#七-prometheus监控redis&#34;&gt;#&lt;/a&gt; 七. Prometheus 监控 Redis&lt;/h4&gt;
&lt;h5 id=&#34;71-安装并配置redis&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#71-安装并配置redis&#34;&gt;#&lt;/a&gt; 7.1 安装并配置 Redis&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install redis -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/redis.conf &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;maxmemory 200mb&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start redis &amp;amp;&amp;amp; systemctl enable redis&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep redis&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp        &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;127.0&lt;/span&gt;.0.1:6379          &lt;span class=&#34;token number&#34;&gt;0.0&lt;/span&gt;.0.0:*               LISTEN      &lt;span class=&#34;token number&#34;&gt;2532&lt;/span&gt;/redis-server &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;72-安装并配置redis_exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#72-安装并配置redis_exporter&#34;&gt;#&lt;/a&gt; 7.2 安装并配置 redis_exporter&lt;/h5&gt;
&lt;p&gt;1、访问 redis_exporter 的 github 地址， &lt;a href=&#34;https://github.com/oliver006/redis_exporter/releases&#34;&gt;https://github.com/oliver006/redis_exporter/releases&lt;/a&gt; ，下载 redis_exporter&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、下载 redis_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://github.com/oliver006/redis_exporter/releases/download/v1.57.0/redis_exporter-v1.57.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#加速地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/oliver006/redis_exporter/releases/download/v1.57.0/redis_exporter-v1.57.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2、解压 redis_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf redis_exporter-v1.57.0.linux-amd64.tar.gz -C /etc&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/redis_exporter-v1.57.0.linux-amd64/ /etc/redis_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3、配置 redis_exporter 启动⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/redis_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;redis_exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/redis_exporter/redis_exporter &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;-redis.addr&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;redis://localhost:6379&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;-redis.password&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  -web.listen-address&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;:9121&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  -web.telemetry-path&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$MAINPID&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4、启动 redis_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start redis_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl enable redis_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 9121&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::9121                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;2600&lt;/span&gt;/redis_exporter &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#5、访问 redis 的 metrics&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl http://localhost:9121/metrics&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE go_gc_duration_seconds summary&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;4&lt;/span&gt;.7772e-05&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0.25&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;4&lt;/span&gt;.7772e-05&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0.5&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;9&lt;/span&gt;.3206e-05&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0.75&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;9&lt;/span&gt;.3206e-05&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;1&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;9&lt;/span&gt;.3206e-05&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds_sum &lt;span class=&#34;token number&#34;&gt;0.000140978&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds_count &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP go_goroutines Number of goroutines that currently exist.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE go_goroutines gauge&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_goroutines &lt;span class=&#34;token number&#34;&gt;8&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;73-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#73-配置prometheus&#34;&gt;#&lt;/a&gt; 7.3 配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、修改 Prometheus 配置&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;tomcat&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8080&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;jmx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:12345&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;mysqld_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: master&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: slave&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;redis_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9121&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;74-redis告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#74-redis告警规则文件&#34;&gt;#&lt;/a&gt; 7.4 Redis 告警规则⽂件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、编写 Redis 告警规则⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/redis_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: redis告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Redis实例宕机&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_up&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance, job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例宕机,  &#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  在过去1分钟内无法连接。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Redis实例重启&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_uptime_in_seconds&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance, job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 0m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  重启&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  出现重启。当前运行时间: 秒。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Redis连接数过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: redis_connected_clients / redis_config_maxclients * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  连接数超过80%&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  当前连接数占最大连接数的比率超过80%。当前比率: %。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Redis连接被拒绝&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: increase&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_rejected_connections_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1h&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  有连接被拒绝&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  在过去1小时内有连接被拒绝。当前被拒绝的连接数: 。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Redis内存使用率过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: redis_memory_used_bytes / redis_memory_max_bytes * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  内存使用率超过80%&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  当前内存使用率超过配置的最大内存值的80%。当前内存使用率: %。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Redis缓存命中率低&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_keyspace_hits_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_keyspace_hits_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; + irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_keyspace_misses_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;90&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 10m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  缓存命中率低于90%&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  最近5分钟内的缓存命中率低于90%。当前命中率: %。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Redis即将过期的Key数量过多&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_db_keys_expiring&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance, job, db&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_db_keys&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance, job, db&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;50&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  中的数据库  有过多即将过期的Key&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  中的数据库  有超过50%的Key即将过期。当前比率: %。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: RedisRDB备份失败&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: redis_rdb_last_bgsave_status &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  RDB备份失败&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  最近的RDB备份尝试失败。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: RedisRDB备份时间过长&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: redis_rdb_last_bgsave_duration_sec &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt; and redis_rdb_last_bgsave_status &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;       severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  RDB备份成功但耗时超过3秒&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  RDB备份成功，但备份耗时超过了3秒。持续时间: 秒。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: RedisRDB备份过期&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; - redis_rdb_last_save_timestamp_seconds&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;36000&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;94&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;95&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;96&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;97&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  超过10小时未进行RDB备份&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;98&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  已超过10小时没有生成新的RDB备份文件。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;99&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;100&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Redis命令拒绝率过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;101&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;102&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_commands_rejected_calls_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance, job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;103&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;irate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_commands_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance, job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;25&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;104&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;105&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;106&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;107&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;108&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  命令拒绝率超过25%&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;109&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  的命令拒绝率超过了25%。当前拒绝率: %。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;110&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;111&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: Redis命令平均响应时间过长&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;112&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;113&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_commands_duration_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;114&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;redis_commands_processed_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance, job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;0.250&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;115&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;116&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;117&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;118&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;119&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  命令平均响应时间超过250ms&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;120&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;Redis实例  的执⾏命令平均响应时间超过了250毫秒。当前平均响应时间: 秒。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;121&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;122&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;123&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/redis_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;124&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking /etc/prometheus/rules/redis_rules.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;125&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS: &lt;span class=&#34;token number&#34;&gt;12&lt;/span&gt; rules found&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;126&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;127&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;128&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;75-导入-grafana-模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#75-导入-grafana-模板&#34;&gt;#&lt;/a&gt; 7.5 导入 Grafana 模板&lt;/h5&gt;
&lt;p&gt;导⼊⼀个 Redis 的 Grafana 模板。Dashboard ID 为 763&lt;/p&gt;
&lt;h4 id=&#34;八-prometheus监控docker&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#八-prometheus监控docker&#34;&gt;#&lt;/a&gt; 八. Prometheus 监控 Docker&lt;/h4&gt;
&lt;p&gt;Docker 的监控，可以使⽤ Docker ⾃带的 stats 命令来获取当前主机上运⾏中的容器的资源使⽤情况。例如：容器的 CPU 使⽤率、内存占⽤、⽹络 IO 以及磁盘 IO 等指标。&lt;/p&gt;
&lt;h5 id=&#34;81-安装docker&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#81-安装docker&#34;&gt;#&lt;/a&gt; 8.1 安装 Docker&lt;/h5&gt;
&lt;p&gt;1、添加 yum 源&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum remove docker* -y &amp;amp;&amp;amp; yum install -y yum-utils&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install docker-ce -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、安装并 docker&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# sudo mkdir -p /etc/docker&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# sudo tee /etc/docker/daemon.json &amp;lt;&amp;lt;-&#39;EOF&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token string&#34;&gt;&#34;registry-mirrors&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://docker.credclouds.com&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://k8s.credclouds.com&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://quay.credclouds.com&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://gcr.credclouds.com&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://k8s-gcr.credclouds.com&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://ghcr.credclouds.com&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://do.nark.eu.org&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://docker.m.daocloud.io&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://docker.nju.edu.cn&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://docker.mirrors.sjtug.sjtu.edu.cn&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://docker.1panel.live&#34;&lt;/span&gt;,&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;	  &lt;span class=&#34;token string&#34;&gt;&#34;https://docker.rainbond.cc&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;, &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token string&#34;&gt;&#34;exec-opts&#34;&lt;/span&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;native.cgroupdriver=systemd&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;EOF&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl enable docker --now&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;4、运⾏两个容器应⽤&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# docker run -d -p3811:80 --name demoapp --memory=&#34;100m&#34; oldxu3957/demoapp:v1.0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# docker run -d -p3812:80 --name nginx --memory=&#34;50m&#34; nginx:1.16&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;82-运行cadvisor&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#82-运行cadvisor&#34;&gt;#&lt;/a&gt; 8.2 运⾏ Cadvisor&lt;/h5&gt;
&lt;p&gt;1、启动 Cadvisor 容器&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node03 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# docker run -d --name=cadvisor \&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;8082&lt;/span&gt;:8080 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-v&lt;/span&gt; /:/rootfs:ro &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-v&lt;/span&gt; /var/run:/var/run:ro &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-v&lt;/span&gt; /sys:/sys:ro &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-v&lt;/span&gt; /dev/disk/:/dev/disk:ro &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-v&lt;/span&gt; /sys/fs/cgroup:/sys/fs/cgroup:ro &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-v&lt;/span&gt; /var/lib/docker/:/var/lib/docker:ro &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;--privileged&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;uhub.service.ucloud.cn/oldxu/cadvisor:v0.47.2&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、Cadvisor 提供的 metrics 地址为 &lt;a href=&#34;http://IP:8082/metrics&#34;&gt;http://IP:8082/metrics&lt;/a&gt;&lt;/p&gt;
&lt;h5 id=&#34;83-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#83-配置prometheus&#34;&gt;#&lt;/a&gt; 8.3 配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;docker&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8082&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/jT1DDkm.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;84-docker告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#84-docker告警规则文件&#34;&gt;#&lt;/a&gt; 8.4 Docker 告警规则⽂件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、编写 Docker 告警规则⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/docker_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: Docker的告警规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 容器CPU利用率高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;container_cpu_usage_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;name&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,name&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例的容器CPU利用率高&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;容器的CPU利用率当前为%，超过了80%的阈值。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 容器内存利用率高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;container_memory_working_set_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;name&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,name&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;container_spec_memory_limit_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;name&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,name&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例的容器内存利用率高&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: 容器&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼225--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;的内存最大限制是&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼226--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;MB , 目前利用率已达&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;--swig￼227--&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;%，超过限制的80%。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 容器整体内存利用率过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;container_memory_working_set_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;name&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;machine_memory_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;所有容器的总内存利用率过高&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;当前所有容器占用物理内存的总量为%，超过了物理内存的80%阈值。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 容器网络发送速率过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;container_network_transmit_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;name&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt;by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job,name&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;8&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;50&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例的容器网络发送速率过高&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;容器的网络发送速率达到Mbps，超过了50Mbps的阈值。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 容器网络接收速率过高&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;container_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;name&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job,name&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;8&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;50&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例的容器网络接收速率过高&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;容器的网络接收速率达到Mbps，超过了50Mbps的阈值。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 容器停止时间过长&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; - container_last_seen&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;name&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,name&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例的容器已停止&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;容器已停止运行超过60秒。当前停止时长 s&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;     &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  /etc/prometheus/promtool check rules /etc/prometheus/rules/docker_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking /etc/prometheus/rules/docker_rules.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS: &lt;span class=&#34;token number&#34;&gt;6&lt;/span&gt; rules found&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;85-导入-grafana-模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#85-导入-grafana-模板&#34;&gt;#&lt;/a&gt; 8.5 导入 Grafana 模板&lt;/h5&gt;
&lt;p&gt;导⼊⼀个 Docker Container 的 Grafana 模板。Dashboard ID 为 11600&lt;/p&gt;
&lt;h4 id=&#34;九-blackbox_exporter黑盒监控&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#九-blackbox_exporter黑盒监控&#34;&gt;#&lt;/a&gt; 九. Blackbox_exporter ⿊盒监控&lt;/h4&gt;
&lt;p&gt;Blackbox_exporter 是⼀个专⻔⽤于⿊盒监控的⼯具，它⽀持多种⽹络协议对⽬标对象进⾏检测，⽐如 HTTP、HTTPS、TCP 和 ICMP。这意味着我们可以⽤它来监控⽹站响应状态和响应时间、以及通过端⼝来判断服务是否正常运⾏。此外⽤户还可以通过设置不同的检查模块来定制 blackbox_exporter，以便它能够适应不同的检测需求。&lt;/p&gt;
&lt;h5 id=&#34;91-安装blackbox_exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#91-安装blackbox_exporter&#34;&gt;#&lt;/a&gt; 9.1 安装 Blackbox_exporter&lt;/h5&gt;
&lt;p&gt;1、访问 blackbox_exporter 的 github 地址， &lt;a href=&#34;https://github.com/prometheus/blackbox_exporter/releases&#34;&gt;https://github.com/prometheus/blackbox_exporter/releases&lt;/a&gt; ，下载 blackbox_exporter&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 下载 blackbox_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.24.0/blackbox_exporter-0.24.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#加速地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/prometheus/blackbox_exporter/releases/download/v0.24.0/blackbox_exporter-0.24.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2、解压 blackbox_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf blackbox_exporter-0.24.0.linux-amd64.tar.gz -C /etc&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/blackbox_exporter-0.24.0.linux-amd64/ /etc/blackbox_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、编辑 /etc/blackbox_exporter/blackbox.yml 默认配置⽂件，可以⾃⾏定义对应的模块，blackbox_exporter/example.yml&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/blackbox_exporter/blackbox.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;modules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# http 检查模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  http_2xx:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    prober: http&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    http:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      preferred_ip_protocol: &lt;span class=&#34;token string&#34;&gt;&#34;ip4&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      valid_http_versions: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;HTTP/1.1&#34;&lt;/span&gt;, &lt;span class=&#34;token string&#34;&gt;&#34;HTTP/2.0&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# Http Post 检查模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  http_post_2xx:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    prober: http&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    http:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      method: POST&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      preferred_ip_protocol: &lt;span class=&#34;token string&#34;&gt;&#34;ip4&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      valid_http_versions: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;HTTP/1.1&#34;&lt;/span&gt;, &lt;span class=&#34;token string&#34;&gt;&#34;HTTP/2.0&#34;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# TCP 检查模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  tcp_connect:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    prober: tcp&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    timeout: 5s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# ICMP 检查模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  icmp:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    prober: icmp&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    timeout: 5s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    icmp:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      preferred_ip_protocol: &lt;span class=&#34;token string&#34;&gt;&#34;ip4&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# DNS 检查模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  dns_tcp: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    prober: dns&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    dns:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      transport_protocol: &lt;span class=&#34;token string&#34;&gt;&#34;tcp&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      preferred_ip_protocol: &lt;span class=&#34;token string&#34;&gt;&#34;ip4&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      query_name: &lt;span class=&#34;token string&#34;&gt;&#34;www.oldxu.net&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# SSH 检查模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ssh_banner:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    prober: tcp&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    tcp:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      query_response:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - expect: &lt;span class=&#34;token string&#34;&gt;&#34;^SSH-2.0-&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      - send: &lt;span class=&#34;token string&#34;&gt;&#34;SSH-2.0-blackbox-ssh-check&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、配置 blackbox_exporter 启动⽂件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/blackbox_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;blackbox_exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/blackbox_exporter/blackbox_exporter &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--config.file&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/blackbox_exporter/blackbox.yml &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --web.listen-address&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$MAINPID&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;4、启动 blackbox_exporter&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start blackbox_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl enable blackbox_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 9115&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::9115                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;1879&lt;/span&gt;/blackbox_expor&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;5、访问 Blackbox_exporter&lt;/p&gt;
&lt;p&gt;1、访问 Blackbox_exporter，通过 &lt;a href=&#34;http://IP:9115&#34;&gt;http://IP:9115&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;2、使⽤ blackbox_exporter 监控站点，需要传递⽬标 target ，以及检测⽅法 module&lt;/p&gt;
&lt;p&gt;具体的 Url 地址：&lt;a href=&#34;http://192.168.40.224:9115/probe?target=https://www.baidu.com&amp;amp;module=http_2xx&amp;amp;debug=true&#34;&gt;http://192.168.40.224:9115/probe?target=https://www.baidu.com&amp;amp;module=http_2xx&amp;amp;debug=true&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;3、针对 blackbox_exporter 的探测过程进⾏解读&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Logs &lt;span class=&#34;token keyword&#34;&gt;for&lt;/span&gt; the probe:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T13:00:22.422589861Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;main.go:181 &lt;span class=&#34;token assign-left variable&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http_2xx &lt;span class=&#34;token assign-left variable&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://www.baidu.com &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Beginning probe&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;probe&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http &lt;span class=&#34;token assign-left variable&#34;&gt;timeout_seconds&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;119.5&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T13:00:22.422705868Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http.go:328 &lt;span class=&#34;token assign-left variable&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http_2xx &lt;span class=&#34;token assign-left variable&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://www.baidu.com &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Resolving target address&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;www.baidu.com &lt;span class=&#34;token assign-left variable&#34;&gt;ip_protocol&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;ip4&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T13:00:22.45404596Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http.go:328 &lt;span class=&#34;token assign-left variable&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http_2xx &lt;span class=&#34;token assign-left variable&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://www.baidu.com &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Resolved target address&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;www.baidu.com &lt;span class=&#34;token assign-left variable&#34;&gt;ip&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;183.2&lt;/span&gt;.172.17&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T13:00:22.454537363Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;client.go:252 &lt;span class=&#34;token assign-left variable&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http_2xx &lt;span class=&#34;token assign-left variable&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://www.baidu.com &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Making HTTP request&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;url&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://183.2.172.17 &lt;span class=&#34;token assign-left variable&#34;&gt;host&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;www.baidu.com&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T13:00:22.604504723Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;handler.go:120 &lt;span class=&#34;token assign-left variable&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http_2xx &lt;span class=&#34;token assign-left variable&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://www.baidu.com &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Received HTTP response&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;status_code&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;200&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T13:00:22.658174121Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;handler.go:120 &lt;span class=&#34;token assign-left variable&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http_2xx &lt;span class=&#34;token assign-left variable&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://www.baidu.com &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Response timings for roundtrip&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;roundtrip&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;start&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T21:00:22.454597016+08:00 &lt;span class=&#34;token assign-left variable&#34;&gt;dnsDone&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T21:00:22.454597016+08:00 &lt;span class=&#34;token assign-left variable&#34;&gt;connectDone&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T21:00:22.47947711+08:00 &lt;span class=&#34;token assign-left variable&#34;&gt;gotConn&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T21:00:22.587945635+08:00 &lt;span class=&#34;token assign-left variable&#34;&gt;responseStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T21:00:22.604420439+08:00 &lt;span class=&#34;token assign-left variable&#34;&gt;tlsStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T21:00:22.479503968+08:00 &lt;span class=&#34;token assign-left variable&#34;&gt;tlsDone&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T21:00:22.58792749+08:00 &lt;span class=&#34;token assign-left variable&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T21:00:22.658024376+08:00&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2025&lt;/span&gt;-07-10T13:00:22.658287803Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;main.go:181 &lt;span class=&#34;token assign-left variable&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;http_2xx &lt;span class=&#34;token assign-left variable&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://www.baidu.com &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Probe succeeded&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;duration_seconds&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;0.23567288&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 1、开始探测（msg=&#34;Beginning probe&#34;） 使⽤的是 http_2xx 模块，超时设置为 119.5 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 2、解析⽬标地址（msg=&#34;Resolving target address&#34;） 正在尝试解析⽬标 www..com 的 IP 地址，使⽤的是 IPv4 协议。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 3、已解析⽬标地址（msg=&#34;Resolved target address&#34;） 成功解析为 183.2.172.17。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 4、发出 HTTP 请求（msg=&#34;Making HTTP request&#34;） 向 http://183.2.172.17 发出 HTTP 请求，请求中的 host 头设置为 www.baidu.com。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 5、收到 HTTP 响应（msg=&#34;Received HTTP response&#34;） 已收到状态码为 200 的 HTTP 响应，这意味着⽹⻚正常，服务器成功处理了请求。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 6、响应时间（msg=&#34;Response timings for roundtrip&#34;） 提供了对于整个请求 - 响应周期中每个步骤的具体时间点，包括 DNS 解析完成、TLS 握⼿开始和完成、连接建⽴、获得连接、响应开始等时间点。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 7、探测成功（msg=&#34;Probe succeeded&#34;） 探测操作成功完成，总耗时为 0.23567288 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;92-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#92-配置prometheus&#34;&gt;#&lt;/a&gt; 9.2 配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;tomcat&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8080&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;jmx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:12345&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;mysqld_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: master&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: slave&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;redis_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9121&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_http&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe &lt;span class=&#34;token comment&#34;&gt;# metrics 的 path 这次不是 /metrics，⽽是 /probe&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params: &lt;span class=&#34;token comment&#34;&gt;# 传递参数&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;http_2xx&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 调⽤哪个模块进⾏探测&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://www.xuliangwei.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://www.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://www.baidu.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://httpbin.org/status/400&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/500&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/502&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# relabel_configs 是标签重写的配置，这⾥进⾏了三次操作：&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 1、将⽬标地址（__address__）赋予给__param_target，这是 Blackbox Exporter 需要的⽬标 target 参数。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 2、将__param_target 的内容复制到 instance 标签，这样 Prometheus UI 中显示的 instance 实例名称会是⽬标站点地址，⽽不是 Blackbox 的地址。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 3、最后，将实际发送探测请求的地址（__address__）设置为运⾏ Blackbox Exporter 的节点地址和端⼝（prom-node04.oldxu.net:9115），这样 Prometheus 就会向这个地址发送探测请求。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;93-配置tcp-ssh-icmp监控&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#93-配置tcp-ssh-icmp监控&#34;&gt;#&lt;/a&gt; 9.3 配置 tcp、ssh、icmp 监控&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、修改 Prometheus 配置&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;tomcat&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8080&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;jmx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:12345&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;mysqld_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: master&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: slave&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;redis_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9121&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_http&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe &lt;span class=&#34;token comment&#34;&gt;# metrics 的 path 这次不是 /metrics，是 /probe&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params: &lt;span class=&#34;token comment&#34;&gt;# 传递参数&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;http_2xx&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 调哪个模块进探测&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://www.xuliangwei.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://www.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://www.baidu.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://httpbin.org/status/400&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/500&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/502&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_tcp&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;tcp_connect&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使 tcp_connect 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:3306&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:6379&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;94&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;95&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;96&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;97&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;98&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;99&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;100&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;101&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;102&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_icmp&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;103&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;104&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;105&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;icmp&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使 icmp 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;106&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;107&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;108&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;109&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;110&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;111&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;112&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;113&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;114&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;115&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;116&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_ssh&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;117&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;118&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;119&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;ssh_banner&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使⽤ ssh_banner 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;120&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;121&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:22&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:22&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:22&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;122&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;123&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;124&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;125&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;126&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;127&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;128&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;129&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;130&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;131&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;94-blackbox告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#94-blackbox告警规则文件&#34;&gt;#&lt;/a&gt; 9.4 Blackbox 告警规则⽂件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/blackbox_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: Blackbox告警规则文件&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 探测失败&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;probe_success &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance, job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  探测失败&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;探测目标  在 job  中失败。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 站点整体平均请求时间过长&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;avg_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;probe_http_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  请求时间过长&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  最近1分钟的平均请求时间超过3秒。当前平均请求时间：秒。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 重定向次数过多&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: probe_http_redirects &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  重定向次数过多&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  在最近的探测中重定向次数超过5次。当前次数：次。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 站点阶段耗时过⻓&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        probe_http_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;phase&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;connect&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.5&lt;/span&gt; or&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        probe_http_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;phase&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;processing&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.5&lt;/span&gt; or&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        probe_http_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;phase&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;resolve&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.5&lt;/span&gt; or&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        probe_http_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;phase&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tls&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.5&lt;/span&gt; or&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        probe_http_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;phase&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;transfer&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.5&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  阶段 &#39;&#39; 耗时过长&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  在阶段 &#39;&#39; 的耗时超过0.5秒。当前耗时：秒。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 站点响应状态码异常&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: probe_http_status_code &lt;span class=&#34;token operator&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;199&lt;/span&gt; or probe_http_status_code &lt;span class=&#34;token operator&#34;&gt;&gt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;400&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  返回异常状态码&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  返回的状态码为 ，表明请求可能存在问题。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 证书即将过期&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;probe_ssl_earliest_cert_expiry - time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; /86400 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 24h&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  的 SSL 证书即将过期&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  的 SSL 证书将在  天内过期。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 证书即将过期&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;7&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;probe_ssl_earliest_cert_expiry - time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; /86400 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;7&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 24h&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;实例  的 SSL 证书即将过期&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;实例  的 SSL 证书将在  天内过期.&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/blackbox_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking /etc/prometheus/rules/blackbox_rules.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS: &lt;span class=&#34;token number&#34;&gt;7&lt;/span&gt; rules found&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;95-导入blackbox图形&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#95-导入blackbox图形&#34;&gt;#&lt;/a&gt; 9.5 导⼊ Blackbox 图形&lt;/h5&gt;
&lt;p&gt;1、专⽤于针对 HTTP 的图形，导⼊ ID13659 ；&lt;/p&gt;
&lt;p&gt;2、也可以使⽤ ID 为 7587 的图形；&lt;/p&gt;
&lt;p&gt;3、以及 ID 为 9965 的图形；&lt;/p&gt;
&lt;h4 id=&#34;十-domain_exporter域名监控&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#十-domain_exporter域名监控&#34;&gt;#&lt;/a&gt; 十. domain_exporter 域名监控&lt;/h4&gt;
&lt;p&gt;domain_exporter 主要⽤来监控⽹站域名的过期时间。这对于企业和个⼈都是⽐较重要的，因为域名过期可能会导致⽹站⽆法访问，进⽽影响业务的正常运⾏。因此监控 “域名的过期时间” 就显得⽐较重要了。&lt;/p&gt;
&lt;p&gt;domain_exporter 的⼯作逻辑有如下⼏步：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、收集域名信息：通过 WHOIS 协议收集 “target 参数定义的域名” 信息。&lt;/li&gt;
&lt;li&gt;2、解析域名信息：从收集到的数据中解析出域名的过期时间。&lt;/li&gt;
&lt;li&gt;3、导出指标：将解析出的域名过期时间等信息格式化为 Prometheus 兼容的格式，⽽后通过 /probe 接⼝输出指标。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;101-安装domain_exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#101-安装domain_exporter&#34;&gt;#&lt;/a&gt; 10.1 安装 domain_exporter&lt;/h5&gt;
&lt;p&gt;1、访问 domain_exporter 的 github 地址， &lt;a href=&#34;https://github.com/caarlos0/domain_exporter/releases&#34;&gt;https://github.com/caarlos0/domain_exporter/releases&lt;/a&gt; ，下载 domain_exporter&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 下载 domain_exporte&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://github.com/caarlos0/domain_exporter/releases/download/v1.23.0/domain_exporter_1.23.0_linux_amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 加速地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/caarlos0/domain_exporter/releases/download/v1.23.0/domain_exporter_1.23.0_linux_amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 解压 domain_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mkdir /etc/domain_exporter_1.23.0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf domain_exporter_1.23.0_linux_amd64.tar.gz -C /etc/domain_exporter_1.23.0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/domain_exporter_1.23.0/ /etc/domain_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4. 配置 domain_exporter 启动⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 domain_exporter&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/domain_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;domain_exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/domain_exporter/domain_exporter &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$MAINPID&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#5. 动 domain_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start domain_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl enable domain_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Created symlink from /etc/systemd/system/multi-user.target.wants/domain_exporter.service to /usr/lib/systemd/system/domain_exporter.service.&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 9222&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::9222                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;1880&lt;/span&gt;/domain_exporte&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、通过 domain_exporter 获取域名过期时间，访问 URL &lt;a href=&#34;http://localhost:9222/probe?target=oldxu.net&#34;&gt;http://localhost:9222/probe?target=oldxu.net&lt;/a&gt; 来获取特定域名（如 &lt;a href=&#34;http://oldxu.net&#34;&gt;oldxu.net&lt;/a&gt;）的过期时间。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  curl http://localhost:9222/probe?target=hmallleasing.com&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP domain_expiry_days time in days until the domain expires&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE domain_expiry_days gauge&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;domain_expiry_days&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;domain&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;hmallleasing.com&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;741&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP domain_probe_duration_seconds returns how long the probe took to complete in seconds&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE domain_probe_duration_seconds gauge&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;domain_probe_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;domain&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;hmallleasing.com&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1.036303946&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP domain_probe_success whether the probe was successful or not&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE domain_probe_success gauge&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;domain_probe_success&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;domain&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;hmallleasing.com&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;102-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#102-配置prometheus&#34;&gt;#&lt;/a&gt; 10.2 配置 Prometheus&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;tomcat&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8080&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;jmx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:12345&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;mysqld_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: master&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: slave&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;redis_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9121&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_http&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe &lt;span class=&#34;token comment&#34;&gt;# metrics 的 path 这次不是 /metrics，是 /probe&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params: &lt;span class=&#34;token comment&#34;&gt;# 传递参数&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;http_2xx&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 调哪个模块进探测&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://www.xuliangwei.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://www.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://www.baidu.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://httpbin.org/status/400&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/500&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/502&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_tcp&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;tcp_connect&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使 tcp_connect 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:3306&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:6379&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;94&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;95&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;96&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;97&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;98&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;99&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;100&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;101&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_icmp&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;102&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;103&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;104&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;icmp&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使 icmp 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;105&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;106&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;107&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;108&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;109&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;110&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;111&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;112&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;113&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;114&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;115&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_ssh&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;116&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;117&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;118&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;ssh_banner&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使⽤ ssh_banner 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;119&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;120&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:22&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:22&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:22&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;121&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;122&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;123&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;124&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;125&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;126&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;127&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;128&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;129&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;domain_exporter&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;130&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe &lt;span class=&#34;token comment&#34;&gt;# metrics 的 path 不是 /metrics，⽽是 /probe&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;131&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;132&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;nf-leasing.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;ixuyong.cn&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;hmallleasing.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;jd.com&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;133&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;134&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;135&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;136&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;137&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;138&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;139&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9222&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;140&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;141&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;142&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;103-domain告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#103-domain告警规则文件&#34;&gt;#&lt;/a&gt; 10.3 domain 告警规则⽂件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/domain_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: domain告警规则文件&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 域名即将过期 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: domain_expiry_days &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;域名即将过期 (实例 )&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;域名  还有少于100天即将过期。当前剩余天数：。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;          &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 域名即将过期&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: domain_expiry_days &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;域名即将过期 (实例 )&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;域名  还有少于30天即将过期。当前剩余天数：。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 域名检测失败&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;domain_probe_success&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;domain, instance, job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 5m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;域名检测失败 (实例 )&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;域名  在  上的检测失败。当前值：。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/domain_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking /etc/prometheus/rules/domain_rules.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS: &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt; rules found&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;104-导入domain_exporter图形&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#104-导入domain_exporter图形&#34;&gt;#&lt;/a&gt; 10.4 导⼊ domain_exporter 图形&lt;/h5&gt;
&lt;p&gt;查看域名的状态，以及连通性和过期时间，导⼊ ID 13924&lt;/p&gt;
&lt;h4 id=&#34;十一-pushgateway推送网关服务&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#十一-pushgateway推送网关服务&#34;&gt;#&lt;/a&gt; 十一. PushGateway 推送⽹关服务&lt;/h4&gt;
&lt;p&gt;Pushgateway 允许脚本通过 Push 的⽅式来推送指标数据，但它不会像 Prometheus 那样主动去抓取指标数据。&lt;/p&gt;
&lt;p&gt;Pushgateway 作为中间存储，仅负责接收数据，等待 Prometheus Server 进⾏数据抓取，它⾃身并不具备抓取功能。默认情况下，数据保存在内存中，但可以通过 --persistence.file 参数持久化数据⾄⽂件中，同时通过 --persistence.interval=5m 设置数据持久化间隔。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/WUzZt2R.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;使⽤ Pushgateway 时需要注意以下⼏点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、若使⽤单个 Pushgateway 接收多个不同实例、或者是脚本推送的数据，它会成为单点。&lt;/li&gt;
&lt;li&gt;2、Pushgateway 不会⾃动删除已推送的数据，⼀旦数据推送到 Pushgateway， Prometheus 会持续从中抓取数据。&lt;/li&gt;
&lt;li&gt;3、删除 Pushgateway 中的数据不会影响 Prometheus 已经抓取的历史数据，但之后 Prometheus 将不会有新的数据更新，直到有新的数据被推送到 Pushgateway。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;111-安装pushgateway&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#111-安装pushgateway&#34;&gt;#&lt;/a&gt; 11.1 安装 pushGateway&lt;/h5&gt;
&lt;p&gt;1、访问 PushGateway 官⽹ &lt;a href=&#34;https://github.com/prometheus/pushgateway&#34;&gt;https://github.com/prometheus/pushgateway&lt;/a&gt; ，下载 PushGateway&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 下载 Pushgateway &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://github.com/prometheus/pushgateway/releases/download/v1.7.0/pushgateway-1.7.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 加速地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/prometheus/pushgateway/releases/download/v1.7.0/pushgateway-1.7.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 解压 PushGateway&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf pushgateway-1.7.0.linux-amd64.tar.gz -C /etc/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/pushgateway-1.7.0.linux-amd64/ /etc/pushgateway&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 编写 pushgateway 启动⽂件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/pushgateway.service &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;pushgateway&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/pushgateway/pushgateway &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; --web.listen-address&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;:9091 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; --web.telemetry-path&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/metrics &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; --web.enable-lifecycle&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4. 启动 PushGateway&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start pushgateway&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl enable pushgateway&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 9091&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::9091                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;2421&lt;/span&gt;/pushgateway&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、是⽤ Curl 给 pushgateway 推送⼀个 some_metric 的指标，值为 3.14&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# echo &#34;some_metric 3.14&#34; | curl --data-binary @- http://localhost:9091/metrics/job/some_job&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、访问 pushgateway 的 web ⻚⾯，通过 &lt;a href=&#34;http://IP:9091&#34;&gt;http://IP:9091&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/RwuXAZe.png&#34; alt=&#34;2.png&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;112-配置promethues&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#112-配置promethues&#34;&gt;#&lt;/a&gt; 11.2 配置 Promethues&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rule_files:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - &lt;span class=&#34;token string&#34;&gt;&#34;/etc/prometheus/rules/*.yml&#34;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;rabbitmq&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:15692&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;nginx&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9113&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;46&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;tomcat&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;47&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;48&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;49&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:8080&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;50&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;51&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;jmx_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;52&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;53&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;54&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:12345&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;55&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;56&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;mysqld_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;57&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;58&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;59&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;60&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;61&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;62&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: master&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;63&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net:9104&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;64&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;65&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        service: database&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;66&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;        role: slave&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;67&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;68&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;redis_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;69&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;70&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;71&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9121&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;72&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;73&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_http&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;74&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe &lt;span class=&#34;token comment&#34;&gt;# metrics 的 path 这次不是 /metrics，是 /probe&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;75&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params: &lt;span class=&#34;token comment&#34;&gt;# 传递参数&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;76&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;http_2xx&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 调哪个模块进探测&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;77&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;78&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://www.xuliangwei.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://www.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://www.baidu.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;http://httpbin.org/status/400&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/500&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/502&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;79&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;80&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;81&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;82&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;83&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;84&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;85&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;86&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;87&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_tcp&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;88&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;89&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;90&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;tcp_connect&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使 tcp_connect 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;91&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;92&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:3306&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:6379&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;93&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;94&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;95&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;96&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;97&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;98&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;99&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;100&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;101&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_icmp&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;102&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;103&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;104&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;icmp&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使 icmp 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;105&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;106&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;107&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;108&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;109&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;110&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;111&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;112&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;113&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;114&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;115&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;blackbox_ssh&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;116&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;117&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    params:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;118&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      module: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;ssh_banner&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使⽤ ssh_banner 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;119&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;120&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:22&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:22&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:22&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;121&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;122&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;123&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;124&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;125&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;126&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;127&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9115&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;128&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;129&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#39;domain_exporter&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;130&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: /probe &lt;span class=&#34;token comment&#34;&gt;# metrics 的 path 不是 /metrics，⽽是 /probe&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;131&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;132&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;nf-leasing.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;hmallleasing.com&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;jd.com&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;133&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    relabel_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;134&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__address__&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;135&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: __param_target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;136&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - source_labels: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;__param_target&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;137&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      target_label: instance&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;138&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - target_label: __address__&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;139&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      replacement: prom-node04.oldxu.net:9222&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;140&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;141&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;pushgateway&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;142&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;143&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;144&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net:9091&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;145&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;146&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;147&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;113-编写脚本并推送指标&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#113-编写脚本并推送指标&#34;&gt;#&lt;/a&gt; 11.3 编写脚本并推送指标&lt;/h5&gt;
&lt;p&gt;假设我们有⼀个备份脚本，它每天执⾏⼀次并且很快就完成了。但是我们需要知道它是否每次都成功执⾏了，以及每次执⾏花了多少时间。为了捕获这些信息，我们可以在脚本执⾏完成之后，将其成功状态和执⾏时间推送到 PushGateway。之后 Prometheus 就会定期从 PushGateway 中拉取这些数据，以此来监控这个脚本的状态。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat pushgateway_backup.sh&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#!/bin/bash&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$#&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-ne&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;token builtin class-name&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;给定一个备份的应用名称&#34;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;token builtin class-name&#34;&gt;exit&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# PushGateway 地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;PUSH_ADDR&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node04.oldxu.net&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 应用名称&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;APP_NAME&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;&lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 备份脚本示例&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;START_TIME&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;&lt;span class=&#34;token variable&#34;&gt;$(&lt;/span&gt;&lt;span class=&#34;token function&#34;&gt;date&lt;/span&gt; +%s&lt;span class=&#34;token variable&#34;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟备份任务，随机睡眠时间 1-10 秒&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;SLEEP_TIME&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;&lt;span class=&#34;token variable&#34;&gt;$((&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;+&lt;/span&gt; RANDOM &lt;span class=&#34;token operator&#34;&gt;%&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;))&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;sleep&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$SLEEP_TIME&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 随机决定备份操作是否成功&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;&lt;span class=&#34;token variable&#34;&gt;$((&lt;/span&gt;RANDOM &lt;span class=&#34;token operator&#34;&gt;%&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;))&lt;/span&gt;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-lt&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;then&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token assign-left variable&#34;&gt;STATUS&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 成功&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;else&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token assign-left variable&#34;&gt;STATUS&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 失败&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;fi&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;END_TIME&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;&lt;span class=&#34;token variable&#34;&gt;$(&lt;/span&gt;&lt;span class=&#34;token function&#34;&gt;date&lt;/span&gt; +%s&lt;span class=&#34;token variable&#34;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;DURATION&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;&lt;span class=&#34;token variable&#34;&gt;$((&lt;/span&gt;END_TIME &lt;span class=&#34;token operator&#34;&gt;-&lt;/span&gt; START_TIME&lt;span class=&#34;token variable&#34;&gt;))&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 推送指标至 PushGateway&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;cat&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;EOF&lt;span class=&#34;token bash punctuation&#34;&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;curl&lt;/span&gt; --data-binary @- http://&lt;span class=&#34;token variable&#34;&gt;$PUSH_ADDR&lt;/span&gt;:9091/metrics/job/backup/instance/&lt;span class=&#34;token variable&#34;&gt;$APP_NAME&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;# HELP backup_duration_seconds The duration of the last backup in seconds.&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;# TYPE backup_duration_seconds gauge&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;backup_duration_seconds&amp;#123;application=&#34;&lt;span class=&#34;token variable&#34;&gt;$APP_NAME&lt;/span&gt;&#34;&amp;#125; &lt;span class=&#34;token variable&#34;&gt;$DURATION&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;# HELP backup_success Last backup was success(1) or ERROR(0).&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;# TYPE backup_success gauge&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;backup_success&amp;#123;application=&#34;&lt;span class=&#34;token variable&#34;&gt;$APP_NAME&lt;/span&gt;&#34;&amp;#125; &lt;span class=&#34;token variable&#34;&gt;$STATUS&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;EOF&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;1、执⾏脚本，需要传递⼀个应⽤的名称&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# sh pushgateway_backup.sh shop&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、在 Prometheus UI 中检查 backup_duration_seconds 和 backup_success 指标&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/wKv8ybJ.png&#34; alt=&#34;1.png&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;114-配置告警规则文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#114-配置告警规则文件&#34;&gt;#&lt;/a&gt; 11.4 配置告警规则⽂件&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/rules/backup_rules.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: backup_alerts&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# 警告：在备份成功情况在，如果备份任务耗时超过了 9 秒则触发告警&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 备份告警超时&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: backup_duration_seconds &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;6&lt;/span&gt; and backup_success &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: warning&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;备份任务耗时过长&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34; 应⽤备份任务成功完成，但耗时超过了6秒。实际耗时:  秒。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token comment&#34;&gt;# 严重警告：备份任务失败，并且不考虑耗时&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 备份任务失败&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: backup_success &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;备份失败&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34; 任务中  应用备份失败。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 检查告警规则语法&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check rules /etc/prometheus/rules/backup_rules.yml &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking /etc/prometheus/rules/backup_rules.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  SUCCESS: &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; rules found&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 重载 Prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;115-清理pushgateway&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#115-清理pushgateway&#34;&gt;#&lt;/a&gt; 11.5 清理 pushGateway&lt;/h5&gt;
&lt;p&gt;清理 PushGateway 中的数据，有两种⽅式，⼀种⼿动清理、⼀种⾃动清理&lt;/p&gt;
&lt;p&gt;1、⼿动清理：访问 PushGateway 的 web 界⾯，找到你要清理的指标，然后点击 “Delete Group” 进⾏删除。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/vu55T71.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;2、⾃动清理：设置⼀个定时任务（如 cron job），定期通过 API 调⽤删除过时的指标。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat clear_pushgateway_job.sh&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#!/bin/bash&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$#&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-ne&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;token builtin class-name&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;给定要清理的 [Job_name名称]和 [instance名称]&#34;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;token builtin class-name&#34;&gt;exit&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;JOB_NAME&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;$1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;INSTANCE_NAME&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;$2&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 清理特定 job 名称的指标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;curl&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-X&lt;/span&gt; DELETE http://prom-node04.oldxu.net:9091/metrics/job/&lt;span class=&#34;token variable&#34;&gt;$&amp;#123;JOB_NAME&amp;#125;&lt;/span&gt;/instance/&lt;span class=&#34;token variable&#34;&gt;$&amp;#123;INSTANCE_NAME&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 设定 crontab&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node04 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# crontab -e&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;59&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;23&lt;/span&gt; * * * /bin/bash /root/clear_pushgateway_job.sh backup shop&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
        <category term="Prometheus" />
        <updated>2025-06-28T14:17:01.000Z</updated>
    </entry>
    <entry>
        <id>http://ixuyong.cn/posts/3386060324.html</id>
        <title>PromQL快速入门（二）</title>
        <link rel="alternate" href="http://ixuyong.cn/posts/3386060324.html"/>
        <content type="html">&lt;h3 id=&#34;promql快速入门二&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#promql快速入门二&#34;&gt;#&lt;/a&gt; PromQL 快速入门（二）&lt;/h3&gt;
&lt;h4 id=&#34;一-promql基础概念&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#一-promql基础概念&#34;&gt;#&lt;/a&gt; 一. PromQL 基础概念&lt;/h4&gt;
&lt;h5 id=&#34;11-什么是promeql&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#11-什么是promeql&#34;&gt;#&lt;/a&gt; 1.1 什么是 PromeQL&lt;/h5&gt;
&lt;p&gt;Prometheus 内置了⼀种强⼤的查询语⾔：PromQL，即 PrometheusQuery Language。PromQL 允许⽤户实时查询监控数据，并对这些数据执⾏复杂的聚合和计算操作。&lt;/p&gt;
&lt;p&gt;在 PromQL 中，查询的结果被称为 “向量（vector）”，分为两种类型：&lt;/p&gt;
&lt;p&gt;1、即时向量（Instant vector）：即时向量查询返回的是⼀组时间序列数据，但每个时间序列中只包含单个的最新数据点。例如：查询当前时刻服务器 1 分钟的负载，所得到的结果就是⼀个即时向量。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/M18NeIk.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;2、范围向量（Range vector）：范围向量查询的结果包含了⼀个时间范围内的所有数据点。例如：查询过去 1 分钟内服务器负载的变化情况，返回的数据集就是⼀个范围向量。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/VlsLPMD.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;在 PromQL 中，除了有向量类型的数据，还有其他的数据类型，具体有：&lt;/p&gt;
&lt;p&gt;标量（Scalar）：标量仅代表⼀个单⼀的浮点数值。可以将向量的某⼀个值通过 scalar () 函数转为标量，然后进⾏数值运算，但使⽤较少。&lt;/p&gt;
&lt;p&gt;字符串（String）：在 PromQL 查询结果中，每个时间序列都伴随着⼀组标签，这些标签和标签值，就是使⽤字符串类型来定义。这些标签为时间序列提供了元数据信息，例如 {job=&amp;quot;nginx&amp;quot;,instance=&amp;quot;&lt;a href=&#34;http://prom-node01.oldxu.net&#34;&gt;prom-node01.oldxu.net&lt;/a&gt;&amp;quot;, method=&amp;quot;get&amp;quot;, url=&amp;quot;/api&amp;quot;} ，通过标签能很好的对数据进⾏分类和识别。&lt;/p&gt;
&lt;h5 id=&#34;12-promql应用场景&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#12-promql应用场景&#34;&gt;#&lt;/a&gt; 1.2 PromQL 应⽤场景&lt;/h5&gt;
&lt;p&gt;Prometheus 的核⼼就是 PromQL，PromQL 在⽇常的数据可视化，查询、定义告警规则都会是⽤到，因此掌握 PromQL 基本上就掌握了 Prometheus；&lt;/p&gt;
&lt;p&gt;1、临时查询：使⽤ PromQL，你可以实时地查询监控数据，这对于调试和诊断问题⾮常有帮助。通常，我们通过 Prometheus ⾃带的表达式浏览器来执⾏这些查询。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/AJVZFdO.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;2、数据可视化，PromQL 可以帮助我们创建数据的可视化展示，这些可视化通常是通过集成⼯具如 Grafana 来实现的，可以将我们 PromQL 查询的结果展示得更直观。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/oqN9oVU.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3、监控告警：Prometheus 可以直接使⽤ PromQL 对指标的查询结果来设置告警。⼀旦查询结果满⾜指定的条件，就会触发告警，⼀个完整的报警规则如下所示：&lt;/p&gt;
&lt;p&gt;⼀个告警规则包括了告警的名称、条件、持续时间等信息。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;groups:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;- name: 告警组&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - alert: 节点宕机   &lt;span class=&#34;token comment&#34;&gt;# 告警名称&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    expr: up &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;   &lt;span class=&#34;token comment&#34;&gt;# 告警条件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    for: 1m         &lt;span class=&#34;token comment&#34;&gt;# 持续时间&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    labels:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      severity: critical&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    annotations: &lt;span class=&#34;token comment&#34;&gt;# 定义邮件中收到的告警详细内容&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      summary: &lt;span class=&#34;token string&#34;&gt;&#34;节点宕机警告 - 实例：&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;      description: &lt;span class=&#34;token string&#34;&gt;&#34;作业  的节点⽆法访问，已经持续超过1分钟。&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;二-promql基础使用&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#二-promql基础使用&#34;&gt;#&lt;/a&gt; 二. PromQL 基础使⽤&lt;/h4&gt;
&lt;h5 id=&#34;21-指标查询&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#21-指标查询&#34;&gt;#&lt;/a&gt; 2.1 指标查询&lt;/h5&gt;
&lt;p&gt;1、查询指标的最直接⽅式是输⼊ “指标的名称”。⽐如，你想知道系统的⼀分钟负载（node_load1）情况：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 查询表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 查询结果（结果展示了所有被监控节点的⼀分钟负载。）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.02&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.13&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、但是，在实际监控时，我们通常只需要关注 “特定节点” 的指标数据。例如，如果我只想查看 &lt;a href=&#34;http://prom-node01.oldxu.net&#34;&gt;prom-node01.oldxu.net&lt;/a&gt; 这个节点的⼀分钟负载情况，那么就可需要是⽤ “标签匹配器” 来筛选出所需的指标。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 查询表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 查询结果（由于指定了过滤条件，因此只会展示 node01 节点的 1 分钟负载）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.35&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、因此，标签匹配器就是通过标签和标签值，来筛选出我们所需要的指标数据。使⽤标签匹配器时，可以按照以下语法构造查询表达式：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;metric_name&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;label_name&lt;span class=&#34;token operator&#34;&gt;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;label_value&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;, &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;label_name&lt;span class=&#34;token operator&#34;&gt;&lt;span class=&#34;token file-descriptor important&#34;&gt;2&lt;/span&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=~&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;regex&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;, &lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;.&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;其中各个部分的含义如下：&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# = 表示⼀个标签必须严格等于⼀个给定的值。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# != 表示排除等于特定值的标签。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# =~ 表示标签的值必须匹配⼀个正则表达式。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# !~ 表示标签的值不应匹配⼀个正则表达式。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 1：查询所有实例，CPU 的第 0 个核⼼，中的 user ⽤户空间所占⽤ CPU 的时间，指标名称：node_cpu_seconds_total&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;cpu&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;,mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;user&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 2：查询所有实例，eth0 ⽹卡发送总⼤⼩，指标名称：node_network_transmit_bytes_total&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_network_transmit_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 转为 GB&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_network_transmit_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; /1024 /1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 3：查询所有实例的⽹卡接收字节数，排除 lo 接⼝，指标名称：node_network_receive_bytes_total&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;lo&#34;&lt;/span&gt;,device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;docker0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;~&lt;span class=&#34;token string&#34;&gt;&#34;lo|docker0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 转为 GB&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;lo&#34;&lt;/span&gt;,device&lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;docker0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; /1024 /102&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;4&lt;/span&gt; /1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 4：查询：挂载点以 /run 开头的⽂件系统可⽤字节数，指标名称 node_filesystem_avail_bytes&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mountpoint&lt;span class=&#34;token operator&#34;&gt;=~&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;^/run.*&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 字节转 MB&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mountpoint&lt;span class=&#34;token operator&#34;&gt;=~&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;^/run.*&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; /1024/1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 5：块设备名字不包含 vda 和 sr0 的读字节数，指标名称 node_disk_read_bytes_total&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_disk_read_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;!&lt;/span&gt;~&lt;span class=&#34;token string&#34;&gt;&#34;.*sr0.*&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;22-时间范围查询&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#22-时间范围查询&#34;&gt;#&lt;/a&gt; 2.2 时间范围查询&lt;/h5&gt;
&lt;p&gt;在 Prometheus 中，范围向量选择器使我们能够提取时间序列中⼀段时间范围内的数据点。要定义⼀个范围向量选择器，你只需要在指标名称后⾯加上⽅括号 []，并在其中指定⼀个时间⻓度。时间⻓度有：s 秒，m 分钟，h ⼩时，d 天，w 周，y 年。使⽤范围向量选择器，你可以灵活查询从最近⼏分钟到⼏年的数据，便于分析和监控指标随时间的变化。&lt;/p&gt;
&lt;p&gt;1、例如，我们想查询 prom-node01.oldxu.net 这个实例，在过去 2 分钟，负载所有数据点。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;2m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; @1751165619.66&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; @1751165634.66&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; @1751165649.66&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; @1751165664.66&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; @1751165679.66&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; @1751165694.66&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; @1751165709.66&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; @1751165724.66&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、在 Prometheus 中，通常使⽤相对时间（如过去⼏分钟、⼩时或天）来查询数据。但是，如果你需要查询⼀个绝对时间点的数据，您可以直接使⽤ UNIX 时间戳来指定查询的具体时间。（在 Prometheus 中通常是以毫秒为单位的）&lt;/p&gt;
&lt;p&gt;例如，查询 2025 年 6 ⽉ 29 ⽇上午 10:58:10 的 &lt;a href=&#34;http://prom-node01.oldxu.net&#34;&gt;prom-node01.oldxu.net&lt;/a&gt; 实例的负载状态。需要先将时间转为 UNIX 时间戳，然后执⾏如下查询语句。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#指定时间查询表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; @ &lt;span class=&#34;token number&#34;&gt;1751165890&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 查询结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;  &lt;span class=&#34;token number&#34;&gt;0.27&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;23-时间偏移查询&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#23-时间偏移查询&#34;&gt;#&lt;/a&gt; 2.3 时间偏移查询&lt;/h5&gt;
&lt;p&gt;除了能够查询过去⼏分钟或⼏⼩时的数据，以及查询指定时间点的数据，同时 Prometheus 也允许您通过 offset 修饰符来指定查询从当前时间往回推某个具体的时间段。这种⽅式常⽤于⽐较，例如：今天 QPS 是 10000，昨天这个时间是 5000，我们就可以计算它们的增⻓率之类的。&lt;/p&gt;
&lt;p&gt;1、如果您想要查看昨天整天的数据，可以使⽤以下查询表达式：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 假设是⽤如下表达式查询的结果是 2023-12-26 17:20&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 那么如下表达式查询的数据将返回：(2023-12-24 17:20 - 2023-12-25 17:20)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1d&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; offset 1d&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、如果想要查看⼀周前的 “时间范围内” 的数据，可以使⽤如下查询：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 查询表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; offset 1w&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;这个查询会返回当前时间往回推⼀周，并从那个时间点开始，持续 5 分钟的数据范围内的 node_load1 指标。例如，如果现在是 12 ⽉ 26 ⽇星期⼀下午 17:30，那么该查询将返回 12 ⽉ 19 ⽇星期⼀下午 17:25 到 17:30 这 5 分钟范围内的所有数据点。&lt;/p&gt;
&lt;p&gt;3、对⽐分析实战：对⽐ “当前时间点接收的⽹络流量” 与 “1 ⼩时前的流量” 进⾏⽐对分析，以判断流量是增⻓还是减少。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;计算同环⽐的增⻓率或减少率的公式：同环⽐率 =(当前流量−过去 1 ⼩时的流量) / 过去 1 ⼩时的流量 ×100&lt;/li&gt;
&lt;li&gt;例如，如果当前总接收流量是 6000MB，⽽ 1 ⼩时前接收的总流量是 5000MB，&lt;/li&gt;
&lt;li&gt;那么计算公式为： （6000 - 5000） / 5000 * 100 = 20% （意味着相⽐ 1 ⼩时前，当前流量增⻓了 20%）&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; - node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; offset 1h&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; offset 1h * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-87.68874820331817&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 负增⻓ 80%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;4231.893284128109&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;# 增⻓ 4231%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;24.658781604740295&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 增⻓ 24%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;三-promql常用函数&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#三-promql常用函数&#34;&gt;#&lt;/a&gt; 三. PromQL 常⽤函数&lt;/h4&gt;
&lt;h5 id=&#34;31-count类型常用函数&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#31-count类型常用函数&#34;&gt;#&lt;/a&gt; 3.1 Count 类型常⽤函数&lt;/h5&gt;
&lt;p&gt;前⾯我们讲过，Counter 类型的监控指标只增不减，因此其样本值应该是不断增⼤的。因此单纯的 Counter 总数并没有直接作⽤，⽽是需要借助于 rate、irate、increase 和等函数来计算样本数据的变化状况（增⻓率）；&lt;/p&gt;
&lt;p&gt;1、rate ⽤于计算平均增⻓速率：计算公式：通过指定时间范围内的样本，使⽤最后⼀个样本的值减去第⼀个样本的值，⽽后除以这两个样本之间的间隔时⻓。&lt;/p&gt;
&lt;p&gt;例如： rate (nginx_http_requests_total [1m]) ，表示要获取 1 分钟内，该指标上的 http 总请求数的平均增⻓速率；&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/luPGWpV.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;2、irate ⽤于计算瞬时的增⻓速率（灵敏度较⾼）：计算公式：通过指定时间范围内的样本最后⼀个样本的值减去前⼀个样本的值，⽽后除以这两个样本之间的间隔时⻓。&lt;/p&gt;
&lt;p&gt;例如： irate (nginx_http_requests_total [1m]) ，表示要获取 1 分钟内，该指标上的 http 总请求数的瞬时增⻓速率；&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/yCfZc4S.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3、increase ⽤于计算指定时间范围内样本值的增加量：计算公式：通过指定时间范围内的样本最后⼀个样本的值减去第⼀个样本的值。注意：increase 可能会引⽤时间范围边界之前的样本值，以便于计算能覆盖到指定的整个时间范围。&lt;/p&gt;
&lt;p&gt;例如： increase (nginx_http_requests_total [1m]) ，表示要获取 1 分钟内，http 请求的增量；&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/lwmN3vP.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;32-gauge类型常用函数&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#32-gauge类型常用函数&#34;&gt;#&lt;/a&gt; 3.2 Gauge 类型常⽤函数&lt;/h5&gt;
&lt;p&gt;Gauge 类型的指标，存储的值是随着时间会变发⽣变化的，它常⽤求和、取平均值、最⼩值、最⼤值等；也会结合 PromQL 的 predict_linear 和 delta 函数使⽤；&lt;/p&gt;
&lt;p&gt;1、predict_linear (v range-vector, t, scalar)：预测时间序列 v 在 t 秒后的值，它通过线性回归的⽅式来预测样本数据的变化趋势；&lt;/p&gt;
&lt;p&gt;例如： predict_linear (node_filesystem_avail_bytes [4h], 60*60*24*30) ，使⽤过去 4 ⼩时的数据来预测接下来 30 天（60*60*24*30）&lt;/p&gt;
&lt;p&gt;的磁盘空间趋势。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;predict_linear&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mountpoint&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;4h&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;, &lt;span class=&#34;token number&#34;&gt;60&lt;/span&gt;*60*24*30&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /1024 /1024 /1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、delta (v range-vector)：计算范围向量中每个时间序列上的第⼀个样本值与最后⼀个样本值之差；其计算结果与 increase 函数相同；但 delta 更适⽤于没有重置的场景，或者⽤来监控那些可能上升或下降的指标，例如温度、磁盘空间等。&lt;/p&gt;
&lt;p&gt;例如： delta (cpu_temp_celsius {host=&amp;quot;&lt;a href=&#34;http://prom01.oldxu.net&#34;&gt;prom01.oldxu.net&lt;/a&gt;&amp;quot;}[2h]) ，返回该服务器上的 CPU 温度与 2 ⼩时之前的差异；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;delta&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;cpu_temp_celsius&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;host&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom01.oldxu.net&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;2h&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;例如： delta (node_filesystem_avail_bytes [10m]) /1024 /1024 ，返回服务器上磁盘可⽤空间与 10 分钟之前的差异；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;delta&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;10m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /1024 /1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#创建大文件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# dd if=/dev/zero of=/bigdata count=1 bs=200M&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、changes () ：计算监控时间范围内某个时间序列的数据变化的次数。它只关⼼变化的次数，⽽不关⼼具体变化的值是什么。&lt;/p&gt;
&lt;p&gt;例如： changes (nginx_up [10m]) 监控 Nginx 服务在给定时间内变化的次数，如果停⽌了变化次数 + 1，启动了变化次数 + 1。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;changes&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;up&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;10m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#模式测试&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node02 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl stop node_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node02 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start node_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;         &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;   &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;   &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;四-promql二元运算符&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#四-promql二元运算符&#34;&gt;#&lt;/a&gt; 四. PromQL ⼆元运算符&lt;/h4&gt;
&lt;p&gt;PromQL 提供了⼀系列⼆元运算符，包括算术运算 (+ - * /)、⽐较运算 ( == &amp;lt;= &amp;gt;=)、以及集合运算 ( and or unless)。在 PromQL 中，⽤户可以执⾏以下类型的运算：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;1、标量与标量之间的运算&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;2、即时向量与标量之间的运算&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;3、两个即时向量之间的运算。（当涉及到两个即时向量的运算时标签必须一致，PromQL 遵循向量匹配机制（Vector Matching），定义其运算逻辑）&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;41-算术运算符介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#41-算术运算符介绍&#34;&gt;#&lt;/a&gt; 4.1 算术运算符介绍&lt;/h5&gt;
&lt;p&gt;在 PromQL 中算术运算符，是⽤来对指标数据执⾏基本的数学运算。⽀持的运算符有：+（加）、-（减）、*（乘）、/（除）、%（取模）和 ^（幂运算）&lt;/p&gt;
&lt;p&gt;1、标量与标量之间进⾏数学运算，其最终得到的也是标量（使⽤较少）&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 标量与标量算数运算表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt; + &lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scalar &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、即时向量与标量进⾏运算，例如将 node_memory_MemTotal_bytes （节点内存总⼤⼩）的默认 bytes 单位转为 MB&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 即时向量与标量算数运算表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_memory_MemTotal_bytes / &lt;span class=&#34;token number&#34;&gt;1024&lt;/span&gt; /1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1970.05859375&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1970.05859375&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1970.05859375&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、即时向量与即时向量进⾏运算，它们需要遵循向量的匹配逻辑，也就是向量与向量的标签必须完全匹配⼀致才可以进⾏运算，如果它们的标签不⼀致，则不会执⾏这个运算。例如：我们想计算内存的可⽤百分⽐，计算公式为 “（内存可⽤空间 / 内存总空间 * 100）= 内存可⽤百分⽐” 这两个向量的标签是完全⼀致的，因此可以直接进⾏运算，否则⽆法正常进⾏运算，除⾮进⾏向量匹配特殊的处理。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 即时向量与即时向量算数运算表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;52.0608325815&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;18234&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 可⽤内存还有 52%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;70.7339367682&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;1954&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 可⽤内存还有 70%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;41.0098446469&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;1128&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 可⽤内存还有 41%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;42-算术运算符实践&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#42-算术运算符实践&#34;&gt;#&lt;/a&gt; 4.2 算术运算符实践&lt;/h5&gt;
&lt;p&gt;实例 1：计算所有实例节点的 eth0 ⽹卡，接收的总流量和发送的总流量之和（以 GB 显示）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;node_network_receive_bytes_total ：节点⽹络接收的总⼤⼩（以字节为单位）&lt;/li&gt;
&lt;li&gt;node_network_transmit_bytes_total ：节点⽹络发送的总⼤⼩（以字节为单位）&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式（ 计算公式：(eth0 接收的总流量 + eth0 发送的总流量) /1024 / 1024 /1024 ）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; + node_network_transmit_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /1024 /1024 /1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;65.10437232814729&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 65GB&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;19.22064190544188&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;35.516745982691646&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 2：计算所有实例节点的 / 分区 已经使⽤了，多少空间（以 GB 显示）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;node_filesystem_size_bytes ：⽂件系统总⼤⼩（以字节为单位）&lt;/li&gt;
&lt;li&gt;node_filesystem_avail_bytes ：⽂件系统可⽤空间（以字节为单位）&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式（ 计算公式：(总空间 - 剩余空间) /1024 / 1024 /1024 ）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mountpoint&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; - node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mountpoint&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /1024 /1024 /1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/dev/mapper/rl-root&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;fstype&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;xfs&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mountpoint&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;7.806545257568359&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;# 已使⽤ 7.8G&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/dev/mapper/rl-root&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;fstype&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;xfs&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mountpoint&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3.9103240966796875&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 已使⽤ 3.9G&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/dev/mapper/rl-root&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;fstype&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;xfs&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mountpoint&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5.496803283691406&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;# 已使⽤ 5.4G&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 3：计算所有实例节点的 / 分区 &amp;quot;已⽤空间百分⽐&amp;quot;&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式（ 计算公式：(总空间 - 可⽤的空间) / 总空间 * 100 ）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mountpoint&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; - node_filesystem_avail_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mountpoint&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mountpoint&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/dev/mapper/rl-root&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;fstype&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;xfs&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mountpoint&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3.965885742336228&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;# 已⽤空间占⽐百分之 3.96G&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/dev/mapper/rl-root&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;fstype&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;xfs&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mountpoint&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1.9864746546908878&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 已⽤空间占⽐百分之 1.98G&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/dev/mapper/rl-root&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;fstype&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;xfs&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mountpoint&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2.792465443218097&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;# 已⽤空间占⽐百分之 2.79G&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 4：计算所有节点内存的 “已⽤百分⽐”&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;node_memory_MemTotal_bytes ：总内存⼤⼩（单位字节）&lt;/li&gt;
&lt;li&gt;node_memory_MemAvailable_bytes ：内存可⽤⼤⼩（单位字节）&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式（ 计算公式：(总内存 - 可⽤内存) / 总内存 * 100 ）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_memory_MemTotal_bytes * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;48.12356865972023&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;# 已⽤ 48% 内存&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;29.767713920310907&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 已⽤ 29% 内存&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;58.8624624505537&lt;/span&gt;   &lt;span class=&#34;token comment&#34;&gt;# 已⽤ 58% 内存&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;43-比较运算符介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#43-比较运算符介绍&#34;&gt;#&lt;/a&gt; 4.3 ⽐较运算符介绍&lt;/h5&gt;
&lt;p&gt;在 PromQL 中⽐较运算符，是⽤来对指标的数据进⾏条件判断，⼀般在告警规则中定义何时应该触发告警。PromQL ⽀持的⽐较运算符有如下⼏个：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;== ：等于，当两边的数值相等时为真。&lt;/li&gt;
&lt;li&gt;!= ：不等于，当两边的数值不相等时为真。&lt;/li&gt;
&lt;li&gt;&amp;gt; ：⼤于，当左边的数值⼤于右边时为真。&lt;/li&gt;
&lt;li&gt;&amp;lt; ：⼩于，当左边的数值⼩于右边时为真。&lt;/li&gt;
&lt;li&gt;&amp;gt;= ：⼤于等于，当左边的数值⼤于或等于右边时为真。&lt;/li&gt;
&lt;li&gt;&amp;lt;= ：⼩于等于，当左边的数值⼩于或等于右边时为真。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;在 PromQL 中，使⽤⽐较运算符时，默认情况下，如果⽐较结果为假（即条件不满⾜），则相关的时间序列不会出现在结果中。但是，如果在测试时，想要明确地看到哪些时间序列满⾜条件（为真）和哪些不满⾜（为假），可以使⽤ bool 修饰符，这个修饰符会将所有的时间序列都显示在结果中，满⾜条件的序列会有⼀个值为 1（true），不满⾜的序列会有⼀个值为 0（false）。&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;1、标量与标量之间进⾏⽐较运算&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 标量与标量⽐较表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; bool &lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scalar &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 说明条件成⽴&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、即时向量与标量进⾏⽐较运算，例如判断服务器 1 分钟的负载，是否有⼤于 0 以上的节点&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 即时向量与标量进⾏⽐较表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1 &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.01&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.01&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、即时向量与即时向量进⾏⽐较运算，它们需要遵循向量的匹配逻辑，也就是向量与向量的标签必须完全匹配⼀致才可以进⾏运算，如果它们的标签不⼀致，则不会执⾏这个运算。例如：我们可以⽐较 “可⽤内存” 是否⼤于 “空闲内存”，如果满⾜该条件，那么会显示左侧的指标名称和指标当前的值。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 即时向量与即时向量⽐较表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_memory_MemAvailable_bytes &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; node_memory_MemFree_bytes&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_memory_MemAvailable_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1092820992&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_memory_MemAvailable_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1456451584&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_memory_MemAvailable_bytes&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;867491840&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;44-比较运算符实践&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#44-比较运算符实践&#34;&gt;#&lt;/a&gt; 4.4 ⽐较运算符实践&lt;/h5&gt;
&lt;p&gt;实例 1：查询 node_exporter 这个 job 中，⽬前不存活实例有哪些（1 为存活、0 为不存活）。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;up&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;up&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 0 表&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;示该节点⽬前不存活&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 2：查询所有实例 “已使⽤内存” 超过 30%&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式：（计算公式：（总内存 - 可⽤内存）/ 总内存 * 100 ⼤于 30 ）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / node_memory_MemTotal_bytes * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;48.04405801699267&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 该节点已使⽤内存达到 48%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;58.090753170015965&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 该节点已使⽤内存达到 58%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 3：查询所有的实例 “磁盘可⽤空间” 不⾜ 30% 的实例&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式：（计算公式：（可⽤空间 / 总磁盘空间） * 100 ⼩于 30 ）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_filesystem_avail_bytes / node_filesystem_size_bytes * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/dev/mapper/rl-root&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;fstype&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;xfs&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mountpoint&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;26.02939746145283&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 剩余空间仅剩 26%，意味着磁盘空间快⽤完了&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 4：查询所有实例中 eth0 设备的⽹络带宽，每秒发送速率超过 200Mb/s 兆 的实例&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 1、在两个测试的节点上安装：yum install iperf -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 2、服务端运⾏并指定端⼝：iperf -s -p 9999&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 3、客户端模拟带宽发送命令，-b 指定发送⼤⼩，-t 指定发送持续时⻓：iperf -c &amp;lt;ip&gt; -p 9999 -b 300M -t 60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式（计算公式：rate (总的传输 [1m]) * 8 /1024/1024) &gt; 200） ⽹络速度或带宽通常以位每秒（如 Mbps, Gbps）为单位。因此需要将字节乘以 8，能够将字节转换为位，这样可以更准确地描述传输速率&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_network_transmit_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;8&lt;/span&gt; /1024 /1024 &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;200&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;286.0319371541341&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 该节点每秒达到了 286Mb/s 的带宽（如果不乘以 8 则单位是 MB/s）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 5：查询所有 https 的域名，检查域名证书的过期时间，将还剩不到 90 天的域名列出来（需要借助后⾯的 blackbox ⿊盒监控，才能获取到对应的指标）&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式，计算公式（ (过期时间 - 当前时间) / 天 (24*60*60) ）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;probe_ssl_earliest_cert_expiry - time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / &lt;span class=&#34;token number&#34;&gt;86400&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;90&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://hmallleasing.com&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;blackbox_http&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;43.74673421296256&lt;/span&gt;       &lt;span class=&#34;token comment&#34;&gt;# 还剩 43 天过期&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://ixuyong.cn&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;blackbox_http&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;87.74673421296256&lt;/span&gt;            &lt;span class=&#34;token comment&#34;&gt;# 还剩 87 天过期&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;45-集合运算符介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#45-集合运算符介绍&#34;&gt;#&lt;/a&gt; 4.5 集合运算符介绍&lt;/h5&gt;
&lt;p&gt;在 Prometheus 的查询语⾔中，集合运算符主要⽤到的运算符包括 and（并且）、or（或者）和 unless（排除）&lt;/p&gt;
&lt;p&gt;例如：我们有两个关键指标：backup_duration_seconds ⽤于记录每次备份操作的持续时间，⽽ backup_success 则指示备份操作是否成功（1 表示成功，0 表示失败）&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;场景 1：备份成功但时间超过 9s&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;当备份操作成功完成（backup_success == 1），并且执⾏时间超过 9 秒（backup_duration_seconds &amp;gt; 9）时，我们需要发出告警通知 “备份成功但备份时间过⻓”。这就需要使⽤ and 运算符来确保只有当这两个条件都满⾜时，才触发告警。对应的表达式为：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;backup_duration_seconds &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;9&lt;/span&gt; and backup_success &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;&lt;strong&gt;场景 2：备份失败或时间超过 9s&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;如果备份时⻓超过了 9 秒（backup_duration_seconds &amp;gt; 9），或者备份操作失败（backup_success == 0），则同样需要发出告警通知 “备份失败或时间过⻓”。在这种情况下，是⽤ or 运算符可以帮助我们在任⼀条件满⾜时触发告警。对应的表达式为：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;backup_duration_seconds &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;9&lt;/span&gt; or backup_success &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;&lt;strong&gt;场景 3：查询成功的备份，但排除耗时超过 9s&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;查询所有成功的备份任务，同时排除那些执⾏时间超过 9 秒的任务，这样我们就可以只关注于那些成功备份的任务，并且备份效率较⾼的。我们可以利⽤ unless 运算符来实现，对应的表达式为：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;backup_success &lt;span class=&#34;token operator&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; unless backup_duration_seconds &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;9&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;1、and 运算符示例，查询当前实例 “1 分钟负载⼤于 2，并且 5 分钟负载⼩于&lt;/p&gt;
&lt;p&gt;2、如果满⾜条件说明当前发了了突增的负载压⼒。注意：and 运算需要遵循向量的匹配逻辑，也就是向量与向量的标签必须完全匹配⼀致才可以进⾏匹配，如果它们的标签不⼀致，则不会执⾏匹配逻辑，除⾮使⽤ ignore 忽略不⼀致的标签来进⾏匹配。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟负载⾼命令 stress --cpu 8 --timeout 60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1 &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; and&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load5 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;4.19&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 说明当前 node03 节点 1 分钟负载⽐较⾼，⽽ 5 分钟负载并不⾼&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、or 示例，查询 &lt;a href=&#34;http://prom-node01.oldxu.net:9100&#34;&gt;prom-node01.oldxu.net:9100&lt;/a&gt; 上 CPU 编号为 0 的 idle 时间或 user 时间&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;,cpu&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; or&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;user&#34;&lt;/span&gt;,cpu&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;cpu&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;6429449.35&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;cpu&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;user&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;26207.44&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、unless 示例，查询 node_cpu_seconds_total 指标上 CPU 编号为 0 的，但要排除 node02 和 node03 节点，同时还要排除模式为 idle|user|system|steal|nice&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;cpu&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; unless&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; unless&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; unless&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=~&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle|user|system|steal|nice&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;cpu&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;iowait&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3243.97&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;cpu&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;irq&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;7236.66&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;cpu&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;softirq&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;4117.61&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;46-集合运算符实践&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#46-集合运算符实践&#34;&gt;#&lt;/a&gt; 4.6 集合运算符实践&lt;/h5&gt;
&lt;p&gt;实例 1：查询实例的⽹络接收流量 “并且” ⽹络发送流量，每秒传输超过 200Mb/s&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#模拟接收和发送流量⽐较⾼：&#34;需要在同⼀节点&#34; 模拟服务端和客户端，执⾏如下命令&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 1、模拟服务端：iperf -s -p 9999&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 2、模拟客户端：iperf -c prom-node01.oldxu.net -p 9999 -b 300M -t 60&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_network_receive_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; *8 /1024 /1024 &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;200&lt;/span&gt; and&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_network_transmit_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; *8 /1024 /1024 &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;200&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;device&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;lo&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;300.4421537611219&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 这个实例发送和接收同时达到了 300Mb/s&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 2：查询当前磁盘，可⽤空间不⾜ 20GB “或者” 当前磁盘可⽤空间不⾜ 30%&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式，计算公式： 可⽤空间 / 1024/1024/1024 &amp;lt;= 20 OR （可⽤空间 / 总磁盘空间） *100 &amp;lt; 30 &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;node_filesystem_avail_bytes /1024 /1024 /1024 &lt;span class=&#34;token operator&#34;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;20&lt;/span&gt; or &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; node_filesystem_avail_bytes / node_filesystem_size_bytes&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 3：通过 probe_http_status_code 指标获取当前监控的⽹站返回的状态码，并从中筛选出⼩于 200 的状态码 “或者” ⼤于 400 的状态码&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;probe_http_status_code &lt;span class=&#34;token operator&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;199&lt;/span&gt; or&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;probe_http_status_code &lt;span class=&#34;token operator&#34;&gt;&gt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;400&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;probe_http_status_code&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/102&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;blackbox_http&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;probe_http_status_code&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;http://httpbin.org/status/400&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;blackbox_http&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;400&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;probe_http_status_code&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/421&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;blackbox_http&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;421&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;probe_http_status_code&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/500&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;blackbox_http&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;500&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;probe_http_status_code&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/502&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;blackbox_http&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;502&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;五-promql聚合操作&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#五-promql聚合操作&#34;&gt;#&lt;/a&gt; 五. PromQL 聚合操作&lt;/h4&gt;
&lt;h5 id=&#34;51-promql聚合介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#51-promql聚合介绍&#34;&gt;#&lt;/a&gt; 5.1 PromQL 聚合介绍&lt;/h5&gt;
&lt;p&gt;聚合运算，是数据处理中的⽐较常⻅操作，例如统计公司所有⼈员的年龄，求公司整体的平均年龄，最⼤年龄，或最⼩年龄等。因此聚合操作它是从⼀组数据值中，计算出⼀个单⼀的值。&lt;/p&gt;
&lt;p&gt;Prometheus 的聚合操作与此前刚才所描述的常规聚合在本质上是相似的，只不过它⽀持多种聚合运算函数，包括:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;max ：计算⼀组时间序列中的最⼤值。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;min ：计算⼀组时间序列中的最⼩值。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;avg ：计算时间序列的平均值。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;sum ：计算时间序列值的总和。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;count ：它不考虑时间序列的具体值，仅⽤来统计时间序列的数量。例如统计不同 OS 的数量，或者统计有多少个正在运⾏的 Pod 等等。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;count_vaules ：对每个样本的值进⾏数量统计，例如：http 请求的状&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;态码，200 出现了多少次，404 出现了多少次，500 出现了多少次；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;topk ：&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;bottomk ：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;除了这些基本聚合功能外，Prometheus 也提供了分组聚合的功能，它是基于时间序列的标签进⾏分组聚合：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;by ：通过 by 关键字，明确指定保留哪些标签进⾏聚合，其他的标签将被忽略。&lt;/li&gt;
&lt;li&gt;without ：与 by 相反， without 关键字⽤于指定要排除的标签，⽽剩下的标签则⽤于聚合和分组。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;52-promql聚合示例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#52-promql聚合示例&#34;&gt;#&lt;/a&gt; 5.2 PromQL 聚合示例&lt;/h5&gt;
&lt;p&gt;为了加深 PromQL 聚合操作的理解，我们使⽤前⾯提到的城市天⽓温度数据，并通过聚合操作来展示如何获取整体的最⾼温度、最低温度以及按城市维度进⾏分组求取平均温度等。&lt;/p&gt;
&lt;p&gt;1、下载并运⾏程序，提供天⽓温度相关的指标数据&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://file.oldxu.net/prometheus/exporter/weather_exporter_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mv weather_exporter_oldxu /usr/local/bin/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# chmod +x /usr/local/bin/weather_exporter_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 启动脚本&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /usr/lib/systemd/system/weather_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;weather_exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/usr/local/bin/weather_exporter_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--port&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;7001&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start weather_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、编辑 Prometheus 配置⽂件，抓取对应的指标数据&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    scrape_interval: 1m &lt;span class=&#34;token comment&#34;&gt;# 抓取指标频率&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7001&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 重新加载 prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例 1：获取所有城市的整体温度总和&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;210&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例 2：分别展示不同城市的最⼤温度&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;city&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;上海&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;30&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;北京&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;25&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;⼴州&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;29&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例 3：分别展示不同城市的最⼩温度&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;min&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;city&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;上海&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;12&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;北京&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;⼴州&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;11&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例 4：仅展示 “武汉” 城市的平均温度&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;avg&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22.666666666666664&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例 5：是⽤ topk 获取前三个的⾼温城市。topk 的结果按温度值从⾼到低排序&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;topk&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;,weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;上海&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;浦东新区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7001&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;27&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;⼴州&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;越秀区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7001&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;15&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;⼴州&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;天河区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7001&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;14&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例 6：使⽤ bottomk 获取排名靠前三的低温城市。bottomk 的结果按温度值从低到⾼排列&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;bottomk&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;,weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7001&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-6&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;汉⼝区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7001&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-5&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;北京&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;海淀区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7001&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例 7：统计天⽓温度的数量，按城市进⾏区分&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;count&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;city&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;上海&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;北京&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;⼴州&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例 8：统计各温度值出现的频次，按城市进⾏区分&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式 count_values (&#34;value_count&#34;, &amp;lt;metrics_name&gt;) by (&amp;lt;label&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;count_values&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;status&#34;&lt;/span&gt;,weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;city&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;上海&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;12&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;上海&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;13&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;上海&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;14&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;北京&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;-3&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;北京&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;6&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;北京&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;-10&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;⼴州&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;20&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;⼴州&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;24&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;⼴州&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;17&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;15&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;17&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 17 度出现了 2 次，这意味着武汉城市有 2 个不同地域报告了 17 度的温度。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;53-promql聚合实践&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#53-promql聚合实践&#34;&gt;#&lt;/a&gt; 5.3 PromQL 聚合实践&lt;/h5&gt;
&lt;p&gt;实例 1：查询所有节点，最近 1 分钟的负载，是否⾼于 cpu 核⼼的 2 倍&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟 cpu 使⽤率⾼于核⼼数：stress --cpu 6&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 获取每个节点的负载表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# CPU 核⼼的 2 倍表达式 [核⼼数 * 2]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;count&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 整体表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_load1&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; count&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;4.06&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 该节点的使⽤率超过核⼼数的 2 倍了&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 2：查询每个节点的 CPU 的使⽤率，指标名称： node_cpu_seconds_total&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟 cpu 使⽤率达到 50%：stress --cpu 1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式: (1 - CPU 整体空闲使⽤率) * 100 = CPU 使⽤率&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; - avg&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;mode&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;idle&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; *100&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1.1555555555484487&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;51.144444444459324&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 使⽤率在 50% 左右&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2.3333333333236395&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 3：查询所有节点，最近 1 分钟磁盘的最⼤写⼊速率，以 MB/s 为单位，指标名称： node_disk_written_bytes_total&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟数据写⼊，复制 2G 的数据，控制每秒 20M 左右的速度写&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install pv -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# dd if=/dev/zero bs=1M count=2000 | pv -L 20M &gt; /tmp/bigdata&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式： 获取每分钟的磁盘速率，然后提取最⼤的值，最后 / 1024/1024 得到 MB/s&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_written_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /1024 /1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.007052951388888888&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;19.724283854166664&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;#每秒写⼊速度在 19MB/s&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.011946614583333333&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 4：查询所有节点，最近 1 分钟磁盘的读取写⼊速率，以 MB/s 为单位，指标名称： node_disk_read_bytes_total&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟数据读取，读取 /tmp/bigdata ⽂件，然后以每秒 15MB 的速度读取&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install pv -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# pv -L 15M /tmp/bigdata &gt; /dev/null&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;max&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;rate&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_disk_read_bytes_total&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;))&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; /1024 /1024&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;15.006076388888888&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;#每秒读取速度在 15MB/s&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 5：计算 Prometheus 服务器的 HTTP 请求成功率，指标名称： prometheus_http_requests_total&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 计算公式： 请求成功的 (2xx|3xx) / 总的请求 * 100 = 请求成功率&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;sum&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;prometheus_http_requests_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;code&lt;span class=&#34;token operator&#34;&gt;=~&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;2.*|3.*&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / sum&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;prometheus_http_requests_total&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;99.59027974003956&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# ⽹站整体请求成功率在 99.5%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 6：查询请求排名前三的 URL，指标名称： prometheus_http_requests_total&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;sum&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;topk&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;,prometheus_http_requests_total&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,handler&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;handler&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5483&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;handler&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/api/v1/query&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1576&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;handler&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;/api/v1/metadata&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;113&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;六-promql时间聚合操作&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#六-promql时间聚合操作&#34;&gt;#&lt;/a&gt; 六. PromQL 时间聚合操作&lt;/h4&gt;
&lt;h5 id=&#34;61-promql时间聚合介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#61-promql时间聚合介绍&#34;&gt;#&lt;/a&gt; 6.1 PromQL 时间聚合介绍&lt;/h5&gt;
&lt;p&gt;在 Prometheus 中，除了可以 “纵向的聚合” 以外，还可以基于时间聚合也就是 “横向聚合”。&lt;/p&gt;
&lt;p&gt;时间聚合不是在不同的序列上进⾏聚合操作，⽽是在 “单个序列” 的不同时间点之间进⾏聚合，这意味着，对于单个序列，我们可以计算过去⼀段时间内的最⼤值，最⼩值，以及平均值等。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;avg_over_time (range-vector) ：区间向量内每个指标的平均值。&lt;/li&gt;
&lt;li&gt;min_over_time (range-vector) ：区间向量内每个指标的最⼩值。&lt;/li&gt;
&lt;li&gt;max_over_time (range-vector) ：区间向量内每个指标的最⼤值。&lt;/li&gt;
&lt;li&gt;sum_over_time (range-vector) ：区间向量内每个指标的求和。&lt;/li&gt;
&lt;li&gt;count_over_time (range-vector) ：区间向量内指标样本的总个数。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/qAuRqKU.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;62-promql时间聚合示例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#62-promql时间聚合示例&#34;&gt;#&lt;/a&gt; 6.2 PromQL 时间聚合示例&lt;/h5&gt;
&lt;p&gt;1、获取武汉城市中武昌区，最近 5 分钟的温度数据&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;,dist&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:5000&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;12&lt;/span&gt; @1704269783.3&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt; @1704269843.3&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;17&lt;/span&gt; @1704269903.3&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;17&lt;/span&gt; @1704269963.3&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt;  @1704270023.3&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、获取武汉城市中武昌区，最近 5 分钟温度的最⼤值&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;max_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;,dist&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:5000&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、获取武汉城市中武昌区，最近 5 分钟温度的最⼩值&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;min_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;,dist&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:5000&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;4、获取武汉城市中武昌区，最近 5 分钟温度的平均值&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;min_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;,dist&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:5000&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;14.6&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;5、获取武汉城市中武昌区，当前数据总共来⾃多少个样本&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;count_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;weather_oldxu&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;,dist&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;5m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;city&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武汉&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;dist&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;武昌区&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:5000&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;weather-exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 说明 5 分钟的样本数有 5 个&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;63-promql时间聚合实践&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#63-promql时间聚合实践&#34;&gt;#&lt;/a&gt; 6.3 PromQL 时间聚合实践&lt;/h5&gt;
&lt;p state=&#34;time_wait&#34;&gt;实例 1：查询最近 1 分钟内 tcp_timewait 连接数的最⼤值，并检查是否超过 1000 个，指标名称： node_tcp_connection_states&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟⼤量 tcp_timewait：ab -n 1000 -c 2 http://localhost:9090/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;max_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_tcp_connection_states&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;state&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;time_wait&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1000&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;time_wait&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1769&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 最近 1 分钟最⼤的值是 1769&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p state=&#34;established&#34;&gt;实例 2：查询最近 1 分钟内 tcp_established 连接数的最⼤值，并检查是否超过 100 个，指标名称： node_tcp_connection_states&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟 established：&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 服务端（node01）：nc -lk 2345&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 客户端（node02）：for i in &amp;#123;1..1000&amp;#125;; do nc prom-node01.oldxu.net 2345 &gt;/dev/null 2&gt;&amp;amp;1 &amp;amp; done&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;max_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_tcp_connection_states&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;state&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;established&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;established&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;133&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;established&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;106&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 3：查询⽹站平均请求延迟 1 分钟⼤于 3s 的站点，指标名称： probe_duration_seconds（需要 blackbox)&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;avg_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;probe_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;https://httpstat.us/102&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;blackbox_http&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;14.501046884666668&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 4：查询 MySQL 服务器在最近 1 分钟内平均运⾏线程数超过 50 的。指标名称： mysql_global_status_threads_running&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟 MySQL 线程数&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;token for-or-select variable&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;120&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;do&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   mysql &lt;span class=&#34;token parameter variable&#34;&gt;-e&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;SELECT SLEEP(60);&#34;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;amp;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;done&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;avg_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;mysql_global_status_threads_running&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;50&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9104&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;mysqld_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;62&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 平均线程数在 62，超过阈值定义的 50&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 5：查询以监控 MySQL 服务器过去 1 分钟内的线程当前打开的最⼤连接数。如果这个数值超过了服务器配置的最⼤连接数的 80% 则触发告警。指标名称&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mysql_global_status_threads_connected （表示当前打开的连接数）&lt;/li&gt;
&lt;li&gt;mysql_global_variables_max_connections （表示配置允许的最⼤连接数）&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 模拟 MySQL 连接数&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;token for-or-select variable&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;120&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;do&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    mysql &lt;span class=&#34;token parameter variable&#34;&gt;-e&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;SELECT SLEEP(60);&#34;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&amp;amp;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;done&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;max_over_time&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;mysql_global_status_threads_connected&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;1m&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; / mysql_global_variables_max_connections * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9104&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;mysqld_exporter&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80.79470198675497&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 当前最⼤连接数已经超过了 80%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;七-promql向量匹配&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#七-promql向量匹配&#34;&gt;#&lt;/a&gt; 七. PromQL 向量匹配&lt;/h4&gt;
&lt;h5 id=&#34;71-promql向量匹配介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#71-promql向量匹配介绍&#34;&gt;#&lt;/a&gt; 7.1 PromQL 向量匹配介绍&lt;/h5&gt;
&lt;p&gt;在 Prometheus 中，执⾏ “向量与向量之间的运算” 时，需要遵循向量匹配的规则。这意味着两个向量必须具有 “相同的标签”，且对应的 “标签值也必须完全相同”，这才能进⾏运算。如果有任何⼀个标签或标签值不匹配，那么此次的运算将不会执⾏。这种匹配规则也被称为 “向量的⼀对⼀匹配”。例如，下⾯两个时间序列可以成功进⾏⼀对⼀匹配，⽽后可以正常执⾏各种运算：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;http_requests_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;promnode01.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;http_requests_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;,instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;因为它们的标签以及标签值完全⼀致，所以它们可以直接进⾏运算操作。&lt;/p&gt;
&lt;h5 id=&#34;72-promql一对一向量匹配&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#72-promql一对一向量匹配&#34;&gt;#&lt;/a&gt; 7.2 PromQL ⼀对⼀向量匹配&lt;/h5&gt;
&lt;p&gt;但是在实际监控场景中，我们会经常遇到 “标签不完全相同” 的两个向量，但它们任然需要进⾏运算。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3200&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#表示该实例的 HTTP 请求总数。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_status_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;GET&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;500&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#表示该实例中使⽤ GET ⽅法的 HTTP 请求总数。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;假设我们想要计算使⽤ GET ⽅法的请求总数，占总请求数的⽐例是多少。理想的计算公式是： GET ⽅法的请求总数 / 总的请求数 * 100 = GET 请求所占的⽐例。 但由于两个向量的标签不完全相同（⼀个有 method 标签，⼀个没有），因此⽆法进⾏直接进⾏计算。&lt;/p&gt;
&lt;p&gt;为了解决这个问题，我们可以借助 PromQL 的向量匹配选项：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;基于标签的匹配（on）：指定基于哪些标签进⾏匹配。只有当指定的 ” 标签及其值 “ 在两个向量中都相同，向量之间才能进⾏运算。&lt;/li&gt;
&lt;li&gt;忽略标签的匹配（ignoring）：指定忽略某些标签，也就是在运算时不考虑这些标签，只要其他标签以及标签的值相同，向量之间就可以进⾏运算。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;⽅式 1：使⽤ on 关键字匹配特定标签，明明确指定仅基于 job 和 instance 标签进⾏匹配&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_status_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;method&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;GET&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; / on &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;job, instance&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_total * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;15.625&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# GET ⽅法占⽐总请求 15%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;⽅式 2：使⽤ ignoring 关键字忽略特定标签，忽略不希望参与匹配的 method 标签&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_status_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;method&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;GET&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; / ignoring &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;method&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_total * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;15.625&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# GET ⽅法占⽐总请求 15%&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;73-promql一对多向量匹配&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#73-promql一对多向量匹配&#34;&gt;#&lt;/a&gt; 7.3 PromQL ⼀对多向量匹配&lt;/h5&gt;
&lt;p&gt;在实际监控中，我们还会遇到需要进⾏ “⼀对多向量匹配” 的情况，即 “⼀个时间序列中的数据点” 需要与 “另⼀个时间序列中的多个数据点” 进⾏匹配运算。&lt;/p&gt;
&lt;p&gt;举个例⼦：假设我们有如下两个指标：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 第⼀个时间序列：记录了不同 HTTP ⽅法和状态码的错误请求总数。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_error_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;GET&#34;&lt;/span&gt;,code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;500&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;220&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_error_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;GET&#34;&lt;/span&gt;,code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;404&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;130&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_error_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;PUT&#34;&lt;/span&gt;,code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;501&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_error_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;POST&#34;&lt;/span&gt;,code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;500&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;34&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_error_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;POST&#34;&lt;/span&gt;,code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;502&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;48&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 第⼆个时间序列：记录了每种 HTTP ⽅法的请求总数。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_instance_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;,method&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;GET&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;600&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_instance_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;method&#34;&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;POST&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;120&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;我们的⽬标是计算每种 HTTP ⽅法（GET 和 POST）对应不同状态码（404 和 500）的请求占该⽅法总请求的⽐例。⼤体计算公式如下：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 1、GET ⽅法为 500 的请求总数 / GET 的总请求数 * 100 = GET 500 错误⽐例。 (220 /600 * 100 = 21.666666666666668)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 2、GET ⽅法为 404 的请求总数 / GET 的总请求数 * 100 = GET 404 错误⽐例。 (130 /600 * 100 = 36.666666666666664)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 3、POST ⽅法为 500 的请求总数 / POST 的总请求数 * 100 = POST 500 错误⽐例。 (34 / 120 * 100 = 28.333333333333332)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 4、POST ⽅法为 502 的请求总数 / POST 的总请求数 * 100 = POST 502 错误⽐例。 (48 / 120 * 100 = 40)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;为了实现这⼀⽬标，我们有两个问题需要解决：&lt;/p&gt;
&lt;p&gt;1、标签不⼀致：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;具体问题：两个时间序列的标签集合不完全⼀致， oldxu_requests_error_total 包含 code 标签，⽽ oldxu_requests_instance_total 不包含。&lt;/li&gt;
&lt;li&gt;解决⽅法：使⽤ ignoring (code) 来忽略 code 标签，从⽽使得两个时间序列在没有 code 标签的情况下可以匹配。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;2、⼀对多匹配：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;具体问题： oldxu_requests_error_total 中的每个数据点，都需要与 oldxu_requests_instance_total 中的总请求数相除。&lt;/li&gt;
&lt;li&gt;解决办法：必须明确左侧还是右侧为多的⼀边，因此我们可以使⽤ group_left 或 group_right 来指明哪个是 “多”，然后进⾏匹配。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;因此完整的 PromQL 查询如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、使⽤ ignoring (code) 忽略左侧查询（ oldxu_requests_error_total ）中的 code 标签。&lt;/li&gt;
&lt;li&gt;2、使⽤ group_left 修饰符来确保它能够与标签较少的右侧进⾏匹配。&lt;/li&gt;
&lt;li&gt;3、将匹配后的结果相除，并乘以 100 得到百分⽐。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_error_total&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; / ignoring &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;code&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   group_left&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;oldxu_requests_instance_total * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;404&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7002&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;GET&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;21.666666666666668&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;500&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7002&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;GET&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;36.666666666666664&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;500&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7002&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;POST&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;28.333333333333332&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;502&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;instance&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7002&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;, &lt;span class=&#34;token assign-left variable&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;POST&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;40&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;74-promql向量匹配示例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#74-promql向量匹配示例&#34;&gt;#&lt;/a&gt; 7.4 PromQL 向量匹配示例&lt;/h5&gt;
&lt;p&gt;1、下载并运⾏程序，该程序⽤于模拟 “向量匹配相关的” 指标数据；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://file.oldxu.net/prometheus/exporter/vectormatch_exporter_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# mv vectormatch_exporter_oldxu /usr/local/bin&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# chmod +x /usr/local/bin/vectormatch_exporter_oldxu&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 启动脚本&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /usr/lib/systemd/system/vectormatch_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;vectormatch_exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/usr/local/bin/vectormatch_exporter_oldxu &lt;span class=&#34;token parameter variable&#34;&gt;--port&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;7002&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start vectormatch_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、编辑 Prometheus 配置⽂件，抓取对应的指标数据&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;webserver&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:7002&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 重新加载 prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例 1：⼀对⼀向量匹配&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/kxSPXou.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;示例 2：⼀对多向量匹配&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/sEj96xP.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;75-promql向量匹配实践&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#75-promql向量匹配实践&#34;&gt;#&lt;/a&gt; 7.5 PromQL 向量匹配实践&lt;/h5&gt;
&lt;p&gt;实例 1：查询每个实例 CPU 的各个模式使⽤的时间占 “总 CPU 的时间” ⽐例是多少，也是就占多少百分⽐。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、获取每个实例各个模式占⽤ CPU 的时间，按照（instance、mode）进⾏分组并求和；&lt;/li&gt;
&lt;li&gt;2、获取每个实例总占⽤ CPU 时间，按照（instance）进⾏分组求和；&lt;/li&gt;
&lt;li&gt;3、将每种模式所使⽤的 CPU 时间 / CPU 总的时间 * 100 = 每种模式占总 CPU 时间的百分⽐；&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;sum&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job,mode&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;/ ignoring &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;mode&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  group_left&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;sum&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,job&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; * &lt;span class=&#34;token number&#34;&gt;100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;实例 2：查询 “每个 CPU 核⼼” 上不同模式的时间，占总 CPU 时间的⽐率是多少，也就是占多少百分⽐。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、计算 “每个 CPU 核⼼” 在 “各个模式下” 的累计 CPU 使⽤时间，按照（instance、cpu、mode）进⾏分组并求和；&lt;/li&gt;
&lt;li&gt;2、计算 “每个 CPU 核⼼的总 CPU 时间” 不区分模式。按照（instance、cpu）进⾏分组并求和；&lt;/li&gt;
&lt;li&gt;3、每个 CPU 核⼼的各个模式 / CPU 核⼼的总时间 * 100 = 每个 CPU 核⼼的各个模式时间占⽤百分⽐&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 表达式&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;sum&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,cpu,mode&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; / on &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,cpu&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;   group_left&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token function&#34;&gt;sum&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;node_cpu_seconds_total&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; by &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;instance,cpu&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
        <category term="Prometheus" />
        <updated>2025-06-28T14:16:53.000Z</updated>
    </entry>
    <entry>
        <id>http://ixuyong.cn/posts/1595025559.html</id>
        <title>Prometheus监控实战（一）</title>
        <link rel="alternate" href="http://ixuyong.cn/posts/1595025559.html"/>
        <content type="html">&lt;h3 id=&#34;prometheus监控实战一&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#prometheus监控实战一&#34;&gt;#&lt;/a&gt; Prometheus 监控实战（一）&lt;/h3&gt;
&lt;h4 id=&#34;一-prometheus介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#一-prometheus介绍&#34;&gt;#&lt;/a&gt; 一、Prometheus 介绍&lt;/h4&gt;
&lt;h5 id=&#34;11-prometheus是什么&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#11-prometheus是什么&#34;&gt;#&lt;/a&gt; 1.1 Prometheus 是什么&lt;/h5&gt;
&lt;p&gt;Prometheus 是由 SoundCloud 使⽤ Go 语⾔开发的时序数据库（简称 TSDB）但它的功能并⾮局限于 TSDB，因为它还⽀持对⽬标（如服务器、应⽤程序等）进⾏监控；&lt;/p&gt;
&lt;p&gt;因此，我们也可以理解 Prometheus 是⼀款开源的 “监控系统”，但仅仅依托 Prometheus 不⾜以⽀撑整个监控系统，它需要结合⽣态内其他的组件来构建⼀个完整的 IT 监控系统。例如： AleartManager、Grafana、PushGateway 等等。&lt;/p&gt;
&lt;h5 id=&#34;12-什么是时序数据&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#12-什么是时序数据&#34;&gt;#&lt;/a&gt; 1.2 什么是时序数据&lt;/h5&gt;
&lt;p&gt;所谓时序数据，指的是，按照固定时间周期对 “某个或某些指标” 进⾏ “反复测量” 从⽽得到测量的 “数据集合”。这些数据随着时间的推移，会形成⼀个连续的序列，因此被称为时序数据。如果我们将这些数据绘制在图形上，通常会有⼀个 数据轴（Y 轴） 表示数据值，⼀个 时间轴（X 轴） 表示测量的时间点。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/ciCCOaR.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;13-prometheus时序数据&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#13-prometheus时序数据&#34;&gt;#&lt;/a&gt; 1.3 Prometheus 时序数据&lt;/h5&gt;
&lt;p&gt;在 Prometheus 中，时序数据主要包括三个部分：指标名称、标签集、时序数据（时间戳、数据）。&lt;/p&gt;
&lt;p&gt;1、指标名称&lt;/p&gt;
&lt;p&gt;例如，监控服务器的 CPU 使⽤率，对应的指标名称可以是 cpu_usage、memory_MemTotal 等指标名称是被监控端提供的。&lt;/p&gt;
&lt;p&gt;2、标签集&lt;/p&gt;
&lt;p&gt;标签集⽤于区分不同的数据源或实例。&lt;/p&gt;
&lt;p&gt;假设我们有两台服务器，⼀台是 Web 服务器，另⼀台是 db 数据库服务器。为了区分这两台服务器的 CPU 使⽤率数据，我们可以为它们添加不同的标签，例如： cpu_usage {type=&amp;quot;web&amp;quot;} 和 cpu_usage {type=&amp;quot;db&amp;quot;} 。&lt;/p&gt;
&lt;p&gt;3、时序数据&lt;/p&gt;
&lt;p&gt;指按照按固定时间间隔，采集对应指标名称，从⽽获取到对应指标的数据。例如，每分钟采集⼀次 CPU 使⽤率（ cpu_usage ）。每个数据点包括采集 CPU 使⽤率的时间戳（ 2023.03.30 10:00:01 ），以及该时间点采集到的样本值（ 50% ）。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/SRYErXu.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;PS：每⼀个 “指标名称和标签组合” 都会形成⼀条独⽴的时间序列。这就表示，即使我们只探测了⼀个指标 cpu_usage ，但是它具有不同的标签值，就会产⽣两条分别代表不同实例的时间序列。在这些时间序列中，每⼀个特定的数据点被称为⼀个 &#39; 样本 &#39;。每个样本都包含指标名称、标签、时间戳以及对应的指标值。&lt;/p&gt;
&lt;h5 id=&#34;14-prometheus数据采集三种方式&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#14-prometheus数据采集三种方式&#34;&gt;#&lt;/a&gt; 1.4 Prometheus 数据采集三种方式&lt;/h5&gt;
&lt;p&gt;在传统的 Zabbix 监控系统中，通常是需要在被监控的节点上安装 Agent 代理程序。由 Agent 代理程序定期收集指标数据，并将其发送到监控服务器，完成数据采集。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/GrKq3KY.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;在 Prometheus 中，被监控端⽆需安装专⻔的 Agent。它只需要 “被监控端通过 HTTP 协议开放出符合 Prometheus 规范的指标数据”，Prometheus 就能够顺利完成数据抓取。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/8qTrLX7.jpeg&#34; alt=&#34;5.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;但，并不是所有的应⽤或服务都能直接⽀持 HTTP 协议并提供符合 Prometheus 所兼容的指标格式。因此，Prometheus 设计了三种主要的数据抓取机制，即 Instrumentation、Exporter 和 PushGateway。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Instrumentation ：被监控端通过 HTTP 暴露出 Prometheus 格式的数据，Prometheus 就可以直接采集，这就是所谓的 Instrumentation。像 Kubernetes、Haproxy、Zookeeper、RabbitMQ、Etcd 等应⽤程序原⽣就⽀持暴露指标，可以直接被 Prometheus 所监控。对于 Python、Java、Go 这些开发语⾔编写的业务应⽤，开发⼈员可以直接引⽤ Prometheus 客户端库来编写代码，让应⽤程序原⽣就能⽀持暴露需要监控的指标数据，这些指标数据可以直接被 Prometheus 采集。这就相当于应⽤程序本身具备了与 Prometheus 通信的能⼒，⽆需额外的中间件来转换数据。&lt;/li&gt;
&lt;li&gt;Exporter（导出器） ：有些应⽤程序并不原⽣⽀持通过 HTTP 协议暴露指标数据。对于这类应⽤，我们可以使⽤ Exporter 来代为采集指标。Exporter 是⼀个独⽴的运⾏程序，负责从⽬标应⽤中采集原始格式的数据，并将其转换为 Prometheus 可以理解的格式，然后通过 HTTP 协议暴露出来，供 Prometheus 抓取指标。简单来说，Exporter 就像⼀个翻译官，将⽬标应⽤程序的数据翻译成 Prometheus 可以读懂的语⾔。&lt;/li&gt;
&lt;li&gt;PushGateway（推送⽹关） ：对于那些⽣命周期较短或者不⽅便被 Prometheus 主动拉取数据的应⽤程序（如短暂运⾏的脚本任务）可以使⽤ PushGateway。让这些短暂运⾏的脚本程序，将对应的指标数据主动推送到 PushGateway，然后 Prometheus 从 PushGateway 中抓取这些数据。PushGateway 就像⼀个中间站，存储这些短暂任务产⽣的指标数据，等待 Prometheus 来抓取。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/vCHt9SX.jpeg&#34; alt=&#34;6.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;15-prometheus作业与实例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#15-prometheus作业与实例&#34;&gt;#&lt;/a&gt; 1.5 Prometheus 作业与实例&lt;/h5&gt;
&lt;p&gt;在 Prometheus 中，被监控的每⼀个对象都称为实例（Instance） 实例代表着⼀个独⽴的监控⽬标，它由 IP 地址加端⼝号组合⽽成，&lt;/p&gt;
&lt;p&gt;如 localhost:9090 。在 Prometheus 的配置中，这些实例也可以被称为” ⽬标（Target）“或者 “端点（Endpoint）”。&lt;/p&gt;
&lt;p&gt;为了⽅便管理这些⽬标实例，我们通常会将功能相似或者类型相同的（实例 Instance）归纳到⼀个 “作业（Job）” 中。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;实例（Instances）：实例指的是⼀个被监控的端点。它通常是指向⼀个运⾏的服务或应⽤程序的进程，每个实例都以 host:port 进⾏标识。例如，⼀个 MySQL 数据库服务运⾏在 10.0.0.51:3306 上，那么它就是⼀个实例。&lt;/li&gt;
&lt;li&gt;作业（Jobs）：作业是⼀组具有相同类型的实例集合。例如，多个分布在不同服务器上 MySQL 应⽤，你可以将这些实例归类为同⼀个 mysql 的 Job 作业，⽽后按照 Job 分组后的维度进⾏分析。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/cFCOs3e.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;在 Prometheus 的数据模型中，job 和 instance 是两个核⼼的标签，它们会⾃动附加到所有收集的时间序列数据上。如下所示：&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 查询&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;cpu_usage&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;cpu_usage&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node-exporter&#34;&lt;/span&gt;,instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;10.0.0.7&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;14.04&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;cpu_usage&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node-exporter&#34;&lt;/span&gt;,instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;10.0.0.8&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;12.04&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;cpu_usage&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;job&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node-exporter&#34;&lt;/span&gt;,instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;10.0.0.9&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;16.04&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;16-prometheus架构&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#16-prometheus架构&#34;&gt;#&lt;/a&gt; 1.6 Prometheus 架构&lt;/h5&gt;
&lt;p&gt;Prometheus 最为核⼼的功能就是 “数据采集” 和 “数据存储”。但是，仅有这两项功能并不能构成⼀个完整的监控系统。因此，Prometheus 需要与其他的组件进⾏结合，从⽽实现数据的分析、展示和告警，因此⼀个完整意义上的监控系统⼤体需要如下 5 个组成部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、数据采集：Prometheus 采⽤ Pull 模式主动向被监控端抓取指标数据。被监控端可以是直接暴露出的应⽤程序指标数据，也可以是通过安装 Exporter 来抓取和暴露应⽤程序的数据。只要是以 Prometheus 格式提供的指标数据，都可以被 Prometheus 抓取。&lt;/li&gt;
&lt;li&gt;2、数据存储：Prometheus 会将抓取到的数据，存储在本地的时间序列数据库中，以防⽌数据丢失。&lt;/li&gt;
&lt;li&gt;3、数据查询和分析：Prometheus 内置了强⼤的查询语⾔ PromQL，⽤户可以通过 PromQL 查询存储在 Prometheus 上的时序数据，进⾏实时查询和分析。同时 PromQL ⽀持多种聚合操作和数学运算，可以对数据进⾏深⼊分析。&lt;/li&gt;
&lt;li&gt;4、告警系统：Prometheus 的告警分为了两个部分组成，告警规则和 Alertmanager。告警规则定义在 Prometheus 服务器中，根据⽤户指定的条件触发告警。当告警触发时，Prometheus 服务器会将告警信息发送给 Alertmanager。Alertmanager 会对告警信息进⾏去重、分组，然后将告警消息通过媒介发送给接收者（如邮件、钉钉等）。&lt;/li&gt;
&lt;li&gt;5、数据可视化：Prometheus 内置了⼀个简单的图形界⾯，⽤户可以在 Web 浏览器中使⽤ PromQL 查询时序数据，并将查询结果以图形的形式展示出来。此外，Prometheus 还可以与第三⽅可视化⼯具（如 Grafana）集成，提供更丰富的可视化功能。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;了解 Prometheus ⽣态中的各个组件后，我们可以概括其⼯作流程：⽬标发现、数据抓取、存储、分析、告警和展示。这些步骤共同构成了 Prometheus 强⼤的监控和告警系统。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/cZ48728.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、⽬标发现：在开始监控之前，Prometheus 需要确定监控⽬标。它可以通过静态的配置⽂件指定，或者利⽤服务发现机制动态地发现需要监控的服务。例如，在 Kubernetes 环境中，Prometheus 能够⾃动识别并监控集群中的服务，确保随着集群的变化，监控⽬标始终是最新的。&lt;/li&gt;
&lt;li&gt;2、数据抓取：有了明确的监控⽬标后，Prometheus 通过 HTTP 协议定期从这些⽬标的 /metrics 端点抓取指标数据。这些端点暴露了各种监控指标。&lt;/li&gt;
&lt;li&gt;3、数据存储：数据抓取后会存储在本地的时间序列数据库中。&lt;/li&gt;
&lt;li&gt;4、数据分析：数据⼀旦被存储，就可以⽤ PromQL 查询语⾔，对其进⾏分析。⽆论是实时监控还是历史数据分析，PromQL 都能提供丰富的数据聚合功能，以洞察系统的状况。&lt;/li&gt;
&lt;li&gt;5、告警：Prometheus 根据预定义的规则进⾏评估。当监控的指标达到告警阈值时，Prometheus 会将告警信息发送给 Alertmanager，由 Alertmanager 进⾏告警处理并通知。&lt;/li&gt;
&lt;li&gt;6、数据可视化：Prometheus ⾃带了简单的 UI。但对于更⾼级的数据可视化需求，通常会整合 Grafana 这样的⼯具来为⽤户提供直观的数据展现⽅式。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;17-prometheus数据模型&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#17-prometheus数据模型&#34;&gt;#&lt;/a&gt; 1.7 Prometheus 数据模型&lt;/h5&gt;
&lt;p&gt;Prometheus 中最为重要的是，对指标进⾏抓取和存储，这些存储下来的数据可以帮助我们分析趋势，或预测未来。为了更有⾼效的存储和查询这些数据，Prometheus 使⽤了⼀种叫 &amp;quot;时间序列&amp;quot; 的数据格式进⾏存储，所谓时间序列就是按照时间顺序记录所采集到的指标以及指标数据。⽽每个时间序列都是由 “⼀个指标名称加⼀堆标签” 所组成的⼀条唯⼀序列标识，其格式 &amp;quot;&amp;lt;metric_name&amp;gt;{&amp;lt;label_name&amp;gt;=&amp;lt;label_value&amp;gt;, &amp;lt;label_name&amp;gt;=&amp;lt;label_value&amp;gt;, ...} @&lt;timestamp&gt; &lt;value&gt;&amp;quot;&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 查询 node01 节点的各 CPU 核⼼使⽤率&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;cpu_usage&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node01.oldxu.net&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;cpu_usage&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node01.oldxu.net&#34;&lt;/span&gt;,core&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;7.535&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;cpu_usage&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node01.oldxu.net&#34;&lt;/span&gt;,core&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;1&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;7.535&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 查询 node02 节点，核⼼为 0 的 CPU 使⽤率&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;cpu_usage&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node02.oldxu.net&#34;&lt;/span&gt;,core&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 结果&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;cpu_usage&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;instance&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;node01.oldxu.net&#34;&lt;/span&gt;,core&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;8.025&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;二-prometheus安装&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#二-prometheus安装&#34;&gt;#&lt;/a&gt; 二、Prometheus 安装&lt;/h4&gt;
&lt;p&gt;Prometheus 支持多种安装方式，为了便于理解，我们先使用二进制方式进行部署，后期在使用 Kubernetes 方式进行部署。&lt;/p&gt;
&lt;h5 id=&#34;21-环境准备&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#21-环境准备&#34;&gt;#&lt;/a&gt; 2.1 环境准备&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;IP 地址&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;主机名名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;系统版本&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;内核版本&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;CPU&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;内存&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.221&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node01.oldxu.net&#34;&gt;prom-node01.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Centos7.9&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;3.10.0-957.el7.x86_64&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2Core&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.222&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node02.oldxu.net&#34;&gt;prom-node02.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Centos7.9&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;3.10.0-957.el7.x86_64&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2Core&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.223&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node03.oldxu.net&#34;&gt;prom-node03.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Centos7.9&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;3.10.0-957.el7.x86_64&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2Core&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.224&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node04.oldxu.net&#34;&gt;prom-node04.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Centos7.9&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;3.10.0-957.el7.x86_64&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2Core&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.225&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node05.oldxu.net&#34;&gt;prom-node05.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Centos7.9&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;3.10.0-957.el7.x86_64&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2Core&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2G&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h5 id=&#34;22-配置host解析&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#22-配置host解析&#34;&gt;#&lt;/a&gt; 2.2 配置 Host 解析&lt;/h5&gt;
&lt;p&gt;1、配置 hosts 解析&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;192.168.40.221 prom-node01.oldxu.net&#34;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&gt;&lt;/span&gt; /etc/hosts&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;192.168.40.222 prom-node02.oldxu.net&#34;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&gt;&lt;/span&gt; /etc/hosts&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;192.168.40.223 prom-node03.oldxu.net&#34;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&gt;&lt;/span&gt; /etc/hosts&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;192.168.40.224 prom-node04.oldxu.net&#34;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&gt;&lt;/span&gt; /etc/hosts&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token builtin class-name&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;192.168.40.225 prom-node05.oldxu.net&#34;&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;&gt;&gt;&lt;/span&gt; /etc/hosts&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、推送 hosts 解析文件，确保每个节点都能正常通过主机名进行访问&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;token for-or-select variable&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;222&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;225&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;do&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token function&#34;&gt;scp&lt;/span&gt; /etc/hosts root@192.168.40.&lt;span class=&#34;token variable&#34;&gt;$i&lt;/span&gt;:/etc/hosts&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;done&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;23-下载prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#23-下载prometheus&#34;&gt;#&lt;/a&gt; 2.3 下载 Prometheus&lt;/h5&gt;
&lt;p&gt;1、访问 Prometheus 官网 ﻿https://prometheus.io/download/﻿下载 Prometheus&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://github.com/prometheus/prometheus/releases/download/v2.49.1/prometheus-2.49.1.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 加速地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/prometheus/prometheus/releases/download/v2.49.1/prometheus-2.49.1.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、解压 Prometheus 至指定目录&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf prometheus-2.49.1.linux-amd64.tar.gz -C /etc&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/prometheus-2.49.1.linux-amd64/ /etc/prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、执行 ﻿prometheus --version﻿ 查看命令是否正常&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/prometheus --version&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;prometheus, version &lt;span class=&#34;token number&#34;&gt;2.49&lt;/span&gt;.1 &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;branch: HEAD, revision: 43e14844a33b65e2a396e3944272af8b3a494071&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  build user:       root@6d5f4c649d25&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  build date:       &lt;span class=&#34;token number&#34;&gt;20240115&lt;/span&gt;-16:58:43&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  go version:       go1.21.6&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  platform:         linux/amd64&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  tags:             netgo,builtinassets,stringlabels&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;24-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#24-配置prometheus&#34;&gt;#&lt;/a&gt; 2.4 配置 Prometheus&lt;/h5&gt;
&lt;p&gt;1、在启动 Prometheus 之前，我们需要准备一个 Prometheus 的配置文件，监控目标服务。由于 Prometheus 服务本身对外暴露了 Metrics 指标接口，所以我们可以配置 Prometheus 监控自身，保存一个名为 prometheus.yml 的文件，替换掉默认的配置文件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cp /etc/prometheus/prometheus.yml /etc/prometheus/prometheus.yml_bak&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、启动可以直接通过命令启动，但直接这么启动不是很方便，因此我们可以准备一个专属的启动文件&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/prometheus --config.file=/etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;25-启动prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#25-启动prometheus&#34;&gt;#&lt;/a&gt; 2.5 启动 Prometheus&lt;/h5&gt;
&lt;p&gt;1、配置 system 管理 Prometheus 启动和停止&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/prometheus.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;Prometheus server&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;root&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/prometheus/prometheus &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--config.file&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/prometheus/prometheus.yml &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--storage.tsdb.path&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/prometheus/data &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--storage.tsdb.retention.time&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;60d &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--web.enable-lifecycle&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$MAINPID&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;on-failure&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;RestartSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;20&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;20&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;SendSIGKILL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;no&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;LimitNOFILE&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;8192&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、在启动 Prometheus 服务时通过参数传递了一些配置选项，它们定义了 Prometheus 服务的一些关键行为。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;--config.file&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/prometheus/prometheus.yml &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 的配置文件路径。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;--storage.tsdb.path&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/prometheus/data &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 存储时间序列数据库（TSDB）的路径。用于存放 Prometheus 抓取到的指标数据。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;--storage.tsdb.retention.time&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;60d &lt;span class=&#34;token comment&#34;&gt;# 配置 Prometheus 的数据保留期限。超过这个时间范围的旧数据将被删除。这个可以根据存储资源和监控需求进行调整。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--web.enable-lifecycle &lt;span class=&#34;token comment&#34;&gt;# 允许通过 HTTP 请求的方式来更新 Prometheus 的配置。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、启动 Prometheus 服务&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start prometheus&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp |grep 9090&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::9090                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;2057&lt;/span&gt;/prometheus&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#通过 HTTP 请求的方式来热更新 Prometheus 的配置文件&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;26-访问prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#26-访问prometheus&#34;&gt;#&lt;/a&gt; 2.6 访问 Prometheus&lt;/h5&gt;
&lt;p&gt;1、通过访问对应服务的 IP:9090 端口，访问 Prometheus 的 UI 界面&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/V68yeDl.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;27-prometheus的webui&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#27-prometheus的webui&#34;&gt;#&lt;/a&gt; 2.7 Prometheus 的 WebUI&lt;/h5&gt;
&lt;p&gt;Prometheus 的 Web UI 提供了多个页面，以便用户可以查询指标、查看配置和状态，以及管理告警等。以下是 Prometheus Web UI 中常见的几个页面及其描述：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Graph: 允许用户通过 Prometheus 的查询语言 PromQL 来查询数据，并将结果以图形的形式展示。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Alerts：允许用户查看当前配置的告警规则以及每个告警的状态。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Status：页面包含了几个子页面，它们提供了关于 Prometheus 服务器本身的各种信息：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Command-Line Flags: 显示了 Prometheus 启动时使用的命令行参数。这有助于了解 Prometheus 的配置和运行状态。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Configuration: 展示了 Prometheus 当前加载的配置文件内容，可以用来确认 Prometheus 正在使用的配置，有助于调试问题。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Targets: 显示了 Prometheus 监控的采集目标列表，包括每个目标的健康状态。如果某个目标无法抓取，这里也会显示相关的错误信息。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Rules: 显示所有配置的告警和记录规则。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Service Discovery: 展示了 Prometheus 的服务发现状态，这包括了 Prometheus 如何发现抓取目标，以及它们的当前状态和元数据信息。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;三-安装grafana图形展示&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#三-安装grafana图形展示&#34;&gt;#&lt;/a&gt; 三、安装 Grafana 图形展示&lt;/h4&gt;
&lt;h5 id=&#34;31-grafana介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#31-grafana介绍&#34;&gt;#&lt;/a&gt; 3.1 Grafana 介绍&lt;/h5&gt;
&lt;p&gt;Grafana 是一款开源的数据分析和可视化工具，从 2.5.0 版本开始，Grafana 已经内置了对 Prometheus 的支持，可以直接将 Prometheus 作为数据源进行查询和展示。&lt;/p&gt;
&lt;h5 id=&#34;32-grafana安装&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#32-grafana安装&#34;&gt;#&lt;/a&gt; 3.2 Grafana 安装&lt;/h5&gt;
&lt;p&gt;1、访问 Grafana 官网 ﻿https://grafana.com/grafana/download﻿，下载 Grafana&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://dl.grafana.com/enterprise/release/grafana-enterprise-10.3.1-1.x86_64.rpm&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、安装并启动 Grafana&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum localinstall grafana-enterprise-10.3.1-1.x86_64.rpm -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start grafana-server &amp;amp;&amp;amp; systemctl enable grafana-server&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp |grep 3000&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::3000                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;1787&lt;/span&gt;/grafana&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、访问 Grafana，通过﻿http://IP:3000﻿，默认 Grafana 用户名为﻿admin﻿，密码为﻿admin&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/kBj2SIo.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;4、点击左边菜单选择﻿Administration--&amp;gt;Default Preferences﻿（偏好设置）在﻿Language﻿选项中选择﻿简体中文﻿然后﻿Save﻿.&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/Xccw96a.png&#34; alt=&#34;1.png&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;33-配置grafana数据源&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#33-配置grafana数据源&#34;&gt;#&lt;/a&gt; 3.3 配置 Grafana 数据源&lt;/h5&gt;
&lt;p&gt;1、配置 Grafana 数据源为 Prometheus，点击菜单，选择﻿Connections--&amp;gt;Data sources--&amp;gt; 选择 Prometheus&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/0CLhNrE.jpeg&#34; alt=&#34;5.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;2、导入 Grafana 默认监控 Prometheus 的 Dashboards，该 Dashboard 主要用于监控 Prometheus 服务器本身的性能和状态指标。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/ZsFdwXb.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3、通过图形界面展示 Prometheus 的数据指标；&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/ZsFdwXb.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;34-配置prometheus监控grafana&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#34-配置prometheus监控grafana&#34;&gt;#&lt;/a&gt; 3.4 配置 Prometheus 监控 Grafana&lt;/h5&gt;
&lt;p&gt;Grafana 作为一个广泛使用的可视化工具，其实也需要被监控。幸运的是 Grafana 本身提供了一个内置的指标端点。通过访问 ﻿http://&amp;lt;grafana-ip:3000/metrics﻿，你可以获取到 Grafana 的性能指标。这些指标包括了 HTTP 请求统计、内存使用情况、图形的数量，活跃用户数等指标，它们对于监控 Grafana 的健康状况非常有帮助。&lt;/p&gt;
&lt;p&gt;1、访问 Grafana 对外暴露指标的 Metrics 接口，如果没有问题，会看到一系列的指标数据&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -s http://prom-node01.oldxu.net:3000/metrics| tail -10&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE prometheus_template_text_expansions_total counter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;prometheus_template_text_expansions_total &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP promhttp_metric_handler_requests_in_flight Current number of scrapes being served.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE promhttp_metric_handler_requests_in_flight gauge&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;promhttp_metric_handler_requests_in_flight &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP promhttp_metric_handler_requests_total Total number of scrapes by HTTP status code.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE promhttp_metric_handler_requests_total counter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;promhttp_metric_handler_requests_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;200&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;promhttp_metric_handler_requests_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;500&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;promhttp_metric_handler_requests_total&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;code&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;503&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、配置 Prometheus，将 Grafana 作为一个监控目标（target）添加到配置中。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/prometheus/promtool check config /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Checking /etc/prometheus/prometheus.yml&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt; SUCCESS: /etc/prometheus/prometheus.yml is valid prometheus config &lt;span class=&#34;token function&#34;&gt;file&lt;/span&gt; syntax&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、访问 Prometheus，在 Status 中的 Targets 页面，能看到新添加的 grafana 目标；如果 State 显示 UP，说明 Prometheus 正在从 Grafana 抓取指标。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/Wh5m6k9.jpeg&#34; alt=&#34;8.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;4、接下来可以在 Grafana 中创建一个（Dashboard），也可以使用之前配置 Prometheus 导入的 Grafana 模板，这样就可以直观地展示被监控的 Grafana 服务状态；&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/9IFFRtb.jpeg&#34; alt=&#34;7.jpg&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;四-配置prometheus监控node节点&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#四-配置prometheus监控node节点&#34;&gt;#&lt;/a&gt; 四、配置 Prometheus 监控 Node 节点&lt;/h4&gt;
&lt;h5 id=&#34;41-如何监控node节点&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#41-如何监控node节点&#34;&gt;#&lt;/a&gt; 4.1 如何监控 Node 节点&lt;/h5&gt;
&lt;p&gt;监控节点（如服务器或者虚拟机）通常涉及收集硬件和操作系统层面的指标，比如 CPU 使用率、内存占用、磁盘 I/O、网络流量等。但是这些指标并不能直接被 Prometheus 抓取，因此我们需要借助 Node exporter 将对应的指标转为 Prometheus 能够兼容的指标格式，并对外提供 HTTP 接口暴露给 Prometheus 进行指标抓取。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;监控地址规划：&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;IP 地址&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;主机名名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;系统版本&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;内核版本&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;CPU&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;内存&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.221&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node01.oldxu.net&#34;&gt;prom-node01.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Centos7.9&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;3.10.0-957.el7.x86_64&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2Core&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.222&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node02.oldxu.net&#34;&gt;prom-node02.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Centos7.9&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;3.10.0-957.el7.x86_64&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2Core&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2G&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;192.168.40.223&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;a href=&#34;http://prom-node03.oldxu.net&#34;&gt;prom-node03.oldxu.net&lt;/a&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Centos7.9&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;3.10.0-957.el7.x86_64&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2Core&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;2G&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h5 id=&#34;42-安装node_exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#42-安装node_exporter&#34;&gt;#&lt;/a&gt; 4.2 安装 node_exporter&lt;/h5&gt;
&lt;p&gt;1、访问 Node-exporter 的 github，获取 Node-exporter 的下载地址， ﻿https://github.com/prometheus/node_exporter/releases/&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 加速地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget https://mirror.ghproxy.com/https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 推送给其他节点&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;token for-or-select variable&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;222&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;225&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;do&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token function&#34;&gt;scp&lt;/span&gt; node_exporter-1.7.0.linux-amd64.tar.gz root@192.168.40.&lt;span class=&#34;token variable&#34;&gt;$i&lt;/span&gt;:~&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;done&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、解压 node-exporter&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tar xf node_exporter-1.7.0.linux-amd64.tar.gz -C /etc&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ln -s /etc/node_exporter-1.7.0.linux-amd64/ /etc/node_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ll /etc/node_exporter/&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;total &lt;span class=&#34;token number&#34;&gt;19476&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-rw-r--r-- &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1001&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1002&lt;/span&gt;    &lt;span class=&#34;token number&#34;&gt;11357&lt;/span&gt; Nov &lt;span class=&#34;token number&#34;&gt;13&lt;/span&gt; 08:02 LICENSE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-rwxr-xr-x &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1001&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1002&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;19925095&lt;/span&gt; Nov &lt;span class=&#34;token number&#34;&gt;13&lt;/span&gt; 07:54 node_exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-rw-r--r-- &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1001&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1002&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;463&lt;/span&gt; Nov &lt;span class=&#34;token number&#34;&gt;13&lt;/span&gt; 08:02 NOTICE&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;43-配置node_exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#43-配置node_exporter&#34;&gt;#&lt;/a&gt; 4.3 配置 node_exporter&lt;/h5&gt;
&lt;p&gt;启动 Node Exporter 即可开始进行指标采集，它默认启用了一些常见的收集器以监控 CPU、内存、网络等关键指标。然而，由于每个操作系统对收集器的支持程度不同，Node Exporter 也提供了一些 &amp;quot;默认未启用的收集器&amp;quot;。我们可以根据监控需求，通过特定的参数来启用这些收集器。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;要禁用默认激活的收集器，可以使用参数 ﻿--no-collector.&lt;name&gt;&lt;/li&gt;
&lt;li&gt;要启用默认未激活的收集器，可以使用参数﻿--collector.&lt;name&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果只想启动某些特定的收集器，可以使用 ﻿--collector.disable-defaults﻿标志禁用所有默认的，然后在指定具体要启用收集器 ﻿--collector.&amp;lt;name﻿ 来进行收集。&lt;/p&gt;
&lt;p&gt;&lt;em&gt;默认关闭一些收集器的原因在于，有些指标采集需要占用过多资源开销、太重、太慢；所以谨慎开启；&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;1、例如，禁止默认启动的 arp 的采集&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 直接启动会发现有 arp 采集&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/node_exporter/node_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;.&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:21:35.150Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:117 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;collector&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;arp&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 禁用 arp 收集器，就看不到了&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/node_exporter/node_exporter --no-collector.arp&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、启用默认未激活的﻿tcpstat﻿收集器&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/node_exporter/node_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/node_exporter/node_exporter --collector.tcpstat&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;.&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:23:34.296Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:117 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;collector&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;tcpstat&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、也可以禁用所有收集器，仅启用那些只想启用的收集器&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# /etc/node_exporter/node_exporter --collector.disable-defaults --collector.cpu --collector.meminfo --collector.diskstats --collector.netstat&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.969Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:192 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Starting node_exporter&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;(version=1.7.0, branch=HEAD, revision=7333465abf9efba81876303bb57e6fadb946041b)&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.969Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:193 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Build context&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;build_context&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;(go=go1.21.4, platform=linux/amd64, user=root@35918982f6d8, date=20231112-23:53:35, tags=netgo osusergo static_build)&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.969Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:195 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;warn &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Node Exporter is running as root user. This exporter is designed to run as unprivileged user, root is not required.&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.970Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;diskstats_common.go:111 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;collector&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;diskstats &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Parsed flag --collector.diskstats.device-exclude&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;flag&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;^&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;ram&lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;loop&lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;fd&lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;h&lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;s&lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;token function&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;xv&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;d&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;a-z&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;nvme&lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;d+n&lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;d+p&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;d+$&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.970Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:110 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Enabled collectors&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.970Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:117 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;collector&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;cpu&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.970Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:117 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;collector&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;diskstats&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.970Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:117 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;collector&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;meminfo&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.970Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter.go:117 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;collector&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;netstat&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.970Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;tls_config.go:274 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Listening on&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;::&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;:9100&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt;-02-22T13:25:37.970Z &lt;span class=&#34;token assign-left variable&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;tls_config.go:277 &lt;span class=&#34;token assign-left variable&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;info &lt;span class=&#34;token assign-left variable&#34;&gt;msg&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;TLS is disabled.&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;http2&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;false &lt;span class=&#34;token assign-left variable&#34;&gt;address&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;::&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;:9100&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;44-启动node_exporter&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#44-启动node_exporter&#34;&gt;#&lt;/a&gt; 4.4 启动 node_exporter&lt;/h5&gt;
&lt;p&gt;1、配置 system 管理 Prometheus 启动和停止&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /usr/lib/systemd/system/node_exporter.service&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Unit&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;node_exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;https://prometheus.io/&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;network.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Service&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/etc/node_exporter/node_exporter &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --web.listen-address&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;:9100 &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  --web.max-requests&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;40&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--collector.mountstats&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--collector.systemd&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--collector.ethtool&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;\&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token parameter variable&#34;&gt;--collector.tcpstat&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ExecReload&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&#34;token parameter variable&#34;&gt;-HUP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TimeoutStopSec&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;20s&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;Restart&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;always&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;Install&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;multi-user.target&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、启动 node-exporter&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl daemon-reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start node_exporter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -lntp|grep 9100&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; :::9100                 :::*                    LISTEN      &lt;span class=&#34;token number&#34;&gt;6340&lt;/span&gt;/node_exporter&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、访问对应的 metrics，验证是否能采集到数据&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -s http://localhost:9100/metrics |head -10&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# TYPE go_gc_duration_seconds summary&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;.066e-05&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0.25&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;.523e-05&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0.5&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;.7351e-05&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;0.75&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;.9952e-05&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;quantile&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;1&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.000122787&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds_sum &lt;span class=&#34;token number&#34;&gt;0.000496506&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;go_gc_duration_seconds_count &lt;span class=&#34;token number&#34;&gt;11&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# HELP go_goroutines Number of goroutines that currently exist.&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;45-配置prometheus&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#45-配置prometheus&#34;&gt;#&lt;/a&gt; 4.5 配置 Prometheus&lt;/h5&gt;
&lt;p&gt;1、修改 Prometheus 配置，添加新的 Job 分组，然后将对应的节点纳入监控中；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/prometheus/prometheus.yml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 全局段定义&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;global:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  scrape_interval: 15s &lt;span class=&#34;token comment&#34;&gt;# 设置 Prometheus 抓取指标数据的间隔，默认为 15 秒。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 抓取指定的目标&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;scrape_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;prometheus&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 定义一个抓取任务，名为 &#39;prometheus&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt; &lt;span class=&#34;token comment&#34;&gt;# 指定 Prometheus 从监控目标暴露的 HTTP 端点路径抓取指标，默认为 &#39;/metrics&#39;。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs: &lt;span class=&#34;token comment&#34;&gt;# 配置静态目标地址，Prometheus 将定期从如下这些地址抓取指标。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9090&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;grafana&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:3000&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  - job_name: &lt;span class=&#34;token string&#34;&gt;&#34;node_exporter&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    metrics_path: &lt;span class=&#34;token string&#34;&gt;&#34;/metrics&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    static_configs:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    - targets: &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;prom-node01.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node02.oldxu.net:9100&#34;&lt;/span&gt;,&lt;span class=&#34;token string&#34;&gt;&#34;prom-node03.oldxu.net:9100&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、重新加载 Prometheus&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@prom-node01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -v -X POST http://localhost:9090/-/reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;* About to connect&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; to localhost port &lt;span class=&#34;token number&#34;&gt;9090&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#0)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;*   Trying ::1&lt;span class=&#34;token punctuation&#34;&gt;..&lt;/span&gt;.&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;* Connected to localhost &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;::1&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; port &lt;span class=&#34;token number&#34;&gt;9090&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#0)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; POST /-/reload HTTP/1.1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; User-Agent: curl/7.29.0&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; Host: localhost:9090&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; Accept: */*&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; HTTP/1.1 &lt;span class=&#34;token number&#34;&gt;200&lt;/span&gt; OK&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; Date: Thu, &lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt; Feb &lt;span class=&#34;token number&#34;&gt;2024&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;13&lt;/span&gt;:35:56 GMT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; Content-Length: &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;* Connection &lt;span class=&#34;token comment&#34;&gt;#0 to host localhost left intact&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、检查 Prometheus 是否已将对应节点纳入监控（点击 Status--&amp;gt;Targets）&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/ClR3Pyh.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;46-导入grafana模板&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#46-导入grafana模板&#34;&gt;#&lt;/a&gt; 4.6 导入 Grafana 模板&lt;/h5&gt;
&lt;p&gt;在 Grafana 的官方插件库中，有很多 Node-exporter 模板。其中相对受欢的模板的 ID 是： ﻿11074、1860﻿。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;11074﻿：模板包括了 CPU、内存、磁盘、网络、温度传感器等指标（常用）。&lt;/li&gt;
&lt;li&gt;1860﻿：模板包括 CPU、内存、磁盘、网络等。这运行状况，及时发现潜在问题并进行调优。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/oqN9oVU.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;五-node_exporter常用指标&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#五-node_exporter常用指标&#34;&gt;#&lt;/a&gt; 五、node_exporter 常用指标&lt;/h4&gt;
&lt;h5 id=&#34;51-cpu与内存相关指标&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#51-cpu与内存相关指标&#34;&gt;#&lt;/a&gt; 5.1 CPU 与内存相关指标&lt;/h5&gt;
&lt;p&gt;1、CPU 负载相关核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_load1&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;过去 1 分钟的系统平均负载。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_load5&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;过去 5 分钟的系统平均负载。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_load15&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;过去 1 5 分钟的系统平均负载。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;2、CPU 使用相关核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_cpu_seconds_total&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Counter&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;CPU 在不同模式下使用的时间（以秒为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;3、内存相关核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_memory_MemTotal_bytes&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;系统总内存量（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_memory_MemAvailable_bytes&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;系统当前可用的内存量（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_memory_Cached_bytes&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;系统缓存使用的内存（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_memory_Buffers_bytes&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;用于缓冲使用的内存（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;计算可用内存百分比： node_memory_MemAvailable_bytes /node_memory_MemTotal_bytes * 100&lt;/p&gt;
&lt;p&gt;计算已用内存百分比：(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) /node_memory_MemTotal_bytes *&lt;br /&gt;
100&lt;/p&gt;
&lt;p&gt;4、SWAP 相关核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_memory_SwapTotal_bytes&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;系统交换空间总量（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_memory_SwapFree_bytes&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;系统未被使用的交换空间（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h5 id=&#34;52-磁盘与网络相关指标&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#52-磁盘与网络相关指标&#34;&gt;#&lt;/a&gt; 5.2 磁盘与网络相关指标&lt;/h5&gt;
&lt;p&gt;1、磁盘空间相关核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_filesystem_size_bytes&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;文件系统大小（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_filesystem_avail_bytes&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;文件系统可用空间（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;计算可用空间百分比： node_filesystem_avail_bytes /node_filesystem_size_bytes * 100&lt;/p&gt;
&lt;p&gt;计算已用空间百分比：(node_filesystem_size_bytes - node_filesystem_avail_bytes) /node_filesystem_size_bytes * 100&lt;/p&gt;
&lt;p&gt;2、磁盘 Inode 相关核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_filesystem_files&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;文件系统中 inode 能使用的总数。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_filesystem_files_free&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;文件系统中空闲 inode 的数量。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;计算已用的 Inode 百分比： (node_filesystem_files - node_filesystem_files_free) /node_filesystem_files * 100&lt;/p&gt;
&lt;p&gt;3、磁盘 IO 吞吐量相关核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_disk_read_bytes_total&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Counter&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;从给定设备读取的总字节数。（以字节为单位）。（使用 irate 可以得到每秒写入大小）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_disk_written_bytes_total&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Counter&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;向给定设备写入的总字节数。（以字节为单位）。（使用 irate 可以得到每秒写入大小）&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;4、磁盘 IOPS 相关核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_disk_reads_completed_total&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Counter&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;磁盘设备完成的读操作总数。（使用 irate 可以得到每秒读操作的平均数）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_disk_writes_completed_total&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Counter&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;磁盘设备完成的写操作总数。（使用 irate 可以得到每秒读操作的平均数）&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;5、网络核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_network_receive_bytes_total&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Counter&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;网络接口接收到的总字节数。（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_network_transmit_bytes_total&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;Counter&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;网络接口发送出去的总字节数。（以字节为单位）。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;6、连接追踪核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_nf_conntrack_entries&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;系统正在跟踪的网络连接的数量。这包括所有类型的连接 TCP， UDP、ICMP 等&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_nf_conntrack_entries_limit&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;系统 conntrack 能够跟踪的网络连接的最大数量。读取的是 /proc/sys/net/netfilter/nf_conntrack_max，内核参数为：net.netfilter.nf_conntrack_max）&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;计算连接追踪使用百分比： node_nf_conntrack_entries /node_nf_conntrack_entries_limit * 100&lt;/p&gt;
&lt;h5 id=&#34;53-tcp与其他相关指标&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#53-tcp与其他相关指标&#34;&gt;#&lt;/a&gt; 5.3 TCP 与其他相关指标&lt;/h5&gt;
&lt;p&gt;1、TCP 相关核心指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34; state=&#34;time_wait&#34;&gt;node_tcp_connection_states&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;当前已断开的 TCP 连接数。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34; state=&#34;established&#34;&gt;node_tcp_connection_states&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;当前建立的 TCP 连接数。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;2、文件描述符&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_filefd_maximum&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;当前系统最大可用的文件描述符数量（由 fs.file-max 内核参数设定，具体读取的文件 /proc/sys/fs/file-max）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_filefd_allocated&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;当前系统已经分配的文件描述符的数量。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;当前文件描述符已使用百分比 ：(node_filefd_allocated /node_filefd_maximum) * 100&lt;/p&gt;
&lt;p&gt;3、系统其他指标&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标名称&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;指标类型&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_time_seconds&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;当前系统的时间戳&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;node_boot_time_seconds&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;gauge&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;系统最后一次启动的时间戳。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;系统自启动以来，总共运行了多少天 = (node_time_seconds - node_boot_time_seconds)/ 86400&lt;/p&gt;
</content>
        <category term="Prometheus" />
        <updated>2025-06-26T02:33:41.000Z</updated>
    </entry>
</feed>
