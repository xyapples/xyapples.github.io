{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"tomcat\" tag",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/754945111.html",
            "url": "http://ixuyong.cn/posts/754945111.html",
            "title": "Tomcat JVM调优实践",
            "date_published": "2025-06-08T02:51:57.000Z",
            "content_html": "<h3 id=\"tomcat-jvm调优实践\"><a class=\"anchor\" href=\"#tomcat-jvm调优实践\">#</a> Tomcat JVM 调优实践</h3>\n",
            "tags": [
                "Tomcat"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/4201058646.html",
            "url": "http://ixuyong.cn/posts/4201058646.html",
            "title": "Tomcat配置管理实践",
            "date_published": "2025-06-08T02:51:48.000Z",
            "content_html": "<h3 id=\"tomcat配置管理实践\"><a class=\"anchor\" href=\"#tomcat配置管理实践\">#</a> Tomcat 配置管理实践</h3>\n<h4 id=\"一-oraclejdk安装\"><a class=\"anchor\" href=\"#一-oraclejdk安装\">#</a> 一、OracleJdk 安装</h4>\n<p>OracleJdk 下载地址：<a href=\"https://www.oracle.com/java/technologies/downloads/#java8\">https://www.oracle.com/java/technologies/downloads/#java8</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf jdk-8u451-linux-x64.tar.gz -C /usr/local</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/jdk1.8.0_451/ /usr/local/jdk</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#添加环境变量</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/profile.d/jdk.sh</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JAVA_HOME</span><span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$JAVA_HOME</span>/bin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JRE_HOME</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/jre </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CLASSPATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/lib/:<span class=\"token variable\">$JRE_HOME</span>/lib/</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -version</span></pre></td></tr></table></figure><h4 id=\"二-tomcat安装\"><a class=\"anchor\" href=\"#二-tomcat安装\">#</a> 二、Tomcat 安装</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft &amp;&amp; cd /soft</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.106/bin/apache-tomcat-9.0.106.tar.gz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf apache-tomcat-9.0.106.tar.gz -C /soft</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /soft/apache-tomcat-9.0.106 /soft/tomcat</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># /soft/tomcat/bin/startup.sh</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep java</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">1765</span>/java           </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:8005          :::*                    LISTEN      <span class=\"token number\">1765</span>/javaa</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#Tomcat 启停配置文件</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/lib/systemd/system/tomcat.service</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># /usr/lib/systemd/system/tomcat.service</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Apache Tomcat</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>forking</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span>JAVA_HOME<span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span>CATALINA_HOME<span class=\"token operator\">=</span>/soft/tomcat</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span>CATALINA_BASE<span class=\"token operator\">=</span>/soft/tomcat</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/soft/tomcat/bin/startup.sh</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token assign-left variable\">ExecStop</span><span class=\"token operator\">=</span>/soft/tomcat/bin/shutdown.sh</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat      </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep java</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">1842</span>/java           </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:8005          :::*                    LISTEN      <span class=\"token number\">1842</span>/java</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Vc1v1lK.jpeg\" alt=\"Snipaste_2025-06-14_14-57-42.jpg\" /></p>\n<h4 id=\"三-tomcat配置\"><a class=\"anchor\" href=\"#三-tomcat配置\">#</a> 三、Tomcat 配置</h4>\n<h5 id=\"31-tomcat目录结构\"><a class=\"anchor\" href=\"#31-tomcat目录结构\">#</a> 3.1 Tomcat 目录结构</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bin\t\t：  二进制可执行（脚本文件 windwos版bat、linux版sh）</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conf\t：  配置文件，主配置是server.xml</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>lib\t\t：  都是一些java语言编写的jar包，这些都需要被调用，才能执行； module （jar、war）</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>logs\t：  tomcat的日志存放位置，可修改；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>temp\t：  tomcat的临时目录；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>webapps ：  相当于nginx中  root /soft/tomcat/webapps/     /soft/tomcat/webapps/ROOT</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>work\t<span class=\"token builtin class-name\">:</span>   tomcat的一个缓存目录；（java代码，编译为class字节码对外提供；）</pre></td></tr></table></figure><h5 id=\"32-tomcat配置文件说明\"><a class=\"anchor\" href=\"#32-tomcat配置文件说明\">#</a> 3.2 Tomcat 配置文件说明</h5>\n<ul>\n<li>server：表示一个 tomcat 实例；</li>\n<li>Listener：监听器；</li>\n<li>connector：连接器，支持 http、https、ajp 等协议请求；</li>\n<li>service：将 connector 与 engine 关联的组件；</li>\n<li>engine：具体 http、https 的请求与响应； （Nginx 中  http {}）</li>\n<li>host：与用户请求的 Host 字段进行比对；哪个 Host 匹配则哪个处理，如没有符合的则交给默认的 defaultHost 处理</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /soft/tomcat/conf/server.xml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"UTF-8\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--关闭tomcat的端口--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>Server <span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token string\">\"8005\"</span> <span class=\"token assign-left variable\">shutdown</span><span class=\"token operator\">=</span><span class=\"token string\">\"SHUTDOWN\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--监听器 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.startup.VersionLoggerListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.core.AprLifecycleListener\"</span> <span class=\"token assign-left variable\">SSLEngine</span><span class=\"token operator\">=</span><span class=\"token string\">\"on\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.core.JreMemoryLeakPreventionListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.core.ThreadLocalLeakPreventionListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--全局资源限制--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token operator\">&lt;</span>GlobalNamingResources<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Resource <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"UserDatabase\"</span> <span class=\"token assign-left variable\">auth</span><span class=\"token operator\">=</span><span class=\"token string\">\"Container\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.UserDatabase\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              <span class=\"token assign-left variable\">description</span><span class=\"token operator\">=</span><span class=\"token string\">\"User database that can be updated and saved\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              <span class=\"token assign-left variable\">factory</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.users.MemoryUserDatabaseFactory\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              <span class=\"token assign-left variable\">pathname</span><span class=\"token operator\">=</span><span class=\"token string\">\"conf/tomcat-users.xml\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/GlobalNamingResources<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--连接器--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Service <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"Catalina\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Connector <span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token string\">\"8080\"</span> <span class=\"token assign-left variable\">protocol</span><span class=\"token operator\">=</span><span class=\"token string\">\"HTTP/1.1\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>               <span class=\"token assign-left variable\">connectionTimeout</span><span class=\"token operator\">=</span><span class=\"token string\">\"20000\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>               <span class=\"token assign-left variable\">redirectPort</span><span class=\"token operator\">=</span><span class=\"token string\">\"8443\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--引擎--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Engine <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"Catalina\"</span> <span class=\"token assign-left variable\">defaultHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--调用限制--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Realm <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.realm.LockOutRealm\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Realm <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.realm.UserDatabaseRealm\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>               <span class=\"token assign-left variable\">resourceName</span><span class=\"token operator\">=</span><span class=\"token string\">\"UserDatabase\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Realm<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--虚拟主机--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"webapps\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token operator\">&lt;</span>/Engine<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/Service<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token operator\">&lt;</span>/Server<span class=\"token operator\">></span></pre></td></tr></table></figure><h5 id=\"33tomcat请求流程\"><a class=\"anchor\" href=\"#33tomcat请求流程\">#</a> 3.3Tomcat 请求流程</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ZU2ezrN.jpeg\" alt=\"2.jpg\" /></p>\n<p>假设来自用户的请求为：<a href=\"http://tomcat.hmallleasing.com:8080/index.jsp\">http://tomcat.hmallleasing.com:8080/index.jsp</a></p>\n<ul>\n<li>1. 服务端运行 Tomcat 应用，监听在本机的 8080 端口，等待连接；</li>\n<li>2. 浏览器发送 http 请求，并且请求服务端的 8080 端口，也就是 Tomcat 进程；</li>\n<li>3. 服务端通过 http connector 连接器获取请求，然后通过 service 将请求交给符合条件的 engine;</li>\n<li><a href=\"http://4.xn--Enginetomcat-4l2xh11ksszesu1a.hmallleasing.com:8080/index.jsp%EF%BC%8C%E9%81%8D%E5%8E%86%E5%AE%83%E6%89%80%E6%9C%89%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BAHost;\">4.Engine 获得请求 tomcat.hmallleasing.com:8080/index.jsp，遍历它所有虚拟主机 Host;</a></li>\n<li>5. 如果 Engine 匹配不到对应的 Host，就把请求交给 Engine 中的 defaultHost 处理；</li>\n<li>6. 如果 Engine 匹配到对应的 Host,  则提取该 Host 中指定的 appBase（代码存储路径）；</li>\n<li>7. 最后 Engine 将解析后的结果返回给 connector，connector 返回给浏览器；</li>\n</ul>\n<h5 id=\"35-tomcat与nginx对比\"><a class=\"anchor\" href=\"#35-tomcat与nginx对比\">#</a> 3.5 Tomcat 与 Nginx 对比</h5>\n<p>Nginx 中：</p>\n<ul>\n<li>http 层：只能有一个；</li>\n<li>server：可以有多个，多个表示多个站点；</li>\n<li>location：一个站点的多个 uri 的路径匹配</li>\n</ul>\n<p>Tomcat 中：</p>\n<ul>\n<li>engine：只能有一个，也是负责请求与响应的；</li>\n<li>Host：  可以有多个，多个表示多个站点；</li>\n<li>context：用来定义用户请求的 uri，将其调度到指定的目录中提取代码；</li>\n</ul>\n<h5 id=\"36-tomcat虚拟主机host\"><a class=\"anchor\" href=\"#36-tomcat虚拟主机host\">#</a> 3.6 Tomcat 虚拟主机 Host</h5>\n<ul>\n<li>name: 主机名称</li>\n<li>appBase：网站代码存放路径</li>\n<li>unpackWARs：自动解压 war 包</li>\n<li>autoDeploy：自动部署</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--tom1.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tom1.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/tom1\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr></table></figure><p>创建网站代码存放路径，写入测试代码，并重启 Tomcat；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/tom1/ROOT -p</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"Tomcat Test Page\" > /code/tom1/ROOT/index.html</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp;  systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ieCVXl0.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"37-tomcat虚拟主机context\"><a class=\"anchor\" href=\"#37-tomcat虚拟主机context\">#</a> 3.7 Tomcat 虚拟主机 Context</h5>\n<p>context 使用方式</p>\n<ul>\n<li>docBase: 站点存放的路径</li>\n<li>path: 访问站点的 URI 路径</li>\n<li>reloadable：修改了 jsp 文件，无需重启就可以实现显示的同步</li>\n</ul>\n<p>访问 http:/tom2.hamllleasing.com/zh-&gt; 映射 -&gt;/code/zh</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--tom1.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tom1.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/tom1\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Context <span class=\"token assign-left variable\">docBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/zh\"</span> <span class=\"token assign-left variable\">path</span><span class=\"token operator\">=</span><span class=\"token string\">\"/zh\"</span> <span class=\"token assign-left variable\">reloadable</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr></table></figure><p>注意：如果设定了 context，没有创建对应目录则无法启动 Tomcat</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f /soft/tomcat/logs/catalina.out</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tCaused by: java.lang.IllegalArgumentException: The main resource <span class=\"token builtin class-name\">set</span> specified <span class=\"token punctuation\">[</span>/code/zh<span class=\"token punctuation\">]</span> is not a directory or war file, or is not readable <span class=\"token punctuation\">(</span>it does not exist or permissions to access it are missing<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\tat org.apache.catalina.webresources.StandardRoot.createMainResourceSet<span class=\"token punctuation\">(</span>StandardRoot.java:758<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tat org.apache.catalina.webresources.StandardRoot.startInternal<span class=\"token punctuation\">(</span>StandardRoot.java:715<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tat org.apache.catalina.util.LifecycleBase.start<span class=\"token punctuation\">(</span>LifecycleBase.java:164<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>创建对应目录，写入测试代码，并重启 Tomcat</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"hello zh\" > /code/zh/index.html</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp;  systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/GoiPhZp.jpeg\" alt=\"2.jpg\" /></p>\n<h5 id=\"38-tomcat管理页面配置\"><a class=\"anchor\" href=\"#38-tomcat管理页面配置\">#</a> 3.8 Tomcat 管理页面配置</h5>\n<p>1、配置 Tomcat Bsic 认证，配置文件 /soft/tomcat/conf/tomcat-users.xml 最后添加用户，然后关联至对应资源的角色名称；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web03 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/tomcat-users.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token operator\">&lt;</span>role <span class=\"token assign-left variable\">rolename</span><span class=\"token operator\">=</span><span class=\"token string\">\"manager-gui,admin-gui\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token operator\">&lt;</span>user <span class=\"token assign-left variable\">username</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"123456\"</span> <span class=\"token assign-left variable\">roles</span><span class=\"token operator\">=</span><span class=\"token string\">\"manager-gui,admin-gui\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>/tomcat-users<span class=\"token operator\">></span></pre></td></tr></table></figure><p>2、由于 Tomcat 仅语序本地 127.0.0.1 进行 basic 认证，如果需要其他网段通过 basic 认证，还需配置允许访问规则。找到 webapps/ 项目 / META-INF/context.xml 配置；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改第一个项目</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/webapps/host-manager/META-INF/context.xml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>修改为：</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">allow</span><span class=\"token operator\">=</span><span class=\"token string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1|192\\.168\\.40\\.\\d+\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#2. 修改第二个项目</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim  /soft/tomcat/webapps/manager/META-INF/context.xml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>修改后：</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">allow</span><span class=\"token operator\">=</span><span class=\"token string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1|192\\.168\\.40\\.\\d+\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#3. 重启 tomcat</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gV1iMaz.jpeg\" alt=\"3.jpg\" /></p>\n<h4 id=\"四-tomcat部署zrlog\"><a class=\"anchor\" href=\"#四-tomcat部署zrlog\">#</a> 四、Tomcat 部署 zrlog</h4>\n<h5 id=\"41-zrlog单节点部署\"><a class=\"anchor\" href=\"#41-zrlog单节点部署\">#</a> 4.1 zrlog 单节点部署</h5>\n<h6 id=\"411-部署mysql\"><a class=\"anchor\" href=\"#411-部署mysql\">#</a> 4.1.1 部署 MySQL</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、关闭防火墙、selinux、环境配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname aizj_db01</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate git -y</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y --exclude=kernel* &amp;&amp; reboot</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 'Asia/Shanghai' >/etc/timezone</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/nul</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#2、安装 Mysql5.7</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y mysql-community-server</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@aizj_db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'localhost'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2023'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'zrlog'</span>@<span class=\"token string\">'192.168.40.%'</span> identified by <span class=\"token string\">'Superman*2023'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#3、允许 root 用户在任何地方进行远程登录，并具有所有库任何操作权限，具体操作如下：</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>mysql <span class=\"token parameter variable\">-u</span> root -p<span class=\"token string\">\"youpass\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>mysql<span class=\"token operator\">></span>GRANT ALL PRIVILEGES ON *.* TO <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2023'</span> WITH GRANT OPTION<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>FLUSH PRIVILEGES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#4. 创建数据库</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>mysql<span class=\"token operator\">></span> create database zrlog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Query OK, <span class=\"token number\">1</span> row affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h6 id=\"412-配置tomcat虚拟主机\"><a class=\"anchor\" href=\"#412-配置tomcat虚拟主机\">#</a> 4.1.2 配置 Tomcat 虚拟主机</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/server.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--zrlog.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"zrlog.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/zrlog\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"zrlog_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h6 id=\"413-准备项目代码\"><a class=\"anchor\" href=\"#413-准备项目代码\">#</a> 4.1.3 准备项目代码</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/zrlog</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv zrlog-2.2.0-5e8a51f-release.war /code/zrlog/ROOT.war</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls /code/zrlog/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ROOT.war</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/hR5jFTN.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"42-zrlog集群部署\"><a class=\"anchor\" href=\"#42-zrlog集群部署\">#</a> 4.2 zrlog 集群部署</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">服务器名称</th>\n<th style=\"text-align:center\">服务器 IP</th>\n<th style=\"text-align:center\">服务器角色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">lb01</td>\n<td style=\"text-align:center\">192.168.40.150</td>\n<td style=\"text-align:center\">Nginx</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">192.168.40.7</td>\n<td style=\"text-align:center\">Tomcat</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">192.168.40.8</td>\n<td style=\"text-align:center\">Tomcat</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">NFS</td>\n<td style=\"text-align:center\">192.168.40.32</td>\n<td style=\"text-align:center\">NFS</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">db01</td>\n<td style=\"text-align:center\">192.168.40.51</td>\n<td style=\"text-align:center\">MySQL</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Redis</td>\n<td style=\"text-align:center\">192.168.40.41</td>\n<td style=\"text-align:center\">Redis</td>\n</tr>\n</tbody>\n</table>\n<h6 id=\"421-安装jdk\"><a class=\"anchor\" href=\"#421-安装jdk\">#</a> 4.2.1 安装 jdk</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp jdk-8u451-linux-x64.tar.gz root@192.168.40.8:/root</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf jdk-8u451-linux-x64.tar.gz  -C /usr/local/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/jdk1.8.0_451/ /usr/local/jdk</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#添加环境变量</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/profile.d/jdk.sh</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JAVA_HOME</span><span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$JAVA_HOME</span>/bin</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JRE_HOME</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/jre </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CLASSPATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/lib/:<span class=\"token variable\">$JRE_HOME</span>/lib/</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -version</span></pre></td></tr></table></figure><h6 id=\"422-安装tomcat\"><a class=\"anchor\" href=\"#422-安装tomcat\">#</a> 4.2.2 安装 Tomcat</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp  /soft root@192.168.40.8:/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /soft/tomcat/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /soft/apache-tomcat-9.0.106 /soft/tomcat</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp /usr/lib/systemd/system/tomcat.service root@192.168.40.8:/usr/lib/systemd/system/tomcat.service</span></pre></td></tr></table></figure><h6 id=\"423-部署zrlog\"><a class=\"anchor\" href=\"#423-部署zrlog\">#</a> 4.2.3 部署 zrlog</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp /code/* root@192.168.40.8:/code/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep java</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">1806</span>/java           </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:8005          :::*                    LISTEN      <span class=\"token number\">1806</span>/java</pre></td></tr></table></figure><h6 id=\"424-接入nginx负载均衡\"><a class=\"anchor\" href=\"#424-接入nginx负载均衡\">#</a> 4.2.4 接入 Nginx 负载均衡</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/zrlog.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream zrlog <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name zrlog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass http://zrlog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>proxy_read_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nginx &amp;&amp; systemctl enable nginx</span></pre></td></tr></table></figure><h6 id=\"425-接入共享存储nfs\"><a class=\"anchor\" href=\"#425-接入共享存储nfs\">#</a> 4.2.5 接入共享存储 Nfs</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/exports</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/data/zrlog <span class=\"token number\">192.168</span>.40.0/24<span class=\"token punctuation\">(</span>rw,all_squash,anonuid<span class=\"token operator\">=</span><span class=\"token number\">666</span>,anongid<span class=\"token operator\">=</span><span class=\"token number\">666</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data/zrlog -p</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /data/zrlog/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nfs-server &amp;&amp; systemctl enable nfs-server</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#web01 挂载 nfs</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zrlog/ROOT/attached</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.40.32:/data/zrlog /code/zrlog/ROOT/attached/</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#web02 挂载 nfs, 由于 web02 节点没有该静态资源目录，所以自行创建</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zrlog/ROOT/attached</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.40.32:/data/zrlog /code/zrlog/ROOT/attached/</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr></table></figure><h6 id=\"426-集群配置https\"><a class=\"anchor\" href=\"#426-集群配置https\">#</a> 4.2.6 集群配置 Https</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ssl_key<span class=\"token punctuation\">]</span><span class=\"token comment\"># [root@lb01 ~]# cat /etc/nginx/conf.d/zrlog.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream zrlog <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name zrlog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        client_max_body_size 1G<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate  /etc/nginx/ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate_key  /etc/nginx/ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_session_timeout 100m<span class=\"token punctuation\">;</span>               <span class=\"token comment\">#多长时间内如果再进行连接，则不需要进行握手过程</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ssl_session_cache shared:cache:10m<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#建立会话的缓存</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tproxy_pass http://zrlog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      server_name zrlog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#创建证书目录</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/ssl_key</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ssl_key<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"427-tomcat会话保持session\"><a class=\"anchor\" href=\"#427-tomcat会话保持session\">#</a> 4.2.7 Tomcat 会话保持 session</h6>\n<p>1、为 web01、web02 节点添加虚拟主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/server.xml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--session.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"session.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/session\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"zrlog_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr></table></figure><p>2、为 web01、web02 配置 session 相关的网页</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 web01</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/session/ROOT -p</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/session/ROOT/index.jsp</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>%</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>//HttpSession session <span class=\"token operator\">=</span> request.getSession<span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>System.out.println<span class=\"token punctuation\">(</span>session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;br> web01 SESSION ID:\"</span> + session.getId<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> + <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"Session created time is :\"</span> + session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>+ <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>%<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:session.hmallleasing.com http://192.168.40.7:8080</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#2. 配置 web02</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/session/ROOT -p</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/session/ROOT/index.jsp</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">&lt;</span>%</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>//HttpSession session <span class=\"token operator\">=</span> request.getSession<span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>System.out.println<span class=\"token punctuation\">(</span>session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;br> web02 SESSION ID:\"</span> + session.getId<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> + <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"Session created time is :\"</span> + session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>+ <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>%<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:session.hmallleasing.com http://192.168.40.7:8080</span></pre></td></tr></table></figure><p>3、接入负载均衡，测试检查，看看是否通过轮询调度，获取的 session 是不一致</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/session.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream session <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        client_max_body_size 1G<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate  /etc/nginx/ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate_key  /etc/nginx/ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_session_timeout 100m<span class=\"token punctuation\">;</span>               <span class=\"token comment\">#多长时间内如果再进行连接，则不需要进行握手过程</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ssl_session_cache shared:cache:10m<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#建立会话的缓存</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tproxy_pass http://session<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      server_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3syDtTJ.jpeg\" alt=\"1.jpg\" /></p>\n<p>当用户通过负载均衡向服务器 A 发起 http 请求，A 服务器会下发一个 sessionID，通过 head 中 set-cookie 回传用户，用户下次请求时会携带 cookie 字段加上服务器用户名和密码进行请求 A 服务器，该值就是 A 服务器下发的 sessionID，如果验证通过则登录成功。由于负载均衡采用轮询调度机制，请求 A 节点下发一个 sessionID，用户带着 A 节点下发一个 sessionID 请求负载均衡，会调度到 B 节点，B 节点不认 A 节点 sessionID，最终形成死循环。</p>\n<p>4、使用负载均衡 ip_hash 来解决 session；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/session.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream session <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         ip_hash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        client_max_body_size 1G<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate  ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_certificate_key  ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ssl_session_timeout 100m<span class=\"token punctuation\">;</span>               <span class=\"token comment\">#多长时间内如果再进行连接，则不需要进行握手过程</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        ssl_session_cache shared:cache:10m<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#建立会话的缓存</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tproxy_pass http://session<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      server_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p>5、通过 redis 来解决 session 会话保持</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WcgGtb7.jpeg\" alt=\"1.jpg\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 安装 redis, 配置 redis</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install redis -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/redis.conf</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">bind</span> <span class=\"token number\">127.0</span>.0.1 <span class=\"token number\">192.168</span>.40.104</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>requirepass <span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start redis &amp;&amp; systemctl enable redis</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#2. 检查 redis 是否正常能对外提供服务</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -h 192.168.40.41 -a 123456</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">192.168</span>.40.104:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#3.tomcat 要支持 redis，需要模块（需要的是 jar 包）所有的应用节点都需要配置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>https://github.com/ran-jit/tomcat-cluster-redis-session-manager</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://github.com/ran-jit/tomcat-cluster-redis-session-manager/releases/download/4.0/tomcat-cluster-redis-session-manager.zip\t</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#4.web01、web02 复制 jar 包到 tomcat/lib 目录中</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip tomcat-cluster-redis-session-manager.zip</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp tomcat-cluster-redis-session-manager/lib/* /soft/tomcat/lib/</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#5.web01、web02 复制 redis 配置文件到 tomcat/conf 目录中。并更新他；</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp tomcat-cluster-redis-session-manager/conf/redis-data-cache.properties /soft/tomcat/conf/</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#6.web01、web02 修改 redis 配置信息</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/redis-data-cache.properties</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#- redis hosts. ex: 127.0.0.1:6379, 127.0.0.2:6379, 127.0.0.2:6380, ....</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">redis.hosts</span><span class=\"token operator\">=</span><span class=\"token number\">192.16</span>.40.41:6379</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#- redis password.</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">redis.password</span><span class=\"token operator\">=</span><span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#7..web01、web02 添加两行配置文件在 tomcat/conf/context.xml</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/context.xml</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat.request.session.redis.SessionHandlerValve\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Manager <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat.request.session.redis.SessionManager\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token operator\">&lt;</span>/Context<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#8.web01、web02 可选：修改 session 过期时间，默认 30m</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/web.xml</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token operator\">&lt;</span>session-config<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token operator\">&lt;</span>session-timeout<span class=\"token operator\">></span><span class=\"token number\">6</span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/session-timeout<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token operator\">&lt;</span>/session-config<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#8.web01、web02 重启 tomcat</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">#9.redis 查看 session</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -h 192.168.40.41 -a 123456</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token number\">192.168</span>.40.41:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> flushdb</pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token number\">192.168</span>.40.41:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *</pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"A8704CF8988CF60C30080420BA66AD0F\"</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/NbEnM7U.jpeg\" alt=\"2.jpg\" /></p>\n",
            "tags": [
                "Tomcat"
            ]
        }
    ]
}