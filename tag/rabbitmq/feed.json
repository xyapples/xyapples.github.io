{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"rabbitmq\" tag",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/1384812626.html",
            "url": "http://ixuyong.cn/posts/1384812626.html",
            "title": "Kubenetes部署Rabbitmq集群",
            "date_published": "2025-05-29T12:48:49.000Z",
            "content_html": "<h3 id=\"kubenetes部署rabbitmq集群\"><a class=\"anchor\" href=\"#kubenetes部署rabbitmq集群\">#</a> Kubenetes 部署 Rabbitmq 集群</h3>\n<h6 id=\"1-创建rbac权限\"><a class=\"anchor\" href=\"#1-创建rbac权限\">#</a> 1. 创建 RBAC 权限</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-rabbitmq-rbac.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>- apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"endpoints\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  namespace: prod</pre></td></tr></table></figure><h6 id=\"2-创建集群的secret\"><a class=\"anchor\" href=\"#2-创建集群的secret\">#</a> 2. 创建集群的 Secret</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-rabbitmq-secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>stringData:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  password: talent</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  url: amqp://RABBITMQ_USER:RABBITMQ_PASS@rmq-cluster-balancer</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  username: superman</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h6 id=\"3-创建configmap\"><a class=\"anchor\" href=\"#3-创建configmap\">#</a> 3. 创建 ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-rabbitmq-cm.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-cluster-config</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    addonmanager.kubernetes.io/mode: Reconcile</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    enabled_plugins: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">[</span>rabbitmq_management,rabbitmq_peer_discovery_k8s<span class=\"token punctuation\">]</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    rabbitmq.conf: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      loopback_users.guest <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      default_user <span class=\"token operator\">=</span> RABBITMQ_USER</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      default_pass <span class=\"token operator\">=</span> RABBITMQ_PASS</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token comment\">## Cluster </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cluster_formation.peer_discovery_backend <span class=\"token operator\">=</span> rabbit_peer_discovery_k8s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      cluster_formation.k8s.host <span class=\"token operator\">=</span> kubernetes.default.svc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token comment\">#cluster_formation.k8s.host = kubernetes.default.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cluster_formation.k8s.address_type <span class=\"token operator\">=</span> <span class=\"token function\">hostname</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\"># prod is rabbitmq-cluster's namespace#</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      cluster_formation.k8s.hostname_suffix <span class=\"token operator\">=</span> .rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      cluster_formation.node_cleanup.interval <span class=\"token operator\">=</span> <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      cluster_formation.node_cleanup.only_log_warning <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      cluster_partition_handling <span class=\"token operator\">=</span> autoheal</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">## queue master locator</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      queue_master_locator <span class=\"token operator\">=</span> min-masters</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      cluster_formation.randomized_startup_delay_range.min <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      cluster_formation.randomized_startup_delay_range.max <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token comment\"># memory</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      vm_memory_high_watermark.absolute <span class=\"token operator\">=</span> 100MB</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token comment\"># disk</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      disk_free_limit.absolute <span class=\"token operator\">=</span> 2GB</pre></td></tr></table></figure><p><em>注：配置文件 cluster_formation.k8s.host 设置为 kubernetes.default.svc.cluster.local，然后就是各种连不上，后来换上 kubernetes.default.svc 就可以了，不知道是不是 k8s 新版本的问题。</em></p>\n<h6 id=\"4-创建集群的svc\"><a class=\"anchor\" href=\"#4-创建集群的svc\">#</a> 4. 创建集群的 svc</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-rabbitmq-cluster-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: rmqport</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    app: rabbitmq-cluster-balancer</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  name: rabbitmq-cluster-balancer</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  - name: rmqport</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  type: NodePort</pre></td></tr></table></figure><h6 id=\"5-创建statefulset\"><a class=\"anchor\" href=\"#5-创建statefulset\">#</a> 5. 创建 StatefulSet</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 05-rabbitmq-cluster-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  serviceName: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      affinity:                                                 <span class=\"token comment\"># 避免 Pod 运行到同一个节点上了</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-cluster\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - <span class=\"token parameter variable\">-c</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-v</span> /etc/rabbitmq/rabbitmq.conf <span class=\"token variable\">$&#123;RABBITMQ_CONFIG_FILE&#125;</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">exec</span> docker-entrypoint.sh rabbitmq-server</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: RABBITMQ_DEFAULT_USER</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: username</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: RABBITMQ_DEFAULT_PASS </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>              key: password </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        - name: TZ</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          value: <span class=\"token string\">'Asia/Shanghai'</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        - name: RABBITMQ_ERLANG_COOKIE</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          value: <span class=\"token string\">'SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY='</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: K8S_SERVICE_NAME</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          value: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: POD_IP</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: POD_NAME</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        - name: RABBITMQ_USE_LONGNAME</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: RABBITMQ_NODENAME</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          value: rabbit@<span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAME<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">.</span><span class=\"token variable\"><span class=\"token variable\">$(</span>K8S_SERVICE_NAME<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">.</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span>.svc.cluster.local</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: RABBITMQ_CONFIG_FILE</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          value: /var/lib/rabbitmq/rabbitmq.conf</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        image: rabbitmq:3.9-management</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        name: rabbitmq</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        - containerPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          name: http</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        - containerPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          name: amqp</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-diagnostics\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          periodSeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-diagnostics\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          periodSeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        - mountPath: /etc/rabbitmq</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          name: config-volume</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        - mountPath: /var/lib/rabbitmq</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      serviceAccountName: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>      terminationGracePeriodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>      - name: config-volume</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          items:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>          - key: rabbitmq.conf</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>            path: rabbitmq.conf</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          - key: enabled_plugins</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            path: enabled_plugins</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          name: rabbitmq-cluster-config</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      accessModes:</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>      - ReadWriteMany</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"6-创建ingress\"><a class=\"anchor\" href=\"#6-创建ingress\">#</a> 6. 创建 Ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 06-rabbitmq-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: rabbitmq.hmallleasing.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              number: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h6 id=\"7-更新资源清单\"><a class=\"anchor\" href=\"#7-更新资源清单\">#</a> <strong>7. 更新资源清单</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n prod</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                 READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmq-cluster-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m53s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rabbitmq-cluster-1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m47s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rabbitmq-cluster-2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m40s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it rabbitmq-cluster-0 -n prod -- /bin/bash</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@rabbitmq-cluster-0:/<span class=\"token comment\"># rabbitmqctl cluster_status</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>RABBITMQ_ERLANG_COOKIE <span class=\"token function\">env</span> variable support is deprecated and will be REMOVED <span class=\"token keyword\">in</span> a future version. Use the <span class=\"token environment constant\">$HOME</span>/.erlang.cookie <span class=\"token function\">file</span> or the --erlang-cookie switch instead.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Cluster status of <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Basics</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Cluster name: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Disk Nodes</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Running Nodes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Versions</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Maintenance status</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Alarms</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>Network Partitions</pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">(</span>none<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>Listeners</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>Feature flags</pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>Flag: drop_unroutable_metric, state: enabled</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>Flag: empty_basic_get_metric, state: enabled</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>Flag: implicit_default_bindings, state: enabled</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>Flag: maintenance_mode_status, state: enabled</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>Flag: quorum_queue, state: enabled</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>Flag: stream_queue, state: enabled</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>Flag: user_limits, state: enabled</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>Flag: virtual_host_metadata, state: enabled</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/XqURJbg.jpeg\" alt=\"Snipaste_2025-05-17_17-42-47.jpg\" /></p>\n<h6 id=\"8-web访问rabbitmq\"><a class=\"anchor\" href=\"#8-web访问rabbitmq\">#</a> <strong>8. Web 访问 rabbitmq</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://rabbitmq.hmallleasing.com/<span class=\"token comment\">#/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>user:superman</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pwd:talent</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/7qKxUBf.jpeg\" alt=\"Snipaste_2025-05-17_17-14-54.jpg\" /></p>\n<h6 id=\"9-rabbitmq全部挂了无法重启解决方案\"><a class=\"anchor\" href=\"#9-rabbitmq全部挂了无法重启解决方案\">#</a> 9. rabbitMQ 全部挂了，无法重启解决方案</h6>\n<p>Kubernetes 环境中，遇到 RabbitMQ 集群无法启动的问题。原因是 RabbitMQ 所有实例均失效，需要在每个 Pod 对应的持久化存储路径下创建 force_load 文件来强制启动。通过获取 PV 存储路径，在指定目录创建该文件后，重新启动 RabbitMQ 服务，成功解决了集群启动问题</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token comment\"># cd /data/dev-rabbitmq-storage-rabbitmq-cluster-0-pvc-3abca920-3c68-44eb-b0fd-406a4358b153/mnesia/rabbit@rabbitmq-cluster-0.rabbitmq-cluster.dev.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 rabbit@rabbitmq-cluster-0.rabbitmq-cluster.dev.svc.cluster.local<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch force_load</span></pre></td></tr></table></figure>",
            "tags": [
                "Rabbitmq"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2692178654.html",
            "url": "http://ixuyong.cn/posts/2692178654.html",
            "title": "Rabbitmq集群部署",
            "date_published": "2025-05-29T12:35:53.000Z",
            "content_html": "<h3 id=\"rabbitmq集群部署\"><a class=\"anchor\" href=\"#rabbitmq集群部署\">#</a> Rabbitmq 集群部署</h3>\n<h4 id=\"一-环境配置\"><a class=\"anchor\" href=\"#一-环境配置\">#</a> 一、环境配置</h4>\n<h5 id=\"11-关闭防火墙-selinux\"><a class=\"anchor\" href=\"#11-关闭防火墙-selinux\">#</a> 1.1 关闭防火墙、Selinux</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> firewalld </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>setenforce <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config</pre></td></tr></table></figure><h5 id=\"12-配置-yum-源\"><a class=\"anchor\" href=\"#12-配置-yum-源\">#</a> 1.2 配置 yum 源</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#rocky linux 配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-i.bak</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    /etc/yum.repos.d/rocky-*.repo</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>yum clean all <span class=\"token operator\">&amp;&amp;</span> yum makecache</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">mkdir</span> /soft /data /scripts /backup</pre></td></tr></table></figure><h5 id=\"13-安装ntpdate\"><a class=\"anchor\" href=\"#13-安装ntpdate\">#</a> 1.3 安装 ntpdate</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> epel-release <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> dnf config-manager --set-enabled epel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> ntpsec</pre></td></tr></table></figure><h5 id=\"14-配置时间同步\"><a class=\"anchor\" href=\"#14-配置时间同步\">#</a> 1.4 配置时间同步</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span>/etc/timezone</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ntpdate time2.aliyun.com</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 加入到 crontab</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">crontab</span> <span class=\"token parameter variable\">-e</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com</pre></td></tr></table></figure><h5 id=\"15-配置文件描述符\"><a class=\"anchor\" href=\"#15-配置文件描述符\">#</a> 1.5 配置文件描述符</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">ulimit</span> <span class=\"token parameter variable\">-SHn</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> /etc/security/limits.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 末尾添加如下内容</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>* soft nofile <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>* hard nofile <span class=\"token number\">131072</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>* soft nproc <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>* hard nproc <span class=\"token number\">655350</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>* soft memlock unlimited</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>* hard memlock unlimited</pre></td></tr></table></figure><h5 id=\"16-系统内核参数调优\"><a class=\"anchor\" href=\"#16-系统内核参数调优\">#</a> 1.6 系统内核参数调优</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">>></span>/etc/sysctl.conf<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>vm.max_map_count = 262144</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>vm.swappiness=1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>net.ipv4.tcp_fin_timeout=2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>net.ipv4.tcp_tw_reuse=1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>#net.ipv4.tcp_tw_recycle=1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>net.ipv4.tcp_syncookies=1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>net.ipv4.tcp_keepalive_time=600</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>net.ipv4.ip_local_port_range=4000 65000</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>net.ipv4.tcp_max_syn_backlog=16384</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>net.ipv4.route.gc_timeout=100</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>net.ipv4.tcp_max_tw_buckets= 5000</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>net.ipv4.tcp_syn_retries=1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>net.ipv4.tcp_synack_retries=1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>net.core.somaxconn=16384</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>net.core.netdev_max_backlog=16384</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>net.ipv4.tcp_max_orphans=16384</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre># 设置最大内存共享段大小bytes</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kernel.shmmax=15461882265</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kernel.shmall=3774873</pre></td></tr><tr><td data-num=\"24\"></td><td><pre># 修改消息队列长度</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kernel.msgmax=65535</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kernel.msgmnb=65535</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>EOF</span></pre></td></tr></table></figure><h5 id=\"17-修改默认资源限制\"><a class=\"anchor\" href=\"#17-修改默认资源限制\">#</a> 1.7 修改默认资源限制</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">>></span>/etc/systemd/system.conf<span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>DefaultLimitNOFILE=65536</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>DefaultLimitNPROC=32000</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DefaultLimitMEMLOCK=infinity</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</span></pre></td></tr></table></figure><h5 id=\"18-执行命令生效状态\"><a class=\"anchor\" href=\"#18-执行命令生效状态\">#</a> 1.8 执行命令生效状态</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-p</span></pre></td></tr></table></figure><h5 id=\"19-安装基础软件包\"><a class=\"anchor\" href=\"#19-安装基础软件包\">#</a> 1.9 安装基础软件包</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> <span class=\"token function\">unzip</span> net-tools telnet tree yum-utils device-mapper-persistent-data <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lvm2 <span class=\"token function\">git</span> nfs-utils iotop httpd-tools dos2unix lrzsz <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><h5 id=\"110-升级系统\"><a class=\"anchor\" href=\"#110-升级系统\">#</a> 1.10 升级系统</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum update <span class=\"token parameter variable\">-y</span> <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>kernel* <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">reboot</span></pre></td></tr></table></figure><h4 id=\"二-rabbitmq集群部署\"><a class=\"anchor\" href=\"#二-rabbitmq集群部署\">#</a> 二、Rabbitmq 集群部署</h4>\n<h5 id=\"21-环境准备\"><a class=\"anchor\" href=\"#21-环境准备\">#</a> 2.1 环境准备</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">192.168.40.101</th>\n<th style=\"text-align:center\">192.168.40.102</th>\n<th style=\"text-align:center\">192.168.40.103</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">master</td>\n<td style=\"text-align:center\">slave1</td>\n<td style=\"text-align:center\">slave2</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"22-修改hosts\"><a class=\"anchor\" href=\"#22-修改hosts\">#</a> 2.2 修改 hosts</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/hosts</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">192.168</span>.40.101 rabbitmq-01</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.40.102 rabbitmq-02</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.40.103 rabbitmq-03</pre></td></tr></table></figure><h5 id=\"23-配置hosts\"><a class=\"anchor\" href=\"#23-配置hosts\">#</a> 2.3 配置 hosts</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hostnamectl set-hostname rabbitmq-01</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>hostnamectl set-hostname rabbitmq-02</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>hostnamectl set-hostname rabbitmq-03</pre></td></tr></table></figure><h5 id=\"24-安装包下载\"><a class=\"anchor\" href=\"#24-安装包下载\">#</a> 2.4 安装包下载</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://github.com/rabbitmq/erlang-rpm/releases/download/v27.3.1/erlang-27.3.1-1.el8.x86_64.rpm</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">wget</span> http://repo.iotti.biz/CentOS/7/x86_64/socat-1.7.3.2-5.el7.lux.x86_64.rpm</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">wget</span> https://github.com/rabbitmq/rabbitmq-server/releases/download/v4.1.0/rabbitmq-server-4.1.0-1.el8.noarch.rpm</pre></td></tr></table></figure><h5 id=\"25-安装rabbitmq\"><a class=\"anchor\" href=\"#25-安装rabbitmq\">#</a> 2.5 安装 rabbitmq</h5>\n<ul>\n<li>RabbitMQ 是采用 Erlang 语言开发的，所以系统环境必须提供 Erlang 环境，需要是安装 Erlang。</li>\n<li>在 RabiitMQ 安装过程中需要依赖 socat 插件，首先安装该插件。</li>\n<li>Erlang 和 RabbitMQ 版本对照： <a href=\"https://www.rabbitmq.com/which-erlang.html\">https://www.rabbitmq.com/which-erlang.html</a></li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum localinstall erlang-27.3.1-1.el8.x86_64.rpm <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yum localinstall socat-1.7.3.2-5.el7.lux.x86_64.rpm <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>yum localinstall rabbitmq-server-4.1.0-1.el8.noarch.rpm <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><h5 id=\"26-配置rabbitmq\"><a class=\"anchor\" href=\"#26-配置rabbitmq\">#</a> 2.6 配置 rabbitmq</h5>\n<p>所有节点创建自定义数据和日志目录</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /data/rabbitmq/data /data/rabbitmq/log</pre></td></tr></table></figure><p>所有节点编辑配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/rabbitmq/rabbitmq-env.conf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">RABBITMQ_MNESIA_BASE</span><span class=\"token operator\">=</span>/data/rabbitmq/data</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">RABBITMQ_LOG_BASE</span><span class=\"token operator\">=</span>/data/rabbitmq/log</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">RABBITMQ_ERLANG_COOKIE</span><span class=\"token operator\">=</span>/data/rabbitmq/.erlang.cookie</pre></td></tr></table></figure><p>所有节点赋予.erlang.cookie 文件权限（其他 2 台从节点 cookie 值要保持一致，权限为 owner 只读），RabbitMQ 的集群是依赖 erlang 集群，而 erlang 集群是通过这个 cookie 进行通信认证的。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /data/rabbitmq/.erlang.cookie</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>KAIJQVKJHAGMUCWXZGVG </pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">chmod</span> <span class=\"token parameter variable\">-R</span> <span class=\"token number\">400</span> /data/rabbitmq/.erlang.cookie</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">chown</span> <span class=\"token parameter variable\">-R</span> rabbitmq.rabbitmq /data/rabbitmq/</pre></td></tr></table></figure><h5 id=\"27-rabbitmq启动\"><a class=\"anchor\" href=\"#27-rabbitmq启动\">#</a> 2.7 rabbitmq 启动</h5>\n<p>所有节点启动 web 管理插件和分片插件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rabbitmq-plugins <span class=\"token builtin class-name\">enable</span> rabbitmq_management</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rabbitmq-plugins <span class=\"token builtin class-name\">enable</span> rabbitmq_sharding</pre></td></tr></table></figure><p>所有节点设置开机自启</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> rabbitmq-server</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl restart rabbitmq-server</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl status rabbitmq-server</pre></td></tr></table></figure><h5 id=\"28-加入集群\"><a class=\"anchor\" href=\"#28-加入集群\">#</a> 2.8 加入集群</h5>\n<p>创建集群，在 node2 和 node3 上执行加入集群命令（主节点无需执行如下操作）:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 关闭服务</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rabbitmqctl stop_app</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 加入集群</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmqctl join_cluster rabbit@rabbitmq-01</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3. 启动服务</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>rabbitmqctl start_app</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4. 查看集群状态，任意节点执行</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>rabbitmqctl cluster_status</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gWflncf.jpeg\" alt=\"Snipaste_2025-05-29_20-40-27.jpg\" /></p>\n<h5 id=\"29-配置rabbitmq权限\"><a class=\"anchor\" href=\"#29-配置rabbitmq权限\">#</a> 2.9 配置 rabbitmq 权限</h5>\n<p>rabbitmq 有一个默认的账号密码 guest，但该情况仅限于本机 localhost 进行访问，所以需要添加一个远程登录的用户。</p>\n<p><strong>角色有四种：</strong></p>\n<ul>\n<li>administrator：可以登录控制台、查看所有信息、并对 rabbitmq 进行管理</li>\n<li>monToring：监控者；登录控制台，查看所有信息</li>\n<li>policymaker：策略制定者；登录控制台指定策略</li>\n<li>managment：普通管理员；登录控制</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加用户</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rabbitmqctl add_user admin <span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 为用户添加资源权限 (授予访问虚拟机根节点的所有权限)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmqctl set_permissions <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"/\"</span> admin <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 设置用户角色，分配操作权限</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>rabbitmqctl set_user_tags admin administrator</pre></td></tr></table></figure><p>这里创建用户 xuyong，密码 123456，设置 adminstator 角色，赋予所有权限</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加用户</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rabbitmqctl add_user xuyong <span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 为用户添加资源权限 (授予访问虚拟机根节点的所有权限)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmqctl set_permissions <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"/\"</span> xuyong <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 新增虚拟主机</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>rabbitmqctl add_vhost /xuyong</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 将新虚拟主机授权给新用户</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># rabbitmqctl set_permissions -p vhost_name username “.*” “.*” “.*”(后面三个”*” 代表用户拥有配置、写、读全部权限)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>rabbitmqctl set_permissions <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"/xuyong\"</span> xuyong <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#查看权限</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rabbitmqctl list_permissions <span class=\"token parameter variable\">-p</span> /xuyong</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 设置用户角色，分配操作权限</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>rabbitmqctl set_user_tags xuyong administrator</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 删除 guest 用户</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rabbitmqctl delete_user guest</pre></td></tr></table></figure><p>在其他节点检查，账户是否已同步</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rabbitmqctl list_users</pre></td></tr></table></figure><h5 id=\"210-访问rabbitmq\"><a class=\"anchor\" href=\"#210-访问rabbitmq\">#</a> 2.10 访问 rabbitmq</h5>\n<p>浏览器访问:<a href=\"http://192.168.40.101:15672/\">http://192.168.40.101:15672/</a><br />\n 用户名: admin<br />\n 密码：123456</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KQpvPU4.jpeg\" alt=\"Snipaste_2025-05-29_20-29-59.jpg\" /></p>\n",
            "tags": [
                "Rabbitmq"
            ]
        }
    ]
}