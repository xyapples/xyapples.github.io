{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"openvpn\" tag",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/2126514413.html",
            "url": "http://ixuyong.cn/posts/2126514413.html",
            "title": "虚拟隧道网络Openvpn",
            "date_published": "2025-06-05T13:50:22.000Z",
            "content_html": "<h3 id=\"虚拟隧道网络openvpn\"><a class=\"anchor\" href=\"#虚拟隧道网络openvpn\">#</a> 虚拟隧道网络 Openvpn</h3>\n<h4 id=\"一-什么是vpn\"><a class=\"anchor\" href=\"#一-什么是vpn\">#</a> 一、什么是 VPN</h4>\n<p>VPN（Virtual Private Network） 翻译过来就是虚拟专⽤⽹络，那虚拟专⽤⽹提供什么功能</p>\n<ol>\n<li>将两个或多个 “不同地域 “的⽹络通过⼀条虚拟隧道的⽅式连接起来，实现互通；</li>\n<li>在不安全的线路上提供安全的数据传输；</li>\n</ol>\n<h4 id=\"二-vpn应用场景\"><a class=\"anchor\" href=\"#二-vpn应用场景\">#</a> 二、VPN 应⽤场景</h4>\n<h5 id=\"21-点对点连接\"><a class=\"anchor\" href=\"#21-点对点连接\">#</a> 2.1 点对点连接</h5>\n<p>Peer-to-Peer VPN (点对点连接)，将 Internet 两台机器（公⽹地址）使⽤ VPN 连接起来，⽐如上海服务器和北京服务器的之间的数据需要相互调⽤，但是数据⼜⽐较敏感，直接通过 http 公共⽹络传输，容易被窃取。如果拉⼀条专线成本⼜太⾼。所以我们可以通过 VPN 将两台主机逻辑上捆绑在⼀个虚拟⽹络中，这样既保证了数据传输安全，同时⼜节省了成本。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ZjDn2SI.png\" alt=\"1.png\" /></p>\n<h5 id=\"22-站点对站点\"><a class=\"anchor\" href=\"#22-站点对站点\">#</a> 2.2 站点对站点</h5>\n<p>SIte-to-Site VPN (站点对站点连接) ，⽤于连接两个或者多个地域上不同的局域⽹ LAN，每个 LAN 有⼀台 OpenVPN 服务器作为接⼊点，组成虚拟专⽤⽹络，使得不同 LAN ⾥⾯的主机和服务器都能够相互通讯。（⽐如国内公司与海外公司分公司的连接）</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/W5Yg3v0.png\" alt=\"2.png\" /></p>\n<h5 id=\"23-远程访问\"><a class=\"anchor\" href=\"#23-远程访问\">#</a> 2.3 远程访问</h5>\n<p>Remote AccessVPN（远程访问），应⽤于外⽹⽤户访问内部资源。在这个场景中远程访问者⼀般通过公⽹ IP 连接 VPN 服务，然后通过分配后的内⽹地址与其内⽹⽹段进⾏通信。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6f3PYIK.png\" alt=\"3.png\" /></p>\n<h4 id=\"三-openvpn基本介绍\"><a class=\"anchor\" href=\"#三-openvpn基本介绍\">#</a> 三、OpenVPN 基本介绍</h4>\n<h5 id=\"31-什么是openvpn\"><a class=\"anchor\" href=\"#31-什么是openvpn\">#</a> 3.1 什么是 OpenVPN</h5>\n<p>OpenVPN 就像它的名字⼀样，是⼀个开源的软件，且提供</p>\n<p>VPN 虚拟专⽤⽹络功能；</p>\n<ul>\n<li>⽀持 SSL/TLS 协议，使得数据传输更安全；</li>\n<li>⽀持 TCP、UDP 隧道；</li>\n<li>⽀持动态分配虚拟 IP 地址；</li>\n<li>⽀持数百甚⾄数千⽤户同时使⽤；</li>\n<li>⽀持⼤多数主流操作系统平台；</li>\n</ul>\n<p>OpenVPN 官⽹：<a href=\"https://openvpn.net\">https://openvpn.net</a></p>\n<p>GitHub 地址：<a href=\"https://github.com/OpenVPN/openvpn\">https://github.com/OpenVPN/openvpn</a></p>\n<h5 id=\"32-openvpn应用场景\"><a class=\"anchor\" href=\"#32-openvpn应用场景\">#</a> 3.2 OpenVPN 应⽤场景</h5>\n<p>场景 1：拨⼊ OpenVPN，然后连接内部服务器；</p>\n<p>场景 2：实现两个不同地域主机、且两个地域主机 IP 不固定，互连互通；</p>\n<h5 id=\"33-openvpn实现场景\"><a class=\"anchor\" href=\"#33-openvpn实现场景\">#</a> 3.3 OpenVPN 实现场景</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3GCg7Qd.png\" alt=\"1.png\" /></p>\n<h4 id=\"四-openvpn证书配置\"><a class=\"anchor\" href=\"#四-openvpn证书配置\">#</a> 四、OpenVPN 证书配置</h4>\n<h5 id=\"41-安装easy-rsa\"><a class=\"anchor\" href=\"#41-安装easy-rsa\">#</a> 4.1 安装 easy-rsa</h5>\n<p>1. 为了保证 OpenVPN 数据传输安全，所以需要证书，可以通过 easy-rsa ⼯具创建相关证书</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install easy-rsa -y</span></pre></td></tr></table></figure><p>2. 创建证书前，需要拷⻉配置⽂件，以及 vars ⽂件，定义证书相关的属性</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@open ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /opt/easy-rsa</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@open ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /opt/easy-rsa/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp -a /usr/share/easy-rsa/3/* ./</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp -a /usr/share/doc/easy-rsa-*/vars.example ./vars</span></pre></td></tr></table></figure><p>3. 修改 vars ⽂件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat vars </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$EASYRSA_CALLER</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"You appear to be sourcing an Easy-RSA 'vars' file.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"This is no longer necessary and is disallowed. See the section called\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"'How to use this file' near the top comments for more details.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>set_var EASYRSA_CA_EXPIRE <span class=\"token number\">3650</span>            <span class=\"token comment\">#证书有效期</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>set_var EASYRSA_CERT_EXPIRE <span class=\"token number\">3650</span>          <span class=\"token comment\">#服务端证书有效期，默为 825 天</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>set_var EASYRSA_DN <span class=\"token string\">\"cn_only\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>set_var EASYRSA_REQ_COUNTRY <span class=\"token string\">\"CN\"</span>          <span class=\"token comment\">#所在的国家</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>set_var EASYRSA_REQ_PROVINCE <span class=\"token string\">\"Guangdong\"</span>    <span class=\"token comment\">#所在的省份</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>set_var EASYRSA_REQ_CITY <span class=\"token string\">\"Shenzhen\"</span>        <span class=\"token comment\">#所在的城市</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>set_var EASYRSA_REQ_ORG <span class=\"token string\">\"nfzl\"</span>           <span class=\"token comment\">#所在的组织</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>set_var EASYRSA_REQ_EMAIL <span class=\"token string\">\"xuy@nf-leasing.com\"</span> <span class=\"token comment\">#邮箱的地址</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>set_var EASYRSA_NS_SUPPORT <span class=\"token string\">\"yes\"</span></pre></td></tr></table></figure><h5 id=\"42-创建证书文件\"><a class=\"anchor\" href=\"#42-创建证书文件\">#</a> 4.2 创建证书⽂件</h5>\n<h6 id=\"421初始化pki\"><a class=\"anchor\" href=\"#421初始化pki\">#</a> 4.2.1 初始化 PKI</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 初始化，在当前⽬录创建 PKI ⽬录，⽤于存储证书</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa init-pki</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>init-pki complete<span class=\"token punctuation\">;</span> you may now create a CA or requests.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Your newly created PKI <span class=\"token function\">dir</span> is: /opt/easy-rsa/pki</pre></td></tr></table></figure><h6 id=\"422-创建ca机构\"><a class=\"anchor\" href=\"#422-创建ca机构\">#</a> 4.2.2 创建 CA 机构</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 ca 证书，主要对后续创建的 server、client 证书进⾏签名；会提示设置密码，其他可默认</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa build-ca</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Enter New CA Key Passphrase:        <span class=\"token comment\">#设置密码</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Re-Enter New CA Key Passphrase:     <span class=\"token comment\">#确认密码</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Generating RSA private key, <span class=\"token number\">2048</span> bit long modulus</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.+++</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>+++</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>e is <span class=\"token number\">65537</span> <span class=\"token punctuation\">(</span>0x10001<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>You are about to be asked to enter information that will be incorporated</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>into your certificate request.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>What you are about to enter is what is called a Distinguished Name or a DN.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>There are quite a few fields but you can leave some blank</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>For some fields there will be a default value,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>If you enter <span class=\"token string\">'.'</span>, the field will be left blank.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Common Name <span class=\"token punctuation\">(</span>eg: your user, host, or server name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Easy-RSA CA<span class=\"token punctuation\">]</span>:nfzl     <span class=\"token comment\">#输入 nfzl</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>CA creation complete and you may now <span class=\"token function\">import</span> and sign cert requests.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Your new CA certificate <span class=\"token function\">file</span> <span class=\"token keyword\">for</span> publishing is at:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>/opt/easy-rsa/pki/ca.crt</pre></td></tr></table></figure><h6 id=\"423-签发服务端证书\"><a class=\"anchor\" href=\"#423-签发服务端证书\">#</a> 4.2.3 签发服务端证书</h6>\n<p>1. 创建 server 端证书，nopass 表示不加密私钥⽂件，其他可默认</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa gen-req server nopass</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Generating a <span class=\"token number\">2048</span> bit RSA private key</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>+++</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>+++</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>writing new private key to <span class=\"token string\">'/opt/easy-rsa/pki/easy-rsa-1983.z07ECs/tmp.PBZXuy'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>You are about to be asked to enter information that will be incorporated</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>into your certificate request.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>What you are about to enter is what is called a Distinguished Name or a DN.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>There are quite a few fields but you can leave some blank</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>For some fields there will be a default value,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>If you enter <span class=\"token string\">'.'</span>, the field will be left blank.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Common Name <span class=\"token punctuation\">(</span>eg: your user, host, or server name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>server<span class=\"token punctuation\">]</span>:     <span class=\"token comment\">#回车即可</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Keypair and certificate request completed. Your files are:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>req: /opt/easy-rsa/pki/reqs/server.req            <span class=\"token comment\">#请求⽂件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>key: /opt/easy-rsa/pki/private/server.key         <span class=\"token comment\">#私钥</span></pre></td></tr></table></figure><p>2. 给 server 端证书签名，⾸先是对信息的确认，可以输⼊ yes，然后输⼊创建 ca 根证书时设置的密码</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 第⼀个 server 是类型</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 第⼆个 server 是 req 请求⽂件名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa sign server server</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>You are about to sign the following certificate.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Please check over the details shown below <span class=\"token keyword\">for</span> accuracy. Note that this request</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>has not been cryptographically verified. Please be sure it came from a trusted</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token builtin class-name\">source</span> or that you have verified the request checksum with the sender.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Request subject, to be signed as a server certificate <span class=\"token keyword\">for</span> <span class=\"token number\">3650</span> days:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">subject</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    commonName                <span class=\"token operator\">=</span> server</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Type the word <span class=\"token string\">'yes'</span> to continue, or any other input to abort.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  Confirm request details: <span class=\"token function\">yes</span>             <span class=\"token comment\">#输入 yes</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Using configuration from /opt/easy-rsa/pki/easy-rsa-2098.GEv4iZ/tmp.oyIjPH</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Enter pass phrase <span class=\"token keyword\">for</span> /opt/easy-rsa/pki/private/ca.key:    <span class=\"token comment\">#输入密码</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Check that the request matches the signature</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Signature ok</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>The Subject<span class=\"token string\">'s Distinguished Name is as follows</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>commonName            :ASN.1 12:'</span>server'</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Certificate is to be certified <span class=\"token keyword\">until</span> Jun  <span class=\"token number\">8</span> <span class=\"token number\">13</span>:22:49 <span class=\"token number\">2033</span> GMT <span class=\"token punctuation\">(</span><span class=\"token number\">3650</span> days<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Write out database with <span class=\"token number\">1</span> new entries</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Data Base Updated</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>Certificate created at: /opt/easy-rsa/pki/issued/server.crt   <span class=\"token comment\"># 公钥</span></pre></td></tr></table></figure><h6 id=\"424-创建dh密钥\"><a class=\"anchor\" href=\"#424-创建dh密钥\">#</a> 4.2.4 创建 DH 密钥</h6>\n<p>Diffie-Hellman 是⼀种安全协议；让双⽅在完全没有对⽅任何信息情况下通过不安全信道建⽴⼀个密钥； 这个密钥⼀般作为 “对称加密” 的密钥⽽被双⽅在后续数据传输中使⽤；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa gen-dh DH parameters of size 2048 created at /opt/easy-rsa/pki/dh.pem</span></pre></td></tr></table></figure><h6 id=\"425-签发客户端证书\"><a class=\"anchor\" href=\"#425-签发客户端证书\">#</a> 4.2.5 签发客户端证书</h6>\n<p>1. 创建 client 端私钥⽂件，nopass 表示不加密私钥⽂件，其他可默认</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa gen-req client nopass</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Generating a <span class=\"token number\">2048</span> bit RSA private key</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>+++</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.+++</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>writing new private key to <span class=\"token string\">'/opt/easy-rsa/pki/easy-rsa-2191.qCdaPl/tmp.mqfX2L'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>You are about to be asked to enter information that will be incorporated</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>into your certificate request.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>What you are about to enter is what is called a Distinguished Name or a DN.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>There are quite a few fields but you can leave some blank</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>For some fields there will be a default value,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>If you enter <span class=\"token string\">'.'</span>, the field will be left blank.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Common Name <span class=\"token punctuation\">(</span>eg: your user, host, or server name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>client<span class=\"token punctuation\">]</span>:    <span class=\"token comment\">#回车即可</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Keypair and certificate request completed. Your files are:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>req: /opt/easy-rsa/pki/reqs/client.req        <span class=\"token comment\">#请求⽂件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>key: /opt/easy-rsa/pki/private/client.key     <span class=\"token comment\">#私钥⽂件</span></pre></td></tr></table></figure><p>2. 给 client 端证书签名，⾸先是对信息的确认，可以输⼊ yes，然后创建 ca 根证书时设置的密码</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 第⼀个 client 是类型</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 第⼆个 client 是 req 请求⽂件名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa sign client client</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>You are about to sign the following certificate.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Please check over the details shown below <span class=\"token keyword\">for</span> accuracy. Note that this request</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>has not been cryptographically verified. Please be sure it came from a trusted</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">source</span> or that you have verified the request checksum with the sender.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Request subject, to be signed as a client certificate <span class=\"token keyword\">for</span> <span class=\"token number\">3650</span> days:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">subject</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    commonName                <span class=\"token operator\">=</span> <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Type the word <span class=\"token string\">'yes'</span> to continue, or any other input to abort.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  Confirm request details: <span class=\"token function\">yes</span>                      <span class=\"token comment\">#输入 yes</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Using configuration from /opt/easy-rsa/pki/easy-rsa-2218.aCZcDB/tmp.Z2nHgS</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Enter pass phrase <span class=\"token keyword\">for</span> /opt/easy-rsa/pki/private/ca.key:            <span class=\"token comment\">#输入密码</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Check that the request matches the signature</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Signature ok</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>The Subject<span class=\"token string\">'s Distinguished Name is as follows</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>commonName            :ASN.1 12:'</span>yes'</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Certificate is to be certified <span class=\"token keyword\">until</span> Jun  <span class=\"token number\">8</span> <span class=\"token number\">13</span>:29:01 <span class=\"token number\">2033</span> GMT <span class=\"token punctuation\">(</span><span class=\"token number\">3650</span> days<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Write out database with <span class=\"token number\">1</span> new entries</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Data Base Updated</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Certificate created at: /opt/easy-rsa/pki/issued/client.crt     <span class=\"token comment\"># 客户端公钥</span></pre></td></tr></table></figure><h4 id=\"五-openvpn服务安装\"><a class=\"anchor\" href=\"#五-openvpn服务安装\">#</a> 五、OpenVPN 服务安装</h4>\n<h5 id=\"51-安装openvpn服务\"><a class=\"anchor\" href=\"#51-安装openvpn服务\">#</a> 5.1 安装 Openvpn 服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com         #⼀定要同步时间</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -l</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/null</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install openvpn -y</span></pre></td></tr></table></figure><h5 id=\"52-配置openvpn服务\"><a class=\"anchor\" href=\"#52-配置openvpn服务\">#</a> 5.2 配置 openvpn 服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/openvpn/server.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>port <span class=\"token number\">1194</span>                              <span class=\"token comment\">#端口</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proto tcp                              <span class=\"token comment\">#协议</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dev tun                                <span class=\"token comment\">#采用路由隧道模式 tun</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ca ca.crt                              <span class=\"token comment\">#ca 证书文件位置</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cert server.crt                        <span class=\"token comment\">#服务端公钥名称</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>key server.key                         <span class=\"token comment\">#服务端私钥名称</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>dh dh.pem                              <span class=\"token comment\">#交换证书</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token number\">10.8</span>.0.0 <span class=\"token number\">255.255</span>.255.0          <span class=\"token comment\">#给客户端分配地址池，注意：不能和 VPN 服务器内网网段有相同</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>push <span class=\"token string\">\"route 172.16.1.0 255.255.255.0\"</span>  <span class=\"token comment\">#允许客户端访问内网 172.16.1.0 网段，根据实际情况修改</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># push \"redirect-gateway def1\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># push \"dhcp-option DNS 8.8.8.8\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ifconfig-pool-persist ipp.txt       <span class=\"token comment\">#地址池记录文件位置</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>keepalive <span class=\"token number\">10</span> <span class=\"token number\">120</span>                    <span class=\"token comment\">#存活时间，10 秒 ping ⼀次，120 如未收到响应则视为断线</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>max-clients <span class=\"token number\">100</span>                     <span class=\"token comment\">#最多允许 100 个客户端连接</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>status openvpn-status.log           <span class=\"token comment\">#日志记录位置</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>verb <span class=\"token number\">3</span>                              <span class=\"token comment\">#openvpn 版本</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>client-to-client                    <span class=\"token comment\">#客户端与客户端之间通信</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>log /var/log/openvpn.log            <span class=\"token comment\">#openvpn 日志记录位置</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>persist-key                         <span class=\"token comment\">#通过 keepalive 检测超时后，重新启动 VPN，不重新读取 keys，保留第一次使的 keys</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>persist-tun                         <span class=\"token comment\">#检测超时后，重新启动 VPN，一直保持 tun 是 linkup 的。否则网络会先 linkdown 然后再 linkup</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>duplicate-cn</pre></td></tr></table></figure><h5 id=\"53-拷服务端证书文件\"><a class=\"anchor\" href=\"#53-拷服务端证书文件\">#</a> 5.3 拷⻉服务端证书⽂件</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 将服务端证书拷⻉⾄ /etc/openvpn ⽬录下</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">cp</span> /opt/easy-rsa/pki/ca.crt /etc/openvpn/</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">cp</span> /opt/easy-rsa/pki/dh.pem /etc/openvpn/</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">cp</span> /opt/easy-rsa/pki/issued/server.crt /etc/openvpn/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">cp</span> /opt/easy-rsa/pki/private/server.key /etc/openvpn/</pre></td></tr></table></figure><h5 id=\"54-开启内核转发参数\"><a class=\"anchor\" href=\"#54-开启内核转发参数\">#</a> 5.4 开启内核转发参数</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 必须开启内核转发功能</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"net.ipv4.ip_forward = 1\" >> /etc/sysctl.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sysctl -p</span></pre></td></tr></table></figure><h5 id=\"55-启动openvpn服务\"><a class=\"anchor\" href=\"#55-启动openvpn服务\">#</a> 5.5 启动 openvpn 服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable openvpn@server &amp;&amp; systemctl start openvpn@server</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep 1194</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:1194            <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">2522</span>/openvpn</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#检测 1194 端口是否通，阿里云服务器需安全组规则放行 1194</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@jumpserver ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># telnet 192.168.40.70 1194</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Trying <span class=\"token number\">192.168</span>.40.70<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Connected to <span class=\"token number\">192.168</span>.40.70.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Escape character is <span class=\"token string\">'^]'</span><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>eth0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.40.70  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.40.255</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        inet6 fe80::1856:7b0:9d1e:7208  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ether 00:0c:29:75:9b:a9  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        RX packets <span class=\"token number\">2542</span>  bytes <span class=\"token number\">836133</span> <span class=\"token punctuation\">(</span><span class=\"token number\">816.5</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        TX packets <span class=\"token number\">3150</span>  bytes <span class=\"token number\">327134</span> <span class=\"token punctuation\">(</span><span class=\"token number\">319.4</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>eth1: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        inet <span class=\"token number\">172.16</span>.1.70  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">172.16</span>.1.255</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        inet6 fe80::1607:3fa8:6c0d:8f7f  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        ether 00:0c:29:75:9b:b3  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        TX packets <span class=\"token number\">18</span>  bytes <span class=\"token number\">1382</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.3</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        inet6 ::1  prefixlen <span class=\"token number\">128</span>  scopeid 0x1<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        TX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>tun0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">430</span><span class=\"token operator\"><span class=\"token file-descriptor important\">5</span>&lt;</span>UP,POINTOPOINT,RUNNING,NOARP,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        inet <span class=\"token number\">10.8</span>.0.1  netmask <span class=\"token number\">255.255</span>.255.255  destination <span class=\"token number\">10.8</span>.0.2</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        inet6 fe80::d334:578d:2988:1996  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen <span class=\"token number\">100</span>  <span class=\"token punctuation\">(</span>UNSPEC<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        TX packets <span class=\"token number\">3</span>  bytes <span class=\"token number\">144</span> <span class=\"token punctuation\">(</span><span class=\"token number\">144.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"六-openvpn客户端\"><a class=\"anchor\" href=\"#六-openvpn客户端\">#</a> 六、OpenVPN 客户端</h4>\n<h5 id=\"61-客户端连接linux\"><a class=\"anchor\" href=\"#61-客户端连接linux\">#</a> 6.1 客户端连接 Linux</h5>\n<p>1. 端安装 openvpn</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install openvpn -y</span></pre></td></tr></table></figure><p>2. 下载客户端公钥与私钥以及 Ca 证书⾄客户端</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/openvpn/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp root@192.168.40.70:/opt/easy-rsa/pki/ca.crt ./</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp root@192.168.40.70:/opt/easy-rsa/pki/issued/client.crt ./</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp root@192.168.40.70:/opt/easy-rsa/pki/private/client.key ./</span></pre></td></tr></table></figure><p>3. 客户端有了公钥和私钥后，还需要准备对应的客户端配置⽂件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat client.ovpn</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>client                        <span class=\"token comment\">#指定当前 VPN 是客户端</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dev tun                       <span class=\"token comment\">#使用 tun 隧道传输协议</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>proto tcp                     <span class=\"token comment\">#使用 udp 协议传输数据</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>remote <span class=\"token number\">192.168</span>.40.70 <span class=\"token number\">1194</span>     <span class=\"token comment\">#openvpn 服务器 IP 地址端口号</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>resolv-retry infinite         <span class=\"token comment\">#断线后动重新连接，在网络不稳定的情况下非常有用</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nobind                        <span class=\"token comment\">#不绑定本地特定的端口号</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ca ca.crt                     <span class=\"token comment\">#指定 CA 证书的文件路径</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>cert client.crt               <span class=\"token comment\">#指定当前客户端的证书文件路径</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>key client.key                <span class=\"token comment\">#指定当前客户端的私钥文件路径</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>verb <span class=\"token number\">3</span>                        <span class=\"token comment\">#指定日志文件的记录详细级别，可选 0-9，等级越高日志内容越详细</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>persist-key                   <span class=\"token comment\">#通过 keepalive 检测超时后，重新启动 VPN，不重新读取 keys，保留第几次使用的 keys</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>persist-tun                   <span class=\"token comment\">#检测超时后，重新启动 VPN，一直保持 tun 是 linkup 的。否则网络会先 linkdown 然后再 linkup</span></pre></td></tr></table></figure><p>4. 启动 openvpn 客户端</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># openvpn --daemon --cd /etc/openvpn --config client.ovpn --log-append /var/log/openvpn.log</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># --daemon：openvpn 以 daemon ⽅式启动。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># --cd dir：配置⽂件的⽬录，openvpn 初始化前，先切换到此⽬录。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># --config file：客户端配置⽂件的路径。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># --log-append file：⽇志⽂件路径，如果⽂件不存在会⾃动创建。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># ps aux|grep openvpn</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>root       <span class=\"token number\">2675</span>  <span class=\"token number\">0.0</span>  <span class=\"token number\">0.1</span>  <span class=\"token number\">75164</span>  <span class=\"token number\">3448</span> ?        Ss   <span class=\"token number\">16</span>:20   <span class=\"token number\">0</span>:00 openvpn <span class=\"token parameter variable\">--daemon</span> <span class=\"token parameter variable\">--cd</span> /etc/openvpn <span class=\"token parameter variable\">--config</span> client.ovpn --log-append /var/log/openvpn.log</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>root       <span class=\"token number\">2705</span>  <span class=\"token number\">0.0</span>  <span class=\"token number\">0.0</span> <span class=\"token number\">112812</span>   <span class=\"token number\">980</span> pts/0    S+   <span class=\"token number\">16</span>:21   <span class=\"token number\">0</span>:00 <span class=\"token function\">grep</span> <span class=\"token parameter variable\">--color</span><span class=\"token operator\">=</span>auto openvpn</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>eth0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.40.51  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.40.255</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        inet6 fe80::63d4:467f:9b76:e34f  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        inet6 fe80::1856:7b0:9d1e:7208  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ether 00:0c:29:e0:f8:86  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        RX packets <span class=\"token number\">2911</span>  bytes <span class=\"token number\">880086</span> <span class=\"token punctuation\">(</span><span class=\"token number\">859.4</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        TX packets <span class=\"token number\">1943</span>  bytes <span class=\"token number\">249205</span> <span class=\"token punctuation\">(</span><span class=\"token number\">243.3</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>eth1: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        inet <span class=\"token number\">172.16</span>.1.51  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">172.16</span>.1.255</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        inet6 fe80::1607:3fa8:6c0d:8f7f  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        inet6 fe80::b64e:4e5e:1653:e542  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        ether 00:0c:29:e0:f8:90  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        RX packets <span class=\"token number\">6</span>  bytes <span class=\"token number\">516</span> <span class=\"token punctuation\">(</span><span class=\"token number\">516.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        TX packets <span class=\"token number\">66</span>  bytes <span class=\"token number\">5642</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5.5</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        inet6 ::1  prefixlen <span class=\"token number\">128</span>  scopeid 0x1<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        RX packets <span class=\"token number\">97</span>  bytes <span class=\"token number\">15400</span> <span class=\"token punctuation\">(</span><span class=\"token number\">15.0</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        TX packets <span class=\"token number\">97</span>  bytes <span class=\"token number\">15400</span> <span class=\"token punctuation\">(</span><span class=\"token number\">15.0</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>tun0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">430</span><span class=\"token operator\"><span class=\"token file-descriptor important\">5</span>&lt;</span>UP,POINTOPOINT,RUNNING,NOARP,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        inet <span class=\"token number\">10.8</span>.0.6  netmask <span class=\"token number\">255.255</span>.255.255  destination <span class=\"token number\">10.8</span>.0.5</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        inet6 fe80::7cc6:553f:e98d:9633  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen <span class=\"token number\">100</span>  <span class=\"token punctuation\">(</span>UNSPEC<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        TX packets <span class=\"token number\">3</span>  bytes <span class=\"token number\">144</span> <span class=\"token punctuation\">(</span><span class=\"token number\">144.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr></table></figure><h5 id=\"62-客户端连接windows\"><a class=\"anchor\" href=\"#62-客户端连接windows\">#</a> 6.2 客户端连接 Windows</h5>\n<p>openvpn for windows 客户端下载地址、openvpn-2.4.11-Win7.exe、openvpn-2.4.11-Win10.exe</p>\n<p>1. 下载服务端准备的客户端密钥⽂件和 ca ⽂件⾄ C:\\Program Files\\OpenVPN\\config ⽬录中</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sz /opt/easy-rsa/pki/ca.crt</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sz /opt/easy-rsa/pki/issued/client.crt</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sz /opt/easy-rsa/pki/private/client.key</span></pre></td></tr></table></figure><p>2. 在 C:\\Program Files\\OpenVPN\\config 创建⼀个客户端配置⽂件，名称叫 client.ovpn</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>client                       <span class=\"token comment\">#指定当前 VPN 是客户端</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dev tun                      <span class=\"token comment\">#使用 tun 隧道传输协议</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proto tcp                    <span class=\"token comment\">#使用 udp 协议传输数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>remote <span class=\"token number\">192.168</span>.40.70 <span class=\"token number\">1194</span>   <span class=\"token comment\">#openvpn 服务器 IP 地址端口号</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>resolv-retry infinite        <span class=\"token comment\">#断线自动重新连接，在网络不稳定的情况下非常有用</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nobind                       <span class=\"token comment\">#不绑定本地特定的端口号</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ca ca.crt                    <span class=\"token comment\">#指定 CA 证书的文件路径</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>cert client.crt              <span class=\"token comment\">#指定当前客户端的证书文件路径</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>key client.key               <span class=\"token comment\">#指定当前客户端的私钥文件路径</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>verb <span class=\"token number\">3</span>                       <span class=\"token comment\">#指定日志文件的记录详细级别，可选 0-9，等级越越高志内容越详细</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>persist-key                  <span class=\"token comment\">#通过 keepalive 检测超时后，重新启动 VPN，不重新读取 keys，保留第一次使用的 keys</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>persist-tun                  <span class=\"token comment\">#检测超时后，重新启动 VPN，一直保持 tun 是 linkup 的。否则网络会先 linkdown 然后再 linkup</span></pre></td></tr></table></figure><p>3. 最终 windows 的⽬录中配置⽂件如下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>C:<span class=\"token punctuation\">\\</span>Program Files<span class=\"token punctuation\">\\</span>OpenVPN<span class=\"token punctuation\">\\</span>config</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ca.crt</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>client.crt</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>client.key</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>client.ovpn</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>README.txt</pre></td></tr></table></figure><p>4. 登陆成功后，通过 windows 查看 openvpn 服务推送过来的路由信息；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看连接状态 10.8.0.6 连接 172.16.1.60</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -nt</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Active Internet connections <span class=\"token punctuation\">(</span>w/o servers<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State      </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>tcp        <span class=\"token number\">0</span>     <span class=\"token number\">36</span> <span class=\"token number\">172.16</span>.1.70:22          <span class=\"token number\">10.8</span>.0.6:52391          ESTABLISHED</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.70:1194      <span class=\"token number\">192.168</span>.40.1:52319      ESTABLISHED</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.70:22        <span class=\"token number\">192.168</span>.40.1:51544      ESTABLISHED</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># windows 查看推送过来的路由信息</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>C:<span class=\"token punctuation\">\\</span>~<span class=\"token punctuation\">]</span>$ route print <span class=\"token parameter variable\">-4</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>接口列表</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token number\">14</span><span class=\"token punctuation\">..</span>.94 c6 <span class=\"token number\">91</span> <span class=\"token number\">22</span> 3a e8 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>Realtek PCIe GBE Family Controller</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token number\">13</span><span class=\"token punctuation\">..</span>.00 ff 9c <span class=\"token number\">82</span> 0c c4 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>TAP-Windows Adapter V9</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token number\">5</span><span class=\"token punctuation\">..</span>.52 2b <span class=\"token number\">73</span> e8 4f b4 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>Microsoft Wi-Fi Direct Virtual Adapter</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token number\">18</span><span class=\"token punctuation\">..</span>.50 2b <span class=\"token number\">73</span> e8 4f b4 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>Microsoft Wi-Fi Direct Virtual Adapter <span class=\"token comment\">#2</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token number\">20</span><span class=\"token punctuation\">..</span>.00 <span class=\"token number\">50</span> <span class=\"token number\">56</span> c0 00 01 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>VMware Virtual Ethernet Adapter <span class=\"token keyword\">for</span> VMnet1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token number\">11</span><span class=\"token punctuation\">..</span>.00 <span class=\"token number\">50</span> <span class=\"token number\">56</span> c0 00 08 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>VMware Virtual Ethernet Adapter <span class=\"token keyword\">for</span> VMnet8</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token number\">10</span><span class=\"token punctuation\">..</span>.00 <span class=\"token number\">50</span> <span class=\"token number\">56</span> c0 00 0f <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>VMware Virtual Ethernet Adapter <span class=\"token keyword\">for</span> VMnet15</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token number\">17</span><span class=\"token punctuation\">..</span>.50 2b <span class=\"token number\">73</span> e8 4f b4 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>Realtek 8188GU Wireless LAN <span class=\"token number\">802</span>.11n USB NIC</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token number\">1</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.Software Loopback Interface <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>IPv4 路由表</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>活动路由:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>网络目标        网络掩码          网关       接口   跃点数</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          <span class=\"token number\">0.0</span>.0.0          <span class=\"token number\">0.0</span>.0.0      <span class=\"token number\">192.168</span>.1.1    <span class=\"token number\">192.168</span>.1.102     <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>         <span class=\"token number\">10.8</span>.0.0    <span class=\"token number\">255.255</span>.255.0         <span class=\"token number\">10.8</span>.0.5         <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>         <span class=\"token number\">10.8</span>.0.4  <span class=\"token number\">255.255</span>.255.252            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>         <span class=\"token number\">10.8</span>.0.6  <span class=\"token number\">255.255</span>.255.255            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>         <span class=\"token number\">10.8</span>.0.7  <span class=\"token number\">255.255</span>.255.255            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token number\">127.0</span>.0.0        <span class=\"token number\">255.0</span>.0.0            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token number\">127.0</span>.0.1  <span class=\"token number\">255.255</span>.255.255            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token number\">127.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>       <span class=\"token number\">172.16</span>.1.0    <span class=\"token number\">255.255</span>.255.0         <span class=\"token number\">10.8</span>.0.5         <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span>         <span class=\"token comment\">#路由条目</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token number\">192.168</span>.1.0    <span class=\"token number\">255.255</span>.255.0            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token number\">192.168</span>.1.102  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token number\">192.168</span>.1.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>     <span class=\"token number\">192.168</span>.40.0    <span class=\"token number\">255.255</span>.255.0            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>     <span class=\"token number\">192.168</span>.40.1  <span class=\"token number\">255.255</span>.255.255            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   <span class=\"token number\">192.168</span>.40.255  <span class=\"token number\">255.255</span>.255.255            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token number\">192.168</span>.137.0    <span class=\"token number\">255.255</span>.255.0            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token number\">192.168</span>.137.1  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token number\">192.168</span>.137.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token number\">192.168</span>.195.0    <span class=\"token number\">255.255</span>.255.0            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token number\">192.168</span>.195.1  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token number\">192.168</span>.195.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>永久路由:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  无</pre></td></tr></table></figure><h4 id=\"七-openvpn用户密码认证\"><a class=\"anchor\" href=\"#七-openvpn用户密码认证\">#</a> 七、OpenVPN ⽤户密码认证</h4>\n<p>我们⽬前使⽤密钥进⾏加密传输，可以说已经很安全了，为什么还要需要⽤户名秘密呢。</p>\n<p>1、首先管理这些秘钥和证书⽐较麻烦，如果⽤户⽐较多，单独为每个⽤户都创建⼀套秘钥⽐较麻烦；<br />\n2、其次多⼈使⽤同⼀秘钥⼜不具有唯⼀性，⽐如说有⽤户不在需要 VPN 的时候，我们就需要吊销证书，如果多⼈使⽤⼀个秘钥的情况下，吊销证书会造成其他⽤户也⽆法正常登录。</p>\n<p>所以就需要秘钥加⽤户名密码，这样就可以实现多个⽤户使⽤同⼀个证书，使⽤不同的⽤户名和密码； 当有新⽤户加⼊时，只需要添加⼀个⽤户名和密码即可，如果不需要使⽤，则删除⽤户名和密码即可；</p>\n<h5 id=\"71-openvpn服务端配置\"><a class=\"anchor\" href=\"#71-openvpn服务端配置\">#</a> 7.1 OpenVPN 服务端配置</h5>\n<p>1、修改服务端配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加如下三⾏代码，使其服务端⽀持密码认证⽅式</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/openvpn/server.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>script-security <span class=\"token number\">3</span>                                         <span class=\"token comment\">#允许使用自定义脚本</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>auth-user-pass-verify /etc/openvpn/check.sh via-env       <span class=\"token comment\">#自定义脚本路径</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>username-as-common-name                                   <span class=\"token comment\">#用户密码登陆方式验证</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 表示只使用用户名密码方式验证，不加该参数，则代表需要证书、用户名、密码多重验证登录</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># client-cert-not-required</span></pre></td></tr></table></figure><p>2、创建⾃定义脚本</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/openvpn/check.sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/bin/sh</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">###########################################################</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">PASSFILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"/etc/openvpn/openvpnfile\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">LOG_FILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"/var/log/openvpn-password.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">TIME_STAMP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> <span class=\"token string\">\"+%Y-%m-%d %T\"</span><span class=\"token variable\">`</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-r</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;PASSFILE&#125;</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;TIME_STAMP&#125;</span>: Could not open password file <span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;PASSFILE&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span> for reading.\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">CORRECT_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">awk</span> <span class=\"token string\">'!/^;/&amp;&amp;!/^#/&amp;&amp;$1==\"'</span>$<span class=\"token punctuation\">&#123;</span>username<span class=\"token punctuation\">&#125;</span><span class=\"token string\">'\"&#123;print $2;exit&#125;'</span> $<span class=\"token punctuation\">&#123;</span>PASSFILE<span class=\"token punctuation\">&#125;</span><span class=\"token variable\">`</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;CORRECT_PASSWORD&#125;</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;TIME_STAMP&#125;</span>: User does not exist: username=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;username&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>, password=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;password&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>.\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;password&#125;</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;CORRECT_PASSWORD&#125;</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;TIME_STAMP&#125;</span>: Successful authentication: username=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;username&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>.\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;TIME_STAMP&#125;</span>: Incorrect password: username=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;username&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>, password=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;password&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>.\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 为脚本增加执⾏权限</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /etc/openvpn/check.sh</span></pre></td></tr></table></figure><p>3、创建⽤户密码⽂件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 `check.sh` 脚本中定义 `openvpn` 使⽤的⽤户和密码认证⽂件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">></span> /etc/openvpn/openvpnfile <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>xuyong 123456</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p>4、重启 OpenVPN 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart openvpn@server</span></pre></td></tr></table></figure><h5 id=\"72-openvpn客户端配置\"><a class=\"anchor\" href=\"#72-openvpn客户端配置\">#</a> 7.2 OpenVPN 客户端配置</h5>\n<p>1、修改客户端配置 C:\\Program Files\\OpenVPN\\config</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改客户端配置文件，增加如下代码，使其支持用户名 / 密码与服务器进行身份验证；</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>auth-user-pass                <span class=\"token comment\">#用户密码认证</span></pre></td></tr></table></figure><p>2、客户端重新登陆</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/HwnEpBm.jpeg\" alt=\"Snipaste_2025-06-07_23-10-45.jpg\" /></p>\n<h4 id=\"八-openvpn访问内部网段\"><a class=\"anchor\" href=\"#八-openvpn访问内部网段\">#</a> 八、OpenVPN 访问内部⽹段</h4>\n<h5 id=\"81-内部节点无法正常访问\"><a class=\"anchor\" href=\"#81-内部节点无法正常访问\">#</a> <strong>8.1</strong> 内部节点无法正常访问</h5>\n<p>抓包分析数据包能抵达 openvpn 的内⽹地址，但⽆法与 OpenVPN 服务同内⽹⽹段主机进⾏通信；</p>\n<p>因为后端主机没有去往 10.8.0.0 ⽹段的路由，所以数据包⽆法原路返回，最终造成⽆法 ping 通</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@windows ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ping 172.16.1.51 -t</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>正在 Ping <span class=\"token number\">172.16</span>.1.51 具有 <span class=\"token number\">32</span> 字节的数据:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>请求超时。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#在后端的主机上抓包分析，发现能接收到数据包，但没有回去的路由所以⽆法通信</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span> tcpdump  <span class=\"token parameter variable\">-i</span> eth1 <span class=\"token parameter variable\">-nn</span> <span class=\"token parameter variable\">-p</span> icmp</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tcpdump: verbose output suppressed, use <span class=\"token parameter variable\">-v</span> or <span class=\"token parameter variable\">-vv</span> <span class=\"token keyword\">for</span> full protocol decode</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>listening on eth1, link-type EN10MB <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span>, capture size <span class=\"token number\">262144</span> bytes</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">16</span>:44:54.957022 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">137</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">16</span>:44:59.956197 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">138</span>, length <span class=\"token number\">40</span></pre></td></tr></table></figure><p>解决此问题有如下⼏种⽅式：</p>\n<p>⽅式 1：在每台节点添加⼀条路由，下⼀跳为 Openvpn 节点；</p>\n<p>⽅式 2：在所有内⽹主机的默认路由器上添加⼀条路由，下⼀跳为 Openvpn 节点；</p>\n<p>⽅式 3：配置 iptables、firewalld 的 NAT 规则</p>\n<h5 id=\"82-在节点上添加主机路由\"><a class=\"anchor\" href=\"#82-在节点上添加主机路由\">#</a> 8.2 在节点上添加主机路由</h5>\n<p>1、在后端主机添加抵达去往 10.8.0.0/24 ⽹段的⾛ openvpn 的内⽹地址进⾏路由（原理如下图）</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/HKR4TLX.jpeg\" alt=\"1.jpg\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span> route <span class=\"token function\">add</span> <span class=\"token parameter variable\">-net</span> <span class=\"token number\">10.8</span>.0.0/24 gw <span class=\"token number\">172.16</span>.1.70</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># route -n</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Kernel IP routing table</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">192.168</span>.40.2    <span class=\"token number\">0.0</span>.0.0         UG    <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">10.8</span>.0.0        <span class=\"token number\">172.16</span>.1.70     <span class=\"token number\">255.255</span>.255.0   UG    <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">172.16</span>.1.0      <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">101</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">192.168</span>.40.0    <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth0</pre></td></tr></table></figure><p>2、添加完路由后，继续 ping 该节点，在抓包查看</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span> tcpdump  <span class=\"token parameter variable\">-i</span> eth1 <span class=\"token parameter variable\">-nn</span> <span class=\"token parameter variable\">-p</span> icmp</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>tcpdump: verbose output suppressed, use <span class=\"token parameter variable\">-v</span> or <span class=\"token parameter variable\">-vv</span> <span class=\"token keyword\">for</span> full protocol decode</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>listening on eth1, link-type EN10MB <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span>, capture size <span class=\"token number\">262144</span> bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">16</span>:48:14.054654 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">240</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">16</span>:48:14.054673 IP <span class=\"token number\">172.16</span>.1.51 <span class=\"token operator\">></span> <span class=\"token number\">10.8</span>.0.10: ICMP <span class=\"token builtin class-name\">echo</span> reply, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">240</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">16</span>:48:15.055662 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">241</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">16</span>:48:15.055683 IP <span class=\"token number\">172.16</span>.1.51 <span class=\"token operator\">></span> <span class=\"token number\">10.8</span>.0.10: ICMP <span class=\"token builtin class-name\">echo</span> reply, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">241</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">16</span>:48:16.056026 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">242</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">16</span>:48:16.056046 IP <span class=\"token number\">172.16</span>.1.51 <span class=\"token operator\">></span> <span class=\"token number\">10.8</span>.0.10: ICMP <span class=\"token builtin class-name\">echo</span> reply, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">242</span>, length <span class=\"token number\">40</span></pre></td></tr></table></figure><p>3、通过 vpn 连接内⽹服务器，检查内⽹服务器与哪个 IP 建⽴连接（会发现是真实的 VPN 客户端节点）；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span> <span class=\"token function\">netstat</span> <span class=\"token parameter variable\">-nt</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Active Internet connections <span class=\"token punctuation\">(</span>w/o servers<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State      </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>tcp        <span class=\"token number\">0</span>     <span class=\"token number\">36</span> <span class=\"token number\">172.16</span>.1.51:22          <span class=\"token number\">10.8</span>.0.10:53947         ESTABLISHED</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.51:22        <span class=\"token number\">192.168</span>.40.1:53130      ESTABLISHED</pre></td></tr></table></figure><h5 id=\"83-配置nat地址替换\"><a class=\"anchor\" href=\"#83-配置nat地址替换\">#</a> 8.3 配置 NAT 地址替换</h5>\n<p>如上的配置需要在所有后端主机添加，如果机器量过多，那么添加起来⾮常的麻烦，可以在 VPN 节点上增加防⽕墙规则配置，实现地址替换（原理如下图）</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/bhcIl0l.jpeg\" alt=\"2.jpg\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Iptables</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth1 -j MASQUERADE    # ⾃动</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth1 -j SNAT --to 172.16.1.70</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># Firewalld</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start firewalld</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># firewall-cmd --add\u0002service=openvpn --permanent</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># firewall-cmd --add-masquerade --permanent</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># firewall-cmd --reload</span></pre></td></tr></table></figure><p>2. 通过 vpn 连接内⽹服务器，检查内⽹服务器与哪个 IP 建⽴连接（会发现是 SNAT 后的内⽹ IP）；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@windows ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh root@172.16.1.51</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -nt|grep 22</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.51:22        <span class=\"token number\">192.168</span>.40.1:60083      ESTABLISHED</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>tcp        <span class=\"token number\">0</span>     <span class=\"token number\">36</span> <span class=\"token number\">172.16</span>.1.51:22          <span class=\"token number\">172.16</span>.1.70:60439       ESTABLISHED</pre></td></tr></table></figure><h5 id=\"84-配置路由器路由条目公有云\"><a class=\"anchor\" href=\"#84-配置路由器路由条目公有云\">#</a> 8.4 配置路由器路由条⽬（公有云）</h5>\n<p><strong>实验环境准备</strong>：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/JvZgcbw.jpeg\" alt=\"2.jpg\" /></p>\n<p>1. 华南 3 买三台，公网 IP，安全组放行 1194 端口；</p>\n<p>2. 西南购买 1 台，公网 IP；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/k6asgYc.jpeg\" alt=\"1.jpg\" /></p>\n<p><strong>实现场景 1：</strong><br />\n1.Windows 主机通过远程访问 vpn，能够直接链接阿里云内网主机；</p>\n<p>方法一：给路由器添加路由条目，指向 VPN 主机；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/dHe7eNU.jpeg\" alt=\"5.jpg\" /></p>\n<p>方法二： 在 VPN 主机上使用 iptables 或 firewalld 规则；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iptables <span class=\"token parameter variable\">-t</span> nat <span class=\"token parameter variable\">-A</span> POSTROUTING <span class=\"token parameter variable\">-s</span> <span class=\"token number\">10.8</span>.0.0/24 <span class=\"token parameter variable\">-o</span> eth0 <span class=\"token parameter variable\">-j</span> SNAT <span class=\"token parameter variable\">--to</span> <span class=\"token number\">172.16</span>.1.70</pre></td></tr></table></figure><p><strong>实现场景 2：</strong>\t<br />\n1. 西南 Linux 主机拨入 vpn 后，可以直接访问华南地域的内网；</p>\n<p><strong>实现场景 3：</strong><br />\n1.windows 和西南地区的 Linux 主机都拨入了 VPN，它们之间通过虚拟地址是可以互通；</p>\n<h4 id=\"九-openvp结合jumpserver\"><a class=\"anchor\" href=\"#九-openvp结合jumpserver\">#</a> 九、OpenVP 结合 Jumpserver</h4>\n<p>实现拨通 OpenVPN 后，仅能够访问 Jumpserver172.16.1.61.</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/openvpn/server.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>port <span class=\"token number\">1194</span>                              <span class=\"token comment\">#端口</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proto tcp                              <span class=\"token comment\">#协议</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dev tun                                <span class=\"token comment\">#采用路由隧道模式 tun</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ca ca.crt                              <span class=\"token comment\">#ca 证书文件位置</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cert server.crt                        <span class=\"token comment\">#服务端公钥名称</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>key server.key                         <span class=\"token comment\">#服务端私钥名称</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>dh dh.pem                              <span class=\"token comment\">#交换证书</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token number\">10.8</span>.0.0 <span class=\"token number\">255.255</span>.255.0          <span class=\"token comment\">#给客户端分配地址池，注意：不能和 VPN 服务器内网网段有相同</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>push <span class=\"token string\">\"route 172.16.1.61 255.255.255.255\"</span>  <span class=\"token comment\">#允许客户端访问内网 172.16.1.61 主机，根据实际情况修改</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># push \"redirect-gateway def1\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># push \"dhcp-option DNS 8.8.8.8\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ifconfig-pool-persist ipp.txt       <span class=\"token comment\">#地址池记录文件位置</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>keepalive <span class=\"token number\">10</span> <span class=\"token number\">120</span>                    <span class=\"token comment\">#存活时间，10 秒 ping ⼀次，120 如未收到响应则视为断线</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>max-clients <span class=\"token number\">100</span>                     <span class=\"token comment\">#最多允许 100 个客户端连接</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>status openvpn-status.log           <span class=\"token comment\">#日志记录位置</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>verb <span class=\"token number\">3</span>                              <span class=\"token comment\">#openvpn 版本</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>client-to-client                    <span class=\"token comment\">#客户端与客户端之间通信</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>log /var/log/openvpn.log            <span class=\"token comment\">#openvpn 日志记录位置</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>persist-key                         <span class=\"token comment\">#通过 keepalive 检测超时后，重新启动 VPN，不重新读取 keys，保留第一次使的 keys</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>persist-tun                         <span class=\"token comment\">#检测超时后，重新启动 VPN，一直保持 tun 是 linkup 的。否则网络会先 linkdown 然后再 linkup</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>duplicate-cn</pre></td></tr></table></figure>",
            "tags": [
                "Openvpn"
            ]
        }
    ]
}