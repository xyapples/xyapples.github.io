{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"nginx\" category",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/865547436.html",
            "url": "http://ixuyong.cn/posts/865547436.html",
            "title": "Nginx基础架构LNMP",
            "date_published": "2025-08-23T13:50:04.000Z",
            "content_html": "<h3 id=\"nginx基础架构lnmp\"><a class=\"anchor\" href=\"#nginx基础架构lnmp\">#</a> Nginx 基础架构 LNMP</h3>\n<h4 id=\"1-lnmp架构基本概述\"><a class=\"anchor\" href=\"#1-lnmp架构基本概述\">#</a> 1. LNMP 架构基本概述</h4>\n<h5 id=\"11-什么是lnmp\"><a class=\"anchor\" href=\"#11-什么是lnmp\">#</a> 1.1 什么是 LNMP</h5>\n<ul>\n<li>LNMP 是一套技术的组合，L=Linux、N=Nginx、M=[MySQL8.0|Mariadb5.5]、P=[PHP|Python]；</li>\n<li>nginx 仅支持解析 html 文件；图片传输；视频传输，不支持 php 脚本文件；</li>\n</ul>\n<h5 id=\"12-lnmp实现过程\"><a class=\"anchor\" href=\"#12-lnmp实现过程\">#</a> 1.2 LNMP 实现过程</h5>\n<p>用户请求 http://hmallleasing.com/index.php，对于 Nginx 服务而言，是无法处理 index.php 这样的脚本，那么 Nginx 该如何配置，才能支持这样的动态请求呢？</p>\n<p>第一步：当用户发起 HTTP 请求，请求首先被 Nginx 接收；</p>\n<p>第二步：Nginx 通过预先定义好的 location 规则进行匹配；</p>\n<p>第三步：Nginx 将匹配到的动态内容，通过 fastcgi 协议传到给后端的 php 应用服务处理</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1vVYqB8.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"13-lnmp实现细节\"><a class=\"anchor\" href=\"#13-lnmp实现细节\">#</a> 1.3 LNMP 实现细节</h5>\n<p>Nginx、PHP、MySQL 之间是如何工作的？</p>\n<ul>\n<li>1. 用户首先通过 http 协议发起请求，请求会先抵达 Nginx；</li>\n<li>2.Nginx 根据用户的请求进行 Location 规则匹配；</li>\n<li>3.Location 如果匹配到请求是静态，则由 Nginx 读取本地直接返回；</li>\n<li>4.Location 如果匹配到请求是动态，则由 Nginx 将请求转发给 fastcgi 协议；</li>\n<li>5.fastgi 收到后会将请求交给 php-fpm 管理进程；</li>\n<li>6.php-fpm 管理进程接收到后会调用具体的 worker 工作进程</li>\n<li>6.warrap 进程会调用 php 解析器解析代码，php 解析后直接返回</li>\n<li>7. 如果有查询数据库操作，则由 php 连接数据库 (用户 密码 IP) 发起查询的操作</li>\n<li>8. 最终数据由 mysql-&gt;php-&gt;php-fpm-&gt;fastcgi-&gt;nginx-&gt;http-&gt;user</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/pHd8HBp.jpeg\" alt=\"2.jpg\" /></p>\n<h4 id=\"2lnmp架构环境安装\"><a class=\"anchor\" href=\"#2lnmp架构环境安装\">#</a> 2.LNMP 架构环境安装</h4>\n<h5 id=\"21-nginx安装\"><a class=\"anchor\" href=\"#21-nginx安装\">#</a> 2.1 Nginx 安装</h5>\n<p>1. 使用官方仓库安装 Nginx</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/yum.repos.d/nginx.repo </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>nginx-stable<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>nginx stable repo</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>http://nginx.org/packages/centos/<span class=\"token variable\">$releasever</span>/<span class=\"token variable\">$basearch</span>/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">gpgkey</span><span class=\"token operator\">=</span>https://nginx.org/keys/nginx_signing.key</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">module_hotfixes</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr></table></figure><p>2. 配置 Nginx 进程运行用户</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g666 www</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u666 -g666 www</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user www;' /etc/nginx/nginx.conf</span></pre></td></tr></table></figure><p>3. 启动 Nginx，并将 Nginx 加入开机自启</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@oldxu ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nginx</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@oldxu ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nginx</span></pre></td></tr></table></figure><h5 id=\"22-php安装\"><a class=\"anchor\" href=\"#22-php安装\">#</a> 2.2 PHP 安装</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、移除旧版 php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum remove php-mysql-5.4 php php-fpm php-common</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2.2 安装扩展源</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum localinstall https://mirror.webtatic.com/yum/el7/webtatic-release.rpm -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、安装 php7.1 版本</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4. 配置 php-fpm 用户与 Nginx 的运行用户保持一致</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^group/c group = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#5、启动 php</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start php-fpm &amp;&amp; systemctl enable php-fpm</span></pre></td></tr></table></figure><h5 id=\"23-mysql安装\"><a class=\"anchor\" href=\"#23-mysql安装\">#</a> 2.3 MySQL 安装</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、下载 MySQL 官方扩展源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ivh http://repo.mysql.com/yum/mysql-5.7-community/el/7/x86_64/mysql57-community-release-el7-10.noarch.rpm</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2、安装 mysql5.7，文件过大可能会导致下载缓慢</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mysql-community-server -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、启动并加入开机自动启动</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4、查看端口是否启动</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:22              <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">3788</span>/sshd           </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:25            <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">4018</span>/master         </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::3306                 :::*                    LISTEN      <span class=\"token number\">4628</span>/mysqld         </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::22                   :::*                    LISTEN      <span class=\"token number\">3788</span>/sshd           </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> ::1:25                  :::*                    LISTEN      <span class=\"token number\">4018</span>/master </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#5、由于 mysql5.7 默认配置密码，需要过滤 temporary password 关键字查看对应登陆数据库密码</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># grep 'temporary password' /var/log/mysqld.log</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#6、登录 mysql 数据库 [password 中填写上一步过滤的密码]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#6、重新修改数据库密码</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'app'</span>@<span class=\"token string\">'192.168.40.%'</span> identified by <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"3lnmp架构环境配置\"><a class=\"anchor\" href=\"#3lnmp架构环境配置\">#</a> 3.LNMP 架构环境配置</h4>\n<p>在配置 Nginx 与 PHP 集成之前， 我们需要先了解 Nginx 的 Fastcgi 代理配置语法</p>\n<h5 id=\"31-fastcgi代理语法\"><a class=\"anchor\" href=\"#31-fastcgi代理语法\">#</a> 3.1 Fastcgi 代理语法</h5>\n<p>1. 设置 fastcgi 服务器的地址，该地址可以指定为域名或 IP 地址，以及端口</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: fastcgi_pass address<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: location, <span class=\"token keyword\">if</span> <span class=\"token keyword\">in</span> location</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#语法示例</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>fastcgi_pass localhost:9000<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>2. 设置 fastcgi 默认的首页文件，需要结合 fastcgi_param 一起设置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: fastcgi_index name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><p>3. 通过 fastcgi_param 设置变量，并将设置的变量传递到后端的 fastcgi 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: fastcgi_param parameter value</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>if_not_empty<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#语法示例</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>fastcgi_index index.php<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>fastcgi_param SCRIPT_FILENAME</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>4. 通过图形方式展示 fastcgi_index 与 fastcgi_param 作用。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zUUojVD.jpeg\" alt=\"3.jpg\" /></p>\n<h5 id=\"32-nginx与php集成\"><a class=\"anchor\" href=\"#32-nginx与php集成\">#</a> 3.2 Nginx 与 PHP 集成</h5>\n<p>1. 编写 Nginx 配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat zh.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver_name php.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tfastcgi_pass   <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tfastcgi_param  SCRIPT_FILENAME  <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tinclude        fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2. 在 /code 目录下创建 info.php 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/info.php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?php</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tphpinfo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>?<span class=\"token operator\">></span></pre></td></tr></table></figure><p>3. 通过浏览器访问 /info.php，返回如下页面表示 nginx 与 php 配置成功；</p>\n",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3682494305.html",
            "url": "http://ixuyong.cn/posts/3682494305.html",
            "title": "Nginx常用模块",
            "date_published": "2025-08-22T13:50:04.000Z",
            "content_html": "<h3 id=\"nginx常用模块\"><a class=\"anchor\" href=\"#nginx常用模块\">#</a> Nginx 常用模块</h3>\n<h4 id=\"1-nginx安装部署\"><a class=\"anchor\" href=\"#1-nginx安装部署\">#</a> 1. Nginx 安装部署</h4>\n<h5 id=\"11-安装nginx方式\"><a class=\"anchor\" href=\"#11-安装nginx方式\">#</a> <strong>1.1</strong> 安装 Nginx 方式</h5>\n<p>安装 Nginx 软件的方式有很多种，分为如下几种</p>\n<ul>\n<li>源码编译 =&gt;Nginx (1. 版本随意 2. 安装复杂 3. 升级繁琐)</li>\n<li>epel 仓库 =&gt;Nginx (1. 版本较低 2. 安装简单 3. 配置不易读)</li>\n<li>官方仓库 =&gt;Nginx (1. 版本较新 2. 安装简单 3. 配置易读，强烈推荐</li>\n</ul>\n<h5 id=\"12-安装nginx依赖\"><a class=\"anchor\" href=\"#12-安装nginx依赖\">#</a> <strong>1.2</strong> 安装 Nginx 依赖</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake httpd-tools</span></pre></td></tr></table></figure><h5 id=\"13-配置nginx源\"><a class=\"anchor\" href=\"#13-配置nginx源\">#</a> 1.3 配置 Nginx 源</h5>\n<p>官网 https://nginx.org -&gt; 点击 download -&gt; 点击 Pre-Built Packages-&gt; 点击 stable and mainline -&gt; 选择系统 RHEL and derivatives</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/yum.repos.d/nginx.repo </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>nginx-stable<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>nginx stable repo</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>http://nginx.org/packages/centos/<span class=\"token variable\">$releasever</span>/<span class=\"token variable\">$basearch</span>/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">gpgkey</span><span class=\"token operator\">=</span>https://nginx.org/keys/nginx_signing.key</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">module_hotfixes</span><span class=\"token operator\">=</span>true</pre></td></tr></table></figure><h5 id=\"14-安装nginx服务\"><a class=\"anchor\" href=\"#14-安装nginx服务\">#</a> <strong>1.4</strong> 安装 Nginx 服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nginx &amp;&amp; systemctl enable nginx</span></pre></td></tr></table></figure><h5 id=\"15-检查nginx版本\"><a class=\"anchor\" href=\"#15-检查nginx版本\">#</a> 1.5 检查 Nginx 版本</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 检查版本</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -v</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx version: nginx/1.26.1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 检查编译参数</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -V</span></pre></td></tr></table></figure><h4 id=\"2-nginx目录结构\"><a class=\"anchor\" href=\"#2-nginx目录结构\">#</a> 2. Nginx 目录结构</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.Nginx 主配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/etc/nginx/conf.d/default.conf    <span class=\"token comment\">#默认网站配置文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/etc/nginx/nginx.conf             <span class=\"token comment\">#nginx 主配置文件</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#2.Nginx 代理配置文件</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>/etc/nginx/fastcgi_params         <span class=\"token comment\">#Fastcgi 代理配置文件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>/etc/nginx/scgi_params            <span class=\"token comment\">#scgi 代理配置文件</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>/etc/nginx/uwsgi_params           <span class=\"token comment\">#uwsgi 代理配置文件</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#3.Nginx 编码配置文件</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>/etc/nginx/mime.types             <span class=\"token comment\">#Content-Type 与扩展名</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#4.Nginx 管理命令文件</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>/usr/sbin/nginx                   <span class=\"token comment\">#Nginx 命令行管理终端工具</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>/usr/sbin/nginx-debug             <span class=\"token comment\">#Nginx 命令行与终端调试工具</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#5.Nginxx 日志相关文件</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>/var/log/nginx                    <span class=\"token comment\">#Nginx 默认存放日志目录</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>/etc/logrotate.d/nginx            <span class=\"token comment\">#Nginx 默认的日志切割</span></pre></td></tr></table></figure><h4 id=\"3-nginx基本配置\"><a class=\"anchor\" href=\"#3-nginx基本配置\">#</a> 3. Nginx 基本配置</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># egrep -v '^#|^$' /etc/nginx/nginx.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>user  nginx<span class=\"token punctuation\">;</span>              <span class=\"token comment\">#nginx 的运行身份为 nginx 用户     </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>worker_processes  auto<span class=\"token punctuation\">;</span>   <span class=\"token comment\">#启动的 worker 进程数量</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>error_log  /var/log/nginx/error.log notice<span class=\"token punctuation\">;</span>      <span class=\"token comment\">#错误日志的路径</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pid        /var/run/nginx.pid<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#存储进程的 pid</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>events <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    worker_connections  <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">#一个 worker 最大连接数，worker_connections * worker_processes = 最大链接数</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    include       /etc/nginx/mime.types<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#支持的类型</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    default_type  application/octet-stream<span class=\"token punctuation\">;</span>  <span class=\"token comment\"># 默认类型（下载的方式）</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    log_format  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">#定义日志的格式</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    access_log  /var/log/nginx/access.log  main<span class=\"token punctuation\">;</span>   <span class=\"token comment\">#访问日志</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    sendfile        on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">#tcp_nopush     on;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    keepalive_timeout  <span class=\"token number\">65</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">#长连接超时时间</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">#gzip  on;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    include /etc/nginx/conf.d/*.conf<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#包含的子文件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"4-nginx虚拟主机\"><a class=\"anchor\" href=\"#4-nginx虚拟主机\">#</a> 4. Nginx 虚拟主机</h4>\n<p>Nginx 配置虚拟主机有如下三种方式</p>\n<ul>\n<li>1、基于主机多 IP 方式</li>\n<li>2、基于端口的配置方式</li>\n<li>3、基于多个 hosts 名称方式 (多域名方式</li>\n</ul>\n<h5 id=\"41-基于多ip虚拟主机实践\"><a class=\"anchor\" href=\"#41-基于多ip虚拟主机实践\">#</a> 4.1 基于多 IP 虚拟主机实践</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/address.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">10.0</span>.0.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlisten <span class=\"token number\">172.16</span>.1.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"42-基于多端口虚拟主机实践\"><a class=\"anchor\" href=\"#42-基于多端口虚拟主机实践\">#</a> 4.2 基于多端口虚拟主机实践</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/port1.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/port2.conf</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlisten <span class=\"token number\">81</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"43-基于多域名虚拟主机实践\"><a class=\"anchor\" href=\"#43-基于多域名虚拟主机实践\">#</a> 4.3 基于多域名虚拟主机实践</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"server1\" > /code/server1/index.html</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"server2\" > /code/server2/index.html</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/server1.conf</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tserver_name server1.oldxu.net<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\troot /code/server1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/server2.conf</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tserver_name server2.oldxu.net<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\troot /code/server2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"5-nginx常用模块\"><a class=\"anchor\" href=\"#5-nginx常用模块\">#</a> 5. Nginx 常用模块</h4>\n<h5 id=\"51-nginx目录索引\"><a class=\"anchor\" href=\"#51-nginx目录索引\">#</a> 5.1 Nginx 目录索引</h5>\n<p>当 ngx_http_index_module 模块找不到索引文件时，通常会将请求传递给 ngx_http_autoindex_module 模块。</p>\n<p>ngx_http_autoindex_module 模块处理以斜杠字符 ('/') 结尾的请求，并生成目录列表。</p>\n<h6 id=\"511-配置语法\"><a class=\"anchor\" href=\"#511-配置语法\">#</a> 5.1.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#启用或禁用目录列表输出，on 开启，off 关闭。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: autoindex on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: autoindex off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#指定是否应在目录列表中输出确切的文件大小，on 显示字</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>节，off显示大概单位。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Syntax: autoindex_exact_size on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Default: autoindex_exact_size on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#指定目录列表中的时间是应以本地时区还是 UTC 输出。on</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>本地时区，off UTC时间。</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Syntax: autoindex_localtime on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Default: autoindex_localtime off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><h6 id=\"512-配置示例\"><a class=\"anchor\" href=\"#512-配置示例\">#</a> 5.1.2 配置示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat mirrors.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /mirrors/repo -p</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"欢迎访问 mirrors 镜像站点！！！\" > /mirrors/index.html</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 repo<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">31367480</span> Aug <span class=\"token number\">23</span> <span class=\"token number\">21</span>:05 EVCapture_v4.2.3.exe</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root  <span class=\"token number\">1885872</span> Aug <span class=\"token number\">23</span> <span class=\"token number\">21</span>:05 Everything-1.4.1.1023.x64-Setup.exe</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">31456728</span> Aug <span class=\"token number\">23</span> <span class=\"token number\">21</span>:09 PixPin_1.7.5.0.exe</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/FGyGR7C.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"52-nginx访问控制\"><a class=\"anchor\" href=\"#52-nginx访问控制\">#</a> 5.2 Nginx 访问控制</h5>\n<p>ngx_http_access_module 模块允许限制对某些客户端地址的访问。</p>\n<h6 id=\"521-配置语法\"><a class=\"anchor\" href=\"#521-配置语法\">#</a> 5.2.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#允许配置语法</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: allow address <span class=\"token operator\">|</span> CIDR <span class=\"token operator\">|</span> unix: <span class=\"token operator\">|</span> all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location,limit_except</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#拒绝配置语法</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Syntax: deny address <span class=\"token operator\">|</span> CIDR <span class=\"token operator\">|</span> unix: <span class=\"token operator\">|</span> all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Context: http, server, location,limit_except</pre></td></tr></table></figure><h6 id=\"522-配置示例\"><a class=\"anchor\" href=\"#522-配置示例\">#</a> 5.2.2 配置示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t    <span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t    allow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t    deny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:mirrors.hmallleasing.com http://192.168.40.7/repo/</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token number\">403</span> Forbidden<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">&lt;</span>center<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token number\">403</span> Forbidden<span class=\"token operator\">&lt;</span>/h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token operator\">&lt;</span>/center<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token operator\">&lt;</span>hr<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>center<span class=\"token operator\">></span>nginx/1.26.<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/center<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></pre></td></tr></table></figure><p>注意 **:deny<strong> 和</strong> allow** 的顺序是有影响的</p>\n<ul>\n<li>默认情况下，从第一条规则进行匹配</li>\n<li>如果匹配成功，则不继续匹配下面的内容。</li>\n<li>如果匹配不成功，则继续往下寻找能匹配成功的内容。</li>\n</ul>\n<h5 id=\"53-nginx基础认证\"><a class=\"anchor\" href=\"#53-nginx基础认证\">#</a> 5.3 Nginx 基础认证</h5>\n<p>ngx_http_auth_basic_module 模块允许使用 HTTP 基本身份验证，验证用户名和密码来限制对资源的访问。</p>\n<h6 id=\"531配置语法\"><a class=\"anchor\" href=\"#531配置语法\">#</a> 5.3.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#使用 HTTP 基本身份验证协议启用用户名和密码验证。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: auth_basic string<span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: auth_basic off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location,limit_except</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#指定保存用户名和密码的文件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Syntax: auth_basic_user_file <span class=\"token function\">file</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Default: -</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Context: http, server, location,limit_except</pre></td></tr></table></figure><p>指定保存用户名和密码的文件，格式如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#可以使用 htpasswd 程序或 \"openssl passwd\" 命令生成对应的密码；</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name1：passwd1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>name2：passwd2</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#使用 htpaaswd 创建新的密码文件，-c 创建新文件 -b 允许命令行输入密码</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@oldxu ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install httpd-tools</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@oldxu ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># htpasswd -b -c /etc/nginx/auth_conf xuyong 123456</span></pre></td></tr></table></figure><h6 id=\"532-配置示例\"><a class=\"anchor\" href=\"#532-配置示例\">#</a> 5.3.2 配置示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat mirrors.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t    <span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t    allow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t    deny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t    <span class=\"token comment\">#basci 认证，局部生效 </span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t    auth_basic <span class=\"token string\">\"welcome to auth_basic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t    auth_basic_user_file auth_conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"54-nginx限流限速\"><a class=\"anchor\" href=\"#54-nginx限流限速\">#</a> 5.4 Nginx 限流限速</h5>\n<h6 id=\"541-为什么要限速\"><a class=\"anchor\" href=\"#541-为什么要限速\">#</a> 5.4.1 为什么要限速</h6>\n<p>限制某个用户在一定时间内能够产生的 Http 请求。或者说限制某个用户的下载速度。</p>\n<h6 id=\"542-限速应用场景\"><a class=\"anchor\" href=\"#542-限速应用场景\">#</a> 5.4.2 限速应用场景</h6>\n<p>下载限速：限制用户下载资源的速度；</p>\n<p>ngx_http_core_module</p>\n<p>请求限制：限制用户单位时间内所产生的 Http 请求数；</p>\n<p>ngx_http_limit_req_module</p>\n<p>连接限制：限制同一时间的连接数，及并发数限制；</p>\n<p>ngx_http_limit_conn_module</p>\n<h6 id=\"543-限制请求并发数\"><a class=\"anchor\" href=\"#543-限制请求并发数\">#</a> 5.4.3 限制请求并发数</h6>\n<p>1. 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: limit_req_zone key <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>name:size <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>rate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: http</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Syntax: limit_req zone number <span class=\"token punctuation\">[</span>burst<span class=\"token operator\">=</span>number<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>nodelay<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><p>2. 基于来源<em> IP</em> 对下载速率限制，限制每秒处理<em> 1</em> 次请求，但可以突发超过<em> 5</em> 个请求放入缓存区</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># http 标签段定义请求限制，rate 限制速率，限制一秒钟最多一个 IP 请求 $remote_addr; $binary_remote_addr</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlimit_req_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one:10m <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>1r/s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tserver_name mirror.oldxu.net<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token comment\"># 请求超过 1r/s, 剩下的将被延迟处理，请求数超过 burst 定义的数量，则返回 503</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tlimit_req <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one <span class=\"token assign-left variable\">burst</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> nodelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>limit_req_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one:10m <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>1r/s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#第一个参数：$binary_remote_addr 表示通过这个标识来做限制，限制同一客户端 ip 地址。</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#第二个参数：zone=req_one:10m 表示生成一个大小为 10M，名为 req_one 的内存区域，用来存储访问的频次信息。</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#第三个参数：rate=1r/s 表示允许相同标识的客户端的访问频次，这里限制的是每秒 1 次。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>limit_req <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one <span class=\"token assign-left variable\">burst</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> nodelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#第一个参数：zone=req_one 设置使用哪个配置区域来做限制，与上面 limit_req_zone 里的 name 对应。</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#第二个参数：burst=3，设置一个大小为 3 的缓冲区，当有大量请求过来时，超过了访问频次限制的请求可以先放到这个缓冲区内。</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#第三个参数：nodelay，超过访问频次并且缓冲区也满了的时候，则会返回 503，如果没有设置，则所有请求会等待排队。</span></pre></td></tr></table></figure><p>3. 配置示例</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#http 标签段定义请求限制，rate 限制速率，限制一秒钟最多一个 IP 请求，10m 可以存储 10*1024*1024/4=2,621,440 个 IP</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>limit_req_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one:10m <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>1r/s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\"># 请求超过 1r/s, 剩下的将被延迟处理，请求数超过 burst 定义的数量 3，则返回 503</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlimit_req <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one <span class=\"token assign-left variable\">burst</span><span class=\"token operator\">=</span><span class=\"token number\">5</span> nodelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlimit_req_status <span class=\"token number\">500</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># 请求限制状态码，默认返回 503</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t    <span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\tallow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\tdeny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token comment\">#basci 认证，局部生效 </span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tauth_basic <span class=\"token string\">\"welcome to auth_basic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\tauth_basic_user_file auth_conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"545-限制并发连接数\"><a class=\"anchor\" href=\"#545-限制并发连接数\">#</a> 5.4.5 限制并发连接数</h6>\n<p>1. 指令</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: limit_conn_zone key <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>name:size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: http</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Syntax: limit_conn zone number<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><p><em>2.<em> 设置共享内存区域和给定键值的最大允许个连接数。超过此限制时，服务器将返回</em> 503</em> 错误以回复请求</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#http 标签段定义连接限制</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>limit_conn_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>conn_od:10m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">#限制最大并发数为 20</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlimit_conn conn_od <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">#出现 503 错误，跳转到充值中心</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\terror_page <span class=\"token number\">503</span> @errpage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tlocation @errpage <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://vip.qq.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tallow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tdeny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t<span class=\"token comment\">#basci 认证，局部生效 </span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\tauth_basic <span class=\"token string\">\"welcome to auth_basic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\tauth_basic_user_file auth_conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># dd if=/dev/zero of=/mirrors/bigdata bs=500M count=1</span></pre></td></tr></table></figure><h6 id=\"546-限制下载速度\"><a class=\"anchor\" href=\"#546-限制下载速度\">#</a> 5.4.6 限制下载速度</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">#达到 100m 开始限速</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlimit_rate_after 100m<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">#限速 100K</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlimit_rate 100k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">#出现 503 错误，跳转到充值中心</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\terror_page <span class=\"token number\">503</span> @errpage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlocation @errpage <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://vip.qq.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\tallow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tdeny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token comment\">#basci 认证，局部生效 </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tauth_basic <span class=\"token string\">\"welcome to auth_basic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tauth_basic_user_file auth_conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"547-综合场景实践\"><a class=\"anchor\" href=\"#547-综合场景实践\">#</a> 5.4.7 综合场景实践</h6>\n<ul>\n<li>1、限制 web 服务器请求数处理为 1 秒一个，触发值为 5、限制用户仅可同时下载一个文件；</li>\n<li>2、当下载超过 100M 则限制下载速度为 500k;</li>\n<li>3、如果同时下载超过 2 个视频，则返回提示 &quot;请联系 oldxu 进行会员充值&quot; | 跳转到其他页面；</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>limit_req_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one:10m <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>1r/s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>limit_conn_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>conn_od:10m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\"># 请求超过 1r/s, 剩下的将被延迟处理，请求数超过 burst 定义的数量 5，则返回 503</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlimit_req <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one <span class=\"token assign-left variable\">burst</span><span class=\"token operator\">=</span><span class=\"token number\">5</span> nodelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">#限制最大并发数为 2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlimit_conn conn_od <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">#达到 100m 开始限速</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tlimit_rate_after 100m<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">#限速 100K</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlimit_rate 500k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">#出现 503 错误，跳转到充值中心</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\terror_page <span class=\"token number\">503</span> @errpage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tlocation @errpage <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://vip.qq.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"55-nginx状态监控\"><a class=\"anchor\" href=\"#55-nginx状态监控\">#</a> 5.5 Nginx 状态监控</h5>\n<p>ngx_http_stub_status_module 模块提供对基本状态信息的访问。</p>\n<p>默认情况下不集成该模块，需要使用 --with-http_stub_status_module 集成。</p>\n<h6 id=\"551-配置语法\"><a class=\"anchor\" href=\"#551-配置语法\">#</a> 5.5.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: stub_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: server, location</pre></td></tr></table></figure><h6 id=\"552-配置示例\"><a class=\"anchor\" href=\"#552-配置示例\">#</a> 5.5.2 配置示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlocation /nginx_status <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tstub_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        allow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        deny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"553-页面状态\"><a class=\"anchor\" href=\"#553-页面状态\">#</a> 5.5.3 页面状态</h6>\n<p>此配置创建一个简单的网页，其基本状态数据可能如下所示</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:mirrors.hmallleasing.com http://192.168.40.7/nginx_status</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Active connections: <span class=\"token number\">1</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server accepts handled requests</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token number\">20</span> <span class=\"token number\">20</span> <span class=\"token number\">42</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Reading: <span class=\"token number\">0</span> Writing: <span class=\"token number\">1</span> Waiting: <span class=\"token number\">0</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># Active connections：当前活跃连接数，包括 Waiting 等待连接数。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># accepts： 已接收的总 TCP 连接数量。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># handled： 已处理的 TCP 连接数量。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># requests： 当前总 http 请求数量。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># Reading： 当前读取的请求头数量。</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># Writing： 当前响应的请求头数量。</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># Waiting： 当前等待请求的空闲客户端连接数。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -s -HHost:mirrors.hmallleasing.com http://192.168.40.7/nginx_status|awk -F ':' 'NR==1 &#123;print $NF&#125;'</span></pre></td></tr></table></figure><h5 id=\"56-nginx资源压缩\"><a class=\"anchor\" href=\"#56-nginx资源压缩\">#</a> 5.6 Nginx 资源压缩</h5>\n<p>Nginx 将发送至客户端之前的数据进行压缩，然后传输，这能够有效地节约带宽，并提高响应速度；</p>\n<h6 id=\"561-配置语法\"><a class=\"anchor\" href=\"#561-配置语法\">#</a> 5.6.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1、启用或关闭 gzip 压缩</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: <span class=\"token function\">gzip</span> on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: <span class=\"token function\">gzip</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location, <span class=\"token keyword\">if</span> <span class=\"token keyword\">in</span> location</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 2、gzip 支持的压缩类型</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Syntax: gzip_types mime-type <span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Default: gzip_types text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 3、gzip 压缩比率，压缩率越高，CPU 消耗越大 9</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Syntax: gzip_comp_level level<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Default: gzip_comp_level <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 4、gzip 压缩的最小文件，小于设置的值文件将不会被压</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>缩（由<span class=\"token string\">\"Content-Length\"</span>响应头字段确定）</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Syntax: gzip_min_length length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Default: gzip_min_length <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 5、gzip 压缩支持的协议版本</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Syntax: gzip_http_version <span class=\"token number\">1.0</span> <span class=\"token operator\">|</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Default: gzip_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 6、启用压缩，是否在响应报文首部插入 \"Vary:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Accept-Encoding\"</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Syntax: gzip_vary on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Default: gzip_vary off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><h6 id=\"562-图片压缩案例\"><a class=\"anchor\" href=\"#562-图片压缩案例\">#</a> 5.6.2 图片压缩案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/images</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat static.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name static.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code/images<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation ~* .*<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>jpg<span class=\"token operator\">|</span>gif<span class=\"token operator\">|</span>png<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token function\">gzip</span> on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\tgzip_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tgzip_comp_level <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\tgzip_min_length 10k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\tgzip_types image/jpeg image/gif image/png<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tgzip_vary on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"563-文件压缩案例\"><a class=\"anchor\" href=\"#563-文件压缩案例\">#</a> 5.6.3 文件压缩案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/doc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat static.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name static.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code/doc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation ~ .*<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>txt<span class=\"token operator\">|</span>pdf<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token function\">gzip</span> on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\tgzip_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tgzip_comp_level <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\tgzip_min_length 10k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\tgzip_types text/plain application/pdf<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tgzip_vary on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"57-nginx-location\"><a class=\"anchor\" href=\"#57-nginx-location\">#</a> 5.7 Nginx Location</h5>\n<p>Location 用来控制访问网站的 uri 路径。</p>\n<h6 id=\"571-location语法示例\"><a class=\"anchor\" href=\"#571-location语法示例\">#</a> 5.7.1 Location 语法示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>location <span class=\"token punctuation\">[</span> <span class=\"token operator\">=</span> <span class=\"token operator\">|</span> ~ <span class=\"token operator\">|</span> ~* <span class=\"token operator\">|</span> ^~ <span class=\"token punctuation\">]</span> uri <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>location @name <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/api/xxx/dadas/dsadsa</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/apiv1/dsa/dsaxx/sadsa/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 匹配符 匹配规则 优先级</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># = 精确匹配 1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># ^~ 以某个字符串开头 2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># ~ 区分大小写的正则匹配 3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># ~* 不区分大小写的正则匹配 4</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># / 通用匹配，任何请求都会匹配到 5</span></pre></td></tr></table></figure><h6 id=\"572-location优先级示例\"><a class=\"anchor\" href=\"#572-location优先级示例\">#</a> 5.7.2 Location 优先级示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat location.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name location.oldxu.net<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlocation <span class=\"token operator\">=</span> / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location = /'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location /'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tlocation /documents/ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location /documents/'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tlocation ^~ /images/ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location ^~ /images/'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tlocation ~* <span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>gif<span class=\"token operator\">|</span>jpg<span class=\"token operator\">|</span>jpeg<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location ~* \\.(gif|jpg|jpeg)'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#测试结果如下 (建议是 curl 测试)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">#1. 请求 http://location.hmallleasing.com/ 会被 location =/ 匹配</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">#2. 请求 http://location.hmallleasing.com/index.html 会被 location / 匹配</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">#3. 请求 http://location.hmallleasing.com/documents/1.html 会被 location /documents/ 匹配</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">#4. 请求 http://location.hmallleasing.com/images/1.gif 会被 location ^~ /images/ 匹配</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">#5. 请求 http://location.hmallleasing.com/documents/1.jpg 会被 location ~* \\.(gif|jpg|jpeg)$ 匹配</span></pre></td></tr></table></figure><h6 id=\"573-location应用场景\"><a class=\"anchor\" href=\"#573-location应用场景\">#</a> 5.7.3 Location 应用场景</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat location2.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name location2.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        charset utf-8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\"># 通用匹配，任何请求都会匹配到</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\troot html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\"># 精准匹配，必须请求的 uri 是 /nginx_status</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlocation <span class=\"token operator\">=</span> /nginx_status <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tstub_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\"># 严格区分大小写，匹配以.php 结尾的都走这个 location info.php</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'php访问成功'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\"># 严格区分大小写，匹配以.jsp 结尾的都走这个 location</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.jsp$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'jsp访问成功'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\"># 不区分大小写匹配，只要用户访问.jpg,gif,png,js,css 都走这条 location</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tlocation ~* <span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>jpg<span class=\"token operator\">|</span>gif<span class=\"token operator\">|</span>png<span class=\"token operator\">|</span>js<span class=\"token operator\">|</span>css<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token comment\"># return 403;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\texpires 3d<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\"># 不区分大小写匹配</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tlocation ~* <span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>sql<span class=\"token operator\">|</span>bak<span class=\"token operator\">|</span>tgz<span class=\"token operator\">|</span>tar.gz<span class=\"token operator\">|</span>.git<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tdeny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'禁止访问！！！'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"574-location-重定向\"><a class=\"anchor\" href=\"#574-location-重定向\">#</a> 5.7.4 Location @重定向</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat location3.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name location3.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">#error_page 400 403 404 error.html;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">#如果出现异常，则重新定向到 @error_404 这个 location 上</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\terror_page <span class=\"token number\">404</span> @error_404<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tlocation @error_404 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">#\treturn 200 ' 你可能是不小心走丢了。';</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> http://<span class=\"token variable\">$server_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"58-nginx日志模块\"><a class=\"anchor\" href=\"#58-nginx日志模块\">#</a> 5.8 Nginx 日志模块</h5>\n<p>Nginx 的日志记录非常灵活，可以通过 log_format 来定义格式。</p>\n<h6 id=\"581-nginx日志格式\"><a class=\"anchor\" href=\"#581-nginx日志格式\">#</a> 5.8.1 Nginx 日志格式</h6>\n<p>1.log_format 定义日志格式语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置语法：包括: error.log access.log</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: log_format name <span class=\"token punctuation\">[</span>escape<span class=\"token operator\">=</span>default<span class=\"token operator\">|</span>json<span class=\"token punctuation\">]</span> string <span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: log_format combined <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http</pre></td></tr></table></figure><p>2. 默认 Nginx 定义语法格式如下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>log_format main <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t\t\t\t<span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t\t\t<span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>log_format <span class=\"token builtin class-name\">test</span> <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span><span class=\"token variable\">$status</span><span class=\"token string\">';</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>log_format test '</span><span class=\"token variable\">$remote_addr</span> - <span class=\"token variable\">$remote_user</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$time_local</span><span class=\"token punctuation\">]</span> <span class=\"token string\">\"<span class=\"token variable\">$request</span>\"</span> <span class=\"token string\">'</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t\t'</span><span class=\"token variable\">$status</span> '<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#access_log</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/var/log/nginx/access.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#access_log</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>/var/log/nginx/access_test.log <span class=\"token builtin class-name\">test</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><em>3.Nginx</em> 日志格式中常用的变量</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$remote_addr</span> <span class=\"token comment\"># 记录客户端 IP 地址</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token variable\">$remote_user</span> <span class=\"token comment\"># 记录客户端用户名</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token variable\">$time_local</span> <span class=\"token comment\"># 记录通用的本地时间</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token variable\">$time_iso8601</span> <span class=\"token comment\"># 记录 ISO8601 标准格式下的本地时间</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token variable\">$request</span> <span class=\"token comment\"># 记录请求的方法以及请求的 http 协议</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token variable\">$status</span> <span class=\"token comment\"># 记录请求状态码 (用于定位错误信息)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token variable\">$body_bytes_sent</span> <span class=\"token comment\"># 发送给客户端的资源字节数，不包括响应头的大小</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token variable\">$bytes_sent</span> <span class=\"token comment\"># 发送给客户端的总字节数</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token variable\">$msec</span> <span class=\"token comment\"># 日志写入时间。单位为秒，精度是毫秒。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token variable\">$http_referer</span> <span class=\"token comment\"># 记录从哪个页面链接访问过来的</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token variable\">$http_user_agent</span> <span class=\"token comment\"># 记录客户端浏览器相关信息</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token variable\">$http_x_forwarded_for</span> <span class=\"token comment\">#记录客户端 IP 地址</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token variable\">$request_length</span> <span class=\"token comment\"># 请求的长度（包括请求行，请求头和请求正文）。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token variable\">$request_time</span> <span class=\"token comment\"># 请求花费的时间，单位为秒，精度毫秒</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 注：如果 Nginx 位于负载均衡器，nginx 反向代理之后，web 服务器无法直接获取到客户端真实的 IP 地址。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># $remote_addr 获取的是反向代理的 IP 地址。反向代理服务器在转发请求的 http 头信息中。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 增加 X-Forwarded-For 信息，用来记录客户端 IP 地址和客户端请求的服务器地址。</span></pre></td></tr></table></figure><h6 id=\"582-nginx访问日志\"><a class=\"anchor\" href=\"#582-nginx访问日志\">#</a> 5.8.2 Nginx 访问日志</h6>\n<p>1.web 服务器的访问日志是非常重要的，我们可以通过访问日志来分析用户的访问情况，也可以通过访问日志发现一些异常访问。access_log 日志配置语法。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: access_log path <span class=\"token punctuation\">[</span>format <span class=\"token punctuation\">[</span>buffer<span class=\"token operator\">=</span>size<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>gzip<span class=\"token punctuation\">[</span><span class=\"token operator\">=</span>level<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>flush<span class=\"token operator\">=</span>time<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>if<span class=\"token operator\">=</span>condition<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>access_log off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: access_log logs/access.log combined<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location, <span class=\"token keyword\">if</span> <span class=\"token keyword\">in</span> location, limit_except</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\taccess_log /var/log/nginx/access.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            access_log /var/log/nginx/test.hmallleasing.com.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   \t\t\t\taccess_log /var/log/nginx/test.hmallleasing.com.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            location /admin <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2.Nginx 访问日志配置示例</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\tserver_name log.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token comment\"># 将当前的 server 网站的访问日志记录至对应的目录，使用 main 格式</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\taccess_log /var/log/nginx/log.hmallleasing.com.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"583-nginx错误日志\"><a class=\"anchor\" href=\"#583-nginx错误日志\">#</a> 5.8.3 Nginx 错误日志</h6>\n<p>Nginx 常见的错误日志级别有 debug | info | notice| warn | error | crit | alert | emerg 级别越高记录的信息越少，如果不定义，默认级别为 warn，它可以配置在 main、http、server、location 段里</p>\n<p>Nginx 错误日志示例：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>error_log /var/log/nginx/error.log warn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 关闭错误日志</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>error_log /dev/null<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h6 id=\"584-nginx日志过滤\"><a class=\"anchor\" href=\"#584-nginx日志过滤\">#</a> 5.8.4 Nginx 日志过滤</h6>\n<p>一个网站会包含很多元素，尤其是有大量的 images、js、css 等静态资源。这样的请求可以不用记录日志。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#请求 favicon.ico 时，不记录日志</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>location /favicon.ico <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\taccess_log off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#或，当有人访问 gif、png 等资源时，将日志丢入空</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>location ~* .*<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>gif<span class=\"token operator\">|</span>jpg<span class=\"token operator\">|</span>png<span class=\"token operator\">|</span>css<span class=\"token operator\">|</span>js<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\taccess_log /dev/null<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1697351306.html",
            "url": "http://ixuyong.cn/posts/1697351306.html",
            "title": "Nginx基础Http协议",
            "date_published": "2025-08-22T13:44:55.000Z",
            "content_html": "<h3 id=\"nginx基础http协议\"><a class=\"anchor\" href=\"#nginx基础http协议\">#</a> Nginx 基础 Http 协议</h3>\n<h4 id=\"1http协议介绍\"><a class=\"anchor\" href=\"#1http协议介绍\">#</a> 1.Http 协议介绍</h4>\n<h5 id=\"11-什么是url\"><a class=\"anchor\" href=\"#11-什么是url\">#</a> <strong>1.1</strong> 什么是 URL</h5>\n<p>通常我们在访问一个网站页面时，请求到的内容通称为 &quot;资源&quot;。而 “资源 “这一概念非常宽泛，它可以是一份文档，一张图片，或所有其他你能够想到的格式。每个资源都由一个 URI 来进行标识；比如: <a href=\"http://fj.ixuyong.cn/public/tt.jpeg%E8%BF%99%E6%A0%B7%E7%9A%84%E8%B5%84%E6%BA%90%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E5%B0%86%E8%AF%A5%E5%85%B6%E7%A7%B0%E4%B8%BAURL%E5%9C%B0%E5%9D%80%EF%BC%9B%E7%99%BE%E5%BA%A6%E7%99%BE%E7%A7%91%E8%A7%A3%E9%87%8A%EF%BC%9AURL%E7%AE%80%E7%A7%B0%E7%BB%9F%E4%B8%80%E8%B5%84%E6%BA%90%E5%AE%9A%E4%BD%8D%E7%AC%A6%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%94%AF%E4%B8%80%E5%9C%B0%E6%A0%87%E8%AF%86%E4%B8%87%E7%BB%B4%E7%BD%91%E4%B8%AD%E7%9A%84%E6%9F%90%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E3%80%82URL%E7%94%B1%E5%8D%8F%E8%AE%AE%E3%80%81%E4%B8%BB%E6%9C%BA%E5%90%8D%E7%A7%B0%E3%80%81%E7%AB%AF%E5%8F%A3%E4%BB%A5%E5%8F%8A%E6%96%87%E4%BB%B6%E5%90%8D%E5%87%A0%E9%83%A8%E5%88%86%E6%9E%84%E6%88%90%E3%80%82\">http://fj.ixuyong.cn/public/tt.jpeg 这样的资源，我们会将该其称为 URL 地址；百度百科解释：URL 简称统一资源定位符，用来唯一地标识万维网中的某一个资源。URL 由协议、主机名称、端口以及文件名几部分构成。</a></p>\n<h5 id=\"12-什么是html\"><a class=\"anchor\" href=\"#12-什么是html\">#</a> <strong>1.2</strong> 什么是 HTML</h5>\n<p>Html 简称 Web Page，一个完整的 Html 页面可能会包含很多个 URL 的资源。(反之：我们也可以理解一个 HTML 文件是由多个不同的 URL 资源拼接而成的。)</p>\n<h5 id=\"13-什么是http\"><a class=\"anchor\" href=\"#13-什么是http\">#</a> <strong>1.3</strong> 什么是 HTTP</h5>\n<p>HTTP (Hyper Text Transfer Protocol) 中文名为超文本传输协议。是一种能够获取如 HTML 这样网络资源的通讯协议。它是在 Web 上进行数据交换的基础。HTTP 的概述参考 URL 简单理解：HTTP 协议就是将用户请求的 HTML 页面从一台 Web 服务器传输到客户端浏览器的一种协议。</p>\n<h5 id=\"14-url-html-http之间关系\"><a class=\"anchor\" href=\"#14-url-html-http之间关系\">#</a> 1.4 URL、HTML、HTTP 之间关系</h5>\n<p>一个完整的 HTML 页面是由多个不同的 Url 资源组成的；而 HTTP 协议主要是用来传输这种 HTML 页面的；</p>\n<h4 id=\"2http工作原理\"><a class=\"anchor\" href=\"#2http工作原理\">#</a> 2.Http 工作原理</h4>\n<h5 id=\"21-图解http工作原理\"><a class=\"anchor\" href=\"#21-图解http工作原理\">#</a> 2.1 图解 HTTP 工作原理</h5>\n<p>我们详细的了解下 HTTP 的工作原理，我们到底是如何获取到服务器上的页面。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/5p0uvcC.png\" alt=\"3.png\" /></p>\n<h5 id=\"22-http工作原理总结\"><a class=\"anchor\" href=\"#22-http工作原理总结\">#</a> 2.2 HTTP 工作原理总结</h5>\n<p>整个用户访问网站过程就是 DNS-TCP-HTTP</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Lwnt1Bw.png\" alt=\"2.png\" /></p>\n<h4 id=\"3http请求request\"><a class=\"anchor\" href=\"#3http请求request\">#</a> 3.Http 请求 Request</h4>\n<p>HTTP 请求的一个例子：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/InbGStI.png\" alt=\"4.png\" /></p>\n<h5 id=\"31-请求method\"><a class=\"anchor\" href=\"#31-请求method\">#</a> 3.1 请求 Method</h5>\n<p>客户端向服务端发送请求时，会根据不同的资源发送不同的请求方法 Method：</p>\n<ul>\n<li>GET：用于获取 URI 对应的资源；（比如看朋友圈)</li>\n<li>POST：用于提交请求，可以更新或者创建资源，是非幂等的；（发布朋友圈）</li>\n<li>PUT：用于向指定的 URI 传送更新资源，是幂等的；（更新朋友圈）</li>\n<li>DELETE：用于向指定的 URI 删除资源；（比如删朋友圈）</li>\n<li>HEAD：用于检查 (仅获取 Header 部分的内容)；</li>\n</ul>\n<p>一般创建对象时用 POST，更新对象时用 PUT；</p>\n<ul>\n<li>PUT 是幂等的，POST 是非幂等的；</li>\n<li>幂等：对于相同的输入，每次得到的结果都是相等的；</li>\n</ul>\n<h5 id=\"32-请求header\"><a class=\"anchor\" href=\"#32-请求header\">#</a> 3.2 请求 Header</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>:authority: www.xuliangwei.com</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>:method: GET</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>:path: /</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>:scheme: https</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Accept: text/html,  <span class=\"token comment\"># 请求的类型</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Accept-Encoding: gzip, deflate  <span class=\"token comment\"># 是否进行压缩</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Accept-Language: zh-CN,zh<span class=\"token punctuation\">;</span><span class=\"token assign-left variable\">q</span><span class=\"token operator\">=</span><span class=\"token number\">0.9</span> <span class=\"token comment\"># 请求的语言</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Cache-Control: max-age<span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token comment\"># 缓存</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Connection: keep-alive   <span class=\"token comment\"># TCP 长连接</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Host: www.oldboyedu.com  <span class=\"token comment\"># 请求的域名</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>If-Modified-Since: Fri, 04 May <span class=\"token number\">201808</span>:13:44 GMT  <span class=\"token comment\"># 修改的时间</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>User-Agent: Mozilla/5.0  <span class=\"token comment\"># 请求浏览器的工具</span></pre></td></tr></table></figure><h5 id=\"33-请求connection\"><a class=\"anchor\" href=\"#33-请求connection\">#</a> <strong>3.3</strong> 请求 Connection</h5>\n<p>Http 请求中的长连接与短连接是什么：</p>\n<ul>\n<li>http1.0 协议使用的是短连接：建立一次 tcp 的连接，发起一次 http 的请求，结束，tcp 断开。</li>\n<li>http1.1 协议使用的是长连接：建立一次 tcp 的连接，发起多次 http 的请求，结束，tcp 断开。</li>\n<li>HTTP 协议版本参考下图，HTTP1.0 使用的是短连接，HTTP1.1 串行连接，与 HTTP2.0 并行连接。</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/bQERRRT.png\" alt=\"5.png\" /></p>\n<h4 id=\"4http响应response\"><a class=\"anchor\" href=\"#4http响应response\">#</a> 4.Http 响应 Response</h4>\n<p>HTTP 响应的一个例子：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/hX37K32.png\" alt=\"6.png\" /></p>\n<h5 id=\"41-响应header\"><a class=\"anchor\" href=\"#41-响应header\">#</a> 4.1 响应 Header</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HTTP/1.1 <span class=\"token number\">200</span> OK        <span class=\"token comment\"># 返回服务器的 http 协议，状态码</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Date: Fri, <span class=\"token number\">14</span> Sep <span class=\"token number\">2018</span> 09:14:28 GMT  <span class=\"token comment\"># 返回服务器的时间</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Server: Apache/2.4.6   <span class=\"token comment\"># 返回服务器使用的软件 Apache</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Connection: Keep-Alive <span class=\"token comment\"># TCP 长连接</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Keep-Alive: <span class=\"token assign-left variable\">timeout</span><span class=\"token operator\">=</span><span class=\"token number\">5</span>, <span class=\"token assign-left variable\">max</span><span class=\"token operator\">=</span><span class=\"token number\">100</span>  <span class=\"token comment\"># 长连接的超时时间</span></pre></td></tr></table></figure><h5 id=\"42-响应code\"><a class=\"anchor\" href=\"#42-响应code\">#</a> 4.2 响应 Code</h5>\n<p>http 响应状态码 Status-Code 以 3 位数字组成，用来标识该请求是否成功，比如是正常还是错误等。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">Code</th>\n<th style=\"text-align:left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">200</td>\n<td style=\"text-align:left\">表示成功客户端成功接收到了服务端返回的数据，这是最常见的状态码</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">206</td>\n<td style=\"text-align:left\">客户端发完请求后，服务端只是返回了部分数据，就会出现该状态码，例如当下载一个很大的文件时，在没有下载完成前就会出现该状态码</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">301</td>\n<td style=\"text-align:left\">永久重定向 (redirect) http--&gt;https</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">302</td>\n<td style=\"text-align:left\">临时重定向 (redirect)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">400</td>\n<td style=\"text-align:left\">客户端请求语法错误，服务端无法理解</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">401</td>\n<td style=\"text-align:left\">服务端开启了用户认证，而客户端没有提供正确的验证信息</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">403</td>\n<td style=\"text-align:left\">服务端不允许客户端访问，或者没有找到默认返回页面 (默认所有的 web 服务器返回的页面都是 index.html、也可以调整默认返回页面 app.html)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">404</td>\n<td style=\"text-align:left\">客户端请求的资源不存在 （路径写错了；服务端真的没有；）</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">413</td>\n<td style=\"text-align:left\">客户端向服务端上传一个比较大的文件，并且文件大小超过了服务端的限制 1MB；</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">500</td>\n<td style=\"text-align:left\">服务端出现了内部错误，需要进行人为排查故障 （链接数据库类服务异常，会出现 500 错误）</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">502</td>\n<td style=\"text-align:left\">服务器充当代理角色时，后端被代理的服务器不可用或者没有正常回应</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">503</td>\n<td style=\"text-align:left\">服务当前不可用，由于超载或系统维护，服务器暂时的无法处理客户端请求</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">504</td>\n<td style=\"text-align:left\">服务器充当代理角色时，后端的服务端没有按时返回数据，超时了</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"5http相关术语\"><a class=\"anchor\" href=\"#5http相关术语\">#</a> 5.Http 相关术语</h4>\n<h5 id=\"51-什么是pv\"><a class=\"anchor\" href=\"#51-什么是pv\">#</a> <strong>5.1</strong> 什么是 PV</h5>\n<p>PV 即页面浏览量：比如用户访问一个网站算 1 个 pv，刷新一次页面则累计 pv+1，如果多次打开或刷新同一页面则浏览量累计。</p>\n<h5 id=\"52-什么是uv\"><a class=\"anchor\" href=\"#52-什么是uv\">#</a> 5.2 什么是 UV</h5>\n<p>UV 即独立访客，访问网站的一台电脑客户端为一个访客。可以理解成访问某网站的电脑的数量。比如电脑、手机算 2 个 UV，无论访问多少次网站，最终 UV 数量就是 2。</p>\n<h5 id=\"53-什么是ip\"><a class=\"anchor\" href=\"#53-什么是ip\">#</a> 5.3 什么是 IP</h5>\n<p>IP 即独立公网 IP 数，是指 1 天内多少个独立的 IP 浏览了页面，比如你在家通过拨号上网访问某个网站，此时网站会记录你的公网 IP 地址。那如果你在公司和很多同事同时访问一个网站，那该网站会记录多少个公网 IP 呢？（看公司有多少个出口公网地址）</p>\n<h5 id=\"54-什么是并发\"><a class=\"anchor\" href=\"#54-什么是并发\">#</a> 5.4 什么是并发</h5>\n<p>并发：指的是同时，我们可以理解为一段时间内 (比如 10 秒)，网站支持同时访问的人数，假设 10s 并发值如果为 500 时，一天能达到多少 PV？ 500 * 6 * 60 * 24 =4320000</p>\n",
            "tags": [
                "Nginx"
            ]
        }
    ]
}