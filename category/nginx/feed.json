{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"nginx\" category",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/2170503498.html",
            "url": "http://ixuyong.cn/posts/2170503498.html",
            "title": "Nginx高可用-Keepalived（十三）",
            "date_published": "2025-09-07T12:57:55.000Z",
            "content_html": "<h3 id=\"nginx高可用-keepalived\"><a class=\"anchor\" href=\"#nginx高可用-keepalived\">#</a> Nginx 高可用 - Keepalived</h3>\n<h4 id=\"1高可用基本概述\"><a class=\"anchor\" href=\"#1高可用基本概述\">#</a> **1.** 高可用基本概述</h4>\n<h5 id=\"11-什么是高可用\"><a class=\"anchor\" href=\"#11-什么是高可用\">#</a> <strong>1.1</strong> <strong>什么是高可用</strong></h5>\n<ul>\n<li>\n<p>简单理解：两台机器启动着相同的业务系统，当有一台机器宕机，另外一台服务器能快速的接管，对于访问的用户是无感知的；</p>\n</li>\n<li>\n<p>专业理解：高可用是分布式系统架构设计中必要的一环，主要目的：减少系统不能提供服务的时间。假设系统一直能够提供服务，我们说系统的可用性是 100%。如果系统每运行 100 个时间单位，会有 1 个时间单位无法提供服务，我们说系统的可用性是 99%；</p>\n</li>\n<li>\n<p>高可用的目的：减少系统 down 机时间，提高 SLA 服务等级；</p>\n</li>\n</ul>\n<h5 id=\"12-高可用使用什么工具\"><a class=\"anchor\" href=\"#12-高可用使用什么工具\">#</a> <strong>1.2</strong> <strong>高可用使用什么工具</strong></h5>\n<p>通常服务高可用我们选择使用 keepalived 软件实现。</p>\n<h5 id=\"13-高可用是如何实现的\"><a class=\"anchor\" href=\"#13-高可用是如何实现的\">#</a> <strong>1.3</strong> <strong>高可用是如何实现的</strong></h5>\n<ul>\n<li>keepalived 软件是基于 VRRP 协议实现的。</li>\n<li>VRRP 虚拟路由冗余协议，主要用于解决单点故障问题。</li>\n</ul>\n<h5 id=\"14-vrrp诞生背景及原理\"><a class=\"anchor\" href=\"#14-vrrp诞生背景及原理\">#</a> <strong>1.4 VRRP</strong> 诞生背景及原理</h5>\n<p>比如公司的网络是通过网关转换进行上网的，那如果该路由器故障了，网关无法转发报文了，此时所有人都将无法上网，这么时候怎么办呢？</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/sBJPtU0.jpeg\" alt=\"1.jpg\" /></p>\n<p>通常做法是增加一个 Backup 路由，然后修改用户 PC 电脑网关指向为 Backup，但这里有几个问题</p>\n<ul>\n<li>1. 如果用户过多修改起来是不是会非常的麻烦；</li>\n<li>2. 如果用户将指向都修改为 Backup，那 Master 如果恢复了该怎么办？</li>\n</ul>\n<p>那我们直接将 Backup 网关 IP 配置为 Master 网关 IP 不就可以了吗？（其实也不行，why）</p>\n<ul>\n<li>因为 PC 在第一次通信时，是通过 ARP 广播获取到 Master 网关的 Mac 地址、IP 地址，同时 PC 还会将 Master 网关对应 IP 与 MAC 地址存储至 ARP 缓存表中；</li>\n<li>所以当 PC 与网关进行通信时，会直接读取 ARP 缓存表中的 MAC 地址与 IP 地址，进行数据包转发，也就意味着当 Master 节点故障，将 Backup 节点 IP 修改为 Master 的 IP，最终 PC 的数据包还是会转发给 Master，不会转发给 Backup 节点。（除非 PC 的 ARP 缓存表过期，在次发起 ARP 广播的时候才能正确获取 Bakcup 的 Mac 地址与对应的 IP 地址。）</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zaaQQpv.jpeg\" alt=\"2.jpg\" /></p>\n<ul>\n<li>那如何才能做到出现故障自动转移，此时 VRRP 就应运而生；</li>\n<li>VRRP 其实是通过软件或硬件的形式在 Master 和 Backup 外层增加一个虚拟 MAC 地址（简称 VMAC）、以及虚拟 IP 地址（简称 VIP）；</li>\n<li>那么在这种情况下，当 PC 请求 VIP 的时候，无论是 Master 处理还是 Backup 处理，PC 仅会在 ARP 缓存表中记录 VMAC 与 VIP 的对应关系。</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/OAokQUX.jpeg\" alt=\"3.jpg\" /></p>\n<h4 id=\"2高可用keepalived\"><a class=\"anchor\" href=\"#2高可用keepalived\">#</a> **2.** 高可用 Keepalived</h4>\n<h5 id=\"21-keeplaived基本介绍\"><a class=\"anchor\" href=\"#21-keeplaived基本介绍\">#</a> <strong>2.1 Keeplaived</strong> 基本介绍</h5>\n<p>Keepalived 基于 vrrp 实现，原生设计是为了高可用 lvs 服务。</p>\n<ul>\n<li>通过 vrrp 协议，可以完成地址漂移技术；</li>\n<li>为 vip 地址所在的节点生成 ipvs 规则（需要在配置文件中预先定义）；</li>\n<li>为 ipvs 集群的 RS 节点做健康状态检测；</li>\n</ul>\n<p>Keepalived 核心组件：</p>\n<ul>\n<li>vrrp stack：用来实现 vrrp 协议重要组件之一；</li>\n<li>Netlink 接口：设置和删除网络接口上的虚拟 IP 地址；</li>\n<li>ipvs wrapper：使用 getsock 和 setsock 来建立 IPVS 规则；</li>\n<li>checkers：监测 RS 节点的方式，支持 tcp、http、ssl 等；</li>\n<li>system call：支持启动额外系统脚本的功能；</li>\n<li>SMTP：为 当发生角色状态转换时，发送事件通知邮件；</li>\n<li>WatchDog：监控进程</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/VYw0jCq.jpeg\" alt=\"4.jpg\" /></p>\n<h5 id=\"22-keepalived核心概念\"><a class=\"anchor\" href=\"#22-keepalived核心概念\">#</a> <strong>2.2 Keepalived</strong> 核心概念</h5>\n<ul>\n<li>虚拟路由器：由一个 Master 路由器和多个 Backup 路由器组成；</li>\n<li>Master 路由器：虚拟路由器中承担报文转发任务的路由器；</li>\n<li>Backup 路由器：Master 路由器出现故障时，能够代替 Master 路由器工作的路由器；</li>\n<li>VRID：虚拟路由器的标识，由相同 VRID 的一组路由器构成一个虚拟路由器；</li>\n<li>组播：组播是有特定的成员，是一种可控的广播，组播成员需要加入 “组播组” 才能收到该组播的信息。</li>\n<li>虚拟 IP 地址：虚拟路由器的 IP 地址，一个虚拟路由器可以拥有一个或多个 IP 地址；</li>\n<li>虚拟 MAC 地址：一个虚拟路由器拥有一个虚拟 MAC 地址；</li>\n<li>优先级：VRRP 根据优先级来确定虚拟路由器中每台路由器的地位；</li>\n<li>抢占式：如果 Master 故障，Backup 自动接管，当 Master 恢复了会将 VIP 地址抢回来；</li>\n<li>非抢占式：如果 Master 故障，Backup 自动接管，当 Master 恢复则自动转为 Backup，不会抢占 VIP；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/qRaACbG.jpeg\" alt=\"5.jpg\" /></p>\n<h5 id=\"23-keeplaived应用场景\"><a class=\"anchor\" href=\"#23-keeplaived应用场景\">#</a> <strong>2.3 Keeplaived</strong> 应用场景</h5>\n<p>当需要使用 Keepalived 时，通常是因为我们的业务系统需要保证 7x24 小时不 DOWN 机，也就是说作为企业的业务系统，要保证随时随地都可以使用，不可以中断。</p>\n<ul>\n<li>比如公司内部 OA 系统，每天公司人员都需要使用，则不允许 Down 机；</li>\n<li>比如公司对外发布的业务系统（单车），每天有大量的用户使用，是不可以出现故障的；</li>\n</ul>\n<h5 id=\"24-keeplaived安装配置\"><a class=\"anchor\" href=\"#24-keeplaived安装配置\">#</a> <strong>2.4 Keeplaived</strong> 安装配置</h5>\n<h6 id=\"241-环境准备\"><a class=\"anchor\" href=\"#241-环境准备\">#</a> <strong>2.4.1</strong> <strong>环境准备</strong></h6>\n<table>\n<thead>\n<tr>\n<th>主机名称</th>\n<th><strong>eth0</strong></th>\n<th><strong>eth1</strong></th>\n<th><strong>角色</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>proxy01</td>\n<td>10.0.0.5</td>\n<td>172.16.0.5</td>\n<td>Master</td>\n</tr>\n<tr>\n<td>proxy02</td>\n<td>10.0.0.6</td>\n<td>172.16.0.6</td>\n<td>Backup</td>\n</tr>\n<tr>\n<td>VIP 地址</td>\n<td>10.0.0.100</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>在 Master 以及 Backup 节点分别安装 Keepalived</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install keepalived -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install keepalived -y</span></pre></td></tr></table></figure><h6 id=\"242-配置master\"><a class=\"anchor\" href=\"#242-配置master\">#</a> <strong>2.4.2</strong> <strong>配置</strong> Master</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb01                  <span class=\"token comment\"># 当前物理设备的标识名称</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    vrrp_mcast_group4 <span class=\"token number\">224.0</span>.0.18    <span class=\"token comment\"># 组播地址，default 224.0.0.18</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    state MASTER                    <span class=\"token comment\"># 角色状态；</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    interface eth0                  <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    priority <span class=\"token number\">200</span>                    <span class=\"token comment\"># 当前物理节点在虚拟路由中的优先级；</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">#nopreempt</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token number\">192.168</span>.40.100        <span class=\"token comment\"># VIP 地址</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable keepalived &amp;&amp; systemctl start keepalived</span></pre></td></tr></table></figure><h6 id=\"243-配置backup\"><a class=\"anchor\" href=\"#243-配置backup\">#</a> <strong>2.4.3 <strong>配置</strong> Backup</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb02                  <span class=\"token comment\"># 当前物理设备的标识名称</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    vrrp_mcast_group4 <span class=\"token number\">224.0</span>.0.18   <span class=\"token comment\"># 组播地址，default 224.0.0.18</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    state BACKUP                    <span class=\"token comment\"># 角色状态；</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    interface eth0                  <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    priority <span class=\"token number\">100</span>                    <span class=\"token comment\"># 当前物理节点在虚拟路由中的优先级；</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">#nopreempt</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token number\">192.168</span>.40.100        <span class=\"token comment\"># VIP 地址</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable keepalived &amp;&amp; systemctl start keepalived</span></pre></td></tr></table></figure><h6 id=\"244-地址漂移测试\"><a class=\"anchor\" href=\"#244-地址漂移测试\">#</a> <strong>2.4.4</strong> 地址漂移测试</h6>\n<p>检查 keepalived 的 VIP 地址能否在两个节点间漂移。</p>\n<p>1. 在 Master 上进行如下操作</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Master 存在 vip 地址</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip addr |grep 192.168.40.100</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    inet <span class=\"token number\">192.168</span>.40.100/32 scope global eth0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop keepalived</span></pre></td></tr></table></figure><p>2. 在 Backup 上进行如下操作</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 发现地址已经漂移至 Backup 端</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip addr |grep 192.168.40.100</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    inet <span class=\"token number\">192.168</span>.40.100/32 scope global eth0</pre></td></tr></table></figure><p>3. 此时启动 Master 上的 Keepalived，会发现 VIP 被强行抢占</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start keepalived</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip addr |grep 192.168.40.100</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    inet <span class=\"token number\">192.168</span>.40.100/32 scope global eth0</pre></td></tr></table></figure><p>4. 通过 windows 查看 arp 缓存表，验证地址漂移后是否会自动更新 MAC 地址。</p>\n<pre><code>接口: 192.168.40.1 --- 0xb\n  Internet 地址         物理地址              类型\n  192.168.40.5          00-0c-29-36-d2-b6     动态\n  192.168.40.6          00-0c-29-14-f6-61     动态\n  192.168.40.100        00-0c-29-36-d2-b6     动态\n</code></pre>\n<h6 id=\"245-抓包分析切换过程\"><a class=\"anchor\" href=\"#245-抓包分析切换过程\">#</a> <strong>2.4.5</strong> <strong>抓包分析切换过程</strong></h6>\n<p>通过 抓包分析 keepalived 地址切换过程。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/PNJ3jME.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"25-keepalived延迟抢占\"><a class=\"anchor\" href=\"#25-keepalived延迟抢占\">#</a> <strong>2.5 Keepalived</strong> 延迟抢占</h5>\n<p>延迟抢占指的是，当 Master 故障后，Backup 接管，当 Master 恢复后不立即抢占 VIP 地址，延迟一段时间在抢占 VIP。</p>\n<p>配置延迟抢占式步骤如下：</p>\n<p>1、两台节点的 state 都必须配置为 BACKUP；</p>\n<p>2、在节点的 vrrp_instance 中添加 preempt_delay</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. Master 配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    router_id lb01                  <span class=\"token comment\"># 当前物理设备的标识名称</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    vrrp_mcast_group4 <span class=\"token number\">224.0</span>.0.18    <span class=\"token comment\"># 组播地址，default 224.0.0.18</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    state BACKUP                    <span class=\"token comment\"># 角色状态；</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    interface eth0                  <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    priority <span class=\"token number\">200</span>                    <span class=\"token comment\"># 当前物理节点在虚拟路由中的优先级；</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    preempt_delay 10s               <span class=\"token comment\"># 延迟 10s 后抢占</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">#nopreempt</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token number\">192.168</span>.40.100        <span class=\"token comment\"># VIP 地址</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#2. Backup 配置</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    router_id lb02                  <span class=\"token comment\"># 当前物理设备的标识名称</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    vrrp_mcast_group4 <span class=\"token number\">224.0</span>.0.18   <span class=\"token comment\"># 组播地址，default 224.0.0.18</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    state BACKUP                    <span class=\"token comment\"># 角色状态；</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    interface eth0                  <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    priority <span class=\"token number\">100</span>                    <span class=\"token comment\"># 当前物理节点在虚拟路由中的优先级；</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    preempt_delay 10s               <span class=\"token comment\"># 延迟 10s 后抢占</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">#nopreempt</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token number\">192.168</span>.40.100        <span class=\"token comment\"># VIP 地址</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"26-keepalived非抢占式\"><a class=\"anchor\" href=\"#26-keepalived非抢占式\">#</a> <strong>2.6 Keepalived</strong> 非抢占式</h5>\n<p>通常 master 服务故障后 backup 会变成 master，但是当 master 服务恢复后，master 会抢占 VIP，这样就会发生两次切换；对业务繁忙的网站来说并不是太友好，此时我们可以配置 keepalived 为非抢占式，（前提两台主机的硬件配置信息一致）；</p>\n<p>配置非抢占式步骤如下</p>\n<p>1、两台节点的 state 都必须配置为 BACKUP；</p>\n<p>2、两台节点都在 vrrp_instance 中添加 nopreempt 参数；</p>\n<p>3、其中一个节点的优先级必须要高于另外一个节点的优先级；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. Master 配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    router_id lb01                  <span class=\"token comment\"># 当前物理设备的标识名称</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    vrrp_mcast_group4 <span class=\"token number\">224.0</span>.0.18    <span class=\"token comment\"># 组播地址，default 224.0.0.18</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    state BACKUP                    <span class=\"token comment\"># 角色状态；</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    interface eth0                  <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    priority <span class=\"token number\">200</span>                    <span class=\"token comment\"># 当前物理节点在虚拟路由中的优先级；</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">#preempt_delay 10s               # 延迟 10s 后抢占</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    nopreempt</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token number\">192.168</span>.40.100        <span class=\"token comment\"># VIP 地址</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#2. Backup 配置</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    router_id lb02                  <span class=\"token comment\"># 当前物理设备的标识名称</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    vrrp_mcast_group4 <span class=\"token number\">224.0</span>.0.18   <span class=\"token comment\"># 组播地址，default 224.0.0.18</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    state BACKUP                    <span class=\"token comment\"># 角色状态；</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    interface eth0                  <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    priority <span class=\"token number\">100</span>                    <span class=\"token comment\"># 当前物理节点在虚拟路由中的优先级；</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">#preempt_delay 10s               # 延迟 10s 后抢占</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    nopreempt</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token number\">192.168</span>.40.100        <span class=\"token comment\"># VIP 地址</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"27-keeplaived邮件通知\"><a class=\"anchor\" href=\"#27-keeplaived邮件通知\">#</a> <strong>2.7 Keeplaived</strong> 邮件通知</h5>\n<p>1. 配置邮箱（所有节点都需要配置）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># # yum install mailx -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat >> /etc/mail.rc &lt;&lt;EOF</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">from</span><span class=\"token operator\">=</span><span class=\"token number\">373370405</span>@qq.com</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">smtp</span><span class=\"token operator\">=</span>smtp.qq.com</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">set</span> smtp-auth-user<span class=\"token operator\">=</span><span class=\"token number\">373370405</span>@qq.com</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">set</span> smtp-auth-password<span class=\"token operator\">=</span><span class=\"token number\">123</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">set</span> smtp-auth<span class=\"token operator\">=</span>login</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">set</span> ssl-verify<span class=\"token operator\">=</span>ignore</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>EOF</pre></td></tr></table></figure><p>2. 通知脚本（所有节点都需要配置）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/notify.sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/usr/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># Author: Oldxu（E-mail: xuy@nf-leasing.com）</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">##Keepalived 故障切换邮件通知</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 定义收件人</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">Email</span><span class=\"token operator\">=</span><span class=\"token string\">'373370405@qq.com'</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 定义主机名称</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">hostname</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">Addr</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ifconfig</span> eth0<span class=\"token operator\">|</span><span class=\"token function\">awk</span> <span class=\"token string\">'NR==2 &#123;print $2&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 定义时间变量</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">Date</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +<span class=\"token string\">'%F %T'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#定义发送的消息</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token function-name function\">Message</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token assign-left variable\">subject</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$&#123;Host&#125;</span>-<span class=\"token variable\">$&#123;Addr&#125;</span> 切换为 <span class=\"token variable\">$1</span> 状态\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token assign-left variable\">submsg</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$&#123;Date&#125;</span>: <span class=\"token variable\">$&#123;Host&#125;</span>-<span class=\"token variable\">$&#123;Addr&#125;</span> 成功切换为 <span class=\"token variable\">$1</span> 状态\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;submsg&#125;</span>\"</span> <span class=\"token operator\">|</span> mail <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;subject&#125;</span>\"</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Email&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token variable\">$1</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tmaster<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tMessage master</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tbackup<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tMessage backup</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tfault<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tMessage fault</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t*<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: <span class=\"token variable\">$0</span> &#123; master | backup | fault &#125;\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token builtin class-name\">exit</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr></table></figure><p>3. 修改配置 （Master）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb01                  <span class=\"token comment\"># 当前物理设备的标识名称</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    vrrp_mcast_group4 <span class=\"token number\">224.0</span>.0.18    <span class=\"token comment\"># 组播地址，default 224.0.0.18</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    state BACKUP                    <span class=\"token comment\"># 角色状态；</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    interface eth0                  <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    priority <span class=\"token number\">200</span>                    <span class=\"token comment\"># 当前物理节点在虚拟路由中的优先级；</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">#preempt_delay 10s               # 延迟 10s 后抢占</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    nopreempt</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token number\">192.168</span>.40.100        <span class=\"token comment\"># VIP 地址</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    notify_master <span class=\"token string\">\"/etc/keepalived/notify.sh master\"</span>  <span class=\"token comment\"># 当前节点成为主节点时触发的脚本</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    notify_backup <span class=\"token string\">\"/etc/keepalived/notify.sh backup\"</span>  <span class=\"token comment\"># 当前节点转为备节点时触发的脚本</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    notify_fault <span class=\"token string\">\"/etc/keepalived/notify.sh fault\"</span>    <span class=\"token comment\"># 当前节点转为 “失败” 状态时触发的脚本</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>4. 修改配置 （Backup）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span>     </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb02                  <span class=\"token comment\"># 当前物理设备的标识名称</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    vrrp_mcast_group4 <span class=\"token number\">224.0</span>.0.18   <span class=\"token comment\"># 组播地址，default 224.0.0.18</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    state BACKUP                    <span class=\"token comment\"># 角色状态；</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    interface eth0                  <span class=\"token comment\"># 绑定当前虚拟路由使用的物理接口；</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span>            <span class=\"token comment\"># 当前虚拟路由标识，VRID；</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    priority <span class=\"token number\">100</span>                    <span class=\"token comment\"># 当前物理节点在虚拟路由中的优先级；</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">3</span>                    <span class=\"token comment\"># vrrp 通告时间间隔，默认 1s；</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">#preempt_delay 10s               # 延迟 10s 后抢占</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    nopreempt</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        auth_type PASS              <span class=\"token comment\"># 密码类型，简单密码；</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span>              <span class=\"token comment\"># 密码不超过 8 位字符；</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token number\">192.168</span>.40.100        <span class=\"token comment\"># VIP 地址</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    notify_master <span class=\"token string\">\"/etc/keepalived/notify.sh master\"</span>  <span class=\"token comment\"># 当前节点成为主节点时触发的脚本</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    notify_backup <span class=\"token string\">\"/etc/keepalived/notify.sh backup\"</span>  <span class=\"token comment\"># 当前节点转为备节点时触发的脚本</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    notify_fault <span class=\"token string\">\"/etc/keepalived/notify.sh fault\"</span>    <span class=\"token comment\"># 当前节点转为 “失败” 状态时触发的脚本</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>5. 停止所有节点的 Keepalived，先启动 Backup 节点，然后启动 Master 节点；</p>\n<pre><code># Backup\n[root@proxy02 ~]# systemctl start keepalived\n\n# 等待邮件发送成功在启动 Master\n\n# Master\n[root@proxy01 ~]# systemctl start keepalived\n</code></pre>\n<p>6. 观察邮件信息</p>\n",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/449551545.html",
            "url": "http://ixuyong.cn/posts/449551545.html",
            "title": "Nginx安全-HTTPS加密实践（十二）",
            "date_published": "2025-09-03T11:27:33.000Z",
            "content_html": "<h3 id=\"nginx安全-https加密实践\"><a class=\"anchor\" href=\"#nginx安全-https加密实践\">#</a> Nginx 安全 - HTTPS 加密实践</h3>\n<h4 id=\"1https基本概述\"><a class=\"anchor\" href=\"#1https基本概述\">#</a> <strong>1.HTTPS</strong> 基本概述</h4>\n<h5 id=\"11-为何需要https\"><a class=\"anchor\" href=\"#11-为何需要https\">#</a> <strong>1.1</strong> <strong>为何需要</strong> HTTPS</h5>\n<p>因为 HTTP 采用的是明文传输数据，那么在传输（账号密码、交易信息、等敏感数据）时不安全。容易遭到篡改，如果使用 HTTPS 协议，数据在传输过程中是加密的，能够有效避免网站传输时信息泄露</p>\n<h5 id=\"12-什么是https\"><a class=\"anchor\" href=\"#12-什么是https\">#</a> <strong>1.2</strong> <strong>什么是</strong> HTTPS</h5>\n<ul>\n<li>HTTPS 安全的超文本传输协议，我们现在大部分站点都是通过 HTTPS 来实现站点数据安全。</li>\n<li>早期网景公司设计了 SSL（Secure Socket Layer）安全套接层协议，主要对 HTTP 协议传输的数据进行加密。那如何将站点变成安全的 HTTPS 站点呢？我们需要了解 SSL（Secure Socket Layer）协议。</li>\n<li>而现在很多时候我们使用的是 TLS（TransportLayer Security）传输层安全协议来实现的加密与解密。</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Qxfvc0q.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"13-tls如何实现加密\"><a class=\"anchor\" href=\"#13-tls如何实现加密\">#</a> <strong>1.3 TLS</strong> 如何实现加密</h5>\n<p>TLS/SSL 是如何实现 HTTP 明文消息被加密的，TLS/SSL 工作在 OSI 七层模型中，应用层与传输层之间。</p>\n<ul>\n<li>\n<p>1. 提供数据安全：保证数据不会被泄露。</p>\n</li>\n<li>\n<p>2. 提供数据的完整性：保证数据在传输过程中不会被篡改。</p>\n</li>\n<li>\n<p>3. 对应用层交给传输层的数据进行加密与解密。</p>\n</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/J6UPCFy.jpeg\" alt=\"2.jpg\" /></p>\n<h4 id=\"2https实现原理\"><a class=\"anchor\" href=\"#2https实现原理\">#</a> <strong>2.HTTPS</strong> 实现原理</h4>\n<h5 id=\"21-加密模型-对称加密\"><a class=\"anchor\" href=\"#21-加密模型-对称加密\">#</a> <strong>2.1</strong> <strong>加密模型</strong> - 对称加密</h5>\n<p>对称加密：两个想通讯的人持有相同的秘钥，进行加密与解密。如下：</p>\n<ul>\n<li>bob 将原始文档通过秘钥加密生成一个密文文档。</li>\n<li>alice 拿到这个密文文档以后，它可以用这把秘钥还原为原始的明文文档。</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/7xV3Qk2.jpeg\" alt=\"3.jpg\" /></p>\n<ul>\n<li>对称加密究竟是如何实现的，我们可以以 RC4 这样一个对称加密序列算法来看一下。</li>\n<li>加密：秘钥序列 + 明文 = 密文</li>\n<li>解密：秘钥序列 + 密文 = 明文</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/MJoaWpe.jpeg\" alt=\"4.jpg\" /></p>\n<h5 id=\"22-加密模型-非对称加密\"><a class=\"anchor\" href=\"#22-加密模型-非对称加密\">#</a> <strong>2.2</strong> <strong>加密模型</strong> - 非对称加密</h5>\n<p>非对称加密：它根据一个数学原理，创建一对秘钥（公钥和私钥）公钥加密，私钥解密；</p>\n<ul>\n<li>私钥：私钥自己使用，不对外开放。</li>\n<li>公钥：公钥给大家使用，对外开放。</li>\n</ul>\n<p>比如：alice 有一对公钥和私钥，他可以将公钥发布给任何人。假设 Bob 是其中一个，当 Bob 要传递一份加密文档给 alice，那么 Bob 就可以用 alice 的公钥进行加密，alice 收到密文文档后通过自己的私钥进行解密，获取原始文档。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/QcsWfn2.jpeg\" alt=\"5.jpg\" /></p>\n<p><em>注意：alice 必须知道 Bob 就是 Bob，也就是它收到的信息必须是 Bob 发来的，那么这个信任问题，在多方通讯的过程中，必须有一个公信机构来验证双方的身份，那么这个机构就是 CA 机构。</em></p>\n<h5 id=\"23-身份验证机构-ca\"><a class=\"anchor\" href=\"#23-身份验证机构-ca\">#</a> <strong>2.3</strong> <strong>身份验证机构</strong> - CA</h5>\n<p>通讯双方是如何验证双方的身份？</p>\n<p>CA 架构是可信任组织架构，主要用来颁发证书及验证证书。那 CA 机构又是如何申请和颁发证书的呢？</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/988nnCD.jpeg\" alt=\"6.jpg\" /></p>\n<p>我们首先需要申请证书，需要进行登记，登记我是谁，我是什么组织，我想做什么，到了登记机构在通过 CSR 发给 CA，CA 中心通过后，CA 中心会生成一对公钥和私钥，那么公钥会在 CA 证书链中保存，公钥和私钥证书订阅人拿到后，会将其部署在 WEB 服务器上</p>\n<p>1. 当浏览器访问我们的 https 站点时，它会去请求我们的证书</p>\n<p>2.Nginx 会将我们的公钥证书回传给浏览器。</p>\n<p>3. 浏览器会去验证我们的证书是否是合法的、是否是有效的。</p>\n<p>4.CA 机构会将过期的证书放置在 CRL 服务器，那么 CRL 服务的验证效率是非常差的，所以 CA 又推出了 OCSP 响应程序，OCSP 响应程序可以查询指定的一个证书是否过期，所以浏览器可以直接查询 OCSP 响应程序，但 OCSP 响应程序性能还不是很高。</p>\n<p>5.Nginx 会有一个 OCSP 的开关，当我们开启后，Nginx 会主动上 OCSP 上查询，这样大量的客户端直接从 Nginx 获取，证书是否有效。</p>\n<h5 id=\"24-https通讯原理\"><a class=\"anchor\" href=\"#24-https通讯原理\">#</a> <strong>2.4 HTTPS</strong> 通讯原理</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ZovzbXD.jpeg\" alt=\"7.jpg\" /></p>\n<p>HTTPS 加密过程，HTTPS 采用混合加密算法，即对称加密、和非对称加密</p>\n<p>通信前准备工作：申请域名对应的证书，并将其部署在 Nginx 服务器中。</p>\n<ul>\n<li>第一步客户端向服务端发送 Client Hello 消息，这个消息里包含了一个客户端生成的随机数 Random1、客户端支持的加密套件和客户端支持 TLS 协议版本等信息。</li>\n<li>服务端会向客户端发送 Server Hello 消息。返回自己的公钥证书、挑选一个合适的加密套件、另外还会生成一份随机数 Random2 推送给客户端。至此客户端和服务端都拥有了两个随机数（Random1+ Random2）</li>\n<li>客户端收到服务端传来的公钥证书后，先从 CA 验证该证书的合法性（CA 公钥去解密公钥证书），验证通过后取出证书中的服务端公钥，再生成一个随机数 Random3，再用服务端公钥非对称加密 Random3。</li>\n<li>服务端用自己的私钥解出客户端生成的 Random3。至此，客户端和服务端都拥有 Random1 + Random2 +Random3，两边根据同样的算法生成一份秘钥，握手结束后的应用层数据都是使用这个秘钥进行对称加密。</li>\n</ul>\n<h4 id=\"3https扩展知识\"><a class=\"anchor\" href=\"#3https扩展知识\">#</a> <strong>3.HTTPS</strong> 扩展知识</h4>\n<h5 id=\"31-https证书类型\"><a class=\"anchor\" href=\"#31-https证书类型\">#</a> <strong>3.1 Https</strong> 证书类型</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/E2YSlWN.jpeg\" alt=\"8.jpg\" /></p>\n<h5 id=\"32-https颜色标识\"><a class=\"anchor\" href=\"#32-https颜色标识\">#</a> <strong>3.2 Https</strong> 颜色标识</h5>\n<ul>\n<li>Https 不支持续费，证书到期需重新申请新并进行替换。</li>\n<li>Https 不支持三级域名解析，如 <a href=\"http://test.m.hmallleasing.com\">test.m.hmallleasing.com</a> *.m.hmallleasing.com</li>\n<li>Https 显示绿色，说明整个网站的 url 都是 https 的，并且都是安全的。</li>\n<li>Https 显示黄色，说明网站代码中有部分 URL 地址是 http 不安全协议的。(https (http url) )</li>\n<li>Https 显示红色，要么证书是假的，要么证书已经过期。</li>\n</ul>\n<h4 id=\"4https单台配置实践\"><a class=\"anchor\" href=\"#4https单台配置实践\">#</a> <strong>4.HTTPS</strong> 单台配置实践</h4>\n<h5 id=\"41-创建ssl证书\"><a class=\"anchor\" href=\"#41-创建ssl证书\">#</a> <strong>4.1</strong> <strong>创建</strong> SSL 证书</h5>\n<p>1. 创建证书存储目录</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /etc/nginx/ssl_key</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/nginx/ssl_key</span></pre></td></tr></table></figure><p>2. 使用 openssl 命令充当 CA 权威机构创建证书</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ssl_key<span class=\"token punctuation\">]</span><span class=\"token comment\"># openssl genrsa -idea -out server.key 2048</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Generating RSA private key, <span class=\"token number\">2048</span> bit long modulus</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>.+++</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>+++</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>e is <span class=\"token number\">65537</span> <span class=\"token punctuation\">(</span>0x10001<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#记住配置密码，我这里是 1234</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Enter pass phrase <span class=\"token keyword\">for</span> server.key:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Verifying - Enter pass phrase <span class=\"token keyword\">for</span> server.key:</pre></td></tr></table></figure><p>3. 生成自签证书，同时去掉私钥的密码</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ssl_key<span class=\"token punctuation\">]</span><span class=\"token comment\"># openssl req -days 36500 -x509 \\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token parameter variable\">-sha256</span> <span class=\"token parameter variable\">-nodes</span> <span class=\"token parameter variable\">-newkey</span> rsa:2048 <span class=\"token parameter variable\">-keyout</span> server.key <span class=\"token parameter variable\">-out</span> server.crt</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Country Name <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> letter code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>XX<span class=\"token punctuation\">]</span>:CN  <span class=\"token comment\">#国家</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>State or Province Name <span class=\"token punctuation\">(</span>full name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:WH  <span class=\"token comment\">#省</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Locality Name <span class=\"token punctuation\">(</span>eg, city<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Default City<span class=\"token punctuation\">]</span>:WH  <span class=\"token comment\">#城市</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Organization Name <span class=\"token punctuation\">(</span>eg, company<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefaultCompany Ltd<span class=\"token punctuation\">]</span>:edu <span class=\"token comment\">#公司</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Organizational Unit Name <span class=\"token punctuation\">(</span>eg, section<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>: xuyong <span class=\"token comment\">#单位</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Common Name <span class=\"token punctuation\">(</span>eg, your name or your servers <span class=\"token function\">hostname</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>: s.hmallleasing.com <span class=\"token comment\">#服务器主机名称</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Email Address <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:373370405@qq.com</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># req --> 用于创建新的证书</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># new --> 表示创建的是新证书</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># x509 --> 表示定义证书的格式为标准格式</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># key --> 表示调用的私钥文件信息</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># out --> 表示输出证书文件信息</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># days --> 表示证书的有效期</span></pre></td></tr></table></figure><h5 id=\"41-配置ssl场景\"><a class=\"anchor\" href=\"#41-配置ssl场景\">#</a> <strong>4.1</strong> <strong>配置</strong> SSL 场景</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat s.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">#rewrite ^(.*)$ https://$server_name$1 redirect;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlisten <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ssl_certificate ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    ssl_certificate_key  ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/ssl_key</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ssl_key<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1675</span> Sep  <span class=\"token number\">6</span> <span class=\"token number\">21</span>:08 hmallleasing.com.key</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">4784</span> Sep  <span class=\"token number\">6</span> <span class=\"token number\">21</span>:08 hmallleasing.com.pem</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"hello https\" > /code/index.html</span></pre></td></tr></table></figure><h5 id=\"43-访问验证ssl\"><a class=\"anchor\" href=\"#43-访问验证ssl\">#</a> <strong>4.3</strong> <strong>访问验证</strong> SSL</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gEREKru.jpeg\" alt=\"1.jpg\" /></p>\n<h4 id=\"5https集群配置实践\"><a class=\"anchor\" href=\"#5https集群配置实践\">#</a> <strong>5.HTTPS</strong> 集群配置实践</h4>\n<h5 id=\"51-环境准备\"><a class=\"anchor\" href=\"#51-环境准备\">#</a> <strong>5.1</strong> <strong>环境准备</strong></h5>\n<table>\n<thead>\n<tr>\n<th><strong>主机名</strong></th>\n<th><strong>外网</strong> IP (NAT)</th>\n<th><strong>内网</strong> IP (LAN)</th>\n<th><strong>角色</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>lb01</td>\n<td>eth0:10.0.0.5</td>\n<td>eth1:172.16.1.5</td>\n<td>nginx-proxy</td>\n</tr>\n<tr>\n<td>web01</td>\n<td>eth0:10.0.0.7</td>\n<td>eth1:172.16.1.7</td>\n<td>nginx-web01</td>\n</tr>\n<tr>\n<td>web02</td>\n<td>eth0:10.0.0.8</td>\n<td>eth1:172.16.1.8</td>\n<td>nginx-web02</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"52-配置应用节点\"><a class=\"anchor\" href=\"#52-配置应用节点\">#</a> <strong>5.2</strong> <strong>配置应用节点</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置所有后端节点，监听 80 端口即可；</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat s.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code/wordpress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web01-https...\" > /code/index.html</span></pre></td></tr></table></figure><h5 id=\"53-配置负载均衡\"><a class=\"anchor\" href=\"#53-配置负载均衡\">#</a> <strong>5.3</strong> 配置负载均衡</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1.Nginx 负载均衡配置文件如下</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream site <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.7:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>10s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.8:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>10s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># https 站点配置信息</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    ssl_certificate ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ssl_certificate_key  ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tproxy_pass http://site<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 用户请求 http 协议，强制跳转至 https 协议</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params </span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># 2. 重启 Nginx 负载均衡</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h4 id=\"6https场景配置实践\"><a class=\"anchor\" href=\"#6https场景配置实践\">#</a> <strong>6.HTTPS</strong> 场景配置实践</h4>\n<h5 id=\"61-场景实践-1\"><a class=\"anchor\" href=\"#61-场景实践-1\">#</a> <strong>6.1</strong> <strong>场景实践</strong> - 1</h5>\n<p>模拟银行网站场景:</p>\n<ul>\n<li>1. 用户访问网站主站，使用 http 协议提供访问。</li>\n<li>2. 当用户点击登陆时，则网站会跳转至一个新的域名，并使用的是 Https 提供安全访问。</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 主页展示 http://yh.hmallleasing.com（提供网页浏览）</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#2. 模拟登陆 http://yh.hmallleasing.com/login（相当于点击了登陆按钮）</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#3. 登陆页面 https://star.hmallleasing.com (提供安全登陆)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#1. 配置 https://star.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/star.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name start.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ssl_certificate ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_certificate_key  ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\troot /code/login<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/login</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"start-login...\" > /code/login/index.html</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#2. 配置 http://yh.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/yh.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tserver_name yh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tlocation /login <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://start.hmallleasign.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"yh...\" > /code/index.html </span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"62-场景实践-2\"><a class=\"anchor\" href=\"#62-场景实践-2\">#</a> <strong>6.2</strong> <strong>场景实践</strong> - 2</h5>\n<p>需求：希望用户访问网站的所有 Url 走 Https 协议，<a href=\"http://xn--s-m66a184q7ri.hmallleasing.com/abc%E6%97%B6%E8%B5%B0Http%E5%8D%8F%E8%AE%AE\">但访问 s.hmallleasing.com/abc 时走 Http 协议</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat s.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream site <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>10s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>10s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># https 站点配置信息</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ssl_certificate ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_certificate_key  ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tproxy_pass http://site<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 用户请求 http 协议，强制跳转至 https 协议</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$request_uri</span> <span class=\"token operator\">!</span>~ <span class=\"token string\">\"^/abc\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tproxy_pass http://site<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"63-场景实践-3\"><a class=\"anchor\" href=\"#63-场景实践-3\">#</a> <strong>6.3</strong> <strong>场景实践</strong> - 3</h5>\n<p>开启 OCSP，加速验证证书是否有效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 准备 OCSP 证书：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># wget -O root.pem https://ssl-tools.net/certificates/dac9024f54d8f6df94935fb1732638ca6ad77c13.pem</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># wget -O intermediate.pem https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># cat intermediate.pem > /etc/nginx/ssl_key/ocsp.pem</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># cat root.pem >> /etc/nginx/ssl_key/ocsp.pem</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 配置 Nginx</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat s.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>upstream site <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>10s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>10s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># https 站点配置信息</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tlisten <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        ssl_certificate ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        ssl_certificate_key  ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">#开启 OCSP</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tssl_stapling on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tssl_stapling_verify on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tssl_trusted_certificate ssl_key/ocsp.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tproxy_pass http://site<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\"># 用户请求 http 协议，强制跳转至 https 协议</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p>验证是否开启 OCSP 响应程序</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 命令验证</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo QUIT | openssl s_client -connect s.hmallleasing.com:443 -status 2>/dev/null | grep -A 17 \"OCSP response\"</span></pre></td></tr></table></figure><h4 id=\"7https优化配置实践\"><a class=\"anchor\" href=\"#7https优化配置实践\">#</a> <strong>7.HTTPS</strong> 优化配置实践</h4>\n<p>SSL 的运行计算需要消耗额外的 CPU 资源，SSL 通讯过程中『握手』阶段的运算最占用 CPU 资源，有如下几个方面可以进行调整与优化。</p>\n<ul>\n<li>1. 设置 worker 进程数设置为等于 CPU 处理器的核心数。worker_processes auto</li>\n<li>2. 启用 keepalive 长连接，一个连接发送更多个请求</li>\n<li>3. 启用 shared 会话缓存，所有 worker 工作进程之间共享的缓存，避免进行多次 SSL『握手』</li>\n<li>4. 禁用 builtin 内置于的缓存，仅能供一个 worker 工作进程使用，使用 shared 缓存即禁止 builtin</li>\n</ul>\n<h5 id=\"71-优化配置实例\"><a class=\"anchor\" href=\"#71-优化配置实例\">#</a> <strong>7.1</strong> <strong>优化配置实例</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>worker_processes auto<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tlisten <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tserver_name www.example.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tssl_certificate www.example.com.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tssl_certificate_key www.example.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token comment\">#Nginx 决定使用哪些协议与浏览器进行通讯</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tssl_protocols TLSv1.2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token comment\">#设置长连接</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tkeepalive_timeout <span class=\"token number\">70</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token comment\">#默认不开启 session_cache： a 握手后，关闭浏览器，再次访问，需要重新握手；</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\">#建立握手后如果连接断开，在 session_timeout 时间内再次连接，无需再次建立握手，可直接复用之间缓存的连接。</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token comment\">#1M 缓存空间能存储 4000 个会话数量</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tssl_session_cache shared:SSL:10m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token comment\">#配置会话超时时间 1 天 （ 默认 5 分钟 ）</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tssl_session_timeout 1440m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"72-优化配置实例\"><a class=\"anchor\" href=\"#72-优化配置实例\">#</a> <strong>7.2</strong> <strong>优化配置实例</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat s.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream site <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>10s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>10s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># https 站点配置信息</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tssl_protocols TLSv1.2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    ssl_certificate ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ssl_certificate_key  ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tssl_session_cache shared:SSL:10m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tssl_session_timeout 1440m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tproxy_pass http://site<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 用户请求 http 协议，强制跳转至 https 协议</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tserver_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/245964480.html",
            "url": "http://ixuyong.cn/posts/245964480.html",
            "title": "Nginx Rewrite场景实战（十一）",
            "date_published": "2025-09-02T11:25:18.000Z",
            "content_html": "<h3 id=\"nginx-rewrite场景实战\"><a class=\"anchor\" href=\"#nginx-rewrite场景实战\">#</a> Nginx Rewrite 场景实战</h3>\n<h4 id=\"1rewrite基本介绍\"><a class=\"anchor\" href=\"#1rewrite基本介绍\">#</a> 1.Rewrite 基本介绍</h4>\n<h5 id=\"11-什么是rewrite\"><a class=\"anchor\" href=\"#11-什么是rewrite\">#</a> <strong>1.1</strong> <strong>什么是</strong> Rewrite</h5>\n<p>Rewrite 主要实现 url 地址重写， 以及 url 地址跳转。就是将用户请求 web 服务器的 URL 地址重新修改为其他 URL 地址的过程。</p>\n<p>比如说京东，google、亚马逊都在使用</p>\n<table>\n<thead>\n<tr>\n<th><strong>域名</strong></th>\n<th><strong>重写后域名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"http://www.z.cn\">www.z.cn</a></td>\n<td><a href=\"http://www.amazon.cn\">www.amazon.cn</a></td>\n</tr>\n<tr>\n<td><a href=\"http://www.g.cn\">www.g.cn</a></td>\n<td><a href=\"http://www.google.cn\">www.google.cn</a></td>\n</tr>\n<tr>\n<td><a href=\"http://www.360buy.com\">www.360buy.com</a></td>\n<td><a href=\"http://www.jd.com\">www.jd.com</a></td>\n</tr>\n<tr>\n<td><a href=\"http://58.com\">58.com</a></td>\n<td><a href=\"http://bj.58.com\">bj.58.com</a></td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"12-rewrite应用场景\"><a class=\"anchor\" href=\"#12-rewrite应用场景\">#</a> <strong>1.2 Rewrite</strong> 应用场景</h5>\n<ul>\n<li>1. 地址跳转，用户访问 www.jd.com 这个 URL 时，<a href=\"http://xn--m-zn6a4eo4l12dva439dgkiz1a902e7j6bpx2a.jd.com\">将其定向至一个新的域名 m.jd.com</a></li>\n<li>2. 协议跳转，将用户通过 http 的请求协议重新跳转至 https 协议 (实现 https 主要手段)。</li>\n<li>3.URL 静态化，将动态 URL 地址显示为静态 URL 的一种技术，能提高搜索引擎抓取，并且能减少动态 URL 对外暴露过多的参数。</li>\n</ul>\n<h5 id=\"13-rewrite重写原理\"><a class=\"anchor\" href=\"#13-rewrite重写原理\">#</a> <strong>1.3 Rewrite</strong> 重写原理</h5>\n<ul>\n<li>1.nginx 和业务在一台服务器 ；</li>\n<li><a href=\"http://2.xn--nginx360buy-mv8q212b85bn8lo10c2r3h6dh.com\">2.nginx 和业务系统分开 360buy.com</a> rewrite--&gt; <a href=\"http://jd.com\">jd.com</a>；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/B3MT2uF.png\" alt=\"2.png\" /></p>\n<h5 id=\"14-rewrite重写模块\"><a class=\"anchor\" href=\"#14-rewrite重写模块\">#</a> <strong>1.4 Rewrite</strong> 重写模块</h5>\n<ul>\n<li>set 设置变量</li>\n<li>if 语句判断</li>\n<li>return 返回返回值或 URL</li>\n<li>rewrite 重定向 URL</li>\n</ul>\n<h4 id=\"2rewrite重写模块\"><a class=\"anchor\" href=\"#2rewrite重写模块\">#</a> <strong>2.Rewrite</strong> 重写模块</h4>\n<h5 id=\"21-if条件判断指令\"><a class=\"anchor\" href=\"#21-if条件判断指令\">#</a> <strong>2.1 if</strong> 条件判断指令</h5>\n<h6 id=\"211-语法示例\"><a class=\"anchor\" href=\"#211-语法示例\">#</a> <strong>2.1.1</strong> <strong>语法示例</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: server, location</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># ~ 模糊匹配</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># ~* 不区分大小写的匹配</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># !~ 不匹配</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># = 精确匹配</span></pre></td></tr></table></figure><h6 id=\"212-场景示例\"><a class=\"anchor\" href=\"#212-场景示例\">#</a> <strong>2.1.2</strong> <strong>场景示例</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>url.hmallleasing.com/index.html?id<span class=\"token operator\">=</span><span class=\"token number\">1234</span> --》 proxy--<span class=\"token operator\">></span><span class=\"token number\">192.168</span>.1.8:8080</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 需求：匹配 Nginx 请求中包含 id=2356 的，然后代理到 192.168.1.8 的 8080 端口</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tdefault_type application/json<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token comment\">#\\d 表示数字，&#123;4&#125; 表示 4 次，&#123;4,8&#125; 表示数字出现的次数是 4 到 8 次，如 gid=12345678 就符合该条件。</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$request_uri</span> ~* <span class=\"token string\">'id=\\d&#123;4&#125;'</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tproxy_pass http://192.168.1.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -L -HHost:url.hmalllleasing.com http://192.168.1.7/?id=2356</span></pre></td></tr></table></figure><h5 id=\"22-set设定变量指令\"><a class=\"anchor\" href=\"#22-set设定变量指令\">#</a> <strong>2.2 set</strong> 设定变量指令</h5>\n<h6 id=\"221-语法示例\"><a class=\"anchor\" href=\"#221-语法示例\">#</a> <strong>2.2.1</strong> <strong>语法示例</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: <span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$variable</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: server, location, <span class=\"token keyword\">if</span></pre></td></tr></table></figure><h6 id=\"222-场景示例\"><a class=\"anchor\" href=\"#222-场景示例\">#</a> <strong>2.2.2</strong> <strong>场景示例</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：通过 user_agent（Header）拦截压测测试工具</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># user_agent:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># chrome ,firefox, curl/7.29.0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 1. 确认来请求的用户是使用的 curl 命令，如果是则做一个标记，设置为 1；</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 2. 判断标记，如果标记的值假设为 1，我们就拒绝，如果不为 1 则不处理；</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"firefox|curl|Wget|ApacheBench\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$deny_user_agent</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$deny_user_agent</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">403</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#默认 curl 测试拒绝场景（-A 指定 user_agent）</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -L -I -A \"curl\" -HHost:url.hmallleasing.com http://192.168.1.7/</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>HTTP/1.1 <span class=\"token number\">403</span> Forbidden</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Date: Thu, 04 Sep <span class=\"token number\">2025</span> 07:36:43 GMT</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>Content-Length: <span class=\"token number\">153</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">#默认 chrome 测试拒绝场景（-A 指定 user_agent）</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -L -I -A \"chrome\" -HHost:url.hmallleasing.com http://192.168.1.7/</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>HTTP/1.1 <span class=\"token number\">200</span> OK</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>Date: Thu, 04 Sep <span class=\"token number\">2025</span> 07:37:42 GMT</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Content-Length: <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>Last-Modified: Thu, 04 Sep <span class=\"token number\">2025</span> 07:32:58 GMT</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>ETag: <span class=\"token string\">\"68b940aa-6\"</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>Accept-Ranges: bytes</pre></td></tr></table></figure><h5 id=\"23-return返回数据指令\"><a class=\"anchor\" href=\"#23-return返回数据指令\">#</a> <strong>2.3 return</strong> 返回数据指令</h5>\n<h6 id=\"231-语法示例\"><a class=\"anchor\" href=\"#231-语法示例\">#</a> <strong>2.3.1</strong> <strong>语法示例</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: <span class=\"token builtin class-name\">return</span> code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">return</span> code <span class=\"token punctuation\">[</span>text<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">return</span> URL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Context: server, location, <span class=\"token keyword\">if</span></pre></td></tr></table></figure><h6 id=\"232-场景实践\"><a class=\"anchor\" href=\"#232-场景实践\">#</a> <strong>2.3.2</strong> <strong>场景实践</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：客户端使用 IE 浏览器访问站点，则返回段字符串或返回错误</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"MSIE|firefox\"</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token comment\"># 返回字符串</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">\"Change browser\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token comment\"># 返回状态码</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">500</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token comment\"># 返回 URL，进行站点跳转</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://www.jd.com </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 模拟测试 1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -L -A \"firefox\" -HHost:url.hmallleasing.com http://192.168.1.7/</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Change browser</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 模拟测试 2</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -I -L -A  \"firefox\" -HHost:url.hmallleasing.com http://192.168.1.7/</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>HTTP/1.1 <span class=\"token number\">500</span> Internal Server Error</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Date: Thu, 04 Sep <span class=\"token number\">2025</span> 07:52:36 GMT</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>Content-Length: <span class=\"token number\">177</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Connection: close</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># 模拟测试 3</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -I -L -A  \"firefox\" -HHost:url.hmallleasing.com http://192.168.1.7/</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>HTTP/1.1 <span class=\"token number\">302</span> Moved Temporarily</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>Date: Thu, 04 Sep <span class=\"token number\">2025</span> 07:51:32 GMT</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Content-Length: <span class=\"token number\">145</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Location: http://www.qq.com</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>HTTP/1.1 <span class=\"token number\">302</span> Moved Temporarily</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>Server: stgw</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>Date: Thu, 04 Sep <span class=\"token number\">2025</span> 07:51:52 GMT</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>Content-Length: <span class=\"token number\">137</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>Location: https://www.qq.com/</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>HTTP/1.1 <span class=\"token number\">200</span> OK</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>Date: Thu, 04 Sep <span class=\"token number\">2025</span> 07:51:52 GMT</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>Content-Type: text/plain<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">charset</span><span class=\"token operator\">=</span>utf-8</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>Content-Length: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>Server: tRPC-Gateway</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>Inews_trace_id: <span class=\"token number\">40396647090904155152</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>Inews-Trace-Id: <span class=\"token number\">40396647090904155152</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>X-Upstream-Latency: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>X-Proxy-Latency: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>X-Frame-Options: SAMEORIGIN</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>Content-Security-Policy: frame-ancestors none</pre></td></tr></table></figure><h4 id=\"3-rewrite重写flag\"><a class=\"anchor\" href=\"#3-rewrite重写flag\">#</a> 3. Rewrite 重写 Flag</h4>\n<p>rewrite 主要是用来重写 URL 或者跳转 URL 的指令。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#rewrite 表达式可以应用在 server,location, if 标签下</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 关键字 正则 替代内容 flag 标记</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Syntax: rewrite regex replacement <span class=\"token punctuation\">[</span>flag<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Default: --</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Context: server, location, <span class=\"token keyword\">if</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#flag</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>last      <span class=\"token comment\">#本条规则匹配完成后，继续向下匹配新的 location URI 规则</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token builtin class-name\">break</span>     <span class=\"token comment\">#本条规则匹配完成即终止，不再匹配后面的任何规则</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>redirect  <span class=\"token comment\">#返回 302 临时重定向，地址栏会显示跳转后的地址</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>permanent <span class=\"token comment\">#返回 301 永久重定向，地址栏会显示跳转后的地址</span></pre></td></tr></table></figure><h5 id=\"31-测试代码准备\"><a class=\"anchor\" href=\"#31-测试代码准备\">#</a> **3.1 ** 测试代码准备</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\trewrite /1.html /2.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\trewrite /2.html /3.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation /2.html <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\trewrite /2.html /a.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tlocation /3.html <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\trewrite /3.html /b.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -tl</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#准备对应代码</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"1.html\" >/code/1.html</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"2.html\" >/code/2.html</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"3.html\" >/code/3.html</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"a.html\" >/code/a.html</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"b.html\" >/code/b.html</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#测试结果：当请求 / 1.html，最终将会访问 /b.html</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:url.hmallleasing.com http://192.168.1.7/1.html</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>b.html</pre></td></tr></table></figure><h5 id=\"32-break与last\"><a class=\"anchor\" href=\"#32-break与last\">#</a> 3.2 Break 与 last</h5>\n<h6 id=\"321-为代码添加break\"><a class=\"anchor\" href=\"#321-为代码添加break\">#</a> <strong>3.2.1</strong> <strong>为代码添加</strong> Break</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#测试结果：当请求 / 1.html，最终会访问 / 2.html</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#因为：在 location &#123;&#125; 内部，遇到 break，本 location &#123;&#125; 内以及后面的所有 location &#123;&#125; 内的所有指令都不再执行。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">#网站维护示例</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">#rewrite  ^(.*)$ /weihu.html break;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\trewrite /1.html /2.html <span class=\"token builtin class-name\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\trewrite /2.html /3.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tlocation /2.html <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\trewrite /2.html /a.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tlocation /3.html <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\trewrite /3.html /b.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:url.hmallleasing.com http://192.168.1.7/1.html</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token number\">2</span>.html</pre></td></tr></table></figure><h6 id=\"322-为代码添加last\"><a class=\"anchor\" href=\"#322-为代码添加last\">#</a> <strong>3.2.2</strong> <strong>为代码添加</strong> last</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 测试结果：当请求 / 1.html，最终会访问 /a.html</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 因为：在 location &#123;&#125; 内部，遇到 last，本 location &#123;&#125; 内后续指令不再执行，</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 而重写后的 url 会对所在的 server &#123;...&#125; 标签重新发起请求，从头到尾匹配一遍规则，哪个匹配则执行哪个。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\trewrite /1.html /2.html last<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\trewrite /2.html /3.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tlocation /2.html <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\trewrite /2.html /a.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlocation /3.html <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\trewrite /3.html /b.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:url.hmallleasing.com http://192.168.1.7/1.html</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>a.html</pre></td></tr></table></figure><h6 id=\"323-break与last区别\"><a class=\"anchor\" href=\"#323-break与last区别\">#</a> 3.2.3 break 与 last 区别</h6>\n<ul>\n<li>当 rewrite 规则遇到 break 后，本 location {} 与其他 location {} 的所有规则都不执行。</li>\n<li>当 rewrite 规则遇到 last 后，本 location {} 里后续规则不执行，但重写后的 url 会再次从头开始匹配所有 Location，哪个匹配执行哪个。</li>\n</ul>\n<h5 id=\"33-redirect与permanent\"><a class=\"anchor\" href=\"#33-redirect与permanent\">#</a> 3.3 redirect 与 permanent</h5>\n<h6 id=\"331-为代码添加redirect\"><a class=\"anchor\" href=\"#331-为代码添加redirect\">#</a> <strong>3.3.1</strong> <strong>为代码添加</strong> redirect</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\trewrite /1.html /2.html redirect<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\trewrite /2.html /3.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"332-为代码添加permanent\"><a class=\"anchor\" href=\"#332-为代码添加permanent\">#</a> <strong>3.3.2</strong> <strong>为代码添加</strong> permanent</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 跳转后状态码为 301</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\trewrite /1.html /2.html permanent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\trewrite /2.html /3.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"333-redirect与permanent区别\"><a class=\"anchor\" href=\"#333-redirect与permanent区别\">#</a> <strong>3.3.3 redirect</strong> 与 permanent 区别</h6>\n<table>\n<thead>\n<tr>\n<th><strong>Flag</strong></th>\n<th>跳转</th>\n<th>状态码</th>\n<th>排名情况</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>redirect</td>\n<td>临时跳转</td>\n<td>302</td>\n<td>对旧网站无影响，新网站会有排名（不会）</td>\n</tr>\n<tr>\n<td>permanent</td>\n<td>永久跳转</td>\n<td>301</td>\n<td>新跳转网站有排名，旧网站排名会被清空（缓存下来）</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"4rewrite生产案例实践\"><a class=\"anchor\" href=\"#4rewrite生产案例实践\">#</a> <strong>4.Rewrite</strong> 生产案例实践</h4>\n<h5 id=\"41-rewrite跳转示例1\"><a class=\"anchor\" href=\"#41-rewrite跳转示例1\">#</a> <strong>4.1 Rewrite</strong> 跳转示例 1</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：根据用户浏览器请求头中携带的语言调度到不同的页面</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># /zh</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># /en</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>url.hmallleasing.com --》hmallleasing.com/zh</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>url.hmallleasing.com --》hmallleasing.com/en</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_accept_language</span> ~* <span class=\"token string\">\"zh-CN|zh\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$language</span> zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_accept_language</span> ~* <span class=\"token string\">\"en\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$language</span> en<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\trewrite ^/$ /<span class=\"token variable\">$language</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">#根据语言跳转对应的站点</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zh  -p</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/en  -p</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"zh....\" > /code/zh/index.html</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"en....\" > /code/en/index.html</span></pre></td></tr></table></figure><h5 id=\"42-rewrite跳转示例2\"><a class=\"anchor\" href=\"#42-rewrite跳转示例2\">#</a> 4.2 Rewrite 跳转示例 2</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：用户通过手机设备访问 url.hmallleasing.com，跳转至 url.hmallleasing.com/m</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"android|iphone|ipad\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\trewrite ^/$ /m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"pc site\" > /code/index.html </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/m</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"m site\" > /code/m/index.html</span></pre></td></tr></table></figure><h5 id=\"43-rewrite跳转示例3\"><a class=\"anchor\" href=\"#43-rewrite跳转示例3\">#</a> 4.3 Rewrite 跳转示例 3</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：用户通过手机设备访问 url.hmallleasing.com 跳转至 m.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#1. 准备 PC 站</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"android|iphone|ipad\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token comment\">#return 302 http://m.hmallleasing.com;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\trewrite ^/$ http://m.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web01 pc site\" > /code/index.html</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#2. 准备手机站</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tserver_name m.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\troot /code/m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/m -p</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web02-site\" > /code/m/index.html</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"44-rewrite跳转示例4\"><a class=\"anchor\" href=\"#44-rewrite跳转示例4\">#</a> <strong>4.4 Rewrite</strong> 跳转示例 4</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：用户通过 http 协议请求，能自动跳转至 https 协议。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">#rewrite ^(.*)$ https://$server_name$1 redirect;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlisten <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate  /etc/nginx/sslkey/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_certificate_key  /etc/nginx/sslkey/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/nginx/</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir sslkey</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd ssl/</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ssl<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1675</span> Jun <span class=\"token number\">14</span> <span class=\"token number\">22</span>:01 hmallleasing.com.key</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">4784</span> Jun <span class=\"token number\">14</span> <span class=\"token number\">22</span>:01 hmallleasing.com.pem</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"hello https\" > /code/index.html</span></pre></td></tr></table></figure><h5 id=\"45-rewrite跳转示例5\"><a class=\"anchor\" href=\"#45-rewrite跳转示例5\">#</a> <strong>4.5 Rewrite</strong> 跳转示例 5</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：网站在维护过程中，希望用户访问所有网站重定向至一个维护页面</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">#配置示例</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\trewrite ^<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span>$ /wh.html <span class=\"token builtin class-name\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"wh.....\" > /code/wh.html</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"46-rewrite跳转示例6\"><a class=\"anchor\" href=\"#46-rewrite跳转示例6\">#</a> <strong>4.6 Rewrite</strong> 跳转示例 6</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：当服务器遇到 403 404 502 等错误时，自动转到临时维护的静态页。[https://404.life/]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">#配置示例</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\terror_page <span class=\"token number\">404</span> <span class=\"token number\">403</span> <span class=\"token number\">502</span> <span class=\"token operator\">=</span> @tempdown<span class=\"token punctuation\">;</span>\t</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlocation @tempdown <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\trewrite ^<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span>$ /wh.html <span class=\"token builtin class-name\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"47-rewrite跳转示例7\"><a class=\"anchor\" href=\"#47-rewrite跳转示例7\">#</a> <strong>4.7 Rewrite</strong> 跳转示例 7</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 公司网站在停机维护时，指定的 IP 能够正常访问，其他的 IP 跳转到维护页。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">#1. 在 server 层下设定 ip 变量值为 0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$ip</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">#2. 如果来源 IP 是 10.0.0.101 102 则设定变量为 ip 变量为 1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$remote_addr</span> ~ <span class=\"token string\">\"192.168.40.1|192.168.40.7\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$ip</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">#3. 如果来源 IP 不是 10.0.0.101 102、则跳转至 /code/wh.html 这个页面，否则不做任何处理</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ip</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\trewrite ^<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span>$ /wh.html <span class=\"token builtin class-name\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">#--> 如果想针对某个 location 进行操作，则将如上配置写入 location 中即可</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#测试 192.168.40.51 访问</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:url.hmallleasing.com http://192.168.40.8</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>wh<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">#测试 192.168.40.7 访问</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:url.hmallleasing.com http://192.168.40.8</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>hello https</pre></td></tr></table></figure><h5 id=\"48-rewrite跳转示例8\"><a class=\"anchor\" href=\"#48-rewrite跳转示例8\">#</a> <strong>4.8 Rewrite</strong> 跳转示例 8</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：公司网站后台 /admin，只允许公司的出口公网 IP 可以访问，其他的 IP 访问全部返回 500，或直接跳转至首页</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#限制访问来源 IP</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation /admin <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$ip</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$remote_addr</span> ~ <span class=\"token string\">\"192.168.40.1|192.168.40.7\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$ip</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ip</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">404</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token comment\">#rewrite /(.*)$ https://url.hmallleasing.com redirect;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/admin</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"admin site\" > /code/admin/index.html</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#测试 192.168.40.7 访问</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:url.hmallleasing.com http://192.168.40.8/admin/index.html</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>admin site</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">#测试 192.168.40.51 访问</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -L -HHost:url.hmallleasing.com http://192.168.40.8/admin/index.html</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token number\">404</span> Not Found<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token operator\">&lt;</span>center<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token number\">404</span> Not Found<span class=\"token operator\">&lt;</span>/h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token operator\">&lt;</span>/center<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token operator\">&lt;</span>hr<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>center<span class=\"token operator\">></span>nginx/1.26.<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/center<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></pre></td></tr></table></figure><h5 id=\"49-rewrite跳转示例9\"><a class=\"anchor\" href=\"#49-rewrite跳转示例9\">#</a> <strong>4.9 Rewrite</strong> 跳转示例 9</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#需求：请求 api.hmallleasing.com/bbb，实际请求：http://demo:27610/api/bbb</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#http://demo:27610/api/bbb 中 api 为请求二级域名，bbb 为请求 uri</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat url.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$http_host</span> ~* <span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span><span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span><span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$domain</span> <span class=\"token variable\">$1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\trewrite ^/<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span> http://demo:27610/<span class=\"token variable\">$domain</span><span class=\"token variable\">$request_uri</span> redirect<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -I -HHost:url.hmallleasing.com http://192.168.40.8/bbb</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>HTTP/1.1 <span class=\"token number\">302</span> Moved Temporarily</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Date: Fri, 05 Sep <span class=\"token number\">2025</span> <span class=\"token number\">14</span>:26:44 GMT</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Content-Length: <span class=\"token number\">145</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Location: http://demo:27610/url/bbb</pre></td></tr></table></figure><h5 id=\"410-rewrite跳转示例10\"><a class=\"anchor\" href=\"#410-rewrite跳转示例10\">#</a> <strong>4.10 Rewrite</strong> 跳转示例 10</h5>\n<p>现有两台服务器，想要实现 http://url.hmallleasing.com/index.php?r=sur/index/sid/613192/lang/zh-Hans 若访问资源为 /index.php?r=survey... 则跳转到 http://sur.hmallleasing.com/index.php?r=survey/index/sid/613192/lang/zh-Hans</p>\n<p>请求的域名：<a href=\"http://url.hmallleasing.com/index.php?r=survey/index/sid/613192/lang/zh-Hans\">http://url.hmallleasing.com/index.php?r=survey/index/sid/613192/lang/zh-Hans</a></p>\n<p>替换后域名：<a href=\"http://sur.hmallleasing.com/index.php?r=survey/index/sid/613192/lang/zh-Hans\">http://sur.hmallleasing.com/index.php?r=survey/index/sid/613192/lang/zh-Hans</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 变量 $args 为？之后的参数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/url.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$args</span> ~* <span class=\"token string\">\"r=survey\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t    <span class=\"token comment\"># ? 这个尾缀，重定向的目标地址结尾处如果加了？号，则不会再转发传递过来原地址问号内容</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\trewrite ^/<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span> http://sur.hmallleasing.com<span class=\"token variable\">$request_uri</span>? redirect<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 测试</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -I -HHost:url.hmallleasing.com http://192.168.40.7/index.php?r=survey/index/sid/613192/lang/zh-Hans</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>HTTP/1.1 <span class=\"token number\">302</span> Moved Temporarily</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Date: Sat, 06 Sep <span class=\"token number\">2025</span> 06:31:24 GMT</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Content-Length: <span class=\"token number\">145</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Location: http://sur.hmallleasing.com/index.php?r<span class=\"token operator\">=</span>survey/index/sid/613192/lang/zh-Hans</pre></td></tr></table></figure><h5 id=\"411-rewrite跳转示例11\"><a class=\"anchor\" href=\"#411-rewrite跳转示例11\">#</a> <strong>4.11 Rewrite</strong> 跳转示例 11</h5>\n<p>需求：将用户请求 http://url.hmallleasing.net/?id=2，替换为 <a href=\"http://url.hmallleasing.net/id/2.html\">http://url.hmallleasing.net/id/2.html</a></p>\n<ul>\n<li>1. 必须是请求 id？ 判断用户请求的是 id 这个关键参数；</li>\n<li>2. 提取整个 uri 中的两个字段， 将左边的做成一个变量，将右边的做成一个变量；</li>\n<li>3. 如果来源为 id 成立的话，则执行 rewirte；</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/url.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$args</span> ~* <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$OK</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$args</span> ~* <span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span><span class=\"token punctuation\">\\</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">))</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$id</span> <span class=\"token variable\">$1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$number</span> <span class=\"token variable\">$2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$OK</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token comment\"># ? 这个尾缀，重定向的目标地址结尾处如果加了？号，则不会再转发传递过来原地址问号内容</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\trewrite ^<span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span>$ http://<span class=\"token variable\">$&#123;server_name&#125;</span>/<span class=\"token variable\">$&#123;id&#125;</span>/<span class=\"token variable\">$&#123;number&#125;</span>.html? last<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#测试</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\">#  curl -I -HHost:url.hmallleasing.com http://192.168.40.7/?id=2</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>HTTP/1.1 <span class=\"token number\">302</span> Moved Temporarily</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>Date: Sat, 06 Sep <span class=\"token number\">2025</span> 06:49:24 GMT</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Content-Length: <span class=\"token number\">145</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Location: http://url.hmallleasing.com/id/2.html</pre></td></tr></table></figure><h5 id=\"412-禁止搜索引擎爬取站点\"><a class=\"anchor\" href=\"#412-禁止搜索引擎爬取站点\">#</a> <strong>4.12</strong> 禁止搜索引擎爬取站点</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 需求：通过 user_agent 防止搜索引擎的爬取</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/url.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name url.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  \t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"YisouSpider|YoudaoBot|tt\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">403</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#测试</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -I -A \"YisouSpider\" -HHost:url.hmallleasing.com http://192.168.40.7/</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>HTTP/1.1 <span class=\"token number\">403</span> Forbidden</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Date: Sat, 06 Sep <span class=\"token number\">2025</span> 06:59:32 GMT</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Content-Length: <span class=\"token number\">153</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -I -A \"ApacheBench\" -HHost:url.hmallleasing.com http://192.168.40.7/</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>HTTP/1.1 <span class=\"token number\">200</span> OK</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Date: Sat, 06 Sep <span class=\"token number\">2025</span> 06:59:32 GMT</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Content-Length: <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>Last-Modified: Sat, 06 Sep <span class=\"token number\">2025</span> 06:58:31 GMT</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>ETag: <span class=\"token string\">\"68bbdb97-c\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>Accept-Ranges: bytes</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -I -A \"TT\" -HHost:url.hmallleasing.com http://192.168.40.7/</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>HTTP/1.1 <span class=\"token number\">403</span> Forbidden</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>Date: Sat, 06 Sep <span class=\"token number\">2025</span> 06:59:32 GMT</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>Content-Length: <span class=\"token number\">153</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -I -A \"wget\" -HHost:url.hmallleasing.com http://192.168.40.7/</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>HTTP/1.1 <span class=\"token number\">200</span> OK</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>Server: nginx/1.26.1</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>Date: Sat, 06 Sep <span class=\"token number\">2025</span> 06:59:34 GMT</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>Content-Length: <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>Last-Modified: Sat, 06 Sep <span class=\"token number\">2025</span> 06:58:31 GMT</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>ETag: <span class=\"token string\">\"68bbdb97-c\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>Accept-Ranges: bytes</pre></td></tr></table></figure><h5 id=\"413-禁止站点资源被盗用\"><a class=\"anchor\" href=\"#413-禁止站点资源被盗用\">#</a> <strong>4.13</strong> 禁止站点资源被盗用</h5>\n<p>防盗链，指的是防止资源被其他网站恶意盗用。如何避免网站资源被盗用：可以根据客户端请求所携带的 Referer 信息来验证请求的合法性，因为 Referer 会告诉服务器它是丛哪一个域名点击过来的；</p>\n<p>基于 Referer 限制盗链：</p>\n<ul>\n<li>优点：规则简单、配置和使用都很方便，</li>\n<li>缺点：防盗链所依赖的 Referer 验证信息是可以伪造的，并非 100% 可靠，但基于 Referer 限制盗链的方式，可以限制绝大多数盗链情况。</li>\n</ul>\n<h6 id=\"4131-环境准备\"><a class=\"anchor\" href=\"#4131-环境准备\">#</a> <strong>4.13.1</strong> 环境准备</h6>\n<table>\n<thead>\n<tr>\n<th>角色</th>\n<th>IP</th>\n<th>域名</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>盗链节点（偷取资源）</td>\n<td>10.0.0.7</td>\n<td><a href=\"http://tou.hmallleasing.com\">tou.hmallleasing.com</a></td>\n</tr>\n<tr>\n<td>被盗链节点</td>\n<td>10.0.0.8</td>\n<td><a href=\"http://image.hmallleasing.com\">image.hmallleasing.com</a></td>\n</tr>\n</tbody>\n</table>\n<h6 id=\"4132-配置被盗链节点\"><a class=\"anchor\" href=\"#4132-配置被盗链节点\">#</a> <strong>4.13.2</strong> <strong>配置被盗链节点</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 在 10.0.0.8 节点配置 Nginx 站点信息</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/image.hmallleaing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name image.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 准备图片</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /code/xld.jpg </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">15817</span> Sep  <span class=\"token number\">6</span> <span class=\"token number\">15</span>:38 /code/xld.jpg</pre></td></tr></table></figure><h6 id=\"4133-配置盗链节点\"><a class=\"anchor\" href=\"#4133-配置盗链节点\">#</a> <strong>4.13.3</strong> <strong>配置盗链节点</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 在 10.0.0.7 节点配置 Nginx 站点信息</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/tou.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name tou.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/index.html</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>meta <span class=\"token assign-left variable\">charset</span><span class=\"token operator\">=</span><span class=\"token string\">\"utf-8\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>hmallleasing.com<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>img <span class=\"token assign-left variable\">src</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://image.hmallleasing.com/xld.jpg\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p>使用浏览器能正常访问到偷链的后的图片资源</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/UxfXetZ.jpeg\" alt=\"2.jpg\" /></p>\n<h6 id=\"4134-防盗链配置语法\"><a class=\"anchor\" href=\"#4134-防盗链配置语法\">#</a> <strong>4.13.4</strong> 防盗链配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 基于 http_referer 防止资源被盗用</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: valid_referers none <span class=\"token operator\">|</span> blocked <span class=\"token operator\">|</span> server_names <span class=\"token operator\">|</span> string <span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: server, location</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#none: Referer 来源头部为空的情况</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#blocked: Referer 来源头部不为空，直接填写允许的域名即可</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#server_names: 来源头部包含当前的域名，可以正则匹配</span></pre></td></tr></table></figure><h6 id=\"4135-防盗链配置实践\"><a class=\"anchor\" href=\"#4135-防盗链配置实践\">#</a> <strong>4.13.5</strong> <strong>防盗链配置实践</strong></h6>\n<p>配置所有来自 *.hmallleasing.com 都可以访问到 image.oldxu.net 站点的图片如果来源域名不在这个列表中，那么 $invalid_referer 变量值为 1，后续通过 if 判断，进行错误返回；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/image.hmallleaing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name image.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation ~ .*<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>jpg<span class=\"token operator\">|</span>jpeg<span class=\"token operator\">|</span>gif<span class=\"token operator\">|</span>png<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token comment\"># 来源域名如何合法，invalid_referer 这个变量被设置为 0，否则为 1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tvalid_referers none blocked *.hmallleasing.net<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$invalid_referer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">403</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token comment\"># 当然也可以返回一张图片给用户</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token comment\">#rewrite ^(.*)$ /error.jpg break;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t   <span class=\"token comment\"># 允许 google、baidu、等站点能够（盗链）资源，那么则可以通过 server_names 开放</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>       <span class=\"token comment\"># location ~ .*\\.(jpg|jpeg|gif|png)$ &#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>       <span class=\"token comment\">#         # 来源域名如何合法，invalid_referer 这个变量被设置为 0，否则为 1</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>       <span class=\"token comment\">#         valid_referers none blocked *.hmallleasing.net server_names ~\\.google\\.~\\.baidu\\.;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>       <span class=\"token comment\">#         if ($invalid_referer) &#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>       <span class=\"token comment\">#                 return 403;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>       <span class=\"token comment\">#                 # 当然也可以返回一张图片给用户</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>       <span class=\"token comment\">#                 #rewrite ^(.*)$ /error.jpg break;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>       <span class=\"token comment\">#         &#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>       <span class=\"token comment\">#&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p><strong>4.13.6</strong> <strong>防盗链结果验证</strong></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Tp6bIiy.jpeg\" alt=\"1.jpg\" /></p>\n",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2674400645.html",
            "url": "http://ixuyong.cn/posts/2674400645.html",
            "title": "Nginx代理-Uwsgi实践(十)",
            "date_published": "2025-09-01T11:21:48.000Z",
            "content_html": "<h3 id=\"nginx代理-uwsgi实践\"><a class=\"anchor\" href=\"#nginx代理-uwsgi实践\">#</a> Nginx 代理 - Uwsgi 实践</h3>\n<h4 id=\"1-uwsgi代理基本概述\"><a class=\"anchor\" href=\"#1-uwsgi代理基本概述\">#</a> 1. <strong>Uwsgi</strong> 代理基本概述</h4>\n<h5 id=\"11-什么是wsgi\"><a class=\"anchor\" href=\"#11-什么是wsgi\">#</a> 1.1 <strong>什么是</strong> wsgi</h5>\n<ul>\n<li>WSGI，全称 Web Server Gateway Interface 是为 Python 语言定义的 Web 服务器 和 Web 应用程序之间的一种简单通用的接口。</li>\n<li>WSGI 的官方定义，the Python Web ServerGateway Interface。从名字就可以看出来，这是一个 Gateway 网关。那么网关的作用就是在协议之间进行转换。</li>\n<li>也就是说，WSGI 就像是一座桥梁，一边连着 web 服务器，另一边连着 web 应用程序。</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/c0JmBnG.png\" alt=\"1.png\" /></p>\n<h5 id=\"12-什么是uwsgi\"><a class=\"anchor\" href=\"#12-什么是uwsgi\">#</a> 1.2 <strong>什么是</strong> uWSGI</h5>\n<p>uWSGI 实现了 WSGI、http 等数据交换协议。简单来说：我们将项目通过 uwsgi 方式运行，就可以直接对外提供服务，而无需依托于 Nginx。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/EVpKGtc.png\" alt=\"2.png\" /></p>\n<h5 id=\"13-uwsgi结合nginx\"><a class=\"anchor\" href=\"#13-uwsgi结合nginx\">#</a> 1.3 uWSGI 结合 nginx</h5>\n<p>通常情况下 Python 中的 Django 框架或 Flask 框架可以通过 Uwsgi 方式对外提供服务。为什么还需要 Nginx</p>\n<ul>\n<li>1. 安全：后端服务直接以 http 对外提供访问，往往会暴露后端的真实服务，如果使用 nginx 可以隐藏后端的服务，并且 nginx 能够实现安全限制、Rewrite、HTTPS 等功能（这些都是 uwsgi 无法实现的。）</li>\n<li>2. 效率：nginx 可以直接处理静态资源，然后将动态内容通过 uWSGI 协议转发给后端 Django，实现动静分离，提供更好的请求与响应。</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/qAPYl5n.png\" alt=\"3.png\" /></p>\n<h4 id=\"2-uwsgi代理配置场景\"><a class=\"anchor\" href=\"#2-uwsgi代理配置场景\">#</a> 2. Uwsgi 代理配置场景</h4>\n<ul>\n<li>步骤一、安装 python3 的环境</li>\n<li>步骤二、安装 Django 框架以及 uwsgi</li>\n<li>步骤三、配置 Django 工程</li>\n<li>步骤四、配置 uWSGI、配置 Nginx</li>\n</ul>\n<h5 id=\"21-安装python3\"><a class=\"anchor\" href=\"#21-安装python3\">#</a> 2.1 安装 Python3</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install openssl-devel bzip2-devel expat-devel gdbm-devel readline-devel \\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sqlite-devel gcc gcc-c++ openssl-develzlib zlib-devel python3 python3-devel <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><h5 id=\"22-安装django\"><a class=\"anchor\" href=\"#22-安装django\">#</a> 2.2 安装 Django</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 安装 Django 框架和 uwsgi</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pip3 install -i https://mirrors.aliyun.com/pypi/simple/ --upgrade pip</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pip3 install -i https://mirrors.aliyun.com/pypi/simple/ django==2.1.8</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pip3 install -i https://mirrors.aliyun.com/pypi/simple/ uwsgi</span></pre></td></tr></table></figure><h5 id=\"23-创建django项目\"><a class=\"anchor\" href=\"#23-创建django项目\">#</a> 2.3 创建 Django 项目</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 使用 Django 新建工程，运行如下指令</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /opt</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># django-admin.py startproject demosite</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd demosite</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 demosite<span class=\"token punctuation\">]</span><span class=\"token comment\"># python3 manage.py runserver 0.0.0.0:8002</span></pre></td></tr></table></figure><h5 id=\"24-访问django项目\"><a class=\"anchor\" href=\"#24-访问django项目\">#</a> 2.4 访问 Django 项目</h5>\n<p>在浏览器内输入 http://IP:8002 正常会提示 The install worked successfully! Congratulations!</p>\n<p>如果出现 ALLOWED_HOSTS 报错，修改如下配置即可；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 demosite<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim demosite/settings.py</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ALLOWED_HOSTS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h5 id=\"25-配置uwsgi运行项目\"><a class=\"anchor\" href=\"#25-配置uwsgi运行项目\">#</a> 2.5 配置 Uwsgi 运行项目</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置 Django 工程以由 uwsgi 方式运行</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 demosite<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /opt/demosite/uwsgi.ini</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>uwsgi<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#uwsgi 监听的端口</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>socket <span class=\"token operator\">=</span> <span class=\"token number\">127.0</span>.0.1:9999</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#uwsgi 启动进程数</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>workers <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#最大接收的请求数</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>max-requests <span class=\"token operator\">=</span> <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#buffer 缓冲区大小</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>buffer-size <span class=\"token operator\">=</span> <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#进程 pid 存放路径</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pidfile <span class=\"token operator\">=</span> /run/uwsgi.pid</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#uwsgi 日志存储路径</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>daemonize <span class=\"token operator\">=</span> /var/log/uwsgi.log</pre></td></tr></table></figure><h5 id=\"26-配置nginx代理uwsgi\"><a class=\"anchor\" href=\"#26-配置nginx代理uwsgi\">#</a> 2.6 配置 Nginx 代理 Uwsgi</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 通过 uwsgi 方式启动 django 项目，默认监听 127.0.0.1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 demosite<span class=\"token punctuation\">]</span><span class=\"token comment\"># uwsgi --ini /opt/demosite/uwsgi.ini       </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 demosite<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep 9999</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:9999          <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">3825</span>/uwsgi</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 配置 Nginx，使用 Nginx 代理 uwsgi 应用</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 demosite<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/py.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name py.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tclient_max_body_size 100M<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span> <span class=\"token comment\">#默认返回页面</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tuwsgi_pass <span class=\"token number\">127.0</span>.0.1:9999<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tuwsgi_param UWSGI_CHDIR /opt/demosite<span class=\"token punctuation\">;</span> <span class=\"token comment\">#工程所在的路径</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tuwsgi_param UWSGI_SCRIPT demosite.wsgi<span class=\"token punctuation\">;</span> <span class=\"token comment\">#demosite/wsgi 接口文件</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tinclude uwsgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 demosite<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 demosite<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h5 id=\"27-浏览器访问测试\"><a class=\"anchor\" href=\"#27-浏览器访问测试\">#</a> 2.7 浏览器访问测试</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KPNDNkB.png\" alt=\"1.png\" /></p>\n<h4 id=\"3uwsgi代理项目实践\"><a class=\"anchor\" href=\"#3uwsgi代理项目实践\">#</a> 3.Uwsgi 代理项目实践</h4>\n<p>使用 NginxUWSGI 代理方式部署 Python 的 Django 项目</p>\n<ul>\n<li>\n<p>1. 安装 python3 环境；</p>\n</li>\n<li>\n<p>2. 安装 Django 环境；</p>\n</li>\n<li>\n<p>3. 下载博客系统、安装博客系统所需要的模块；</p>\n</li>\n<li>\n<p>4. 配置博客链接的数据库、在数据上创建对应的库名；</p>\n</li>\n<li>\n<p>5. 导入博客的数据内容；</p>\n</li>\n<li>\n<p>6. 收集所有的静态资源文件到统一的一个目录中；</p>\n</li>\n<li>\n<p>7. 配置 uwsgi 运行</p>\n</li>\n<li>\n<p>8. 配置 Nginx 反向代理 uwsgi</p>\n</li>\n</ul>\n<h5 id=\"31-下载django博客系统\"><a class=\"anchor\" href=\"#31-下载django博客系统\">#</a> 3.1 下载 Django 博客系统</h5>\n<h5 id=\"31-下载django博客系统-2\"><a class=\"anchor\" href=\"#31-下载django博客系统-2\">#</a> 3.1 下载 Django 博客系统</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 下载博客系统项目并解压</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code &amp;&amp; cd /code</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip pythonav.zip</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#2. 安装该项目所需的依赖包软件</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pip3 install -i https://pypi.doubanio.com/simple/ -r /code/pythonav/requirements.txt</span></pre></td></tr></table></figure><h5 id=\"32-导入django项目数据库\"><a class=\"anchor\" href=\"#32-导入django项目数据库\">#</a> 3.2 导入 Django 项目数据库</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、下载 MySQL 官方扩展源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ivh http://repo.mysql.com/yum/mysql-5.7-community/el/7/x86_64/mysql57-community-release-el7-10.noarch.rpm</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2、安装 mysql5.7，文件过大可能会导致下载缓慢</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mysql-community-server -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、启动并加入开机自动启动</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4、查看端口是否启动</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep 3306</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::3306                 :::*                    LISTEN      <span class=\"token number\">1911</span>/mysqld  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#5、由于 mysql5.7 默认配置密码，需要过滤 temporary password 关键字查看对应登陆数据库密码</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># grep 'temporary password' /var/log/mysqld.log</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#6、登录 mysql 数据库 [password 中填写上一步过滤的密码]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#7、重新修改数据库密码</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'localhost'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2025'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#8、添加 app 用户</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'app'</span>@<span class=\"token string\">'192.168.1.%'</span> identified by <span class=\"token string\">'Superman*2025'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#9、允许 root 用户在任何地方进行远程登录，并具有所有库任何操作权限，具体操作如下</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql<span class=\"token operator\">></span> GRANT ALL PRIVILEGES ON *.* TO <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2025'</span> WITH GRANT OPTION<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>mysql<span class=\"token operator\">></span> FLUSH PRIVILEGES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#10、创建数据库</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>mysql<span class=\"token operator\">></span> create database pythonav<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">#11. 配置项目连接数据库信息</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 pythonav<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /code/BBS/BBS/settings.py</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>DATABASES <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token string\">'default'</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token string\">'ENGINE'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'django.db.backends.mysql'</span>,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token string\">'NAME'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'pythonav'</span>,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token string\">'HOST'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"127.0.0.1\"</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token string\">'USER'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'root'</span>,</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token string\">'PASSWORD'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'Superman*2025'</span>,</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token string\">'PORT'</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">3306</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#12. 初始化数据库</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 pythonav<span class=\"token punctuation\">]</span><span class=\"token comment\"># python3 manage.py makemigrations</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 pythonav<span class=\"token punctuation\">]</span><span class=\"token comment\"># python3 manage.py migrate</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">#13. 创建超级管理员用户</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 pythonav<span class=\"token punctuation\">]</span><span class=\"token comment\"># python3 manage.py</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>createsuperuser</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>Username <span class=\"token punctuation\">(</span>leave blank to use <span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span>: oldxu</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>Email address: <span class=\"token number\">552408925</span>@qq.com</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>Password: <span class=\"token comment\">#输入密码 Superman*2025</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>Password <span class=\"token punctuation\">(</span>again<span class=\"token punctuation\">)</span>: <span class=\"token comment\">#确认密码 Superman*2025</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>Superuser created successfully.</pre></td></tr></table></figure><h5 id=\"33-收集django静态文件\"><a class=\"anchor\" href=\"#33-收集django静态文件\">#</a> 3.3 收集 Django 静态文件</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 收集静态资源至指定位置存储</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 pythonav<span class=\"token punctuation\">]</span><span class=\"token comment\"># python3 manage.py collectstatic</span></pre></td></tr></table></figure><h5 id=\"34-配置uwsgi运行项目\"><a class=\"anchor\" href=\"#34-配置uwsgi运行项目\">#</a> 3.4 配置 Uwsgi 运行项目</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 Uwsgi 启动 Django 项目</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 pythonav<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat pythonav_uwsgi.ini</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>uwsgi<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#uwsgi 监听的端口</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>socket <span class=\"token operator\">=</span> <span class=\"token number\">127.0</span>.0.1:8811</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#指定项目所在路径</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>chdir <span class=\"token operator\">=</span> /code/pythonav/</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#指定项目入口文件</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>wsgi-file <span class=\"token operator\">=</span> pythonav/wsgi.py</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#uwsgi 启动的进程数量与线程数量</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>processes <span class=\"token operator\">=</span> <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>threads <span class=\"token operator\">=</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#最大接收的请求数</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>max-requests <span class=\"token operator\">=</span> <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#buffer 缓冲区大小</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>buffer-size <span class=\"token operator\">=</span> <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#进程 pid 存放路径</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>pidfile <span class=\"token operator\">=</span> /run/uwsgi-pythonav.pid</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#uwsgi 日志存储路径</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>daemonize <span class=\"token operator\">=</span> /var/log/uwsgi-pythonav.log</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#2. 启动 uwsgi</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># uwsgi --ini /code/pythonav/pythonav_uwsgi.ini</span></pre></td></tr></table></figure><h5 id=\"35-配置nginx代理uwsgi\"><a class=\"anchor\" href=\"#35-配置nginx代理uwsgi\">#</a> 3.5 配置 Nginx 代理 Uwsgi</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置 Nginx Uwsgi 反向代理</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 pythonav<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/av.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name av.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tclient_max_body_size 100M<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation /static <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token builtin class-name\">alias</span> /opt/pythonav/static<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token comment\">#root /opt/pythonav;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tuwsgi_pass <span class=\"token number\">127.0</span>.0.1:8811<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tinclude uwsgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"36-浏览器访问博客项目\"><a class=\"anchor\" href=\"#36-浏览器访问博客项目\">#</a> 3.6 浏览器访问博客项目</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/PFH2dst.jpeg\" alt=\"1.jpg\" /></p>\n",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2279050448.html",
            "url": "http://ixuyong.cn/posts/2279050448.html",
            "title": "Nginx代理-动静分离(九)",
            "date_published": "2025-09-01T11:18:51.000Z",
            "content_html": "<h3 id=\"nginx代理-动静分离\"><a class=\"anchor\" href=\"#nginx代理-动静分离\">#</a> Nginx 代理 - 动静分离</h3>\n<h4 id=\"1动静分离基本介绍\"><a class=\"anchor\" href=\"#1动静分离基本介绍\">#</a> 1. 动静分离基本介绍</h4>\n<h5 id=\"11-什么是动静分离\"><a class=\"anchor\" href=\"#11-什么是动静分离\">#</a> <strong>1.1</strong> <strong>什么是动静分离</strong></h5>\n<p>简单来说就是将动态请求和静态请求分开处理。</p>\n<h5 id=\"12-为何需要动静分离\"><a class=\"anchor\" href=\"#12-为何需要动静分离\">#</a> <strong>1.2</strong> <strong>为何需要动静分离</strong></h5>\n<ul>\n<li>首先 Tomcat 应用服务器在处理静态资源时效率不高，但默认情况下无论 “动态、静态 “ 资源都是由 tomcat 处理，而 Tomcat 在处理静态资源时需要进行逻辑运算，从而会导致应用响应慢，并且会占用不必要的系统资源。</li>\n<li>那么借助 Nginx 实现动态资源请求和静态资源请求分离后，可以减少系统不必要的消耗和延时。以便加快系统的处理性能。</li>\n</ul>\n<h5 id=\"13-如何实现动静分离\"><a class=\"anchor\" href=\"#13-如何实现动静分离\">#</a> <strong>1.3</strong> <strong>如何实现动静分离</strong></h5>\n<p>Nginx 通过用户请求的 uri 来区分请求的类型，并转发给不同的服务端。</p>\n<ul>\n<li>如果请求的 uri 包含 png、jpg 等资源则由 Nginx 处理；</li>\n<li>如果请求的 uri 包含 php、jsp 等资源则代理至 Tomcat 处理；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/HnMddaH.png\" alt=\"1.png\" /></p>\n<h4 id=\"2单机动静分离实践\"><a class=\"anchor\" href=\"#2单机动静分离实践\">#</a> **2.** 单机动静分离实践</h4>\n<p>单机实现动静分离 nginx + Tomcat</p>\n<h5 id=\"21-tomcat配置\"><a class=\"anchor\" href=\"#21-tomcat配置\">#</a> <strong>2.1 Tomcat</strong> 配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://download.oracle.com/otn/java/jdk/8u461-b11/68ce765258164726922591683c51982c/jdk-8u461-linux-x64.tar.gz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf jdk-8u461-linux-x64.tar.gz -C /usr/local</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/jdk1.8.0_461/ /usr/local/jdk</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#添加环境变量</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/profile.d/jdk.sh</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JAVA_HOME</span><span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$JAVA_HOME</span>/bin</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JRE_HOME</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/jre </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CLASSPATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/lib/:<span class=\"token variable\">$JRE_HOME</span>/lib/</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -version</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.108/bin/apache-tomcat-9.0.108.tar.gz</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf apache-tomcat-9.0.52.tar.gz -C /soft/</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /soft/apache-tomcat-9.0.108/ /soft/tomcat</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># /soft/tomcat/bin/startup.sh</span></pre></td></tr></table></figure><h5 id=\"22-nginx配置\"><a class=\"anchor\" href=\"#22-nginx配置\">#</a> <strong>2.2 Nginx</strong> 配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat java.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name java.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token comment\">#处理动态请求</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tproxy_pass http://192.168.1.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">#如果匹配到.png .jpg 这样的后缀，则让其通过 Nginx 读取本地 /code/images 下的资源文件\t</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation ~* <span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>png<span class=\"token operator\">|</span>jpg<span class=\"token operator\">|</span>svg<span class=\"token operator\">|</span>ioc<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\troot /code/images<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\texpires 30d<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#启用长连接</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h4 id=\"3集群动静分离实践\"><a class=\"anchor\" href=\"#3集群动静分离实践\">#</a> 3. 集群动静分离实践</h4>\n<p>通过 nginx 负载均衡将动态请求和静态请求进行分离，基于用户请求 URI 实现路由功能；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/XSrjylv.png\" alt=\"2.png\" /></p>\n<h5 id=\"31-环境准备\"><a class=\"anchor\" href=\"#31-环境准备\">#</a> <strong>3.1</strong> <strong>环境准备</strong></h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>系统</strong></th>\n<th style=\"text-align:center\"><strong>服务</strong></th>\n<th style=\"text-align:center\">角色</th>\n<th style=\"text-align:center\"><strong>地址</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">CentOS7.6</td>\n<td style=\"text-align:center\">负载均衡</td>\n<td style=\"text-align:center\">Nginx Proxy</td>\n<td style=\"text-align:center\">10.0.0.5</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CentOS7.6</td>\n<td style=\"text-align:center\">动态资源</td>\n<td style=\"text-align:center\">Tomcat Server</td>\n<td style=\"text-align:center\">10.0.0.7</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CentOS7.6</td>\n<td style=\"text-align:center\">静态资源</td>\n<td style=\"text-align:center\">Nginx Static</td>\n<td style=\"text-align:center\">10.0.0.8</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"32-配置静态节点\"><a class=\"anchor\" href=\"#32-配置静态节点\">#</a> <strong>3.2</strong> <strong>配置静态节点</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 在 10.0.0.8 服务器上配置静态资源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/ds.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name ds.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code/images<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 准备目录，以及静态相关图片</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/images -p</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget -O /code/images/nginx.png http://nginx.org/nginx.png</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"33-配置动态节点\"><a class=\"anchor\" href=\"#33-配置动态节点\">#</a> <strong>3.3</strong> <strong>配置动态节点</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 在 10.0.0.7 服务器上配置动态资源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># /soft/tomcat/bin/shutdown.sh</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /soft/tomcat/webapps/ROOT/*</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 编写 java 配置</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/webapps/ROOT/index.jsp</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">&lt;</span>%@ page <span class=\"token assign-left variable\">language</span><span class=\"token operator\">=</span><span class=\"token string\">\"java\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">import</span><span class=\"token operator\">=</span><span class=\"token string\">\"java.util.*\"</span> <span class=\"token assign-left variable\">pageEncoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"utf-8\"</span>%<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>Nginx+Tomcat动静分离<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>%</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\tRandom rand <span class=\"token operator\">=</span> new Random<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\tout.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;h2>动态资源&lt;/h2>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\tout.println<span class=\"token punctuation\">(</span>rand.nextInt<span class=\"token punctuation\">(</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span>+100<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t%<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>h<span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>静态图片<span class=\"token operator\">&lt;</span>/h<span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&lt;</span>img <span class=\"token assign-left variable\">src</span><span class=\"token operator\">=</span><span class=\"token string\">\"nginx.png\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># /soft/tomcat/bin/startup.sh</span></pre></td></tr></table></figure><h5 id=\"34-配置负载均衡\"><a class=\"anchor\" href=\"#34-配置负载均衡\">#</a> <strong>3.4</strong> <strong>配置负载均衡</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 负载均衡 10.0.0.5 上配置调度，根据不同的 url 调度到不同的服务器</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_ds.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream <span class=\"token function\">java</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.1.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>upstream static <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.1.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tserver_name ds.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tproxy_pass http://java<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tlocation ~* .*<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>png<span class=\"token operator\">|</span>jpg<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tproxy_pass http://static<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params </span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#启用长连接</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h5 id=\"35-测试集群动静分离\"><a class=\"anchor\" href=\"#35-测试集群动静分离\">#</a> <strong>3.5</strong> <strong>测试集群动静分离</strong></h5>\n<p>测试效果动静分离效果</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ePKNa5d.png\" alt=\"1.png\" /></p>\n<p>模拟静态资源集群故障。动态内容依旧能正常访问，静态内容则不会被请求到。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/qk8NUGU.png\" alt=\"2.png\" /></p>\n",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1240534980.html",
            "url": "http://ixuyong.cn/posts/1240534980.html",
            "title": "Nginx TCP四层负载均衡(八)",
            "date_published": "2025-08-31T13:40:01.000Z",
            "content_html": "<h3 id=\"nginx-tcp四层负载均衡\"><a class=\"anchor\" href=\"#nginx-tcp四层负载均衡\">#</a> Nginx TCP 四层负载均衡</h3>\n<h4 id=\"1四层负载均衡基本概述\"><a class=\"anchor\" href=\"#1四层负载均衡基本概述\">#</a> 1. 四层负载均衡基本概述</h4>\n<h5 id=\"11-什么是四层负载均衡\"><a class=\"anchor\" href=\"#11-什么是四层负载均衡\">#</a> 1.1 什么是四层负载均衡</h5>\n<p>所谓四层就是基于 * IP+* 端口的负载均衡，它通过用户请求的端口来决定将请求转发至哪台后端服务器。</p>\n<p>就是通过三层的<em> IP</em> 地址并加上四层的端口号，来决定哪些流量需要做负载均衡。对需要负载均衡的流量进行<em> NAT</em> 转换，然后转发至后端服务器节点，并记录这个<em> TCP</em> 或者<em> UDP</em> 的流量是由哪台后端服务器处理的，后续这个连接的所有流量都同样转发到同一台服务器处理。</p>\n<h5 id=\"12-四层负载均衡应用场景\"><a class=\"anchor\" href=\"#12-四层负载均衡应用场景\">#</a> <strong>1.2</strong> <strong>四层负载均衡应用场景</strong></h5>\n<p>1. 场景一、端口代理</p>\n<p>首先<em> http</em> 当然是最常用的一种协议，但是还是有很多非<em> http</em> 的应用（<em>mysql</em>、<em>redis</em>、<em>ssh</em>），只能用四层代理</p>\n<p>2.<em> 场景二、四层负载均衡</em> +* 七层负载均衡，实现大规模集群架构。</p>\n<p>其次七层代理需要<em> CPU</em> 运算，所以单台机器很难做到很高的处理能力，因此需要在七层负载均衡前面再加四层负载均衡。（提高网站的访问效率，并保证了七层负载均衡的高可用性。）</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/j1fG1db.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"13-四层负载均衡优缺点\"><a class=\"anchor\" href=\"#13-四层负载均衡优缺点\">#</a> <strong>1.3</strong> <strong>四层负载均衡优缺点</strong></h5>\n<ul>\n<li>1. 四层负载均衡通常用来转发非 http 应用：如 tcp/80tcp/443 tcp/3306 tcp/22 udp/53</li>\n<li>2. 四层负载均衡可以解决七层负载均衡高可用性的问题。(多个七层负载均衡同时提供服务)</li>\n<li>3. 四层负载均衡可以解决七层负载均衡端口数限制问题。（七层负载均衡最多能使用的端口是 5w）</li>\n<li>4. 四层转发效率远比七层代理的效率高的多，但是他只能支持 tcp/ip 协议，所以他的功能较弱，虽然七层效率不高，但他支持 http/https 这样的应用层协议。</li>\n</ul>\n<h4 id=\"2四层负载均衡场景实践\"><a class=\"anchor\" href=\"#2四层负载均衡场景实践\">#</a> 2. 四层负载均衡场景实践</h4>\n<h5 id=\"21-配置语法示例\"><a class=\"anchor\" href=\"#21-配置语法示例\">#</a> <strong>2.1</strong> <strong>配置语法示例</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>stream <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tupstream backend <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t<span class=\"token builtin class-name\">hash</span> <span class=\"token variable\">$remote_addr</span> consistent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\tserver backend1.example.com:12345 <span class=\"token assign-left variable\">weight</span><span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tserver <span class=\"token number\">127.0</span>.0.1:12345 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>30s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tserver unix:/tmp/backend3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tlisten <span class=\"token number\">12345</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tproxy_connect_timeout 1s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tproxy_timeout 3s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass backend<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"22-实现http协议负载均衡\"><a class=\"anchor\" href=\"#22-实现http协议负载均衡\">#</a> <strong>2.2</strong> <strong>实现</strong> HTTP 协议负载均衡</h5>\n<p>前端四层负载均衡 + 后端七层负载均衡 + 应用节点</p>\n<p>1. 配置 nginx 四层负载均衡</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/nginx/nginx.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 在 events 层下面，http 层上面配置 include</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>events <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>include /etc/nginx/conf.c/*.conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#1. 配置四层负载均衡</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.c<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -f /etc/nginx/conf.d/default.conf #删除 http 的 80 端口</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /etc/nginx/conf.c</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/nginx/conf.c</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.c<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_lb.conf</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>stream <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tupstream lb <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tserver <span class=\"token number\">172.16</span>.1.5:80 <span class=\"token assign-left variable\">weight</span><span class=\"token operator\">=</span><span class=\"token number\">5</span> <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>30s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tserver <span class=\"token number\">172.16</span>.1.6:80 <span class=\"token assign-left variable\">weight</span><span class=\"token operator\">=</span><span class=\"token number\">5</span> <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>30s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tserver <span class=\"token number\">172.16</span>.1.7:80 <span class=\"token assign-left variable\">weight</span><span class=\"token operator\">=</span><span class=\"token number\">5</span> <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>30s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tproxy_connect_timeout 3s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tproxy_timeout 3s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tproxy_pass lb<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#2. 配置七层负载均衡</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>upstream www <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    server  <span class=\"token number\">172.16</span>.1.10:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    server \t<span class=\"token number\">172.16</span>.1.11:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    server \t<span class=\"token number\">172.16</span>.1.12:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>upstream blog <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    server <span class=\"token number\">172.16</span>.1.13:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    server <span class=\"token number\">172.16</span>.1.14:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    server <span class=\"token number\">172.16</span>.1.15:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>upstream bbs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    server <span class=\"token number\">172.16</span>.1.16:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    server <span class=\"token number\">172.16</span>.1.17:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    server <span class=\"token number\">172.16</span>.1.18:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    server_name www.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        proxy_pass http://www<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        include proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    server_name blog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        proxy_pass http://blog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        include proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    server_name bbs.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        proxy_pass http://bbs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        include proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.c<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params </span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token comment\">#当其中一台返回错误 500,502,503,504 时，分配下一台服务器程序处理，提高平台访问成功率</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>proxy_next_upstream error <span class=\"token function\">timeout</span> http_500 http_502 http_503 http_504<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>proxy_next_upstream_tries <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>proxy_next_upstream_timeout 3s<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h5 id=\"23-实现mysql负载均衡\"><a class=\"anchor\" href=\"#23-实现mysql负载均衡\">#</a> 2.3 实现 MySQL 负载均衡</h5>\n<p>请求负载均衡 5555 ---&gt; 172.16.1.7:22</p>\n<p>请求负载均衡 6666 ---&gt; 172.16.1.51:3306</p>\n<p><em>1. Nginx</em> 四层负载均衡配置如下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /etc/nginx/conf.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/nginx/nginx.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 在 events 层下面，http 层上面配置 include</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>include /etc/nginx/conf.c/*.conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 配置 Nginx 四层转发</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.c<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_stream.conf</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>stream <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">#1. 定义转发 tcp/22 端口的虚拟资源池</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tupstream <span class=\"token function\">ssh</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tserver <span class=\"token number\">192.168</span>.40.7:22<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">#2. 定义转发 tcp/3306 端口的虚拟资源池</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tupstream mysql <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tserver <span class=\"token number\">192.168</span>.40.51:3306<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">#调用虚拟资源池</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tlisten <span class=\"token number\">5555</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tproxy_connect_timeout 1s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tproxy_timeout 300s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tproxy_pass <span class=\"token function\">ssh</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tlisten <span class=\"token number\">6666</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tproxy_connect_timeout 1s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tproxy_timeout 300s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tproxy_pass mysql<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.c<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.c<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure>",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1868764668.html",
            "url": "http://ixuyong.cn/posts/1868764668.html",
            "title": "Nginx负载均衡基于uri调度场景（七）",
            "date_published": "2025-08-31T06:45:17.000Z",
            "content_html": "<h3 id=\"nginx负载均衡基于uri调度场景\"><a class=\"anchor\" href=\"#nginx负载均衡基于uri调度场景\">#</a> Nginx 负载均衡基于 uri 调度场景</h3>\n<h4 id=\"1-nginx负载均衡调度场景\"><a class=\"anchor\" href=\"#1-nginx负载均衡调度场景\">#</a> 1. Nginx 负载均衡调度场景</h4>\n<h5 id=\"11-根据uri进行调度路由\"><a class=\"anchor\" href=\"#11-根据uri进行调度路由\">#</a> 1.1 根据 uri 进行调度 (路由)</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iKnDFqy.jpeg\" alt=\"1.jpg\" /></p>\n<h6 id=\"111-环境准备\"><a class=\"anchor\" href=\"#111-环境准备\">#</a> 1.1.1 环境准备</h6>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">系统版本</th>\n<th style=\"text-align:center\">主机角色</th>\n<th style=\"text-align:center\">外网 IP</th>\n<th style=\"text-align:center\">内网 IP</th>\n<th style=\"text-align:center\">端口</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">负载均衡</td>\n<td style=\"text-align:center\">10.0.0.5</td>\n<td style=\"text-align:center\">172.16.1.5</td>\n<td style=\"text-align:center\">80</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">提供 /user 集群</td>\n<td style=\"text-align:center\">10.0.0.7</td>\n<td style=\"text-align:center\">172.16.1.7</td>\n<td style=\"text-align:center\">80</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">提供 /pass 集群</td>\n<td style=\"text-align:center\">10.0.0.8</td>\n<td style=\"text-align:center\">172.16.1.8</td>\n<td style=\"text-align:center\">80</td>\n</tr>\n</tbody>\n</table>\n<h6 id=\"112-配置应用节点\"><a class=\"anchor\" href=\"#112-配置应用节点\">#</a> 1.1.2 配置应用节点</h6>\n<p>1、web01 配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat uri.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">8081</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name uri.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code/user1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlisten <span class=\"token number\">8082</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tserver_name uri.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\troot /code/user2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/user1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/user2</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"user-8081\" >  /code/user1/index.html</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"user-8082\" >  /code/user2/index.html</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p>2、web02 配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat uri.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">8081</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name uri.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code/pass1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlisten <span class=\"token number\">8082</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tserver_name uri.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\troot /code/pass2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/pass1 -p</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/pass2 -p</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"pass-8081\" >  /code/pass1/index.html</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"pass-8082\" >  /code/pass2/index.html</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"113-配置负载均衡\"><a class=\"anchor\" href=\"#113-配置负载均衡\">#</a> 1.1.3 配置负载均衡</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 根据不同的 URL 请求调度到不同的资源池</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat uri.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream user <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8081<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8082<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>upstream pass <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8081<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8082<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tserver_name uri.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tlocation /user <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tproxy_pass http://user/<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tlocation /pass <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tproxy_pass http://pass/<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"12-proxy添加与不添加\"><a class=\"anchor\" href=\"#12-proxy添加与不添加\">#</a> 1.2 Proxy 添加 / 与不添加 /</h5>\n<p>在使用 proxy_pass 反向代理时，最后结尾添加 / 和不添加 / 有什么区别？</p>\n<p>proxy_pass <a href=\"http://localhost:8080\">http://localhost:8080</a>;</p>\n<p>proxy_pass <a href=\"http://localhost:8080/;\">http://localhost:8080/;</a></p>\n<h6 id=\"121-不添加示例\"><a class=\"anchor\" href=\"#121-不添加示例\">#</a> 1.2.1 不添加 / 示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver_name uri.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlocation /user <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tproxy_pass http://172.16.1.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#用户请求 URL： /user/test/index.html</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#请求到达 Nginx 负载均衡： /user/test/index.html</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#Nginx 负载均衡到后端节点： /user/test/index.html</span></pre></td></tr></table></figure><h6 id=\"122-添加示例\"><a class=\"anchor\" href=\"#122-添加示例\">#</a> 1.2.2 添加 / 示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver_name uri.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlocation /user <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tproxy_pass http://172.16.1.7:80/<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#用户请求 URL： /user/test/index.html</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#请求到达 Nginx 负载均衡： /user/test/index.html</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#Nginx 负载均衡到后端节点： /test/index.html</span></pre></td></tr></table></figure><h6 id=\"123-结果总结\"><a class=\"anchor\" href=\"#123-结果总结\">#</a> 1.2.3 结果总结</h6>\n<ul>\n<li>1. 带 / 意味着 Nginx 代理会修改用户请求的 URL，将 location 匹配的 URL 进行删除。</li>\n<li>2. 不带 / 意味着 Nginx 代理不会修改用户请求的 URL，而是直接代理到后端应用服务器。</li>\n</ul>\n<h5 id=\"13-根据请求设备进行调度\"><a class=\"anchor\" href=\"#13-根据请求设备进行调度\">#</a> 1.3 根据请求设备进行调度</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/u9aCgsk.jpeg\" alt=\"1.jpg\" /></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">系统版本</th>\n<th style=\"text-align:center\">主机角色</th>\n<th style=\"text-align:center\">外网 IP</th>\n<th style=\"text-align:center\">内网 IP</th>\n<th style=\"text-align:center\">端口</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">负载均衡</td>\n<td style=\"text-align:center\">10.0.0.5</td>\n<td style=\"text-align:center\">172.16.1.5</td>\n<td style=\"text-align:center\">80</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">提供 /user 集群</td>\n<td style=\"text-align:center\">10.0.0.7</td>\n<td style=\"text-align:center\">172.16.1.7</td>\n<td style=\"text-align:center\">80</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CentOS7</td>\n<td style=\"text-align:center\">提供 /pass 集群</td>\n<td style=\"text-align:center\">10.0.0.8</td>\n<td style=\"text-align:center\">172.16.1.8</td>\n<td style=\"text-align:center\">80</td>\n</tr>\n</tbody>\n</table>\n<h6 id=\"131-配置应用节点\"><a class=\"anchor\" href=\"#131-配置应用节点\">#</a> 1.3.1 配置应用节点</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置后端 WEB 节点的 Nginx 配置。（注意 pc 和 phone 准备的站点内容不一样）</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#1.PC 端配置</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/agent.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tserver_name agent.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\troot /code/pc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/pc -p</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"PC...\" > /code/pc/index.html</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#2. 手机端配置</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/agent.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tserver_name agent.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\troot /code/phone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/phone</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"phone\" > /code/phone/index.html</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"133-配置负载均衡\"><a class=\"anchor\" href=\"#133-配置负载均衡\">#</a> 1.3.3 配置负载均衡</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_agent.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream pc <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>upstream phone <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tserver_name agent.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token comment\">#如果 agent 为手机则匹配</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"iphone|android|ipad\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\tproxy_pass http://phone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token comment\">#如果浏览器为 IE 则下载火狐浏览器</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"MSIE|Trident\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token comment\">#return 403;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token comment\">#return 200 'Please Change Browser...';\t\t\t</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> <span class=\"token string\">'https://download-ssl.firefox.com.cn/releases-sha2/stub/official/zh-CN/Firefox-latest.exe'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token comment\">#如果以上都没有匹配，则匹配 pc</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tproxy_pass http://pc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"2-nginx多级代理获取真实ip\"><a class=\"anchor\" href=\"#2-nginx多级代理获取真实ip\">#</a> 2. Nginx 多级代理获取真实 IP</h4>\n<h5 id=\"21-多级代理获取地址概述\"><a class=\"anchor\" href=\"#21-多级代理获取地址概述\">#</a> 2.1 多级代理获取地址概述</h5>\n<p>用户发起请求，沿途可能会经过多级代理，最终抵达应用节点，那应用节点如何获取客户端真实 IP 地址</p>\n<ul>\n<li>实现方式 1：通过 X-Forwarded-For 透传客户端的真实 IP</li>\n<li>实现方式 2：使用 Nginx RealIP 模块实现客户端地址透传</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Wz9mh1k.jpeg\" alt=\"2.jpg\" /></p>\n<h5 id=\"22-多级代理获取地址实践\"><a class=\"anchor\" href=\"#22-多级代理获取地址实践\">#</a> 2.2 多级代理获取地址实践</h5>\n<h6 id=\"221-环境准备\"><a class=\"anchor\" href=\"#221-环境准备\">#</a> 2.2.1 环境准备</h6>\n<p>1. 基于代理 *(<em>七层负载均衡</em>)* 情况下环境</p>\n<p>192.168.40.150 proxy_node1 一级代理</p>\n<p>192.168.40.7 二级代理</p>\n<p>192.168.40.8 真实节点</p>\n<h6 id=\"222-配置一级代理\"><a class=\"anchor\" href=\"#222-配置一级代理\">#</a> 2.2.2 配置一级代理</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_ip.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name ip.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tproxy_pass http://192.168.40.7<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tproxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tproxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tproxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tproxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"223-配置二级代理\"><a class=\"anchor\" href=\"#223-配置二级代理\">#</a> 2.2.3 配置二级代理</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_ip.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name ip.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tproxy_pass http://192.168.40.8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tproxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tproxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tproxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tproxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"224-配置应用节点\"><a class=\"anchor\" href=\"#224-配置应用节点\">#</a> 2.2.4 配置应用节点</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ip.hmallleasig.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name ip.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tfastcgi_pass <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tfastcgi_param SCRIPT_FILENAME <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"23-多级代理获取地址测试\"><a class=\"anchor\" href=\"#23-多级代理获取地址测试\">#</a> 2.3 多级代理获取地址测试</h5>\n<h6 id=\"231-通过php脚本分析\"><a class=\"anchor\" href=\"#231-通过php脚本分析\">#</a> 2.3.1 通过 php 脚本分析</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 通过如下页面获取真实 IP，或查看 phpinfo () 函数中的 HTTP_X_FORWARDED_FOR</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/index.php</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span>?php</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tphpinfo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>?<span class=\"token operator\">></span></pre></td></tr></table></figure><h6 id=\"232-通过日志分析\"><a class=\"anchor\" href=\"#232-通过日志分析\">#</a> 2.3.2 通过日志分析</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.proxy_node1 代理的日志</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">192.168</span>.40.1 - - <span class=\"token punctuation\">[</span><span class=\"token number\">31</span>/Aug/2025:17:18:16 +0800<span class=\"token punctuation\">]</span> <span class=\"token string\">\"GET / HTTP/1.1\"</span> <span class=\"token number\">200</span> <span class=\"token number\">95487</span> <span class=\"token string\">\"-\"</span> <span class=\"token string\">\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36\"</span> <span class=\"token string\">\"-\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2.proxy_node2 代理的日志</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.40.150 - - <span class=\"token punctuation\">[</span><span class=\"token number\">31</span>/Aug/2025:17:18:16 +0800<span class=\"token punctuation\">]</span> <span class=\"token string\">\"GET / HTTP/1.1\"</span> <span class=\"token number\">200</span> <span class=\"token number\">95463</span> <span class=\"token string\">\"-\"</span> <span class=\"token string\">\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36\"</span> <span class=\"token string\">\"192.168.40.1\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3. 真实节点</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">192.168</span>.40.7 - - <span class=\"token punctuation\">[</span><span class=\"token number\">31</span>/Aug/2025:17:18:16 +0800<span class=\"token punctuation\">]</span> <span class=\"token string\">\"GET / HTTP/1.1\"</span> <span class=\"token number\">200</span> <span class=\"token number\">95458</span> <span class=\"token string\">\"-\"</span> <span class=\"token string\">\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36\"</span> <span class=\"token string\">\"192.168.40.1, 192.168.40.150\"</span></pre></td></tr></table></figure><h6 id=\"233-通过抓包分析\"><a class=\"anchor\" href=\"#233-通过抓包分析\">#</a> 2.3.3 通过抓包分析</h6>\n<p>通过抓包分析 X-Forwarded-For 记录所有代理的客户端真实 IP，而 X-Real-IP 只记录上级代理的 IP</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/D5M8u9S.jpeg\" alt=\"3.jpg\" /></p>\n<h5 id=\"24-realip模块获取真实ip\"><a class=\"anchor\" href=\"#24-realip模块获取真实ip\">#</a> 2.4 RealiP 模块获取真实 IP</h5>\n<p>使用 nginx Realip_module 获取多级代理下的客户端真实 IP 地址，在后端 Web 节点上添加如下配置即可（Realip 需要知道所有沿途经过的代理节点的 IP 地址或 IP 段）；</p>\n<h6 id=\"241-配置示例\"><a class=\"anchor\" href=\"#241-配置示例\">#</a> 2.4.1 配置示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ip.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name ip.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tset_real_ip_from <span class=\"token number\">192.168</span>.40.150<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tset_real_ip_from <span class=\"token number\">192.168</span>.40.7<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\treal_ip_header X-Forwarded-For<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\treal_ip_recursive on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">#set_real_ip_from：真实服务器上一级代理的 IP 地址或者 IP 段，可以写多行</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">#real_ip_header：从哪个 header 头检索出需要的 IP 地址</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">#real_ip_recursive：递归排除 set_real_ip_from 里面出现的 IP, 其余没有出现的认为是用户真实 IP</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tfastcgi_pass <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tfastcgi_param SCRIPT_FILENAME <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tinclude fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"242-结果验证\"><a class=\"anchor\" href=\"#242-结果验证\">#</a> 2.4.2 结果验证</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">192.168</span>.40.1 - - <span class=\"token punctuation\">[</span><span class=\"token number\">31</span>/Aug/2025:17:34:16 +0800<span class=\"token punctuation\">]</span> <span class=\"token string\">\"GET / HTTP/1.1\"</span> <span class=\"token number\">200</span> <span class=\"token number\">95487</span> <span class=\"token string\">\"-\"</span> <span class=\"token string\">\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36\"</span> <span class=\"token string\">\"192.168.40.1, 192.168.40.150\"</span></pre></td></tr></table></figure>",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2322410227.html",
            "url": "http://ixuyong.cn/posts/2322410227.html",
            "title": "Nginx负载均衡会话共享（六）",
            "date_published": "2025-08-30T13:25:28.000Z",
            "content_html": "<h3 id=\"nginx负载均衡会话共享\"><a class=\"anchor\" href=\"#nginx负载均衡会话共享\">#</a> Nginx 负载均衡会话共享</h3>\n<h4 id=\"1-什么是会话保持\"><a class=\"anchor\" href=\"#1-什么是会话保持\">#</a> 1. 什么是会话保持</h4>\n<p>当用户登陆一个网站服务器，网站服务器会将用户的登陆信息存储下来（存储下来的内容叫 Session ）以保证</p>\n<p>我们能够一直处于 ” 登陆在线 “ 状态。</p>\n<ul>\n<li>客户端：cookies</li>\n<li>服务端：sessionID</li>\n</ul>\n<h4 id=\"2-为什么需要会话保持\"><a class=\"anchor\" href=\"#2-为什么需要会话保持\">#</a> 2. 为什么需要会话保持</h4>\n<p>由于我们使用的是负载均衡轮询机制，会导致用户请求分散在不同的节点，从而造成会话无法保持。假设用户 A，通过负载均衡登陆了网站，此时会话信息存储在 A 节点，那么当它一刷新，负载均衡会将请求分发给 B 节点，那么 B 节点没有用户 A 的登陆信息，就会提示用户 A 登陆，当 A 用户点击登陆时又会将请求分发给 C 节点，从而造成用户 A 无法实现会话保持。</p>\n<h4 id=\"3-如何实现会话保持\"><a class=\"anchor\" href=\"#3-如何实现会话保持\">#</a> 3. 如何实现会话保持</h4>\n<ul>\n<li>1. 粘性 session (演示)：指 Ngnix 每次都将同一用户的所有请求转发至同一台服务器上，及 Nginx 的 IP_hash。</li>\n<li>2.session 复制（不用）：每次 session 发生变化，就广播给集群中的服务器，使所有的服务器上的 session 相同。</li>\n<li>3.session 共享（√）：缓存 session 至内存数据库中，使用 redis，memcached 实现。</li>\n<li>4.session 持久化：将 session 存储至数据库中，像操作数据一样操作 session。</li>\n</ul>\n<h4 id=\"4-会话保持场景演示\"><a class=\"anchor\" href=\"#4-会话保持场景演示\">#</a> 4. 会话保持场景演示</h4>\n<p>session 共享实现过程：</p>\n<ul>\n<li>1. 用户第一次发起 HTTP 请求，默认不会携带 Cookies 信息；</li>\n<li>2. 服务器接收到请求后，发现没有 Cookies 信息，认为是第一次请求，所以会生成一个随机 SessionID，存储在 Redis 中，然后通过 Set-Cookies 的 Header 中下发给客户端；</li>\n<li>3. 客户端拿着 SessionID+User+Password 提交给负载均衡，负载均衡调度至 web02 节点；</li>\n<li>4.web02 节点查询 Redis 中是否存在该 SessionID，如果存在，则验证用户名和密码，如果成功，则将 Redis 中的 SessionID 初始化已登录状态；</li>\n</ul>\n<h5 id=\"41-配置web节点\"><a class=\"anchor\" href=\"#41-配置web节点\">#</a> 4.1 配置 web 节点</h5>\n<p>1. 首先安装并配置 phpmyadmin</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /code</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://files.phpmyadmin.net/phpMyAdmin/4.8.4/phpMyAdmin-4.8.4-all-languages.zip</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip phpMyAdmin-4.8.4-all-languages.zip</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /code/phpMyAdmin-4.8.4-all-languages /code/phpmyadmin</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 phpmyadmin<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /var/lib/php/session</span></pre></td></tr></table></figure><p>2. 修改 phpmyadmin 连接远程的数据库</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd phpmyadmin/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 phpmyadmin<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp config.sample.inc.php config.inc.php</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 phpmyadmin<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim config.inc.php</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/* Server parameters */</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token variable\">$cfg</span><span class=\"token punctuation\">[</span><span class=\"token string\">'Servers'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'host'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'192.168.40.51'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>3. 在多台 web 上准备 phpmyadmin 的 nginx 配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 phpmyadmin<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/phpmyadmin.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name phpmyadmin.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code/phpmyadmin<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tfastcgi_pass <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tfastcgi_param SCRIPT_FILENAME <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#重启 Nginx 服务</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 phpmyadmin<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 phpmyadmin<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h5 id=\"42-配置负载均衡\"><a class=\"anchor\" href=\"#42-配置负载均衡\">#</a> 4.2 配置负载均衡</h5>\n<p>1. 编写一份 proxy 负载均衡的配置文件，将请求调度到后端 web 节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat phpmyadmin.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream phpmyadmin <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name phpmyadmin.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tproxy_pass http://phpmyadmin<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>2. 检查语法并重载 nginx</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h5 id=\"43-配置redis服\"><a class=\"anchor\" href=\"#43-配置redis服\">#</a> 4.3 配置 Redis 服</h5>\n<p>1. 安装 redis 内存数据库</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install redis -y</span></pre></td></tr></table></figure><p>2. 配置 redis 监听在本地的内网网卡上</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^bind/c bind 127.0.0.1 192.168.40.41' /etc/redis.conf</span></pre></td></tr></table></figure><p>3. 启动 redis</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start redis &amp;&amp; systemctl enable redis</span></pre></td></tr></table></figure><h5 id=\"44-配置php连接redis\"><a class=\"anchor\" href=\"#44-配置php连接redis\">#</a> 4.4 配置 php 连接 Redis</h5>\n<p>1. 修改 /etc/php.ini 文件。[所有节点都需要操作]</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.php 已经引用 redis 的扩展模块</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/php.d/redis.ini </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">;</span> Enable redis extension module</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>extension <span class=\"token operator\">=</span> redis.so</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">;</span> phpredis can be used to store PHP sessions. </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">;</span> To <span class=\"token keyword\">do</span> this, uncomment and configure below</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">;</span>session.save_handler <span class=\"token operator\">=</span> redis</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">;</span>session.save_path <span class=\"token operator\">=</span> <span class=\"token string\">\"tcp://host1:6379?weight=1, tcp://host2:6379?weight=2&amp;timeout=2.5, tcp://host3:6379?weight=2\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#2.php 连接 redis</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/php.ini</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">;</span>session.save_handler <span class=\"token operator\">=</span> files</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>session.save_handler <span class=\"token operator\">=</span> redis</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>session.save_path <span class=\"token operator\">=</span> <span class=\"token string\">\"tcp://192.168.40.41:6379\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">;</span>session.save_path <span class=\"token operator\">=</span> <span class=\"token string\">\"tcp://192.168.40.41:6379?auth=123456\"</span> <span class=\"token comment\">#如果 redis 存在密码，则使用该方式</span></pre></td></tr></table></figure><p>2. 注释 php-fpm.d/www.conf 里面的两条内容，否则 session 内容会一直写入 /var/lib/php/session 目录中，从而造成会话共享失败。[所有节点都需要操作]</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">;</span>php_value<span class=\"token punctuation\">[</span>session.save_handler<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> files</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">;</span>php_value<span class=\"token punctuation\">[</span>session.save_path<span class=\"token punctuation\">]</span>    <span class=\"token operator\">=</span> /var/lib/php/session</pre></td></tr></table></figure><p>3. 重启 php-fpm 服务。[所有节点都需要操作]</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 phpmyadmin<span class=\"token punctuation\">]</span><span class=\"token comment\"># php-fpm -t</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 phpmyadmin<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart php-fpm</span></pre></td></tr></table></figure><h5 id=\"45-测试集群会话共享\"><a class=\"anchor\" href=\"#45-测试集群会话共享\">#</a> 4.5 测试集群会话共享</h5>\n<p>1. 使用浏览器登陆网站，获取对应的 cookie 信息</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/A5FBBT4.jpeg\" alt=\"1.jpg\" /></p>\n<p>2. 检查 redis 中是否存在 cookie 对应的 session 信息</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"PHPREDIS_SESSION:33ed378672b5b53f491d6e409d44032f\"</span></pre></td></tr></table></figure>",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1979768636.html",
            "url": "http://ixuyong.cn/posts/1979768636.html",
            "title": "Nginx代理-负载均衡实践（五）",
            "date_published": "2025-08-28T13:53:24.000Z",
            "content_html": "<h3 id=\"nginx代理-负载均衡实践\"><a class=\"anchor\" href=\"#nginx代理-负载均衡实践\">#</a> Nginx 代理 - 负载均衡实践</h3>\n<h4 id=\"1nginx负载均衡基本概述\"><a class=\"anchor\" href=\"#1nginx负载均衡基本概述\">#</a> 1.Nginx 负载均衡基本概述</h4>\n<h5 id=\"11-什么是负载均衡\"><a class=\"anchor\" href=\"#11-什么是负载均衡\">#</a> 1.1 什么是负载均衡</h5>\n<p>负载均衡 Load Balance，指的是将用户访问请求所产生的流量，进行平衡，分摊到多个应用节点处理。负载均衡扩展了应用的服务能力，增强了应用的可用性。</p>\n<h5 id=\"12-为什么需要负载均\"><a class=\"anchor\" href=\"#12-为什么需要负载均\">#</a> 1.2 为什么需要负载均</h5>\n<p>当我们的 Web 服务器直接面向用户，往往要承载大量并发请求，单台服务器难以负荷，我使用多台 WEB 服务器组成集群，前端使用 Nginx 负载均衡，将请求分散的打到我们的后端服务器集群中，实现负载的流量分发。从而提升整体性能、以及系统的容灾能力。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/m4Q9T8O.png\" alt=\"1.png\" /></p>\n<h5 id=\"13-负载均衡与代理区别\"><a class=\"anchor\" href=\"#13-负载均衡与代理区别\">#</a> 1.3 负载均衡与代理区别</h5>\n<p>Nginx 负载均衡与 Nginx 反向代理不同地方在于：</p>\n<ul>\n<li>Nginx 代理仅代理一台服务器基于 URI 来调度，调度到不同功能的应用节点处理。</li>\n<li>Nginx 负载均衡则是将客户端请求通过 proxy_pass 代理至一组 upstream 资源池。</li>\n</ul>\n<h4 id=\"2nginx-负载均衡应用场景\"><a class=\"anchor\" href=\"#2nginx-负载均衡应用场景\">#</a> 2.Nginx 负载均衡应用场景</h4>\n<h5 id=\"21-四层负载均衡\"><a class=\"anchor\" href=\"#21-四层负载均衡\">#</a> 2.1 四层负载均衡</h5>\n<p>四层负载均衡指的是 OSI 七层模型中的传输层，四层仅需要对客户端的请求进行 TCP/IP 协议的包代理就可以实</p>\n<p>现负载均衡。IP+Port</p>\n<p>四层负载均衡的性能极好、因为只需要底层进行转发处理，而不需要进行一些复杂的逻辑。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/kYs0geZ.png\" alt=\"2.png\" /></p>\n<h5 id=\"22-七层负载均衡\"><a class=\"anchor\" href=\"#22-七层负载均衡\">#</a> 2.2 七层负载均衡</h5>\n<p>七层负载均衡工作在应用层，它可以完成很多应用方面的协议请求，比如我们说的 http 应用负载均衡，它可以实现 http 头信息的改写、安全应用规则控制、URI 匹配规则控制、及 rewrite 等功能，所以在应用层里面可以做的内容就更多了。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/TrNv8V2.png\" alt=\"3.png\" /></p>\n<h5 id=\"23-四层与七层区别\"><a class=\"anchor\" href=\"#23-四层与七层区别\">#</a> 2.3 四层与七层区别</h5>\n<p>四层负载均衡：传输层</p>\n<ul>\n<li>优点：性能高，数据包在底层就进行了转发</li>\n<li>缺点：仅支持 ip:prot 转发，无法完成复杂的业务逻辑应用。</li>\n<li>MySQL TCP 3306， Redis、SSH、等；</li>\n</ul>\n<p>七层负载均衡：应用层</p>\n<ul>\n<li>优点：贴近业务，支持 URI 路径匹配、Header 改写、Rewrite 等</li>\n<li>缺点：性能低，数据包需要拆解到顶层才进行调度，消耗随机端口；</li>\n</ul>\n<h4 id=\"3nginx负载均衡配置场景\"><a class=\"anchor\" href=\"#3nginx负载均衡配置场景\">#</a> 3.Nginx 负载均衡配置场景</h4>\n<h5 id=\"31-负载均衡场景环境规划\"><a class=\"anchor\" href=\"#31-负载均衡场景环境规划\">#</a> 3.1 负载均衡场景环境规划</h5>\n<p>负载均衡场景架构图规划：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/wy35sJ9.png\" alt=\"4.png\" /></p>\n<p>负载均衡场景地址规划:</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>角色</strong></th>\n<th style=\"text-align:center\">外网 IP (NAT)</th>\n<th style=\"text-align:center\"><strong>内网</strong> IP (LAN)</th>\n<th style=\"text-align:center\"><strong>主机名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">lb01</td>\n<td style=\"text-align:center\">eth0:10.0.0.5</td>\n<td style=\"text-align:center\">eth1:172.16.1.5</td>\n<td style=\"text-align:center\">lb01</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">eth0:10.0.0.7</td>\n<td style=\"text-align:center\">eth1:172.16.1.7</td>\n<td style=\"text-align:center\">web01</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">eth0:10.0.0.8</td>\n<td style=\"text-align:center\">eth1:172.16.1.8</td>\n<td style=\"text-align:center\">web02</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"32-后端web节点配置实例\"><a class=\"anchor\" href=\"#32-后端web节点配置实例\">#</a> 3.2 后端 Web 节点配置实例</h5>\n<p>1.Web01 服务器上配置为应用服务节点，创建对应 html 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/web.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code/web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/web</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"Web01...\" > /code/web/index.html</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><p>2.Web02 服务器上配置为应用服务节点，创建对应 html 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/web.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code/web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/web</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"Web02...\" > /code/web/index.html</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h5 id=\"33-前端接入nginx负载均衡\"><a class=\"anchor\" href=\"#33-前端接入nginx负载均衡\">#</a> 3.3. 前端接入 Nginx 负载均衡</h5>\n<p>1. 将 lb01 配置为负载均衡，将所有请求代理至虚拟资源池</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">172.16</span>.1.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><p>2. 准备 Nginx 负载均衡需要使用的 proxy_params 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h5 id=\"34-浏览器访问测试负载效果\"><a class=\"anchor\" href=\"#34-浏览器访问测试负载效果\">#</a> 3.4. 浏览器访问测试负载效果</h5>\n<p>使用浏览器访问 <a href=\"http://web.oldxu.com\">web.oldxu.com</a>，然后进行刷新测试。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/xuwt4mO.jpeg\" alt=\"1.jpg\" /></p>\n<h4 id=\"4nginx负载均衡调度算法\"><a class=\"anchor\" href=\"#4nginx负载均衡调度算法\">#</a> 4.Nginx 负载均衡调度算法</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>调度算法</strong></th>\n<th style=\"text-align:center\"><strong>概述</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">轮询</td>\n<td style=\"text-align:center\">按时间顺序逐一分配到不同的后端服务器 (默认)</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">weight</td>\n<td style=\"text-align:center\">加权轮询，weight 值越大，分配到的访问几率越高</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">ip_hash</td>\n<td style=\"text-align:center\">每个请求按访问 IP 的 hash 结果分配，这样来自同一 IP 的固定访问一个后端服务器</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">url_hash</td>\n<td style=\"text-align:center\">根据请求 uri 进行调度到指定节点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">least_conn</td>\n<td style=\"text-align:center\">将请求传递到活动连接数最少的服务器。</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"41-轮询调度算法\"><a class=\"anchor\" href=\"#41-轮询调度算法\">#</a> 4.1 轮询调度算法</h5>\n<p>轮询调度算法的原理是将每一次用户的请求，轮流分配给内部中的服务器。</p>\n<p>轮询算法的优点是其简洁性，它无需记录当前所有连接的状态，所以它是一种无状态调度。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"42-加权轮询调度算法\"><a class=\"anchor\" href=\"#42-加权轮询调度算法\">#</a> 4.2 加权轮询调度算法</h5>\n<p>轮询调度算法没有考虑每台服务器的处理能力，在实际情况中，由于每台服务器的配置、安装的业务应用等不同，其处理能力会不一样。所以，我们根据服务器的不同处理能力，给每个服务器分配不同的权值，使其能够接受相应权值数的服务请求。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80 <span class=\"token assign-left variable\">weight</span><span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80 <span class=\"token assign-left variable\">weight</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"43-ip_hash调度算法\"><a class=\"anchor\" href=\"#43-ip_hash调度算法\">#</a> 4.3 ip_hash 调度算法</h5>\n<p>ip_hash 是基于用户请求的 IP，对该 IP 进行 hash 运算，根据 hash 运算的值，将请求分配到后端特定的一台节点进行处理。ip_hash 算法实现公式：hash (ip) % node_counts = index</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/GwQU27w.jpeg\" alt=\"2.jpg\" /></p>\n<p>如何配置 ip_hash 调度算法：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tip_hash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ip_hash 调度算法会带来两个问题:</p>\n<ul>\n<li>1. 如果有大量来自于同一 IP 的请求会造成某个后端节点流量过大，而其他节点无流量</li>\n<li>2. 如果临时下线一台节点，会出现重新计算 hash 值，官方建议将下线节点标记为 down 状态，以保留客户端 IP 地址的当前哈希值。（如下图所示：）</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/xarGiUJ.jpeg\" alt=\"3.jpg\" /></p>\n<p>如果有大量的用户调度到某一节点，而该节点刚好故障，则该算法会重新计算结果，从而造成大量的用户被转移其他节点处理，而需要重新建立会话。</p>\n<h5 id=\"44-一致性hash调度算\"><a class=\"anchor\" href=\"#44-一致性hash调度算\">#</a> 4.4 一致性 hash 调度算</h5>\n<p>为了规避上述 hash 情况，一致性 hash 算法就诞生，一致性 Hash 算法也是使用取模的方法，但不是对服务器节点数量进行取模，而是对 2 的 32 方取模。即，一致性 Hash 算法将整个 Hash 空间组织成一个虚拟的圆环，Hash 函数值的空间为 0 ~ 2^32 - 1，整个哈希环如下：</p>\n<p><a href=\"https://www.jianshu.com/p/528ce5cd7e8f\">https://www.jianshu.com/p/528ce5cd7e8f</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token builtin class-name\">hash</span> <span class=\"token variable\">$remote_addr</span> consistent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"45-url_hash调度算法\"><a class=\"anchor\" href=\"#45-url_hash调度算法\">#</a> 4.5 url_hash 调度算法</h5>\n<p>根据用户请求的 URL 进行 hash 取模，根据 hash 运算的值，将请求分配到后端特定的一台节点进行处理。URL 算法使用场景如下：client--&gt;nginx--&gt;url_hash--&gt;cache1--&gt;app</p>\n<ul>\n<li>1. 用户请求 nginx 负载均衡器，通过 url 调度算法，将请求调度至 Cache1</li>\n<li>2. 由于 Cache1 节点没有对应的缓存数据，则会请求后端获取，然后返回数据，并将数据缓存起来；</li>\n<li>3. 当其他用户再次请求此前相同的 URL 时，此时调度器依然会调度至 Cache1 节点处理；</li>\n<li>4. 由于 Cache1 节点已存在该 URL 资源缓存，所以直接将缓存数据进行返回；能大幅提升网站的响应；</li>\n</ul>\n<p>1. 配置后端节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># web1 节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web1 Url1\" > /code/web/url1.html</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web1 Url2\" > /code/web/url2.html</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># web2 节点</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web2 Url1\" > /code/web/url1.html</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web2 Url2\" > /code/web/url2.html</span></pre></td></tr></table></figure><p>2. 负载均衡配置 url_hash 调度算法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\"># 请求同一个 url，会始终定向到同一个服务器节点，consistent 表示使用一致性 hash 算法</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token builtin class-name\">hash</span> <span class=\"token variable\">$request_uri</span> consistent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3.Client 测试，会发现请求相同的 URL，始终会被定向至某特定后端节点。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  curl -HHost:web.hmallleasing.com http://192.168.40.150/url1.html</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>web2 Url1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  curl -HHost:web.hmallleasing.com http://192.168.40.150/url2.html</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>web1 Url2</pre></td></tr></table></figure><h5 id=\"46-least_conn调度算法\"><a class=\"anchor\" href=\"#46-least_conn调度算法\">#</a> 4.6 least_conn 调度算法</h5>\n<p>least_conn 调度算法实现原理，哪台节点连接数少，则将请求调度至哪台节点。</p>\n<p>假设：A 节点有 1000 个连接 、b 节点有 500 连接，如果此时新的连接进入会分发给 b 节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tleast_conn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"5nginx负载均衡后端状态\"><a class=\"anchor\" href=\"#5nginx负载均衡后端状态\">#</a> 5.Nginx 负载均衡后端状态</h4>\n<p>后端 Web 节点在前端 Nginx 负载均衡调度中的状态</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>状态</strong></th>\n<th style=\"text-align:center\"><strong>概述</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">down</td>\n<td style=\"text-align:center\">当前的 server 暂时不参与负载均衡</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">backup</td>\n<td style=\"text-align:center\">预留的备份服务器</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">max_fails</td>\n<td style=\"text-align:center\">允许请求失败的次数</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">fail_timeout</td>\n<td style=\"text-align:center\">经过 max_fails 失败后，服务暂停时间</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">max_conns</td>\n<td style=\"text-align:center\">限制最大的接收连接数</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"51-max_conns限制连接数\"><a class=\"anchor\" href=\"#51-max_conns限制连接数\">#</a> 5.1 max_conns 限制连接数</h5>\n<p>max_conns 用来限制每个后端节点能够接收的最大 TCP 连接数，如果超过此连接则会抛出错误。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">#接收的最大 TCP 连接数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80 <span class=\"token assign-left variable\">max_conns</span><span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80 <span class=\"token assign-left variable\">max_conns</span><span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>1、配置 jmeter</strong></p>\n<p>a、添加线程组：添加 -&gt; 线程用户 -&gt; 线程组</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/SMUzBLA.jpeg\" alt=\"1.jpg\" /></p>\n<p>b、添加 HTTP 请求：添加 -&gt; 取样器 -&gt;HTTP 请求</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6MeBeZA.jpeg\" alt=\"2.jpg\" /></p>\n<p>c. 添加聚合报告：添加 -&gt; 监听器 -&gt; 聚合报告</p>\n<p>d. 添加察看结果树：添加 -&gt; 监听器 -&gt; 察看结果树</p>\n<p>e. 添加用表格察看结果：添加 -&gt; 监听器 -&gt; 用表格察看结果</p>\n<p><strong>2、通过 jmter 压力测试发现，当后端节点处理的连接数非常多的时候，当大于 4 个连接，其余的连接则会抛出异常，也就是每次仅能满足 4 个连接。</strong></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/09cpWiW.jpeg\" alt=\"3.jpg\" /></p>\n<h5 id=\"52-down标识关闭状态\"><a class=\"anchor\" href=\"#52-down标识关闭状态\">#</a> 5.2 down 标识关闭状态</h5>\n<p>down 将服务器标记为不可用状态。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">#临时停机维护</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80 down<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"53-backup标识备份状态\"><a class=\"anchor\" href=\"#53-backup标识备份状态\">#</a> 5.3 backup 标识备份状态</h5>\n<p>backup 将服务器标记为备份服务器。当主服务器不可用时，将请求传递至备份服务器处理。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80 backup<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"54-max_fails与fail_timeout\"><a class=\"anchor\" href=\"#54-max_fails与fail_timeout\">#</a> 5.4 max_fails 与 fail_timeout</h5>\n<p>max_fails=2 服务器通信失败尝试 2 次，任然失败，认为服务器不可用，默认值 1；</p>\n<p>fail_timeout=5s 服务器通信失败后，每 5s 探测一次节点是否恢复可用，默认值 10s；</p>\n<p>在 fail_timeout 设定的时间内，与服务器连接失败达到 max_fails 则认为服务器不可用；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">#失败尝试 2 次，如果失败了每 5s 探测一次</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>5s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80 <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>5s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"55-keepalived提升吞吐量\"><a class=\"anchor\" href=\"#55-keepalived提升吞吐量\">#</a> 5.5 keepalived 提升吞吐量</h5>\n<p>keepalive 主要是与后端服务器激活缓存，也就是长连接，主要用来提升网站吞吐量。</p>\n<p>默认情况下：没有与后端服务启用长连接功能，当有请求时，需要建立连接、维护连接、关闭连接，所以会存在网络消耗，但如果将所有的连接都缓存了，当连接空闲了又会占用其系统资源，所以可以使用 keepalive 参数来激活缓存，同时还可以使用 keepalive 参数来限制最大的空闲连接数；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">#keepalive 32;                       #最大的空闲连接数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">#keepalive_timeout 100s;             #空闲连接的超时时间</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#proxy_http_version 1.1;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#proxy_set_header Connectin \"\";</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>没有启用 keepalive 参数前，对集群进行压力测试</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/HLqwoaL.jpeg\" alt=\"4.jpg\" /></p>\n<p>配置 Nginx 负载均衡启用 keepalive 参数：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tkeepalive <span class=\"token number\">32</span><span class=\"token punctuation\">;</span>                       <span class=\"token comment\">#最大的空闲连接数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tkeepalive_timeout 100s<span class=\"token punctuation\">;</span>             <span class=\"token comment\">#空闲连接的超时时间</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#启用长连接</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>对启用 keepalive 参数后的集群进行压力测试，发现整体性能提升了一倍。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/p6LTldf.jpeg\" alt=\"5.jpg\" /></p>\n<h4 id=\"6-后端节点异常容错机制\"><a class=\"anchor\" href=\"#6-后端节点异常容错机制\">#</a> 6. 后端节点异常容错机制</h4>\n<p>使用 nginx 负载均衡时，如何将后端请求超时的服务器流量平滑的切换到另一台上。</p>\n<p>如果后台服务连接超时，Nginx 是本身是有机制的，如果出现一个节点 down 掉的时候，Nginx 会更据你具体负载均衡的设置，将请求转移到其他的节点上，但是，如果后台服务连接没有 down 掉，而是返回了错误异常码如：504、502、500，该怎么办</p>\n<h5 id=\"61-配置语法\"><a class=\"anchor\" href=\"#61-配置语法\">#</a> 6.1 配置语法</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 当其中一台返回错误码 404,500 等错误时，可以分配到下一台服务器程序继续处理，提高平台访问成功率。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>proxy_next_upstream http_500 <span class=\"token operator\">|</span> http_502 <span class=\"token operator\">|</span> http_503 <span class=\"token operator\">|</span> http_504 <span class=\"token operator\">|</span>http_404<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h5 id=\"62-场景示例\"><a class=\"anchor\" href=\"#62-场景示例\">#</a> 6.2 场景示例</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream web <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tkeepalive <span class=\"token number\">32</span><span class=\"token punctuation\">;</span>                       <span class=\"token comment\">#最大的空闲连接数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tkeepalive_timeout 100s<span class=\"token punctuation\">;</span>             <span class=\"token comment\">#空闲连接的超时时间</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tproxy_pass http://web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token comment\">#当其中一台返回错误 500,502,503,504 时，分配下一台服务器程序处理，提高平台访问成功率</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tproxy_next_upstream error <span class=\"token function\">timeout</span> http_500 http_502 http_503 http_504<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tproxy_next_upstream_tries <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tproxy_next_upstream_timeout 3s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#启用长连接</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1601152722.html",
            "url": "http://ixuyong.cn/posts/1601152722.html",
            "title": "Nginx反向代理服务（四）",
            "date_published": "2025-08-27T13:56:13.000Z",
            "content_html": "<h3 id=\"nginx反向代理服务\"><a class=\"anchor\" href=\"#nginx反向代理服务\">#</a> Nginx 反向代理服务</h3>\n<h4 id=\"1nginx代理概述\"><a class=\"anchor\" href=\"#1nginx代理概述\">#</a> 1.Nginx 代理概述</h4>\n<h5 id=\"11-什么是代理\"><a class=\"anchor\" href=\"#11-什么是代理\">#</a> 1.1 什么是代理</h5>\n<ul>\n<li>代理代理，代为办理，对于代理一词而言，我们并不陌生，在我们日常生活中常常用到。</li>\n<li>比如代理理财、代理租房、代理收货等等</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/M4LsywY.jpeg\" alt=\"1.jpg\" /></p>\n<h4 id=\"2-nginx正向代理\"><a class=\"anchor\" href=\"#2-nginx正向代理\">#</a> 2. Nginx 正向代理</h4>\n<ul>\n<li>正向代理，(内部上网) 客户端 &lt;--&gt; 代理 -&gt; 服务端</li>\n<li>比如：科学的方式访问 Google</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WXS0jyR.jpeg\" alt=\"2.jpg\" /></p>\n<h4 id=\"3-nginx反向代理\"><a class=\"anchor\" href=\"#3-nginx反向代理\">#</a> 3. Nginx 反向代理</h4>\n<p>反向代理，用于公司集群架构中，客户端 -&gt; 代理 &lt;--&gt; 服务端</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zH6x7Ix.jpeg\" alt=\"3.jpg\" /></p>\n<h5 id=\"31-负载均衡\"><a class=\"anchor\" href=\"#31-负载均衡\">#</a> 3.1 负载均衡</h5>\n<p>将用户发送的请求，通过负载均衡调度算法挑选一台合适的节点进行请求处理。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gY35csf.jpeg\" alt=\"4.jpg\" /></p>\n<h5 id=\"32-动静分离\"><a class=\"anchor\" href=\"#32-动静分离\">#</a> 3.2 动静分离</h5>\n<p>根据用户请求的 URI 进行区分，将动态资源调度至应用服务器处理，将静态资源调度至静态资源服务器处理。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/YCJutcf.jpeg\" alt=\"5.jpg\" /></p>\n<h5 id=\"33-数据缓存\"><a class=\"anchor\" href=\"#33-数据缓存\">#</a> 3.3 数据缓存</h5>\n<p>将后端查询的数据存储至反向代理上缓存，可以加速用户获取资源。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/VuDyTPG.jpeg\" alt=\"6.jpg\" /></p>\n<h4 id=\"4-正向与反向代理区别\"><a class=\"anchor\" href=\"#4-正向与反向代理区别\">#</a> 4. 正向与反向代理区别</h4>\n<p>区别在于形式上服务的 &quot;对象&quot; 不一样、其次架设的位置点不一样。</p>\n<ul>\n<li>正向代理代理的对象是【客户端】，为客户端服务</li>\n<li>反向代理代理的对象是【服务端】，为服务端服务</li>\n<li>user--&gt; 正向代理（路由器）--&gt; 反向代理（缓存）--&gt; 服务器</li>\n</ul>\n<h4 id=\"5-nginx常用的代理协议\"><a class=\"anchor\" href=\"#5-nginx常用的代理协议\">#</a> 5. Nginx 常用的代理协议</h4>\n<p>通常情况下，我们将 Nginx 作为反向代理，常常会用到如下几种代理协议，如下图所示：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1wvfyBe.jpeg\" alt=\"7.jpg\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/NpuU8oZ.jpeg\" alt=\"8.jpg\" /></p>\n<h4 id=\"6-nginx反向代理实践\"><a class=\"anchor\" href=\"#6-nginx反向代理实践\">#</a> 6. Nginx 反向代理实践</h4>\n<h5 id=\"61-配置语法指令\"><a class=\"anchor\" href=\"#61-配置语法指令\">#</a> 6.1 配置语法指令</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: proxy_pass URL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: location, <span class=\"token keyword\">if</span> <span class=\"token keyword\">in</span> location,limit_except</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>proxy_pass http://localhost:8000/uri/</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>http://10.0.0.7:8000/uri/</pre></td></tr></table></figure><h5 id=\"62-代理配置场景\"><a class=\"anchor\" href=\"#62-代理配置场景\">#</a> 6.2 代理配置场景</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3vhNEj5.jpeg\" alt=\"9.jpg\" /></p>\n<h6 id=\"621-环境准备\"><a class=\"anchor\" href=\"#621-环境准备\">#</a> 6.2.1 环境准备</h6>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>角色</strong></th>\n<th style=\"text-align:center\"><strong>外网 ****IP (NAT)</strong></th>\n<th style=\"text-align:center\"><strong>内网 ****IP (LAN)</strong></th>\n<th style=\"text-align:center\"><strong>主机名</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">Proxy</td>\n<td style=\"text-align:center\">eth0:10.0.0.5</td>\n<td style=\"text-align:center\">eth1:172.16.1.5</td>\n<td style=\"text-align:center\">proxy01</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">eth1:172.16.1.7</td>\n<td style=\"text-align:center\">web01</td>\n</tr>\n</tbody>\n</table>\n<h6 id=\"622-web节点配置\"><a class=\"anchor\" href=\"#622-web节点配置\">#</a> 6.2.2 web 节点配置</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># web01 服务配置一个网站，监听在 `8080`，此时网站仅 `172` 网段的用户能访问</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/web.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">8080</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\troot /code/web<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/web</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web01-8080...\">/code/web/index.html</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h6 id=\"623-proxy节点配置\"><a class=\"anchor\" href=\"#623-proxy节点配置\">#</a> 6.2.3 proxy 节点配置</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># proxy 代理服务配置，让外网用户能够通过代理服务访问到后端的 172.16.1.7 的 8080 端口站点内容</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/proxy_web.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name web.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tproxy_pass http://172.16.1.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nginx</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nginx</span></pre></td></tr></table></figure><h6 id=\"624-抓包分析访问过程\"><a class=\"anchor\" href=\"#624-抓包分析访问过程\">#</a> 6.2.4 抓包分析访问过程</h6>\n<p>抓包分析 Nginx 代理处理整个请求的过程</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zzTTryV.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"63-代理相关配置参数\"><a class=\"anchor\" href=\"#63-代理相关配置参数\">#</a> 6.3 代理相关配置参数</h5>\n<h6 id=\"631-proxy_set_header\"><a class=\"anchor\" href=\"#631-proxy_set_header\">#</a> 6.3.1 proxy_set_header</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加发往后端服务器的请求头信息，</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: proxy_set_header field value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: proxy_set_header Host <span class=\"token variable\">$proxy_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t proxy_set_header Connection close<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 客户端请求 Host 的值是 www.oldxu.net, 那么代理服务会像后端请求时携带 Host 变量为 www.oldxu.net</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 将 $remote_addr 的值放进变量 X-Real-IP 中，$remote_addr 的值为客户端的 ip</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 客户端通过代理服务访问后端服务，后端服务会通过该变量会记录真实客户端地址</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h6 id=\"632-proxy_http_version\"><a class=\"anchor\" href=\"#632-proxy_http_version\">#</a> 6.3.2 proxy_http_version</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 代理的向后端请求时使用的 HTTP 协议版本。默认 1.0 版本</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: proxy_http_version <span class=\"token number\">1.0</span> <span class=\"token operator\">|</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: proxy_http_version <span class=\"token number\">1.0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>This directive appeared <span class=\"token keyword\">in</span> version <span class=\"token number\">1.1</span>.4</pre></td></tr></table></figure><h6 id=\"633-proxy_connect_timeout\"><a class=\"anchor\" href=\"#633-proxy_connect_timeout\">#</a> 6.3.3 proxy_connect_timeout</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#nginx 代理与后端服务器 \"连接超时\" 时间 (代理连接超时)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: proxy_connect_timeout <span class=\"token function\">time</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: proxy_connect_timeout 60s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><h6 id=\"634-proxy_read_timeout\"><a class=\"anchor\" href=\"#634-proxy_read_timeout\">#</a> 6.3.4 proxy_read_timeout</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#nginx 代理等待后端服务器 \"响应（Header）超时\" 时间</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: proxy_read_timeout <span class=\"token function\">time</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: proxy_read_timeout 60s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><h6 id=\"635-proxy_send_timeout\"><a class=\"anchor\" href=\"#635-proxy_send_timeout\">#</a> 6.3.5 proxy_send_timeout</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#后端服务器 \"数据（Data）回传给 nginx 代理超时\" 时间</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: proxy_send_timeout <span class=\"token function\">time</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: proxy_send_timeout 60s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><h6 id=\"636-proxy_buffer缓冲区\"><a class=\"anchor\" href=\"#636-proxy_buffer缓冲区\">#</a> 6.3.6 proxy_buffer (缓冲区)</h6>\n<p>1）启用缓冲时，nginx 代理服务器将尽快的接收响应 Header 以及响应报文，并将其保存到 proxy_buffer_size (Headers) 和 proxy_buffers (data) 设置的缓冲区中。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># proxy_buffer 代理缓冲区</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: proxy_buffering on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><p>如果响应报文过大无法存储至内存，则会将其中部分保存到磁盘上的临时文件中。写入临时文件由 proxy_temp_path（控制临时存储目录）proxy_max_temp_file_size（控制临时存储目录大小） 和 proxy_temp_file_write_size（控制一次写入临时文件的数据大小），临时文件最大大小由 proxy_buffer_size 和 proxy_buffers 限制。但当禁用缓冲时，nginx 代理服务器会在接收到响应时立即同步传递给客户端。nginx 代理服务器不会读取整个响应。</p>\n<p>2）proxy_buffer_size 用于控制代理服务读取后端第一部分响应 Header 的缓冲区大小。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: proxy_buffer_size size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: proxy_buffer_size 4k<span class=\"token operator\">|</span>8k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># proxy_buffer_size 64k;</span></pre></td></tr></table></figure><p>3）proxy_buffers 是代理服务器为单个连接设置响应缓冲区 “数量” 和 “大小” 。</p>\n<p>如果一个后端服务所返回的页面大小为 256KB，那么会为其分配 4 个 64KB 的缓冲区来缓存，如果页面大小大于 256KB，那么大于 256KB 的部分会缓存到 proxy_temp_path 指定的路径中。但是这并不是好方法，因为内存中的数据处理速度要快于硬盘。所以这个值一般建议设置为站点响应所产生的页面大小中间值，如果站点大部分脚本所产生的页面大小为 256KB，那么可以把这个值设置为 “16 16k”、“4 64k” 等。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: proxy_buffers number size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: proxy_buffers <span class=\"token number\">8</span> 4k<span class=\"token operator\">|</span>8k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#proxy_buffers 4 64k;</span></pre></td></tr></table></figure><h6 id=\"637-代理参数总结\"><a class=\"anchor\" href=\"#637-代理参数总结\">#</a> 6.3.7 代理参数总结</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 代理网站常用优化配置如下，将配置写入一个新文件，调用时使用 include 即可</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 使用 include 方式，便于后续 Location 的重复使用。</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tproxy_pass http://127.0.0.1:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/pSerie6.jpeg\" alt=\"2.jpg\" /></p>\n",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/865547436.html",
            "url": "http://ixuyong.cn/posts/865547436.html",
            "title": "Nginx基础架构LNMP（三）",
            "date_published": "2025-08-27T13:50:04.000Z",
            "content_html": "<h3 id=\"nginx基础架构lnmp\"><a class=\"anchor\" href=\"#nginx基础架构lnmp\">#</a> Nginx 基础架构 LNMP</h3>\n<h4 id=\"1-lnmp架构基本概述\"><a class=\"anchor\" href=\"#1-lnmp架构基本概述\">#</a> 1. LNMP 架构基本概述</h4>\n<h5 id=\"11-什么是lnmp\"><a class=\"anchor\" href=\"#11-什么是lnmp\">#</a> 1.1 什么是 LNMP</h5>\n<ul>\n<li>LNMP 是一套技术的组合，L=Linux、N=Nginx、M=[MySQL|Mariadb]、P=[PHP|Python]；</li>\n<li>nginx 仅支持解析 html 文件；图片传输；视频传输，不支持 php 脚本文件；</li>\n</ul>\n<h5 id=\"12-lnmp实现过程\"><a class=\"anchor\" href=\"#12-lnmp实现过程\">#</a> 1.2 LNMP 实现过程</h5>\n<p>用户请求 http://hmallleasing.com/index.php，对于 Nginx 服务而言，是无法处理 index.php 这样的脚本，那么 Nginx 该如何配置，才能支持这样的动态请求呢？</p>\n<p>第一步：当用户发起 HTTP 请求，请求首先被 Nginx 接收；</p>\n<p>第二步：Nginx 通过预先定义好的 location 规则进行匹配；</p>\n<p>第三步：Nginx 将匹配到的动态内容，通过 fastcgi 协议传到给后端的 php 应用服务处理</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1vVYqB8.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"13-lnmp实现细节\"><a class=\"anchor\" href=\"#13-lnmp实现细节\">#</a> 1.3 LNMP 实现细节</h5>\n<p>Nginx、PHP、MySQL 之间是如何工作的？</p>\n<ul>\n<li>1. 用户首先通过 http 协议发起请求，请求会先抵达 Nginx；</li>\n<li>2.Nginx 根据用户的请求进行 Location 规则匹配；</li>\n<li>3.Location 如果匹配到请求是静态，则由 Nginx 读取本地直接返回；</li>\n<li>4.Location 如果匹配到请求是动态，则由 Nginx 将请求转发给 fastcgi 协议；</li>\n<li>5.fastgi 收到后会将请求交给 php-fpm 管理进程；</li>\n<li>6.php-fpm 管理进程接收到后会调用具体的 worker 工作进程</li>\n<li>6.warrap 进程会调用 php 解析器解析代码，php 解析后直接返回</li>\n<li>7. 如果有查询数据库操作，则由 php 连接数据库 (用户 密码 IP) 发起查询的操作</li>\n<li>8. 最终数据由 mysql-&gt;php-&gt;php-fpm-&gt;fastcgi-&gt;nginx-&gt;http-&gt;user</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/pHd8HBp.jpeg\" alt=\"2.jpg\" /></p>\n<h4 id=\"2lnmp架构环境安装\"><a class=\"anchor\" href=\"#2lnmp架构环境安装\">#</a> 2.LNMP 架构环境安装</h4>\n<h5 id=\"21-nginx安装\"><a class=\"anchor\" href=\"#21-nginx安装\">#</a> 2.1 Nginx 安装</h5>\n<p>1. 使用官方仓库安装 Nginx</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/yum.repos.d/nginx.repo </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>nginx-stable<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>nginx stable repo</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>http://nginx.org/packages/centos/<span class=\"token variable\">$releasever</span>/<span class=\"token variable\">$basearch</span>/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">gpgkey</span><span class=\"token operator\">=</span>https://nginx.org/keys/nginx_signing.key</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">module_hotfixes</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr></table></figure><p>2. 配置 Nginx 进程运行用户</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g666 www</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u666 -g666 www</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user www;' /etc/nginx/nginx.conf</span></pre></td></tr></table></figure><p>3. 启动 Nginx，并将 Nginx 加入开机自启</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nginx</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nginx</span></pre></td></tr></table></figure><h5 id=\"22-php安装\"><a class=\"anchor\" href=\"#22-php安装\">#</a> 2.2 PHP 安装</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、移除旧版 php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum remove php-mysql-5.4 php php-fpm php-common</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2、安装扩展源</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum localinstall https://mirror.webtatic.com/yum/el7/webtatic-release.rpm -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、安装 php7.1 版本</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4. 配置 php-fpm 用户与 Nginx 的运行用户保持一致</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^group/c group = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#5、启动 php</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start php-fpm &amp;&amp; systemctl enable php-fpm</span></pre></td></tr></table></figure><h5 id=\"23-mysql安装\"><a class=\"anchor\" href=\"#23-mysql安装\">#</a> 2.3 MySQL 安装</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、下载 MySQL 官方扩展源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ivh http://repo.mysql.com/yum/mysql-5.7-community/el/7/x86_64/mysql57-community-release-el7-10.noarch.rpm</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2、安装 mysql5.7，文件过大可能会导致下载缓慢</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mysql-community-server -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、启动并加入开机自动启动</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4、查看端口是否启动</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep 3306</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::3306                 :::*                    LISTEN      <span class=\"token number\">1911</span>/mysqld  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#5、由于 mysql5.7 默认配置密码，需要过滤 temporary password 关键字查看对应登陆数据库密码</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># grep 'temporary password' /var/log/mysqld.log</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#6、登录 mysql 数据库 [password 中填写上一步过滤的密码]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#7、重新修改数据库密码</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'localhost'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2025'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#8、添加 app 用户</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'app'</span>@<span class=\"token string\">'192.168.1.%'</span> identified by <span class=\"token string\">'Superman*2025'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#9、允许 root 用户在任何地方进行远程登录，并具有所有库任何操作权限，具体操作如下</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql<span class=\"token operator\">></span> GRANT ALL PRIVILEGES ON *.* TO <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2025'</span> WITH GRANT OPTION<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>mysql<span class=\"token operator\">></span> FLUSH PRIVILEGES<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"3lnmp架构环境配置\"><a class=\"anchor\" href=\"#3lnmp架构环境配置\">#</a> 3.LNMP 架构环境配置</h4>\n<p>在配置 Nginx 与 PHP 集成之前， 我们需要先了解 Nginx 的 Fastcgi 代理配置语法</p>\n<h5 id=\"31-fastcgi代理语法\"><a class=\"anchor\" href=\"#31-fastcgi代理语法\">#</a> 3.1 Fastcgi 代理语法</h5>\n<p>1. 设置 fastcgi 服务器的地址，该地址可以指定为域名或 IP 地址，以及端口</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: fastcgi_pass address<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: location, <span class=\"token keyword\">if</span> <span class=\"token keyword\">in</span> location</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#语法示例</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>fastcgi_pass localhost:9000<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>2. 设置 fastcgi 默认的首页文件，需要结合 fastcgi_param 一起设置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: fastcgi_index name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><p>3. 通过 fastcgi_param 设置变量，并将设置的变量传递到后端的 fastcgi 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: fastcgi_param parameter value</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>if_not_empty<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#语法示例</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>fastcgi_index index.php<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>fastcgi_param SCRIPT_FILENAME</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>4. 通过图形方式展示 fastcgi_index 与 fastcgi_param 作用。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zUUojVD.jpeg\" alt=\"3.jpg\" /></p>\n<h5 id=\"32-nginx与php集成\"><a class=\"anchor\" href=\"#32-nginx与php集成\">#</a> 3.2 Nginx 与 PHP 集成</h5>\n<p>1. 编写 Nginx 配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat php.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/php.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name php.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tfastcgi_pass   <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tfastcgi_param  SCRIPT_FILENAME  <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tinclude        fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p>2. 在 /code 目录下创建 info.php 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/index.php </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?php</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tphpinfo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>?<span class=\"token operator\">></span></pre></td></tr></table></figure><p>3. 通过浏览器访问 /info.php，返回如下页面表示 nginx 与 php 配置成功；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8L2aAcZ.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"33-php与mysql集成\"><a class=\"anchor\" href=\"#33-php与mysql集成\">#</a> 3.3 PHP 与 MySQL 集成</h5>\n<p>1. 在 /code 目录下创建 mysqli.php 文件，填入对应的数据库 IP、用户名、密码 *</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/mysqli.php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?php</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token variable\">$servername</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token variable\">$username</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"root\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token variable\">$password</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Superman*2025\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t// 创建连接</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token variable\">$conn</span> <span class=\"token operator\">=</span> mysqli_connect<span class=\"token punctuation\">(</span><span class=\"token variable\">$servername</span>, <span class=\"token variable\">$username</span>, <span class=\"token variable\">$password</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t// 检测连接</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>die<span class=\"token punctuation\">(</span><span class=\"token string\">\"Connection failed: \"</span> <span class=\"token builtin class-name\">.</span> mysqli_connect_error<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"php连接MySQL数据库成功\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>?<span class=\"token operator\">></span></pre></td></tr></table></figure><p>2. 使用 php 命令直接解析文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># php /code/mysqli.php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>php连接MySQL数据库成功</pre></td></tr></table></figure><h4 id=\"4部署开源产品\"><a class=\"anchor\" href=\"#4部署开源产品\">#</a> 4. 部署开源产品</h4>\n<h5 id=\"41-部署博客wordpress\"><a class=\"anchor\" href=\"#41-部署博客wordpress\">#</a> 4.1 部署博客 Wordpress</h5>\n<h6 id=\"411-配置nginx\"><a class=\"anchor\" href=\"#411-配置nginx\">#</a> 4.1.1 配置 Nginx</h6>\n<p>1. 配置 Nginx 虚拟主机站点，域名为 <a href=\"http://blog.hmallleasing.com\">blog.hmallleasing.com</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/blog.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name blog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code/wordpress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tfastcgi_pass <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tfastcgi_index index.php<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tfastcgi_param SCRIPT_FILENAME <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tinclude fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2. 检测语法，并重启 nginx 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"412-配置mysql\"><a class=\"anchor\" href=\"#412-配置mysql\">#</a> 4.1.2 配置 MySQL</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -pSuperman*2025</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mysql<span class=\"token operator\">></span> create database wordpress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token builtin class-name\">exit</span></pre></td></tr></table></figure><h6 id=\"413-部署wordpress\"><a class=\"anchor\" href=\"#413-部署wordpress\">#</a> 4.1.3 部署 Wordpress</h6>\n<p>1. 获取 wordpress 产品，解压并部署 wordress</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://cn.wordpress.org/wordpress-4.9.4-zh_CN.tar.gz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf wordpress-4.9.4-zh_CN.tar.gz -C /code</span></pre></td></tr></table></figure><p>2. 授权目前的权限为进程运行的用户身份；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /code/wordpress/</span></pre></td></tr></table></figure><p>3.wordpress 相关主题</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget http://cdn.xuliangwei.com/Origami-1.1.0.zip</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget http://cdn.xuliangwei.com/QQ2.8.zip</span></pre></td></tr></table></figure><h5 id=\"42-部署知乎产品wecenter\"><a class=\"anchor\" href=\"#42-部署知乎产品wecenter\">#</a> 4.2 部署知乎产品 Wecenter</h5>\n<h6 id=\"421-配置nginx\"><a class=\"anchor\" href=\"#421-配置nginx\">#</a> 4.2.1 配置 Nginx</h6>\n<p>1. 配置 Nginx 虚拟主机站点，域名为 <a href=\"http://zh.hmallleasing.com\">zh.hmallleasing.com</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/zh.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code/zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tfastcgi_pass <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tfastcgi_index index.php<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tfastcgi_param SCRIPT_FILENAME <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tinclude fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2. 检查语法，并重启 nginx 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h6 id=\"422-配置mysql\"><a class=\"anchor\" href=\"#422-配置mysql\">#</a> 4.2.2 配置 MySQL</h6>\n<p>由于 wecenter 产品需要依赖数据库，所以需要手动建立数据库</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -pSuperman*2025</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mysql<span class=\"token operator\">></span> create database zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token builtin class-name\">exit</span></pre></td></tr></table></figure><p>4.2.3 部署 Wecenter</p>\n<p>1. 获取 Wecenter 产品，解压并部署 Wecenter</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 zh<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /code/zh/WeCenter_3-2-1</span></pre></td></tr></table></figure><p>2. 授权目前的权限为进程运行的用户身份；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /code/zh/</span></pre></td></tr></table></figure><h4 id=\"5拆分数据库至独立服务器\"><a class=\"anchor\" href=\"#5拆分数据库至独立服务器\">#</a> 5. 拆分数据库至独立服务器</h4>\n<h5 id=\"51-为何要拆分数据库\"><a class=\"anchor\" href=\"#51-为何要拆分数据库\">#</a> 5.1 为何要拆分数据库</h5>\n<p>由于单台服务器运行 LNMP 架构会导致网站访问缓慢，当系统内存被吃满时，很容易导致系统出现 oom，从而 kill 掉 MySQL 数据库，所以需要将 web 和数据库进行独立部署。</p>\n<h5 id=\"52-数据库拆分架构演变\"><a class=\"anchor\" href=\"#52-数据库拆分架构演变\">#</a> 5.2 数据库拆分架构演变</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/BpAMDyG.png\" alt=\"1.png\" /></p>\n<h5 id=\"53-数据库拆分环境准备\"><a class=\"anchor\" href=\"#53-数据库拆分环境准备\">#</a> 5.3 数据库拆分环境准备</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>主机名称</strong></th>\n<th style=\"text-align:center\"><strong>应用环境</strong></th>\n<th style=\"text-align:center\"><strong>外网地址</strong></th>\n<th style=\"text-align:center\"><strong>内网地址</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">nginx+php</td>\n<td style=\"text-align:center\">10.0.0.7</td>\n<td style=\"text-align:center\">172.16.1.7</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">db01</td>\n<td style=\"text-align:center\">mysql</td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">172.16.1.51</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"54-数据库拆分实现步骤\"><a class=\"anchor\" href=\"#54-数据库拆分实现步骤\">#</a> 5.4 数据库拆分实现步骤</h5>\n<h6 id=\"541-web服务操作如下\"><a class=\"anchor\" href=\"#541-web服务操作如下\">#</a> 5.4.1 web 服务操作如下</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysqldump -uroot -p'Superman*2025' --all-databases > mysql-all.sql</span></pre></td></tr></table></figure><p>2. 将 web01 上备份的数据库拷贝至 db01 服务器上</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp mysql-all.sql root@172.16.1.51:/tmp</span></pre></td></tr></table></figure><h6 id=\"542-数据库服务操作如下\"><a class=\"anchor\" href=\"#542-数据库服务操作如下\">#</a> 5.4.2 数据库服务操作如下</h6>\n<p>1. 将 web01 服务器上推送的数据库备份文件恢复至 db01 服务器新数据库中</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、下载 MySQL 官方扩展源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ivh http://repo.mysql.com/yum/mysql-5.7-community/el/7/x86_64/mysql57-community-release-el7-10.noarch.rpm</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2、安装 mysql5.7，文件过大可能会导致下载缓慢</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mysql-community-server -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、启动并加入开机自动启动</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4、查看端口是否启动</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:22              <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">3788</span>/sshd           </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:25            <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">4018</span>/master         </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::3306                 :::*                    LISTEN      <span class=\"token number\">4628</span>/mysqld         </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::22                   :::*                    LISTEN      <span class=\"token number\">3788</span>/sshd           </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> ::1:25                  :::*                    LISTEN      <span class=\"token number\">4018</span>/master </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#5、由于 mysql5.7 默认配置密码，需要过滤 temporary password 关键字查看对应登陆数据库密码</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># grep 'temporary password' /var/log/mysqld.log</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#6、登录 mysql 数据库 [password 中填写上一步过滤的密码]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#7、重新修改数据库密码</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'app'</span>@<span class=\"token string\">'192.168.40.%'</span> identified by <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#8、导入备份数据</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot &lt; /tmp/mysql-all.sql</span></pre></td></tr></table></figure><h6 id=\"543-修改代码指向新数据库\"><a class=\"anchor\" href=\"#543-修改代码指向新数据库\">#</a> 5.4.3 修改代码指向新数据库</h6>\n<p>1. 修改 Wordpress 产品代码连接数据库的配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 code<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/wordpress/wp-config.php </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/** WordPress数据库的名称 */</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>define<span class=\"token punctuation\">(</span><span class=\"token string\">'DB_NAME'</span>, <span class=\"token string\">'wordpress'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/** MySQL数据库用户名 */</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>define<span class=\"token punctuation\">(</span><span class=\"token string\">'DB_USER'</span>, <span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>/** MySQL数据库密码 */</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>define<span class=\"token punctuation\">(</span><span class=\"token string\">'DB_PASSWORD'</span>, <span class=\"token string\">'Superman*2025'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>/** MySQL主机 */</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>define<span class=\"token punctuation\">(</span><span class=\"token string\">'DB_HOST'</span>, <span class=\"token string\">'192.168.1.51'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>2. 修改 wecenter 产品代码连接数据库的配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 zh<span class=\"token punctuation\">]</span><span class=\"token comment\">#  find ./ -type f | xargs grep -iR \"Superman*2025\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token variable\">$config</span><span class=\"token punctuation\">[</span><span class=\"token string\">'charset'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token variable\">$config</span><span class=\"token punctuation\">[</span><span class=\"token string\">'prefix'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'aws_'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token variable\">$config</span><span class=\"token punctuation\">[</span><span class=\"token string\">'driver'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'MySQLi'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token variable\">$config</span><span class=\"token punctuation\">[</span><span class=\"token string\">'master'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> array <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token string\">'charset'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'utf8'</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token string\">'host'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'192.168.1.51'</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token string\">'username'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'app'</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token string\">'password'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'Superman*2025'</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token string\">'dbname'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'zh'</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token string\">'port'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'3306'</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token variable\">$config</span><span class=\"token punctuation\">[</span><span class=\"token string\">'slave'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token variable\">$config</span><span class=\"token punctuation\">[</span><span class=\"token string\">'port'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'3306'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"6扩展多台相同的web服务器\"><a class=\"anchor\" href=\"#6扩展多台相同的web服务器\">#</a> 6. 扩展多台相同的 Web 服务器</h4>\n<h5 id=\"61-为何要扩展多台web节点\"><a class=\"anchor\" href=\"#61-为何要扩展多台web节点\">#</a> 6.1 为何要扩展多台 web 节点</h5>\n<p>单台 web 服务器能抗住的访问量是有限的，配置多台 web 服务器能提升更高的访问速度。</p>\n<p>扩展多台节点解决什么问题:</p>\n<ul>\n<li>1. 单台 web 节点如果故障，会导致业务 down 机；</li>\n<li>2. 多台 web 节点能保证业务的持续稳定，扩展性高；</li>\n<li>3. 多台 web 节点能有效的提升用户访问网站的速度；</li>\n</ul>\n<h5 id=\"62-扩展多web节点架构演变\"><a class=\"anchor\" href=\"#62-扩展多web节点架构演变\">#</a> 6.2 扩展多 web 节点架构演变</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/pha0vTV.png\" alt=\"2.png\" /></p>\n<h5 id=\"63-扩展多web节点环境准备\"><a class=\"anchor\" href=\"#63-扩展多web节点环境准备\">#</a> 6.3 扩展多 web 节点环境准备</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>主机名称</strong></th>\n<th style=\"text-align:center\"><strong>应用环境</strong></th>\n<th style=\"text-align:center\"><strong>外网地址</strong></th>\n<th style=\"text-align:center\"><strong>内网地址</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">nginx+php</td>\n<td style=\"text-align:center\">10.0.0.7</td>\n<td style=\"text-align:center\">172.16.1.7</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">nginx+php</td>\n<td style=\"text-align:center\">10.0.0.78</td>\n<td style=\"text-align:center\">172.16.1.8</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">db01</td>\n<td style=\"text-align:center\">mysql</td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">172.16.1.51</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"64-扩展多web节点实现步骤\"><a class=\"anchor\" href=\"#64-扩展多web节点实现步骤\">#</a> 6.4 扩展多 web 节点实现步骤</h5>\n<p>通过 web01 现有环境快速的扩展一台 web02 的服务器，数据库统一使用 db01</p>\n<h6 id=\"641-lnp环境安装\"><a class=\"anchor\" href=\"#641-lnp环境安装\">#</a> 6.4.1 LNP 环境安装</h6>\n<p>1. 创建 www 用户</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g666 www</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u666 -g666 www</span></pre></td></tr></table></figure><p>2. 安装 LNP</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp root@172.16.1.7:/etc/yum.repos.d/* /etc/yum.repos.d/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp root@172.16.1.7:/etc/pki/rpm-gpg/* /etc/pki/rpm-gpg/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install php71w php71w-cli \\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>php71w-common php71w-devel php71w-embedded php71w-gd <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>php71w-fpm php71w-mysqlnd php71w-opcache <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</pre></td></tr></table></figure><h6 id=\"642-lnp配置导入\"><a class=\"anchor\" href=\"#642-lnp配置导入\">#</a> 6.4.2 LNP 配置导入</h6>\n<p>1. 将 web01 的 nginx 配置文件导入到 web02</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp root@172.16.1.7:/etc/nginx /etc/</span></pre></td></tr></table></figure><p>2. 将 web01 的 php 配置文件导入到 web02</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp root@172.16.1.7:/etc/php-fpm.d /etc/</span></pre></td></tr></table></figure><h6 id=\"643-导入代码文件\"><a class=\"anchor\" href=\"#643-导入代码文件\">#</a> 6.4.3 导入代码文件</h6>\n<p>1. 将 web01 的代码打包传输到 web02 服务器上，在 web1 上线进行打包操作</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar czf code.tar.gz /code</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp code.tar.gz root@172.16.1.8:/tmp</span></pre></td></tr></table></figure><p>2. 在 web02 服务器上进行解压</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf /tmp/code.tar.gz -C /</span></pre></td></tr></table></figure><h6 id=\"644-启动服务验证\"><a class=\"anchor\" href=\"#644-启动服务验证\">#</a> 6.4.4 启动服务验证</h6>\n<p>启动 nginx 与 php-fpm 并加入开机自启</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nginx php-fpm</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nginx php-fpm</span></pre></td></tr></table></figure><h4 id=\"7-拆分静态资源至独立服务器\"><a class=\"anchor\" href=\"#7-拆分静态资源至独立服务器\">#</a> 7. 拆分静态资源至独立服务器</h4>\n<h5 id=\"71-为何要拆分静态资源\"><a class=\"anchor\" href=\"#71-为何要拆分静态资源\">#</a> 7.1 为何要拆分静态资源</h5>\n<p>当后端的 web 节点出现多台时，会导致用户上传的图片、视频附件等内容仅上传至一台 web 服务器，那么其他的 web 服务器则无法访问到该图片。</p>\n<p>如果增加一台共享存储能解决什么问题：</p>\n<ul>\n<li>1. 保证了多台 web 节点静态资源一致。</li>\n<li>2. 有效节省多台 web 节点的存储空间。</li>\n<li>3. 统一管理静态资源，便于后期推送至 CDN 进行静态资源加速</li>\n</ul>\n<h5 id=\"72-拆分静态资源架构演变\"><a class=\"anchor\" href=\"#72-拆分静态资源架构演变\">#</a> 7.2 拆分静态资源架构演变</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/pwA82mg.png\" alt=\"3.png\" /></p>\n<h5 id=\"73-增加共享存储环境准备\"><a class=\"anchor\" href=\"#73-增加共享存储环境准备\">#</a> 7.3 增加共享存储环境准备</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>主机名称</strong></th>\n<th style=\"text-align:center\"><strong>应用环境</strong></th>\n<th style=\"text-align:center\"><strong>外网地址</strong></th>\n<th style=\"text-align:center\"><strong>内网地址</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">nginx+php</td>\n<td style=\"text-align:center\">10.0.0.7</td>\n<td style=\"text-align:center\">172.16.1.7</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">nginx+php</td>\n<td style=\"text-align:center\">10.0.0.78</td>\n<td style=\"text-align:center\">172.16.1.8</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">nfs</td>\n<td style=\"text-align:center\">nfs</td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">172.16.1.32</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">db01</td>\n<td style=\"text-align:center\">mysql</td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">172.16.1.51</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"74-增加共享存储实现步骤\"><a class=\"anchor\" href=\"#74-增加共享存储实现步骤\">#</a> 7.4 增加共享存储实现步骤</h5>\n<h6 id=\"741-配置nfs存储\"><a class=\"anchor\" href=\"#741-配置nfs存储\">#</a> 7.4.1 配置 NFS 存储</h6>\n<p>1. 安装并配置 nfs</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g666 www</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u666 -g666 www</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/exports</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/data/blog <span class=\"token number\">192.168</span>.1.0/24<span class=\"token punctuation\">(</span>rw,sync,all_squash,anonuid<span class=\"token operator\">=</span><span class=\"token number\">666</span>,anongid<span class=\"token operator\">=</span><span class=\"token number\">666</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>/data/zh <span class=\"token number\">192.168</span>.1.0/24<span class=\"token punctuation\">(</span>rw,sync,all_squash,anonuid<span class=\"token operator\">=</span><span class=\"token number\">666</span>,anongid<span class=\"token operator\">=</span><span class=\"token number\">666</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>2. 创建共享目录，并进行授权</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkfs.xfs /dev/sdb</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data/&#123;blog,zh&#125; -p</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t xfs /dev/sdb /data</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /data/</span></pre></td></tr></table></figure><p>3. 启动 nfs 服务，并加入开机自启</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nfs-server &amp;&amp; systemctl enable nfs-server</span></pre></td></tr></table></figure><h6 id=\"742-导入静态资源至存储\"><a class=\"anchor\" href=\"#742-导入静态资源至存储\">#</a> 7.4.2 导入静态资源至存储</h6>\n<p>1.web01 节点安装 nfs，然后使用 showmount 查看服务端共享的资源</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># showmount -e 172.16.1.32</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Export list <span class=\"token keyword\">for</span> <span class=\"token number\">172.16</span>.1.32:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/data/zh <span class=\"token number\">172.16</span>.1.0/24</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/data/blog <span class=\"token number\">172.16</span>.1.0/24</pre></td></tr></table></figure><p>2. 查找 Wordpress 静态资源，然后</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 首先打开浏览器 -> 右键 -> 检查 ->Network-></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 然后点击左上角的 Select 按钮 -> 点击对应的图片</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 最后提取站点中对应的 url 地址 ->http://blog.oldxu.net/wp\u0002content/uploads/2018/11/timg.gif</span></pre></td></tr></table></figure><p>3. 拷贝静态资源至 nfs 共享存储</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /code/wordpress/wp-content/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 wp-content<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp uploads/* root@172.16.1.32:/data/blog</span></pre></td></tr></table></figure><h6 id=\"743-节点1接入共享存储\"><a class=\"anchor\" href=\"#743-节点1接入共享存储\">#</a> 7.4.3 节点 1 接入共享存储</h6>\n<p>1.web01 客户端执行挂载操作</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.1.32:/data/blog /code/wordpress/wp-content/uploads/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># df -h</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Filesystem               Size  Used Avail Use% Mounted on</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/dev/mapper/centos-root   92G  <span class=\"token number\">2</span>.2G   89G   <span class=\"token number\">3</span>% /</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>devtmpfs                 <span class=\"token number\">3</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9G   <span class=\"token number\">0</span>% /dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tmpfs                    <span class=\"token number\">3</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9G   <span class=\"token number\">0</span>% /dev/shm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tmpfs                    <span class=\"token number\">3</span>.9G  <span class=\"token number\">8</span>.9M  <span class=\"token number\">3</span>.9G   <span class=\"token number\">1</span>% /run</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tmpfs                    <span class=\"token number\">3</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9G   <span class=\"token number\">0</span>% /sys/fs/cgroup</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/dev/sda1               1014M  146M  869M  <span class=\"token number\">15</span>% /boot</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>tmpfs                    783M     <span class=\"token number\">0</span>  783M   <span class=\"token number\">0</span>% /run/user/0</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">192.168</span>.1.32:/data/blog   92G  <span class=\"token number\">2</span>.0G   90G   <span class=\"token number\">3</span>% /code/wordpress/wp-content/uploa</pre></td></tr></table></figure><p>2. 将挂载信息加入开机自启</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/fstab</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">172.16</span>.1.32:/data/blog /code/wordpress/wp-content/uploads nfs defaults <span class=\"token number\">0</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -a</span></pre></td></tr></table></figure><h6 id=\"744-节点2接入共享存储\"><a class=\"anchor\" href=\"#744-节点2接入共享存储\">#</a> 7.4.4 节点 2 接入共享存储</h6>\n<p>1.web02 客户端直接挂载 nfs 即可</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.1.32:/data/blog /code/wordpress/wp-content/uploads/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># df -h</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Filesystem               Size  Used Avail Use% Mounted on</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/dev/mapper/centos-root   92G  <span class=\"token number\">2</span>.2G   89G   <span class=\"token number\">3</span>% /</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>devtmpfs                 <span class=\"token number\">3</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9G   <span class=\"token number\">0</span>% /dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tmpfs                    <span class=\"token number\">3</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9G   <span class=\"token number\">0</span>% /dev/shm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tmpfs                    <span class=\"token number\">3</span>.9G  <span class=\"token number\">8</span>.8M  <span class=\"token number\">3</span>.9G   <span class=\"token number\">1</span>% /run</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tmpfs                    <span class=\"token number\">3</span>.9G     <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9G   <span class=\"token number\">0</span>% /sys/fs/cgroup</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/dev/sda1               1014M  146M  869M  <span class=\"token number\">15</span>% /boot</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>tmpfs                    783M     <span class=\"token number\">0</span>  783M   <span class=\"token number\">0</span>% /run/user/0</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">192.168</span>.1.32:/data/blog   92G  <span class=\"token number\">2</span>.0G   90G   <span class=\"token number\">3</span>% /code/wordpress/wp-content/uploads</pre></td></tr></table></figure><p>2. 将挂载信息加入开机自启</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/fstab</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">172.16</span>.1.32:/data/blog /code/wordpress/wp-content/uploads nfs defaults <span class=\"token number\">0</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -a</span></pre></td></tr></table></figure>",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3682494305.html",
            "url": "http://ixuyong.cn/posts/3682494305.html",
            "title": "Nginx常用模块（二）",
            "date_published": "2025-08-22T13:50:04.000Z",
            "content_html": "<h3 id=\"nginx常用模块\"><a class=\"anchor\" href=\"#nginx常用模块\">#</a> Nginx 常用模块</h3>\n<h4 id=\"1-nginx安装部署\"><a class=\"anchor\" href=\"#1-nginx安装部署\">#</a> 1. Nginx 安装部署</h4>\n<h5 id=\"11-安装nginx方式\"><a class=\"anchor\" href=\"#11-安装nginx方式\">#</a> <strong>1.1</strong> 安装 Nginx 方式</h5>\n<p>安装 Nginx 软件的方式有很多种，分为如下几种</p>\n<ul>\n<li>源码编译 =&gt;Nginx (1. 版本随意 2. 安装复杂 3. 升级繁琐)</li>\n<li>epel 仓库 =&gt;Nginx (1. 版本较低 2. 安装简单 3. 配置不易读)</li>\n<li>官方仓库 =&gt;Nginx (1. 版本较新 2. 安装简单 3. 配置易读，强烈推荐</li>\n</ul>\n<h5 id=\"12-安装nginx依赖\"><a class=\"anchor\" href=\"#12-安装nginx依赖\">#</a> <strong>1.2</strong> 安装 Nginx 依赖</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake httpd-tools</span></pre></td></tr></table></figure><h5 id=\"13-配置nginx源\"><a class=\"anchor\" href=\"#13-配置nginx源\">#</a> 1.3 配置 Nginx 源</h5>\n<p>官网 https://nginx.org -&gt; 点击 download -&gt; 点击 Pre-Built Packages-&gt; 点击 stable and mainline -&gt; 选择系统 RHEL and derivatives</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/yum.repos.d/nginx.repo </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>nginx-stable<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>nginx stable repo</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>http://nginx.org/packages/centos/<span class=\"token variable\">$releasever</span>/<span class=\"token variable\">$basearch</span>/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">gpgkey</span><span class=\"token operator\">=</span>https://nginx.org/keys/nginx_signing.key</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">module_hotfixes</span><span class=\"token operator\">=</span>true</pre></td></tr></table></figure><h5 id=\"14-安装nginx服务\"><a class=\"anchor\" href=\"#14-安装nginx服务\">#</a> <strong>1.4</strong> 安装 Nginx 服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nginx &amp;&amp; systemctl enable nginx</span></pre></td></tr></table></figure><h5 id=\"15-检查nginx版本\"><a class=\"anchor\" href=\"#15-检查nginx版本\">#</a> 1.5 检查 Nginx 版本</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 检查版本</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -v</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx version: nginx/1.26.1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 检查编译参数</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -V</span></pre></td></tr></table></figure><h4 id=\"2-nginx目录结构\"><a class=\"anchor\" href=\"#2-nginx目录结构\">#</a> 2. Nginx 目录结构</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.Nginx 主配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/etc/nginx/conf.d/default.conf    <span class=\"token comment\">#默认网站配置文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/etc/nginx/nginx.conf             <span class=\"token comment\">#nginx 主配置文件</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#2.Nginx 代理配置文件</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>/etc/nginx/fastcgi_params         <span class=\"token comment\">#Fastcgi 代理配置文件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>/etc/nginx/scgi_params            <span class=\"token comment\">#scgi 代理配置文件</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>/etc/nginx/uwsgi_params           <span class=\"token comment\">#uwsgi 代理配置文件</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#3.Nginx 编码配置文件</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>/etc/nginx/mime.types             <span class=\"token comment\">#Content-Type 与扩展名</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#4.Nginx 管理命令文件</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>/usr/sbin/nginx                   <span class=\"token comment\">#Nginx 命令行管理终端工具</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>/usr/sbin/nginx-debug             <span class=\"token comment\">#Nginx 命令行与终端调试工具</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#5.Nginxx 日志相关文件</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>/var/log/nginx                    <span class=\"token comment\">#Nginx 默认存放日志目录</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>/etc/logrotate.d/nginx            <span class=\"token comment\">#Nginx 默认的日志切割</span></pre></td></tr></table></figure><h4 id=\"3-nginx基本配置\"><a class=\"anchor\" href=\"#3-nginx基本配置\">#</a> 3. Nginx 基本配置</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># egrep -v '^#|^$' /etc/nginx/nginx.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>user  nginx<span class=\"token punctuation\">;</span>              <span class=\"token comment\">#nginx 的运行身份为 nginx 用户     </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>worker_processes  auto<span class=\"token punctuation\">;</span>   <span class=\"token comment\">#启动的 worker 进程数量</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>error_log  /var/log/nginx/error.log notice<span class=\"token punctuation\">;</span>      <span class=\"token comment\">#错误日志的路径</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pid        /var/run/nginx.pid<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#存储进程的 pid</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>events <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    worker_connections  <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">#一个 worker 最大连接数，worker_connections * worker_processes = 最大链接数</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    include       /etc/nginx/mime.types<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#支持的类型</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    default_type  application/octet-stream<span class=\"token punctuation\">;</span>  <span class=\"token comment\"># 默认类型（下载的方式）</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    log_format  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">#定义日志的格式</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    access_log  /var/log/nginx/access.log  main<span class=\"token punctuation\">;</span>   <span class=\"token comment\">#访问日志</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    sendfile        on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">#tcp_nopush     on;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    keepalive_timeout  <span class=\"token number\">65</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">#长连接超时时间</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">#gzip  on;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    include /etc/nginx/conf.d/*.conf<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#包含的子文件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"4-nginx虚拟主机\"><a class=\"anchor\" href=\"#4-nginx虚拟主机\">#</a> 4. Nginx 虚拟主机</h4>\n<p>Nginx 配置虚拟主机有如下三种方式</p>\n<ul>\n<li>1、基于主机多 IP 方式</li>\n<li>2、基于端口的配置方式</li>\n<li>3、基于多个 hosts 名称方式 (多域名方式</li>\n</ul>\n<h5 id=\"41-基于多ip虚拟主机实践\"><a class=\"anchor\" href=\"#41-基于多ip虚拟主机实践\">#</a> 4.1 基于多 IP 虚拟主机实践</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/address.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">10.0</span>.0.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlisten <span class=\"token number\">172.16</span>.1.7:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"42-基于多端口虚拟主机实践\"><a class=\"anchor\" href=\"#42-基于多端口虚拟主机实践\">#</a> 4.2 基于多端口虚拟主机实践</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/port1.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/port2.conf</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlisten <span class=\"token number\">81</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"43-基于多域名虚拟主机实践\"><a class=\"anchor\" href=\"#43-基于多域名虚拟主机实践\">#</a> 4.3 基于多域名虚拟主机实践</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"server1\" > /code/server1/index.html</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"server2\" > /code/server2/index.html</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/server1.conf</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tserver_name server1.oldxu.net<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\troot /code/server1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/server2.conf</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tserver_name server2.oldxu.net<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\troot /code/server2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"5-nginx常用模块\"><a class=\"anchor\" href=\"#5-nginx常用模块\">#</a> 5. Nginx 常用模块</h4>\n<h5 id=\"51-nginx目录索引\"><a class=\"anchor\" href=\"#51-nginx目录索引\">#</a> 5.1 Nginx 目录索引</h5>\n<p>当 ngx_http_index_module 模块找不到索引文件时，通常会将请求传递给 ngx_http_autoindex_module 模块。</p>\n<p>ngx_http_autoindex_module 模块处理以斜杠字符 ('/') 结尾的请求，并生成目录列表。</p>\n<h6 id=\"511-配置语法\"><a class=\"anchor\" href=\"#511-配置语法\">#</a> 5.1.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#启用或禁用目录列表输出，on 开启，off 关闭。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: autoindex on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: autoindex off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#指定是否应在目录列表中输出确切的文件大小，on 显示字</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>节，off显示大概单位。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Syntax: autoindex_exact_size on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Default: autoindex_exact_size on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#指定目录列表中的时间是应以本地时区还是 UTC 输出。on</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>本地时区，off UTC时间。</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Syntax: autoindex_localtime on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Default: autoindex_localtime off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><h6 id=\"512-配置示例\"><a class=\"anchor\" href=\"#512-配置示例\">#</a> 5.1.2 配置示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat mirrors.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /mirrors/repo -p</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"欢迎访问 mirrors 镜像站点！！！\" > /mirrors/index.html</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 repo<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">31367480</span> Aug <span class=\"token number\">23</span> <span class=\"token number\">21</span>:05 EVCapture_v4.2.3.exe</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root  <span class=\"token number\">1885872</span> Aug <span class=\"token number\">23</span> <span class=\"token number\">21</span>:05 Everything-1.4.1.1023.x64-Setup.exe</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">31456728</span> Aug <span class=\"token number\">23</span> <span class=\"token number\">21</span>:09 PixPin_1.7.5.0.exe</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/FGyGR7C.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"52-nginx访问控制\"><a class=\"anchor\" href=\"#52-nginx访问控制\">#</a> 5.2 Nginx 访问控制</h5>\n<p>ngx_http_access_module 模块允许限制对某些客户端地址的访问。</p>\n<h6 id=\"521-配置语法\"><a class=\"anchor\" href=\"#521-配置语法\">#</a> 5.2.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#允许配置语法</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: allow address <span class=\"token operator\">|</span> CIDR <span class=\"token operator\">|</span> unix: <span class=\"token operator\">|</span> all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location,limit_except</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#拒绝配置语法</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Syntax: deny address <span class=\"token operator\">|</span> CIDR <span class=\"token operator\">|</span> unix: <span class=\"token operator\">|</span> all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Context: http, server, location,limit_except</pre></td></tr></table></figure><h6 id=\"522-配置示例\"><a class=\"anchor\" href=\"#522-配置示例\">#</a> 5.2.2 配置示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t    <span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t    allow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t    deny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:mirrors.hmallleasing.com http://192.168.40.7/repo/</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span><span class=\"token number\">403</span> Forbidden<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">&lt;</span>center<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token number\">403</span> Forbidden<span class=\"token operator\">&lt;</span>/h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token operator\">&lt;</span>/center<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token operator\">&lt;</span>hr<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>center<span class=\"token operator\">></span>nginx/1.26.<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/center<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></pre></td></tr></table></figure><p>注意 **:deny<strong> 和</strong> allow** 的顺序是有影响的</p>\n<ul>\n<li>默认情况下，从第一条规则进行匹配</li>\n<li>如果匹配成功，则不继续匹配下面的内容。</li>\n<li>如果匹配不成功，则继续往下寻找能匹配成功的内容。</li>\n</ul>\n<h5 id=\"53-nginx基础认证\"><a class=\"anchor\" href=\"#53-nginx基础认证\">#</a> 5.3 Nginx 基础认证</h5>\n<p>ngx_http_auth_basic_module 模块允许使用 HTTP 基本身份验证，验证用户名和密码来限制对资源的访问。</p>\n<h6 id=\"531配置语法\"><a class=\"anchor\" href=\"#531配置语法\">#</a> 5.3.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#使用 HTTP 基本身份验证协议启用用户名和密码验证。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: auth_basic string<span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: auth_basic off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location,limit_except</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#指定保存用户名和密码的文件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Syntax: auth_basic_user_file <span class=\"token function\">file</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Default: -</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Context: http, server, location,limit_except</pre></td></tr></table></figure><p>指定保存用户名和密码的文件，格式如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#可以使用 htpasswd 程序或 \"openssl passwd\" 命令生成对应的密码；</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name1：passwd1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>name2：passwd2</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#使用 htpaaswd 创建新的密码文件，-c 创建新文件 -b 允许命令行输入密码</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@oldxu ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install httpd-tools</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@oldxu ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># htpasswd -b -c /etc/nginx/auth_conf xuyong 123456</span></pre></td></tr></table></figure><h6 id=\"532-配置示例\"><a class=\"anchor\" href=\"#532-配置示例\">#</a> 5.3.2 配置示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat mirrors.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t    <span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t    allow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t    deny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t    <span class=\"token comment\">#basci 认证，局部生效 </span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t    auth_basic <span class=\"token string\">\"welcome to auth_basic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t    auth_basic_user_file auth_conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"54-nginx限流限速\"><a class=\"anchor\" href=\"#54-nginx限流限速\">#</a> 5.4 Nginx 限流限速</h5>\n<h6 id=\"541-为什么要限速\"><a class=\"anchor\" href=\"#541-为什么要限速\">#</a> 5.4.1 为什么要限速</h6>\n<p>限制某个用户在一定时间内能够产生的 Http 请求。或者说限制某个用户的下载速度。</p>\n<h6 id=\"542-限速应用场景\"><a class=\"anchor\" href=\"#542-限速应用场景\">#</a> 5.4.2 限速应用场景</h6>\n<p>下载限速：限制用户下载资源的速度；</p>\n<p>ngx_http_core_module</p>\n<p>请求限制：限制用户单位时间内所产生的 Http 请求数；</p>\n<p>ngx_http_limit_req_module</p>\n<p>连接限制：限制同一时间的连接数，及并发数限制；</p>\n<p>ngx_http_limit_conn_module</p>\n<h6 id=\"543-限制请求并发数\"><a class=\"anchor\" href=\"#543-限制请求并发数\">#</a> 5.4.3 限制请求并发数</h6>\n<p>1. 语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: limit_req_zone key <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>name:size <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>rate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: http</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Syntax: limit_req zone number <span class=\"token punctuation\">[</span>burst<span class=\"token operator\">=</span>number<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>nodelay<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><p>2. 基于来源<em> IP</em> 对下载速率限制，限制每秒处理<em> 1</em> 次请求，但可以突发超过<em> 5</em> 个请求放入缓存区</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># http 标签段定义请求限制，rate 限制速率，限制一秒钟最多一个 IP 请求 $remote_addr; $binary_remote_addr</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlimit_req_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one:10m <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>1r/s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tserver_name mirror.oldxu.net<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token comment\"># 请求超过 1r/s, 剩下的将被延迟处理，请求数超过 burst 定义的数量，则返回 503</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tlimit_req <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one <span class=\"token assign-left variable\">burst</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> nodelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>limit_req_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one:10m <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>1r/s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#第一个参数：$binary_remote_addr 表示通过这个标识来做限制，限制同一客户端 ip 地址。</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#第二个参数：zone=req_one:10m 表示生成一个大小为 10M，名为 req_one 的内存区域，用来存储访问的频次信息。</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#第三个参数：rate=1r/s 表示允许相同标识的客户端的访问频次，这里限制的是每秒 1 次。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>limit_req <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one <span class=\"token assign-left variable\">burst</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> nodelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#第一个参数：zone=req_one 设置使用哪个配置区域来做限制，与上面 limit_req_zone 里的 name 对应。</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#第二个参数：burst=3，设置一个大小为 3 的缓冲区，当有大量请求过来时，超过了访问频次限制的请求可以先放到这个缓冲区内。</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#第三个参数：nodelay，超过访问频次并且缓冲区也满了的时候，则会返回 503，如果没有设置，则所有请求会等待排队。</span></pre></td></tr></table></figure><p>3. 配置示例</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#http 标签段定义请求限制，rate 限制速率，限制一秒钟最多一个 IP 请求，10m 可以存储 10*1024*1024/4=2,621,440 个 IP</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>limit_req_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one:10m <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>1r/s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\"># 请求超过 1r/s, 剩下的将被延迟处理，请求数超过 burst 定义的数量 3，则返回 503</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlimit_req <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one <span class=\"token assign-left variable\">burst</span><span class=\"token operator\">=</span><span class=\"token number\">5</span> nodelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlimit_req_status <span class=\"token number\">500</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># 请求限制状态码，默认返回 503</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t    <span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\tallow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\tdeny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token comment\">#basci 认证，局部生效 </span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tauth_basic <span class=\"token string\">\"welcome to auth_basic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\tauth_basic_user_file auth_conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"545-限制并发连接数\"><a class=\"anchor\" href=\"#545-限制并发连接数\">#</a> 5.4.5 限制并发连接数</h6>\n<p>1. 指令</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: limit_conn_zone key <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>name:size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: http</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Syntax: limit_conn zone number<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><p><em>2.<em> 设置共享内存区域和给定键值的最大允许个连接数。超过此限制时，服务器将返回</em> 503</em> 错误以回复请求</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#http 标签段定义连接限制</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>limit_conn_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>conn_od:10m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">#限制最大并发数为 20</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlimit_conn conn_od <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">#出现 503 错误，跳转到充值中心</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\terror_page <span class=\"token number\">503</span> @errpage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tlocation @errpage <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://vip.qq.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tallow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tdeny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t<span class=\"token comment\">#basci 认证，局部生效 </span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\tauth_basic <span class=\"token string\">\"welcome to auth_basic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\tauth_basic_user_file auth_conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># dd if=/dev/zero of=/mirrors/bigdata bs=500M count=1</span></pre></td></tr></table></figure><h6 id=\"546-限制下载速度\"><a class=\"anchor\" href=\"#546-限制下载速度\">#</a> 5.4.6 限制下载速度</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tcharset utf-8<span class=\"token punctuation\">;</span> <span class=\"token comment\">#设定字符集，防止中文字符乱码显示</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">#达到 100m 开始限速</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlimit_rate_after 100m<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">#限速 100K</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlimit_rate 100k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">#出现 503 错误，跳转到充值中心</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\terror_page <span class=\"token number\">503</span> @errpage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlocation @errpage <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://vip.qq.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tlocation /repo <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t        autoindex on<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#目录索引</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t        autoindex_exact_size off<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#显示单位</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            autoindex_localtime on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#指定目录列表中的时间是应以本地时区</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\tallow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tdeny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token comment\">#basci 认证，局部生效 </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tauth_basic <span class=\"token string\">\"welcome to auth_basic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tauth_basic_user_file auth_conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"547-综合场景实践\"><a class=\"anchor\" href=\"#547-综合场景实践\">#</a> 5.4.7 综合场景实践</h6>\n<ul>\n<li>1、限制 web 服务器请求数处理为 1 秒一个，触发值为 5、限制用户仅可同时下载一个文件；</li>\n<li>2、当下载超过 100M 则限制下载速度为 500k;</li>\n<li>3、如果同时下载超过 2 个视频，则返回提示 &quot;请联系 oldxu 进行会员充值&quot; | 跳转到其他页面；</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>limit_req_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one:10m <span class=\"token assign-left variable\">rate</span><span class=\"token operator\">=</span>1r/s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>limit_conn_zone <span class=\"token variable\">$binary_remote_addr</span> <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>conn_od:10m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\troot /mirrors<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\"># 请求超过 1r/s, 剩下的将被延迟处理，请求数超过 burst 定义的数量 5，则返回 503</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlimit_req <span class=\"token assign-left variable\">zone</span><span class=\"token operator\">=</span>req_one <span class=\"token assign-left variable\">burst</span><span class=\"token operator\">=</span><span class=\"token number\">5</span> nodelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">#限制最大并发数为 2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlimit_conn conn_od <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">#达到 100m 开始限速</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tlimit_rate_after 100m<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">#限速 100K</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlimit_rate 500k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">#出现 503 错误，跳转到充值中心</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\terror_page <span class=\"token number\">503</span> @errpage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tlocation @errpage <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://vip.qq.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"55-nginx状态监控\"><a class=\"anchor\" href=\"#55-nginx状态监控\">#</a> 5.5 Nginx 状态监控</h5>\n<p>ngx_http_stub_status_module 模块提供对基本状态信息的访问。</p>\n<p>默认情况下不集成该模块，需要使用 --with-http_stub_status_module 集成。</p>\n<h6 id=\"551-配置语法\"><a class=\"anchor\" href=\"#551-配置语法\">#</a> 5.5.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: stub_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Default: —</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Context: server, location</pre></td></tr></table></figure><h6 id=\"552-配置示例\"><a class=\"anchor\" href=\"#552-配置示例\">#</a> 5.5.2 配置示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/mirrors.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name mirrors.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t        index index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tlocation /nginx_status <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tstub_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">#访问控制</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        allow <span class=\"token number\">192.168</span>.40.1/32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        deny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"553-页面状态\"><a class=\"anchor\" href=\"#553-页面状态\">#</a> 5.5.3 页面状态</h6>\n<p>此配置创建一个简单的网页，其基本状态数据可能如下所示</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:mirrors.hmallleasing.com http://192.168.40.7/nginx_status</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Active connections: <span class=\"token number\">1</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server accepts handled requests</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token number\">20</span> <span class=\"token number\">20</span> <span class=\"token number\">42</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Reading: <span class=\"token number\">0</span> Writing: <span class=\"token number\">1</span> Waiting: <span class=\"token number\">0</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># Active connections：当前活跃连接数，包括 Waiting 等待连接数。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># accepts： 已接收的总 TCP 连接数量。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># handled： 已处理的 TCP 连接数量。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># requests： 当前总 http 请求数量。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># Reading： 当前读取的请求头数量。</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># Writing： 当前响应的请求头数量。</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># Waiting： 当前等待请求的空闲客户端连接数。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 mirrors<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -s -HHost:mirrors.hmallleasing.com http://192.168.40.7/nginx_status|awk -F ':' 'NR==1 &#123;print $NF&#125;'</span></pre></td></tr></table></figure><h5 id=\"56-nginx资源压缩\"><a class=\"anchor\" href=\"#56-nginx资源压缩\">#</a> 5.6 Nginx 资源压缩</h5>\n<p>Nginx 将发送至客户端之前的数据进行压缩，然后传输，这能够有效地节约带宽，并提高响应速度；</p>\n<h6 id=\"561-配置语法\"><a class=\"anchor\" href=\"#561-配置语法\">#</a> 5.6.1 配置语法</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1、启用或关闭 gzip 压缩</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: <span class=\"token function\">gzip</span> on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: <span class=\"token function\">gzip</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location, <span class=\"token keyword\">if</span> <span class=\"token keyword\">in</span> location</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 2、gzip 支持的压缩类型</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Syntax: gzip_types mime-type <span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Default: gzip_types text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 3、gzip 压缩比率，压缩率越高，CPU 消耗越大 9</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Syntax: gzip_comp_level level<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Default: gzip_comp_level <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 4、gzip 压缩的最小文件，小于设置的值文件将不会被压</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>缩（由<span class=\"token string\">\"Content-Length\"</span>响应头字段确定）</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Syntax: gzip_min_length length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Default: gzip_min_length <span class=\"token number\">20</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 5、gzip 压缩支持的协议版本</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Syntax: gzip_http_version <span class=\"token number\">1.0</span> <span class=\"token operator\">|</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Default: gzip_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Context: http, server, location</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 6、启用压缩，是否在响应报文首部插入 \"Vary:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Accept-Encoding\"</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Syntax: gzip_vary on <span class=\"token operator\">|</span> off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Default: gzip_vary off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>Context: http, server, location</pre></td></tr></table></figure><h6 id=\"562-图片压缩案例\"><a class=\"anchor\" href=\"#562-图片压缩案例\">#</a> 5.6.2 图片压缩案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/images</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat static.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name static.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code/images<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation ~* .*<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>jpg<span class=\"token operator\">|</span>gif<span class=\"token operator\">|</span>png<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token function\">gzip</span> on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\tgzip_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tgzip_comp_level <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\tgzip_min_length 10k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\tgzip_types image/jpeg image/gif image/png<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tgzip_vary on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"563-文件压缩案例\"><a class=\"anchor\" href=\"#563-文件压缩案例\">#</a> 5.6.3 文件压缩案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/doc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat static.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver_name static.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\troot /code/doc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation ~ .*<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>txt<span class=\"token operator\">|</span>pdf<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token function\">gzip</span> on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\tgzip_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tgzip_comp_level <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\tgzip_min_length 10k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\tgzip_types text/plain application/pdf<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tgzip_vary on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h5 id=\"57-nginx-location\"><a class=\"anchor\" href=\"#57-nginx-location\">#</a> 5.7 Nginx Location</h5>\n<p>Location 用来控制访问网站的 uri 路径。</p>\n<h6 id=\"571-location语法示例\"><a class=\"anchor\" href=\"#571-location语法示例\">#</a> 5.7.1 Location 语法示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>location <span class=\"token punctuation\">[</span> <span class=\"token operator\">=</span> <span class=\"token operator\">|</span> ~ <span class=\"token operator\">|</span> ~* <span class=\"token operator\">|</span> ^~ <span class=\"token punctuation\">]</span> uri <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>location @name <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/api/xxx/dadas/dsadsa</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/apiv1/dsa/dsaxx/sadsa/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 匹配符 匹配规则 优先级</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># = 精确匹配 1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># ^~ 以某个字符串开头 2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># ~ 区分大小写的正则匹配 3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># ~* 不区分大小写的正则匹配 4</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># / 通用匹配，任何请求都会匹配到 5</span></pre></td></tr></table></figure><h6 id=\"572-location优先级示例\"><a class=\"anchor\" href=\"#572-location优先级示例\">#</a> 5.7.2 Location 优先级示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat location.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name location.oldxu.net<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tlocation <span class=\"token operator\">=</span> / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location = /'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location /'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tlocation /documents/ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location /documents/'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tlocation ^~ /images/ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location ^~ /images/'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tlocation ~* <span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>gif<span class=\"token operator\">|</span>jpg<span class=\"token operator\">|</span>jpeg<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'location ~* \\.(gif|jpg|jpeg)'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#测试结果如下 (建议是 curl 测试)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">#1. 请求 http://location.hmallleasing.com/ 会被 location =/ 匹配</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">#2. 请求 http://location.hmallleasing.com/index.html 会被 location / 匹配</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">#3. 请求 http://location.hmallleasing.com/documents/1.html 会被 location /documents/ 匹配</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">#4. 请求 http://location.hmallleasing.com/images/1.gif 会被 location ^~ /images/ 匹配</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">#5. 请求 http://location.hmallleasing.com/documents/1.jpg 会被 location ~* \\.(gif|jpg|jpeg)$ 匹配</span></pre></td></tr></table></figure><h6 id=\"573-location应用场景\"><a class=\"anchor\" href=\"#573-location应用场景\">#</a> 5.7.3 Location 应用场景</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat location2.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name location2.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        charset utf-8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\"># 通用匹配，任何请求都会匹配到</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\troot html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\"># 精准匹配，必须请求的 uri 是 /nginx_status</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tlocation <span class=\"token operator\">=</span> /nginx_status <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tstub_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\"># 严格区分大小写，匹配以.php 结尾的都走这个 location info.php</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'php访问成功'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\"># 严格区分大小写，匹配以.jsp 结尾的都走这个 location</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.jsp$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'jsp访问成功'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\"># 不区分大小写匹配，只要用户访问.jpg,gif,png,js,css 都走这条 location</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tlocation ~* <span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>jpg<span class=\"token operator\">|</span>gif<span class=\"token operator\">|</span>png<span class=\"token operator\">|</span>js<span class=\"token operator\">|</span>css<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token comment\"># return 403;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\texpires 3d<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\"># 不区分大小写匹配</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tlocation ~* <span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>sql<span class=\"token operator\">|</span>bak<span class=\"token operator\">|</span>tgz<span class=\"token operator\">|</span>tar.gz<span class=\"token operator\">|</span>.git<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tdeny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'禁止访问！！！'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"574-location-重定向\"><a class=\"anchor\" href=\"#574-location-重定向\">#</a> 5.7.4 Location @重定向</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat location3.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver_name location3.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">#error_page 400 403 404 error.html;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">#如果出现异常，则重新定向到 @error_404 这个 location 上</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\terror_page <span class=\"token number\">404</span> @error_404<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tlocation @error_404 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tdefault_type text/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">#\treturn 200 ' 你可能是不小心走丢了。';</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> http://<span class=\"token variable\">$server_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"58-nginx日志模块\"><a class=\"anchor\" href=\"#58-nginx日志模块\">#</a> 5.8 Nginx 日志模块</h5>\n<p>Nginx 的日志记录非常灵活，可以通过 log_format 来定义格式。</p>\n<h6 id=\"581-nginx日志格式\"><a class=\"anchor\" href=\"#581-nginx日志格式\">#</a> 5.8.1 Nginx 日志格式</h6>\n<p>1.log_format 定义日志格式语法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置语法：包括: error.log access.log</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Syntax: log_format name <span class=\"token punctuation\">[</span>escape<span class=\"token operator\">=</span>default<span class=\"token operator\">|</span>json<span class=\"token punctuation\">]</span> string <span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: log_format combined <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http</pre></td></tr></table></figure><p>2. 默认 Nginx 定义语法格式如下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>log_format main <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t\t\t\t<span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t\t\t<span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>log_format <span class=\"token builtin class-name\">test</span> <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span><span class=\"token variable\">$status</span><span class=\"token string\">';</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>log_format test '</span><span class=\"token variable\">$remote_addr</span> - <span class=\"token variable\">$remote_user</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$time_local</span><span class=\"token punctuation\">]</span> <span class=\"token string\">\"<span class=\"token variable\">$request</span>\"</span> <span class=\"token string\">'</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t\t'</span><span class=\"token variable\">$status</span> '<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#access_log</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/var/log/nginx/access.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#access_log</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>/var/log/nginx/access_test.log <span class=\"token builtin class-name\">test</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><em>3.Nginx</em> 日志格式中常用的变量</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$remote_addr</span> <span class=\"token comment\"># 记录客户端 IP 地址</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token variable\">$remote_user</span> <span class=\"token comment\"># 记录客户端用户名</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token variable\">$time_local</span> <span class=\"token comment\"># 记录通用的本地时间</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token variable\">$time_iso8601</span> <span class=\"token comment\"># 记录 ISO8601 标准格式下的本地时间</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token variable\">$request</span> <span class=\"token comment\"># 记录请求的方法以及请求的 http 协议</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token variable\">$status</span> <span class=\"token comment\"># 记录请求状态码 (用于定位错误信息)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token variable\">$body_bytes_sent</span> <span class=\"token comment\"># 发送给客户端的资源字节数，不包括响应头的大小</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token variable\">$bytes_sent</span> <span class=\"token comment\"># 发送给客户端的总字节数</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token variable\">$msec</span> <span class=\"token comment\"># 日志写入时间。单位为秒，精度是毫秒。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token variable\">$http_referer</span> <span class=\"token comment\"># 记录从哪个页面链接访问过来的</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token variable\">$http_user_agent</span> <span class=\"token comment\"># 记录客户端浏览器相关信息</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token variable\">$http_x_forwarded_for</span> <span class=\"token comment\">#记录客户端 IP 地址</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token variable\">$request_length</span> <span class=\"token comment\"># 请求的长度（包括请求行，请求头和请求正文）。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token variable\">$request_time</span> <span class=\"token comment\"># 请求花费的时间，单位为秒，精度毫秒</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 注：如果 Nginx 位于负载均衡器，nginx 反向代理之后，web 服务器无法直接获取到客户端真实的 IP 地址。</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># $remote_addr 获取的是反向代理的 IP 地址。反向代理服务器在转发请求的 http 头信息中。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 增加 X-Forwarded-For 信息，用来记录客户端 IP 地址和客户端请求的服务器地址。</span></pre></td></tr></table></figure><h6 id=\"582-nginx访问日志\"><a class=\"anchor\" href=\"#582-nginx访问日志\">#</a> 5.8.2 Nginx 访问日志</h6>\n<p>1.web 服务器的访问日志是非常重要的，我们可以通过访问日志来分析用户的访问情况，也可以通过访问日志发现一些异常访问。access_log 日志配置语法。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Syntax: access_log path <span class=\"token punctuation\">[</span>format <span class=\"token punctuation\">[</span>buffer<span class=\"token operator\">=</span>size<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>gzip<span class=\"token punctuation\">[</span><span class=\"token operator\">=</span>level<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>flush<span class=\"token operator\">=</span>time<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>if<span class=\"token operator\">=</span>condition<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>access_log off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Default: access_log logs/access.log combined<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Context: http, server, location, <span class=\"token keyword\">if</span> <span class=\"token keyword\">in</span> location, limit_except</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\taccess_log /var/log/nginx/access.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            access_log /var/log/nginx/test.hmallleasing.com.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   \t\t\t\taccess_log /var/log/nginx/test.hmallleasing.com.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            location /admin <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2.Nginx 访问日志配置示例</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\tserver_name log.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token comment\"># 将当前的 server 网站的访问日志记录至对应的目录，使用 main 格式</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\taccess_log /var/log/nginx/log.hmallleasing.com.log main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"583-nginx错误日志\"><a class=\"anchor\" href=\"#583-nginx错误日志\">#</a> 5.8.3 Nginx 错误日志</h6>\n<p>Nginx 常见的错误日志级别有 debug | info | notice| warn | error | crit | alert | emerg 级别越高记录的信息越少，如果不定义，默认级别为 warn，它可以配置在 main、http、server、location 段里</p>\n<p>Nginx 错误日志示例：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>error_log /var/log/nginx/error.log warn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 关闭错误日志</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>error_log /dev/null<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h6 id=\"584-nginx日志过滤\"><a class=\"anchor\" href=\"#584-nginx日志过滤\">#</a> 5.8.4 Nginx 日志过滤</h6>\n<p>一个网站会包含很多元素，尤其是有大量的 images、js、css 等静态资源。这样的请求可以不用记录日志。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#请求 favicon.ico 时，不记录日志</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>location /favicon.ico <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\taccess_log off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#或，当有人访问 gif、png 等资源时，将日志丢入空</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>location ~* .*<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">(</span>gif<span class=\"token operator\">|</span>jpg<span class=\"token operator\">|</span>png<span class=\"token operator\">|</span>css<span class=\"token operator\">|</span>js<span class=\"token punctuation\">)</span>$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\taccess_log /dev/null<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "Nginx"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1697351306.html",
            "url": "http://ixuyong.cn/posts/1697351306.html",
            "title": "Nginx基础Http协议（一）",
            "date_published": "2025-08-22T13:44:55.000Z",
            "content_html": "<h3 id=\"nginx基础http协议\"><a class=\"anchor\" href=\"#nginx基础http协议\">#</a> Nginx 基础 Http 协议</h3>\n<h4 id=\"1http协议介绍\"><a class=\"anchor\" href=\"#1http协议介绍\">#</a> 1.Http 协议介绍</h4>\n<h5 id=\"11-什么是url\"><a class=\"anchor\" href=\"#11-什么是url\">#</a> <strong>1.1</strong> 什么是 URL</h5>\n<p>通常我们在访问一个网站页面时，请求到的内容通称为 &quot;资源&quot;。而 “资源 “这一概念非常宽泛，它可以是一份文档，一张图片，或所有其他你能够想到的格式。每个资源都由一个 URI 来进行标识；比如: <a href=\"http://fj.ixuyong.cn/public/tt.jpeg%E8%BF%99%E6%A0%B7%E7%9A%84%E8%B5%84%E6%BA%90%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E5%B0%86%E8%AF%A5%E5%85%B6%E7%A7%B0%E4%B8%BAURL%E5%9C%B0%E5%9D%80%EF%BC%9B%E7%99%BE%E5%BA%A6%E7%99%BE%E7%A7%91%E8%A7%A3%E9%87%8A%EF%BC%9AURL%E7%AE%80%E7%A7%B0%E7%BB%9F%E4%B8%80%E8%B5%84%E6%BA%90%E5%AE%9A%E4%BD%8D%E7%AC%A6%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%94%AF%E4%B8%80%E5%9C%B0%E6%A0%87%E8%AF%86%E4%B8%87%E7%BB%B4%E7%BD%91%E4%B8%AD%E7%9A%84%E6%9F%90%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E3%80%82URL%E7%94%B1%E5%8D%8F%E8%AE%AE%E3%80%81%E4%B8%BB%E6%9C%BA%E5%90%8D%E7%A7%B0%E3%80%81%E7%AB%AF%E5%8F%A3%E4%BB%A5%E5%8F%8A%E6%96%87%E4%BB%B6%E5%90%8D%E5%87%A0%E9%83%A8%E5%88%86%E6%9E%84%E6%88%90%E3%80%82\">http://fj.ixuyong.cn/public/tt.jpeg 这样的资源，我们会将该其称为 URL 地址；百度百科解释：URL 简称统一资源定位符，用来唯一地标识万维网中的某一个资源。URL 由协议、主机名称、端口以及文件名几部分构成。</a></p>\n<h5 id=\"12-什么是html\"><a class=\"anchor\" href=\"#12-什么是html\">#</a> <strong>1.2</strong> 什么是 HTML</h5>\n<p>Html 简称 Web Page，一个完整的 Html 页面可能会包含很多个 URL 的资源。(反之：我们也可以理解一个 HTML 文件是由多个不同的 URL 资源拼接而成的。)</p>\n<h5 id=\"13-什么是http\"><a class=\"anchor\" href=\"#13-什么是http\">#</a> <strong>1.3</strong> 什么是 HTTP</h5>\n<p>HTTP (Hyper Text Transfer Protocol) 中文名为超文本传输协议。是一种能够获取如 HTML 这样网络资源的通讯协议。它是在 Web 上进行数据交换的基础。HTTP 的概述参考 URL 简单理解：HTTP 协议就是将用户请求的 HTML 页面从一台 Web 服务器传输到客户端浏览器的一种协议。</p>\n<h5 id=\"14-url-html-http之间关系\"><a class=\"anchor\" href=\"#14-url-html-http之间关系\">#</a> 1.4 URL、HTML、HTTP 之间关系</h5>\n<p>一个完整的 HTML 页面是由多个不同的 Url 资源组成的；而 HTTP 协议主要是用来传输这种 HTML 页面的；</p>\n<h4 id=\"2http工作原理\"><a class=\"anchor\" href=\"#2http工作原理\">#</a> 2.Http 工作原理</h4>\n<h5 id=\"21-图解http工作原理\"><a class=\"anchor\" href=\"#21-图解http工作原理\">#</a> 2.1 图解 HTTP 工作原理</h5>\n<p>我们详细的了解下 HTTP 的工作原理，我们到底是如何获取到服务器上的页面。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/5p0uvcC.png\" alt=\"3.png\" /></p>\n<h5 id=\"22-http工作原理总结\"><a class=\"anchor\" href=\"#22-http工作原理总结\">#</a> 2.2 HTTP 工作原理总结</h5>\n<p>整个用户访问网站过程就是 DNS-TCP-HTTP</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Lwnt1Bw.png\" alt=\"2.png\" /></p>\n<h4 id=\"3http请求request\"><a class=\"anchor\" href=\"#3http请求request\">#</a> 3.Http 请求 Request</h4>\n<p>HTTP 请求的一个例子：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/InbGStI.png\" alt=\"4.png\" /></p>\n<h5 id=\"31-请求method\"><a class=\"anchor\" href=\"#31-请求method\">#</a> 3.1 请求 Method</h5>\n<p>客户端向服务端发送请求时，会根据不同的资源发送不同的请求方法 Method：</p>\n<ul>\n<li>GET：用于获取 URI 对应的资源；（比如看朋友圈)</li>\n<li>POST：用于提交请求，可以更新或者创建资源，是非幂等的；（发布朋友圈）</li>\n<li>PUT：用于向指定的 URI 传送更新资源，是幂等的；（更新朋友圈）</li>\n<li>DELETE：用于向指定的 URI 删除资源；（比如删朋友圈）</li>\n<li>HEAD：用于检查 (仅获取 Header 部分的内容)；</li>\n</ul>\n<p>一般创建对象时用 POST，更新对象时用 PUT；</p>\n<ul>\n<li>PUT 是幂等的，POST 是非幂等的；</li>\n<li>幂等：对于相同的输入，每次得到的结果都是相等的；</li>\n</ul>\n<h5 id=\"32-请求header\"><a class=\"anchor\" href=\"#32-请求header\">#</a> 3.2 请求 Header</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>:authority: www.xuliangwei.com</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>:method: GET</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>:path: /</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>:scheme: https</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Accept: text/html,  <span class=\"token comment\"># 请求的类型</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Accept-Encoding: gzip, deflate  <span class=\"token comment\"># 是否进行压缩</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Accept-Language: zh-CN,zh<span class=\"token punctuation\">;</span><span class=\"token assign-left variable\">q</span><span class=\"token operator\">=</span><span class=\"token number\">0.9</span> <span class=\"token comment\"># 请求的语言</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Cache-Control: max-age<span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token comment\"># 缓存</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Connection: keep-alive   <span class=\"token comment\"># TCP 长连接</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Host: www.oldboyedu.com  <span class=\"token comment\"># 请求的域名</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>If-Modified-Since: Fri, 04 May <span class=\"token number\">201808</span>:13:44 GMT  <span class=\"token comment\"># 修改的时间</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>User-Agent: Mozilla/5.0  <span class=\"token comment\"># 请求浏览器的工具</span></pre></td></tr></table></figure><h5 id=\"33-请求connection\"><a class=\"anchor\" href=\"#33-请求connection\">#</a> <strong>3.3</strong> 请求 Connection</h5>\n<p>Http 请求中的长连接与短连接是什么：</p>\n<ul>\n<li>http1.0 协议使用的是短连接：建立一次 tcp 的连接，发起一次 http 的请求，结束，tcp 断开。</li>\n<li>http1.1 协议使用的是长连接：建立一次 tcp 的连接，发起多次 http 的请求，结束，tcp 断开。</li>\n<li>HTTP 协议版本参考下图，HTTP1.0 使用的是短连接，HTTP1.1 串行连接，与 HTTP2.0 并行连接。</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/bQERRRT.png\" alt=\"5.png\" /></p>\n<h4 id=\"4http响应response\"><a class=\"anchor\" href=\"#4http响应response\">#</a> 4.Http 响应 Response</h4>\n<p>HTTP 响应的一个例子：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/hX37K32.png\" alt=\"6.png\" /></p>\n<h5 id=\"41-响应header\"><a class=\"anchor\" href=\"#41-响应header\">#</a> 4.1 响应 Header</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HTTP/1.1 <span class=\"token number\">200</span> OK        <span class=\"token comment\"># 返回服务器的 http 协议，状态码</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Date: Fri, <span class=\"token number\">14</span> Sep <span class=\"token number\">2018</span> 09:14:28 GMT  <span class=\"token comment\"># 返回服务器的时间</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Server: Apache/2.4.6   <span class=\"token comment\"># 返回服务器使用的软件 Apache</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Connection: Keep-Alive <span class=\"token comment\"># TCP 长连接</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Keep-Alive: <span class=\"token assign-left variable\">timeout</span><span class=\"token operator\">=</span><span class=\"token number\">5</span>, <span class=\"token assign-left variable\">max</span><span class=\"token operator\">=</span><span class=\"token number\">100</span>  <span class=\"token comment\"># 长连接的超时时间</span></pre></td></tr></table></figure><h5 id=\"42-响应code\"><a class=\"anchor\" href=\"#42-响应code\">#</a> 4.2 响应 Code</h5>\n<p>http 响应状态码 Status-Code 以 3 位数字组成，用来标识该请求是否成功，比如是正常还是错误等。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">Code</th>\n<th style=\"text-align:left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">200</td>\n<td style=\"text-align:left\">表示成功客户端成功接收到了服务端返回的数据，这是最常见的状态码</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">206</td>\n<td style=\"text-align:left\">客户端发完请求后，服务端只是返回了部分数据，就会出现该状态码，例如当下载一个很大的文件时，在没有下载完成前就会出现该状态码</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">301</td>\n<td style=\"text-align:left\">永久重定向 (redirect) http--&gt;https</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">302</td>\n<td style=\"text-align:left\">临时重定向 (redirect)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">400</td>\n<td style=\"text-align:left\">客户端请求语法错误，服务端无法理解</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">401</td>\n<td style=\"text-align:left\">服务端开启了用户认证，而客户端没有提供正确的验证信息</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">403</td>\n<td style=\"text-align:left\">服务端不允许客户端访问，或者没有找到默认返回页面 (默认所有的 web 服务器返回的页面都是 index.html、也可以调整默认返回页面 app.html)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">404</td>\n<td style=\"text-align:left\">客户端请求的资源不存在 （路径写错了；服务端真的没有；）</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">413</td>\n<td style=\"text-align:left\">客户端向服务端上传一个比较大的文件，并且文件大小超过了服务端的限制 1MB；</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">500</td>\n<td style=\"text-align:left\">服务端出现了内部错误，需要进行人为排查故障 （链接数据库类服务异常，会出现 500 错误）</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">502</td>\n<td style=\"text-align:left\">服务器充当代理角色时，后端被代理的服务器不可用或者没有正常回应</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">503</td>\n<td style=\"text-align:left\">服务当前不可用，由于超载或系统维护，服务器暂时的无法处理客户端请求</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">504</td>\n<td style=\"text-align:left\">服务器充当代理角色时，后端的服务端没有按时返回数据，超时了</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"5http相关术语\"><a class=\"anchor\" href=\"#5http相关术语\">#</a> 5.Http 相关术语</h4>\n<h5 id=\"51-什么是pv\"><a class=\"anchor\" href=\"#51-什么是pv\">#</a> <strong>5.1</strong> 什么是 PV</h5>\n<p>PV 即页面浏览量：比如用户访问一个网站算 1 个 pv，刷新一次页面则累计 pv+1，如果多次打开或刷新同一页面则浏览量累计。</p>\n<h5 id=\"52-什么是uv\"><a class=\"anchor\" href=\"#52-什么是uv\">#</a> 5.2 什么是 UV</h5>\n<p>UV 即独立访客，访问网站的一台电脑客户端为一个访客。可以理解成访问某网站的电脑的数量。比如电脑、手机算 2 个 UV，无论访问多少次网站，最终 UV 数量就是 2。</p>\n<h5 id=\"53-什么是ip\"><a class=\"anchor\" href=\"#53-什么是ip\">#</a> 5.3 什么是 IP</h5>\n<p>IP 即独立公网 IP 数，是指 1 天内多少个独立的 IP 浏览了页面，比如你在家通过拨号上网访问某个网站，此时网站会记录你的公网 IP 地址。那如果你在公司和很多同事同时访问一个网站，那该网站会记录多少个公网 IP 呢？（看公司有多少个出口公网地址）</p>\n<h5 id=\"54-什么是并发\"><a class=\"anchor\" href=\"#54-什么是并发\">#</a> 5.4 什么是并发</h5>\n<p>并发：指的是同时，我们可以理解为一段时间内 (比如 10 秒)，网站支持同时访问的人数，假设 10s 并发值如果为 500 时，一天能达到多少 PV？ 500 * 6 * 60 * 24 =4320000</p>\n",
            "tags": [
                "Nginx"
            ]
        }
    ]
}