{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"lvs\" category",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/1598774589.html",
            "url": "http://ixuyong.cn/posts/1598774589.html",
            "title": "负载均衡LVS入门与实践",
            "date_published": "2025-06-20T14:28:55.000Z",
            "content_html": "<h3 id=\"负载均衡lvs入门与实践\"><a class=\"anchor\" href=\"#负载均衡lvs入门与实践\">#</a> 负载均衡 LVS 入门与实践</h3>\n<h4 id=\"一-安装mysql57\"><a class=\"anchor\" href=\"#一-安装mysql57\">#</a> 一、 安装 MySQL5.7</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、下载 MySQL 官方扩展源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ivh http://repo.mysql.com/yum/mysql-5.7-community/el/7/x86_64/mysql57-community-release-el7-10.noarch.rpm</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2、安装 mysql5.7，文件过大可能会导致下载缓慢</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mysql-community-server -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、启动并加入开机自动启动</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4、查看端口是否启动</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:22              <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">3788</span>/sshd           </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:25            <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">4018</span>/master         </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::3306                 :::*                    LISTEN      <span class=\"token number\">4628</span>/mysqld         </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::22                   :::*                    LISTEN      <span class=\"token number\">3788</span>/sshd           </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> ::1:25                  :::*                    LISTEN      <span class=\"token number\">4018</span>/master </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#5、由于 mysql5.7 默认配置密码，需要过滤 temporary password 关键字查看对应登陆数据库密码</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># grep 'temporary password' /var/log/mysqld.log</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#6、登录 mysql 数据库 [password 中填写上一步过滤的密码]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#6、重新修改数据库密码</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'app'</span>@<span class=\"token string\">'192.168.40.%'</span> identified by <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"二-nfs服务部署\"><a class=\"anchor\" href=\"#二-nfs服务部署\">#</a> 二、 NFS 服务部署</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.NFS 服务安装</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install nfs-utils</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2.NFS 服务配置</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/exports</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>/data <span class=\"token number\">192.168</span>.40.0/24<span class=\"token punctuation\">(</span>rw,sync,all_squash,anonuid<span class=\"token operator\">=</span><span class=\"token number\">666</span>,anongid<span class=\"token operator\">=</span><span class=\"token number\">666</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#3.NFS 服务初始化</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /data/</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#4.NFS 服务启动</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nfs-server &amp;&amp; systemctl start nfs-server</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#5. 客户端挂载 NFS</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>客户端也创建一个uid为666，gid为666，统一身份，避免后续出现权限不足的情况</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup mnt<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup mnt<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -g 666 -u 666 www</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install nfs-utils</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># showmount -e 192.168.40.103</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.40.103:/data /data</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#6. 客户端永久挂载 NFS</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/fstab 192.168.40.103:/data /data nfs defaults 0 0</span></pre></td></tr></table></figure><h4 id=\"三-部署web01\"><a class=\"anchor\" href=\"#三-部署web01\">#</a> 三、 部署 web01</h4>\n<h5 id=\"31-部署nginx\"><a class=\"anchor\" href=\"#31-部署nginx\">#</a> 3.1 部署 Nginx</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.Nginx 安装</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 Nginx 进程运行用户</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g666 www</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u666 -g666 www</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user www;' /etc/nginx/nginx.conf</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#3. 启动 Nginx，并将 Nginx 加入开机自启</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nginx &amp;&amp; systemctl start nginx</span></pre></td></tr></table></figure><h5 id=\"32-部署php71\"><a class=\"anchor\" href=\"#32-部署php71\">#</a> 3.2 部署 PHP7.1</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、移除旧版 php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum remove php-mysql-5.4 php php-fpm php-common</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2.2 安装扩展源</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum localinstall https://mirror.webtatic.com/yum/el7/webtatic-release.rpm -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、安装 php7.1 版本</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4、启动 php</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^group/c group = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start php-fpm &amp;&amp; systemctl enable php-fpm</span></pre></td></tr></table></figure><h4 id=\"四-部署web02\"><a class=\"anchor\" href=\"#四-部署web02\">#</a> 四、部署 web02</h4>\n<h5 id=\"41-部署nginx\"><a class=\"anchor\" href=\"#41-部署nginx\">#</a> 4.1 部署 Nginx</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.Nginx 安装</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 Nginx 进程运行用户</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">groupadd</span> <span class=\"token parameter variable\">-g666</span> www</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">useradd</span> <span class=\"token parameter variable\">-u666</span> <span class=\"token parameter variable\">-g666</span> www</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'/^user/c user www;'</span> /etc/nginx/nginx.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#3. 启动 Nginx，并将 Nginx 加入开机自启</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nginx &amp;&amp; systemctl start nginx</span></pre></td></tr></table></figure><h5 id=\"42-部署php71\"><a class=\"anchor\" href=\"#42-部署php71\">#</a> 4.2 部署 PHP7.1</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 移除旧版 php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum remove php-mysql-5.4 php php-fpm php-common</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 安装扩展源</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum localinstall https://mirror.webtatic.com/yum/el7/webtatic-release.rpm -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3. 安装 php7.1 版本</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4. 启动 php</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^group/c group = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start php-fpm &amp;&amp; systemctl enable php-fpm</span></pre></td></tr></table></figure><h4 id=\"五-部署博客wecenter\"><a class=\"anchor\" href=\"#五-部署博客wecenter\">#</a> 五、  部署博客 WeCenter</h4>\n<h5 id=\"51-web01配置\"><a class=\"anchor\" href=\"#51-web01配置\">#</a> 5.1 web01 配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改 nginx 反代参数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>proxy_send_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#2. 修改 nginx 配置文件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat zh.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tserver_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\troot /code/zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tfastcgi_pass   <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tfastcgi_param  SCRIPT_FILENAME  <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tfastcgi_param HTTPS on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#支持前端用 https, 后端用 http</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tinclude        fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#3. 创建网站目录</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/zh</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">#4. 重启 nginx 服务</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#5. 获取 WeCenter 代码</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://cn.wordpress.org/wordpress-4.9.4-zh_CN.tar.g</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">#6. 解压网站源码文件，拷贝至对应站点目录，并授权站点目录</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf wordpress-4.9.4-zh_CN.tar.gz </span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /code/zh/uploads/</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp uploads/* root@192.168.1.116:/data/zh</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /code/zh</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\">#7. 由于 wordpress 产品需要依赖数据库，所以需要手动建立数据库</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token comment\">#1. 登陆数据库</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\">#8. 创建 wordpress 数据库</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>mysql<span class=\"token operator\">></span> create database wordpress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'app'</span>@<span class=\"token string\">'192.168.1.%'</span> identified by <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token comment\">#9. 通过浏览器访问 wordpress, 并部署该产品</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>http://zh.hmallleasing.com</pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token comment\">#10. 获取 Wordpress 产品的附件和图片存放的位置</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>浏览器-<span class=\"token operator\">></span>右键-<span class=\"token operator\">></span>检查-<span class=\"token operator\">></span>Network-<span class=\"token operator\">></span>选择按钮-<span class=\"token operator\">></span>点击一下图片</pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token comment\">#11. 挂载 NFS</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.1.116:/data/zh /code/zh/uploads</span></pre></td></tr></table></figure><h5 id=\"52-web02配置\"><a class=\"anchor\" href=\"#52-web02配置\">#</a> 5.2 web02 配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改 nginx 配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp zh.hmallleasing.com.conf root@192.168.1.118:/etc/nginx/conf.d/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp /etc/nginx/proxy_params root@192.168.1.118:/etc/nginx</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#2. 创建网站目录</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zh -p</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#3. 重启 nginx 服务</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#4. 获取 wordpress 代码</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp /code/zh/* root@192.168.1.118:/code/zh/</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /code/zh</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#5. 获取 Wordpress 产品的附件和图片存放的位置</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>浏览器-<span class=\"token operator\">></span>右键-<span class=\"token operator\">></span>检查-<span class=\"token operator\">></span>Network-<span class=\"token operator\">></span>选择按钮-<span class=\"token operator\">></span>点击一下图片</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#6. 挂载 NFS</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.1.116:/data/zh /code/zh/uploads</span></pre></td></tr></table></figure><h4 id=\"六-配置七层负载均衡\"><a class=\"anchor\" href=\"#六-配置七层负载均衡\">#</a> 六、配置七层负载均衡</h4>\n<h5 id=\"61-配置lb01\"><a class=\"anchor\" href=\"#61-配置lb01\">#</a> 6.1 配置 Lb01</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改 nginx 配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat zh.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream zh <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        server <span class=\"token number\">192.168</span>.1.117:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        server <span class=\"token number\">192.168</span>.1.118:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        server_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_certificate  /etc/nginx/sslkey/*.hmallleasing.com_chain.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate_key  /etc/nginx/sslkey/*.hmallleasing.com_key.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                proxy_pass http://zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                include proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    server_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#2. 修改 nginx 反代参数</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_params </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>proxy_send_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#3. 上传 nginx 证书</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/sslkey</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /etc/nginx/sslkey/</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>*.hmallleasing.com_chain.crt</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>*.hmallleasing.com_key.key</pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">#4. 重启 nginx</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h5 id=\"62-vip和arp抑制脚本\"><a class=\"anchor\" href=\"#62-vip和arp抑制脚本\">#</a> 6.2 VIP 和 Arp 抑制脚本</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat lvs_rs.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/usr/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">VIP</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">DEV</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token variable\">$1</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\"># ARP 抑制</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\"># VIP</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">cat</span>  <span class=\"token operator\">></span>/etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span> <span class=\"token operator\">&lt;&lt;-</span>EOF</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;VIP&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token assign-left variable\">NETMASK</span><span class=\"token operator\">=</span><span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>loopback</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tEOF</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">ifup</span> <span class=\"token variable\">$&#123;DEV&#125;</span>\t<span class=\"token comment\"># 启动网卡</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tsystemctl start nginx</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    stop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function\">ifdown</span> <span class=\"token variable\">$&#123;DEV&#125;</span>  <span class=\"token comment\"># 停止网卡</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        systemctl stop nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    *<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: sh <span class=\"token variable\">$0</span> &#123; start | stop &#125;\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr></table></figure><h5 id=\"63-配置rs节点vip和arp抑制\"><a class=\"anchor\" href=\"#63-配置rs节点vip和arp抑制\">#</a> 6.3 配置 RS 节点 VIP 和 Arp 抑制</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/lvs_rs.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_rs.sh start</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ens192: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.113  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.1.255</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        ether 00:50:56:b7:a1:fc  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        RX packets <span class=\"token number\">70472</span>  bytes <span class=\"token number\">6340792</span> <span class=\"token punctuation\">(</span><span class=\"token number\">6.0</span> MiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">1280</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        TX packets <span class=\"token number\">6372</span>  bytes <span class=\"token number\">2196852</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2.0</span> MiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        TX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>lo:0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.110  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h5 id=\"64-配置lb02\"><a class=\"anchor\" href=\"#64-配置lb02\">#</a> 6.4 配置 Lb02</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改 nginx 配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat zh.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream zh <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        server <span class=\"token number\">192.168</span>.1.117:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        server <span class=\"token number\">192.168</span>.1.118:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        server_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_certificate  /etc/nginx/sslkey/*.hmallleasing.com_chain.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate_key  /etc/nginx/sslkey/*.hmallleasing.com_key.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                proxy_pass http://zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                include proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    server_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#2. 修改 nginx 反代参数</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_params </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>proxy_send_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#3. 上传 nginx 证书</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/sslkey</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /etc/nginx/sslkey/</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>*.hmallleasing.com_chain.crt</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>*.hmallleasing.com_key.key</pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\">#4. 重启 nginx</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h5 id=\"65-vip和arp抑制脚本\"><a class=\"anchor\" href=\"#65-vip和arp抑制脚本\">#</a> 6.5 VIP 和 Arp 抑制脚本</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat lvs_rs.sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/usr/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">VIP</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">DEV</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token variable\">$1</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\"># ARP 抑制</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\"># VIP</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">cat</span>  <span class=\"token operator\">></span>/etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span> <span class=\"token operator\">&lt;&lt;-</span>EOF</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;VIP&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token assign-left variable\">NETMASK</span><span class=\"token operator\">=</span><span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>loopback</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tEOF</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">ifup</span> <span class=\"token variable\">$&#123;DEV&#125;</span>\t<span class=\"token comment\"># 启动网卡</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tsystemctl start nginx</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    stop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function\">ifdown</span> <span class=\"token variable\">$&#123;DEV&#125;</span>  <span class=\"token comment\"># 停止网卡</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        systemctl stop nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    *<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: sh <span class=\"token variable\">$0</span> &#123; start | stop &#125;\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr></table></figure><h5 id=\"66-配置rs节点vip和arp抑制\"><a class=\"anchor\" href=\"#66-配置rs节点vip和arp抑制\">#</a> 6.6 配置 RS 节点 VIP 和 Arp 抑制</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/lvs_rs.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_rs.sh start</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ens192: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.113  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.1.255</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        ether 00:50:56:b7:a1:fc  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        RX packets <span class=\"token number\">70472</span>  bytes <span class=\"token number\">6340792</span> <span class=\"token punctuation\">(</span><span class=\"token number\">6.0</span> MiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">1280</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        TX packets <span class=\"token number\">6372</span>  bytes <span class=\"token number\">2196852</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2.0</span> MiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        TX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>lo:0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.110  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"七-接入四层负载均衡\"><a class=\"anchor\" href=\"#七-接入四层负载均衡\">#</a> 七、接入四层负载均衡</h4>\n<h5 id=\"71-安装lvs命令行工具\"><a class=\"anchor\" href=\"#71-安装lvs命令行工具\">#</a> 7.1 安装 lvs 命令行工具</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install ipvsadm -y</span></pre></td></tr></table></figure><h5 id=\"72-使用脚本生成lvs规则\"><a class=\"anchor\" href=\"#72-使用脚本生成lvs规则\">#</a> 7.2 使用脚本生成 lvs 规则</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /scripts/lvs_ds.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/usr/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">VIP</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">RS1</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.113</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">RS2</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.114</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">SCHEDULER</span><span class=\"token operator\">=</span>rr</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">DEV</span><span class=\"token operator\">=</span>ens192:1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token variable\">$1</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\"># 配置虚拟 IP 地址  VIP</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token function\">cat</span>  <span class=\"token operator\">></span>/etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span> <span class=\"token operator\">&lt;&lt;-</span>EOF</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span>Ethernet</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span>none</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;VIP&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tEOF</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\"># 启动网卡</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token function\">ifup</span> <span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token comment\"># 配置 LVS 规则</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-C</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-A</span> <span class=\"token parameter variable\">-t</span> <span class=\"token variable\">$&#123;VIP&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;PORT&#125;</span> <span class=\"token parameter variable\">-s</span> <span class=\"token variable\">$&#123;SCHEDULER&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-a</span> <span class=\"token parameter variable\">-t</span> <span class=\"token variable\">$&#123;VIP&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;PORT&#125;</span> <span class=\"token parameter variable\">-r</span> <span class=\"token variable\">$&#123;RS1&#125;</span> <span class=\"token parameter variable\">-g</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-a</span> <span class=\"token parameter variable\">-t</span> <span class=\"token variable\">$&#123;VIP&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;PORT&#125;</span> <span class=\"token parameter variable\">-r</span> <span class=\"token variable\">$&#123;RS2&#125;</span> <span class=\"token parameter variable\">-g</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tstop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t    <span class=\"token function\">ifdown</span> <span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t    <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t    ipvsadm <span class=\"token parameter variable\">-C</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t   <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t*<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: sh <span class=\"token variable\">$0</span> &#123; start | stop &#125;\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/lvs_ds.sh </span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_ds.sh start</span></pre></td></tr></table></figure><h5 id=\"73-命令行配置lvs规则\"><a class=\"anchor\" href=\"#73-命令行配置lvs规则\">#</a> 7.3 命令行配置 lvs 规则</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置虚拟 IP 地址 VIP</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_ds.sh start</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 80 端口的调度</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -A -t 192.168.1.110:80 -s rr</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.110:80 -r 192.168.1.113:80 -g</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.110:80 -r 192.168.1.114:80 -g</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>TCP  <span class=\"token number\">192.168</span>.1.110:80 rr</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.113:80             Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.114:80             Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span> </pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#3. 配置 443 端口的调度</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -A -t 192.168.1.110:443 -s rr</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.110:443 -r 192.168.1.113:443 -g</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.110:443 -r 192.168.1.114:443 -g</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>TCP  <span class=\"token number\">192.168</span>.1.110:80 rr</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.113:80             Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.114:80             Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>TCP  <span class=\"token number\">192.168</span>.1.110:443 rr</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.113:443            Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.114:443            Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr></table></figure><h5 id=\"74-lvskeepalived实现高可用\"><a class=\"anchor\" href=\"#74-lvskeepalived实现高可用\">#</a> 7.4 LVS+Keepalived 实现高可用</h5>\n<p>1.lvs01 和 lvs02 安装软件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> keepalived ipvsadm <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p>2. 必须关闭七层负载均衡的 keepalived</p>\n<p>3. 删除 lvs 上的虚拟 IP，以及 ipvs 规则</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_ds.sh stop</span></pre></td></tr></table></figure><p>4. 配置 lvs-master</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb01</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    state MASTER</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    priority <span class=\"token number\">200</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    interface ens192</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>virtual_server <span class=\"token number\">192.168</span>.1.110 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.113 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.114 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>virtual_server <span class=\"token number\">192.168</span>.1.110 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.113 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.114 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>5. 配置 lvs-backup</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb02</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    priority <span class=\"token number\">150</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    interface ens192</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 配置集群地址访问的 IP+Port</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>virtual_server <span class=\"token number\">192.168</span>.1.110 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\"># 健康检查的时间，单位：秒</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\"># 配置负载均衡的算法</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\"># 设置 LVS 的模式 NAT|TUN|DR</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\"># 设置协议</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-1</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.113 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\"># 权重配比设置为 1</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token comment\"># 设置健康检查</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token comment\"># 检测后端 80 端口</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token comment\"># 超时时间</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token comment\"># 重试次数 2 次</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token comment\"># 间隔时间 3s</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>     <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-2</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.114 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\"># 配置集群地址访问的 IP+Port</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>virtual_server <span class=\"token number\">192.168</span>.1.110 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\"># 健康检查的时间，单位：秒</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token comment\"># 配置负载均衡的算法</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\"># 设置 LVS 的模式 NAT|TUN|DR</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token comment\"># 设置协议</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-1</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.113 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token comment\"># 权重配比设置为 1</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token comment\"># 设置健康检查</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token comment\"># 检测后端 80 端口</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            <span class=\"token comment\"># 超时时间</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token comment\"># 重试次数 2 次</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token comment\"># 间隔时间 3s</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>     <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-2</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.114 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>6. 配置 RS 节点的 VIP 和 Arp 抑制</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_rs.sh start</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_rs.sh start</span></pre></td></tr></table></figure><p>7. 启动 keepalived</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable keepalived &amp;&amp; systemctl start keepalived</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable keepalived &amp;&amp; systemctl start keepalived</span></pre></td></tr></table></figure><p>8. 如果 realserver 节点故障，是否会自动将其移除</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl start nginx</pre></td></tr></table></figure><p>9. 如果 ds 服务器故障，能否切换到备用节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl stop keepalived</pre></td></tr></table></figure>",
            "tags": [
                "LVS"
            ]
        }
    ]
}