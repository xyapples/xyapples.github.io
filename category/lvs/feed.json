{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"lvs\" category",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/1598774589.html",
            "url": "http://ixuyong.cn/posts/1598774589.html",
            "title": "企业级负载均衡LVS场景实战（二）",
            "date_published": "2025-09-10T14:28:55.000Z",
            "content_html": "<h3 id=\"企业级负载均衡lvs场景实战\"><a class=\"anchor\" href=\"#企业级负载均衡lvs场景实战\">#</a> 企业级负载均衡 LVS 场景实战</h3>\n<h4 id=\"一-安装mysql57\"><a class=\"anchor\" href=\"#一-安装mysql57\">#</a> 一、 安装 MySQL5.7</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、下载 MySQL 官方扩展源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ivh http://repo.mysql.com/yum/mysql-5.7-community/el/7/x86_64/mysql57-community-release-el7-10.noarch.rpm</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2、安装 mysql5.7，文件过大可能会导致下载缓慢</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mysql-community-server -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、启动并加入开机自动启动</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4、查看端口是否启动</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:22              <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">3788</span>/sshd           </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:25            <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">4018</span>/master         </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::3306                 :::*                    LISTEN      <span class=\"token number\">4628</span>/mysqld         </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::22                   :::*                    LISTEN      <span class=\"token number\">3788</span>/sshd           </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> ::1:25                  :::*                    LISTEN      <span class=\"token number\">4018</span>/master </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#5、由于 mysql5.7 默认配置密码，需要过滤 temporary password 关键字查看对应登陆数据库密码</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># grep 'temporary password' /var/log/mysqld.log</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#6、登录 mysql 数据库 [password 中填写上一步过滤的密码]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#6、重新修改数据库密码</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'app'</span>@<span class=\"token string\">'192.168.40.%'</span> identified by <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"二-nfs服务部署\"><a class=\"anchor\" href=\"#二-nfs服务部署\">#</a> 二、 NFS 服务部署</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.NFS 服务安装</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install nfs-utils</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2.NFS 服务配置</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/exports</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>/data <span class=\"token number\">192.168</span>.40.0/24<span class=\"token punctuation\">(</span>rw,sync,all_squash,anonuid<span class=\"token operator\">=</span><span class=\"token number\">666</span>,anongid<span class=\"token operator\">=</span><span class=\"token number\">666</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#3.NFS 服务初始化</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /data/</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#4.NFS 服务启动</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nfs-server &amp;&amp; systemctl start nfs-server</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#5. 客户端挂载 NFS</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>客户端也创建一个uid为666，gid为666，统一身份，避免后续出现权限不足的情况</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup mnt<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup mnt<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -g 666 -u 666 www</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install nfs-utils</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># showmount -e 192.168.40.103</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.40.103:/data /data</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#6. 客户端永久挂载 NFS</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/fstab 192.168.40.103:/data /data nfs defaults 0 0</span></pre></td></tr></table></figure><h4 id=\"三-部署web01\"><a class=\"anchor\" href=\"#三-部署web01\">#</a> 三、 部署 web01</h4>\n<h5 id=\"31-部署nginx\"><a class=\"anchor\" href=\"#31-部署nginx\">#</a> 3.1 部署 Nginx</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.Nginx 安装</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 Nginx 进程运行用户</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g666 www</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u666 -g666 www</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user www;' /etc/nginx/nginx.conf</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#3. 启动 Nginx，并将 Nginx 加入开机自启</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nginx &amp;&amp; systemctl start nginx</span></pre></td></tr></table></figure><h5 id=\"32-部署php71\"><a class=\"anchor\" href=\"#32-部署php71\">#</a> 3.2 部署 PHP7.1</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、移除旧版 php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum remove php-mysql-5.4 php php-fpm php-common</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2.2 安装扩展源</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum localinstall https://mirror.webtatic.com/yum/el7/webtatic-release.rpm -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3、安装 php7.1 版本</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4、启动 php</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^group/c group = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start php-fpm &amp;&amp; systemctl enable php-fpm</span></pre></td></tr></table></figure><h4 id=\"四-部署web02\"><a class=\"anchor\" href=\"#四-部署web02\">#</a> 四、部署 web02</h4>\n<h5 id=\"41-部署nginx\"><a class=\"anchor\" href=\"#41-部署nginx\">#</a> 4.1 部署 Nginx</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.Nginx 安装</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 Nginx 进程运行用户</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">groupadd</span> <span class=\"token parameter variable\">-g666</span> www</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">useradd</span> <span class=\"token parameter variable\">-u666</span> <span class=\"token parameter variable\">-g666</span> www</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'/^user/c user www;'</span> /etc/nginx/nginx.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#3. 启动 Nginx，并将 Nginx 加入开机自启</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nginx &amp;&amp; systemctl start nginx</span></pre></td></tr></table></figure><h5 id=\"42-部署php71\"><a class=\"anchor\" href=\"#42-部署php71\">#</a> 4.2 部署 PHP7.1</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 移除旧版 php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum remove php-mysql-5.4 php php-fpm php-common</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 安装扩展源</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum localinstall https://mirror.webtatic.com/yum/el7/webtatic-release.rpm -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3. 安装 php7.1 版本</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4. 启动 php</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^user/c user = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i '/^group/c group = www' /etc/php-fpm.d/www.conf</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start php-fpm &amp;&amp; systemctl enable php-fpm</span></pre></td></tr></table></figure><h4 id=\"五-部署博客wecenter\"><a class=\"anchor\" href=\"#五-部署博客wecenter\">#</a> 五、  部署博客 WeCenter</h4>\n<h5 id=\"51-web01配置\"><a class=\"anchor\" href=\"#51-web01配置\">#</a> 5.1 web01 配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改 nginx 反代参数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>proxy_send_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#2. 修改 nginx 配置文件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat zh.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tserver_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\troot /code/zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\tindex index.php index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tlocation ~ <span class=\"token punctuation\">\\</span>.php$ <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tfastcgi_pass   <span class=\"token number\">127.0</span>.0.1:9000<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tfastcgi_param  SCRIPT_FILENAME  <span class=\"token variable\">$document_root</span><span class=\"token variable\">$fastcgi_script_name</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tfastcgi_param HTTPS on<span class=\"token punctuation\">;</span>    <span class=\"token comment\">#支持前端用 https, 后端用 http</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tinclude        fastcgi_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#3. 创建网站目录</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/zh</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">#4. 重启 nginx 服务</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#5. 获取 WeCenter 代码</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://cn.wordpress.org/wordpress-4.9.4-zh_CN.tar.g</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">#6. 解压网站源码文件，拷贝至对应站点目录，并授权站点目录</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf wordpress-4.9.4-zh_CN.tar.gz </span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /code/zh/uploads/</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp uploads/* root@192.168.1.116:/data/zh</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /code/zh</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\">#7. 由于 wordpress 产品需要依赖数据库，所以需要手动建立数据库</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token comment\">#1. 登陆数据库</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\">#8. 创建 wordpress 数据库</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>mysql<span class=\"token operator\">></span> create database wordpress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'app'</span>@<span class=\"token string\">'192.168.1.%'</span> identified by <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token comment\">#9. 通过浏览器访问 wordpress, 并部署该产品</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>http://zh.hmallleasing.com</pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token comment\">#10. 获取 Wordpress 产品的附件和图片存放的位置</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>浏览器-<span class=\"token operator\">></span>右键-<span class=\"token operator\">></span>检查-<span class=\"token operator\">></span>Network-<span class=\"token operator\">></span>选择按钮-<span class=\"token operator\">></span>点击一下图片</pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token comment\">#11. 挂载 NFS</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.1.116:/data/zh /code/zh/uploads</span></pre></td></tr></table></figure><h5 id=\"52-web02配置\"><a class=\"anchor\" href=\"#52-web02配置\">#</a> 5.2 web02 配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改 nginx 配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp zh.hmallleasing.com.conf root@192.168.1.118:/etc/nginx/conf.d/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp /etc/nginx/proxy_params root@192.168.1.118:/etc/nginx</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#2. 创建网站目录</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zh -p</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#3. 重启 nginx 服务</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#4. 获取 wordpress 代码</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp /code/zh/* root@192.168.1.118:/code/zh/</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /code/zh</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#5. 获取 Wordpress 产品的附件和图片存放的位置</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>浏览器-<span class=\"token operator\">></span>右键-<span class=\"token operator\">></span>检查-<span class=\"token operator\">></span>Network-<span class=\"token operator\">></span>选择按钮-<span class=\"token operator\">></span>点击一下图片</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#6. 挂载 NFS</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.1.116:/data/zh /code/zh/uploads</span></pre></td></tr></table></figure><h4 id=\"六-配置七层负载均衡\"><a class=\"anchor\" href=\"#六-配置七层负载均衡\">#</a> 六、配置七层负载均衡</h4>\n<h5 id=\"61-配置lb01\"><a class=\"anchor\" href=\"#61-配置lb01\">#</a> 6.1 配置 Lb01</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改 nginx 配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat zh.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream zh <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        server <span class=\"token number\">192.168</span>.1.117:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        server <span class=\"token number\">192.168</span>.1.118:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        server_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_certificate  /etc/nginx/sslkey/*.hmallleasing.com_chain.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate_key  /etc/nginx/sslkey/*.hmallleasing.com_key.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                proxy_pass http://zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                include proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    server_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#2. 修改 nginx 反代参数</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_params </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>proxy_send_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#3. 上传 nginx 证书</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/sslkey</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /etc/nginx/sslkey/</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>*.hmallleasing.com_chain.crt</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>*.hmallleasing.com_key.key</pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">#4. 重启 nginx</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h5 id=\"62-vip和arp抑制脚本\"><a class=\"anchor\" href=\"#62-vip和arp抑制脚本\">#</a> 6.2 VIP 和 Arp 抑制脚本</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat lvs_rs.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/usr/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">VIP</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">DEV</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token variable\">$1</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\"># ARP 抑制</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\"># VIP</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">cat</span>  <span class=\"token operator\">></span>/etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span> <span class=\"token operator\">&lt;&lt;-</span>EOF</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;VIP&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token assign-left variable\">NETMASK</span><span class=\"token operator\">=</span><span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>loopback</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tEOF</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">ifup</span> <span class=\"token variable\">$&#123;DEV&#125;</span>\t<span class=\"token comment\"># 启动网卡</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tsystemctl start nginx</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    stop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function\">ifdown</span> <span class=\"token variable\">$&#123;DEV&#125;</span>  <span class=\"token comment\"># 停止网卡</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        systemctl stop nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    *<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: sh <span class=\"token variable\">$0</span> &#123; start | stop &#125;\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr></table></figure><h5 id=\"63-配置rs节点vip和arp抑制\"><a class=\"anchor\" href=\"#63-配置rs节点vip和arp抑制\">#</a> 6.3 配置 RS 节点 VIP 和 Arp 抑制</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/lvs_rs.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_rs.sh start</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ens192: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.113  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.1.255</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        ether 00:50:56:b7:a1:fc  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        RX packets <span class=\"token number\">70472</span>  bytes <span class=\"token number\">6340792</span> <span class=\"token punctuation\">(</span><span class=\"token number\">6.0</span> MiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">1280</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        TX packets <span class=\"token number\">6372</span>  bytes <span class=\"token number\">2196852</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2.0</span> MiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        TX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>lo:0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.110  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h5 id=\"64-配置lb02\"><a class=\"anchor\" href=\"#64-配置lb02\">#</a> 6.4 配置 Lb02</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改 nginx 配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat zh.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream zh <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        server <span class=\"token number\">192.168</span>.1.117:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        server <span class=\"token number\">192.168</span>.1.118:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        server_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_certificate  /etc/nginx/sslkey/*.hmallleasing.com_chain.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate_key  /etc/nginx/sslkey/*.hmallleasing.com_key.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                proxy_pass http://zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                include proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    server_name zh.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#2. 修改 nginx 反代参数</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_params </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>proxy_send_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#3. 上传 nginx 证书</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/sslkey</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /etc/nginx/sslkey/</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>*.hmallleasing.com_chain.crt</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>*.hmallleasing.com_key.key</pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\">#4. 重启 nginx</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart nginx</span></pre></td></tr></table></figure><h5 id=\"65-vip和arp抑制脚本\"><a class=\"anchor\" href=\"#65-vip和arp抑制脚本\">#</a> 6.5 VIP 和 Arp 抑制脚本</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat lvs_rs.sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/usr/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">VIP</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">DEV</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token variable\">$1</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\"># ARP 抑制</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\"># VIP</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">cat</span>  <span class=\"token operator\">></span>/etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span> <span class=\"token operator\">&lt;&lt;-</span>EOF</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;VIP&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token assign-left variable\">NETMASK</span><span class=\"token operator\">=</span><span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>loopback</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tEOF</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">ifup</span> <span class=\"token variable\">$&#123;DEV&#125;</span>\t<span class=\"token comment\"># 启动网卡</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tsystemctl start nginx</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    stop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function\">ifdown</span> <span class=\"token variable\">$&#123;DEV&#125;</span>  <span class=\"token comment\"># 停止网卡</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        systemctl stop nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    *<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: sh <span class=\"token variable\">$0</span> &#123; start | stop &#125;\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr></table></figure><h5 id=\"66-配置rs节点vip和arp抑制\"><a class=\"anchor\" href=\"#66-配置rs节点vip和arp抑制\">#</a> 6.6 配置 RS 节点 VIP 和 Arp 抑制</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/lvs_rs.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_rs.sh start</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ens192: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.113  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.1.255</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        ether 00:50:56:b7:a1:fc  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        RX packets <span class=\"token number\">70472</span>  bytes <span class=\"token number\">6340792</span> <span class=\"token punctuation\">(</span><span class=\"token number\">6.0</span> MiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">1280</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        TX packets <span class=\"token number\">6372</span>  bytes <span class=\"token number\">2196852</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2.0</span> MiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        TX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>lo:0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.1.110  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"七-接入四层负载均衡\"><a class=\"anchor\" href=\"#七-接入四层负载均衡\">#</a> 七、接入四层负载均衡</h4>\n<h5 id=\"71-安装lvs命令行工具\"><a class=\"anchor\" href=\"#71-安装lvs命令行工具\">#</a> 7.1 安装 lvs 命令行工具</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install ipvsadm -y</span></pre></td></tr></table></figure><h5 id=\"72-使用脚本生成lvs规则\"><a class=\"anchor\" href=\"#72-使用脚本生成lvs规则\">#</a> 7.2 使用脚本生成 lvs 规则</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /scripts/lvs_ds.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/usr/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">VIP</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">RS1</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.113</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">RS2</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.114</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">SCHEDULER</span><span class=\"token operator\">=</span>rr</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">DEV</span><span class=\"token operator\">=</span>ens192:1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token variable\">$1</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\"># 配置虚拟 IP 地址  VIP</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token function\">cat</span>  <span class=\"token operator\">></span>/etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span> <span class=\"token operator\">&lt;&lt;-</span>EOF</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span>Ethernet</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span>none</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;VIP&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tEOF</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\"># 启动网卡</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token function\">ifup</span> <span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token comment\"># 配置 LVS 规则</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-C</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-A</span> <span class=\"token parameter variable\">-t</span> <span class=\"token variable\">$&#123;VIP&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;PORT&#125;</span> <span class=\"token parameter variable\">-s</span> <span class=\"token variable\">$&#123;SCHEDULER&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-a</span> <span class=\"token parameter variable\">-t</span> <span class=\"token variable\">$&#123;VIP&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;PORT&#125;</span> <span class=\"token parameter variable\">-r</span> <span class=\"token variable\">$&#123;RS1&#125;</span> <span class=\"token parameter variable\">-g</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-a</span> <span class=\"token parameter variable\">-t</span> <span class=\"token variable\">$&#123;VIP&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;PORT&#125;</span> <span class=\"token parameter variable\">-r</span> <span class=\"token variable\">$&#123;RS2&#125;</span> <span class=\"token parameter variable\">-g</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tstop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t    <span class=\"token function\">ifdown</span> <span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t    <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t    ipvsadm <span class=\"token parameter variable\">-C</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t   <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t*<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: sh <span class=\"token variable\">$0</span> &#123; start | stop &#125;\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/lvs_ds.sh </span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_ds.sh start</span></pre></td></tr></table></figure><h5 id=\"73-命令行配置lvs规则\"><a class=\"anchor\" href=\"#73-命令行配置lvs规则\">#</a> 7.3 命令行配置 lvs 规则</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置虚拟 IP 地址 VIP</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_ds.sh start</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 80 端口的调度</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -A -t 192.168.1.110:80 -s rr</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.110:80 -r 192.168.1.113:80 -g</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.110:80 -r 192.168.1.114:80 -g</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>TCP  <span class=\"token number\">192.168</span>.1.110:80 rr</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.113:80             Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.114:80             Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span> </pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#3. 配置 443 端口的调度</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -A -t 192.168.1.110:443 -s rr</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.110:443 -r 192.168.1.113:443 -g</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.110:443 -r 192.168.1.114:443 -g</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>TCP  <span class=\"token number\">192.168</span>.1.110:80 rr</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.113:80             Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.114:80             Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>TCP  <span class=\"token number\">192.168</span>.1.110:443 rr</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.113:443            Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.114:443            Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr></table></figure><h5 id=\"74-lvskeepalived实现高可用\"><a class=\"anchor\" href=\"#74-lvskeepalived实现高可用\">#</a> 7.4 LVS+Keepalived 实现高可用</h5>\n<p>1.lvs01 和 lvs02 安装软件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> keepalived ipvsadm <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p>2. 必须关闭七层负载均衡的 keepalived</p>\n<p>3. 删除 lvs 上的虚拟 IP，以及 ipvs 规则</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_ds.sh stop</span></pre></td></tr></table></figure><p>4. 配置 lvs-master</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb01</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    state MASTER</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    priority <span class=\"token number\">200</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    interface ens192</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>virtual_server <span class=\"token number\">192.168</span>.1.110 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.113 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.114 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>virtual_server <span class=\"token number\">192.168</span>.1.110 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.113 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.114 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>5. 配置 lvs-backup</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb02</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    priority <span class=\"token number\">150</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    interface ens192</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.110</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 配置集群地址访问的 IP+Port</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>virtual_server <span class=\"token number\">192.168</span>.1.110 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\"># 健康检查的时间，单位：秒</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\"># 配置负载均衡的算法</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\"># 设置 LVS 的模式 NAT|TUN|DR</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\"># 设置协议</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-1</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.113 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\"># 权重配比设置为 1</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token comment\"># 设置健康检查</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token comment\"># 检测后端 80 端口</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token comment\"># 超时时间</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token comment\"># 重试次数 2 次</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token comment\"># 间隔时间 3s</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>     <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-2</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.114 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\"># 配置集群地址访问的 IP+Port</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>virtual_server <span class=\"token number\">192.168</span>.1.110 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\"># 健康检查的时间，单位：秒</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token comment\"># 配置负载均衡的算法</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token comment\"># 设置 LVS 的模式 NAT|TUN|DR</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token comment\"># 设置协议</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-1</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.113 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token comment\"># 权重配比设置为 1</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token comment\"># 设置健康检查</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token comment\"># 检测后端 80 端口</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            <span class=\"token comment\"># 超时时间</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token comment\"># 重试次数 2 次</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token comment\"># 间隔时间 3s</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>     <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-2</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    real_server <span class=\"token number\">192.168</span>.1.114 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>6. 配置 RS 节点的 VIP 和 Arp 抑制</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_rs.sh start</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh /scripts/lvs_rs.sh start</span></pre></td></tr></table></figure><p>7. 启动 keepalived</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable keepalived &amp;&amp; systemctl start keepalived</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable keepalived &amp;&amp; systemctl start keepalived</span></pre></td></tr></table></figure><p>8. 如果 realserver 节点故障，是否会自动将其移除</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl start nginx</pre></td></tr></table></figure><p>9. 如果 ds 服务器故障，能否切换到备用节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl stop keepalived</pre></td></tr></table></figure>",
            "tags": [
                "LVS"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3106546893.html",
            "url": "http://ixuyong.cn/posts/3106546893.html",
            "title": "企业级负载均衡LVS（一）",
            "date_published": "2025-09-10T14:02:57.000Z",
            "content_html": "<h3 id=\"企业级负载均衡lvs\"><a class=\"anchor\" href=\"#企业级负载均衡lvs\">#</a> 企业级负载均衡 LVS</h3>\n<h4 id=\"1-lvs基本概述\"><a class=\"anchor\" href=\"#1-lvs基本概述\">#</a> 1. LVS 基本概述</h4>\n<h5 id=\"11-什么是lvs\"><a class=\"anchor\" href=\"#11-什么是lvs\">#</a> 1.1 什么是 LVS</h5>\n<p>LVS 是 Linux Virtual Server 的简称，即 Linux 虚拟服务器。其实它是一种 Cluster 集群技术，主要用于负载均衡，将用户请求均匀的调度到不同部服务器上执行。LVS 是基于四层目标 IP、PORT 的负载均衡。</p>\n<h5 id=\"12-为何需要lvs\"><a class=\"anchor\" href=\"#12-为何需要lvs\">#</a> 1.2 为何需要 LVS</h5>\n<ul>\n<li>1. 解决七层端口不够问题，实现百万链接；</li>\n<li>2. 解决七层负载均衡高可用问题；</li>\n</ul>\n<h5 id=\"13-lvs组成部分\"><a class=\"anchor\" href=\"#13-lvs组成部分\">#</a> 1.3 LVS 组成部分</h5>\n<ul>\n<li>\n<p>ipvsadm：用户空间的客户端工具，负责 ipvs 内核框架编写规则。定义谁是集群服务，谁是后端服务，数据包如何调度，调度到那个节点；</p>\n</li>\n<li>\n<p>ipvs：工作在内核空间，实现集群服务的 “调度”，借鉴了 iptables 的实现方式；</p>\n</li>\n</ul>\n<h5 id=\"14-lvs组成部分\"><a class=\"anchor\" href=\"#14-lvs组成部分\">#</a> 1.4 LVS 组成部分</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/o8blZVV.png\" alt=\"1.png\" /></p>\n<ul>\n<li>DS：Director Server，lvs 服务器名称</li>\n<li>RS：Real Server ，后端请求处理服务器，真实服务器</li>\n<li>CIP: Client IP ，客户端 IP</li>\n<li>VIP：Director Virtual IP ，负载均衡器虚拟 IP</li>\n<li>DIP：Director IP ，ds 服务器真实的 IP 地址</li>\n<li>RIP：Real Server IP ，后端请求处理的服务器 IP</li>\n</ul>\n<h5 id=\"15-lvs常见模型\"><a class=\"anchor\" href=\"#15-lvs常见模型\">#</a> 1.5 LVS 常见模型</h5>\n<p>LVS 负载均衡模型有 NAT、DR、TUN、FULL-NAT，较为常见的模型有 NAT、DR，使用最为广泛的模型是 DR。</p>\n<h6 id=\"151-nat模型\"><a class=\"anchor\" href=\"#151-nat模型\">#</a> 1.5.1 NAT 模型</h6>\n<p>NAT：通过修改请求报文的目标 IP 地址，然后根据算法挑选出某台 RS 进行转发。（请求进入负载均衡器 LVS 时做 DNAT，后端返回数据报文出负载均衡时做 SNAT）</p>\n<h6 id=\"152-dr模型\"><a class=\"anchor\" href=\"#152-dr模型\">#</a> 1.5.2 DR 模型</h6>\n<p>DR：通过修改请求报文的目标 MAC 地址，然后根据算法挑选出某台 RS 进行转发。（请求进入负载均衡器 LVS 时做 MAC 地址转换，后端返回数据报文不经过负载均衡，所以无需做转换）</p>\n<h5 id=\"16-管理工具ipvsadm使用\"><a class=\"anchor\" href=\"#16-管理工具ipvsadm使用\">#</a> 1.6 管理工具 ipvsadm 使用</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install ipvsadm -y</span></pre></td></tr></table></figure><h6 id=\"161-集群管理参数\"><a class=\"anchor\" href=\"#161-集群管理参数\">#</a> 1.6.1 集群管理参数</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># COMMANDS-CLUSTER</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>-A, --add-service：     <span class=\"token comment\">#添加一个集群服务。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>-E, --edit-service：    <span class=\"token comment\">#修改已添加的集群服务。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>-D, --delete-service：  <span class=\"token comment\">#删除一个虚拟服务。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>-C, --clear：           <span class=\"token comment\">#清除所有虚拟服务。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>-R, --restore：         <span class=\"token comment\">#从文件中恢复集群。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>-S, --save：            <span class=\"token comment\">#将集群信息保存至文件中。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>-L, -l, --list：        <span class=\"token comment\">#列出当前集群信息。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-Z, --zero：            <span class=\"token comment\">#将所有数据相关的记录清零。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token parameter variable\">-n</span>                      <span class=\"token comment\">#数字格式显示 ip 和 port，注意 - n 只能写在 - L 之后。</span></pre></td></tr></table></figure><h6 id=\"162-节点管理参数\"><a class=\"anchor\" href=\"#162-节点管理参数\">#</a> 1.6.2 节点管理参数</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># COMMANDS-RS</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>-a, --add-server：         <span class=\"token comment\">#表示添加一个 RS 节点</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>-e, --edit-server：        <span class=\"token comment\">#表示修改一个 RS 节点</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>-d, --delete-server：      <span class=\"token comment\">#表示删除一个 RS 节点</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>-t, service-address：      <span class=\"token comment\">#指定操作那个节点地址与端口，host:[port],tcp 协议。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>-u, service-address：      <span class=\"token comment\">#指定操作那个节点地址与端口，host:[port],ucp 协议。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>-r, --real-server：        <span class=\"token comment\">#指定 RS 节点地址与端口。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>-w, --weight:              <span class=\"token comment\">#指定 RS 节点的权重。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-m, --masquerading：       <span class=\"token comment\">#指定 LVS 工作模型（NAT 模型）。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>-g, --gatewaying：         <span class=\"token comment\">#指定 LVS 工作模型（DR 模型）。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>-i, --ipip：               <span class=\"token comment\">#指定 LVS 工作模型（TUN 模型）。</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>-s, --scheduler：          <span class=\"token comment\">#指定 LVS 调度策略，默认为 wlc。</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>-p, --persistent：         <span class=\"token comment\">#持久连接超时时间。</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>-f, --fwmark-service：     <span class=\"token comment\">#防火墙标记</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>-c, --connection：         <span class=\"token comment\">#列出当前的 IPVS 连接。</span></pre></td></tr></table></figure><h6 id=\"163-集群管理示例\"><a class=\"anchor\" href=\"#163-集群管理示例\">#</a> 1.6.3 集群管理示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 添加虚拟服务，定义集群</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -A -t 192.168.1.7:3306</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>TCP  <span class=\"token number\">192.168</span>.1.7:3306 wlc</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2. 添加真实服务 IP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.7:3306 -r 192.168.1.51:3306  </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 192.168.1.7:3306 -r 192.168.1.41:3306</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>TCP  <span class=\"token number\">192.168</span>.1.7:3306 wlc</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.41:3306            Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.51:3306            Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"2-lvs-nat模型详解\"><a class=\"anchor\" href=\"#2-lvs-nat模型详解\">#</a> 2. LVS NAT 模型详解</h4>\n<p>通过修改请求报文的目标 IP 地址，然后根据算法挑选出某台 RS 进行转发。（请求进入负载均衡器 LVS 时做 DNAT，后端返回数据报文出负载均衡时做 SNAT）</p>\n<h5 id=\"21-nat基础图解\"><a class=\"anchor\" href=\"#21-nat基础图解\">#</a> 2.1 NAT 基础图解</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/n7ga0Kv.png\" alt=\"1.png\" /></p>\n<h5 id=\"22-nat底层实现\"><a class=\"anchor\" href=\"#22-nat底层实现\">#</a> 2.2 NAT 底层实现</h5>\n<p>客户端：10.0.0.10（外网）</p>\n<p>DS 节点：172.16.1.100（VIP）、172.16.1.3（DIP）</p>\n<p>RD 节点：172.16.1.5、172.16.1.6、Gateway：172.16.1.3</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/XuAW9Ha.png\" alt=\"2.png\" /></p>\n<h5 id=\"23-nat访问原理\"><a class=\"anchor\" href=\"#23-nat访问原理\">#</a> 2.3 NAT 访问原理</h5>\n<ul>\n<li>1. 当用户请求到达 Director Server，此时请求的数据报文会先到内核空间的 PREOUTING 链。此时报文的源 IP 为 CIP，目标 IP 为 VIP;</li>\n<li>2.PREOUTING 检查发现数据包的目标 IP 是本机，将数据包送至 INPUT 链；</li>\n<li>3.IPVS 比对数据包请求的服务是否为集群服务，若是，通过调度算法挑选一台后端 RS 服务器，并修改数据包的目标 IP 为 RS 的 IP，然后将数据包发至 POSTROUTING 链。此时报文的源 IP 为 CIP，目标 IP 为 RIP;</li>\n<li>4.POSTROUTING 链通过选路，将数据包通过 Director Server 的 DIP 发送给 RS；</li>\n<li>5.RS 发现目标为自己的 IP，则交给应用程序处理，然后构建相应报文发回给 Director Server。此时报文的源 IP 为 RIP，目标 IP 为 CIP;</li>\n<li>6.Director Server 在响应客户端前，会将源 IP 地址修改为 VIP 地址，然后响应给客户端。此时报文的源 IP 为 VIP，目标 IP 为 CIP;</li>\n</ul>\n<h5 id=\"24-nat特性总结\"><a class=\"anchor\" href=\"#24-nat特性总结\">#</a> 2.4 NAT 特性总结</h5>\n<ul>\n<li>1.RS 必须使用私网地址，并需要将网关指向 DS；</li>\n<li>2.RIP 和 DIP 必须为同一网段内；</li>\n<li>3.NAT 模型支持端口映射；</li>\n<li>4.RS 可以使用任意操作系统，例如 Linux、Windows 等；</li>\n<li>5. 请求和响应报文都要经过 RS，高负载场景中，DS 易成为瓶颈；</li>\n</ul>\n<h5 id=\"25-nat模型场景实战\"><a class=\"anchor\" href=\"#25-nat模型场景实战\">#</a> 2.5 NAT 模型场景实战</h5>\n<h6 id=\"251-nat架构规划\"><a class=\"anchor\" href=\"#251-nat架构规划\">#</a> 2.5.1 NAT 架构规划</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/X70XumG.jpeg\" alt=\"NAT-实现架构图.jpg\" /></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">角色</th>\n<th style=\"text-align:center\">主机名称</th>\n<th style=\"text-align:center\"><strong>外网地址</strong></th>\n<th style=\"text-align:center\"><strong>内网地址</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">客服端</td>\n<td style=\"text-align:center\">client</td>\n<td style=\"text-align:center\">eth0:192.168.40.41</td>\n<td style=\"text-align:center\">/</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">路由器</td>\n<td style=\"text-align:center\">route</td>\n<td style=\"text-align:center\">eth0:192.168.40.200</td>\n<td style=\"text-align:center\">eth1:172.16.1.200</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">LVS</td>\n<td style=\"text-align:center\">lb01</td>\n<td style=\"text-align:center\">/</td>\n<td style=\"text-align:center\">eth1:172.16.1.3/VIP:172.16.1.100</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">应用服务器</td>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">/</td>\n<td style=\"text-align:center\">eth1:172.16.1.7</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">应用服务器</td>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">/</td>\n<td style=\"text-align:center\">eth1:172.16.1.8</td>\n</tr>\n</tbody>\n</table>\n<h6 id=\"252-客户端配置\"><a class=\"anchor\" href=\"#252-客户端配置\">#</a> 2.5.2 客户端配置</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 eth1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 eth0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">UUID</span><span class=\"token operator\">=</span><span class=\"token string\">\"09f9df8f-9a2c-48ec-a530-cedcbc801991\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.40.10\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#GATEWAY=\"192.168.40.2\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#DNS1=\"223.5.5.5\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth0 &amp;&amp; ifup eth0</span></pre></td></tr></table></figure><h6 id=\"253-路由器配置\"><a class=\"anchor\" href=\"#253-路由器配置\">#</a> 2.5.3 路由器配置</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 eth0 (eth0: 192.168.40.200\tgateway: 192.168.40.2)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">UUID</span><span class=\"token operator\">=</span><span class=\"token string\">\"09f9df8f-9a2c-48ec-a530-cedcbc801991\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.40.200\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">GATEWAY</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.40.2\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">DNS1</span><span class=\"token operator\">=</span><span class=\"token string\">\"223.5.5.5\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#2. 配置 eth1 (eth1: 172.16.1.200)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"172.16.1.200\"</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">#3. 开启 forward 转发</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"net.ipv4.ip_forward = 1\" >> /etc/sysctl.conf </span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sysctl -p</span></pre></td></tr></table></figure><h6 id=\"254-web01配置rs节点\"><a class=\"anchor\" href=\"#254-web01配置rs节点\">#</a> 2.5.4 web01 配置 (RS 节点)</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 eth0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 eth1 网关指向 LVS 的 VIP</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"172.16.1.7\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">GATEWAY</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1 &amp;&amp; ifup eth1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#3. 配置 Nginx</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/lvs.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tserver_name lvs.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web01 Real Server\" > /code/index.html</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://172.16.1.7</span></pre></td></tr></table></figure><h6 id=\"255-web02配置rs节点\"><a class=\"anchor\" href=\"#255-web02配置rs节点\">#</a> 2.5.5 web02 配置 (RS 节点)</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 eth0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 eth1 网关指向 LVS 的 VIP</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"172.16.1.8\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">GATEWAY</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1 &amp;&amp; ifup eth1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#3. 配置 Nginx</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/lvs.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tserver_name lvs.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web02 Real Server\" > /code/index.html</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://172.16.1.8</span></pre></td></tr></table></figure><h6 id=\"256-lvs配置\"><a class=\"anchor\" href=\"#256-lvs配置\">#</a> 2.5.6 LVS 配置</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 关闭 eth0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 eth1 (eth1: 172.16.1.3  gateway：172.16.1.200)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"172.16.1.3\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">GATEWAY</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.200</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1 &amp;&amp; ifup eth1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#3. 配置 vip (vip : 172.16.1.100)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp /etc/sysconfig/network-scripts/ifcfg-eth1 /etc/sysconfig/network-scripts/ifcfg-eth1:1</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1:1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span>Ethernet</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span>none</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>eth1:1</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span>eth1:1</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1:1 &amp;&amp; ifup eth1:1</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">#4. 开启 forward 转发功能</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"net.ipv4.ip_forward = 1\" >> /etc/sysctl.conf </span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sysctl -p</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#5. 配置 ipvs 规则，将请求的 80 端口，调度到后端 rs 节点；</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -A -t 172.16.1.100:80 -s rr</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 172.16.1.100:80 -r 172.16.1.7 -m </span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 172.16.1.100:80 -r 172.16.1.8 -m </span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:80 rr</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.7:80                Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:80                Masq    <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr></table></figure><h6 id=\"257-路由器配置端口映射\"><a class=\"anchor\" href=\"#257-路由器配置端口映射\">#</a> 2.5.7 路由器配置端口映射</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 在路由器上增加端口映射，模拟实现真实的公网环境</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -A PREROUTING -d 192.168.40.200 -p tcp --dport 80 -j DNAT --to 172.16.1.100:80</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -A PREROUTING -d 192.168.40.200 -p tcp --dport 443 -j DNAT --to 172.16.1.100:443</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -L -n</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Chain PREROUTING <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>target     prot opt <span class=\"token builtin class-name\">source</span>               destination         </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>DNAT       tcp  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">192.168</span>.40.200       tcp dpt:80 to:172.16.1.100:80</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>DNAT       tcp  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">192.168</span>.40.200       tcp dpt:443 to:172.16.1.100:443</pre></td></tr></table></figure><h6 id=\"258-测试验证\"><a class=\"anchor\" href=\"#258-测试验证\">#</a> 2.5.8 测试验证</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 验证测试</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>web01 Real Server</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>web02 Real Server</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#2. 查看客户端是否与 web 服务器建立握手</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># dd if=/dev/zero of=/code/bigdata bs=3000M count=1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -ntp</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Active Internet connections <span class=\"token punctuation\">(</span>w/o servers<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>tcp        <span class=\"token number\">0</span> <span class=\"token number\">4077780</span> <span class=\"token number\">172.16</span>.1.7:80           <span class=\"token number\">192.168</span>.40.1:59525      ESTABLISHED <span class=\"token number\">1871</span>/nginx: worker  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.16</span>.1.7:22           <span class=\"token number\">172.16</span>.1.41:58656       ESTABLISHED <span class=\"token number\">1731</span>/sshd: root@pts </pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#3. 对于客服端与路由器建立握手</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>C:<span class=\"token punctuation\">\\</span>Users<span class=\"token punctuation\">\\</span>Administrator<span class=\"token operator\">></span>netstat <span class=\"token parameter variable\">-an</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>TCP    <span class=\"token number\">192.168</span>.40.1:59525     <span class=\"token number\">192.168</span>.40.200:80      ESTABLISHED</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#4. 查看 LVS 连接记录</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -c -n</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>IPVS connection entries</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pro expire state       <span class=\"token builtin class-name\">source</span>             virtual            destination</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>TCP 00:02  CLOSE       <span class=\"token number\">192.168</span>.40.1:59067 <span class=\"token number\">172.16</span>.1.100:80    <span class=\"token number\">172.16</span>.1.7:80</pre></td></tr></table></figure><h4 id=\"3lvs-dr模型详解\"><a class=\"anchor\" href=\"#3lvs-dr模型详解\">#</a> 3.LVS DR 模型详解</h4>\n<p>通过修改请求报文的目标 MAC 地址，然后根据算法挑选出合适的 RS 节点进行转发。（请求进入 DS Server 时做 MAC 地址替换，后端返回数据报文不经过 DS Server 节点，直接返回给客户端即可。）</p>\n<h5 id=\"31-nat基础图解\"><a class=\"anchor\" href=\"#31-nat基础图解\">#</a> 3.1 NAT 基础图解</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/0Fw5cku.png\" alt=\"1.png\" /></p>\n<h5 id=\"32-dr底层实现\"><a class=\"anchor\" href=\"#32-dr底层实现\">#</a> 3.2 DR 底层实现</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/qX7Ttqg.png\" alt=\"2.png\" /></p>\n<p><strong>1. 路由器如何规划 VIP 以及 MAC 地址呢？</strong></p>\n<p>路由器通过 ARP 广播获取 VMAC，然后封装 CIP、VIP、CMAC、VMAC，通过交换机转发至目标主机。</p>\n<p><strong>2.RS 处理请求直接返回给 CIP，不经过 DS，那么 RS 如何将数据包回传给 CIP？</strong></p>\n<p>由于 CIP 请求的是 VIP，而响应是通过 RIP 响应给 CIP，所以数据报文一定会被丢弃。那么就需要在所有的 RS 的接口上配置 VIP 的地址，由 RS 上的 VIP 响应给 CIP 即可。</p>\n<p><strong>3. 所有 RS 节点都配置 VIP，那么路由器在广播的时候，岂不是所有的 VIP 都会响应？</strong></p>\n<p>方式 1：在路由器上静态绑定 VIP 与 VMAC 的关系。</p>\n<p>方式 2：在所有 RS 节点上配置 ARP 抑制，简单来说就是路由器广播获取 VMAC 时，所有的 RS 都不应答，其次所有的 RS 都不对外宣布自己的 VIP。</p>\n<p><strong>4.VIP、DIP、RIP 需要在同一网段中吗？</strong></p>\n<p>一般来说 DIP 和 RIP 在同一物理网络中，并不一定在同一网段中。</p>\n<h5 id=\"33-dr访问流程\"><a class=\"anchor\" href=\"#33-dr访问流程\">#</a> 3.3 DR 访问流程</h5>\n<ul>\n<li>1. 当用户请求到达 DS 节点，此时请求的数据报文会先到内核空间的 PREOUTING 链。此时报文的源 IP 为 CIP，目标 IP 为 VIP;</li>\n<li>2.PREOUTING 检查发现数据包的目标 IP 是本机，将数据包送至 INPUT 链条；</li>\n<li>3.IPVS 比对数据包请求的服务是否为集群服务，是则将请求报文中的源 MAC 修改为 DMAC，将目标 MAC 修改为 RMAC，然后将数据包通过 POSTROUTING 链发出，此时的源 IP 和目的 IP 均未修改，仅将源 MAC 修改为 DMAC，目标 MAC 修改为 RMAC；</li>\n<li>4.RS 拆解数据报文发现请求的 IP 地址是本机，则会接收该数据报文，而后构建响应报文发出，此时的源 IP 是 VIP，目标 IP 是 CIP；</li>\n<li>5. 响应报文最终送达至客户端；</li>\n</ul>\n<h5 id=\"34-nat特性总结\"><a class=\"anchor\" href=\"#34-nat特性总结\">#</a> 3.4 NAT 特性总结</h5>\n<ul>\n<li>1. 请求报文必须有 DS 节点转发，但响应报文必须不经过 DS 节点；</li>\n<li>2.RS 不能将网关指向 DS 节点的 DIP；</li>\n<li>3.DS 和 RS 节点必须位于同一物理网络中；</li>\n<li>4.DR 模型不支持地址转换，也不支持端口映射；</li>\n<li>5.RS 可以是常见的操作系统 Windows、Linux、MacOSl；</li>\n<li>6.RS 在 lo 接口上配置 VIP；</li>\n</ul>\n<h5 id=\"35-dr-arp参数\"><a class=\"anchor\" href=\"#35-dr-arp参数\">#</a> 3.5 DR ARP 参数</h5>\n<p>arp_ignore（控制系统在收到外部的 arp 请求时，是否应答。）</p>\n<ul>\n<li>0 默认值，将本机所有接口的所有信息向每一连接的网络进行通告。</li>\n<li>1 只应答本地主机访问网络接口（eth0-&gt;lo）, 才给予响应。</li>\n</ul>\n<p>arp_announce（控制系统是否对外宣布自己的地址）</p>\n<ul>\n<li>0 默认值，把本机所有接口的所有信息向每个接口的网络进行通信</li>\n<li>1 “尽量避免” 将接口信息向非直接连接网络进行通信</li>\n<li>2 “必须避免” 将接口信息向非本网络进行通信</li>\n</ul>\n<h5 id=\"36-dr模型场景实战\"><a class=\"anchor\" href=\"#36-dr模型场景实战\">#</a> 3.6 DR 模型场景实战</h5>\n<h6 id=\"361-dr架构规划\"><a class=\"anchor\" href=\"#361-dr架构规划\">#</a> 3.6.1 DR 架构规划</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/SMdcieN.jpeg\" alt=\"DR实现架构图.jpg\" /></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">角色</th>\n<th style=\"text-align:center\">主机名称</th>\n<th style=\"text-align:center\"><strong>外网地址</strong></th>\n<th style=\"text-align:center\"><strong>内网地址</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">客服端</td>\n<td style=\"text-align:center\">client</td>\n<td style=\"text-align:center\">eth0:192.168.40.10</td>\n<td style=\"text-align:center\">/</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">路由器</td>\n<td style=\"text-align:center\">route</td>\n<td style=\"text-align:center\">eth0:192.168.40.200</td>\n<td style=\"text-align:center\">eth1:172.16.1.200</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">LVS</td>\n<td style=\"text-align:center\">lb01</td>\n<td style=\"text-align:center\">/</td>\n<td style=\"text-align:center\">eth1:172.16.1.3/VIP:172.16.1.100</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">应用服务器</td>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">/</td>\n<td style=\"text-align:center\">eth1:172.16.1.7</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">应用服务器</td>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">/</td>\n<td style=\"text-align:center\">eth1:172.16.1.8</td>\n</tr>\n</tbody>\n</table>\n<h6 id=\"362-客户端配置\"><a class=\"anchor\" href=\"#362-客户端配置\">#</a> 3.6.2 客户端配置</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 eth1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 eth0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">UUID</span><span class=\"token operator\">=</span><span class=\"token string\">\"09f9df8f-9a2c-48ec-a530-cedcbc801991\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.40.10\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#GATEWAY=\"192.168.40.2\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#DNS1=\"223.5.5.5\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth0 &amp;&amp; ifup eth0</span></pre></td></tr></table></figure><h6 id=\"363-路由器配置\"><a class=\"anchor\" href=\"#363-路由器配置\">#</a> 3.6.3 路由器配置</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 eth0 (eth0: 192.168.40.200\tgateway: 192.168.40.2)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">UUID</span><span class=\"token operator\">=</span><span class=\"token string\">\"09f9df8f-9a2c-48ec-a530-cedcbc801991\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.40.200\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">GATEWAY</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.40.2\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">DNS1</span><span class=\"token operator\">=</span><span class=\"token string\">\"223.5.5.5\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#2. 配置 eth1 (eth1: 172.16.1.200)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"172.16.1.200\"</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">#3. 开启 forward 转发</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"net.ipv4.ip_forward = 1\" >> /etc/sysctl.conf </span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sysctl -p</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">#4. 清除 iptables 规则</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -F </span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -L -n</span></pre></td></tr></table></figure><h6 id=\"364-web01配置rs节点\"><a class=\"anchor\" href=\"#364-web01配置rs节点\">#</a> 3.6.4 web01 配置 (RS 节点)</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 eth0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 eth1 网关指向路由器</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"172.16.1.7\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">GATEWAY</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.200</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1 &amp;&amp; ifup eth1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#3. 配置 Nginx</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/lvs.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tserver_name lvs.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web01 Real Server\" > /code/index.html</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://172.16.1.7</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">#4. 配置 VIP 地址；</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp /etc/sysconfig/network-scripts/ifcfg-lo /etc/sysconfig/network-scripts/ifcfg-lo:0</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-lo:0</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token assign-left variable\">NETMASK</span><span class=\"token operator\">=</span><span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>loopback</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@proxy01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown lo:0 &amp;&amp; ifup lo:0</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\">#5. 配置 arp 抑制</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr></table></figure><h6 id=\"365-web02配置rs节点\"><a class=\"anchor\" href=\"#365-web02配置rs节点\">#</a> 3.6.5 web02 配置 (RS 节点)</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 eth0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 eth1 网关指向路由器</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"172.16.1.8\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">GATEWAY</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.200</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1 &amp;&amp; ifup eth1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#3. 配置 Nginx</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/lvs.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tserver_name lvs.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\troot /code<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\tindex index.html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"web02 Real Server\" > /code/index.html</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://172.16.1.8</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">#4. 配置 VIP 地址；</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp /etc/sysconfig/network-scripts/ifcfg-lo /etc/sysconfig/network-scripts/ifcfg-lo:0</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-lo:0</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token assign-left variable\">NETMASK</span><span class=\"token operator\">=</span><span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>loopback</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown lo:0 &amp;&amp; ifup lo:0</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\">#5. 配置 arp 抑制</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr></table></figure><h6 id=\"366-lvs配置\"><a class=\"anchor\" href=\"#366-lvs配置\">#</a> 3.6.6 LVS 配置</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 关闭 eth0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 配置 eth1 (eth1: 172.16.1.3  gateway：172.16.1.200)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"172.16.1.3\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">GATEWAY</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.200</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1 &amp;&amp; ifup eth1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#3. 配置 vip (vip : 172.16.1.100)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp /etc/sysconfig/network-scripts/ifcfg-eth1 /etc/sysconfig/network-scripts/ifcfg-eth1:1</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1:1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span>Ethernet</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span>none</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>eth1:1</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span>eth1:1</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1:1 &amp;&amp; ifup eth1:1</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">#4. 配置 LVS 规则，配置 DR 模型：</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -C</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -A -t 172.16.1.100:80 -s rr</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 172.16.1.100:80 -r 172.16.1.7:80 -g</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -a -t 172.16.1.100:80 -r 172.16.1.8:80 -g</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:80 rr</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.7:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr></table></figure><h6 id=\"367-路由器配置端口映射\"><a class=\"anchor\" href=\"#367-路由器配置端口映射\">#</a> 3.6.7 路由器配置端口映射</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 端口路由器的映射：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -A PREROUTING -d 192.168.40.200 -p tcp --dport 80 -j DNAT --to 172.16.1.100:80</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -A PREROUTING -d 192.168.40.200 -p tcp --dport 443 -j DNAT --to 172.16.1.100:443</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@route ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -t nat</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Chain PREROUTING <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>target     prot opt <span class=\"token builtin class-name\">source</span>               destination         </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>DNAT       tcp  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">192.168</span>.40.200       tcp dpt:80 to:172.16.1.100:80</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>DNAT       tcp  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">192.168</span>.40.200       tcp dpt:443 to:172.16.1.100:443</pre></td></tr></table></figure><h6 id=\"368-测试验证\"><a class=\"anchor\" href=\"#368-测试验证\">#</a> 3.6.8 测试验证</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 验证测试</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>web02 Real Server</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>web01 Real Server</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#2. 查看客户端是否与 web 服务器虚拟 IP 建立握手</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># dd if=/dev/zero of=/code/bigdata bs=3000M count=1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.16</span>.1.100:80         <span class=\"token number\">192.168</span>.40.1:61004      ESTABLISHED <span class=\"token number\">1809</span>/nginx: worker  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.16</span>.1.8:22           <span class=\"token number\">172.16</span>.1.41:51444       ESTABLISHED <span class=\"token number\">1676</span>/sshd: root@pts </pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#3. 对于客服端与路由器建立握手</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>C:<span class=\"token punctuation\">\\</span>Users<span class=\"token punctuation\">\\</span>Administrator<span class=\"token operator\">></span>netstat <span class=\"token parameter variable\">-an</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  TCP    <span class=\"token number\">192.168</span>.40.1:61004     <span class=\"token number\">192.168</span>.40.200:80      ESTABLISHED</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#4. 查看 LVS 连接记录</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -c -n</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>IPVS connection entries</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>pro expire state       <span class=\"token builtin class-name\">source</span>             virtual            destination</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>TCP 01:25  FIN_WAIT    <span class=\"token number\">192.168</span>.40.10:51664 <span class=\"token number\">172.16</span>.1.100:80    <span class=\"token number\">172.16</span>.1.7:80</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>TCP 01:23  FIN_WAIT    <span class=\"token number\">192.168</span>.40.10:51662 <span class=\"token number\">172.16</span>.1.100:80    <span class=\"token number\">172.16</span>.1.8:80</pre></td></tr></table></figure><h5 id=\"37-shell脚本配置lvs场景\"><a class=\"anchor\" href=\"#37-shell脚本配置lvs场景\">#</a> 3.7 shell 脚本配置 LVS 场景</h5>\n<p>在网络规划没有问题的情况下，通过脚本来实现 LVS-DR 模型。（注意修改脚本中的 IP 地址）</p>\n<h6 id=\"371-ds配置脚本\"><a class=\"anchor\" href=\"#371-ds配置脚本\">#</a> 3.7.1 DS 配置脚本</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat lvs_ds.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/usr/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">VIP</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">RS1</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.7</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">RS2</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.8</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">SCHEDULER</span><span class=\"token operator\">=</span>rr</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">DEV</span><span class=\"token operator\">=</span>eth1:1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token variable\">$1</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\"># 配置虚拟 IP 地址  VIP</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token function\">cat</span>  <span class=\"token operator\">></span>/etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span> <span class=\"token operator\">&lt;&lt;-</span>EOF</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span>Ethernet</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span>none</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;VIP&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tEOF</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\"># 启动网卡</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token function\">ifup</span> <span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token comment\"># 配置 LVS 规则</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-C</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-A</span> <span class=\"token parameter variable\">-t</span> <span class=\"token variable\">$&#123;VIP&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;PORT&#125;</span> <span class=\"token parameter variable\">-s</span> <span class=\"token variable\">$&#123;SCHEDULER&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-a</span> <span class=\"token parameter variable\">-t</span> <span class=\"token variable\">$&#123;VIP&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;PORT&#125;</span> <span class=\"token parameter variable\">-r</span> <span class=\"token variable\">$&#123;RS1&#125;</span> <span class=\"token parameter variable\">-g</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tipvsadm <span class=\"token parameter variable\">-a</span> <span class=\"token parameter variable\">-t</span> <span class=\"token variable\">$&#123;VIP&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;PORT&#125;</span> <span class=\"token parameter variable\">-r</span> <span class=\"token variable\">$&#123;RS2&#125;</span> <span class=\"token parameter variable\">-g</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tstop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t    <span class=\"token function\">ifdown</span> <span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t    <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t    ipvsadm <span class=\"token parameter variable\">-C</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t   <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t*<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: sh <span class=\"token variable\">$0</span> &#123; start | stop &#125;\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x  lvs_ds.sh</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh lvs_ds.sh stop</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh lvs_ds.sh start</span></pre></td></tr></table></figure><h6 id=\"372-rs配置脚本\"><a class=\"anchor\" href=\"#372-rs配置脚本\">#</a> 3.7.2 RS 配置脚本</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat lvs_rs.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/usr/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">VIP</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">DEV</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">case</span> <span class=\"token variable\">$1</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\"># ARP 抑制</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"1\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"2\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\"># VIP</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">cat</span>  <span class=\"token operator\">></span>/etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span> <span class=\"token operator\">&lt;&lt;-</span>EOF</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span>lo:0</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;VIP&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token assign-left variable\">NETMASK</span><span class=\"token operator\">=</span><span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span>yes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>loopback</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tEOF</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">ifup</span> <span class=\"token variable\">$&#123;DEV&#125;</span>\t<span class=\"token comment\"># 启动网卡</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tsystemctl start nginx</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    stop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_ignore</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_ignore</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_ignore</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/all/arp_announce</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/default/arp_announce</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">></span>/proc/sys/net/ipv4/conf/lo/arp_announce</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function\">ifdown</span> <span class=\"token variable\">$&#123;DEV&#125;</span>  <span class=\"token comment\"># 停止网卡</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/sysconfig/network-scripts/ifcfg-<span class=\"token variable\">$&#123;DEV&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        systemctl stop nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    *<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Usage: sh <span class=\"token variable\">$0</span> &#123; start | stop &#125;\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">esac</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x lvs_rs.sh </span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh lvs_rs.sh stop</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh lvs_rs.sh start</span></pre></td></tr></table></figure><h4 id=\"4lvskeepalived实现高可用\"><a class=\"anchor\" href=\"#4lvskeepalived实现高可用\">#</a> 4.LVS+Keepalived 实现高可用</h4>\n<h5 id=\"41-为什么需要高可用\"><a class=\"anchor\" href=\"#41-为什么需要高可用\">#</a> 4.1 为什么需要高可用</h5>\n<p>问题：LVS 可以实现负载均衡功能，但是没有健康检查机制，以及冗余机制。</p>\n<ul>\n<li>1. 如果一台 RS 节点故障，LVS 任然会将请求调度至该盖章 RS 节点服务器；</li>\n<li>2. 其次 LVS 节点出现故障，那么整个集群就无法正常对外提供服务；</li>\n</ul>\n<p>解决：可以使用 keepalived 软件来解决如上问题。</p>\n<ul>\n<li>1. 使用 keealived 可以实现 LVS 的健康检查机制，RS 节点故障，则自动剔除该故障的 RS 节点，如果 RS 节点恢复则自动加入集群；</li>\n<li>2. 使用 keealived 可以解决 LVS 单点故障，以此实现 LVS 的高可用</li>\n</ul>\n<p>总结：keealived 就是为 LVS 而诞生的。</p>\n<h5 id=\"42-master节点配置\"><a class=\"anchor\" href=\"#42-master节点配置\">#</a> 4.2 Master 节点配置</h5>\n<p>1. 安装 keealived 软件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 安装软件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install keepalived -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 关闭七层负载均衡的 keepalived</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#3. 配置 lvs-master 的 keepalived, （记得先删除 lvs 上的虚拟 IP，以及 ipvs 规则）</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sh lvs_ds.sh stop</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr></table></figure><p>2. 配置 lvs-master 的 keepalived</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb01</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    state MASTER</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    priority <span class=\"token number\">200</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    interface eth1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 配置集群地址访问的 IP+Port</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>virtual_server <span class=\"token number\">172.16</span>.1.100 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\"># 健康检查的时间，单位：秒</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\"># 配置负载均衡的算法</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\"># 设置 LVS 的模式 NAT|TUN|DR</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\"># 设置会话持久化的时间</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">#persistence_timeout 30</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\"># 设置协议</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-1</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    real_server <span class=\"token number\">172.16</span>.1.7 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\"># 权重配比设置为 1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token comment\"># 设置健康检查</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token comment\"># 检测后端 80 端口</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token comment\"># 超时时间</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token comment\"># 重试次数 2 次</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token comment\"># 间隔时间 3s</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>     <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-2</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    real_server <span class=\"token number\">172.16</span>.1.8 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token comment\"># 配置集群地址访问的 IP+Port</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>virtual_server <span class=\"token number\">172.16</span>.1.100 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    real_server <span class=\"token number\">172.16</span>.1.7 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    real_server <span class=\"token number\">172.16</span>.1.8 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"43-backup节点配置\"><a class=\"anchor\" href=\"#43-backup节点配置\">#</a> 4.3 Backup 节点配置</h5>\n<p>1. 安装 keealived 软件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 新的节点 172.16.1.4  需要做如下基础信息配置：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/sysconfig/network-scripts/ifcfg-eth1 </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"Ethernet\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">PROXY_METHOD</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">BROWSER_ONLY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">BOOTPROTO</span><span class=\"token operator\">=</span><span class=\"token string\">\"none\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">IPV4_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">IPV6INIT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">IPV6_AUTOCONF</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">IPV6_DEFROUTE</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">IPV6_FAILURE_FATAL</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">IPV6_ADDR_GEN_MODE</span><span class=\"token operator\">=</span><span class=\"token string\">\"stable-privacy\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth1\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">ONBOOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"yes\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">IPV6_PRIVACY</span><span class=\"token operator\">=</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">IPADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"172.16.1.4\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"24\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">GATEWAY</span><span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.1.200</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth1 &amp;&amp; ifup eth1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#2. 关闭七层负载均衡的 keepalived</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#3. 配置 lvs-master 的 keepalived, （记得先删除 lvs 上的虚拟 IP，以及 ipvs 规则）</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install keepalived -y</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install ipvsadm -y</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#4. 关闭 eth0</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifdown eth0</span></pre></td></tr></table></figure><p>2. 配置 keealived 未 BACKUP 角色</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    router_id lb02</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    priority <span class=\"token number\">150</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    interface eth1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    virtual_router_id <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    advert_int <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        auth_pass <span class=\"token number\">1111</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token number\">172.16</span>.1.100</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 配置集群地址访问的 IP+Port</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>virtual_server <span class=\"token number\">172.16</span>.1.100 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\"># 健康检查的时间，单位：秒</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\"># 配置负载均衡的算法</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    lb_algo wlc</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\"># 设置 LVS 的模式 NAT|TUN|DR</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\"># 设置会话持久化的时间</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">#persistence_timeout 30</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\"># 设置协议</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-1</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    real_server <span class=\"token number\">172.16</span>.1.7 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\"># 权重配比设置为 1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token comment\"># 设置健康检查</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token comment\"># 检测后端 80 端口</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token comment\"># 超时时间</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token comment\"># 重试次数 2 次</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token comment\"># 间隔时间 3s</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>     <span class=\"token comment\"># 负载均衡后端的真实服务节点 RS-2</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    real_server <span class=\"token number\">172.16</span>.1.8 <span class=\"token number\">80</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token comment\"># 权重配比设置为 1</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token comment\"># 设置健康检查</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token comment\"># 检测后端 80 端口</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            <span class=\"token comment\"># 超时时间</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token comment\"># 重试次数 2 次</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token comment\"># 间隔时间 3s</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token comment\"># 配置集群地址访问的 IP+Port</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>virtual_server <span class=\"token number\">172.16</span>.1.100 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    delay_loop <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    lb_algo rr</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    lb_kind DR</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    protocol TCP</pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    real_server <span class=\"token number\">172.16</span>.1.7 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            connect_port <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    real_server <span class=\"token number\">172.16</span>.1.8 <span class=\"token number\">443</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        weight <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        TCP_CHECK <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>            connect_port <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            connect_timeout  <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            nb_get_retry <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            delay_beefore_retry <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"44-测试验证\"><a class=\"anchor\" href=\"#44-测试验证\">#</a> 4.4 测试验证</h5>\n<p>1. 启动 keepalived 并查看 LVS 规则</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 启动 keepalived</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable keepalived</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable keepalived</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start keepalived</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start keepalived</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#2.MASTER 查看 LVS 规则</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:80 rr</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.7:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:443 rr</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.7:443               Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:443               Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#3.BACKUP 查看 LVS 规则</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:80 wlc</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.7:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:443 rr</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.7:443               Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:443               Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>    </pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#4. 查看 VIP</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip addr | grep 172.16.1.100</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    inet <span class=\"token number\">172.16</span>.1.100/32 scope global eth1</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">#5. 检查应用服务是否正常 </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>web01 Real Server</pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>web02 Real Server</pre></td></tr></table></figure><p>2. 如果 realserver 节点故障，是否会自动将其移除</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 停止 web01 服务</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop nginx </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 通过查看 systemctl status keepalived -l 会发现有移除的记录</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl status keepalived -l</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>● keepalived.service - LVS and VRRP High Availability Monitor</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   Loaded: loaded <span class=\"token punctuation\">(</span>/usr/lib/systemd/system/keepalived.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: disabled<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Thu <span class=\"token number\">2025</span>-09-11 <span class=\"token number\">21</span>:42:18 CST<span class=\"token punctuation\">;</span> 9min ago</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Process: <span class=\"token number\">2050</span> <span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/sbin/keepalived <span class=\"token variable\">$KEEPALIVED_OPTIONS</span> <span class=\"token punctuation\">(</span>code<span class=\"token operator\">=</span>exited, <span class=\"token assign-left variable\">status</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>/SUCCESS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> Main PID: <span class=\"token number\">2051</span> <span class=\"token punctuation\">(</span>keepalived<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   CGroup: /system.slice/keepalived.service</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>           ├─2051 /usr/sbin/keepalived <span class=\"token parameter variable\">-D</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>           ├─2052 /usr/sbin/keepalived <span class=\"token parameter variable\">-D</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>           └─2053 /usr/sbin/keepalived <span class=\"token parameter variable\">-D</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:20 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: TCP connection to <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:80 success.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:20 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: Adding <span class=\"token function\">service</span> <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:80 to VS <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.100<span class=\"token punctuation\">]</span>:80</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:26 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: TCP connection to <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:443 failed.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:26 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: TCP connection to <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:80 failed.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:27 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: TCP connection to <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:443 failed.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:27 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: Check on <span class=\"token function\">service</span> <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:443 failed after <span class=\"token number\">1</span> retry.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:27 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: Removing <span class=\"token function\">service</span> <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:443 from VS <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.100<span class=\"token punctuation\">]</span>:443</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:27 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: TCP connection to <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:80 failed.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:27 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: Check on <span class=\"token function\">service</span> <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:80 failed after <span class=\"token number\">1</span> retry.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Sep <span class=\"token number\">11</span> <span class=\"token number\">21</span>:51:27 lvs01 Keepalived_healthcheckers<span class=\"token punctuation\">[</span><span class=\"token number\">2052</span><span class=\"token punctuation\">]</span>: Removing <span class=\"token function\">service</span> <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.7<span class=\"token punctuation\">]</span>:80 from VS <span class=\"token punctuation\">[</span><span class=\"token number\">172.16</span>.1.100<span class=\"token punctuation\">]</span>:80</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#3. 检查 ipvsadm -L -n 节点信息</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:80 rr</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">11</span>        </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:443 rr</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:443               Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:80 wlc</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"44\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:443 rr</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:443               Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\">#4. 检查应用服务是否正常</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>web02 Real Server</pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>web02 Real Server</pre></td></tr></table></figure><p>2. 如果 ds 服务器故障，能否切换到备用节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 停止 Master 节点 keepalived</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop keepalived</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 查看备节点 VIP 是否漂移</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip addr | grep 172.16.1.100</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    inet <span class=\"token number\">172.16</span>.1.100/32 scope global eth1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#3. 查看备节点 IPVS 规则</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:80 wlc</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.7:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:80                Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>TCP  <span class=\"token number\">172.16</span>.1.100:443 rr</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.7:443               Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span>         </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  -<span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.8:443               Route   <span class=\"token number\">1</span>      <span class=\"token number\">0</span>          <span class=\"token number\">0</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>IP Virtual Server version <span class=\"token number\">1.2</span>.1 <span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Prot LocalAddress:Port Scheduler Flags</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  -<span class=\"token operator\">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#4. 测试服务是否可用  </span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>web01 Real Server</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:lvs.hmallleasing.com http://192.168.40.200</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>web02 Real Server</pre></td></tr></table></figure><h4 id=\"5-lvs持久连接实践\"><a class=\"anchor\" href=\"#5-lvs持久连接实践\">#</a> 5. LVS 持久连接实践</h4>\n<h5 id=\"51-什么是持久化连接\"><a class=\"anchor\" href=\"#51-什么是持久化连接\">#</a> 5.1 什么是持久化连接</h5>\n<p>LVS persistence 持久连接，无论使用任何调度算法，在一段时间内（默认 300s）, 能够实现将来自同一地址的请求始终发往同一个 RS，常用于 SSL、FTP 等协议。</p>\n<h5 id=\"52-持久化连接配置\"><a class=\"anchor\" href=\"#52-持久化连接配置\">#</a> 5.2 持久化连接配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -E -t 172.16.1.100:80 -p 30</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr></table></figure><h5 id=\"53-持久化连接测试\"><a class=\"anchor\" href=\"#53-持久化连接测试\">#</a> 5.3 持久化连接测试</h5>\n<p>客户端请求后，可以登陆 LVS 节点查看，是否有一个连接处于连接状态。（需要每个请求 TIME-WAIT 结算，才会断开连接）。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n -c</span></pre></td></tr></table></figure><h4 id=\"6-lvs调度算法详解\"><a class=\"anchor\" href=\"#6-lvs调度算法详解\">#</a> 6. LVS 调度算法详解</h4>\n<p>LVS 根据后端服务的负载，或其他的计算标准，判断挑选那台 RS 来进行请求处理。调度算法主要分为 “静态调度算法”，“静态调度算法”。</p>\n<p>静态调度算法：RR、WRR、SH、DH</p>\n<p>静态调度算法：LC、WLC、SED、NQ、LBLC、LBLCR</p>\n<h5 id=\"61-lvs静态调度算法\"><a class=\"anchor\" href=\"#61-lvs静态调度算法\">#</a> 6.1 LVS 静态调度算法</h5>\n<p>静态：仅根据算法本身进行调度，不考虑后端实际负载情况。</p>\n<h6 id=\"611-rr\"><a class=\"anchor\" href=\"#611-rr\">#</a> 6.1.1 RR</h6>\n<p>RR：round robin 轮询调度算法，将每一次用户的请求，轮流分配给 Real Server 节点。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -E -t 172.16.1.100:80 -s rr</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr></table></figure><h6 id=\"612-wrr\"><a class=\"anchor\" href=\"#612-wrr\">#</a> 6.1.2 WRR</h6>\n<p>WRR：weighted round robin 加权轮询调度算法，根据服务器的硬件情况、以及处理能力，为每台服务器分配不同的权值，使其能够接受相应权值的请求。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -E -t 172.16.1.100:80 -s wrr</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -e -t 172.16.1.100:80 -r 172.16.1.7:80 -g -w 5</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -e -t 172.16.1.100:80 -r 172.16.1.8:80 -g -w 1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr></table></figure><h6 id=\"613-sh\"><a class=\"anchor\" href=\"#613-sh\">#</a> 6.1.3 SH</h6>\n<p>SH：Source Hashing 源地址 hash 算法，将请求的源 IP 地址进行 Hash 运算，得到一个具体的数值，同时对后端服务器进行编号，按照运算结果将请求分发到对应编号的服务器上。</p>\n<p>1. 可以实现不同涟源 IP 的请求进行负载分发；</p>\n<p>2. 同时还能实现相同来源 IP 的请求始终被派发至某一台特定的节点；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -E -t 172.16.1.100:80 -s sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr></table></figure><h6 id=\"614-dh\"><a class=\"anchor\" href=\"#614-dh\">#</a> 6.1.4 DH</h6>\n<p>DH：destination hash 目标地址 hash 将客户端的请求，始终发往同一个 RS。</p>\n<p>应用场景：LVS-cache - 源站，使用调度至指定的 cache,，加速用户体验。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/JUBYAK4.png\" alt=\"2.png\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -E -t 172.16.1.100:80 -s dh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lvs01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ipvsadm -L -n</span></pre></td></tr></table></figure><h5 id=\"62-lvs动态调度算法\"><a class=\"anchor\" href=\"#62-lvs动态调度算法\">#</a> 6.2 LVS 动态调度算法</h5>\n<p>动态：根据算法及 RS 节点负载状态进行调度，较小的 RS 将被调度。</p>\n<h6 id=\"621-lc\"><a class=\"anchor\" href=\"#621-lc\">#</a> 6.2.1 LC</h6>\n<p>LC：Least-Connection 最少连接数调度算法，那台 RS 连接数少就将请求调度至哪台 RS。</p>\n<p>算法：Overhead = (Active * 256 + Inactive 仅连接) 一个活动连接相当于 256 个非活动连接。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/lGtVYhL.png\" alt=\"1.png\" /></p>\n<h6 id=\"622-wlc\"><a class=\"anchor\" href=\"#622-wlc\">#</a> 6.2.2 WLC</h6>\n<p>WLC：Weighted Least-Connection 加权最小连接数（默认调度算法），在服务器性能差异较大的情况下，采用 “加权最少连接” 调度算法优化负载均衡性能，权值较高的 RS 节点，将承受更多的连接；负载均衡可以自动问询 RS 节点服务器的负载状态，通过算法计算当前连接数最少的节点，而后将新的请求调度至该节点。</p>\n<p>算法：Overhead = (Active * 256 + Inactive) /weigth</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/FG9qL9H.png\" alt=\"3.png\" /></p>\n<h6 id=\"623-sed\"><a class=\"anchor\" href=\"#623-sed\">#</a> 6.2.3 SED</h6>\n<p>SED: Shortest Expected Delay 最短期望延迟，尽可能让权重高的优先接收请求，不在考虑非活动状态，把当前出于活动状态的数据 + 1，通过算法计算当前连接数最少的节点，而后将新的请求调度至该节点。</p>\n<p>算法：在 WLC 基础上改进，Overhead = (ACTIVE + 1) * 256/Weight</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/yTxt5Cs.png\" alt=\"1.png\" /></p>\n<h6 id=\"624-nq\"><a class=\"anchor\" href=\"#624-nq\">#</a> 6.2.4 NQ</h6>\n<p>NQ：Never Queue 永不排队 / 最少队列调度</p>\n<p>原理：SED 算法由于某台服务器的权重较小，比较空闲，甚至接收不到请求，而权重打的服务器会很忙，而 NQ 算法是说不管权重多大都会被分配到请求。简答来说，就是无需队列，如果有 Real Server 的连接数为 0 会直接分配过去，后续采用 SED 算法。</p>\n<p>算法：Overhead = (ACTIVE + 1) * 256/Weight</p>\n<h6 id=\"625-lblc\"><a class=\"anchor\" href=\"#625-lblc\">#</a> 6.2.5 LBLC</h6>\n<h6 id=\"626-lblcr\"><a class=\"anchor\" href=\"#626-lblcr\">#</a> 6.2.6 LBLCR</h6>\n",
            "tags": [
                "LVS"
            ]
        }
    ]
}