{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"kubernetes\" category",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/626047790.html",
            "url": "http://ixuyong.cn/posts/626047790.html",
            "title": "消费租赁系统微服务应用交付实践",
            "date_published": "2025-05-18T13:42:46.000Z",
            "content_html": "<h3 id=\"消费租赁系统微服务应用交付实践\"><a class=\"anchor\" href=\"#消费租赁系统微服务应用交付实践\">#</a> 消费租赁系统微服务应用交付实践</h3>\n<h4 id=\"一-部署中间件\"><a class=\"anchor\" href=\"#一-部署中间件\">#</a> 一、部署中间件</h4>\n<h5 id=\"11-部署mysql\"><a class=\"anchor\" href=\"#11-部署mysql\">#</a> 1.1 部署 MySQL</h5>\n<h6 id=\"111-mysql-configmap\"><a class=\"anchor\" href=\"#111-mysql-configmap\">#</a> 1.1.1 MySQL-ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 01-mysql-cm.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-cm</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  my.cnf: <span class=\"token operator\">|</span>-</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">[</span>mysqld<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">#performance setttings</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    lock_wait_timeout <span class=\"token operator\">=</span> <span class=\"token number\">3600</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    open_files_limit <span class=\"token operator\">=</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    back_log <span class=\"token operator\">=</span> <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    max_connections <span class=\"token operator\">=</span> <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    max_connect_errors <span class=\"token operator\">=</span> <span class=\"token number\">1000000</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    table_open_cache <span class=\"token operator\">=</span> <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    table_definition_cache <span class=\"token operator\">=</span> <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    thread_stack <span class=\"token operator\">=</span> 512K</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    sort_buffer_size <span class=\"token operator\">=</span> 4M</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    join_buffer_size <span class=\"token operator\">=</span> 4M</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    read_buffer_size <span class=\"token operator\">=</span> 8M</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    read_rnd_buffer_size <span class=\"token operator\">=</span> 4M</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    bulk_insert_buffer_size <span class=\"token operator\">=</span> 64M</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    thread_cache_size <span class=\"token operator\">=</span> <span class=\"token number\">768</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    interactive_timeout <span class=\"token operator\">=</span> <span class=\"token number\">600</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    wait_timeout <span class=\"token operator\">=</span> <span class=\"token number\">600</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    tmp_table_size <span class=\"token operator\">=</span> 32M</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    max_heap_table_size <span class=\"token operator\">=</span> 32M</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    max_allowed_packet <span class=\"token operator\">=</span> 128M</pre></td></tr></table></figure><h6 id=\"112-mysql-secret\"><a class=\"anchor\" href=\"#112-mysql-secret\">#</a> 1.1.2 MySQL-Secret</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 02-mysql-secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-secret</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>stringData:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  MYSQL_ROOT_PASSWORD: Superman*2023</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h6 id=\"113-mysql-statefulset\"><a class=\"anchor\" href=\"#113-mysql-statefulset\">#</a> 1.1.3 MySQL-StatefulSet</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-mysql-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-nf-flms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"mysql-nf-flms-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: mysql</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      role: nf-flms</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: mysql</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        role: nf-flms</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: db</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        image: mysql:8.0</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        args:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"--character-set-server=utf8\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - name: MYSQL_ROOT_PASSWORD</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              name: mysql-secret</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              key: MYSQL_ROOT_PASSWORD</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: MYSQL_DATABASE      <span class=\"token comment\">#数据库名称</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          value: nf-flms        </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - name: tcp-3306</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          containerPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            cpu: 2000m</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            memory: 4000Mi</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            cpu: 200m</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /var/lib/mysql/</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - name: config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          mountPath: /etc/mysql/conf.d/my.cnf</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          subPath: my.cnf</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      - name: config</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          name: mysql-cm</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          items:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            - key: my.cnf</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>              path: my.cnf</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          defaultMode: <span class=\"token number\">420</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span> <span class=\"token string\">\"ReadWriteOnce\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"114-mysql-service\"><a class=\"anchor\" href=\"#114-mysql-service\">#</a> 1.1.4 MySQL Service</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-mysql-nf-flms-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-nf-flms-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    role: nf-flms</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - name: tcp-mysql-svc</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: mysql-nf-flms-svc-balance</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  namespace: prod </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    role: nf-flms</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  - name: tcp-mysql-balance</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    nodePort: <span class=\"token number\">32206</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  type: NodePort</pre></td></tr></table></figure><h6 id=\"115-更新资源清单\"><a class=\"anchor\" href=\"#115-更新资源清单\">#</a> 1.1.5 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create ns prod</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr></table></figure><h6 id=\"116-导入数据库\"><a class=\"anchor\" href=\"#116-导入数据库\">#</a> 1.1.6 导入数据库</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local +short</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">172.16</span>.85.231</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 172.16.85.231 -uroot -p\"Superman*2023\" -B nf_flms &lt; 202503310038/sggyl_nf_flms_202503310038.sql</span></pre></td></tr></table></figure><h6 id=\"117-连接外部数据库示例\"><a class=\"anchor\" href=\"#117-连接外部数据库示例\">#</a> 1.1.7 连接外部数据库示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 05-mysql-nf-flms-svc-external.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: mysql-nf-flms-svc-external</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: mysql-nf-flms-svc-external</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: mysql</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">3306</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kind: Endpoints</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    app: mysql-nf-flms-svc-external</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  name: mysql-nf-flms-svc-external</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>subsets:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>- addresses:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  - ip: <span class=\"token number\">192.168</span>.1.68</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  - name: mysql</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 mysql-nf-flms-svc-external.prod.svc.cluster.local +short</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token number\">192.168</span>.1.68</pre></td></tr></table></figure><h5 id=\"12-部署redis-single\"><a class=\"anchor\" href=\"#12-部署redis-single\">#</a> 1.2 部署 Redis-single</h5>\n<h6 id=\"121-redis-configmap\"><a class=\"anchor\" href=\"#121-redis-configmap\">#</a> 1.2.1 Redis-ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-redis-cm.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: redis-conf</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  redis.conf: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">0.0</span>.0.0</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    appendonly <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    protected-mode no</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">dir</span> /data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    requirepass Superman*2023</pre></td></tr></table></figure><h6 id=\"122-redis-statefulset\"><a class=\"anchor\" href=\"#122-redis-statefulset\">#</a> 1.2.2 Redis-StatefulSet</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-redis-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: redis</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: redis-svc</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: redis</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: redis</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: redis</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        image: redis:6.2.7</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        - <span class=\"token string\">\"redis-server\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        args:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"/etc/redis/redis.conf\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - name: redis-6379</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          containerPort: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            port: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        - name: config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          mountPath: /etc/redis</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          mountPath: /data</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            cpu: <span class=\"token string\">'2'</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            memory: 4000Mi</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            cpu: 100m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      - name: config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          name: redis-conf</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          items:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          - key: redis.conf</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            path: redis.conf</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span> <span class=\"token string\">\"ReadWriteOnce\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          storage: 2Gi</pre></td></tr></table></figure><h6 id=\"123-redis-service\"><a class=\"anchor\" href=\"#123-redis-service\">#</a> 1.2.3 Redis-Service</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-redis-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: redis-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    app: redis</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    - name: redis-6379</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      port: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      targetPort: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    app: redis</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  clusterIP: None</pre></td></tr></table></figure><h6 id=\"124-更新资源清单\"><a class=\"anchor\" href=\"#124-更新资源清单\">#</a> 1.2.4 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr></table></figure><h5 id=\"14-部署nacos集群\"><a class=\"anchor\" href=\"#14-部署nacos集群\">#</a> 1.4 部署 Nacos 集群</h5>\n<h6 id=\"141-部署nacos-mysql\"><a class=\"anchor\" href=\"#141-部署nacos-mysql\">#</a> 1.4.1 部署 Nacos-MySQL</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-mysql-nacos-sts-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-nacos-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    role: nacos</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  name: mysql-nacos-balance</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    role: nacos</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  - name: tcp-mysql-balance</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    nodePort: <span class=\"token number\">31106</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  type: NodePort</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  name: mysql-nacos</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  serviceName: <span class=\"token string\">\"mysql-nacos-svc\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      app: mysql</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      role: nacos</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        app: mysql</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        role: nacos</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      - name: db</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        image: mysql:8.0</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        args:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        - <span class=\"token string\">\"--character-set-server=utf8\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        - name: MYSQL_ROOT_PASSWORD</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          value: Superman*2023</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        - name: MYSQL_DATABASE    <span class=\"token comment\">#nacos 库名称</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          value: nacos</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        - containerPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            cpu: <span class=\"token string\">'2'</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            memory: 4000Mi</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            cpu: 100m</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          mountPath: /var/lib/mysql/</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"142-导入数据库\"><a class=\"anchor\" href=\"#142-导入数据库\">#</a> 1.4.2 导入数据库</h6>\n<p>nacos 下载地址：<a href=\"https://nacos.io/download/release-history/?spm=5238cd80.7a4232a8.0.0.f834e7559caaaK\">https://nacos.io/download/release-history/?spm=5238cd80.7a4232a8.0.0.f834e7559caaaK</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\">#  sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-mysql-nacos-sts-svc.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 mysql-nacos-svc.prod.svc.cluster.local +short</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">172.16</span>.32.159</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 172.16.32.159 -uroot -p\"Superman*2023\" -B nacos &lt; nacos/conf/mysql-schema.sql</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 172.16.32.159 -uroot -p\"Superman*2023\" -B nacos &lt; sggyl_nf_nacos_202505210038.sql</span></pre></td></tr></table></figure><h6 id=\"143-部署nacos-configmap\"><a class=\"anchor\" href=\"#143-部署nacos-configmap\">#</a> 1.4.3 部署 Nacos-ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-nacos-configmap.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nacos-cm</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  mysql.host: <span class=\"token string\">\"mysql-nacos-svc.prod.svc.cluster.local\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  mysql.db.name: <span class=\"token string\">\"nacos\"</span>   <span class=\"token comment\">#nacos 数据库名称</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  mysql.port: <span class=\"token string\">\"3306\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  mysql.user: <span class=\"token string\">\"root\"</span>    <span class=\"token comment\">#nacos 数据库用户名</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  mysql.password: <span class=\"token string\">\"Superman*2023\"</span>   <span class=\"token comment\">#nacos 数据库密码</span></pre></td></tr></table></figure><h6 id=\"144-部署nacos-service-statefulset\"><a class=\"anchor\" href=\"#144-部署nacos-service-statefulset\">#</a> 1.4.4 部署 Nacos-Service-StatefulSet</h6>\n<p><strong>1. 开启鉴权</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-nacos-sts-deploy-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nacos-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: nacos</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: server</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: client-rpc</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - name: raft-rpc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    port: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    targetPort: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - name: old-raft-rpc</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    port: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    targetPort: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: nacos</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  serviceName: <span class=\"token string\">\"nacos-svc\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      app: nacos</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        app: nacos</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      affinity:                                                 <span class=\"token comment\"># 避免 Pod 运行到同一个节点上了</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                    values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"nacos\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      initContainers:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      - name: peer-finder-plugin-install</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        image: nacos/nacos-peer-finder-plugin:1.1</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        imagePullPolicy: IfNotPresent </pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            mountPath: /home/nacos/plugins/peer-finder</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            subPath: peer-finder</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      - name: nacos</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        image: nacos/nacos-server:v2.4.3</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            cpu: <span class=\"token string\">'2'</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            memory: 4Gi</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            memory: <span class=\"token string\">\"1Gi\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        - name: client-port</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          containerPort: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        - name: client-rpc</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          containerPort: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        - name: raft-rpc</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          containerPort: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        - name: old-raft-rpc</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          containerPort: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: NACOS_REPLICAS</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          value: <span class=\"token string\">\"3\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: SERVICE_NAME</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          value: <span class=\"token string\">\"nacos-svc\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        - name: DOMAIN_NAME</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          value: <span class=\"token string\">\"cluster.local\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        - name: MYSQL_SERVICE_HOST</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>              key: mysql.host</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        - name: MYSQL_SERVICE_DB_NAME</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>              key: mysql.db.name</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        - name: MYSQL_SERVICE_PORT</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>              key: mysql.port</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        - name: MYSQL_SERVICE_USER</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>              key: mysql.user</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        - name: MYSQL_SERVICE_PASSWORD</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>              key: mysql.password</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        - name: SPRING_DATASOURCE_PLATFORM</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          value: <span class=\"token string\">\"mysql\"</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        - name: NACOS_SERVER_PORT</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          value: <span class=\"token string\">\"8848\"</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        - name: NACOS_APPLICATION_PORT</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>          value: <span class=\"token string\">\"8848\"</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        - name: PREFER_HOST_MODE</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>          value: <span class=\"token string\">\"hostname\"</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        - name: NACOS_AUTH_ENABLE</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        - name: NACOS_AUTH_IDENTITY_KEY</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          value: <span class=\"token string\">\"nacosAuthKey\"</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        - name: NACOS_AUTH_IDENTITY_VALUE</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>          value: <span class=\"token string\">\"nacosSecurtyValue\"</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>        - name: NACOS_AUTH_TOKEN</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>          value: <span class=\"token string\">\"SecretKey012345678901234567890123456789012345678901234567890123456789\"</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        - name: NACOS_AUTH_TOKEN_EXPIRE_SECONDS</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>          value: <span class=\"token string\">\"18000\"</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>          mountPath: /home/nacos/plugins/peer-finder</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          subPath: peer-finder</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>          mountPath: /home/nacos/data</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>          subPath: data</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>          mountPath: /home/nacos/logs</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          subPath: logs</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>    - metadata:</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        name: data</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>      spec:</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>        accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>            storage: 5Gi</pre></td></tr></table></figure><p><strong>2. 关闭鉴权</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-nacos-sts-deploy-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nacos-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: nacos</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: server</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: client-rpc</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - name: raft-rpc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    port: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    targetPort: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - name: old-raft-rpc</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    port: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    targetPort: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: nacos</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  serviceName: <span class=\"token string\">\"nacos-svc\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      app: nacos</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        app: nacos</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      affinity:                                                 <span class=\"token comment\"># 避免 Pod 运行到同一个节点上了</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                    values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"nacos\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      initContainers:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      - name: peer-finder-plugin-install</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        image: nacos/nacos-peer-finder-plugin:1.1</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            mountPath: /home/nacos/plugins/peer-finder</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            subPath: peer-finder</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      - name: nacos</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        image: nacos/nacos-server:v2.4.3</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            cpu: <span class=\"token string\">'2'</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            memory: 4Gi</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            memory: <span class=\"token string\">\"1Gi\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        - name: client-port</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          containerPort: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        - name: client-rpc</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          containerPort: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        - name: raft-rpc</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          containerPort: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        - name: old-raft-rpc</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          containerPort: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: NACOS_AUTH_ENABLE</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          value: <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: MODE  </pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          value: <span class=\"token string\">\"cluster\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        - name: NACOS_SERVERS</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          value: <span class=\"token string\">\"nacos-0.nacos-svc.prod.svc.cluster.local:8848  nacos-1.nacos-svc.prod.svc.cluster.local:8848 nacos-2.nacos-svc.prod.svc.cluster.local:8848\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        - name: NACOS_VERSION</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          value: <span class=\"token number\">2.4</span>.3</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        - name: SPRING_DATASOURCE_PLATFORM</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          value: <span class=\"token string\">\"mysql\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        - name: NACOS_REPLICAS</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          value: <span class=\"token string\">\"3\"</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        - name: SERVICE_NAME </pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          value: <span class=\"token string\">\"nacos-svc\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        - name: DOMAIN_NAME </pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          value: <span class=\"token string\">\"cluster.local\"</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        - name: NACOS_SERVER_PORT   </pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          value: <span class=\"token string\">\"8848\"</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        - name: NACOS_APPLICATION_PORT</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          value: <span class=\"token string\">\"8848\"</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        - name: PREFER_HOST_MODE</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          value: <span class=\"token string\">\"hostname\"</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        - name: POD_NAMESPACE      </pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        - name: MYSQL_SERVICE_HOST</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>              key: mysql.host</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        - name: MYSQL_SERVICE_DB_NAME</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>              key: mysql.db.name</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        - name: MYSQL_SERVICE_PORT</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>              key: mysql.port</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        - name: MYSQL_SERVICE_USER</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>              key: mysql.user</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>        - name: MYSQL_SERVICE_PASSWORD</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>              key: mysql.password</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>          mountPath: /home/nacos/plugins/peer-finder</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>          subPath: peer-finder</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          mountPath: /home/nacos/data</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>          subPath: data</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>          mountPath: /home/nacos/logs</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>          subPath: logs</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>    - metadata:</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>        name: data</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>      spec:</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>        accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>            storage: 5Gi</pre></td></tr></table></figure><h6 id=\"145-部署nacos-ingress\"><a class=\"anchor\" href=\"#145-部署nacos-ingress\">#</a> 1.4.5 部署 Nacos-Ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-nacos-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nacos-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: nacos.hmallleasing.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            name: nacos-svc</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              number: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h6 id=\"146-更新资源清单\"><a class=\"anchor\" href=\"#146-更新资源清单\">#</a> 1.4.6 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#检查 cluster 是否一致</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># for i in &#123;0..2&#125;; do echo nacos-$i; kubectl exec nacos-$i -c nacos -n prod -- cat conf/cluster.conf; donenacos-0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#2025-05-21T10:43:12.668</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nacos-0.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nacos-1.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nacos-2.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>nacos-1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#2025-05-21T10:43:14.879</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nacos-0.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>nacos-1.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>nacos-2.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>nacos-2</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#2025-05-21T10:43:17.299</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nacos-0.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>nacos-1.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>nacos-2.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr></table></figure><h6 id=\"147-web访问nacos\"><a class=\"anchor\" href=\"#147-web访问nacos\">#</a> 1.4.7 Web 访问 nacos</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Url：http://nacos.hmallleasing.com/nacos </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>User: nacos</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Passwd: nacos</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iNiUErY.jpeg\" alt=\"Snipaste_2025-05-18_21-13-44.jpg\" /></p>\n<h5 id=\"15-部署xxl-job\"><a class=\"anchor\" href=\"#15-部署xxl-job\">#</a> 1.5 部署 xxl-job</h5>\n<h6 id=\"151-部署xxl-job-mysql\"><a class=\"anchor\" href=\"#151-部署xxl-job-mysql\">#</a> 1.5.1 部署 xxl-job-MySQL</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-mysql-xxljob-sts-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-xxljob-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    role: xxljob</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    - name: tcp-mysql-svc</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  name: mysql-xxljob-external</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    - name: tcp-mysql-external</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      nodePort: <span class=\"token number\">31206</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    role: xxljob</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  type: NodePort</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  name: mysql-xxljob</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  serviceName: <span class=\"token string\">\"mysql-xxljob-svc\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      app: mysql</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      role: xxljob</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        app: mysql</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        role: xxljob</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      - name: db</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        image: mysql:8.0</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        args:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - <span class=\"token string\">\"--character-set-server=utf8\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: MYSQL_ROOT_PASSWORD</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          value: Superman*2023</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - containerPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            cpu: 2000m</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            memory: 4000Mi</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            cpu: 200m</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          mountPath: /var/lib/mysql/</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"152-导入数据库\"><a class=\"anchor\" href=\"#152-导入数据库\">#</a> 1.5.2 导入数据库</h6>\n<p>xxljob 表结构下载地址：<a href=\"https://gitee.com/xuxueli0323/xxl-job/tree/3.1.0-release/doc/db\">https://gitee.com/xuxueli0323/xxl-job/tree/3.1.0-release/doc/db</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-mysql-xxljob-sts-svc.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 mysql-xxljob-svc.prod.svc.cluster.local +short</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">172.16</span>.85.250</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 172.16.85.250  -uroot -p\"Superman*2023\"  &lt; tables_xxl_job.sql</span></pre></td></tr></table></figure><h6 id=\"153-部署xxl-job-service-deployment\"><a class=\"anchor\" href=\"#153-部署xxl-job-service-deployment\">#</a> 1.5.3 部署 xxl-job-Service-Deployment</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-xxljob-deploy-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: xxl-job</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: xxl-job</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: xxl-job</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - image: xuxueli/xxl-job-admin:3.1.0</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        name: xxl-job</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - name: PARAMS</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          value: <span class=\"token string\">\"--spring.datasource.url=jdbc:mysql://mysql-xxljob-svc.prod.svc.cluster.local:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai --spring.datasource.username=root --spring.datasource.password=Superman*2023\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            cpu: <span class=\"token string\">'1'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            memory: 2000Mi</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            cpu: 100m</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  name: xxljob-svc</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    name: http</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    app: xxl-job</pre></td></tr></table></figure><h6 id=\"154-部署xxl-job-service\"><a class=\"anchor\" href=\"#154-部署xxl-job-service\">#</a> 1.5.4 部署 xxl-job-service</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 04-xxljob-external.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: xxljob-balancer</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  type: NodePort</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - name: xxljob-balancer</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app: xxl-job</pre></td></tr></table></figure><h6 id=\"155-部署xxl-job-ingress\"><a class=\"anchor\" href=\"#155-部署xxl-job-ingress\">#</a> 1.5.5 部署 xxl-job-Ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 03-xxljob-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: xxljob-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: xxljob.hmallleasing.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            name: xxljob-svc</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h6 id=\"156-更新资源清单\"><a class=\"anchor\" href=\"#156-更新资源清单\">#</a> 1.5.6 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr></table></figure><h6 id=\"157-web访问xxl-job\"><a class=\"anchor\" href=\"#157-web访问xxl-job\">#</a> 1.5.7 Web 访问 xxl-job</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://192.168.40.101:30904/xxl-job-admin/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>http://xxljob.hmallleasing.com/xxl-job-admin/ </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>user:admin    </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pwd:1223456</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/A5NbU2Z.jpeg\" alt=\"Snipaste_2025-05-18_14-54-59.jpg\" /></p>\n<h5 id=\"16-部署rabbitmq集群\"><a class=\"anchor\" href=\"#16-部署rabbitmq集群\">#</a> 1.6 部署 rabbitmq 集群</h5>\n<h6 id=\"161-创建rbac权限\"><a class=\"anchor\" href=\"#161-创建rbac权限\">#</a> 1.6.1 创建 RBAC 权限</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-rabbitmq-rbac.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>- apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"endpoints\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  namespace: prod</pre></td></tr></table></figure><h6 id=\"162-创建集群的secret\"><a class=\"anchor\" href=\"#162-创建集群的secret\">#</a> 1.6.2 创建集群的 Secret</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-rabbitmq-secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>stringData:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  password: talent</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  url: amqp://RABBITMQ_USER:RABBITMQ_PASS@rmq-cluster-balancer</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  username: superman</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h6 id=\"163-创建configmap\"><a class=\"anchor\" href=\"#163-创建configmap\">#</a> 1.6.3 创建 ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-rabbitmq-cm.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-cluster-config</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    addonmanager.kubernetes.io/mode: Reconcile</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    enabled_plugins: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">[</span>rabbitmq_management,rabbitmq_peer_discovery_k8s<span class=\"token punctuation\">]</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    rabbitmq.conf: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      loopback_users.guest <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      default_user <span class=\"token operator\">=</span> RABBITMQ_USER</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      default_pass <span class=\"token operator\">=</span> RABBITMQ_PASS</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token comment\">## Cluster </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cluster_formation.peer_discovery_backend <span class=\"token operator\">=</span> rabbit_peer_discovery_k8s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      cluster_formation.k8s.host <span class=\"token operator\">=</span> kubernetes.default.svc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token comment\">#cluster_formation.k8s.host = kubernetes.default.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cluster_formation.k8s.address_type <span class=\"token operator\">=</span> <span class=\"token function\">hostname</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\"># prod is rabbitmq-cluster's namespace#</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      cluster_formation.k8s.hostname_suffix <span class=\"token operator\">=</span> .rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      cluster_formation.node_cleanup.interval <span class=\"token operator\">=</span> <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      cluster_formation.node_cleanup.only_log_warning <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      cluster_partition_handling <span class=\"token operator\">=</span> autoheal</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">## queue master locator</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      queue_master_locator <span class=\"token operator\">=</span> min-masters</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      cluster_formation.randomized_startup_delay_range.min <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      cluster_formation.randomized_startup_delay_range.max <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token comment\"># memory</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      vm_memory_high_watermark.absolute <span class=\"token operator\">=</span> 100MB</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token comment\"># disk</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      disk_free_limit.absolute <span class=\"token operator\">=</span> 2GB</pre></td></tr></table></figure><p><em>注：配置文件 cluster_formation.k8s.host 设置为 kubernetes.default.svc.cluster.local，然后就是各种连不上，后来换上 kubernetes.default.svc 就可以了，不知道是不是 k8s 新版本的问题。</em></p>\n<h6 id=\"164-创建集群的svc\"><a class=\"anchor\" href=\"#164-创建集群的svc\">#</a> 1.6.4 创建集群的 svc</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-rabbitmq-cluster-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: rmqport</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    app: rabbitmq-cluster-balancer</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  name: rabbitmq-cluster-balancer</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  - name: rmqport</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  type: NodePort</pre></td></tr></table></figure><h6 id=\"165-创建statefulset\"><a class=\"anchor\" href=\"#165-创建statefulset\">#</a> 1.6.5 创建 StatefulSet</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 05-rabbitmq-cluster-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  serviceName: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      affinity:                                                 <span class=\"token comment\"># 避免 Pod 运行到同一个节点上了</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-cluster\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - <span class=\"token parameter variable\">-c</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-v</span> /etc/rabbitmq/rabbitmq.conf <span class=\"token variable\">$&#123;RABBITMQ_CONFIG_FILE&#125;</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">exec</span> docker-entrypoint.sh rabbitmq-server</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: RABBITMQ_DEFAULT_USER</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: username</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: RABBITMQ_DEFAULT_PASS </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>              key: password </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        - name: TZ</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          value: <span class=\"token string\">'Asia/Shanghai'</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        - name: RABBITMQ_ERLANG_COOKIE</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          value: <span class=\"token string\">'SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY='</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: K8S_SERVICE_NAME</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          value: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: POD_IP</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: POD_NAME</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        - name: RABBITMQ_USE_LONGNAME</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: RABBITMQ_NODENAME</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          value: rabbit@<span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAME<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">.</span><span class=\"token variable\"><span class=\"token variable\">$(</span>K8S_SERVICE_NAME<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">.</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span>.svc.cluster.local</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: RABBITMQ_CONFIG_FILE</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          value: /var/lib/rabbitmq/rabbitmq.conf</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        image: rabbitmq:3.9-management</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        name: rabbitmq</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        - containerPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          name: http</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        - containerPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          name: amqp</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-diagnostics\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          periodSeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-diagnostics\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          periodSeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        - mountPath: /etc/rabbitmq</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          name: config-volume</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        - mountPath: /var/lib/rabbitmq</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      serviceAccountName: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>      terminationGracePeriodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>      - name: config-volume</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          items:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>          - key: rabbitmq.conf</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>            path: rabbitmq.conf</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          - key: enabled_plugins</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            path: enabled_plugins</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          name: rabbitmq-cluster-config</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      accessModes:</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>      - ReadWriteMany</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"166-创建ingress\"><a class=\"anchor\" href=\"#166-创建ingress\">#</a> 1.6.6 创建 Ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 06-rabbitmq-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: rabbitmq.hmallleasing.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              number: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h6 id=\"167-更新资源清单\"><a class=\"anchor\" href=\"#167-更新资源清单\">#</a> 1.6.7 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n prod</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                 READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmq-cluster-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m53s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rabbitmq-cluster-1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m47s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rabbitmq-cluster-2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m40s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it rabbitmq-cluster-0 -n prod -- /bin/bash</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@rabbitmq-cluster-0:/<span class=\"token comment\"># rabbitmqctl cluster_status</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>RABBITMQ_ERLANG_COOKIE <span class=\"token function\">env</span> variable support is deprecated and will be REMOVED <span class=\"token keyword\">in</span> a future version. Use the <span class=\"token environment constant\">$HOME</span>/.erlang.cookie <span class=\"token function\">file</span> or the --erlang-cookie switch instead.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Cluster status of <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Basics</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Cluster name: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Disk Nodes</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Running Nodes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Versions</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Maintenance status</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Alarms</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>Network Partitions</pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">(</span>none<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>Listeners</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>Feature flags</pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>Flag: drop_unroutable_metric, state: enabled</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>Flag: empty_basic_get_metric, state: enabled</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>Flag: implicit_default_bindings, state: enabled</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>Flag: maintenance_mode_status, state: enabled</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>Flag: quorum_queue, state: enabled</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>Flag: stream_queue, state: enabled</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>Flag: user_limits, state: enabled</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>Flag: virtual_host_metadata, state: enabled</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/XqURJbg.jpeg\" alt=\"Snipaste_2025-05-17_17-42-47.jpg\" /></p>\n<h6 id=\"168-web访问rabbitmq\"><a class=\"anchor\" href=\"#168-web访问rabbitmq\">#</a> 1.6.8 Web 访问 rabbitmq</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://rabbitmq.hmallleasing.com/<span class=\"token comment\">#/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>user:superman</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pwd:talent</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/7qKxUBf.jpeg\" alt=\"Snipaste_2025-05-17_17-14-54.jpg\" /></p>\n<h6 id=\"168-rabbitmq全部挂了无法重启解决方案\"><a class=\"anchor\" href=\"#168-rabbitmq全部挂了无法重启解决方案\">#</a> 1.6.8 rabbitMQ 全部挂了，无法重启解决方案</h6>\n<p>Kubernetes 环境中，遇到 RabbitMQ 集群无法启动的问题。原因是 RabbitMQ 所有实例均失效，需要在每个 Pod 对应的持久化存储路径下创建 force_load 文件来强制启动。通过获取 PV 存储路径，在指定目录创建该文件后，重新启动 RabbitMQ 服务，成功解决了集群启动问题</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token comment\"># cd /data/dev-rabbitmq-storage-rabbitmq-cluster-0-pvc-3abca920-3c68-44eb-b0fd-406a4358b153/mnesia/rabbit@rabbitmq-cluster-0.rabbitmq-cluster.dev.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 rabbit@rabbitmq-cluster-0.rabbitmq-cluster.dev.svc.cluster.local<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch force_load</span></pre></td></tr></table></figure><h5 id=\"17-部署rabbitmq-single\"><a class=\"anchor\" href=\"#17-部署rabbitmq-single\">#</a> 1.7 部署 rabbitmq-single</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 06-rabbitmq-single.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-single-data</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  storageClassName: <span class=\"token string\">\"nfs-storage\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      storage: 1Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  name: rabbitmq-single-svc</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    name: rabbitmq-single-svc</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  - port: <span class=\"token number\">5672</span> </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    name: web</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    app: rabbitmq-single</pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>apiVersion: networking.k8s.io/v1 <span class=\"token comment\"># k8s >= 1.22 必须 v1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  name: rabbitmq-single-ingress</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  ingressClassName: nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  - host: rabbitmq.hmallleasing.com</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            name: rabbitmq-single-svc</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>              number: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  name: rabbitmq-single</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      app: rabbitmq-single</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        app: rabbitmq-single</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      - name: rabbitmq-single</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        image: rabbitmq:3.9-management</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        - containerPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          name: web</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        - containerPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          name: http</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        - name: RABBITMQ_DEFAULT_USER  <span class=\"token comment\"># 自定义环境变量</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          value: admin</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        - name: RABBITMQ_DEFAULT_PASS</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          value: Superman*2025</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            memory: <span class=\"token string\">\"1Gi\"</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            cpu: <span class=\"token string\">\"500m\"</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmqctl\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmqctl\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        - name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>          mountPath: /var/lib/rabbitmq</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>      - name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          claimName: rabbitmq-single-data</pre></td></tr></table></figure><h4 id=\"二-微服务配置\"><a class=\"anchor\" href=\"#二-微服务配置\">#</a> 二、微服务配置</h4>\n<h5 id=\"21-代码编译前配置\"><a class=\"anchor\" href=\"#21-代码编译前配置\">#</a> 2.1 代码编译前配置</h5>\n<p>每个微服务需要配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins nf-flms<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nf-flms-order/src/main/resources/bootstrap-prd.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>info:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  groupId: @project.groupId@</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  artifactId: @project.artifactId@</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  version: @project.version@</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: 南方手机租赁平台</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  copyright: <span class=\"token number\">2021</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  description: 诚信 务实 专注 专业 创新</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>server:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  application:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    name: @artifactId@</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  profiles:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    active: prd</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  cloud:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    nacos:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      discovery:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        server-addr: nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        namespace: 1d994267-0b13-45aa-bdbd-b810a37725ef</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        group: nf-flms</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      config:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        server-addr: <span class=\"token variable\">$&#123;spring.cloud.nacos.discovery.server-addr&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        namespace: <span class=\"token variable\">$&#123;spring.cloud.nacos.discovery.namespace&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        group: <span class=\"token variable\">$&#123;spring.cloud.nacos.discovery.group&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        file-extension: yml</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        shared-configs:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          - data-id: nf-flms-application-<span class=\"token variable\">$&#123;spring.profiles.active&#125;</span><span class=\"token builtin class-name\">.</span><span class=\"token variable\">$&#123;spring.cloud.nacos.config.file-extension&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            group: nf-flms</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            refresh: <span class=\"token boolean\">true</span></pre></td></tr></table></figure><h5 id=\"22-导入mvn本地依赖\"><a class=\"anchor\" href=\"#22-导入mvn本地依赖\">#</a> 2.2 导入 mvn 本地依赖</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins repository<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll ~/.m2/repository</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>total <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> aopalliance</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">4</span> root root   <span class=\"token number\">35</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> asm</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">30</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> avalon-framework</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">38</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> backport-util-concurrent</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">17</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> ch</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> classworlds</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">6</span> root root   <span class=\"token number\">62</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> cn</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>drwxr-xr-x <span class=\"token number\">36</span> root root <span class=\"token number\">4096</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">4</span> root root   <span class=\"token number\">61</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-beanutils</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-cli</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">27</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-codec</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">33</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-collections</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">35</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-configuration</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">26</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-dbcp</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">30</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-digester</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">24</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-el</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">32</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-fileupload</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">32</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-httpclient</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">24</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-io</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">26</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-lang</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">29</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-logging</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-net</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">26</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-pool</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">24</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> concurrent</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> de</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">19</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> dom4j</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">28</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> doxia</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>drwxr-xr-x <span class=\"token number\">17</span> root root  <span class=\"token number\">251</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> io</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">8</span> root root   <span class=\"token number\">96</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> jakarta</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>drwxr-xr-x <span class=\"token number\">14</span> root root  <span class=\"token number\">175</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> javax</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">23</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> joda-time</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">19</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> junit</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">19</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> log4j</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">20</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> logkit</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">20</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> math</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">18</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> me</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">34</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> mysql</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>drwxr-xr-x <span class=\"token number\">13</span> root root  <span class=\"token number\">167</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> net</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">18</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> ognl</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>drwxr-xr-x <span class=\"token number\">56</span> root root <span class=\"token number\">4096</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> org</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">21</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> redis</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">22</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> stax</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">5</span> root root   <span class=\"token number\">72</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> tomcat</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">19</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> xalan</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">24</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> xerces</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">4</span> root root   <span class=\"token number\">42</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> xml-apis</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">20</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> xmlenc</pre></td></tr></table></figure><h5 id=\"23-mvn打包代码\"><a class=\"anchor\" href=\"#23-mvn打包代码\">#</a> 2.3 mvn 打包代码</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins nf-flms<span class=\"token punctuation\">]</span><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/root/qzj-system-back/nf-flms</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins nf-flms<span class=\"token punctuation\">]</span><span class=\"token comment\"># mvn -B -U clean package -Dmaven.test.skip=true -Dautoconfig.skip</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3zRSM8b.png\" alt=\"PixPin_2025-05-22_15-40-30.png\" /></p>\n<h5 id=\"24-nacos配置\"><a class=\"anchor\" href=\"#24-nacos配置\">#</a> 2.4 Nacos 配置</h5>\n<h6 id=\"241-nf-flms-application-prdyml\"><a class=\"anchor\" href=\"#241-nf-flms-application-prdyml\">#</a> 2.4.1 nf-flms-application-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  mq:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    qos: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    maxRetries <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  security:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    jwt:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      issuer: nf-fmls</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\">#到期时间，单位毫秒</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      expiration: <span class=\"token punctuation\">&#123;</span>SYSTEM: <span class=\"token number\">1800000</span>, ALIPAY_MEMBER: <span class=\"token number\">31536000000</span>, SALES_MEMBER: <span class=\"token number\">31536000000</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      maxRetries: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      patterns:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        - /**</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    feign:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      allowHeads:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        - SOURCE_TYPE</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  rabbitmq:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    host: rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    username: superman</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    password: talent</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    publisher-confirms: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    publisher-returns: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    virtual-host: /</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    listener:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      simple:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        acknowledge-mode: manual</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        concurrency: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        max-concurrency: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        retry:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  klock:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\"># redis 地址</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    address: redis-0.redis-svc.prod.svc.cluster.local:6379</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\"># redis 密码</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\"># redis 数据索引</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    database: <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\"># 获取锁最长阻塞时间（默认：60，单位：秒）</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    waitTime: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\"># 已获取锁后自动释放时间（默认：60，单位：秒）</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    leaseTime: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>jetcache:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  statIntervalMinutes: <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  areaInCacheName: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  hiddenPackages: com.timedigit</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  local:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    default:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      type: linkedhashmap</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      keyConvertor: fastjson</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  remote:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    default:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      type: redis</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      keyConvertor: fastjson</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      valueEncoder: <span class=\"token function\">java</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      valueDecoder: <span class=\"token function\">java</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      poolConfig:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        minIdle: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        maxIdle: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        maxTotal: <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      host: redis-0.redis-svc.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      port: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      password: Superman*2023</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      database: <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token comment\"># feign 配置</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>feign:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  client:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    config:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      default:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        connectTimeout: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        readTimeout: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token comment\">#ribbon 请求处理的超时时间</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>ribbon:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token comment\">#全局请求连接的超时时间</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  ReadTimeout: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token comment\">#全局请求的超时时间</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  ConnectTimeout: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>xgyq:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  url: https://qiaozuji-flms-api.test.qiaozuji.com</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  accessKey: 7d82b81b9b6075f7</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  secretKey: 17b85704043f57759983af5a744d82c0</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  path: /data/</pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>ant:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token comment\">#正式参数</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  blockchainv3:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    endpoint: https://openapi.alipay.com/gateway.do</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    appId: <span class=\"token string\">'2021002169667748'</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    privateKey: MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCxCce/eHKuTv+joeDwQv1a2Po0HsoJWdnBK8DMlflC3P8bUbPLom690tIWSo1JQyAFEFDGnE3Wqc/GFEySNZvHJ693YRiyLoLtBTJw9i/yH8aINX8fQ+SbM9SxyiMl9wqc+16hxp93Rar7zZY9UbMI3bRhRquPA7rGm/66I5BldDaL1Hnh1ZQ2WwNMOpiw5vAN8ulqm3HAkUC4pReG+SCtgzu6jj2pfbViakXDCO0G7JdNKUI2G4Bhstx3V+mLYKD7+jRwaVWyZDmtiFfjPDXx2u9UYFYDrfLZb7FBs9EjzLO5z6qPerjxu5T8P5qKmsXpmyu6hfj1R3pKwILTIGGzAgMBAAECggEBAJt9U4q/Zzng+HXnP4DF1W9tEpOkVx5PZAldPEBzmDE5mHWOFLPNPiZKe2pIoD6wTfcklU1bCqJ3Ep2ORpJDs0X/fQUEqoQUhblWzy6XixTFA8Gt+rCjGK2XoD9moeg+SXwG6t57bKN89OejcUj58Jzg3ARz5Un+pJS7fcZOZgwzxoyDnhnfe7mEcN8bkuy/2PhRkZWcTkY6ND/Ey5VHk8dqjIQ7uLf3TEilL+mNdcNoguju3I0yhAEtJlhsefeKKcFADWxWZRY129RJPn22TlHNk6h5GmCktnNthaMH1yDWq7mhi/2dUYqE6KlKD37zveQnVUtR6OtMV0wcFeKqY8ECgYEA5aIDJzRicxKdbuX6+aIoGHkH3iU6gfHQRUdI4FGf3+ZqfZ3AKbsBQ5EtzIns9HXVLsPdqq7ZTeFcAeIR7hdeiTWec+fxTu0VROu4z8SMQFQQW2QlvBMfNcPhACOlCFw2aZGbsaqwFmXqshxOBeqzR57MYvTAERvtgN6NxZm0Ar8CgYEAxV3DnOi8uFnttYtf4jI06Fba2LcRJgVL10jUZBDdZLfgMCcWLVHKYc50VQIK7lnzH7uP8+mJEVwT7fMWAmi1+x4XX2o+hbx4rsLbAwTMlWgnj3bFtR1/3r4VW8IF2BN9U95+KuxdQ9UMCsStVYlL4RldEDS3Q2jSwfyRX7B5Qg0CgYAVogOmB9tWd+R49BWGuu4IEC7bkKpIX519SU/mQgpLr4tMtjXKOKHP2bd003GNPiSNOUqCr+Is4hQm4UNLKMxxJKn+xVUIWHFugr5wZFXKIaFA2thrNWn1SLTDrJf5h6Zgn6UJQclA8uz/RodbK1ckYiNjFyeY9QaU42J7wRUiRQKBgQCKxigh7x+rPEhBS3Oq94RuDYwpr2cWZcjy4hm9FoKlLAktsn4MdaMo7GKt1xbai1LA8EAC0CV5mFXHDRJftUKoBHuIsoqtvFza/NXEJJ65Oxf97xSLCef8NYmNEDrNuL55t0rdYX8ej/G8rJf4OeapqwzdtUNa2Zy/m5iYQNyyDQKBgDYtXji8LJFtuF5hOVLC5X9xZKUCiFnblD9Rkv2P5OwyfFkq8tQq1a122ha/8Vwyuv4M/C4yfeEVPbE45OMBxlcggLbtSyubEdno1etmNBftOSHeG7xXjoNqJqP7cRiFE3EgjHsbDOCiED7YCk0RsFnvXmCqL8jgUJUsuXQFZwMK</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    alipayPublicKey: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAgi1cntxez3ul/BPoOBpp2/4VczWnBZ2Hv1+r7hbsOjYqflOsBQYid/p8bN7WlyZ6QgwQO32288mORWH6scXBDAMc5g+nn4rBhSOqDHh0ZxVnf+RTqSMpp+207DcCO8MbEP5EucpYOsTIvOqufSY7QkTMcaNfaYxxTPLi20Y+VKY/EsB+m8UpY93f9cxKl8vwmpJUfOtU3ENxKfrAZhm1+h4QcFy5W7ERae1Htk40bMLCvWFCrNkhTXQ0LY9bJAPLGlr8zqv0Vb7PxauNdStgIuM7SPdFQ+ZJisj7kbvfeUbPFWMRRBJaBJJWmZYWsKP7RF1f7wSocZxodEUHyJp8IwIDAQAB</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    sceneCode: NFZL</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    subSceneCode: <span class=\"token string\">'0000000000025599'</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    siteUserId: <span class=\"token string\">'2088731937333632'</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    notifyUrl: </pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    timeout: 25h</pre></td></tr></table></figure><h6 id=\"242-nf-flms-gateway-prdyml\"><a class=\"anchor\" href=\"#242-nf-flms-gateway-prdyml\">#</a> 2.4.2 nf-flms-gateway-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  cloud:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    gateway:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      discovery:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>         locator:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           lowerCaseServiceId: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      routes:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        - id: nf-flms-system</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          uri: lb://nf-flms-system</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          order: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          predicates:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          - <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/system/**</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          filters:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          - <span class=\"token assign-left variable\">StripPrefix</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        - id: nf-flms-order</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          uri: lb://nf-flms-order</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          order: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          predicates:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/order/**</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          filters:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          - <span class=\"token assign-left variable\">StripPrefix</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - id: nf-flms-statistics</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          uri: lb://nf-flms-statistics</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          order: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          predicates:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          - <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/statistics/**</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          filters:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          - <span class=\"token assign-left variable\">StripPrefix</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - id: nf-flms-openapi</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          uri: lb://nf-flms-openapi</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          order: <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          predicates:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          - <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/openapi/**</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          filters:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          - <span class=\"token assign-left variable\">StripPrefix</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h6 id=\"243-nf-flms-order-prdyml\"><a class=\"anchor\" href=\"#243-nf-flms-order-prdyml\">#</a> 2.4.3 nf-flms-order-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 订单服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 订单服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>    </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 档案</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>document:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  path: /data/</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  job:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    adminAddresses: http://xxljob-svc.prod.svc.cluster.local:8080/xxl-job-admin</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    appName: nf-flms</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    ip:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    port: <span class=\"token number\">9996</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    logPath: /logs/jobhandler</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    accessToken:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    logRetentionDays: <span class=\"token number\">5</span>  </pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>sign:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  saas:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">#appId: 7438855101</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">#appKey: c8def27d26d9493d745cfba4a96fa3b5</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    appId: <span class=\"token number\">7438905950</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    appKey: 9554565359962695be2842dda660587a</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    host: https://smlopenapi.esign.cn</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>bairong:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  apiCode: <span class=\"token number\">3030942</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  appKey: f997bd90b4457e7407b249a228d903e35f71acf7a65544c08620fa41e32e1867</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  url: https://sandbox-api2.100credit.cn</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  strategyId: STR_BR0003107</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  confId: MCP_BR0001643</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  befor:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    path: /strategy_api/v3/hx_query</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  valid:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    path: /infoverify/v3/info_verify  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    enable: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"244-nf-flms-statistics-prdyml\"><a class=\"anchor\" href=\"#244-nf-flms-statistics-prdyml\">#</a> 2.4.4 nf-flms-statistics-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 统计服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 统计服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>   </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  job:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    adminAddresses: http://xxljob-svc.prod.svc.cluster.local:8080/xxl-job-admin</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    appName: nf-flms-statistics</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    ip:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    port: <span class=\"token number\">9996</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    logPath: /logs/jobhandler</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    accessToken:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    logRetentionDays: <span class=\"token number\">5</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    enable: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"245-nf-flms-system-prdyml\"><a class=\"anchor\" href=\"#245-nf-flms-system-prdyml\">#</a> 2.4.5 nf-flms-system-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 系统服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 系统服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>    </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    enable: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"246-nf-flms-openapi-prdyml\"><a class=\"anchor\" href=\"#246-nf-flms-openapi-prdyml\">#</a> 2.4.6 nf-flms-openapi-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 订单服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 订单服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>    </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  job:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    adminAddresses: http://xxljob-svc.prod.svc.cluster.local:8080/xxl-job-admin</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    appName: nf-flms</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    ip:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    port: <span class=\"token number\">9996</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    logPath: /logs/jobhandler</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    accessToken:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    logRetentionDays: <span class=\"token number\">5</span>  </pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">#蚂蚁区块链代扣</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>ant:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  blockchainv2:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>     callbackKey: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAgi1cntxez3ul/BPoOBpp2/4VczWnBZ2Hv1+r7hbsOjYqflOsBQYid/p8bN7WlyZ6QgwQO32288mORWH6scXBDAMc5g+nn4rBhSOqDHh0ZxVnf+RTqSMpp+207DcCO8MbEP5EucpYOsTIvOqufSY7QkTMcaNfaYxxTPLi20Y+VKY/EsB+m8UpY93f9cxKl8vwmpJUfOtU3ENxKfrAZhm1+h4QcFy5W7ERae1Htk40bMLCvWFCrNkhTXQ0LY9bJAPLGlr8zqv0Vb7PxauNdStgIuM7SPdFQ+ZJisj7kbvfeUbPFWMRRBJaBJJWmZYWsKP7RF1f7wSocZxodEUHyJp8IwIDAQAB</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>     <span class=\"token comment\">#callbackKey: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAigh2X40D7Rm6zu3UFkFVnnLU0higr3Q/IRN+qyAOO2CGddQ1xhyqNr82mYUHcUvKUkTV/QDi3yvfMfo2DUaffURWab0Ucth02mz70Jknse/BmkZLX0r3jiJGDErbwP1xb149GwkgM3ffwDB+LhXe/4Y0cOXJV2Qen0p3Krl5I5QFiuGfFNHPHsBJ6WRMNie8J/rvdOriVZlYmevzDxbeuvsdrXqLRIiLazvK1B0+8NcGhInCkVLFw/Zvu7piCUkyh01AyVDB13Qau6M4l93usp5jQXcTLLxMhjJTnO1L2kwGUCekKgutLbUXLa0Ar8DHrD6Z2sw8iz2hVJUXjufYMwIDAQAB</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    enable: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"247-nf-flms-admin-prdyml\"><a class=\"anchor\" href=\"#247-nf-flms-admin-prdyml\">#</a> 2.4.7 nf-flms-admin-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  security:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    user:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      name: admin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      password: 4Q3NGIqsnU3Arwg9</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  boot:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    admin:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      ui:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        title: <span class=\"token string\">'俏租机 服务状态监控'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        brand: <span class=\"token string\">'俏租机 服务状态监控'</span></pre></td></tr></table></figure><h6 id=\"248-nf-flms-file-prdyml\"><a class=\"anchor\" href=\"#248-nf-flms-file-prdyml\">#</a> 2.4.8 nf-flms-file-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 文件服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 文件服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>   </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  job:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    adminAddresses: http://192.168.1.70:30959/xxl-job-admin/</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    appName: nf-flms-statistics</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    ip:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    port: <span class=\"token number\">9996</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    logPath: /logs/jobhandler</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    accessToken:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    logRetentionDays: <span class=\"token number\">5</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    enable: <span class=\"token boolean\">false</span> </pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># 档案</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>document:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  path: /data/</pre></td></tr></table></figure><h5 id=\"25-构建镜像\"><a class=\"anchor\" href=\"#25-构建镜像\">#</a> 2.5 构建镜像</h5>\n<h6 id=\"251-构建nf-flms-order\"><a class=\"anchor\" href=\"#251-构建nf-flms-order\">#</a> 2.5.1 构建 nf-flms-order</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins nf-flms-order<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>COPY target/nf-flms-order.jar nf-flms-order.jar</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>EXPOSE <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-order.jar</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-order</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-order:v2.0 .</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-order:v2.0</span></pre></td></tr></table></figure><h6 id=\"252-构建nf-flms-statistics\"><a class=\"anchor\" href=\"#252-构建nf-flms-statistics\">#</a> 2.5.2 构建 nf-flms-statistics</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-statistics.jar nf-flms-statistics.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-statistics.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-statistics</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-statistics:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-statistics:v1</span></pre></td></tr></table></figure><h6 id=\"253-构建nf-flms-system\"><a class=\"anchor\" href=\"#253-构建nf-flms-system\">#</a> 2.5.3 构建 nf-flms-system</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-system.jar nf-flms-system.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">30011</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-system.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-system</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-system:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-system:v1</span></pre></td></tr></table></figure><h6 id=\"254-构建nf-flms-openapi\"><a class=\"anchor\" href=\"#254-构建nf-flms-openapi\">#</a> 2.5.4 构建 nf-flms-openapi</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-openapi.jar nf-flms-openapi.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">30022</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-openapi.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-openapi</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-openapi:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-openapi:v1</span></pre></td></tr></table></figure><h6 id=\"255-构建nf-flms-gateway\"><a class=\"anchor\" href=\"#255-构建nf-flms-gateway\">#</a> 2.5.5 构建 nf-flms-gateway</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-gateway.jar nf-flms-gateway.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-gateway.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-gateway</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-gateway:v2 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-gateway:v2</span></pre></td></tr></table></figure><h6 id=\"256-构建nf-flms-file\"><a class=\"anchor\" href=\"#256-构建nf-flms-file\">#</a> 2.5.6 构建 nf-flms-file</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-file.jar nf-flms-file.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">30017</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-file.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-file</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-file:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-file:v1</span></pre></td></tr></table></figure><h6 id=\"257-构建nf-flms-admin\"><a class=\"anchor\" href=\"#257-构建nf-flms-admin\">#</a> 2.5.7 构建 nf-flms-admin</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-admin.jar nf-flms-admin.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">30013</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-admin.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-admin</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-admin:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-admin:v1</span></pre></td></tr></table></figure><h5 id=\"26-配置xxl-job执行器\"><a class=\"anchor\" href=\"#26-配置xxl-job执行器\">#</a> 2.6 配置 XXL-JOB 执行器</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/LrPhTlM.png\" alt=\"微信图片_20250523105717.png\" /></p>\n<h4 id=\"三-部署微服务应用\"><a class=\"anchor\" href=\"#三-部署微服务应用\">#</a> 三、部署微服务应用</h4>\n<h5 id=\"31-创建secret\"><a class=\"anchor\" href=\"#31-创建secret\">#</a> 3.1 创建 secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#  sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl create secret tls prod-api.hmallleasig.com --key hmallleasing.com.key --cert hmallleasing.com.pem -n prod</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin --docker-server=registry.cn-hangzhou.aliyuncs.com --docker-username=xyapples@163.com --docker-password=passwd -n prod</span></pre></td></tr></table></figure><h5 id=\"32-创建nf-flms-gateway\"><a class=\"anchor\" href=\"#32-创建nf-flms-gateway\">#</a> 3.2 创建 nf-flms-gateway</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl apply -f 01-nf-flms-gateway.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/nf-flms-gateway created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>service/gateway-svc created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ingress.networking.k8s.io/gateway-ingress created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 01-nf-flms-gateway.yaml </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  name: nf-flms-gateway</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      app: nf-flms-gateway</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        app: nf-flms-gateway</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      - name: nf-flms-gateway</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-gateway:v2.2 </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-gateway.jar\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  name: gateway-svc</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    app: nf-flms-gateway</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  name: gateway-ingress</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-redirect: <span class=\"token string\">\"false\"</span>    <span class=\"token comment\">#禁用 https 强制跳转</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  - host: <span class=\"token string\">\"prod-api.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>            name: gateway-svc</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  tls:                  <span class=\"token comment\">#https</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  - hosts:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    - prod-api.hmallleasing.com</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    secretName: <span class=\"token string\">\"prod-api.hmallleasig.com\"</span>   <span class=\"token comment\">#配置默认证书可不添加 secretName</span></pre></td></tr></table></figure><h5 id=\"33-创建nf-flms-statistics\"><a class=\"anchor\" href=\"#33-创建nf-flms-statistics\">#</a> 3.3 创建 nf-flms-statistics</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-nf-flms-statistics.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-statistics</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-statistics</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-statistics</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-statistics</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-statistics:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-statistics.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"34-创建nf-flms-order\"><a class=\"anchor\" href=\"#34-创建nf-flms-order\">#</a> 3.4 创建 nf-flms-order</h5>\n<h6 id=\"341-创建pvc\"><a class=\"anchor\" href=\"#341-创建pvc\">#</a> 3.4.1 创建 PVC</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-data-image.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: data-image</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  storageClassName: <span class=\"token string\">\"nfs-storage\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      storage: 2Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请</span></pre></td></tr></table></figure><h6 id=\"342-创建nf-flms-order\"><a class=\"anchor\" href=\"#342-创建nf-flms-order\">#</a> 3.4.2 创建 nf-flms-order</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-nf-flms-order.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-order</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-order</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-order</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-order</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-order:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-order.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: data-image</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      - name: data-image</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        persistentVolumeClaim:      </pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          claimName: data-image</pre></td></tr></table></figure><h5 id=\"35-创建nf-flms-system\"><a class=\"anchor\" href=\"#35-创建nf-flms-system\">#</a> 3.5 创建 nf-flms-system</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-nf-flms-system.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-system</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-system</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-system</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-system</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-system:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-system.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"36-创建nf-flms-admin\"><a class=\"anchor\" href=\"#36-创建nf-flms-admin\">#</a> 3.6 创建 nf-flms-admin</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 05-nf-flms-admin.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-admin   </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-admin</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-admin</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-admin</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-admin:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-admin.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  name: nf-flms-admin-svc</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    app: nf-flms-admin</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  name: nf-flms-admin-ingress</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  - host: <span class=\"token string\">\"monitor.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            name: nf-flms-admin-svc</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr></table></figure><h5 id=\"37-创建nf-flms-openapi\"><a class=\"anchor\" href=\"#37-创建nf-flms-openapi\">#</a> 3.7 创建 nf-flms-openapi</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 06-nf-flms-openapi.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-openapi</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-openapi</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-openapi</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-openapi</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-openapi:v2.2 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-openapi.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"38-查看服务是否注册nacos\"><a class=\"anchor\" href=\"#38-查看服务是否注册nacos\">#</a> 3.8 查看服务是否注册 Nacos</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/I3obzQJ.png\" alt=\"1.png\" /></p>\n<h4 id=\"四-部署前端ui\"><a class=\"anchor\" href=\"#四-部署前端ui\">#</a> 四、部署前端 UI</h4>\n<h5 id=\"41-修改前端配置\"><a class=\"anchor\" href=\"#41-修改前端配置\">#</a> 4.1 修改前端配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins qzj-system-front<span class=\"token punctuation\">]</span><span class=\"token comment\"># git checkout nf-flms-ui-v2.2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins qzj-system-front<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim src/environments/environment.prod.ts</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins qzj-system-front<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat src/environments/environment.prod.ts</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">export</span> const environment <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  // SERVER_URL: <span class=\"token variable\"><span class=\"token variable\">`</span>https://nf-flms-api.prd.qiaozuji.com<span class=\"token variable\">`</span></span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  SERVER_URL: <span class=\"token variable\"><span class=\"token variable\">`</span>https://prod-api.hmallleasing.com<span class=\"token variable\">`</span></span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  production: true,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  useHash: true,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  hmr: false,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h5 id=\"42-编译项目\"><a class=\"anchor\" href=\"#42-编译项目\">#</a> 4.2 编译项目</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /soft/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://nodejs.org/dist/v12.20.0/node-v12.20.0-linux-x64.tar.xz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf node-v12.20.0-linux-x64.tar.xz -C /usr/local/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /usr/local/node-v12.20.0-linux-x64/</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 node<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv node-v12.20.0-linux-x64 node </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 node<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/profile.d/nodejs.sh </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">NODE_HOME</span><span class=\"token operator\">=</span>/usr/local/node</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token variable\">$NODE_HOME</span>/bin:<span class=\"token environment constant\">$PATH</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># node -v &amp;&amp; npm -v</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>v12.20.0</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">6.14</span>.8</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm install yarn -g</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># yarn -v</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">1.22</span>.19</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd nf-flms-ui/</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm install -g yarn -registry=https://registry.npm.taobao.org</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># yarn install</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm run build</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm run build-qnyp </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm run build-test</span></pre></td></tr></table></figure><h5 id=\"43编写dockerfile\"><a class=\"anchor\" href=\"#43编写dockerfile\">#</a> 4.3 编写 Dockerfile</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins qzj-system-front<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM nginx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>COPY ./dist/ /code</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>RUN <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/nginx/conf.d/default.conf</pre></td></tr></table></figure><h5 id=\"44-制作镜像并推送仓库\"><a class=\"anchor\" href=\"#44-制作镜像并推送仓库\">#</a> 4.4 制作镜像并推送仓库</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cd /root/nf-flms-ui</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-ui:v1.0 .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-ui:v1.0</span></pre></td></tr></table></figure><h5 id=\"45-创建configmap\"><a class=\"anchor\" href=\"#45-创建configmap\">#</a> 4.5 创建 ConfigMap</h5>\n<h6 id=\"451-准备nginx配置文件\"><a class=\"anchor\" href=\"#451-准备nginx配置文件\">#</a> 4.5.1 准备 Nginx 配置文件</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat prod.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        server_name prod.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        root /code/prod<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            index  index.html index.htm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        server_name prod-api.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                proxy_set_header REMOTE-HOST <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                proxy_pass http://gateway-svc.prod.svc.cluster.local:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"452-创建configmap\"><a class=\"anchor\" href=\"#452-创建configmap\">#</a> 4.5.2 创建 ConfigMap</h6>\n<p>在启动 ui 项目时，通过 configmap 挂载配置，便于后期动态修改；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create configmap nf-flms-ui-conf --from-file=./prod.hmallleasing.com.conf -n prod</span></pre></td></tr></table></figure><h5 id=\"46-创建前端ui\"><a class=\"anchor\" href=\"#46-创建前端ui\">#</a> 4.6 创建前端 UI</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 07-ui-deploy-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-ui</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-ui</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-ui</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-ui</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-ui:v1.0</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        - name: ngxconfs</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          mountPath: /etc/nginx/conf.d/</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      - name: ngxconfs</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          name: nf-flms-ui-conf</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  name: nf-flms-ui-svc</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    app: nf-flms-ui</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  name: nf-flms-ui-ingress</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-redirect: <span class=\"token string\">\"false\"</span>    <span class=\"token comment\">#禁用 https 强制跳转</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  - host: <span class=\"token string\">\"prod.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            name: nf-flms-ui-svc</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  tls:                  <span class=\"token comment\">#https</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  - hosts:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    - prod.hmallleasing.com</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    secretName: <span class=\"token string\">\"prod-api.hmallleasig.com\"</span>   <span class=\"token comment\">#配置默认证书可不添加 secretName</span></pre></td></tr></table></figure><h5 id=\"47-创建ssl-secret\"><a class=\"anchor\" href=\"#47-创建ssl-secret\">#</a> 4.7 创建 ssl secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd ssl/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ssl<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create secret tls prod-api.hmallleasig.com --key *.hmallleasing.com_key.key --cert *.hmallleasing.com_chain.crt -n dev</span></pre></td></tr></table></figure><h5 id=\"48-更新资源清单\"><a class=\"anchor\" href=\"#48-更新资源清单\">#</a> 4.8 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 07-ui-deploy-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n prod</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mysql-nacos-0                         <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>mysql-nf-flms-0                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7d4h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mysql-xxljob-0                        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nacos-0                               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4d22h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nacos-1                               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4d22h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>nacos-2                               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4d22h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>nf-flms-admin-576b8fb949-2w6vg        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          13m</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nf-flms-gateway-55cb54cc7c-jtmjj      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          28m</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>nf-flms-gateway-55cb54cc7c-zmgpc      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          28m</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>nf-flms-openapi-67d66d97cf-ldhgz      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          16m</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>nf-flms-openapi-67d66d97cf-vq82b      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15m</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>nf-flms-order-599dcd884c-k7rtf        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m57s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nf-flms-order-599dcd884c-wjtn7        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          11m</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>nf-flms-statistics-77bf7dd847-n7k46   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          23m</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>nf-flms-statistics-77bf7dd847-qjp7q   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          23m</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>nf-flms-system-8d5c784b9-2cwrj        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15m</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>nf-flms-system-8d5c784b9-lhs2f        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>nf-flms-ui-55467cd98b-gl99s           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          57m</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>rabbitmq-cluster-0                    <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>rabbitmq-cluster-1                    <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rabbitmq-cluster-2                    <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>redis-0                               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>xxl-job-76c9464876-dzntc              <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr></table></figure>",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/170573601.html",
            "url": "http://ixuyong.cn/posts/170573601.html",
            "title": "K8s服务发布Ingress",
            "date_published": "2025-04-26T08:52:06.000Z",
            "content_html": "<h4 id=\"1-ingress-nginx-controller-安装\"><a class=\"anchor\" href=\"#1-ingress-nginx-controller-安装\">#</a> 1. Ingress Nginx Controller 安装</h4>\n<table>\n<thead>\n<tr>\n<th>Supported</th>\n<th>Ingress-NGINX version</th>\n<th>k8s supported version</th>\n<th>Alpine Version</th>\n<th>Nginx Version</th>\n<th>Helm Chart Version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>🔄</td>\n<td><strong>v1.12.1</strong></td>\n<td>1.32, 1.31, 1.30, 1.29, 1.28</td>\n<td>3.21.3</td>\n<td>1.25.5</td>\n<td>4.12.1</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.12.0</strong></td>\n<td>1.32, 1.31, 1.30, 1.29, 1.28</td>\n<td>3.21.0</td>\n<td>1.25.5</td>\n<td>4.12.0</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.12.0-beta.0</strong></td>\n<td>1.32, 1.31, 1.30, 1.29, 1.28</td>\n<td>3.20.3</td>\n<td>1.25.5</td>\n<td>4.12.0-beta.0</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.5</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.21.3</td>\n<td>1.25.5</td>\n<td>4.11.5</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.4</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.21.0</td>\n<td>1.25.5</td>\n<td>4.11.4</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.3</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.3</td>\n<td>1.25.5</td>\n<td>4.11.3</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.2</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.11.2</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.1</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.11.1</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.0</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.11.0</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.6</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.21.0</td>\n<td>1.25.5</td>\n<td>4.10.6</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.5</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.3</td>\n<td>1.25.5</td>\n<td>4.10.5</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.4</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.10.4</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.3</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.10.3</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.2</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.10.2</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.1</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.19.1</td>\n<td>1.25.3</td>\n<td>4.10.1</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.0</strong></td>\n<td>1.29, 1.28, 1.27, 1.26</td>\n<td>3.19.1</td>\n<td>1.25.3</td>\n<td>4.10.0</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.6</td>\n<td>1.29, 1.28, 1.27, 1.26, 1.25</td>\n<td>3.19.0</td>\n<td>1.21.6</td>\n<td>4.9.1</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.5</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.4</td>\n<td>1.21.6</td>\n<td>4.9.0</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.4</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.4</td>\n<td>1.21.6</td>\n<td>4.8.3</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.3</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.4</td>\n<td>1.21.6</td>\n<td>4.8.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.1</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.4</td>\n<td>1.21.6</td>\n<td>4.8.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.0</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.2</td>\n<td>1.21.6</td>\n<td>4.8.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.8.4</td>\n<td>1.27, 1.26, 1.25, 1.24</td>\n<td>3.18.2</td>\n<td>1.21.6</td>\n<td>4.7.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.7.1</td>\n<td>1.27, 1.26, 1.25, 1.24</td>\n<td>3.17.2</td>\n<td>1.21.6</td>\n<td>4.6.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.6.4</td>\n<td>1.26, 1.25, 1.24, 1.23</td>\n<td>3.17.0</td>\n<td>1.21.6</td>\n<td>4.5.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.5.1</td>\n<td>1.25, 1.24, 1.23</td>\n<td>3.16.2</td>\n<td>1.21.6</td>\n<td>4.4.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.4.0</td>\n<td>1.25, 1.24, 1.23, 1.22</td>\n<td>3.16.2</td>\n<td>1.19.10†</td>\n<td>4.3.0</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.3.1</td>\n<td>1.24, 1.23, 1.22, 1.21, 1.20</td>\n<td>3.16.2</td>\n<td>1.19.10†</td>\n<td>4.2.5</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"11-helm安装ingress-nginx-controller\"><a class=\"anchor\" href=\"#11-helm安装ingress-nginx-controller\">#</a> 1.1 Helm 安装 Ingress Nginx Controller</h5>\n<ol>\n<li>安装 Helm</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># wget https://get.helm.sh/helm-v3.6.3-linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># tar xf helm-v3.6.3-linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># mv linux-amd64/helm /usr/local/bin/helm</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># helm version</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>下载 Ingress Nginx Controller 安装包</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>官方文档：https://github.com/kubernetes/ingress-nginx/tree/helm-chart-4.8.2         <span class=\"token comment\">#根据自己 k8s 版本下载</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># helm repo update</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># helm repo list</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># helm pull ingress-nginx/ingress-nginx --version 4.8.2</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>配置 Ingress Nginx Controller</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># tar xf ingress-nginx-4.8.2.tgz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># cd ingress-nginx</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># vim values.yaml</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token number\">16</span> controller:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token number\">17</span>   name: controller</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token number\">18</span>   enableAnnotationValidations: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token number\">19</span>   image:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token number\">20</span>     <span class=\"token comment\">## Keep false as default for now!</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token number\">21</span>     chroot: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token number\">22</span>     registry: registry.cn-hangzhou.aliyuncs.com</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token number\">23</span>     image: kubernetes_public/ingress-nginx-controller</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token number\">24</span>     <span class=\"token comment\">## for backwards compatibility consider setting the full image url via the repository value below</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token number\">25</span>     <span class=\"token comment\">## use *either* current default registry/image or repository format or installing chart by providing the values.yaml wil    l fail</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token number\">26</span>     <span class=\"token comment\">## repository:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token number\">27</span>     tag: <span class=\"token string\">\"v1.9.3\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token number\">28</span>     <span class=\"token comment\">#digest: sha256:8fd21d59428507671ce0fb47f818b1d859c92d2ad07bb7c947268d433030ba98</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token number\">42</span>   <span class=\"token comment\"># -- Will add custom configuration options to Nginx https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configurat    ion/configmap/</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token number\">43</span>   config:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token number\">44</span>     allow-snippet-annotations: <span class=\"token boolean\">true</span>          <span class=\"token comment\">#开启 server snippet 的配置</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token number\">67</span>   dnsPolicy: ClusterFirstWithHostNet</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> <span class=\"token number\">88</span>   hostNetwork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token number\">107</span>   ingressClassResource:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token number\">108</span>     <span class=\"token comment\"># -- Name of the ingressClass</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token number\">109</span>     name: nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token number\">110</span>     <span class=\"token comment\"># -- Is this ingressClass enabled or not</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token number\">111</span>     enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token number\">112</span>     <span class=\"token comment\"># -- Is this the default ingressClass for the cluster</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token number\">113</span>     default: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token number\">184</span>   kind: DaemonSet</pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token number\">287</span>   nodeSelector:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token number\">288</span>     kubernetes.io/os: linux</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token number\">289</span>     ingress: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token number\">638</span>       image:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token number\">639</span>         registry: registry.cn-hangzhou.aliyuncs.com</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token number\">640</span>         image: kubernetes_public/kube-webhook-certgen</pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token number\">641</span>         <span class=\"token comment\">## for backwards compatibility consider setting the full image url via the repository value below</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token number\">642</span>         <span class=\"token comment\">## use *either* current default registry/image or repository format or installing chart by providing the values.yaml     will fail</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token number\">643</span>         <span class=\"token comment\">## repository:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token number\">644</span>         tag: v20231011-8b53cabe0</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token number\">645</span>         <span class=\"token comment\">#digest: sha256:a7943503b45d552785aa3b5e457f169a5661fb94d82b8a3373bcd9ebaf9aac80</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>4. 给需要部署 ingress 的节点上打标签</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl label node k8s-node02 ingress=true</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl label node k8s-node01 ingress=true</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl create ns ingress-nginx</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># helm install ingress-nginx -n ingress-nginx .     #安装</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># helm upgrade ingress-nginx -n ingress-nginx .     #更新</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># kubectl get pods -n ingress-nginx </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ingress-nginx-controller-7nfqn   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          27s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ingress-nginx-controller-k4p2n   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ingress-nginx-controller-kw5jk   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24s</pre></td></tr></table></figure><h5 id=\"12-bare-metal安装ingress-nginx-controller\"><a class=\"anchor\" href=\"#12-bare-metal安装ingress-nginx-controller\">#</a> 1.2 Bare metal 安装 Ingress Nginx Controller</h5>\n<ol>\n<li>下载 Ingress 部署文件，链接地址：<a href=\"https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters\">https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters</a></li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.1/deploy/static/provider/baremetal/deploy.yaml</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>配置 Ingress</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Namespace</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>automountServiceAccountToken: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>automountServiceAccountToken: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  - namespaces</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  - configmaps</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  - secrets</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  - endpoints</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  - services</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  - ingresses</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  - ingresses/status</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  - update</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  - ingressclasses</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  - coordination.k8s.io</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  resourceNames:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  - ingress-nginx-leader</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  - leases</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  - update</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  - coordination.k8s.io</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  - leases</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  - create</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  - events</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  - create</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  - patch</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  - discovery.k8s.io</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  - endpointslices</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  - secrets</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  - create</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  - configmaps</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>  - endpoints</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>  - nodes</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>  - secrets</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>  - namespaces</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  - coordination.k8s.io</pre></td></tr><tr><td data-num=\"170\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"171\"></td><td><pre>  - leases</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>  - nodes</pre></td></tr><tr><td data-num=\"179\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"180\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"181\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"182\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"184\"></td><td><pre>  - services</pre></td></tr><tr><td data-num=\"185\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"186\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"187\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"188\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"190\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"191\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>  - ingresses</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"194\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"195\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"196\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"198\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"200\"></td><td><pre>  - events</pre></td></tr><tr><td data-num=\"201\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"202\"></td><td><pre>  - create</pre></td></tr><tr><td data-num=\"203\"></td><td><pre>  - patch</pre></td></tr><tr><td data-num=\"204\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"205\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"206\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"207\"></td><td><pre>  - ingresses/status</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>  - update</pre></td></tr><tr><td data-num=\"210\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"211\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"212\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"213\"></td><td><pre>  - ingressclasses</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"215\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"216\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"217\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"219\"></td><td><pre>  - discovery.k8s.io</pre></td></tr><tr><td data-num=\"220\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"221\"></td><td><pre>  - endpointslices</pre></td></tr><tr><td data-num=\"222\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"223\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"224\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"226\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"227\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"228\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"229\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"230\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"231\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"232\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"233\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"234\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"235\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"236\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"237\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"238\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"239\"></td><td><pre>  - admissionregistration.k8s.io</pre></td></tr><tr><td data-num=\"240\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"241\"></td><td><pre>  - validatingwebhookconfigurations</pre></td></tr><tr><td data-num=\"242\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"243\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"244\"></td><td><pre>  - update</pre></td></tr><tr><td data-num=\"245\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"246\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"247\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"248\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"249\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"250\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"251\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"252\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"253\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"254\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"255\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"256\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"257\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"258\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"259\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"260\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"261\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"262\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"263\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"264\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"265\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"266\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"267\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"268\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"269\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"270\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"271\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"272\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"273\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"274\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"275\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"276\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"277\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"278\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"279\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"280\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"281\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"282\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"283\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"284\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"285\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"286\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"287\"></td><td><pre>kind: ClusterRoleBinding</pre></td></tr><tr><td data-num=\"288\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"289\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"290\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"291\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"292\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"293\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"294\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"295\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"296\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"297\"></td><td><pre>  kind: ClusterRole</pre></td></tr><tr><td data-num=\"298\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"299\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"300\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"301\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"302\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"303\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"304\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"305\"></td><td><pre>kind: ClusterRoleBinding</pre></td></tr><tr><td data-num=\"306\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"307\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"308\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"309\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"310\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"311\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"312\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"313\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"314\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"315\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"316\"></td><td><pre>  kind: ClusterRole</pre></td></tr><tr><td data-num=\"317\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"318\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"319\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"320\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"321\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"322\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"323\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"324\"></td><td><pre>data: null</pre></td></tr><tr><td data-num=\"325\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"326\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"327\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"328\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"329\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"330\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"331\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"332\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"333\"></td><td><pre>  name: ingress-nginx-controller</pre></td></tr><tr><td data-num=\"334\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"335\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"336\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"337\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"338\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"339\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"340\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"341\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"342\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"343\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"344\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"345\"></td><td><pre>  name: ingress-nginx-controller</pre></td></tr><tr><td data-num=\"346\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"347\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"348\"></td><td><pre>  ipFamilies:</pre></td></tr><tr><td data-num=\"349\"></td><td><pre>  - IPv4</pre></td></tr><tr><td data-num=\"350\"></td><td><pre>  ipFamilyPolicy: SingleStack</pre></td></tr><tr><td data-num=\"351\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"352\"></td><td><pre>  - appProtocol: http</pre></td></tr><tr><td data-num=\"353\"></td><td><pre>    name: http</pre></td></tr><tr><td data-num=\"354\"></td><td><pre>    port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"356\"></td><td><pre>    targetPort: http</pre></td></tr><tr><td data-num=\"357\"></td><td><pre>  - appProtocol: https</pre></td></tr><tr><td data-num=\"358\"></td><td><pre>    name: https</pre></td></tr><tr><td data-num=\"359\"></td><td><pre>    port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"361\"></td><td><pre>    targetPort: https</pre></td></tr><tr><td data-num=\"362\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"363\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"364\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"365\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"366\"></td><td><pre>  <span class=\"token comment\">#type: NodePort</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"368\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"369\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"370\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"371\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"372\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"373\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"374\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"375\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"376\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"377\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"378\"></td><td><pre>  name: ingress-nginx-controller-admission</pre></td></tr><tr><td data-num=\"379\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"380\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"381\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"382\"></td><td><pre>  - appProtocol: https</pre></td></tr><tr><td data-num=\"383\"></td><td><pre>    name: https-webhook</pre></td></tr><tr><td data-num=\"384\"></td><td><pre>    port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>    targetPort: webhook</pre></td></tr><tr><td data-num=\"386\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"387\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"388\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"389\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"390\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"391\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"392\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"393\"></td><td><pre><span class=\"token comment\">#kind: Deployment</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>kind: DaemonSet</pre></td></tr><tr><td data-num=\"395\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"396\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"397\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"398\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"399\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"400\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"401\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"402\"></td><td><pre>  name: ingress-nginx-controller</pre></td></tr><tr><td data-num=\"403\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"404\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"405\"></td><td><pre>  minReadySeconds: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>  revisionHistoryLimit: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"408\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"409\"></td><td><pre>      app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"410\"></td><td><pre>      app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"411\"></td><td><pre>      app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"412\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"413\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"414\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"415\"></td><td><pre>        app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"416\"></td><td><pre>        app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"417\"></td><td><pre>        app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"418\"></td><td><pre>        app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"419\"></td><td><pre>        app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"420\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"421\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"422\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"423\"></td><td><pre>        - /nginx-ingress-controller</pre></td></tr><tr><td data-num=\"424\"></td><td><pre>        - --election-id<span class=\"token operator\">=</span>ingress-nginx-leader</pre></td></tr><tr><td data-num=\"425\"></td><td><pre>        - --controller-class<span class=\"token operator\">=</span>k8s.io/ingress-nginx</pre></td></tr><tr><td data-num=\"426\"></td><td><pre>        - --ingress-class<span class=\"token operator\">=</span>nginx</pre></td></tr><tr><td data-num=\"427\"></td><td><pre>        - <span class=\"token parameter variable\">--configmap</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span>/ingress-nginx-controller</pre></td></tr><tr><td data-num=\"428\"></td><td><pre>        - --validating-webhook<span class=\"token operator\">=</span>:8443</pre></td></tr><tr><td data-num=\"429\"></td><td><pre>        - --validating-webhook-certificate<span class=\"token operator\">=</span>/usr/local/certificates/cert</pre></td></tr><tr><td data-num=\"430\"></td><td><pre>        - --validating-webhook-key<span class=\"token operator\">=</span>/usr/local/certificates/key</pre></td></tr><tr><td data-num=\"431\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"432\"></td><td><pre>        - name: POD_NAME</pre></td></tr><tr><td data-num=\"433\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"434\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"435\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"436\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"437\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"438\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"439\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"440\"></td><td><pre>        - name: LD_PRELOAD</pre></td></tr><tr><td data-num=\"441\"></td><td><pre>          value: /usr/local/lib/libmimalloc.so</pre></td></tr><tr><td data-num=\"442\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/ingress-nginx-controller-v1.12.1:v1.12.1 </pre></td></tr><tr><td data-num=\"443\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"444\"></td><td><pre>        lifecycle:</pre></td></tr><tr><td data-num=\"445\"></td><td><pre>          preStop:</pre></td></tr><tr><td data-num=\"446\"></td><td><pre>            exec:</pre></td></tr><tr><td data-num=\"447\"></td><td><pre>              command:</pre></td></tr><tr><td data-num=\"448\"></td><td><pre>              - /wait-shutdown</pre></td></tr><tr><td data-num=\"449\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"450\"></td><td><pre>          failureThreshold: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>          httpGet:</pre></td></tr><tr><td data-num=\"452\"></td><td><pre>            path: /healthz</pre></td></tr><tr><td data-num=\"453\"></td><td><pre>            port: <span class=\"token number\">10254</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>            scheme: HTTP</pre></td></tr><tr><td data-num=\"455\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"456\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre>        name: controller</pre></td></tr><tr><td data-num=\"460\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"461\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>          name: http</pre></td></tr><tr><td data-num=\"463\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"464\"></td><td><pre>        - containerPort: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre>          name: https</pre></td></tr><tr><td data-num=\"466\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"467\"></td><td><pre>        - containerPort: <span class=\"token number\">8443</span></pre></td></tr><tr><td data-num=\"468\"></td><td><pre>          name: webhook</pre></td></tr><tr><td data-num=\"469\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"470\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"471\"></td><td><pre>          failureThreshold: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>          httpGet:</pre></td></tr><tr><td data-num=\"473\"></td><td><pre>            path: /healthz</pre></td></tr><tr><td data-num=\"474\"></td><td><pre>            port: <span class=\"token number\">10254</span></pre></td></tr><tr><td data-num=\"475\"></td><td><pre>            scheme: HTTP</pre></td></tr><tr><td data-num=\"476\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"477\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"478\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"480\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"481\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"482\"></td><td><pre>            cpu: 100m</pre></td></tr><tr><td data-num=\"483\"></td><td><pre>            memory: 90Mi</pre></td></tr><tr><td data-num=\"484\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"485\"></td><td><pre>          allowPrivilegeEscalation: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"486\"></td><td><pre>          capabilities:</pre></td></tr><tr><td data-num=\"487\"></td><td><pre>            add:</pre></td></tr><tr><td data-num=\"488\"></td><td><pre>            - NET_BIND_SERVICE</pre></td></tr><tr><td data-num=\"489\"></td><td><pre>            drop:</pre></td></tr><tr><td data-num=\"490\"></td><td><pre>            - ALL</pre></td></tr><tr><td data-num=\"491\"></td><td><pre>          readOnlyRootFilesystem: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"492\"></td><td><pre>          runAsGroup: <span class=\"token number\">82</span></pre></td></tr><tr><td data-num=\"493\"></td><td><pre>          runAsNonRoot: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"494\"></td><td><pre>          runAsUser: <span class=\"token number\">101</span></pre></td></tr><tr><td data-num=\"495\"></td><td><pre>          seccompProfile:</pre></td></tr><tr><td data-num=\"496\"></td><td><pre>            type: RuntimeDefault</pre></td></tr><tr><td data-num=\"497\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"498\"></td><td><pre>        - mountPath: /usr/local/certificates/</pre></td></tr><tr><td data-num=\"499\"></td><td><pre>          name: webhook-cert</pre></td></tr><tr><td data-num=\"500\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"501\"></td><td><pre>      hostNetwork: <span class=\"token boolean\">true</span>                         <span class=\"token comment\"># 与节点共享网络名称空间</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>      <span class=\"token comment\">#dnsPolicy: ClusterFirst</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>      dnsPolicy: ClusterFirstWithHostNet        <span class=\"token comment\"># dns 策略</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre>      nodeSelector:                             <span class=\"token comment\"># 节点选择器</span></pre></td></tr><tr><td data-num=\"505\"></td><td><pre>        kubernetes.io/os: linux</pre></td></tr><tr><td data-num=\"506\"></td><td><pre>        ingress: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"507\"></td><td><pre>      serviceAccountName: ingress-nginx</pre></td></tr><tr><td data-num=\"508\"></td><td><pre>      terminationGracePeriodSeconds: <span class=\"token number\">300</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"510\"></td><td><pre>      - name: webhook-cert</pre></td></tr><tr><td data-num=\"511\"></td><td><pre>        secret:</pre></td></tr><tr><td data-num=\"512\"></td><td><pre>          secretName: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"513\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"514\"></td><td><pre>apiVersion: batch/v1</pre></td></tr><tr><td data-num=\"515\"></td><td><pre>kind: Job</pre></td></tr><tr><td data-num=\"516\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"517\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"518\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"519\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"520\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"521\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"522\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"523\"></td><td><pre>  name: ingress-nginx-admission-create</pre></td></tr><tr><td data-num=\"524\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"525\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"526\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"527\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"528\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"529\"></td><td><pre>        app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"530\"></td><td><pre>        app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"531\"></td><td><pre>        app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"532\"></td><td><pre>        app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"533\"></td><td><pre>        app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"534\"></td><td><pre>      name: ingress-nginx-admission-create</pre></td></tr><tr><td data-num=\"535\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"536\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"537\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"538\"></td><td><pre>        - create</pre></td></tr><tr><td data-num=\"539\"></td><td><pre>        - <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span>ingress-nginx-controller-admission,ingress-nginx-controller-admission.<span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span>.svc</pre></td></tr><tr><td data-num=\"540\"></td><td><pre>        - <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"541\"></td><td><pre>        - --secret-name<span class=\"token operator\">=</span>ingress-nginx-admission</pre></td></tr><tr><td data-num=\"542\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"543\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"544\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"545\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"546\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"547\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kube-webhook-certgen-v1.5.2:v1.5.2 </pre></td></tr><tr><td data-num=\"548\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"549\"></td><td><pre>        name: create</pre></td></tr><tr><td data-num=\"550\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"551\"></td><td><pre>          allowPrivilegeEscalation: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"552\"></td><td><pre>          capabilities:</pre></td></tr><tr><td data-num=\"553\"></td><td><pre>            drop:</pre></td></tr><tr><td data-num=\"554\"></td><td><pre>            - ALL</pre></td></tr><tr><td data-num=\"555\"></td><td><pre>          readOnlyRootFilesystem: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"556\"></td><td><pre>          runAsGroup: <span class=\"token number\">65532</span></pre></td></tr><tr><td data-num=\"557\"></td><td><pre>          runAsNonRoot: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"558\"></td><td><pre>          runAsUser: <span class=\"token number\">65532</span></pre></td></tr><tr><td data-num=\"559\"></td><td><pre>          seccompProfile:</pre></td></tr><tr><td data-num=\"560\"></td><td><pre>            type: RuntimeDefault</pre></td></tr><tr><td data-num=\"561\"></td><td><pre>      nodeSelector:</pre></td></tr><tr><td data-num=\"562\"></td><td><pre>        kubernetes.io/os: linux</pre></td></tr><tr><td data-num=\"563\"></td><td><pre>      restartPolicy: OnFailure</pre></td></tr><tr><td data-num=\"564\"></td><td><pre>      serviceAccountName: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"565\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"566\"></td><td><pre>apiVersion: batch/v1</pre></td></tr><tr><td data-num=\"567\"></td><td><pre>kind: Job</pre></td></tr><tr><td data-num=\"568\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"569\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"570\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"571\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"572\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"573\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"574\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"575\"></td><td><pre>  name: ingress-nginx-admission-patch</pre></td></tr><tr><td data-num=\"576\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"577\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"578\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"579\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"580\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"581\"></td><td><pre>        app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"582\"></td><td><pre>        app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"583\"></td><td><pre>        app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"584\"></td><td><pre>        app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"585\"></td><td><pre>        app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"586\"></td><td><pre>      name: ingress-nginx-admission-patch</pre></td></tr><tr><td data-num=\"587\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"588\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"589\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"590\"></td><td><pre>        - patch</pre></td></tr><tr><td data-num=\"591\"></td><td><pre>        - --webhook-name<span class=\"token operator\">=</span>ingress-nginx-admission</pre></td></tr><tr><td data-num=\"592\"></td><td><pre>        - <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"593\"></td><td><pre>        - --patch-mutating<span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"594\"></td><td><pre>        - --secret-name<span class=\"token operator\">=</span>ingress-nginx-admission</pre></td></tr><tr><td data-num=\"595\"></td><td><pre>        - --patch-failure-policy<span class=\"token operator\">=</span>Fail</pre></td></tr><tr><td data-num=\"596\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"597\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"598\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"599\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"600\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"601\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kube-webhook-certgen-v1.5.2:v1.5.2 </pre></td></tr><tr><td data-num=\"602\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"603\"></td><td><pre>        name: patch</pre></td></tr><tr><td data-num=\"604\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"605\"></td><td><pre>          allowPrivilegeEscalation: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"606\"></td><td><pre>          capabilities:</pre></td></tr><tr><td data-num=\"607\"></td><td><pre>            drop:</pre></td></tr><tr><td data-num=\"608\"></td><td><pre>            - ALL</pre></td></tr><tr><td data-num=\"609\"></td><td><pre>          readOnlyRootFilesystem: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"610\"></td><td><pre>          runAsGroup: <span class=\"token number\">65532</span></pre></td></tr><tr><td data-num=\"611\"></td><td><pre>          runAsNonRoot: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"612\"></td><td><pre>          runAsUser: <span class=\"token number\">65532</span></pre></td></tr><tr><td data-num=\"613\"></td><td><pre>          seccompProfile:</pre></td></tr><tr><td data-num=\"614\"></td><td><pre>            type: RuntimeDefault</pre></td></tr><tr><td data-num=\"615\"></td><td><pre>      nodeSelector:</pre></td></tr><tr><td data-num=\"616\"></td><td><pre>        kubernetes.io/os: linux</pre></td></tr><tr><td data-num=\"617\"></td><td><pre>      restartPolicy: OnFailure</pre></td></tr><tr><td data-num=\"618\"></td><td><pre>      serviceAccountName: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"619\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"620\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"621\"></td><td><pre>kind: IngressClass</pre></td></tr><tr><td data-num=\"622\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"623\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"624\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"625\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"626\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"627\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"628\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"629\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"630\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"631\"></td><td><pre>  controller: k8s.io/ingress-nginx</pre></td></tr><tr><td data-num=\"632\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"633\"></td><td><pre>apiVersion: admissionregistration.k8s.io/v1</pre></td></tr><tr><td data-num=\"634\"></td><td><pre>kind: ValidatingWebhookConfiguration</pre></td></tr><tr><td data-num=\"635\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"636\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"637\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"638\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"639\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"640\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"641\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"642\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"643\"></td><td><pre>webhooks:</pre></td></tr><tr><td data-num=\"644\"></td><td><pre>- admissionReviewVersions:</pre></td></tr><tr><td data-num=\"645\"></td><td><pre>  - v1</pre></td></tr><tr><td data-num=\"646\"></td><td><pre>  clientConfig:</pre></td></tr><tr><td data-num=\"647\"></td><td><pre>    service:</pre></td></tr><tr><td data-num=\"648\"></td><td><pre>      name: ingress-nginx-controller-admission</pre></td></tr><tr><td data-num=\"649\"></td><td><pre>      namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"650\"></td><td><pre>      path: /networking/v1/ingresses</pre></td></tr><tr><td data-num=\"651\"></td><td><pre>      port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"652\"></td><td><pre>  failurePolicy: Fail</pre></td></tr><tr><td data-num=\"653\"></td><td><pre>  matchPolicy: Equivalent</pre></td></tr><tr><td data-num=\"654\"></td><td><pre>  name: validate.nginx.ingress.kubernetes.io</pre></td></tr><tr><td data-num=\"655\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"656\"></td><td><pre>  - apiGroups:</pre></td></tr><tr><td data-num=\"657\"></td><td><pre>    - networking.k8s.io</pre></td></tr><tr><td data-num=\"658\"></td><td><pre>    apiVersions:</pre></td></tr><tr><td data-num=\"659\"></td><td><pre>    - v1</pre></td></tr><tr><td data-num=\"660\"></td><td><pre>    operations:</pre></td></tr><tr><td data-num=\"661\"></td><td><pre>    - CREATE</pre></td></tr><tr><td data-num=\"662\"></td><td><pre>    - UPDATE</pre></td></tr><tr><td data-num=\"663\"></td><td><pre>    resources:</pre></td></tr><tr><td data-num=\"664\"></td><td><pre>    - ingresses</pre></td></tr><tr><td data-num=\"665\"></td><td><pre>  sideEffects: None</pre></td></tr></table></figure><ul>\n<li>type: ClusterIP                                              #service 类型改为 ClusterIP</li>\n<li>hostNetwork: true                                      # 与节点共享网络名称空间</li>\n<li>dnsPolicy: ClusterFirstWithHostNet        # dns 策略</li>\n<li>nodeSelector:                                             # 节点选择器</li>\n<li>kind: DaemonSet                                        # 资源类型 DaemonSet</li>\n</ul>\n<ol start=\"3\">\n<li>在指定节点部署 Ingress-Controller</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f deploy.yaml -n ingress-nginx</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label node k8s-node01 ingress=true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label node k8s-node02 ingress=true</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label node k8s-master03 ingress-     #取消节点部署</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n ingress-nginx </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NAME                                   READY   STATUS      RESTARTS   AGE</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ingress-nginx-admission-create-zp6mh   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          12m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ingress-nginx-admission-patch-f2bpd    <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          12m</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ingress-nginx-controller-rgtkc         <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>          3m59s</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ingress-nginx-controller-trmn8         <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>          3m59s</pre></td></tr></table></figure><h4 id=\"2-ingress-nginx-入门使用\"><a class=\"anchor\" href=\"#2-ingress-nginx-入门使用\">#</a> 2. Ingress Nginx 入门使用</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat web-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: web-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  - host: test.hmallleasing.com</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h4 id=\"3-ingress-nginx-域名重定向-redirect\"><a class=\"anchor\" href=\"#3-ingress-nginx-域名重定向-redirect\">#</a> 3. Ingress Nginx 域名重定向 Redirect</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat redirect-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: redirect-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    nginx.ingress.kubernetes.io/permanent-redirect: https://www.baidu.com</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - host: redirect.hmallleasing.com</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h4 id=\"4-ingress-nginx-前后端分离-rewrite\"><a class=\"anchor\" href=\"#4-ingress-nginx-前后端分离-rewrite\">#</a> 4. Ingress Nginx 前后端分离 Rewrite</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat rewrite-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rewrite-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    nginx.ingress.kubernetes.io/rewrite-target: /<span class=\"token variable\">$2</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - host: rewrite.hmallleasing.com</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        path: /api<span class=\"token punctuation\">(</span>/<span class=\"token operator\">|</span>$<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        pathType: ImplementationSpecif</pre></td></tr></table></figure><h4 id=\"5-ingress-nginx-错误代码重定向\"><a class=\"anchor\" href=\"#5-ingress-nginx-错误代码重定向\">#</a> 5. Ingress Nginx 错误代码重定向</h4>\n<pre><code>\n</code></pre>\n<h4 id=\"6-ingress-nginx-ssl\"><a class=\"anchor\" href=\"#6-ingress-nginx-ssl\">#</a> 6. Ingress Nginx SSL</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.生成证书</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.cert -subj \"/CN=s.hmallleasing.com/O=tls.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span>.创建证书</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># kubectl create secret tls tls.hmallleasig.com --key tls.key --cert tls.cert</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">3</span>.ingress配置</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># kubectl create secret tls tls.hmallleasig.com --cert=tls.crt --key=tls.key</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># cat tls-ingress.yaml </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  name: tls-ingress</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-redirect: <span class=\"token string\">\"false\"</span>    <span class=\"token comment\">#禁用 https 强制跳转</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - host: tls.hmallleasing.com</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  tls:                  <span class=\"token comment\">#https</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  - hosts:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    - tls.hmallleasing.com</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    secretName: <span class=\"token string\">\"tls.hmallleasig.com\"</span></pre></td></tr></table></figure><h4 id=\"7-ingress-nginx-匹配请求头\"><a class=\"anchor\" href=\"#7-ingress-nginx-匹配请求头\">#</a> 7. Ingress Nginx 匹配请求头</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.部署移动端应用</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl create deploy phone --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:phone</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl expose deploy phone --port 80</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># vim m-ingress.yaml</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: m-ingress</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - host: m.hmallleasing.com</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: phone</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token number\">2</span>.部署PC端应用\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># kubectl create deploy laptop --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:laptop\t</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\"># kubectl expose deploy laptop --port 80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># vim laptop-ingress.yaml</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    kubernetes.io/ingress.class: nginx</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    nginx.ingress.kubernetes.io/server-snippet: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$agentflag</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"(Android|iPhone|Windows Phone|UC|Kindle)\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$agentflag</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$agentflag</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              <span class=\"token builtin class-name\">return</span> <span class=\"token number\">301</span> http://m.hmallleaing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  name: laptop-ingress</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  - host: hmallleasing.com</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            name: laptop</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h4 id=\"8ingress-nginx-基本认证\"><a class=\"anchor\" href=\"#8ingress-nginx-基本认证\">#</a> 8.Ingress Nginx 基本认证</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install httpd -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># htpasswd -c auth superman</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># cat auth </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>superman:<span class=\"token variable\">$apr1</span><span class=\"token variable\">$AC1pc3dK</span><span class=\"token variable\">$RJyWnyDJFNKY6twneGVrA1</span>\t\t</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># kubectl create secret generic basic-auth --from-file=auth</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># cat basic-ingress.yaml </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  name: basic-ingress</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    nginx.ingress.kubernetes.io/auth-type: basic  <span class=\"token comment\"># 认证类型</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    nginx.ingress.kubernetes.io/auth-secret: basic-auth  <span class=\"token comment\"># 包含用户和密码的 secret 资源名称</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    nginx.ingress.kubernetes.io/auth-realm: <span class=\"token string\">'Please User password'</span>  <span class=\"token comment\"># 要显示的信息</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - host: basic.hmallleasing.com</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h4 id=\"9-ingress-nginx-黑白名单\"><a class=\"anchor\" href=\"#9-ingress-nginx-黑白名单\">#</a> 9. Ingress Nginx 黑 / 白名单</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>写法一：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># cat white-ingress.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: white-ingress</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    nginx.ingress.kubernetes.io/whitelist-source-range: <span class=\"token string\">\"192.168.40.101\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - host: white.hmallleasing.com</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        pathType: ImplementationSpecific\t</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>写法二：\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat white-ingress.yaml </span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: white-ingress</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    nginx.ingress.kubernetes.io/whitelist-source-range: <span class=\"token string\">\"192.168.40.0/24\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  - host: white.hmallleasing.com</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>写法三：</pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\"># cat white-ingress.yaml </span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  name: white-ingress</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    nginx.ingress.kubernetes.io/server-snippet: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      allow <span class=\"token number\">192.168</span>.40.0/24<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      deny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  - host: white.hmallleasing.com</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token comment\">#Master01 测试\t\t</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token comment\"># curl -H \"Host:white.hmallleasing.com\" http://192.168.40.103 -I</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>HTTP/1.1 <span class=\"token number\">200</span> OK</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>Date: Sat, <span class=\"token number\">14</span> Oct <span class=\"token number\">2023</span> <span class=\"token number\">13</span>:12:03 GMT</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>Content-Length: <span class=\"token number\">612</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>Last-Modified: Tue, <span class=\"token number\">16</span> Apr <span class=\"token number\">2019</span> <span class=\"token number\">13</span>:08:19 GMT</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>ETag: <span class=\"token string\">\"5cb5d3c3-264\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>Accept-Ranges: bytes\t\t</pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token comment\">#Master02 测试</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token comment\"># curl -H \"Host:white.hmallleasing.com\" http://192.168.40.103 -I</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>HTTP/1.1 <span class=\"token number\">403</span> Forbidden</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>Date: Sat, <span class=\"token number\">14</span> Oct <span class=\"token number\">2023</span> <span class=\"token number\">13</span>:13:34 GMT</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>Content-Length: <span class=\"token number\">146</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>Connection: keep-alive</pre></td></tr></table></figure><h4 id=\"10-ingress-nginx-速率限制\"><a class=\"anchor\" href=\"#10-ingress-nginx-速率限制\">#</a> 10. Ingress Nginx 速率限制</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat limit-rate-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rate-limit-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    nginx.ingress.kubernetes.io/limit-rps: <span class=\"token string\">\"50\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - host: rate-limit.hmallleasing.com</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># ab -c 20 -n 1000 http://rate-limit.hmallleasing.com/ |grep request</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Complete requests:      <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Failed requests:        <span class=\"token number\">724</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Time per request:       <span class=\"token number\">10.301</span> <span class=\"token punctuation\">[</span>ms<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>mean<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Time per request:       <span class=\"token number\">0.515</span> <span class=\"token punctuation\">[</span>ms<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>mean, across all concurrent requests<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Percentage of the requests served within a certain <span class=\"token function\">time</span> <span class=\"token punctuation\">(</span>ms<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"11使用-nginx-实现灰度金丝雀发布\"><a class=\"anchor\" href=\"#11使用-nginx-实现灰度金丝雀发布\">#</a> 11. 使用 Nginx 实现灰度 / 金丝雀发布</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.创建 v1 版本</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl create deploy canary-v1 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v1\t</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl expose deploy canary-v1 --port 8080</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># cat canary-v1-ingress.yaml </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: canary-v1-ingress</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - host: canary.hmallleasing.com</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: canary-v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># curl -H \"Host:canary.hmallleasing.com\" http://192.168.40.103 \t</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token number\">2</span>.创建 v2 版本</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># kubectl create deploy canary-v2 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v2</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># kubectl expose deploy canary-v2 --port 8080</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># cat canary-v2-ingress.yaml </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  name: canary-v2-ingress</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    nginx.ingress.kubernetes.io/canary: <span class=\"token string\">\"true\"</span>    <span class=\"token comment\">#启动灰度发布</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    nginx.ingress.kubernetes.io/canary-weight: <span class=\"token string\">\"20\"</span>  <span class=\"token comment\">#基于权重，50% 流量调度到这个灰度的版本上</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  - host: canary.hmallleasing.com</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            name: canary-v2</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">#测试灰度发布</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat canary.sh </span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Host:canary.hmallleasing.com\"</span> http://192.168.40.103</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token function\">sleep</span> <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr></table></figure><h4 id=\"12-kubernetes-dashboard配置证书\"><a class=\"anchor\" href=\"#12-kubernetes-dashboard配置证书\">#</a> 12. kubernetes-dashboard 配置证书</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.创建证书</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl create secret tls kubernetes-dashboard-certs <span class=\"token parameter variable\">--key</span> *.hmallleasing.com_key.key <span class=\"token parameter variable\">--cert</span> *.hmallleasing.com_chain.crt <span class=\"token parameter variable\">-n</span> kubernetes-dashboard</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span>.修改kubernetes-dashboard资源清单</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kubectl edit deployment <span class=\"token parameter variable\">-n</span> kubernetes-dashboard kubernetes-dashboard</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        - --auto-generate-certificates<span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        - --tls-key-file<span class=\"token operator\">=</span>_.hmallleasing.com_key.key</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        - --tls-cert-file<span class=\"token operator\">=</span>_.hmallleasing.com_chain.crt</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        - --token-ttl<span class=\"token operator\">=</span><span class=\"token number\">21600</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        - --authentication-mode<span class=\"token operator\">=</span>basic,token</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        - <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>kubernetes-dashboard</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">3</span>.创建ingress</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#cat dashboard-ingress.yaml </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: dashboard-ingress</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  namespace: kubernetes-dashboard</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-passthrough: <span class=\"token string\">\"true\"</span>    </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    nginx.ingress.kubernetes.io/backend-protocol: <span class=\"token string\">\"HTTPS\"</span>    </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  - host: dashboard.hmallleasing.com</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            name: kubernetes-dashboard</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              number: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\"># kubectl apply -f dashboard-ingress.yaml</span></pre></td></tr></table></figure><h4 id=\"13-入口lb配置\"><a class=\"anchor\" href=\"#13-入口lb配置\">#</a> 13. 入口 LB 配置</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/ingress.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream ingress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.103:80 <span class=\"token assign-left variable\">max_conns</span><span class=\"token operator\">=</span><span class=\"token number\">2000</span> <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>5s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.104:80 <span class=\"token assign-left variable\">max_conns</span><span class=\"token operator\">=</span><span class=\"token number\">2000</span> <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>5s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.105:80 <span class=\"token assign-left variable\">max_conns</span><span class=\"token operator\">=</span><span class=\"token number\">2000</span> <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>5s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    server_name test.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    client_max_body_size 1G<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ssl_certificate  /etc/nginx/sslkey/*.hmallleasing.com_chain.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    ssl_certificate_key  /etc/nginx/sslkey/*.hmallleasing.com_key.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        proxy_pass http://ingress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        include proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t    proxy_next_upstream error <span class=\"token function\">timeout</span> http_500 http_502 http_503 http_504<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t    proxy_next_upstream_tries <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t    proxy_next_upstream_timeout 3s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    server_name test.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/sslkey -p</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_params </span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>proxy_send_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3030097036.html",
            "url": "http://ixuyong.cn/posts/3030097036.html",
            "title": "K8S云原生存储Rook-Ceph",
            "date_published": "2025-04-24T13:43:19.000Z",
            "content_html": "<h3 id=\"k8s云原生存储rook-ceph\"><a class=\"anchor\" href=\"#k8s云原生存储rook-ceph\">#</a> K8S 云原生存储 Rook-Ceph</h3>\n<h4 id=\"1-storageclass动态存储\"><a class=\"anchor\" href=\"#1-storageclass动态存储\">#</a> 1. StorageClass 动态存储</h4>\n<p>StorageClass：存储类，由 K8s 管理员创建，用于动态 PV 的管理，可以链接至不同的后端存储，比如 Ceph、GlusterFS 等。之后对存储的请求可以指向 StorageClass，然后 StorageClass 会自动的创建、删除 PV。</p>\n<p>实现方式：</p>\n<ul>\n<li>in-tree: 内置于 K8s 核心代码，对于存储的管理，都需要编写相应的代码。</li>\n<li>out-of-tree：由存储厂商提供一个驱动（CSI 或 Flex Volume），安装到 K8s 集群，然后 StorageClass 只需要配置该驱动即可，驱动器会代替 StorageClass 管理存储。</li>\n</ul>\n<p>StorageClass 官网介绍：<a href=\"https://kubernetes.io/docs/concepts/storage/storage-classes/\">https://kubernetes.io/docs/concepts/storage/storage-classes/</a></p>\n<h4 id=\"2-云原生存储rook\"><a class=\"anchor\" href=\"#2-云原生存储rook\">#</a> 2. 云原生存储 Rook</h4>\n<p>Rook 是一个自我管理的分布式存储编排系统，它本身并不是存储系统，在存储和 k8s 之前搭建了一个桥梁，使存储系统的搭建或者维护变得特别简单，Rook 将分布式存储系统转变为自我管理、自我扩展、自我修复的存储服务。它让一些存储的操作，比如部署、配置、扩容、升级、迁移、灾难恢复、监视和资源管理变得自动化，无需人工处理。并且 Rook 支持 CSI，可以利用 CSI 做一些 PVC 的快照、扩容、克隆等操作。</p>\n<p>Rook 官网介绍：<a href=\"https://rook.io/\">https://rook.io/</a></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/CK4Gn1u.jpeg\" alt=\"Snipaste_2025-05-07_20-15-59.jpg\" /></p>\n<h4 id=\"3-rook-安装\"><a class=\"anchor\" href=\"#3-rook-安装\">#</a> 3. Rook 安装</h4>\n<p>环境准备</p>\n<ul>\n<li>K8s 集群至少五个节点，每个节点的内存不低于 5G，CPU 不低于 2 核</li>\n<li>所有节点时间同步</li>\n<li>至少有三个存储节点，并且每个节点至少有一个裸盘，k8s-master03、k8s-node01、k8s-node02 增加裸盘</li>\n</ul>\n<h5 id=\"31-下载-rook-安装文件\"><a class=\"anchor\" href=\"#31-下载-rook-安装文件\">#</a> 3.1 下载 Rook 安装文件</h5>\n<pre><code>[root@k8s-master01 ~]# git clone --single-branch --branch v1.17.2 https://github.com/rook/rook.git\n</code></pre>\n<h5 id=\"32-配置更改\"><a class=\"anchor\" href=\"#32-配置更改\">#</a> 3.2 配置更改</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd rook/deploy/examples</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim operator.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ROOK_CSI_CEPH_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/cephcsi:v3.14.0\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  ROOK_CSI_REGISTRAR_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-node-driver-registrar:v2.13.0\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  ROOK_CSI_RESIZER_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-resizer:v1.13.1\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  ROOK_CSI_PROVISIONER_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-provisioner:v5.1.0\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ROOK_CSI_SNAPSHOTTER_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-snapshotter:v8.2.0\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ROOK_CSI_ATTACHER_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-attacher:v4.8.0\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#ROOK_ENABLE_DISCOVERY_DAEMON 改成 true 即可</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ROOK_ENABLE_DISCOVERY_DAEMON: <span class=\"token string\">\"true\"</span></pre></td></tr></table></figure><h5 id=\"33-部署-rook\"><a class=\"anchor\" href=\"#33-部署-rook\">#</a> 3.3 部署 rook</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ceph<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f crds.yaml -f common.yaml -f operator.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n rook-ceph</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rook-ceph-operator-84ff77778b-7ww2w   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          91m</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-discover-6j68f                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          82m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rook-discover-9w4kt                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          82m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rook-discover-h2zfm                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          82m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>rook-discover-hsz8b                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          19m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>rook-discover-rj4t7                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          82m</pre></td></tr></table></figure><h4 id=\"4创建-ceph-集群\"><a class=\"anchor\" href=\"#4创建-ceph-集群\">#</a> 4. 创建 Ceph 集群</h4>\n<h5 id=\"41-配置更改\"><a class=\"anchor\" href=\"#41-配置更改\">#</a> 4.1 配置更改</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim cluster.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/cephv19.2.2:v19.2.2</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  skipUpgradeChecks: <span class=\"token boolean\">true</span>     <span class=\"token comment\">#改为 true，跳过升级</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  dashboard:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\"># serve the dashboard under a subpath (useful when you are accessing the dashboard via a reverse proxy)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\"># urlPrefix: /ceph-dashboard</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\"># serve the dashboard at the given port.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\"># port: 8443</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\"># serve the dashboard using SSL</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    ssl: <span class=\"token boolean\">false</span>          <span class=\"token comment\">#改为 false</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  storage: <span class=\"token comment\"># cluster level storage configuration and selection</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    useAllNodes: <span class=\"token boolean\">false</span>      <span class=\"token comment\">#改为 false, 不使用所有的节点当 osd</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    useAllDevices: <span class=\"token boolean\">false</span>    <span class=\"token comment\">#改为 false, 不使用所有的磁盘当 osd</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">#     deviceFilter: \"^sd.\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    nodes:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    - name: <span class=\"token string\">\"k8s-master03\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      devices:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      - name: <span class=\"token string\">\"sdb\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    - name: <span class=\"token string\">\"k8s-node01\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      devices:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      - name: <span class=\"token string\">\"sdb\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    - name: <span class=\"token string\">\"k8s-node02\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      devices:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - name: <span class=\"token string\">\"sdb\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>注意：新版必须采用裸盘，即未格式化的磁盘。其中 k8s-master03、 k8s-node01、  k8s-node02 有新加的一个磁盘，可以通过 lsblk -f 查看新添加的磁盘名称。建议最少三个节点，否则后面的试验可能会出现问题</p>\n<h5 id=\"42-创建-ceph-集群\"><a class=\"anchor\" href=\"#42-创建-ceph-集群\">#</a> 4.2 创建 Ceph 集群</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f cluster.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n rook-ceph</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                                                     READY   STATUS      RESTARTS        AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>csi-cephfsplugin-5nmnl                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>csi-cephfsplugin-6b6ct                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>csi-cephfsplugin-8xlnl                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>csi-cephfsplugin-fh9w5                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>csi-cephfsplugin-mslst                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>csi-cephfsplugin-provisioner-59bd447c6d-5zwj2            <span class=\"token number\">6</span>/6     Running     <span class=\"token number\">0</span>               61s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>csi-cephfsplugin-provisioner-59bd447c6d-7t2kg            <span class=\"token number\">6</span>/6     Running     <span class=\"token number\">2</span> <span class=\"token punctuation\">(</span>20s ago<span class=\"token punctuation\">)</span>     61s</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>csi-rbdplugin-5gvmp                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>csi-rbdplugin-dzcs4                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>csi-rbdplugin-n82b5                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>csi-rbdplugin-provisioner-6856fb8b86-86hw8               <span class=\"token number\">6</span>/6     Running     <span class=\"token number\">0</span>               19s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>csi-rbdplugin-provisioner-6856fb8b86-lj9s4               <span class=\"token number\">6</span>/6     Running     <span class=\"token number\">0</span>               19s</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>csi-rbdplugin-vh8j2                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>csi-rbdplugin-xfgwr                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>rook-ceph-crashcollector-k8s-master01-bbc78d496-bzjk8    <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               8m26s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>rook-ceph-crashcollector-k8s-master03-765ff964bb-95wmt   <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               28m</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>rook-ceph-crashcollector-k8s-node01-7cf4c4b6b6-r4n84     <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               20m</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rook-ceph-crashcollector-k8s-node02-f887f8cf9-jz2l8      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               28m</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>rook-ceph-detect-version-nsrwj                           <span class=\"token number\">0</span>/1     Init:0/1    <span class=\"token number\">0</span>               3s</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>rook-ceph-exporter-k8s-master01-5cd4577b79-ckd4m         <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               8m26s</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>rook-ceph-exporter-k8s-master03-75f4cf6f7-hc9zb          <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               28m</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rook-ceph-exporter-k8s-node01-96fc7cf49-d2r24            <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               20m</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>rook-ceph-exporter-k8s-node02-777b9f555b-7j6cz           <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               27m</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>rook-ceph-mgr-a-6f46b4b945-q6cjb                         <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">3</span> <span class=\"token punctuation\">(</span>14m ago<span class=\"token punctuation\">)</span>     35m</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>rook-ceph-mgr-b-5d4cc5465b-8dfh6                         <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">0</span>               35m</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>rook-ceph-mon-a-7c7b7555c7-nlhwg                         <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">2</span> <span class=\"token punctuation\">(</span>6m14s ago<span class=\"token punctuation\">)</span>   51m</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>rook-ceph-mon-c-559bcf95fd-cl62w                         <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               8m27s</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>rook-ceph-mon-d-7dbc6b8f5c-8264t                         <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               28m</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>rook-ceph-operator-645478ff5b-jdcrp                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               102m</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>rook-ceph-osd-0-6d9cf78f76-4zhx8                         <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               12m</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>rook-ceph-osd-1-88c78bbcb-cn48c                          <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               5m15s</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>rook-ceph-osd-2-b464c9fc6-458hv                          <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               4m29s</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>rook-ceph-osd-prepare-k8s-master03-pwnrc                 <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>               86s</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>rook-ceph-osd-prepare-k8s-node01-xxp2j                   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>               83s</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>rook-ceph-osd-prepare-k8s-node02-8nz7x                   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>               78s</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>rook-discover-jzmkr                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>rook-discover-k7pxt                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>rook-discover-vqjh5                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>rook-discover-wk8jq                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>rook-discover-x8rsn                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get cephcluster -n rook-ceph</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>NAME        DATADIRHOSTPATH   MONCOUNT   AGE   PHASE   MESSAGE                        HEALTH        EXTERNAL   FSID</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>rook-ceph   /var/lib/rook     <span class=\"token number\">3</span>          63m   Ready   Cluster created successfully   HEALTH_WARN              ca429602-66f4-4a1e-9d5c-a5773a0f594f</pre></td></tr></table></figure><h5 id=\"43-安装-ceph-snapshot-控制器\"><a class=\"anchor\" href=\"#43-安装-ceph-snapshot-控制器\">#</a> 4.3 安装 ceph snapshot 控制器</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/k8s-ha-install/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># git checkout manual-installation-v1.32.x</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f snapshotter/ -n kube-system</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get po -n kube-system -l app=snapshot-controller</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>NAME                    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>snapshot-controller-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          67s</pre></td></tr></table></figure><h4 id=\"5-安装-ceph-客户端工具\"><a class=\"anchor\" href=\"#5-安装-ceph-客户端工具\">#</a> 5. 安装 ceph 客户端工具</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/rook/deploy/examples/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f toolbox.yaml -n rook-ceph</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get po -n rook-ceph -l app=rook-ceph-tools</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                               READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-ceph-tools-7b75b967db-sqddk   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it rook-ceph-tools-7b75b967db-sqddk -n rook-ceph -- bash</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>bash-5.1$ ceph status</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  cluster:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    id:     87b85368-9487-4967-a4e4-5970d2e0ec94</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    health: HEALTH_WARN</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token number\">1</span> mgr modules have recently crashed</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  services:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    mon: <span class=\"token number\">3</span> daemons, quorum b,c <span class=\"token punctuation\">(</span>age 12s<span class=\"token punctuation\">)</span>, out of quorum: a</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    mgr: a<span class=\"token punctuation\">(</span>active, since 7m<span class=\"token punctuation\">)</span>, standbys: b</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    osd: <span class=\"token number\">3</span> osds: <span class=\"token number\">3</span> up <span class=\"token punctuation\">(</span>since 8m<span class=\"token punctuation\">)</span>, <span class=\"token number\">3</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">(</span>since 3h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  data:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    pools:   <span class=\"token number\">0</span> pools, <span class=\"token number\">0</span> pgs</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    objects: <span class=\"token number\">0</span> objects, <span class=\"token number\">0</span> B</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    usage:   <span class=\"token number\">82</span> MiB used, <span class=\"token number\">60</span> GiB / <span class=\"token number\">60</span> GiB avail</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    pgs: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>bash-4.4$  ceph osd status</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>ID  HOST           USED  AVAIL  WR OPS  WR DATA  RD OPS  RD DATA  STATE      </pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token number\">0</span>  k8s-master03  <span class=\"token number\">20</span>.6M  <span class=\"token number\">19</span>.9G      <span class=\"token number\">0</span>        <span class=\"token number\">0</span>       <span class=\"token number\">0</span>        <span class=\"token number\">0</span>   exists,up  </pre></td></tr><tr><td data-num=\"27\"></td><td><pre> <span class=\"token number\">1</span>  k8s-node01    <span class=\"token number\">20</span>.6M  <span class=\"token number\">19</span>.9G      <span class=\"token number\">0</span>        <span class=\"token number\">0</span>       <span class=\"token number\">0</span>        <span class=\"token number\">0</span>   exists,up  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token number\">2</span>  k8s-node02    <span class=\"token number\">20</span>.6M  <span class=\"token number\">19</span>.9G      <span class=\"token number\">0</span>        <span class=\"token number\">0</span>       <span class=\"token number\">0</span>        <span class=\"token number\">0</span>   exists,up </pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>bash-4.4$ ceph <span class=\"token function\">df</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>--- RAW STORAGE ---</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>CLASS    SIZE   AVAIL    USED  RAW USED  %RAW USED</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>hdd    <span class=\"token number\">60</span> GiB  <span class=\"token number\">60</span> GiB  <span class=\"token number\">62</span> MiB    <span class=\"token number\">62</span> MiB       <span class=\"token number\">0.10</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>TOTAL  <span class=\"token number\">60</span> GiB  <span class=\"token number\">60</span> GiB  <span class=\"token number\">62</span> MiB    <span class=\"token number\">62</span> MiB       <span class=\"token number\">0.10</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>--- POOLS ---</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>POOL  ID  PGS   STORED  OBJECTS     USED  %USED  MAX AVAIL</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.mgr   <span class=\"token number\">1</span>    <span class=\"token number\">1</span>  <span class=\"token number\">449</span> KiB        <span class=\"token number\">2</span>  <span class=\"token number\">1.3</span> MiB      <span class=\"token number\">0</span>     <span class=\"token number\">19</span> GiB</pre></td></tr></table></figure><h4 id=\"6-ceph-dashboard\"><a class=\"anchor\" href=\"#6-ceph-dashboard\">#</a> 6. Ceph dashboard</h4>\n<h5 id=\"61-暴露服务\"><a class=\"anchor\" href=\"#61-暴露服务\">#</a> 6.1 暴露服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc -n rook-ceph</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>             AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>rook-ceph-mgr             ClusterIP   <span class=\"token number\">10.96</span>.54.15     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">9283</span>/TCP            133m</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rook-ceph-mgr-dashboard   ClusterIP   <span class=\"token number\">10.96</span>.97.117    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">7000</span>/TCP            133m        <span class=\"token comment\">#暴露 ingresss 也可</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-ceph-mon-a           ClusterIP   <span class=\"token number\">10.96</span>.125.216   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">6789</span>/TCP,3300/TCP   170m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rook-ceph-mon-b           ClusterIP   <span class=\"token number\">10.96</span>.34.183    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">6789</span>/TCP,3300/TCP   133m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rook-ceph-mon-c           ClusterIP   <span class=\"token number\">10.96</span>.232.252   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">6789</span>/TCP,3300/TCP   133m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f dashboard-external-http.yaml           #暴露 nodeport</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc -n rook-ceph rook-ceph-mgr-dashboard-external-http</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>NAME                                     TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>          AGE</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>rook-ceph-mgr-dashboard-external-https   NodePort   <span class=\"token number\">10.96</span>.11.120   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">8443</span>:32611/TCP   45s</pre></td></tr></table></figure><h5 id=\"62-配置ingress访问ceph\"><a class=\"anchor\" href=\"#62-配置ingress访问ceph\">#</a> 6.2 配置 ingress 访问 ceph</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat dashboard-ingress-https.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># This example is for Kubernetes running an nginx-ingress</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># and an ACME (e.g. Let's Encrypt) certificate service</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># The nginx-ingress annotations support the dashboard</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># running using HTTPS with a self-signed certificate</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: rook-ceph-mgr-dashboard</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  namespace: rook-ceph <span class=\"token comment\"># namespace:cluster</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#  annotations:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#    kubernetes.io/ingress.class: \"nginx\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#    kubernetes.io/tls-acme: \"true\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#    nginx.ingress.kubernetes.io/backend-protocol: \"HTTPS\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#    nginx.ingress.kubernetes.io/server-snippet: |</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#      proxy_ssl_verify off;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#  tls:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#    - hosts:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#        - rook-ceph.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#      secretName: rook-ceph.example.com</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    - host: rook-ceph.hmallleasing.com</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      http:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        paths:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          - path: /</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            pathType: Prefix</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            backend:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              service:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                name: rook-ceph-mgr-dashboard</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                port:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                  name: http-dashboard</pre></td></tr></table></figure><h5 id=\"63-登录\"><a class=\"anchor\" href=\"#63-登录\">#</a> 6.3 登录</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://192.168.40.100:32611</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>用户名：admin</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>密码：kubectl <span class=\"token parameter variable\">-n</span> rook-ceph get secret rook-ceph-dashboard-password <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">\"&#123;['data']['password']&#125;\"</span> <span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">--decode</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">echo</span></pre></td></tr></table></figure><h4 id=\"7-ceph-块存储的使用\"><a class=\"anchor\" href=\"#7-ceph-块存储的使用\">#</a> 7. Ceph 块存储的使用</h4>\n<p>块存储一般用于一个 Pod 挂载一块存储使用，相当于一个服务器新挂了一个盘，只给一个应用使用。</p>\n<h5 id=\"71-创建-storageclass-和-ceph-的存储池\"><a class=\"anchor\" href=\"#71-创建-storageclass-和-ceph-的存储池\">#</a> 7.1 创建 StorageClass 和 ceph 的存储池</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get csidriver</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                            ATTACHREQUIRED   PODINFOONMOUNT   STORAGECAPACITY   TOKENREQUESTS   REQUIRESREPUBLISH   MODES        AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>rook-ceph.cephfs.csi.ceph.com   <span class=\"token boolean\">true</span>             <span class=\"token boolean\">false</span>            <span class=\"token boolean\">false</span>             <span class=\"token operator\">&lt;</span>unset<span class=\"token operator\">></span>         <span class=\"token boolean\">false</span>               Persistent   15h       <span class=\"token comment\">#文件存储 csi</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rook-ceph.rbd.csi.ceph.com      <span class=\"token boolean\">true</span>             <span class=\"token boolean\">false</span>            <span class=\"token boolean\">false</span>             <span class=\"token operator\">&lt;</span>unset<span class=\"token operator\">></span>         <span class=\"token boolean\">false</span>               Persistent   15h       <span class=\"token comment\">#块存储 csi</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/rook/deploy/examples/</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim csi/rbd/storageclass.yaml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>apiVersion: ceph.rook.io/v1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kind: CephBlockPool</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: replicapool</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  namespace: rook-ceph <span class=\"token comment\"># namespace:cluster</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  failureDomain: <span class=\"token function\">host</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  replicated:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    size: <span class=\"token number\">3</span>                <span class=\"token comment\">#数据保存几份，测试环境可以将副本数设置成了 2（不能设置为 1），生产环境最少为 3，且要小于等于 osd 的数量</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>allowVolumeExpansion: <span class=\"token boolean\">true</span>     <span class=\"token comment\">#是否可以扩容</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>reclaimPolicy: Delete          <span class=\"token comment\">#pv 回收策略</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f csi/rbd/storageclass.yaml -n rook-ceph</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get cephblockpool -n rook-ceph</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>NAME          PHASE</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>replicapool   Ready</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get sc</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>NAME              PROVISIONER                  RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>nfs-storage       nfzl.com/nfs                 Delete          Immediate           <span class=\"token boolean\">false</span>                  16h</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>rook-ceph-block   rook-ceph.rbd.csi.ceph.com   Delete          Immediate           <span class=\"token boolean\">true</span>                   37s</pre></td></tr></table></figure><h5 id=\"72-挂载测试\"><a class=\"anchor\" href=\"#72-挂载测试\">#</a> 7.2 挂载测试</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ceph-block-pvc.yaml        #创建 PVC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: ceph-block-pvc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  storageClassName: <span class=\"token string\">\"rook-ceph-block\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      storage: 1Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f ceph-block-pvc.yaml </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ceph-block-pvc   Bound    pvc-86c94d8d-c359-47b8-b5d3-31dcdaf86551   1Gi        RWO            rook-ceph-block   3s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS      REASON   AGE</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pvc-86c94d8d-c359-47b8-b5d3-31dcdaf86551   1Gi        RWO            Delete           Bound    default/ceph-block-pvc   rook-ceph-block</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ceph-block-pvc-pod.yaml    #挂载 PVC 测试 </span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: ceph-block-pvc-pod</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  containers:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  - name: ceph-block-pvc-pod</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    image: nginx</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    volumeMounts:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    - name: nginx-page</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  - name: nginx-page</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    persistentVolumeClaim:      </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      claimName: ceph-block-pv</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f ceph-block-pvc-pod.yaml</span></pre></td></tr></table></figure><h5 id=\"73-statefulset-volumeclaimtemplates\"><a class=\"anchor\" href=\"#73-statefulset-volumeclaimtemplates\">#</a> 7.3 StatefulSet volumeClaimTemplates</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ceph-block-pvc-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    name: web</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      clusterIP: None</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  name: web</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      app: nginx <span class=\"token comment\"># 必须匹配 .spec.template.metadata.labels</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  serviceName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  replicas: <span class=\"token number\">3</span> <span class=\"token comment\"># 默认值是 1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        app: nginx <span class=\"token comment\"># 必须匹配 .spec.selector.matchLabels</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      - name: nginx</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        image: nginx:1.20</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          name: web</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    name: www</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span> <span class=\"token string\">\"ReadWriteOnce\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      storageClassName: <span class=\"token string\">\"rook-ceph-block\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          storage: 1Gi</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    \t  </pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f ceph-block-pvc-sts.yaml </span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS       AGE</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>web-0                                     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              4m19s</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>web-1                                     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              4m10s</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>web-2                                     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              2m21s</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>www-web-0   Bound    pvc-27cab5bf-f989-4050-aa84-1b2dac9fa745   1Gi        RWO            rook-ceph-block   4m23s</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>www-web-1   Bound    pvc-76fb08f4-2195-4678-b6b8-286c2f722cc9   1Gi        RWO            rook-ceph-block   4m14s</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>www-web-2   Bound    pvc-6b858cd9-288f-48bc-bc96-33e6eb519613   1Gi        RWO            rook-ceph-block   2m25s</pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS      REASON   AGE</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>pvc-27cab5bf-f989-4050-aa84-1b2dac9fa745   1Gi        RWO            Delete           Bound    default/www-web-0   rook-ceph-block            4m25s</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>pvc-6b858cd9-288f-48bc-bc96-33e6eb519613   1Gi        RWO            Delete           Bound    default/www-web-2   rook-ceph-block            2m27s</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>pvc-76fb08f4-2195-4678-b6b8-286c2f722cc9   1Gi        RWO            Delete           Bound    default/www-web-1   rook-ceph-block            4m16s</pre></td></tr></table></figure><h4 id=\"8-共享文件系统的使用\"><a class=\"anchor\" href=\"#8-共享文件系统的使用\">#</a> 8. 共享文件系统的使用</h4>\n<p>共享文件系统一般用于多个 Pod 共享一个存储</p>\n<h5 id=\"81-创建共享类型的文件系统\"><a class=\"anchor\" href=\"#81-创建共享类型的文件系统\">#</a> 8.1 创建共享类型的文件系统</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/rook/deploy/examples/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f filesystem.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -l app=rook-ceph-mds -n rook-ceph</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                                    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-ceph-mds-myfs-a-7d76cb5988-9nz9p   <span class=\"token number\">2</span>/2     Running   <span class=\"token number\">0</span>          36s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rook-ceph-mds-myfs-b-76ff7c784c-vs8nm   <span class=\"token number\">2</span>/2     Running   <span class=\"token number\">0</span>          33s</pre></td></tr></table></figure><h5 id=\"82-创建共享类型文件系统的-storageclass\"><a class=\"anchor\" href=\"#82-创建共享类型文件系统的-storageclass\">#</a> 8.2 创建共享类型文件系统的 StorageClass</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd csi/cephfs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cephfs<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f storageclass.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cephfs<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get sc</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME              PROVISIONER                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nfs-storage       nfzl.com/nfs                    Delete          Immediate           <span class=\"token boolean\">false</span>                  17h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           <span class=\"token boolean\">true</span>                   82m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           <span class=\"token boolean\">true</span>                   13s</pre></td></tr></table></figure><h5 id=\"83-挂载测试\"><a class=\"anchor\" href=\"#83-挂载测试\">#</a> 8.3 挂载测试</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat cephfs-pvc-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    name: web</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  name: nginx-share-pvc</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  storageClassName: rook-cephfs </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>kind: Deployment </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  name: web</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      app: nginx <span class=\"token comment\"># has to match .spec.template.metadata.labels</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  replicas: <span class=\"token number\">3</span> <span class=\"token comment\"># by default is 1</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        app: nginx <span class=\"token comment\"># has to match .spec.selector.matchLabels</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      - name: nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        image: nginx </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          name: web</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            claimName: nginx-share-pvc</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f cephfs-pvc-deploy.yaml</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS        AGE</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>cluster-test-84dfc9c68b-5q4ng             <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">84</span> <span class=\"token punctuation\">(</span>4m2s ago<span class=\"token punctuation\">)</span>   16d</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>nfs-client-provisioner-5dbbd8d796-lhdgw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">5</span> <span class=\"token punctuation\">(</span>123m ago<span class=\"token punctuation\">)</span>    18h</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>web-6c59f8559-g5xzb                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               46s</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>web-6c59f8559-ns77q                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               46s</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>web-6c59f8559-qxb5f                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               46s</pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   2Gi        RWX            rook-cephfs    52s</pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                     STORAGECLASS   REASON   AGE</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   2Gi        RWX            Delete           Bound    default/nginx-share-pvc   rook-cephfs             53s</pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it web-6c59f8559-g5xzb -- bash</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class=\"token comment\"># cd /usr/share/nginx/html/</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># echo \"hello cephfs\" >> index.html</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>    AGE</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>kubernetes           ClusterIP   <span class=\"token number\">10.96</span>.0.1     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>/TCP    16d</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>mysql-svc-external   ClusterIP   None          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">3306</span>/TCP   9d</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>nginx                ClusterIP   <span class=\"token number\">10.96</span>.58.17   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>/TCP     4m34s</pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 10.96.58.17</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>hello cephfs</pre></td></tr></table></figure><h4 id=\"9pvc-扩容\"><a class=\"anchor\" href=\"#9pvc-扩容\">#</a> 9.PVC 扩容</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get sc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME              PROVISIONER                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nfs-storage       nfzl.com/nfs                    Delete          Immediate           <span class=\"token boolean\">false</span>                  18h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           <span class=\"token boolean\">true</span>                   104m     <span class=\"token comment\">#true 允许扩容</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           <span class=\"token boolean\">true</span>                   22m      <span class=\"token comment\">#true 允许扩容</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   2Gi        RWX            rook-cephfs    13m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit pvc nginx-share-pvc</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - ReadWriteMany</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      storage: 5Gi         <span class=\"token comment\">#更改 pvc 大小</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  storageClassName: rook-cephfs</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc       #查看 PVC 是否扩容</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    15m</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv         #查看 PV 是否扩容</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                     STORAGECLASS   REASON   AGE</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            Delete           Bound    default/nginx-share-pvc   rook-cephfs             15m</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it web-6c59f8559-g5xzb -- bash       #进入容器，查看 pod 是否扩容  </span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class=\"token comment\"># df -h </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Filesystem                                                                                                                                             Size  Used Avail Use% Mounted on</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>overlay                                                                                                                                                 17G   13G  <span class=\"token number\">4</span>.1G  <span class=\"token number\">76</span>% /</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>tmpfs                                                                                                                                                   64M     <span class=\"token number\">0</span>   64M   <span class=\"token number\">0</span>% /dev</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /sys/fs/cgroup</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>/dev/sda3                                                                                                                                               17G   13G  <span class=\"token number\">4</span>.1G  <span class=\"token number\">76</span>% /etc/hosts</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>shm                                                                                                                                                     64M     <span class=\"token number\">0</span>   64M   <span class=\"token number\">0</span>% /dev/shm</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token number\">10.96</span>.121.140:6789,10.96.131.130:6789,10.96.62.64:6789:/volumes/csi/csi-vol-3b645a11-58f4-475a-9404-5d84964f5291/e4bdf743-eb18-42c8-b04f-41964f76de4f  <span class=\"token number\">5</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">5</span>.0G   <span class=\"token number\">0</span>% /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">3</span>.8G   12K  <span class=\"token number\">3</span>.8G   <span class=\"token number\">1</span>% /run/secrets/kubernetes.io/serviceaccount</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /proc/asound</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /proc/acpi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /proc/scsi</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /sys/firmware</pre></td></tr></table></figure><h4 id=\"10-pvc-快照\"><a class=\"anchor\" href=\"#10-pvc-快照\">#</a> 10. PVC 快照</h4>\n<h5 id=\"101-文件共享类型快照\"><a class=\"anchor\" href=\"#101-文件共享类型快照\">#</a> 10.1 文件共享类型快照</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd rook/deploy/examples</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f csi/cephfs/snapshotclass.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get volumesnapshotclass</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>NAME                         DRIVER                          DELETIONPOLICY   AGE</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>csi-cephfsplugin-snapclass   rook-ceph.cephfs.csi.ceph.com   Delete           25s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#拍摄快照\t</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it web-6c59f8559-g5xzb -- bash         #pvc 新增数据</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class=\"token comment\"># cd /usr/share/nginx/html/</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># touch &#123;1..10&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">1</span>  <span class=\"token number\">10</span>  <span class=\"token number\">2</span>  <span class=\"token number\">3</span>  <span class=\"token number\">4</span>\t<span class=\"token number\">5</span>  <span class=\"token number\">6</span>  <span class=\"token number\">7</span>  <span class=\"token number\">8</span>  <span class=\"token number\">9</span>  index.html</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc       #查看 pvs 并对 nginx-share-pvc 拍摄快照</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    4h23m</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/snapshot.yaml         #拍摄快照</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 1.17 &lt;= K8s &lt;= v1.19</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># apiVersion: snapshot.storage.k8s.io/v1beta1</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># K8s >= v1.20</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: snapshot.storage.k8s.io/v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: VolumeSnapshot</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: cephfs-pvc-snapshot</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  volumeSnapshotClassName: csi-cephfsplugin-snapclass</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  source:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    persistentVolumeClaimName: nginx-share-pvc         <span class=\"token comment\">#基于那个 PVC 拍摄快照</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/snapshot.yaml</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get volumesnapshot</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>NAME                  READYTOUSE   SOURCEPVC         SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS                SNAPSHOTCONTENT                                    CREATIONTIME   AGE</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>cephfs-pvc-snapshot   <span class=\"token boolean\">true</span>         nginx-share-pvc                           5Gi           csi-cephfsplugin-snapclass   snapcontent-bdaddb97-debe-4f42-9423-13bf1c5b5402   4m6s           4m8s</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#删除 pvc 数据</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it web-6c59f8559-g5xzb -- bash</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class=\"token comment\"># cd /usr/share/nginx/html/</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token number\">1</span>  <span class=\"token number\">10</span>  <span class=\"token number\">2</span>  <span class=\"token number\">3</span>  <span class=\"token number\">4</span>\t<span class=\"token number\">5</span>  <span class=\"token number\">6</span>  <span class=\"token number\">7</span>  <span class=\"token number\">8</span>  <span class=\"token number\">9</span>  index.html</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># rm -rf &#123;1..10&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>index.html</pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">#pvc 回滚数据</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get volumesnapshot</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>NAME                  READYTOUSE   SOURCEPVC         SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS                SNAPSHOTCONTENT                                    CREATIONTIME   AGE</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>cephfs-pvc-snapshot   <span class=\"token boolean\">true</span>         nginx-share-pvc                           5Gi           csi-cephfsplugin-snapclass   snapcontent-bdaddb97-debe-4f42-9423-13bf1c5b5402   7m39s          7m41s</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/pvc-restore.yaml </span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  name: cephfs-pvc-restore</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  storageClassName: rook-cephfs       <span class=\"token comment\">#创建 pv 的 storageclass 名称相同</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  dataSource:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    name: cephfs-pvc-snapshot         <span class=\"token comment\">#volumesnapshot 数据源</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    kind: VolumeSnapshot</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    apiGroup: snapshot.storage.k8s.io</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      storage: 5Gi      <span class=\"token comment\">#大小等于 snapshot 大小</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/pvc-restore.yaml</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>cephfs-pvc-restore   Bound    pvc-9e845f2b-df1f-450d-8aa2-f9a46db6adb6   5Gi        RWX            rook-cephfs    54s          </pre></td></tr><tr><td data-num=\"76\"></td><td><pre>nginx-share-pvc      Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    4h50m</pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token comment\">#挂载 PVC 测试数据是否恢复</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/pod.yaml </span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  name: csicephfs-demo-pod</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  containers:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    - name: web-server</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      image: nginx</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      volumeMounts:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        - name: mypvc</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          mountPath: /var/lib/www/html</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    - name: mypvc</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>      persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        claimName: cephfs-pvc-restore        <span class=\"token comment\">#挂载恢复 pvc</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/pod.yaml</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS        AGE</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>cluster-test-84dfc9c68b-5q4ng             <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">88</span> <span class=\"token punctuation\">(</span>57m ago<span class=\"token punctuation\">)</span>    16d</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>csicephfs-demo-pod                        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               24s</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>nfs-client-provisioner-5dbbd8d796-lhdgw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">5</span> <span class=\"token punctuation\">(</span>6h57m ago<span class=\"token punctuation\">)</span>   23h</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>web-6c59f8559-g5xzb                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               4h54m</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>web-6c59f8559-ns77q                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               4h54m</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>web-6c59f8559-qxb5f                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               4h54m</pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it csicephfs-demo-pod -- bash</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>root@csicephfs-demo-pod:/<span class=\"token comment\"># ls /var/lib/www/html/               #s 删除数据已经恢复</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token number\">1</span>  <span class=\"token number\">10</span>  <span class=\"token number\">2</span>  <span class=\"token number\">3</span>  <span class=\"token number\">4</span>\t<span class=\"token number\">5</span>  <span class=\"token number\">6</span>  <span class=\"token number\">7</span>  <span class=\"token number\">8</span>  <span class=\"token number\">9</span>  index.html</pre></td></tr></table></figure><h5 id=\"102-pvc-克隆\"><a class=\"anchor\" href=\"#102-pvc-克隆\">#</a> 10.2 PVC 克隆</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>cephfs-pvc-restore   Bound    pvc-9e845f2b-df1f-450d-8aa2-f9a46db6adb6   5Gi        RWX            rook-cephfs    11m</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-share-pvc      Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    5h1m</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/pvc-clone.yaml </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: cephfs-pvc-clone</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  storageClassName: rook-cephfs      <span class=\"token comment\"># pvc 的 storageClass 名称</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  dataSource:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    name: nginx-share-pvc          <span class=\"token comment\">#克隆的 PVC 名称</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      storage: 5Gi                 <span class=\"token comment\">#大小等于所克隆的 PVC 大小</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/pvc-clone.yaml</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>cephfs-pvc-clone     Bound    pvc-0a19b65e-cb5e-4379-a7f7-e0783fcf8ddf   5Gi        RWX            rook-cephfs    22s</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>cephfs-pvc-restore   Bound    pvc-9e845f2b-df1f-450d-8aa2-f9a46db6adb6   5Gi        RWX            rook-cephfs    15m</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>nginx-share-pvc      Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    5h4m</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#挂载克隆 PVC 测试</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/pod.yaml </span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  name: csicephfs-demo-pod</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  containers:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    - name: web-server</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      image: nginx</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        - name: mypvc</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          mountPath: /var/lib/www/html</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    - name: mypvc</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        claimName: cephfs-pvc-clone      <span class=\"token comment\">#挂载克隆的 pvc</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/pod.yaml          </span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS         AGE</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>cluster-test-84dfc9c68b-5q4ng             <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">89</span> <span class=\"token punctuation\">(</span>9m54s ago<span class=\"token punctuation\">)</span>   16d</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>csicephfs-demo-pod                        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>                17s</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>nfs-client-provisioner-5dbbd8d796-lhdgw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">5</span> <span class=\"token punctuation\">(</span>7h9m ago<span class=\"token punctuation\">)</span>     23h</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>web-6c59f8559-g5xzb                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>                5h6m</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>web-6c59f8559-ns77q                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>                5h6m</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>web-6c59f8559-qxb5f                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>                5h6m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it csicephfs-demo-pod -- bash</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>root@csicephfs-demo-pod:/<span class=\"token comment\"># cat /var/lib/www/html/index.html </span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>hello cephfs</pre></td></tr></table></figure><h4 id=\"11-测试数据清理\"><a class=\"anchor\" href=\"#11-测试数据清理\">#</a> 11. 测试数据清理</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>参考文档：https://rook.io/docs/rook/v1.11/Getting-Started/ceph-teardown/<span class=\"token comment\">#delete-the-cephcluster-crd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete deploy web</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete pods csicephfs-demo-pod</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete pvc --all</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>No resources found <span class=\"token keyword\">in</span> default namespace.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>No resources found</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get volumesnapshot</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>NAME                  READYTOUSE   SOURCEPVC         SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS                SNAPSHOTCONTENT                                    CREATIONTIME   AGE</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>cephfs-pvc-snapshot   <span class=\"token boolean\">true</span>         nginx-share-pvc                           5Gi           csi-cephfsplugin-snapclass   snapcontent-bdaddb97-debe-4f42-9423-13bf1c5b5402   61m            61m</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete volumesnapshot cephfs-pvc-snapshot</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>volumesnapshot.snapshot.storage.k8s.io <span class=\"token string\">\"cephfs-pvc-snapshot\"</span> deleted</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-n</span> rook-ceph cephblockpool replicapool</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-n</span> rook-ceph cephfilesystem myfs</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kubectl delete storageclass rook-ceph-block</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kubectl delete storageclass rook-cephfs</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-f</span> csi/cephfs/kube-registry.yaml</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kubectl delete storageclass csi-cephfs</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>kubectl <span class=\"token parameter variable\">-n</span> rook-ceph delete cephcluster rook-ceph</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-f</span> operator.yaml</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-f</span> common.yaml</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-f</span> crds.yaml</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3890389502.html",
            "url": "http://ixuyong.cn/posts/3890389502.html",
            "title": "K8S持久化存储NFS+StorageClass",
            "date_published": "2025-04-23T12:08:26.000Z",
            "content_html": "<h3 id=\"k8s持久化存储nfsstorageclass\"><a class=\"anchor\" href=\"#k8s持久化存储nfsstorageclass\">#</a> K8S 持久化存储 NFS+StorageClass</h3>\n<h4 id=\"1-搭建nfs服务器\"><a class=\"anchor\" href=\"#1-搭建nfs服务器\">#</a> 1. 搭建 NFS 服务器</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#所有 K8S 节点安装 nfs-utils</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y    </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#K8S-node02 节点配置 nfs 服务</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data/nfs -p</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/exports</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>/data/nfs <span class=\"token number\">192.168</span>.1.0/24<span class=\"token punctuation\">(</span>rw,no_root_squash<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># exportfs -arv   #NFS 配置生效 </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nfs-server &amp;&amp; systemctl enable nfs-server &amp;&amp; systemctl status nfs-server</span></pre></td></tr></table></figure><h4 id=\"2-创建rbac\"><a class=\"anchor\" href=\"#2-创建rbac\">#</a> 2.  创建 RBAC</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 01-rbac.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: nfs-client-provisioner-runner</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"nodes\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"persistentvolumes\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span>, <span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"persistentvolumeclaims\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span>, <span class=\"token string\">\"update\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"storage.k8s.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"storageclasses\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"events\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"update\"</span>, <span class=\"token string\">\"patch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kind: ClusterRoleBinding</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  name: run-nfs-client-provisioner</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  - kind: ServiceAccount</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    namespace: default</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  kind: ClusterRole</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  name: nfs-client-provisioner-runner</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  name: leader-locking-nfs-client-provisioner</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"endpoints\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span>, <span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"update\"</span>, <span class=\"token string\">\"patch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  name: leader-locking-nfs-client-provisioner</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  - kind: ServiceAccount</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    namespace: default</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  name: leader-locking-nfs-client-provisioner</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-rbac.yaml </span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>serviceaccount/nfs-client-provisioner created</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</pre></td></tr></table></figure><h4 id=\"3-创建nfs-provisioner\"><a class=\"anchor\" href=\"#3-创建nfs-provisioner\">#</a> 3. 创建 nfs-provisioner</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 02-nfs-provisioner.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  strategy:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    type: Recreate</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      app: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        app: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      serviceAccountName: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          image: registry.cn-hangzhou.aliyuncs.com/old_xu/nfs-subdir-external-provisioner:v4.0.2</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            - name: nfs-client-root</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              mountPath: /persistentvolumes</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          env:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            - name: PROVISIONER_NAME\t<span class=\"token comment\"># nfs-provisioner 的名称，后续 storageClass 要与该名称一致</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              value: nfzl.com/nfs</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            - name: NFS_SERVER\t\t<span class=\"token comment\"># NFS 服务的 IP 地址</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>              value: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            - name: NFS_PATH\t\t<span class=\"token comment\"># NFS 服务共享的路径</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              value: /data/nfs</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: nfs-client-root</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          nfs:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            path: /data/nfs</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-nfs-provisioner.yaml </span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>nfs-client-provisioner-6bcc4587f8-zp8qc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17s</pre></td></tr></table></figure><h4 id=\"4-创建storageclass\"><a class=\"anchor\" href=\"#4-创建storageclass\">#</a> 4. 创建 StorageClass</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 03-storageClass.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: storage.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StorageClass</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nfs-storage \t<span class=\"token comment\"># pvc 申请时需明确指定的 storageClass 名称</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>provisioner: nfzl.com/nfs        <span class=\"token comment\"># 供应商名称，必须和上面创建的 \"PROVISIONER_NAME\" 变量值致</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>parameters:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  archiveOnDelete: <span class=\"token string\">\"false\"</span>     <span class=\"token comment\"># 如果值为 false，删除 PVC 后也会删除目录内容，\"true\" 则会对数据进行保留</span></pre></td></tr></table></figure><h4 id=\"5-创建pvc\"><a class=\"anchor\" href=\"#5-创建pvc\">#</a> 5. 创建 PVC</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 04-nginx-pvc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: sc-pvc-001</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  storageClassName: <span class=\"token string\">\"nfs-storage\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      storage: 1Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 04-nginx-pvc.yaml</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/fgpaP15.png\" alt=\"1.png\" /></p>\n<h4 id=\"6-挂载pvc测试\"><a class=\"anchor\" href=\"#6-挂载pvc测试\">#</a> 6. 挂载 PVC 测试</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 05-nginx-pod.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-sc-001</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  containers:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - name: nginx-sc-001</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    image: nginx</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    volumeMounts:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    - name: nginx-page</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - name: nginx-page</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    persistentVolumeClaim:      </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      claimName: sc-pvc-001</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 05-nginx-pod.yaml</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>nginx-sc-001                              <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15s   <span class=\"token number\">172.16</span>.85.244   k8s-node01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 172.16.85.244</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>hello world</pre></td></tr></table></figure>",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/722512536.html",
            "url": "http://ixuyong.cn/posts/722512536.html",
            "title": "K8s细粒度权限控制RBAC",
            "date_published": "2025-04-23T12:04:03.000Z",
            "content_html": "<h3 id=\"k8s细粒度权限控制rbac\"><a class=\"anchor\" href=\"#k8s细粒度权限控制rbac\">#</a> K8s 细粒度权限控制 RBAC</h3>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KCZPPkv.jpeg\" alt=\"rbac.jpg\" /></p>\n<h4 id=\"1-创建不同权限的clusterrole\"><a class=\"anchor\" href=\"#1-创建不同权限的clusterrole\">#</a> 1. 创建不同权限的 clusterrole</h4>\n<h5 id=\"11-命令空间只读namespace-readonly\"><a class=\"anchor\" href=\"#11-命令空间只读namespace-readonly\">#</a> 1.1 命令空间只读 namespace-readonly</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> namespace-readonly.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: namespace-readonly</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - namespaces</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  - metrics.k8s.io</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr></table></figure><h5 id=\"12-资源查看resource-readonly\"><a class=\"anchor\" href=\"#12-资源查看resource-readonly\">#</a> 1.2 资源查看 resource-readonly</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> resource-readonly.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: resource-readonly</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - configmaps</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - endpoints</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - persistentvolumeclaims</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - replicationcontrollers</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - replicationcontrollers/scale</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  - serviceaccounts</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  - services</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  - bindings</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  - events</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  - limitranges</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  - namespaces/status</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  - pods/log</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  - pods/status</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  - replicationcontrollers/status</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  - resourcequotas</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  - resourcequotas/status</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  - namespaces</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  - apps</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  - controllerrevisions</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  - daemonsets</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  - deployments</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  - deployments/scale</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  - replicasets</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  - replicasets/scale</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  - statefulsets</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  - statefulsets/scale</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  - autoscaling</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  - horizontalpodautoscalers</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  - batch</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  - cronjobs</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  - <span class=\"token function\">jobs</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  - extensions</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  - daemonsets</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  - deployments</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  - deployments/scale</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  - ingresses</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  - networkpolicies</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  - replicasets</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  - replicasets/scale</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  - replicationcontrollers/scale</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  - policy</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  - poddisruptionbudgets</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  - networkpolicies</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  - metrics.k8s.io</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr></table></figure><h5 id=\"13-pod日志查看\"><a class=\"anchor\" href=\"#13-pod日志查看\">#</a> 1.3 pod 日志查看</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> pod-log.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: pod-log</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - pods/log</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr></table></figure><h5 id=\"14-pod删除\"><a class=\"anchor\" href=\"#14-pod删除\">#</a> 1.4 Pod 删除</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> pod-delete.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: pod-delete</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - delete</pre></td></tr></table></figure><h5 id=\"15-pod执行\"><a class=\"anchor\" href=\"#15-pod执行\">#</a> 1.5 Pod 执行</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> pod-exec.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: pod-exec</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  - pods/exec</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - create</pre></td></tr></table></figure><h5 id=\"16-创建不同权限的clusterrole\"><a class=\"anchor\" href=\"#16-创建不同权限的clusterrole\">#</a> 1.6 创建不同权限的 clusterrole</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 rbac<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr></table></figure><h4 id=\"2-创建serviceaccount\"><a class=\"anchor\" href=\"#2-创建serviceaccount\">#</a> 2. 创建 serviceaccount</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create ns kube-users</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>$ kubectl create sa <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-n</span> kube-users   </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>$ kubectl create sa dev <span class=\"token parameter variable\">-n</span> kube-users    </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>$ kubectl create sa ops <span class=\"token parameter variable\">-n</span> kube-users    </pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>$ kubectl create token <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-n</span> kube-users</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>$ kubectl create token dev <span class=\"token parameter variable\">-n</span> kube-users</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>$ kubectl create token ops <span class=\"token parameter variable\">-n</span> kube-users</pre></td></tr></table></figure><h4 id=\"3-创建clusterrolebinding\"><a class=\"anchor\" href=\"#3-创建clusterrolebinding\">#</a> 3. 创建 ClusterRoleBinding</h4>\n<h5 id=\"31-绑定全局命名空间查看权限\"><a class=\"anchor\" href=\"#31-绑定全局命名空间查看权限\">#</a> 3.1 绑定全局命名空间查看权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> clusterrolebinding-namespace-readonly.yaml </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRoleBinding</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: clusterrolebinding-namespace-readonly </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- kind: Group</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: system:serviceaccounts:kube-users</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  kind: ClusterRole</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: namespace-readonly</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>$ kubectl apply <span class=\"token parameter variable\">-f</span> clusterrolebinding-namespace-readonly.yaml</pre></td></tr></table></figure><h5 id=\"32-绑定日志查看权限\"><a class=\"anchor\" href=\"#32-绑定日志查看权限\">#</a> 3.2 绑定日志查看权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create rolebinding ops-pod-log <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-log <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectA</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create rolebinding ops-pod-log <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-log <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectB</pre></td></tr></table></figure><h5 id=\"33-绑定资源查看权限\"><a class=\"anchor\" href=\"#33-绑定资源查看权限\">#</a> 3.3 绑定资源查看权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create rolebinding ops-resource-readonly <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>resource-readonly <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectA</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create rolebinding ops-resource-readonly <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>resource-readonly <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectB</pre></td></tr></table></figure><h5 id=\"34-绑定pod执行权限\"><a class=\"anchor\" href=\"#34-绑定pod执行权限\">#</a> 3.4 绑定 Pod 执行权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create rolebinding ops-pod-exec <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-exec <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectA</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create rolebinding ops-pod-exec <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-exec <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectB</pre></td></tr></table></figure><h5 id=\"35-绑定pod删除权限\"><a class=\"anchor\" href=\"#35-绑定pod删除权限\">#</a> 3.5 绑定 Pod 删除权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create rolebinding ops-pod-delete <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-delete <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectA</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create rolebinding ops-pod-delete <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-delete <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectB</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/176412055.html",
            "url": "http://ixuyong.cn/posts/176412055.html",
            "title": "K8s准入控制ResourceQuota、LimitRange、QoS服务质量",
            "date_published": "2025-04-23T11:55:19.000Z",
            "content_html": "<h3 id=\"k8s准入控制resourcequota-limitrange-qos服务质量\"><a class=\"anchor\" href=\"#k8s准入控制resourcequota-limitrange-qos服务质量\">#</a> K8s 准入控制 ResourceQuota、LimitRange、QoS 服务质量</h3>\n<h4 id=\"1-resourcequota配置解析\"><a class=\"anchor\" href=\"#1-resourcequota配置解析\">#</a> 1. ResourceQuota 配置解析</h4>\n<p>ResourceQuotas 实现资源配额，避免过度创建资源，针对 namespace 进行限制。cpu 内存则是根据 pod 配置的 resources 总额进行限制，如果没有配置 resources 参数则无法限制。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: ResourceQuota</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: resourcequota-test</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: resourcequota</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  hard:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    pods: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    requests.cpu: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    requests.memory: 512Mi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    limits.cpu: <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    limits.memory: 16Gi</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    configmaps: <span class=\"token number\">201</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    requests.storage: 40Gi</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    persistentvolumeclaims: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    replicationcontrollers: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    secrets: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    services: <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    services.loadbalancers: <span class=\"token string\">\"2\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    services.nodeports: <span class=\"token string\">\"10\"</span></pre></td></tr></table></figure><ul>\n<li>pods：限制最多启动 Pod 的个数</li>\n<li>requests.cpu：限制最高 CPU 请求数</li>\n<li>requests.memory：限制最高内存的请求数</li>\n<li>limits.cpu：限制最高 CPU 的 limit 上限</li>\n<li>limits.memory：限制最高内存的 limit 上限</li>\n<li>services：限制 services 数量</li>\n<li>services.nodeports：限制 services 中 nodeport 类型 service 数量</li>\n<li>services.loadbalancers：限制 services 中 loadbalancers 类型 service 数量</li>\n</ul>\n<h5 id=\"11-resourcequota配置示例\"><a class=\"anchor\" href=\"#11-resourcequota配置示例\">#</a> 1.1 ResourceQuota 配置示例</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 限制 test 命名空间 pods 数量量为 3、configmap 数量为 2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat rq-test.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: ResourceQuota</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: resourcequota-test</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: resourcequota</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  hard:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    pods: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#    requests.cpu: 3</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#    requests.memory: 512Mi</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#    limits.cpu: 8</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#    limits.memory: 16Gi</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    configmaps: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#    requests.storage: 40Gi</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#    persistentvolumeclaims: 20</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#    replicationcontrollers: 20</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#    secrets: 20</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#    services: 50</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#    services.loadbalancers: \"2\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#    services.nodeports: \"10\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#2.test 命名空间已创建 configmap 数量为 1, 限制数量为 2</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get resourcequota -n test</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>NAME                 AGE   REQUEST                      LIMIT</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>resourcequota-test   61s   configmaps: <span class=\"token number\">1</span>/2, pods: <span class=\"token number\">0</span>/3  </pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#3.test 命名空间创建第 2 个 configmap 时正常，创建第 3 个 configmap 时报错</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create cm rq-cm1 -n test --from-literal=key1=value1</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create cm rq-cm2 -n test --from-literal=key2=value2</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>error: failed to create configmap: configmaps <span class=\"token string\">\"rq-cm2\"</span> is forbidden: exceeded quota: resourcequota-test, requested: <span class=\"token assign-left variable\">configmaps</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, used: <span class=\"token assign-left variable\">configmaps</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>, limited: <span class=\"token assign-left variable\">configmaps</span><span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr></table></figure><h4 id=\"2-limitrange配置解析\"><a class=\"anchor\" href=\"#2-limitrange配置解析\">#</a> 2. LimitRange 配置解析</h4>\n<p>虽然 ResourceQuota 可以实现资源配额，可以限制某个命名空间内存和 CPU，但是如果创建的 Pod 都没有配置 resources 参数则无法限制。如果配置 LimitRange，Pod 没有配置 resources 情况下，创建的 Pod 会根据 LimitRange 配置自动添加 CPU 内存配置，并且可以限制 resources 参数最大配置和最小配置，LimitRange 针对 Pod 进行限制。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: LimitRange</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: cpu-mem-limit-range</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  limits:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - default:         <span class=\"token comment\">#限制 CPU 内存默认 limits 配置</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      memory: 512Mi</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    defaultRequest:  <span class=\"token comment\">#限制 CPU 内存默认 request 配置</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      cpu: <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      memory: 256Mi</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    max:                <span class=\"token comment\">#限制 CPU 内存最大配置 </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      cpu: <span class=\"token string\">\"4000m\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      memory: 4Gi</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    min:                <span class=\"token comment\">#限制 CPU 内存最小配置</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      memory: 100Mi</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    type: Container</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - type: PersistentVolumeClaim    <span class=\"token comment\">#限制 pvc 大小</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    max:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    min:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      storage: 1Gi</pre></td></tr></table></figure><ul>\n<li>default：默认 limits 配置</li>\n<li>defaultRequest：默认 requests 配置</li>\n</ul>\n<h5 id=\"21-配置默认的requests和limits\"><a class=\"anchor\" href=\"#21-配置默认的requests和limits\">#</a> 2.1 配置默认的 requests 和 limits</h5>\n<p>Pod 没有配置 resources 情况下，创建的 Pod 会根据 LimitRange 配置自动添加 CPU 内存配置。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建 LimitRange</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat limitrange.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: LimitRange</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: cpu-mem-limit-range</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  limits:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - default:         <span class=\"token comment\">#限制 CPU 内存默认 limits 配置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      memory: 512Mi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    defaultRequest:  <span class=\"token comment\">#限制 CPU 内存默认 request 配置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      cpu: <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      memory: 256Mi</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    max:                <span class=\"token comment\">#限制 CPU 内存最大配置 </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cpu: <span class=\"token string\">\"4000m\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      memory: 4Gi</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    min:                <span class=\"token comment\">#限制 CPU 内存最小配置</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      memory: 100Mi</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    type: Container</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - type: PersistentVolumeClaim    <span class=\"token comment\">#限制 pvc 大小</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    max:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    min:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      storage: 1Gi  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f limitrange.yaml</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get limitrange -n test</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>NAME                  CREATED AT</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>cpu-mem-limit-range   <span class=\"token number\">2025</span>-04-23T07:55:03Z</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">#2. 创建 deployment, 查看是否会根据 LimitRange 自动添加 CPU 内存配置</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy-limitrange.yaml</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  name: deploy-limirange</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    app: deploy-limirange</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      app: deploy-limirange</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        app: deploy-limirange</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        - name: deploy-limirange</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n test</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>NAME                                READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>deploy-limirange-854c9545ff-grpxr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          39s</pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n test -oyaml</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  spec:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    containers:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    - image: nginx</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      name: deploy-limirange</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        limits:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          cpu: <span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          memory: 512Mi</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          cpu: 500m</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          memory: 256Mi</pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h5 id=\"22-限制requests和limits范围\"><a class=\"anchor\" href=\"#22-限制requests和limits范围\">#</a> 2.2 限制 requests 和 limits 范围</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建 LimitRange</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat limitrange.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: LimitRange</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: cpu-mem-limit-range</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  limits:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - default:         <span class=\"token comment\">#限制 CPU 内存默认 limits 配置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      memory: 512Mi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    defaultRequest:  <span class=\"token comment\">#限制 CPU 内存默认 request 配置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      cpu: <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      memory: 256Mi</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    max:                <span class=\"token comment\">#限制 CPU 内存最大配置 </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cpu: <span class=\"token string\">\"4000m\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      memory: 4Gi</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    min:                <span class=\"token comment\">#限制 CPU 内存最小配置</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      memory: 100Mi</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    type: Container</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - type: PersistentVolumeClaim    <span class=\"token comment\">#限制 pvc 大小</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    max:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    min:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      storage: 1Gi  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#2. 创建 deployment, CPU 内存 limits 和 requests 高于 / 低于 LimitRangeCPU 内存 max、min 配置</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy-limitrange.yaml </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  name: deploy-limirange</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    app: deploy-limirange</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      app: deploy-limirange</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        app: deploy-limirange</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: deploy-limirange</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              memory: 8096Mi</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              cpu: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>              memory: 64Mi</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              cpu: 10m</pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\">#3. 由于创建 deployment, CPU 内存 limits 和 requests 高于 / 低于 LimitRangeCPU 内存 max、min 配置，pod 没有创建</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f deploy-limitrange.yaml </span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get deploy deploy-limirange -n test</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>NAME               READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>deploy-limirange   <span class=\"token number\">0</span>/1     <span class=\"token number\">0</span>            <span class=\"token number\">0</span>           2m7s</pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n test</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe rs deploy-limirange-54c5d69b4b -n test</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>Name:           deploy-limirange-54c5d69b4b</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>Namespace:      <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>Selector:       <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>deploy-limirange,pod-template-hash<span class=\"token operator\">=</span>54c5d69b4b</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>Labels:         <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>deploy-limirange</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                pod-template-hash<span class=\"token operator\">=</span>54c5d69b4b</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>Annotations:    deployment.kubernetes.io/desired-replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                deployment.kubernetes.io/max-replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                deployment.kubernetes.io/revision: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>Controlled By:  Deployment/deploy-limirange</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>Replicas:       <span class=\"token number\">0</span> current / <span class=\"token number\">1</span> desired</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>Pods Status:    <span class=\"token number\">0</span> Running / <span class=\"token number\">0</span> Waiting / <span class=\"token number\">0</span> Succeeded / <span class=\"token number\">0</span> Failed</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>Pod Template:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  Labels:  <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>deploy-limirange</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>           pod-template-hash<span class=\"token operator\">=</span>54c5d69b4b</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  Containers:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>   deploy-limirange:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    Image:      nginx</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    Port:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    Host Port:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    Limits:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      cpu:     <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      memory:  8096Mi</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    Requests:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      cpu:         10m</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>      memory:      64Mi</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    Environment:   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    Mounts:        <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  Volumes:         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  Node-Selectors:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  Tolerations:     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>Conditions:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  Type             Status  Reason</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  ----             ------  ------</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  ReplicaFailure   True    FailedCreate</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>Events:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  Type     Reason        Age                 From                   Message</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  ----     ------        ----                ----                   -------</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  Warning  FailedCreate  3m8s                replicaset-controller  Error creating: pods <span class=\"token string\">\"deploy-limirange-54c5d69b4b-zxhzk\"</span> is forbidden: <span class=\"token punctuation\">[</span>minimum cpu usage per Container is 100m, but request is 10m, minimum memory usage per Container is 100Mi, but request is 64Mi, maximum cpu usage per Container is <span class=\"token number\">4</span>, but limit is <span class=\"token number\">5</span>, maximum memory usage per Container is 4Gi, but limit is 8096Mi<span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h5 id=\"23-限制存储空间大小\"><a class=\"anchor\" href=\"#23-限制存储空间大小\">#</a> 2.3 限制存储空间大小</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建 LimitRange</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat limitrange.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: LimitRange</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: cpu-mem-limit-range</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  limits:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - default:         <span class=\"token comment\">#限制 CPU 内存默认 limits 配置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      memory: 512Mi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    defaultRequest:  <span class=\"token comment\">#限制 CPU 内存默认 request 配置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      cpu: <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      memory: 256Mi</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    max:                <span class=\"token comment\">#限制 CPU 内存最大配置 </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cpu: <span class=\"token string\">\"4000m\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      memory: 4Gi</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    min:                <span class=\"token comment\">#限制 CPU 内存最小配置</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      memory: 100Mi</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    type: Container</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - type: PersistentVolumeClaim    <span class=\"token comment\">#限制 pvc 大小</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    max:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    min:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      storage: 1Gi  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#2. 由于创建的 pvc 大于 2G，所以报错  </span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat pvc.yaml </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  name: sc-pvc-001</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  storageClassName: <span class=\"token string\">\"nfs-storage\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      storage: 3Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请  </span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pvc.yaml -n test</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Error from server <span class=\"token punctuation\">(</span>Forbidden<span class=\"token punctuation\">)</span>: error when creating <span class=\"token string\">\"pvc.yaml\"</span><span class=\"token builtin class-name\">:</span> persistentvolumeclaims <span class=\"token string\">\"sc-pvc-001\"</span> is forbidden: maximum storage usage per PersistentVolumeClaim is 2Gi, but request is 3Gi</pre></td></tr></table></figure><h4 id=\"3-服务质量-qos\"><a class=\"anchor\" href=\"#3-服务质量-qos\">#</a> 3. 服务质量 QoS</h4>\n<ul>\n<li>Guaranteed：最高服务质量，当宿主机内存不够时，会先 kill 掉 QoS 为 BestEffort 和 Burstable 的 Pod，如果内存还是不够，才会 kill 掉 QoS 为 Guaranteed，该级别 Pod 的资源占用量一般比较明确，即 requests 的 cpu 和 memory 和 limits 的 cpu 和 memory 配置的一致。</li>\n<li>Burstable： 服务质量低于 Guaranteed，当宿主机内存不够时，会先 kill 掉 QoS 为 BestEffort 的 Pod，如果内存还是不够之后就会 kill 掉 QoS 级别为 Burstable 的 Pod，用来保证 QoS 质量为 Guaranteed 的 Pod，该级别 Pod 一般知道最小资源使用量，但是当机器资源充足时，还是想尽可能的使用更多的资源，即 limits 字段的 cpu 和 memory 大于 requests 的 cpu 和 memory 的配置。</li>\n<li>BestEffort：尽力而为，当宿主机内存不够时，首先 kill 的就是该 QoS 的 Pod，用以保证 Burstable 和 Guaranteed 级别的 Pod 正常运行。</li>\n</ul>\n<h5 id=\"31-实现qos为guaranteed的pod\"><a class=\"anchor\" href=\"#31-实现qos为guaranteed的pod\">#</a> 3.1 实现 QoS 为 Guaranteed 的 Pod</h5>\n<ol>\n<li>\n<p>Pod 中的每个容器必须指定 limits.memory 和 requests.memory，并且两者需要相等；</p>\n</li>\n<li>\n<p>Pod 中的每个容器必须指定 limits.cpu 和 limits.memory，并且两者需要相等。</p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr></table></figure><h5 id=\"32-实现qos为burstable的pod\"><a class=\"anchor\" href=\"#32-实现qos为burstable的pod\">#</a> 3.2 实现 QoS 为 Burstable 的 Pod</h5>\n<ol>\n<li>\n<p>Pod 不符合 Guaranteed 的配置要求；</p>\n</li>\n<li>\n<p>Pod 中至少有一个容器配置了 requests.cpu 或 requests.memory。</p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><h5 id=\"33-实现qos为besteffort的pod\"><a class=\"anchor\" href=\"#33-实现qos为besteffort的pod\">#</a> 3.3 实现 QoS 为 BestEffort 的 Pod</h5>\n<ol>\n<li>不设置 resources 参数</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/312010518.html",
            "url": "http://ixuyong.cn/posts/312010518.html",
            "title": "K8s亲和力Affinity",
            "date_published": "2025-04-20T09:59:58.000Z",
            "content_html": "<h3 id=\"k8s亲和力affinity\"><a class=\"anchor\" href=\"#k8s亲和力affinity\">#</a> K8s 亲和力 Affinity</h3>\n<p>Pod 和节点之间的关系：</p>\n<ul>\n<li>某些 Pod 优先选择有 ssd=true 标签的节点，如果没有在考虑部署到其它节点；</li>\n<li>某些 Pod 需要部署在 ssd=true 和 type=physical 的节点上，但是优先部署在 ssd=true 的节点上。</li>\n</ul>\n<p>Pod 和 Pod 之间的关系：</p>\n<ul>\n<li>同一个应用的 Pod 不同的副本或者同一个项目的应用尽量或必须不部署在同一个节点或者符合某个标签的一类节点上或者不同的区域；</li>\n<li>相互依赖的两个 Pod 尽量或必须部署在同一个节点上或者同一个域内。</li>\n</ul>\n<h4 id=\"1-affinity分类\"><a class=\"anchor\" href=\"#1-affinity分类\">#</a> 1. Affinity 分类</h4>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/hTd0wmD.png\" alt=\"1.png\" /></p>\n<h4 id=\"2-节点亲和力配置详解\"><a class=\"anchor\" href=\"#2-节点亲和力配置详解\">#</a> 2. 节点亲和力配置详解</h4>\n<h5 id=\"21-硬亲和力required\"><a class=\"anchor\" href=\"#21-硬亲和力required\">#</a> 2.1 硬亲和力 required</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        nodeAffinity:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            nodeSelectorTerms:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>              - matchExpressions:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                  - key: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                      - k8s-node01</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                      - k8s-node02</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><ul>\n<li>requiredDuringSchedulingIgnoredDuringExecution：硬亲和力配置</li>\n<li>nodeSelectorTerms：节点选择器配置，可以配置多个 matchExpressions（满足其一即可）</li>\n<li>matchExpressions：matchExpressions 下可以配置多个 key、values（都需要满足），其中 values 可以配置多个（满足其一即可）</li>\n<li>operator：\n<ul>\n<li>IN 相当于 key = value 的形式，<strong>NotIn 相当于 key!=value 的形式 (反亲和力)</strong></li>\n<li>Exists: 节点存在 label 的 key 为指定的值即可，不能配置 values 字段</li>\n<li>DoesNotExist: 节点不存在 label 的 key 为指定的值即可，不能配置 values 字段</li>\n<li>Gt：大于 value 指定的值</li>\n<li>Lt：小于 value 指定的值</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"22-软亲和力preferred\"><a class=\"anchor\" href=\"#22-软亲和力preferred\">#</a> 2.2 软亲和力 preferred</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  replicas: <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        nodeAffinity:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            - weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              preference:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  - key: ssd</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                      - <span class=\"token string\">'true'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            - weight: <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              preference:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                  - key: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                      - k8s-master01</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><ul>\n<li>preferredDuringSchedulingIgnoredDuringExecution：软亲和力配置</li>\n<li>weight：软亲和力的权重，权重越高优先级越大，范围 1-100</li>\n<li>matchExpressions：matchExpressions 下可以配置多个 key、values（都需要满足），其中 values 可以配置多个（满足其一即可）</li>\n<li>operator：\n<ul>\n<li>IN 相当于 key = value 的形式，<strong>NotIn 相当于 key!=value 的形式 (反亲和力)</strong></li>\n<li>Exists: 节点存在 label 的 key 为指定的值即可，不能配置 values 字段</li>\n<li>DoesNotExist: 节点不存在 label 的 key 为指定的值即可，不能配置 values 字段</li>\n<li>Gt：大于 value 指定的值</li>\n<li>Lt：小于 value 指定的值</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"3-pod亲和力详解\"><a class=\"anchor\" href=\"#3-pod亲和力详解\">#</a> 3. Pod 亲和力详解</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:              </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAntiAffinity:   <span class=\"token comment\">#pod 硬反亲和力</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          - labelSelector:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              matchExpressions:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              - key: app</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                values:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                - nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        podAntiAffinity:       <span class=\"token comment\">#pod 软反亲和力</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          - weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            podAffinityTerm:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              labelSelector:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                - key: app</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                  operator: In</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                  values:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                  - nginx-deploy</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              namespaces:     <span class=\"token comment\">#和哪个命名空间的 Pod 进行匹配，为空为当前命名空间</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              - default</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              topologyKey: kubernetes.io/hostname</pre></td></tr></table></figure><ul>\n<li>\n<p>labelSelector：Pod 选择器配置，可以配置多个</p>\n</li>\n<li>\n<p>matchExpressions：matchExpressions 下可以配置多个 key、values（都需要满足），其中 values 可以配置多个（满足其一即可）</p>\n</li>\n<li>\n<p>topologyKey：匹配的拓扑域的 key，也就是节点上 label 的 key，key 和 value 相同的为同一个域，可以用于标注不同的机房和地区</p>\n</li>\n<li>\n<p>Namespaces: 和哪个命名空间的 Pod 进行匹配，为空为当前命名空间</p>\n</li>\n<li>\n<p>operator：配置和节点亲和力一致，但是没有 Gt 和 Lt</p>\n<ul>\n<li>\n<p>IN 相当于 key = value 的形式；</p>\n</li>\n<li>\n<p>Exists: 节点存在 label 的 key 为指定的值即可，不能配置 values 字段；</p>\n</li>\n<li>\n<p>DoesNotExist: 节点不存在 label 的 key 为指定的值即可，不能配置 values 字段</p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"4-节点亲和力配置示例\"><a class=\"anchor\" href=\"#4-节点亲和力配置示例\">#</a> 4. 节点亲和力配置示例</h4>\n<p>Pod 尽量部署在 ssd=true 和 type=physical 的节点上，但是优先部署在 ssd=true 的节点上，不能部署 label 为 gpu=true 的节点。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes k8s-node01 ssd=true</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes k8s-master01 ssd=true</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes k8s-master01 gpu=true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes k8s-node02 type=physical</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      annotations:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        nodeAffinity:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            - weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              preference:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                  - key: ssd</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                      - <span class=\"token string\">'true'</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                  - key: gpu</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    operator: NotIn</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                      - <span class=\"token string\">'true'</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            - weight: <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              preference:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                  - key: <span class=\"token builtin class-name\">type</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                      - physical</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>NAME                          READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>nginx-deploy-7d65fbdf-2b4jr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.85.236   k8s-node01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>nginx-deploy-7d65fbdf-jjzwr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.58.251   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>nginx-deploy-7d65fbdf-kx5lm   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.85.237   k8s-node01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>nginx-deploy-7d65fbdf-lrmcg   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.85.238   k8s-node01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>nginx-deploy-7d65fbdf-n6mlp   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.58.250   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><h4 id=\"5-pod亲和力-反亲和力配置示例\"><a class=\"anchor\" href=\"#5-pod亲和力-反亲和力配置示例\">#</a> 5. Pod 亲和力、反亲和力配置示例</h4>\n<h5 id=\"51-pod反亲和力required\"><a class=\"anchor\" href=\"#51-pod反亲和力required\">#</a> 5.1 Pod 反亲和力 required</h5>\n<p>同一个应用部署在不同的宿主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 节点存在污点 pod 无法调度至该节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl describe nodes|grep -i taint</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2.pod 反亲和力 required</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                      - nginx-deploy</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token comment\">#3. 部署 deployment</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>NAME                            READY   STATUS    RESTARTS   AGE   IP               NODE           NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>nginx-deploy-5787887b6f-4654b   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.85.234    k8s-node01     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>nginx-deploy-5787887b6f-8mq7s   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.122.152   k8s-master02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>nginx-deploy-5787887b6f-fdkft   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.58.247    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>nginx-deploy-5787887b6f-jzcmd   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.32.152    k8s-master01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>nginx-deploy-5787887b6f-qdq9g   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.195.14    k8s-master03   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token comment\">#4. 将副本扩成 6 个，由于 K8s 集群只有 5 个节点，即 5 个 topologyKey（拓扑域），每个域只能有一个副本，所以有一个 pod 会 pending</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl scale deploy nginx-deploy --replicas=6 </span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>NAME                            READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>nginx-deploy-5787887b6f-4654b   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.85.234    k8s-node01     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>nginx-deploy-5787887b6f-8mq7s   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.122.152   k8s-master02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>nginx-deploy-5787887b6f-fdkft   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.58.247    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>nginx-deploy-5787887b6f-jzcmd   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.32.152    k8s-master01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>nginx-deploy-5787887b6f-qdq9g   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.195.14    k8s-master03   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>nginx-deploy-5787887b6f-sztm7   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          9s      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pods nginx-deploy-5787887b6f-sztm7</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>Events:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  Type     Reason            Age   From               Message</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  ----     ------            ----  ----               -------</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  Warning  FailedScheduling  102s  default-scheduler  <span class=\"token number\">0</span>/5 nodes are available: <span class=\"token number\">5</span> node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn't match pod anti-affinity rules. preemption: <span class=\"token number\">0</span>/5 nodes are available: <span class=\"token number\">5</span> No preemption victims found <span class=\"token keyword\">for</span> incoming pod.</pre></td></tr></table></figure><p><strong>将副本扩成 6 个，有一个会 pending 状态，原因 K8s 集群只有 5 个节点，即 5 个 topologyKey（拓扑域），每个拓扑域只能有一个副本，所以有一个 pod 会 pending。</strong></p>\n<p><strong>topologyKey：匹配的拓扑域的 key，也就是节点上 label 的 key，key 和 value 相同的为同一个域，可以用于标注不同的机房和地区</strong>。</p>\n<h5 id=\"52-pod反亲和力preferred\"><a class=\"anchor\" href=\"#52-pod反亲和力preferred\">#</a> 5.2 Pod 反亲和力 preferred</h5>\n<p>同一个应用尽量部署在不同的宿主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 节点存在污点 pod 无法调度至该节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl describe nodes|grep -i taint</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2.pod 反亲和力 preferred</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  replicas: <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            - podAffinityTerm:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                labelSelector:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                  matchExpressions:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    - key: app</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                      operator: In</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                      values:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                        - nginx-deploy</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token comment\">#3. 部署 deployment</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>NAME                            READY   STATUS    RESTARTS   AGE   IP               NODE           NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>nginx-deploy-7c47567b79-97qs5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.122.153   k8s-master02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>nginx-deploy-7c47567b79-g49h4   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.85.235    k8s-node01     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>nginx-deploy-7c47567b79-g5n2s   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.58.248    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>nginx-deploy-7c47567b79-g5v5b   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.195.15    k8s-master03   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>nginx-deploy-7c47567b79-pjwws   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.58.249    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>nginx-deploy-7c47567b79-q2hn5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.32.153    k8s-master01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><h5 id=\"53-pod亲和力required\"><a class=\"anchor\" href=\"#53-pod亲和力required\">#</a> 5.3 Pod 亲和力 required</h5>\n<p>同一个应用必须部署在同一个宿主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:              </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAffinity:   <span class=\"token comment\">#pod 硬亲和力</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          - labelSelector:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              matchExpressions:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              - key: app</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                values:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                - nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>NAME                           READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>nginx-deploy-dbcc4d65c-2sthn   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.255   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>nginx-deploy-dbcc4d65c-78nxf   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.197   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>nginx-deploy-dbcc4d65c-82ssq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.194   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>nginx-deploy-dbcc4d65c-986cb   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.254   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>nginx-deploy-dbcc4d65c-9rnt7   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.252   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>nginx-deploy-dbcc4d65c-knm8q   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.195   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>nginx-deploy-dbcc4d65c-kx56f   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.253   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>nginx-deploy-dbcc4d65c-sqlhf   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.198   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><h5 id=\"54-pod亲和力preferre\"><a class=\"anchor\" href=\"#54-pod亲和力preferre\">#</a> 5.4 Pod 亲和力 preferre</h5>\n<p>同一个应用尽量部署在同一个宿主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:              </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAffinity:       <span class=\"token comment\">#pod 软亲和力</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          - weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            podAffinityTerm:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              labelSelector:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                - key: app</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                  operator: In</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                  values:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                  - nginx-deploy</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              namespaces:     <span class=\"token comment\">#和哪个命名空间的 Pod 进行匹配，为空为当前命名空间</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              - default</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          type: File</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3254599477.html",
            "url": "http://ixuyong.cn/posts/3254599477.html",
            "title": "K8s容忍和污点",
            "date_published": "2025-04-20T07:51:58.000Z",
            "content_html": "<h3 id=\"k8s容忍和污点\"><a class=\"anchor\" href=\"#k8s容忍和污点\">#</a> K8s 容忍和污点</h3>\n<p>Taint 指定服务器上打上污点，让不能容忍这个污点的 Pod 不能部署在打了污点的服务器上。Toleration 是让 Pod 容忍节点上配置的污点，可以让一些需要特殊配置的 Pod 能够调用到具有污点和特殊配置的节点上。</p>\n<h4 id=\"1-taint配置解析\"><a class=\"anchor\" href=\"#1-taint配置解析\">#</a> 1. Taint 配置解析</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.Taint 语法</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes NODE_NAME TAINT_KEY=TAINT_VALUE:EFFECT</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 创建 Taint 示例</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd=true:PreferNoSchedule</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3. 查看污点</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># kubectl describe node k8s-node01 | grep Taints -A 10</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4. 删除污点</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd-                   #基于 Key 删除</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd:PreferNoSchedule-  #基于 Key+Effect 删除</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#5. 修改污点（Key 和 Effect 相同）</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd=true:PreferNoSchedule --overwrite</span></pre></td></tr></table></figure><p>EFFECT 排斥等级：</p>\n<ul>\n<li>NoSchedule：禁止调度到该节点，已经在该节点上的 Pod 不受影响</li>\n<li>NoExecute：禁止调度到该节点，如果不符合这个污点，会立马被驱逐（或在一段时间后）</li>\n<li>PreferNoSchedule：尽量避免将 Pod 调度到指定的节点上，如果没有更合适的节点，可以部署到该节点</li>\n</ul>\n<h4 id=\"2toleration配置解析\"><a class=\"anchor\" href=\"#2toleration配置解析\">#</a> 2.Toleration 配置解析</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 完全匹配</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>tolerations:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>- key: <span class=\"token string\">\"taintKey\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  operator: <span class=\"token string\">\"Equal\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  value: <span class=\"token string\">\"taintValue\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  effect: <span class=\"token string\">\"NoSchedule</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>#2.不完全匹配 </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>tolerations:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>- key: \"</span>taintKey<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  operator: \"</span>Exists<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  effect: \"</span>NoSchedule<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>#3.大范围匹配（不推荐key为内置Taint，会导致节点故障pod无法漂移）</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>tolerations:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>- key: \"</span>taintKey<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  operator: \"</span>Exists</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#4. 容忍时间配置</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>tolerations:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>- key: <span class=\"token string\">\"key1\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  operator: <span class=\"token string\">\"Equal\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  value: <span class=\"token string\">\"value1\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  effect: <span class=\"token string\">\"NoExecute\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  tolerationSeconds: <span class=\"token number\">3600</span></pre></td></tr></table></figure><h4 id=\"3-taint-toleration配置示例\"><a class=\"anchor\" href=\"#3-taint-toleration配置示例\">#</a> 3. Taint、Toleration 配置示例</h4>\n<p>有一个 K8s 节点是纯 SSD 硬盘的节点，现需要只有一些需要高性能存储的 Pod 才能调度到该节点上。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 给节点打上污点和标签</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd=true:PreferNoSchedule</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl label node k8s-node01 ssd=true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#2. 配置 Toleration：</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      nodeSelector:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        ssd: <span class=\"token string\">'true'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      tolerations:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - key: ssd</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          operator: Exists</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          effect: NoSchedule</pre></td></tr></table></figure><h4 id=\"4-k8s内置污点\"><a class=\"anchor\" href=\"#4-k8s内置污点\">#</a> 4. K8s 内置污点</h4>\n<ul>\n<li><a href=\"http://node.kubernetes.io/not-ready%EF%BC%9A%E8%8A%82%E7%82%B9%E6%9C%AA%E5%87%86%E5%A4%87%E5%A5%BD%EF%BC%8C%E7%9B%B8%E5%BD%93%E4%BA%8E%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81Ready%E7%9A%84%E5%80%BC%E4%B8%BAFalse%E3%80%82\">node.kubernetes.io/not-ready：节点未准备好，相当于节点状态 Ready 的值为 False。</a></li>\n<li><a href=\"http://node.kubernetes.io/unreachable%EF%BC%9ANode\">node.kubernetes.io/unreachable：Node</a> Controller 访问不到节点，相当于节点状态 Ready 的值为 Unknown。</li>\n<li><a href=\"http://node.kubernetes.io/out-of-disk%EF%BC%9A%E8%8A%82%E7%82%B9%E7%A3%81%E7%9B%98%E8%80%97%E5%B0%BD%E3%80%82\">node.kubernetes.io/out-of-disk：节点磁盘耗尽。</a></li>\n<li><a href=\"http://node.kubernetes.io/memory-pressure%EF%BC%9A%E8%8A%82%E7%82%B9%E5%AD%98%E5%9C%A8%E5%86%85%E5%AD%98%E5%8E%8B%E5%8A%9B%E3%80%82\">node.kubernetes.io/memory-pressure：节点存在内存压力。</a></li>\n<li><a href=\"http://node.kubernetes.io/disk-pressure%EF%BC%9A%E8%8A%82%E7%82%B9%E5%AD%98%E5%9C%A8%E7%A3%81%E7%9B%98%E5%8E%8B%E5%8A%9B%E3%80%82\">node.kubernetes.io/disk-pressure：节点存在磁盘压力。</a></li>\n<li><a href=\"http://node.kubernetes.io/network-unavailable%EF%BC%9A%E8%8A%82%E7%82%B9%E7%BD%91%E7%BB%9C%E4%B8%8D%E5%8F%AF%E8%BE%BE%E3%80%82\">node.kubernetes.io/network-unavailable：节点网络不可达。</a></li>\n<li><a href=\"http://node.kubernetes.io/unschedulable%EF%BC%9A%E8%8A%82%E7%82%B9%E4%B8%8D%E5%8F%AF%E8%B0%83%E5%BA%A6%E3%80%82\">node.kubernetes.io/unschedulable：节点不可调度。</a></li>\n<li><a href=\"http://node.cloudprovider.kubernetes.io/uninitialized%EF%BC%9A%E5%A6%82%E6%9E%9CKubelet%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8C%87%E5%AE%9A%E4%BA%86%E4%B8%80%E4%B8%AA%E5%A4%96%E9%83%A8%E7%9A%84cloudprovider%EF%BC%8C%E5%AE%83%E5%B0%86%E7%BB%99%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AATaint%E5%B0%86%E5%85%B6%E6%A0%87%E8%AE%B0%E4%B8%BA%E4%B8%8D%E5%8F%AF%E7%94%A8%E3%80%82%E5%9C%A8cloud-controller-manager%E7%9A%84%E4%B8%80%E4%B8%AAcontroller%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%99%E4%B8%AA%E8%8A%82%E7%82%B9%E5%90%8E%EF%BC%8CKubelet%E5%B0%86%E5%88%A0%E9%99%A4%E8%BF%99%E4%B8%AATaint%E3%80%82\">node.cloudprovider.kubernetes.io/uninitialized：如果 Kubelet 启动时指定了一个外部的 cloudprovider，它将给当前节点添加一个 Taint 将其标记为不可用。在 cloud-controller-manager 的一个 controller 初始化这个节点后，Kubelet 将删除这个 Taint。</a></li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/vO7kURL.png\" alt=\"1.png\" /></p>\n<p>Deployment 创建后 K8s 默认为 Pod 添加容忍，当 Pod 所在的节点宕机，300 秒后 pod 会漂移，默认容忍时间 300 秒。</p>\n<h4 id=\"5节点宕机快速恢复业务应用\"><a class=\"anchor\" href=\"#5节点宕机快速恢复业务应用\">#</a> 5. 节点宕机快速恢复业务应用</h4>\n<p>节点不健康，180 秒后再驱逐（默认是 300 秒）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      tolerations:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - key: node.kubernetes.io/unreachable</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          operator: Exists</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          effect: NoExecute</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          tolerationSeconds: <span class=\"token number\">180</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - key: node.kubernetes.io/not-ready</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          operator: Exists</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          effect: NoExecute</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          tolerationSeconds: <span class=\"token number\">180</span></pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3142072607.html",
            "url": "http://ixuyong.cn/posts/3142072607.html",
            "title": "K8s初始化容器、临时容器",
            "date_published": "2025-04-19T13:07:20.000Z",
            "content_html": "<h3 id=\"k8s初始化容器-临时容器\"><a class=\"anchor\" href=\"#k8s初始化容器-临时容器\">#</a> K8s 初始化容器、临时容器</h3>\n<h4 id=\"1-初始化容器\"><a class=\"anchor\" href=\"#1-初始化容器\">#</a> 1. 初始化容器</h4>\n<h5 id=\"1-1-初始化容器的用途\"><a class=\"anchor\" href=\"#1-1-初始化容器的用途\">#</a> 1. 1 初始化容器的用途</h5>\n<p>初始化容器主要是在主应用启动之前，做一些初始化的操作，比如创建文件、修改内核参数、等待依赖程序启动或其他需要在主程序启动之前需要做的工作。</p>\n<ul>\n<li>Init 容器可以包含一些安装过程中应用容器中不存在的实用工具或个性化代码；</li>\n<li>Init 容器可以安全地运行这些工具，避免这些工具导致应用镜像的安全性降低；</li>\n<li>Init 容器可以以 root 身份运行，执行一些高权限命令；</li>\n<li>Init 容器相关操作执行完成以后即退出，不会给业务容器带来安全隐患。</li>\n</ul>\n<h5 id=\"12-初始化容器和poststart区别\"><a class=\"anchor\" href=\"#12-初始化容器和poststart区别\">#</a> 1.2 初始化容器和 PostStart 区别</h5>\n<p>PostStart：依赖主应用的环境，而且并不一定先于 Command 运行。</p>\n<p>InitContainer：不依赖主应用的环境，可以有更高的权限和更多的工具，一定会在主应用启动之前完成</p>\n<h5 id=\"13-初始化容器和普通容器的区别\"><a class=\"anchor\" href=\"#13-初始化容器和普通容器的区别\">#</a> 1.3 初始化容器和普通容器的区别</h5>\n<p>Init 容器与普通的容器非常像，除了如下几点：</p>\n<ul>\n<li>\n<p>第一个 Init 容器运行成功后才会运行下一个 Init 容器；</p>\n</li>\n<li>\n<p>所有的 Init 容器运行成功后才会运行主容器；</p>\n</li>\n<li>\n<p>如果 Pod 的 Init 容器失败，Kubernetes 会不断地重启该 Pod，直到 Init 容器成功为止，但是 Pod 对应的 restartPolicy 值为 Never，Kubernetes 不会重新启动 Pod。</p>\n</li>\n<li>\n<p>Init 容器不支持 lifecycle、livenessProbe、readinessProbe 和 startupProbe</p>\n</li>\n</ul>\n<h5 id=\"14-初始化容器示例\"><a class=\"anchor\" href=\"#14-初始化容器示例\">#</a> 1.4 初始化容器示例</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat init.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      initContainers:           <span class=\"token comment\"># 初始化容器设定</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: fix-permissions</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        image: busybox</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span>,<span class=\"token string\">\"-c\"</span>,<span class=\"token string\">\"echo hello kubernetes>/usr/share/nginx/html/index.html\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          privileged: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - name: share-volume</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: share-volume</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      - name: share-volume</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f init.yaml</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 172.16.32.145</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>hello kubernetes</pre></td></tr></table></figure><h4 id=\"2-临时容器\"><a class=\"anchor\" href=\"#2-临时容器\">#</a> 2. 临时容器</h4>\n<h5 id=\"21-注入临时容器到pod\"><a class=\"anchor\" href=\"#21-注入临时容器到pod\">#</a> 2.1 注入临时容器到 Pod</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                            READY   STATUS    RESTARTS      AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-deploy-7dd6cd4b44-ktw5k   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">1</span>             16h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-deploy-7dd6cd4b44-mjcgq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>28m ago<span class=\"token punctuation\">)</span>   16h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-deploy-7dd6cd4b44-wdm6p   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>28m ago<span class=\"token punctuation\">)</span>   16h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#1. 进入容器发现 pod 没有 ps 和 netstat 命令</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it nginx-deploy-7dd6cd4b44-ktw5k  -- bash</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>root@nginx-deploy-7dd6cd4b44-ktw5k:/<span class=\"token comment\"># ps aux</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@nginx-deploy-7dd6cd4b44-ktw5k:/<span class=\"token comment\"># netstat -lntp</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#2. 注入临时容器至该 Pod</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl debug nginx-deploy-7dd6cd4b44-wdm6p -ti --image=registry.cn-hangzhou.aliyuncs.com/old_xu/debug-tools</span></pre></td></tr></table></figure><h5 id=\"21-注入临时容器到节点\"><a class=\"anchor\" href=\"#21-注入临时容器到节点\">#</a> 2.1 注入临时容器到节点</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl debug <span class=\"token function\">node</span> k8s-node01 <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--image</span><span class=\"token operator\">=</span>registry.cn-hangzhou.aliyuncs.com/old_xu/debug-tools</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3833778957.html",
            "url": "http://ixuyong.cn/posts/3833778957.html",
            "title": "K8s计划任务Job、Cronjob",
            "date_published": "2025-04-19T13:00:21.000Z",
            "content_html": "<h3 id=\"k8s计划任务job-cronjob\"><a class=\"anchor\" href=\"#k8s计划任务job-cronjob\">#</a> K8s 计划任务 Job、Cronjob</h3>\n<h4 id=\"1-job配置参数详解\"><a class=\"anchor\" href=\"#1-job配置参数详解\">#</a> 1. Job 配置参数详解</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat job.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: batch/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Job</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    job-name: <span class=\"token builtin class-name\">echo</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: <span class=\"token builtin class-name\">echo</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">#suspend: true # 1.21+</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">#ttlSecondsAfterFinished: 100</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  backoffLimit: <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  completions: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  parallelism: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: <span class=\"token builtin class-name\">echo</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        image: busybox</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token parameter variable\">-c</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Hello Job\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      restartPolicy: Never</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get jobs</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>NAME   STATUS     COMPLETIONS   DURATION   AGE</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token builtin class-name\">echo</span>   Complete   <span class=\"token number\">1</span>/1           70s        2m5s</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>NAME          READY   STATUS      RESTARTS      AGE</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>echo-564c8    <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>             2m10s</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl logs echo-564c8</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>Hello Job</pre></td></tr></table></figure><ul>\n<li>backoffLimit:：如果任务执行失败，失败多少次后不再执行</li>\n<li>completions：有多少个 Pod 执行成功，认为任务是成功的，默认为空和 parallelism 数值一样</li>\n<li>parallelism：并行执行任务的数量，如果 parallelism 数值大于 completions 数值，只会创建 completions 的数量；如果 completions 是 4，并发是 3，第一次会创建 3 个 Pod 执行任务，第二次只会创建一个 Pod 执行任务</li>\n<li>ttlSecondsAfterFinished：Job 在执行结束之后（状态为 completed 或 Failed）自动清理。设置为 0 表示执行结束立即删除，不设置则不会清除，需要开启 TTLAfterFinished 特性</li>\n</ul>\n<h4 id=\"2-cronjob配置参数详解\"><a class=\"anchor\" href=\"#2-cronjob配置参数详解\">#</a> 2. CronJob 配置参数详解</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat cronjob.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: batch/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: CronJob</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: hello</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  schedule: <span class=\"token string\">\"*/1 * * * *\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  concurrencyPolicy: Allow   <span class=\"token comment\">#允许同时运行多个任务</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  failedJobsHistoryLimit: <span class=\"token number\">10</span>  <span class=\"token comment\">#保留多少失败的任务</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  successfulJobsHistoryLimit: <span class=\"token number\">10</span>  <span class=\"token comment\">#保留多少已完成的任务</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">#suspend: true             #如果 true 则取消周期性执行任务</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  jobTemplate:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          - name: hello</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            image: busybox</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            command:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            - <span class=\"token parameter variable\">-c</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            - <span class=\"token function\">date</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">echo</span> Hello from the Kubernetes cluster</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          restartPolicy: OnFailure </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get  cj</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>NAME    SCHEDULE      TIMEZONE   SUSPEND   ACTIVE   LAST SCHEDULE   AGE</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>hello   */1 * * * *   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>     False     <span class=\"token number\">0</span>        6s              81s</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get  jobs</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>NAME             STATUS     COMPLETIONS   DURATION   AGE</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>hello-29084454   Complete   <span class=\"token number\">1</span>/1           4s         72s</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>hello-29084455   Complete   <span class=\"token number\">1</span>/1           5s         12s</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get  pods</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>NAME                   READY   STATUS      RESTARTS   AGE</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>hello-29084454-hwv7p   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          78s</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>hello-29084455-vf99w   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          18s</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl logs -f hello-29084455-vf99w</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>Sat Apr <span class=\"token number\">19</span> <span class=\"token number\">12</span>:55:02 UTC <span class=\"token number\">2025</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Hello from the Kubernetes cluster</pre></td></tr></table></figure><ul>\n<li>apiVersion: batch/v1beta1   #1.21+ batch/v1</li>\n<li>schedule：调度周期，和 Linux 一致，分别是分时日月周。</li>\n<li>restartPolicy：重启策略，和 Pod 一致。</li>\n<li>concurrencyPolicy：并发调度策略。可选参数如下：\n<ul>\n<li>Allow：允许同时运行多个任务。</li>\n<li>Forbid：不允许并发运行，如果之前的任务尚未完成，新的任务不会被创建。</li>\n<li>Replace：如果之前的任务尚未完成，新的任务会替换的之前的任务。</li>\n</ul>\n</li>\n<li>suspend：如果设置为 true，则暂停后续的任务，默认为 false。</li>\n<li>successfulJobsHistoryLimit：保留多少已完成的任务，按需配置。</li>\n<li>failedJobsHistoryLimit：保留多少失败的任务。</li>\n</ul>\n<p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/169153047.html",
            "url": "http://ixuyong.cn/posts/169153047.html",
            "title": "K8s持久化存储",
            "date_published": "2025-04-18T14:25:17.000Z",
            "content_html": "<h3 id=\"k8s持久化存储\"><a class=\"anchor\" href=\"#k8s持久化存储\">#</a> K8s 持久化存储</h3>\n<h4 id=\"1-volume\"><a class=\"anchor\" href=\"#1-volume\">#</a> 1. Volume</h4>\n<p>Container（容器）中的磁盘文件是短暂的，当容器崩溃时，kubelet 会重新启动容器，Container 会以最干净的状态启动，最初的文件将丢失。另外，当一个 Pod 运行多个 Container 时，各个容器可能需要共享一些文件。Kubernetes Volume 可以解决这两个问题。</p>\n<ul>\n<li>一些需要持久化数据的程序才会用到 Volumes，或者一些需要共享数据的容器需要 volumes。</li>\n<li>日志收集的需求需要在应用程序的容器里面加一个 sidecar，这个容器是一个收集日志的容器，比如 filebeat，它通过 volumes 共享应用程序的日志文件目录。</li>\n</ul>\n<h5 id=\"11-emptydir实现数据共享\"><a class=\"anchor\" href=\"#11-emptydir实现数据共享\">#</a> 1.1 EmptyDir 实现数据共享</h5>\n<p>和上述 volume 不同的是，如果删除 Pod，emptyDir 卷中的数据也将被删除，一般 emptyDir 卷用于 Pod 中的不同 Container 共享数据。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - name: share-volume</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: nginx</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            - name: share-volume</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>              mountPath: /opt</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: nginx2</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          command:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            - <span class=\"token string\">'-c'</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            - <span class=\"token function\">sleep</span> <span class=\"token number\">3600</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            - name: share-volume</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>              mountPath: /mnt</pre></td></tr></table></figure><h5 id=\"12-volumes-hostpath挂载宿主机路径\"><a class=\"anchor\" href=\"#12-volumes-hostpath挂载宿主机路径\">#</a> 1.2 Volumes HostPath 挂载宿主机路径</h5>\n<p>hostPath 卷可将节点上的文件或目录挂载到 Pod 上，用于 Pod 自定义日志输出或访问 Docker 内部的容器等。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: share-volume</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - name: nginx</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          - name: share-volume</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            mountPath: /opt</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: nginx2</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          command:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            - <span class=\"token string\">'-c'</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            - <span class=\"token function\">sleep</span> <span class=\"token number\">3600</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          - name: share-volume</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            mountPath: /mnt</pre></td></tr></table></figure><p>hostPath 卷常用的 type（类型）如下：</p>\n<ul>\n<li>type 为空字符串：默认选项，意味着挂载 hostPath 卷之前不会执行任何检查。</li>\n<li>DirectoryOrCreate：如果给定的 path 不存在任何东西，那么将根据需要创建一个权限为 0755 的空目录，和 Kubelet 具有相同的组和权限。</li>\n<li>Directory：目录必须存在于给定的路径下。</li>\n<li>FileOrCreate：如果给定的路径不存储任何内容，则会根据需要创建一个空文件，权限设置为 0644，和 Kubelet 具有相同的组和所有权。</li>\n<li>File：文件，必须存在于给定路径中。</li>\n<li>Socket：UNIX 套接字，必须存在于给定路径中。</li>\n<li>CharDevice：字符设备，必须存在于给定路径中。</li>\n<li>BlockDevice：块设备，必须存在于给定路径中。</li>\n</ul>\n<h5 id=\"13-挂载nfs至容器\"><a class=\"anchor\" href=\"#13-挂载nfs至容器\">#</a> 1.3 挂载 NFS 至容器</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 安装 nfs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># yum install nfs-utils -y       </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># mkdir /data/nfs -p</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># vim /etc/exports </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/data <span class=\"token number\">192.168</span>.1.0/24<span class=\"token punctuation\">(</span>rw,no_root_squash<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># exportfs -arv   </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># systemctl start nfs-server &amp;&amp; systemctl enable nfs-server &amp;&amp; systemctl status nfs-server </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2. 测试客户端挂载</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># showmount -e 192.168.1.75</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># mount -t nfs 192.168.1.75:/data/nfs /mnt</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#3.Deploy 挂载 NFS</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy-nfs.yaml </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      annotations:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      - name: nfs-volume</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        nfs:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          path: /data/nfs</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          - name: nfs-volume</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr></table></figure><h4 id=\"2-pv-pvc\"><a class=\"anchor\" href=\"#2-pv-pvc\">#</a> 2. PV、PVC</h4>\n<p>PersistentVolume：简称 PV，是由 Kubernetes 管理员设置的存储，可以配置 Ceph、NFS、GlusterFS 等常用存储配置，相对于 Volume 配置，提供了更多的功能，比如生命周期的管理、大小的限制。PV 分为静态和动态。</p>\n<p>PersistentVolumeClaim：简称 PVC，是对存储 PV 的请求，表示需要什么类型的 PV，需要存储的技术人员只需要配置 PVC 即可使用存储，或者 Volume 配置 PVC 的名称即可。</p>\n<h5 id=\"21-pv回收策略\"><a class=\"anchor\" href=\"#21-pv回收策略\">#</a> 2.1 PV 回收策略</h5>\n<ul>\n<li>Retain：保留，该策略允许手动回收资源，当删除 PVC 时，PV 仍然存在，PV 被视为已释放，管理员可以手动回收卷。</li>\n<li>Recycle：回收，如果 Volume 插件支持，Recycle 策略会对卷执行 rm -rf 清理该 PV，并使其可用于下一个新的 PVC，但是本策略将来会被弃用，目前只有 NFS 和 HostPath 支持该策略。</li>\n<li>Delete：删除，如果 Volume 插件支持，删除 PVC 时会同时删除 PV，动态卷默认为 Delete，目前支持 Delete 的存储后端包括 AWS EBS, GCE PD, Azure Disk, or OpenStack Cinder 等。</li>\n<li>可以通过 persistentVolumeReclaimPolicy: Recycle 字段配置</li>\n</ul>\n<h5 id=\"22-pv访问策略\"><a class=\"anchor\" href=\"#22-pv访问策略\">#</a> 2.2 PV 访问策略</h5>\n<ul>\n<li>ReadWriteOnce：可以被单节点以读写模式挂载，命令行中可以被缩写为 RWO。</li>\n<li>ReadOnlyMany：可以被多个节点以只读模式挂载，命令行中可以被缩写为 ROX。</li>\n<li>ReadWriteMany：可以被多个节点以读写模式挂载，命令行中可以被缩写为 RWX。</li>\n<li>ReadWriteOncePod ：只允许被单个 Pod 访问，需要 K8s 1.22 + 以上版本，并且是 CSI 创建的 PV 才可使用，缩写为 RWOP</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">Volume Plugin</th>\n<th style=\"text-align:center\">ReadWriteOnce</th>\n<th style=\"text-align:center\">ReadOnlyMany</th>\n<th style=\"text-align:center\">ReadWriteMany</th>\n<th style=\"text-align:center\">ReadWriteOncePod</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">AzureFile</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CephFS</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CSI</td>\n<td style=\"text-align:center\">depends on the driver</td>\n<td style=\"text-align:center\">depends on the driver</td>\n<td style=\"text-align:center\">depends on the driver</td>\n<td style=\"text-align:center\">depends on the driver</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">FC</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">FlexVolume</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">depends on the driver</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">HostPath</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">iSCSI</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">NFS</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RBD</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">VsphereVolume</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">- (works when Pods are collocated)</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PortworxVolume</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"23-存储分类\"><a class=\"anchor\" href=\"#23-存储分类\">#</a> 2.3 存储分类</h5>\n<ul>\n<li>文件存储：一些数据可能需要被多个节点使用，比如用户的头像、用户上传的文件等，实现方式：NFS、NAS、FTP、CephFS 等。</li>\n<li>块存储：一些数据只能被一个节点使用，或者是需要将一块裸盘整个挂载使用，比如数据库、Redis 等，实现方式：Ceph、GlusterFS、公有云。</li>\n<li>对象存储：由程序代码直接实现的一种存储方式，云原生应用无状态化常用的实现方式，实现方式：一般是符合 S3 协议的云存储，比如 AWS 的 S3 存储、Minio、七牛云等。</li>\n</ul>\n<h5 id=\"24-pv配置示例nfs\"><a class=\"anchor\" href=\"#24-pv配置示例nfs\">#</a> 2.4 PV 配置示例 NFS</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: PersistentVolume</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nfs-pv1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  capacity:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    storage: 5Gi</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  volumeMode: Filesystem</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  persistentVolumeReclaimPolicy: Retain</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  storageClassName: nfs-slow</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    path: /data/pv1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr></table></figure><p>capacity：容量配置</p>\n<p>volumeMode：卷的模式，目前支持 Filesystem（文件系统） 和 Block（块），其中 Block 类型需要后端存储支持，默认为文件系统</p>\n<p>accessModes：该 PV 的访问模式</p>\n<p>storageClassName：PV 的类，一个特定类型的 PV 只能绑定到特定类别的 PVC；</p>\n<p>persistentVolumeReclaimPolicy：回收策略</p>\n<p>mountOptions：非必须，新版本中已弃用</p>\n<p>nfs：NFS 服务配置，包括以下两个选项</p>\n<ul>\n<li>path：NFS 上的共享目录</li>\n<li>server：NFS 的 IP 地址</li>\n</ul>\n<h5 id=\"25-pv配置示例hostpath\"><a class=\"anchor\" href=\"#25-pv配置示例hostpath\">#</a> 2.5 PV 配置示例 HostPath</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: PersistentVolume</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: hostpath</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  capacity:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    storage: 5Gi</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  volumeMode: Filesystem</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  persistentVolumeReclaimPolicy: Retain</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  storageClassName: hostpath</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  hostPath:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    path: <span class=\"token string\">\"/mnt/data\"</span></pre></td></tr></table></figure><p>hostPath：hostPath 服务配置</p>\n<ul>\n<li>path：宿主机路径</li>\n</ul>\n<h5 id=\"26-pv的状态\"><a class=\"anchor\" href=\"#26-pv的状态\">#</a> 2.6 PV 的状态</h5>\n<ul>\n<li>Available：可用，没有被 PVC 绑定的空闲资源。</li>\n<li>Bound：已绑定，已经被 PVC 绑定。</li>\n<li>Released：已释放，PVC 被删除，但是资源还未被重新使用。</li>\n<li>Failed：失败，自动回收失败。</li>\n</ul>\n<h5 id=\"27-pvc绑定pv\"><a class=\"anchor\" href=\"#27-pvc绑定pv\">#</a> 2.7 PVC 绑定 PV</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nfs-pvc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  storageClassName: nfs-slow</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      storage: 5Gi</pre></td></tr></table></figure><ul>\n<li>PVC 的空间申请大小≤PV 的大小</li>\n<li>PVC 的 StorageClassName 和 PV 的一致</li>\n<li>PVC 的 accessModes 和 PV 的一致</li>\n</ul>\n<h5 id=\"28-depoyment挂载pvc\"><a class=\"anchor\" href=\"#28-depoyment挂载pvc\">#</a> 2.8 Depoyment 挂载 PVC</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: nfs-pvc-storage  <span class=\"token comment\">#volume 名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          claimName: nfs-pvc   <span class=\"token comment\">#PVC 名称</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>         - name: nfs-pvc-storage</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr></table></figure><p>挂载 PVC 的 Pod 一直处于 Pending：</p>\n<ul>\n<li>PVC 没有创建成功或 PVC 不存在</li>\n<li>PVC 和 Pod 不在同一个 Namespace</li>\n</ul>\n<p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3992668367.html",
            "url": "http://ixuyong.cn/posts/3992668367.html",
            "title": "K8s配置管理Configmap",
            "date_published": "2025-04-14T13:47:47.000Z",
            "content_html": "<h3 id=\"k8s配置管理configmap\"><a class=\"anchor\" href=\"#k8s配置管理configmap\">#</a> K8s 配置管理 Configmap</h3>\n<h4 id=\"1-configmap\"><a class=\"anchor\" href=\"#1-configmap\">#</a> 1. Configmap</h4>\n<h5 id=\"1-1-基于from-env-file创建configmap\"><a class=\"anchor\" href=\"#1-1-基于from-env-file创建configmap\">#</a> 1. 1 基于 from-env-file 创建 Configmap</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat cm_env.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">podname</span><span class=\"token operator\">=</span>nf-flms-system</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">podip</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.100</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">env</span><span class=\"token operator\">=</span>prod</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">nacosaddr</span><span class=\"token operator\">=</span>nacos.svc.cluster.local</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#kubectl create cm cmenv --from-env-file=./cm_env.conf</span></pre></td></tr></table></figure><h5 id=\"12-基于from-literal创建configmap\"><a class=\"anchor\" href=\"#12-基于from-literal创建configmap\">#</a> 1.2 基于 from-literal 创建 Configmap</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create cm cmliteral --from-literal=level=INFO --from-literal=passwd=Superman*2023</span></pre></td></tr></table></figure><h5 id=\"13-基于from-file创建configmap\"><a class=\"anchor\" href=\"#13-基于from-file创建configmap\">#</a> 1.3 基于 from-file 创建 Configmap</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat s.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    server_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    client_max_body_size 1G<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        proxy_pass http://192.168.1.134<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        proxy_connect_timeout <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        proxy_read_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span>\t\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    server_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># kubectl create cm nginxconfig --from-file=./s.hmallleasing.com.conf</span></pre></td></tr></table></figure><h5 id=\"14-deployment挂载configmap示例\"><a class=\"anchor\" href=\"#14-deployment挂载configmap示例\">#</a> 1.4 Deployment 挂载 configmap 示例</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        envFrom:         <span class=\"token comment\"># 1. 批量挂载 ConfigMap 生成环境变量</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - configMapRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            name: cmenv</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: MYSQL_ADDR     <span class=\"token comment\"># 2. 自定义环境变量</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          value: <span class=\"token string\">\"192.168.40.150\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: MYSQL_PASSWD</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          value: Superman*2022</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: LOG_LEVEL           <span class=\"token comment\"># 3. 挂载单个 ConfigMap 生成环境变量，这里和 ConfigMap 中的键名是不一样的     </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              name: cmliteral       <span class=\"token comment\"># 这个值来自 ConfigMap</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: level            <span class=\"token comment\"># 来自 ConfigMap 的 key</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:              </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: nginx-config</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: <span class=\"token string\">\"/etc/nginx/conf.d\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      - name: nginx-config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          name: nginxconfig      <span class=\"token comment\"># 提供你想要挂载的 ConfigMap 的名字</span></pre></td></tr></table></figure><h5 id=\"15-重命名挂载的configmaq-key的名称\"><a class=\"anchor\" href=\"#15-重命名挂载的configmaq-key的名称\">#</a> 1.5 重命名挂载的 configmaq key 的名称</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        envFrom:         <span class=\"token comment\"># 1. 批量挂载 ConfigMap 生成环境变量</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - configMapRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            name: cmenv</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: MYSQL_ADDR     <span class=\"token comment\"># 2. 自定义环境变量</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          value: <span class=\"token string\">\"192.168.40.150\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: MYSQL_PASSWD</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          value: Superman*2022</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: LOG_LEVEL           <span class=\"token comment\"># 3. 挂载单个 ConfigMap 生成环境变量，这里和 ConfigMap 中的键名是不一样的     </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              name: cmliteral       <span class=\"token comment\"># 这个值来自 ConfigMap</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: level            <span class=\"token comment\"># 来自 ConfigMap 的 key</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:              </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: nginx-config</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: <span class=\"token string\">\"/etc/nginx/conf.d\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      - name: nginx-config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          name: nginxconfig      <span class=\"token comment\"># 提供你想要挂载的 ConfigMap 的名字</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          items:                <span class=\"token comment\"># 重命名挂载的 configmaq key 的名称为 nginx.conf</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          - key: s.hmallleasing.com.conf  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            path: nginx.conf</pre></td></tr><tr><td data-num=\"51\"></td><td><pre> </pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">#查看挂载的 configmaq key 的名称重命名为 nginx.conf</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>NAME                           READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>nginx-deploy-bc476bc56-flln4   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10h</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>nginx-deploy-bc476bc56-jhsh6   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10h</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>nginx-deploy-bc476bc56-splv9   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10h</pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it nginx-deploy-bc476bc56-flln4 -- bash</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>root@nginx-deploy-bc476bc56-flln4:/<span class=\"token comment\"># ls /etc/nginx/conf.d/</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>nginx.conf</pre></td></tr></table></figure><h5 id=\"16-修改挂载的configmaq-权限\"><a class=\"anchor\" href=\"#16-修改挂载的configmaq-权限\">#</a> 1.6 修改挂载的 configmaq 权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        envFrom:         <span class=\"token comment\"># 1. 批量挂载 ConfigMap 生成环境变量</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - configMapRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            name: cmenv</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: MYSQL_ADDR     <span class=\"token comment\"># 2. 自定义环境变量</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          value: <span class=\"token string\">\"192.168.40.150\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: MYSQL_PASSWD</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          value: Superman*2022</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: LOG_LEVEL           <span class=\"token comment\"># 3. 挂载单个 ConfigMap 生成环境变量，这里和 ConfigMap 中的键名是不一样的     </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              name: cmliteral       <span class=\"token comment\"># 这个值来自 ConfigMap</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: level            <span class=\"token comment\"># 来自 ConfigMap 的 key</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:              </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: nginx-config</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: <span class=\"token string\">\"/etc/nginx/conf.d\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      - name: nginx-config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          name: nginxconfig      <span class=\"token comment\"># 提供你想要挂载的 ConfigMap 的名字</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          items:                <span class=\"token comment\"># 重命名挂载的 configmaq key 的名称为 nginx.conf</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          - key: s.hmallleasing.com.conf  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            path: nginx.conf</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            mode: 0644        <span class=\"token comment\"># 配置挂载权限，针对单个 key 生效</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          defaultMode: 0666   <span class=\"token comment\"># 配置挂载权限，针对整个 key 生效</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">#查看挂载权限</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>root@nginx-deploy-7657fbffc7-k75l5:/<span class=\"token comment\"># ls -l /etc/nginx/conf.d/nginx.conf </span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>lrwxrwxrwx <span class=\"token number\">1</span> root root <span class=\"token number\">17</span> Apr <span class=\"token number\">16</span> <span class=\"token number\">13</span>:37 /etc/nginx/conf.d/nginx.conf -<span class=\"token operator\">></span> <span class=\"token punctuation\">..</span>data/nginx.conf</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>root@nginx-deploy-7657fbffc7-k75l5:/<span class=\"token comment\"># ls -l /etc/nginx/conf.d/..data/nginx.conf </span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>-rw-rw-rw- <span class=\"token number\">1</span> root root <span class=\"token number\">722</span> Apr <span class=\"token number\">16</span> <span class=\"token number\">13</span>:37 /etc/nginx/conf.d/<span class=\"token punctuation\">..</span>data/nginx.conf</pre></td></tr></table></figure><h5 id=\"17-subpath解决挂载覆盖问题\"><a class=\"anchor\" href=\"#17-subpath解决挂载覆盖问题\">#</a> 1.7 subpath 解决挂载覆盖问题</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建 configmap</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>user  nginx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>worker_processes  <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>error_log  /var/log/nginx/error.log warn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pid        /var/run/nginx.pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>events <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    worker_connections  <span class=\"token number\">512</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    include       /etc/nginx/mime.types<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    default_type  application/octet-stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    log_format  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    access_log  /var/log/nginx/access.log  main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    sendfile        on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">#tcp_nopush     on;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    keepalive_timeout  <span class=\"token number\">65</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">#gzip  on;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    include /etc/nginx/conf.d/*.conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create cm nginx-config --from-file=./nginx.conf</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">#subpath 解决挂载覆盖问题</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 study<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat cm-deploy.yaml </span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        envFrom:         <span class=\"token comment\"># ①批量挂载 ConfigMap 生成环境变量</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - configMapRef:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            name: cmenv</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        - name: MYSQL_ADDR     <span class=\"token comment\"># ②自定义环境变量</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          value: <span class=\"token string\">\"192.168.40.150\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        - name: MYSQL_PASSWD</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          value: Superman*2022</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        - name: LOG_LEVEL           <span class=\"token comment\"># ③挂载单个 ConfigMap 生成环境变量，这里和 ConfigMap 中的键名是不一样的     </span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>              name: cmliteral       <span class=\"token comment\"># 这个值来自 ConfigMap</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>              key: level            <span class=\"token comment\"># 来自 ConfigMap 的 key</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        - name: config</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          mountPath: <span class=\"token string\">\"/etc/nginx/nginx.conf\"</span>   <span class=\"token comment\">#只挂在 nginx.conf 一个文件，不覆盖目录</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          subPath: nginx.conf      </pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      - name: config</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          name: nginx-config      <span class=\"token comment\"># 提供你想要挂载的 ConfigMap 的名字</span></pre></td></tr></table></figure><h4 id=\"2-secret\"><a class=\"anchor\" href=\"#2-secret\">#</a> 2. Secret</h4>\n<h5 id=\"21-secret拉取私有仓库镜像\"><a class=\"anchor\" href=\"#21-secret拉取私有仓库镜像\">#</a> 2.1 Secret 拉取私有仓库镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create secret docker-registry harboradmin \\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--docker-server<span class=\"token operator\">=</span>s.hmallleasing.com <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>--docker-username<span class=\"token operator\">=</span>admin <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>--docker-password<span class=\"token operator\">=</span>Superman*2023</pre></td></tr></table></figure><h5 id=\"22-创建ssl-secret\"><a class=\"anchor\" href=\"#22-创建ssl-secret\">#</a> 2.2 创建 ssl Secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create secret tls dev.hmallleasig.com --key *.hmallleasing.com_key.key --cert *.hmallleasing.com_chain.crt -n dev</span></pre></td></tr></table></figure><h5 id=\"23-基于命令创建generic-secret\"><a class=\"anchor\" href=\"#23-基于命令创建generic-secret\">#</a> 2.3 基于命令创建 generic Secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 通过 from-env-file 创建</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># cat db.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">username</span><span class=\"token operator\">=</span>xuyong</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">passwd</span><span class=\"token operator\">=</span>Superman*2023</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># kubectl create secret generic dbconf --from-env-file=./db.conf</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#2. 通过 from-literal 创建</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kubectl create secret generic db-user-pass <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    --from-literal<span class=\"token operator\">=</span>username<span class=\"token operator\">=</span>admin <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    --from-literal<span class=\"token operator\">=</span>password<span class=\"token operator\">=</span><span class=\"token string\">'S!B\\*d$zDsb='</span></pre></td></tr></table></figure><h5 id=\"24-secret加密-解密\"><a class=\"anchor\" href=\"#24-secret加密-解密\">#</a> 2.4 Secret 加密、解密</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.加密</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># echo -n \"Superman*2023\" | base64</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">U3VwZXJtYW4qMjAyMw</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2</span>.解密</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># echo \"U3VwZXJtYW4qMjAyMw==\" | base64 --decode</span></pre></td></tr></table></figure><h5 id=\"25-基于文件创建非加密generic-secret\"><a class=\"anchor\" href=\"#25-基于文件创建非加密generic-secret\">#</a> 2.5 基于文件创建非加密 generic Secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get secret dbconf -oyaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  passwd: <span class=\"token assign-left variable\">U3VwZXJtYW4qMjAyMw</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  username: eHV5b25n</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: dbconf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h5 id=\"2-6-基于yaml创建加密generic-secret\"><a class=\"anchor\" href=\"#2-6-基于yaml创建加密generic-secret\">#</a> 2. 6 基于 yaml 创建加密 generic Secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat mysql-secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-secret</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: dev</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>stringData:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  MYSQL_ROOT_PASSWORD: Superman*2023</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h5 id=\"27-deployment挂载secret示例\"><a class=\"anchor\" href=\"#27-deployment挂载secret示例\">#</a> 2.7 Deployment 挂载 Secret 示例</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 study<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat cm-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        - name: MYSQL_ROOT_PASSWORD  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              name: mysql-secret</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              key: MYSQL_ROOT_PASSWORD</pre></td></tr></table></figure><h4 id=\"3-configmapsecret热更新\"><a class=\"anchor\" href=\"#3-configmapsecret热更新\">#</a> 3. ConfigMap&amp;Secret 热更新</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create cm nginxconfig --from-file=nginx.conf --dry-run=client -oyaml | kubectl replace -f -</span></pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/858611107.html",
            "url": "http://ixuyong.cn/posts/858611107.html",
            "title": "K8s服务发布Service",
            "date_published": "2025-04-14T11:25:51.000Z",
            "content_html": "<h3 id=\"k8s服务发布service\"><a class=\"anchor\" href=\"#k8s服务发布service\">#</a> K8s 服务发布 Service</h3>\n<h4 id=\"1-service类型\"><a class=\"anchor\" href=\"#1-service类型\">#</a> 1. Service 类型</h4>\n<p>Kubernetes Service Type（服务类型）主要包括以下几种：</p>\n<ul>\n<li>ClusterIP：在集群内部使用，默认值，只能从集群中访问。</li>\n<li>NodePort：在所有安装了 Kube-Proxy 的节点上打开一个端口，此端口可以代理至后端 Pod，可以通过 NodePort 从集群外部访问集群内的服务，格式为 NodeIP:NodePort。</li>\n<li>LoadBalancer：使用云提供商的负载均衡器公开服务，成本较高。</li>\n<li>ExternalName：通过返回定义的 CNAME 别名，没有设置任何类型的代理，需要 1.7 或更高版本 kube-dns 支持。</li>\n</ul>\n<h5 id=\"11-nodeport类型\"><a class=\"anchor\" href=\"#11-nodeport类型\">#</a> 1.1 NodePort 类型</h5>\n<p>如果将 Service 的 type 字段设置为 NodePort，则 Kubernetes 将从 --service-node-port-range 参数指定的范围（默认为 30000-32767）中自动分配端口，也可以手动指定 NodePort，创建该 Service 后，集群每个节点都将暴露一个端口，通过某个宿主机的 IP + 端口即可访问到后端的应用。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-svc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-svc</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  type: NodePort</pre></td></tr></table></figure><h5 id=\"12-clusterip类型\"><a class=\"anchor\" href=\"#12-clusterip类型\">#</a> 1.2 ClusterIP 类型</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-svc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-svc</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  type: ClusterIP</pre></td></tr></table></figure><h5 id=\"13-使用service代理k8s外部服务\"><a class=\"anchor\" href=\"#13-使用service代理k8s外部服务\">#</a> 1.3 使用 Service 代理 K8s 外部服务</h5>\n<p>使用场景：</p>\n<ul>\n<li>希望在生产环境中使用某个固定的名称而非 IP 地址访问外部的中间件服务；</li>\n<li>希望 Service 指向另一个 Namespace 中或其他集群中的服务；</li>\n<li>正在将工作负载转移到 Kubernetes 集群，但是一部分服务仍运行在 Kubernetes 集群之外的 backend。</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    app: mysql-svc-external</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: mysql-svc-external</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - name: mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    port: <span class=\"token number\">3306</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kind: Endpoints</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    app: mysql-svc-external</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: mysql-svc-external</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>subsets:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>- addresses:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  - ip: <span class=\"token number\">192.168</span>.40.150</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  - name: mysql</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    protocol: TCP</pre></td></tr></table></figure><h5 id=\"14-externalname-service\"><a class=\"anchor\" href=\"#14-externalname-service\">#</a> 1.4 ExternalName Service</h5>\n<p>ExternalName Service 是 Service 的特例，它没有 Selector，也没有定义任何端口和 Endpoint，它通过返回该外部服务的别名来提供服务。</p>\n<p>比如可以定义一个 Service，后端设置为一个外部域名，这样通过 Service 的名称即可访问到该域名。使用 nslookup 解析以下文件定义的 Service，集群的 DNS <a href=\"http://xn--my-uu2cmg2cx7mswf9rko5lsx1a5n3h.database.example.com\">服务将返回一个值为 my.database.example.com</a> 的 CNAME 记录：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: my-service</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  type: ExternalName</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  externalName: my.database.example.com</pre></td></tr></table></figure><h5 id=\"15-多端口-service\"><a class=\"anchor\" href=\"#15-多端口-service\">#</a> 1.5 多端口 Service</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-svc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-svc</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      targetPort: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      name: https</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  type: ClusterIP</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/108692210.html",
            "url": "http://ixuyong.cn/posts/108692210.html",
            "title": "K8s资源调度deployment、statefulset、daemonset",
            "date_published": "2025-04-14T11:25:00.000Z",
            "content_html": "<h3 id=\"k8s资源调度deployment-statefulset-daemonset\"><a class=\"anchor\" href=\"#k8s资源调度deployment-statefulset-daemonset\">#</a> K8s 资源调度 deployment、statefulset、daemonset</h3>\n<h4 id=\"1-无状态应用管理-deployment\"><a class=\"anchor\" href=\"#1-无状态应用管理-deployment\">#</a> 1. 无状态应用管理 Deployment</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          image: nginx:1.21.0</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      restartPolicy: Always</pre></td></tr></table></figure><p>示例解析：</p>\n<ol>\n<li>\n<p>nginx-deploy：Deployment 的名称；</p>\n</li>\n<li>\n<p>replicas： 创建 Pod 的副本数；</p>\n</li>\n<li>\n<p>selector：定义 Deployment 如何找到要管理的 Pod，与 template 的 label（标签）对应，apiVersion 为 apps/v1 必须指定该字段；</p>\n</li>\n<li>\n<p>template 字段包含以下字段：</p>\n<ul>\n<li>\n<p>app: nginx-deploy 使用 label（标签）标记 Pod；</p>\n</li>\n<li>\n<p>spec：表示 Pod 运行一个名字为 nginx 的容器；</p>\n</li>\n<li>\n<p>image：运行此 Pod 使用的镜像；</p>\n</li>\n<li>\n<p>Port：容器用于发送和接收流量的端口。</p>\n</li>\n</ul>\n</li>\n</ol>\n<h5 id=\"11-更新-deployment\"><a class=\"anchor\" href=\"#11-更新-deployment\">#</a> 1.1 更新 Deployment</h5>\n<p>假如更新 Nginx Pod 的 image 使用 nginx:latest，并使用 --record 记录当前更改的参数，后期回滚时可以查看到对应的信息：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl set image deployment nginx-deploy nginx-deploy=nginx:latest --record</span></pre></td></tr></table></figure><p>更新过程为新旧交替更新，首先新建一个 Pod，当 Pod 状态为 Running 时，删除一个旧的 Pod，同时再创建一个新的 Pod。当触发一个更新后，会有新的 ReplicaSet 产生，旧的 ReplicaSet 会被保存，查看此时 ReplicaSet，可以从 AGE 或 READY 看出来新旧 ReplicaSet：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get rs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                      DESIRED   CURRENT   READY   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-deploy-65bfb77869   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       50s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-deploy-85b94dddb4   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       8s</pre></td></tr></table></figure><p>通过 describe 查看 Deployment 的详细信息：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl describe deploy nginx-deploy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Name:                   nginx-deploy</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Namespace:              default</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>CreationTimestamp:      Mon, <span class=\"token number\">14</span> Apr <span class=\"token number\">2025</span> <span class=\"token number\">11</span>:28:03 +0800</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Labels:                 <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Annotations:            app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                        deployment.kubernetes.io/revision: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        kubernetes.io/change-cause: kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:latest <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Selector:               <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-deploy</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Replicas:               <span class=\"token number\">3</span> desired <span class=\"token operator\">|</span> <span class=\"token number\">3</span> updated <span class=\"token operator\">|</span> <span class=\"token number\">3</span> total <span class=\"token operator\">|</span> <span class=\"token number\">3</span> available <span class=\"token operator\">|</span> <span class=\"token number\">0</span> unavailable</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>StrategyType:           RollingUpdate</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>MinReadySeconds:        <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>RollingUpdateStrategy:  <span class=\"token number\">25</span>% max unavailable, <span class=\"token number\">25</span>% max surge</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Pod Template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Labels:  <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-deploy</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  Containers:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   nginx-deploy:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    Image:         nginx:latest</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    Port:          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    Host Port:     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    Environment:   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    Mounts:        <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  Volumes:         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  Node-Selectors:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  Tolerations:     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Conditions:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  Type           Status  Reason</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  ----           ------  ------</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  Available      True    MinimumReplicasAvailable</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  Progressing    True    NewReplicaSetAvailable</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>OldReplicaSets:  nginx-deploy-65bfb77869 <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>/0 replicas created<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>NewReplicaSet:   nginx-deploy-85b94dddb4 <span class=\"token punctuation\">(</span><span class=\"token number\">3</span>/3 replicas created<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Events:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  Type    Reason             Age   From                   Message</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  ----    ------             ----  ----                   -------</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  Normal  ScalingReplicaSet  71s   deployment-controller  Scaled up replica <span class=\"token builtin class-name\">set</span> nginx-deploy-65bfb77869 from <span class=\"token number\">0</span> to <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  Normal  ScalingReplicaSet  29s   deployment-controller  Scaled up replica <span class=\"token builtin class-name\">set</span> nginx-deploy-85b94dddb4 from <span class=\"token number\">0</span> to <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  Normal  ScalingReplicaSet  28s   deployment-controller  Scaled down replica <span class=\"token builtin class-name\">set</span> nginx-deploy-65bfb77869 from <span class=\"token number\">3</span> to <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  Normal  ScalingReplicaSet  28s   deployment-controller  Scaled up replica <span class=\"token builtin class-name\">set</span> nginx-deploy-85b94dddb4 from <span class=\"token number\">1</span> to <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  Normal  ScalingReplicaSet  27s   deployment-controller  Scaled down replica <span class=\"token builtin class-name\">set</span> nginx-deploy-65bfb77869 from <span class=\"token number\">2</span> to <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  Normal  ScalingReplicaSet  27s   deployment-controller  Scaled up replica <span class=\"token builtin class-name\">set</span> nginx-deploy-85b94dddb4 from <span class=\"token number\">2</span> to <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  Normal  ScalingReplicaSet  26s   deployment-controller  Scaled down replica <span class=\"token builtin class-name\">set</span> nginx-deploy-65bfb77869 from <span class=\"token number\">1</span> to <span class=\"token number\">0</span></pre></td></tr></table></figure><p>在 describe 中可以看出，第一次创建时，它创建了一个名为 nginx-deploy-65bfb77869 的 ReplicaSet，并直接将其扩展为 3 个副本。更新部署时，它创建了一个新的 ReplicaSet，命名为 nginx-deploy-85b94dddb4，并将其副本数扩展为 1，然后将旧的 ReplicaSet 缩小为 2，这样至少可以有 2 个 Pod 可用，最多创建了 4 个 Pod。以此类推，使用相同的滚动更新策略向上和向下扩展新旧 ReplicaSet，最终新的 ReplicaSet 可以拥有 3 个副本，并将旧的 ReplicaSet 缩小为 0。</p>\n<h5 id=\"12-回滚-deployment\"><a class=\"anchor\" href=\"#12-回滚-deployment\">#</a> 1.2 回滚 Deployment</h5>\n<p>当更新了版本不稳定或配置不合理时，可以对其进行回滚操作，假设我们又进行了几次更新（此处以更新镜像版本触发更新，更改配置效果类似）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl set image deployment nginx-deploy nginx-deploy=nginx:1.21.1 --record</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl set image deployment nginx-deploy nginx-deploy=nginx:1.21.2 --record</span></pre></td></tr></table></figure><p>使用 kubectl rollout history 查看更新历史：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl rollout history deployment nginx-deploy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/nginx-deploy </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>REVISION  CHANGE-CAUSE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">1</span>         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:latest <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">3</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.1 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">4</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.2 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr></table></figure><p>查看 Deployment 某次更新的详细信息，使用 --revision 指定某次更新版本号：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout history deployment nginx-deploy --revision=4</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/nginx-deploy with revision <span class=\"token comment\">#4</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Pod Template:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  Labels:\t<span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tpod-template-hash<span class=\"token operator\">=</span>65b576b795</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Annotations:\tkubernetes.io/change-cause: kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.2 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  Containers:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   nginx-deploy:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    Image:\tnginx:1.21.2</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    Port:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    Host Port:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    Environment:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    Mounts:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  Volumes:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Node-Selectors:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  Tolerations:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><p>如果只需要回滚到上一个稳定版本，使用 kubectl rollout undo 即可：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout undo deployment nginx-deploy</span></pre></td></tr></table></figure><p>再次查看更新历史，发现 REVISION3 回到了 nginx:1.21.1：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout history deployment nginx-deploy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/nginx-deploy </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>REVISION  CHANGE-CAUSE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">1</span>         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:latest <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">4</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.2 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">5</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.1 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr></table></figure><p>如果要回滚到指定版本，使用 --to-revision 参数：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout undo deployment nginx-deploy --to-revision=2</span></pre></td></tr></table></figure><h5 id=\"13-扩容-deployment\"><a class=\"anchor\" href=\"#13-扩容-deployment\">#</a> 1.3 扩容 Deployment</h5>\n<p>当公司访问量变大，或者有预期内的活动时，三个 Pod 可能已无法支撑业务时，可以提前对其进行扩展。</p>\n<p>使用 kubectl scale 动态调整 Pod 的副本数，比如增加 Pod 为 5 个：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl scale deployment nginx-deploy --replicas=5</span></pre></td></tr></table></figure><p>查看 Pod，此时 Pod 已经变成了 5 个：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-deploy-85b94dddb4-2qrh6   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m9s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-deploy-85b94dddb4-gvkqj   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m10s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-deploy-85b94dddb4-mdfjs   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          22s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nginx-deploy-85b94dddb4-rhgpr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m8s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nginx-deploy-85b94dddb4-vwjhl   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          22s</pre></td></tr></table></figure><h5 id=\"14-暂停和恢复-deployment-更新\"><a class=\"anchor\" href=\"#14-暂停和恢复-deployment-更新\">#</a> 1.4 暂停和恢复 Deployment 更新</h5>\n<p>上述演示的均为更改某一处的配置，更改后立即触发更新，大多数情况下可能需要针对一个资源文件更改多处地方，而并不需要多次触发更新，此时可以使用 Deployment 暂停功能，临时禁用更新操作，对 Deployment 进行多次修改后在进行更新。</p>\n<p>使用 kubectl rollout pause 命令即可暂停 Deployment 更新：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout pause deployment nginx-deploy</span></pre></td></tr></table></figure><p>然后对 Deployment 进行相关更新操作，比如先更新镜像，然后对其资源进行限制（如果使用的是 kubectl edit 命令，可以直接进行多次修改，无需暂停更新，kubectlset 命令一般会集成在 CICD 流水线中）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl set image deployment nginx-deploy nginx-deploy=nginx:1.21.3</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl set resources deployment nginx-deploy -c=nginx-deploy --limits=cpu=200m,memory=512Mi</span></pre></td></tr></table></figure><p>通过 rollout history 可以看到没有新的更新：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#  kubectl rollout history deployment nginx-deploy</span></pre></td></tr></table></figure><p>进行完最后一处配置更改后，使用 kubectl rollout resume 恢复 Deployment 更新：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout resume deployment nginx-deploy</span></pre></td></tr></table></figure><p>可以查看到恢复更新的 Deployment 创建了一个新的 RS（ReplicaSet 缩写）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get rs</span></pre></td></tr></table></figure><p>可以查看 Deployment 的 image（镜像）已经变为 nginx:1.21.3</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -oyaml|grep image</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr></table></figure><h5 id=\"15-更新-deployment-的注意事项\"><a class=\"anchor\" href=\"#15-更新-deployment-的注意事项\">#</a> 1.5 更新 Deployment 的注意事项</h5>\n<p>在默认情况下，revision 保留 10 个旧的 ReplicaSet，其余的将在后台进行垃圾回收，可以在.spec.revisionHistoryLimit 设置保留 ReplicaSet 的个数。当设置为 0 时，不保留历史记录。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              cpu: 200m</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>              memory: 512Mi</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  strategy:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    type: RollingUpdate</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    rollingUpdate:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      maxUnavailable: <span class=\"token number\">25</span>%</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      maxSurge: <span class=\"token number\">25</span>%</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  revisionHistoryLimit: <span class=\"token number\">10</span></pre></td></tr></table></figure><p>更新策略：</p>\n<ul>\n<li>spec.strategy.type==Recreate，表示重建，先删掉旧的 Pod 再创建新的 Pod；</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>strategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: Recreate</pre></td></tr></table></figure><ul>\n<li>\n<p>spec.strategy.type==RollingUpdate，表示滚动更新，可以指定 maxUnavailable 和 maxSurge 来控制滚动更新过程；</p>\n<ul>\n<li>\n<p>spec.strategy.rollingUpdate.maxUnavailable，指定在回滚更新时最大不可用的 Pod 数量，可选字段，默认为 25%，可以设置为数字或百分比，如果 maxSurge 为 0，则该值不能为 0；</p>\n</li>\n<li>\n<p>spec.strategy.rollingUpdate.maxSurge 可以超过期望值的最大 Pod 数，可选字段，默认为 25%，可以设置成数字或百分比，如果 maxUnavailable 为 0，则该值不能为 0。</p>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>strategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: RollingUpdate</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    rollingUpdate:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      maxUnavailable: <span class=\"token number\">25</span>%</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      maxSurge: <span class=\"token number\">25</span>%</pre></td></tr></table></figure><h4 id=\"2-有状态应用管理-statefulset\"><a class=\"anchor\" href=\"#2-有状态应用管理-statefulset\">#</a> 2. 有状态应用管理 StatefulSet</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: web</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      app: nginx</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        app: nginx</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: nginx</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              cpu: <span class=\"token string\">'1'</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              memory: 1Gi</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  serviceName: web</pre></td></tr></table></figure><ul>\n<li>kind: Service 定义了一个名字为 web 的 Headless Service，创建的 Service 格式为 nginx-0.web.default.svc.cluster.local，其他的类似，因为没有指定 Namespace（命名空间），所以默认部署在 default；</li>\n<li>kind: StatefulSet 定义了一个名字为 nginx 的 StatefulSet，replicas 表示部署 Pod 的副本数，本实例为 3。</li>\n</ul>\n<h5 id=\"21-创建-statefulset\"><a class=\"anchor\" href=\"#21-创建-statefulset\">#</a> 2.1 创建 StatefulSet</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME      READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m51s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m50s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m48s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>kubernetes   ClusterIP   <span class=\"token number\">10.96</span>.0.1    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>/TCP   6d1h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>web          ClusterIP   None         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>/TCP    9m28s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get sts</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>NAME    READY   AGE</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nginx   <span class=\"token number\">3</span>/3     8m58s</pre></td></tr></table></figure><h5 id=\"22-statefulset创建pod流程\"><a class=\"anchor\" href=\"#22-statefulset创建pod流程\">#</a> 2.2 StatefulSet 创建 Pod 流程</h5>\n<p>StatefulSet 管理的 Pod 部署和扩展规则如下：</p>\n<ul>\n<li>对于具有 N 个副本的 StatefulSet，将按顺序从 0 到 N-1 开始创建 Pod；</li>\n<li>当删除 Pod 时，将按照 N-1 到 0 的反顺序终止；</li>\n<li>在缩放 Pod 之前，必须保证当前的 Pod 是 Running（运行中）或者 Ready（就绪）；</li>\n<li>在终止 Pod 之前，它所有的继任者必须是完全关闭状态。</li>\n</ul>\n<p>StatefulSet 的 pod.Spec.TerminationGracePeriodSeconds（终止 Pod 的等待时间）不应该指定为 0，设置为 0 对 StatefulSet 的 Pod 是极其不安全的做法，优雅地删除 StatefulSet 的 Pod 是非常有必要的，而且是安全的，因为它可以确保在 Kubelet 从 APIServer 删除之前，让 Pod 正常关闭。</p>\n<p>当创建上面的 Nginx 实例时，Pod 将按 nginx-0、nginx-1、nginx-2 的顺序部署 3 个 Pod。在 nginx-0 处于 Running 或者 Ready 之前，nginx-1 不会被部署，相同的，nginx-2 在 web-1 未处于 Running 和 Ready 之前也不会被部署。如果在 nginx-1 处于 Running 和 Ready 状态时，nginx-0 变成 Failed 失败）状态，那么 nginx-2 将不会被启动，直到 nginx-0 恢复为 Running 和 Ready 状态。</p>\n<p>如果用户将 StatefulSet 的 replicas 设置为 1，那么 nginx-2 将首先被终止，在完全关闭并删除 nginx-2 之前，不会删除 nginx-1。如果 nginx-2 终止并且完全关闭后，nginx-0 突然失败，那么在 nginx-0 未恢复成 Running 或者 Ready 时，nginx-1 不会被删除。</p>\n<h5 id=\"23-tatefulset-扩容和缩容\"><a class=\"anchor\" href=\"#23-tatefulset-扩容和缩容\">#</a> 2.3 tatefulSet 扩容和缩容</h5>\n<p>和 Deployment 类似，可以通过更新 replicas 字段扩容 / 缩容 StatefulSet，也可以使用 kubectlscale、kubectl edit 和 kubectl patch 来扩容 / 缩容一个 StatefulSet。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl scale sts nginx --replicas=5</span></pre></td></tr></table></figure><h5 id=\"24-statefulset-更新策略\"><a class=\"anchor\" href=\"#24-statefulset-更新策略\">#</a> 2.4 StatefulSet 更新策略</h5>\n<p><strong>On Delete 策略</strong></p>\n<p>OnDelete 更新策略实现了传统（1.7 版本之前）的行为，它也是默认的更新策略。当我们选择这个更新策略并修改 StatefulSet 的.spec.template 字段时，StatefulSet 控制器不会自动更新 Pod，必须手动删除 Pod 才能使控制器创建新的 Pod。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>updateStrategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: OnDelete</pre></td></tr></table></figure><p><strong>RollingUpdate 策略</strong></p>\n<p>RollingUpdate（滚动更新）更新策略会自动更新一个 StatefulSet 中所有的 Pod，采用与序号索引相反的顺序进行滚动更新。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>updateStrategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: RollingUpdate</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    rollingUpdate:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      partition: <span class=\"token number\">0</span></pre></td></tr></table></figure><h5 id=\"25-分段更新\"><a class=\"anchor\" href=\"#25-分段更新\">#</a> 2.5 分段更新</h5>\n<p>将分区改为 2，此时会自动更新 nginx-2、nginx-3、nginx-4（因为之前更改了更新策略），但是不会更新 nginx-0 和 nginx-1：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>updateStrategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: RollingUpdate</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    rollingUpdate:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      partition: <span class=\"token number\">2</span></pre></td></tr></table></figure><p>将 sts 镜像为 nginx:1.21.1</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl set image sts nginx nginx=nginx:1.21.1</span></pre></td></tr></table></figure><p>按照上述方式，可以实现分阶段更新，类似于灰度 / 金丝雀发布。查看最终的结果如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -oyaml|grep image</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    - image: nginx:latest</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      image: docker.io/library/nginx:latest</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:fad8e1cd52e24bce7b72cd7cb674a2efad671647b917055f5bd8a1f7ac9b1af8</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - image: nginx:latest</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      image: docker.io/library/nginx:latest</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:fad8e1cd52e24bce7b72cd7cb674a2efad671647b917055f5bd8a1f7ac9b1af8</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - image: nginx:1.21.1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      image: docker.io/library/nginx:1.21.1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:a05b0cdd4fc1be3b224ba9662ebdf98fe44c09c0c9215b45f84344c12867002e</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - image: nginx:1.21.1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      image: docker.io/library/nginx:1.21.1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:a05b0cdd4fc1be3b224ba9662ebdf98fe44c09c0c9215b45f84344c12867002e</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - image: nginx:1.21.1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      image: docker.io/library/nginx:1.21.1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:a05b0cdd4fc1be3b224ba9662ebdf98fe44c09c0c9215b45f84344c12867002e</pre></td></tr></table></figure><h5 id=\"26-statefulset-挂载动态存储\"><a class=\"anchor\" href=\"#26-statefulset-挂载动态存储\">#</a> 2.6 StatefulSet 挂载动态存储</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    name: web</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  name: web</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      app: nginx </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  serviceName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  replicas: <span class=\"token number\">3</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        app: nginx </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      - name: nginx</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        image: nginx:1.20</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          name: web</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      name: www</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span> <span class=\"token string\">\"ReadWriteOnce\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      storageClassName: <span class=\"token string\">\"rook-ceph-block\"</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          storage: 10Gi</pre></td></tr></table></figure><h4 id=\"3守护进程集-daemonset\"><a class=\"anchor\" href=\"#3守护进程集-daemonset\">#</a> 3. 守护进程集 DaemonSet</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: DaemonSet</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-ds</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-ds</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-ds</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nginx-ds</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        - name: nginx-ds</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><p>此时会在每个节点创建一个 Pod：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME             READY   STATUS    RESTARTS   AGE   IP               NODE           NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-ds-47dxc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.85.213    k8s-node01     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-ds-4m89f   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.32.143    k8s-master01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-ds-mtpc2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.195.12    k8s-master03   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nginx-ds-t5rxc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.122.142   k8s-master02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nginx-ds-x86kc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.58.222    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><p>指定节点部署 Pod</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nodeSelector:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        ingress: <span class=\"token string\">'true'</span></pre></td></tr></table></figure><p>更新和回滚 DaemonSet</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl set image ds nginx-ds nginx-ds=1.21.0 --record=true</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl rollout undo daemonset &lt;daemonset-name> --to-revision=&lt;revision></span></pre></td></tr></table></figure><p>DaemonSet 的更新和回滚与 Deployment 类似，此处不再演示。</p>\n<h4 id=\"4-hpa\"><a class=\"anchor\" href=\"#4-hpa\">#</a> 4. HPA</h4>\n<p>创建 deployment、service</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-hpa-svc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    app: nginx-hpa</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: nginx-hpa</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    app: nginx-hpa</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      app: nginx-hpa</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        app: nginx-hpa</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: nginx-hpa</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><p>创建 HPA</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl autoscale deployment nginx-hpa --cpu-percent=10 --min=1 --max=10</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl get hpa</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME        REFERENCE              TARGETS       MINPODS   MAXPODS   REPLICAS   AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-hpa   Deployment/nginx-hpa   cpu: <span class=\"token number\">0</span>%/10%   <span class=\"token number\">1</span>         <span class=\"token number\">10</span>        <span class=\"token number\">1</span>          16s</pre></td></tr></table></figure><p>测试自动扩缩容</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token function\">wget</span> <span class=\"token parameter variable\">-q</span> -O- http://10.96.18.221 <span class=\"token operator\">></span> /dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                        READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-hpa-d8bcbdf7d-4mkxp   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          66s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-hpa-d8bcbdf7d-974q5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m36s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nginx-hpa-d8bcbdf7d-g6p2h   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          66s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nginx-hpa-d8bcbdf7d-lvvsq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          111s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nginx-hpa-d8bcbdf7d-tgqmr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          111s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nginx-hpa-d8bcbdf7d-tzfbs   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          21s</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1771242682.html",
            "url": "http://ixuyong.cn/posts/1771242682.html",
            "title": "K8s零宕机服务发布-探针",
            "date_published": "2025-04-14T11:23:48.000Z",
            "content_html": "<h3 id=\"k8s零宕机服务发布-探针\"><a class=\"anchor\" href=\"#k8s零宕机服务发布-探针\">#</a> K8s 零宕机服务发布 - 探针</h3>\n<h4 id=\"1-pod状态及-pod-故障排查命令\"><a class=\"anchor\" href=\"#1-pod状态及-pod-故障排查命令\">#</a> 1. Pod 状态及 Pod 故障排查命令</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">状态</th>\n<th style=\"text-align:left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Pending（挂起）</td>\n<td style=\"text-align:left\">Pod 已被 Kubernetes 系统接收，但仍有一个或多个容器未被创建，可以通过 kubectl describe 查看处于 Pending 状态的原因</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Running（运行中）</td>\n<td style=\"text-align:left\">Pod 已经被绑定到一个节点上，并且所有的容器都已经被创建，而且至少有一个是运行状态，或者是正在启动或者重启，可以通过 kubectl logs 查看 Pod 的日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Succeeded（成功）</td>\n<td style=\"text-align:left\">所有容器执行成功并终止，并且不会再次重启，可以通过 kubectl logs 查看 Pod 日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Failed（失败）</td>\n<td style=\"text-align:left\">所有容器都已终止，并且至少有一个容器以失败的方式终止，也就是说这个容器要么以非零状态退出，要么被系统终止，可以通过 logs 和 describe 查看 Pod 日志和状态</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Unknown（未知）</td>\n<td style=\"text-align:left\">通常是由于通信问题造成的无法获得 Pod 的状态</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ImagePullBackOff ErrImagePull</td>\n<td style=\"text-align:left\">镜像拉取失败，一般是由于镜像不存在、网络不通或者需要登录认证引起的，可以使用 describe 命令查看具体原因</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CrashLoopBackOff</td>\n<td style=\"text-align:left\">容器启动失败，可以通过 logs 命令查看具体原因，一般为启动命令不正确，健康检查不通过等</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">OOMKilled</td>\n<td style=\"text-align:left\">容器内存溢出，一般是容器的内存 Limit 设置的过小，或者程序本身有内存溢出，可以通过 logs 查看程序启动日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Terminating</td>\n<td style=\"text-align:left\">Pod 正在被删除，可以通过 describe 查看状态</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SysctlForbidden</td>\n<td style=\"text-align:left\">Pod 自定义了内核配置，但 kubelet 没有添加内核配置或配置的内核参数不支持，可以通过 describe 查看具体原因</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Completed</td>\n<td style=\"text-align:left\">容器内部主进程退出，一般计划任务执行结束会显示该状态，此时可以通过 logs 查看容器日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ContainerCreating</td>\n<td style=\"text-align:left\">Pod 正在创建，一般为正在下载镜像，或者有配置不当的地方，可以通过 describe 查看具体原因</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"2-pod镜像拉取策略\"><a class=\"anchor\" href=\"#2-pod镜像拉取策略\">#</a> 2. Pod 镜像拉取策略</h4>\n<p>通过 spec.containers [].imagePullPolicy 参数可以指定镜像的拉取策略，目前支持的策略如下：</p>\n<table>\n<thead>\n<tr>\n<th>操作方式</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Always</td>\n<td>总是拉取，当镜像 tag 为 latest 时，且 imagePullPolicy 未配置，默认为 Always</td>\n</tr>\n<tr>\n<td>Never</td>\n<td>不管是否存在都不会拉取</td>\n</tr>\n<tr>\n<td>IfNotPresent</td>\n<td>镜像不存在时拉取镜像，如果 tag 为非 latest，且 imagePullPolicy 未配置，默认为 IfNotPresent</td>\n</tr>\n</tbody>\n</table>\n<p>更改镜像拉取策略为 IfNotPresent：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr></table></figure><h4 id=\"3-pod-重启策略\"><a class=\"anchor\" href=\"#3-pod-重启策略\">#</a> 3. <strong>Pod</strong> 重启策略</h4>\n<table>\n<thead>\n<tr>\n<th>操作方式</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Always</td>\n<td>默认策略。容器失效时，自动重启该容器</td>\n</tr>\n<tr>\n<td>OnFailure</td>\n<td>容器以不为 0 的状态码终止，自动重启该容器</td>\n</tr>\n<tr>\n<td>Never</td>\n<td>无论何种状态，都不会重启</td>\n</tr>\n</tbody>\n</table>\n<p>指定重启策略为 Always ：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      restartPolicy: Always</pre></td></tr></table></figure><h4 id=\"4-pod的三种探针\"><a class=\"anchor\" href=\"#4-pod的三种探针\">#</a> 4. Pod 的三种探针</h4>\n<table>\n<thead>\n<tr>\n<th>种类</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>startupProbe</td>\n<td>Kubernetes1.16 新加的探测方式，用于判断容器内的应用程序是否已经启动。如果配置了 startupProbe，就会先禁用其他探测，直到它成功为止。如果探测失败，Kubelet 会杀死容器，之后根据重启策略进行处理，如果探测成功，或没有配置 startupProbe，则状态为成功，之后就不再探测。</td>\n</tr>\n<tr>\n<td>livenessProbe</td>\n<td>用于探测容器是否在运行，如果探测失败，kubelet 会 “杀死” 容器并根据重启策略进行相应的处理。如果未指定该探针，将默认为 Success</td>\n</tr>\n<tr>\n<td>readinessProbe</td>\n<td>一般用于探测容器内的程序是否健康，即判断容器是否为就绪（Ready）状态。如果是，则可以处理请求，反之 Endpoints Controller 将从所有的 Service 的 Endpoints 中删除此容器所在 Pod 的 IP 地址。如果未指定，将默认为 Success</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"5-pod探针的实现方式\"><a class=\"anchor\" href=\"#5-pod探针的实现方式\">#</a> 5. Pod 探针的实现方式</h4>\n<table>\n<thead>\n<tr>\n<th>实现方式</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ExecAction</td>\n<td>在容器内执行一个指定的命令，如果命令返回值为 0，则认为容器健康</td>\n</tr>\n<tr>\n<td>TCPSocketAction</td>\n<td>通过 TCP 连接检查容器指定的端口，如果端口开放，则认为容器健康</td>\n</tr>\n<tr>\n<td>HTTPGetAction</td>\n<td>对指定的 URL 进行 Get 请求，如果状态码在 200~400 之间，则认为容器健康</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"6-健康检查配置\"><a class=\"anchor\" href=\"#6-健康检查配置\">#</a> 6. 健康检查配置</h4>\n<p>配置健康检查：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          startupProbe:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            tcpSocket:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          livenessProbe:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            tcpSocket:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          readinessProbe:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            httpGet:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              path: /index.html</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              scheme: HTTP</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      restartPolicy: Always</pre></td></tr></table></figure><h4 id=\"7-prestop和-poststart配置\"><a class=\"anchor\" href=\"#7-prestop和-poststart配置\">#</a> 7. PreStop 和 PostStart 配置</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          startupProbe:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            tcpSocket:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          livenessProbe:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            tcpSocket:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            httpGet:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              path: /index.html</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              scheme: HTTP</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          lifecycle:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            postStart:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>              exec:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                command:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                  - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                  - <span class=\"token string\">'-c'</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                  - <span class=\"token function\">mkdir</span> /data</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            preStop:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              exec:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                command:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                  - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                  - <span class=\"token string\">'-c'</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                  - <span class=\"token function\">sleep</span> <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      restartPolicy: Always</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/985149017.html",
            "url": "http://ixuyong.cn/posts/985149017.html",
            "title": "二进制高可用安装K8S集群",
            "date_published": "2025-04-10T12:58:40.000Z",
            "content_html": "<h2 id=\"二进制高可用安装k8s集群\"><a class=\"anchor\" href=\"#二进制高可用安装k8s集群\">#</a> 二进制高可用安装 K8s 集群</h2>\n<h4 id=\"1-基本配置\"><a class=\"anchor\" href=\"#1-基本配置\">#</a> 1. 基本配置</h4>\n<h5 id=\"11-基本环境配置\"><a class=\"anchor\" href=\"#11-基本环境配置\">#</a> 1.1 基本环境配置</h5>\n<table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>IP 地址</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>k8s-master01 ~ 03</td>\n<td>192.168.1.71 ~ 73</td>\n<td>master 节点 * 3</td>\n</tr>\n<tr>\n<td>/</td>\n<td>192.168.1.70</td>\n<td>keepalived 虚拟 IP（不占用机器）</td>\n</tr>\n<tr>\n<td>k8s-node01 ~ 02</td>\n<td>192.168.1.74/75</td>\n<td>worker 节点 * 2</td>\n</tr>\n</tbody>\n</table>\n<p><em>请统一替换这些网段，Pod 网段和 service 和宿主机网段不要重复！！！</em></p>\n<table>\n<thead>\n<tr>\n<th><em><strong>* 配置信息 *</strong></em></th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>系统版本</td>\n<td>Rocky Linux 8/9</td>\n</tr>\n<tr>\n<td>Containerd</td>\n<td>latest</td>\n</tr>\n<tr>\n<td>Pod 网段</td>\n<td>172.16.0.0/16</td>\n</tr>\n<tr>\n<td>Service 网段</td>\n<td>10.96.0.0/16</td>\n</tr>\n</tbody>\n</table>\n<p><mark>所有节点</mark>更改主机名（其它节点按需修改）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hostnamectl set-hostname k8s-master01</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 hosts，修改 /etc/hosts 如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/hosts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.1.71 k8s-master01</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.1.72 k8s-master02</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">192.168</span>.1.73 k8s-master03</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">192.168</span>.1.74 k8s-node01</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">192.168</span>.1.75 k8s-node02</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 yum 源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置基础源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-i.bak</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    /etc/yum.repos.d/*.repo</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>yum makecache</pre></td></tr></table></figure><p><mark>所有节点</mark>必备工具安装：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class=\"token function\">git</span> rsyslog <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>关闭防火墙、selinux、dnsmasq、swap、开启 rsyslog。服务器配置如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> firewalld </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> dnsmasq</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>setenforce <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> rsyslog</pre></td></tr></table></figure><p><mark>所有节点</mark>关闭 swap 分区：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>swapoff <span class=\"token parameter variable\">-a</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-w</span> <span class=\"token assign-left variable\">vm.swappiness</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-ri</span> <span class=\"token string\">'/^[^#]*swap/s@^@#@'</span> /etc/fstab</pre></td></tr></table></figure><p><mark>所有节点</mark>安装 ntpdate：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> epel-release <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> dnf config-manager --set-enabled epel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> ntpsec</pre></td></tr></table></figure><p><mark>所有节点</mark>同步时间并配置上海时区：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span>/etc/timezone</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ntpdate time2.aliyun.com</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 加入到 crontab</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">crontab</span> <span class=\"token parameter variable\">-e</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 limit：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">ulimit</span> <span class=\"token parameter variable\">-SHn</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> /etc/security/limits.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 末尾添加如下内容</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>* soft nofile <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>* hard nofile <span class=\"token number\">131072</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>* soft nproc <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>* hard nproc <span class=\"token number\">655350</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>* soft memlock unlimited</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>* hard memlock unlimited</pre></td></tr></table></figure><p><mark>所有节点</mark>升级系统：</p>\n<pre><code>yum update -y\n</code></pre>\n<p><mark>Master01 节点</mark>免密钥登录其他节点，安装过程中生成配置文件和证书均在 Master01 上操作，集群管理也在 Master01 上操作：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ssh-keygen <span class=\"token parameter variable\">-t</span> rsa</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class=\"token punctuation\">;</span><span class=\"token keyword\">do</span> ssh-copy-id <span class=\"token parameter variable\">-i</span> .ssh/id_rsa.pub <span class=\"token variable\">$i</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">done</span></pre></td></tr></table></figure><p><em>注意：公有云环境，可能需要把 kubectl 放在一个非 Master 节点上</em></p>\n<p><mark>Master01 节点</mark>下载安装所有的源码文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/ <span class=\"token punctuation\">;</span> <span class=\"token function\">git</span> clone https://gitee.com/chinagei/k8s-ha-install</pre></td></tr></table></figure><h5 id=\"12-内核配置\"><a class=\"anchor\" href=\"#12-内核配置\">#</a> 1.2 内核配置</h5>\n<p><mark>所有节点</mark>安装 ipvsadm：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> ipvsadm ipset sysstat conntrack libseccomp <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置 ipvs 模块：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>modprobe -- ip_vs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>modprobe -- ip_vs_rr</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>modprobe -- ip_vs_wrr</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>modprobe -- ip_vs_sh</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>modprobe -- nf_conntrack</pre></td></tr></table></figure><p><mark>所有节点</mark>创建 ipvs.conf，并配置开机自动加载：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/modules-load.d/ipvs.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 加入以下内容</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ip_vs</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ip_vs_lc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ip_vs_wlc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ip_vs_rr</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ip_vs_wrr</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ip_vs_lblc</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ip_vs_lblcr</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ip_vs_dh</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ip_vs_sh</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ip_vs_fo</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ip_vs_nq</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ip_vs_sed</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ip_vs_ftp</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ip_vs_sh</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nf_conntrack</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ip_tables</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>ip_set</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>xt_set</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>ipt_set</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>ipt_rpfilter</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ipt_REJECT</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>ipip</pre></td></tr></table></figure><p><mark>所有节点</mark>然后执行 systemctl enable --now systemd-modules-load.service 即可（报错不用管）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> systemd-modules-load.service</pre></td></tr></table></figure><p><mark>所有节点</mark>内核优化配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /etc/sysctl.d/k8s.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.ipv4.ip_forward = 1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.bridge.bridge-nf-call-iptables = 1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables = 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>fs.may_detach_mounts = 1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>net.ipv4.conf.all.route_localnet = 1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>vm.overcommit_memory=1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>vm.panic_on_oom=0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>fs.inotify.max_user_watches=89100</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>fs.file-max=52706963</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>fs.nr_open=52706963</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>net.netfilter.nf_conntrack_max=2310720</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>net.ipv4.tcp_keepalive_time = 600</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>net.ipv4.tcp_keepalive_probes = 3</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>net.ipv4.tcp_keepalive_intvl =15</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>net.ipv4.tcp_max_tw_buckets = 36000</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>net.ipv4.tcp_tw_reuse = 1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>net.ipv4.tcp_max_orphans = 327680</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>net.ipv4.tcp_orphan_retries = 3</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net.ipv4.tcp_syncookies = 1</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>net.ipv4.tcp_max_syn_backlog = 16384</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>net.ipv4.ip_conntrack_max = 65536</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>net.ipv4.tcp_max_syn_backlog = 16384</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>net.ipv4.tcp_timestamps = 0</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>net.core.somaxconn = 16384</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p><mark>所有节点</mark>应用配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置完内核后，重启机器，之后查看内核模块是否已自动加载：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lsmod <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">--color</span><span class=\"token operator\">=</span>auto <span class=\"token parameter variable\">-e</span> ip_vs <span class=\"token parameter variable\">-e</span> nf_conntrack</pre></td></tr></table></figure><h4 id=\"2-高可用组件安装\"><a class=\"anchor\" href=\"#2-高可用组件安装\">#</a> 2. 高可用组件安装</h4>\n<p><em>注意：如果安装的不是高可用集群，haproxy 和 keepalived 无需安装</em></p>\n<p><em>注意：公有云要用公有云自带的负载均衡，比如阿里云的 SLB、NLB，腾讯云的 ELB，用来替代 haproxy 和 keepalived，因为公有云大部分都是不支持 keepalived 的。</em></p>\n<p><mark>所有 Master 节点</mark>通过 yum 安装 HAProxy 和 KeepAlived：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> keepalived haproxy <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>配置 HAProxy，需要注意黄色部分的 IP：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/haproxy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/haproxy/haproxy.cfg </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>global</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  maxconn  <span class=\"token number\">2000</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  ulimit-n  <span class=\"token number\">16384</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  log  <span class=\"token number\">127.0</span>.0.1 local0 err</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  stats <span class=\"token function\">timeout</span> 30s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>defaults</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  log global</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  mode  http</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  option  httplog</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">timeout</span> connect <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">timeout</span> client  <span class=\"token number\">50000</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">timeout</span> server  <span class=\"token number\">50000</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token function\">timeout</span> http-request 15s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">timeout</span> http-keep-alive 15s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>frontend monitor-in</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> *:33305</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  mode http</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  option httplog</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  monitor-uri /monitor</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>frontend k8s-master</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">0.0</span>.0.0:8443       <span class=\"token comment\">#HAProxy 监听端口</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">127.0</span>.0.1:8443     <span class=\"token comment\">#HAProxy 监听端口</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  mode tcp</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  option tcplog</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  tcp-request inspect-delay 5s</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  default_backend k8s-master</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>backend k8s-master</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  mode tcp</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  option tcplog</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  option tcp-check</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  balance roundrobin</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  default-server inter 10s downinter 5s rise <span class=\"token number\">2</span> fall <span class=\"token number\">2</span> slowstart 60s maxconn <span class=\"token number\">250</span> maxqueue <span class=\"token number\">256</span> weight <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  server k8s-master01\t<span class=\"token number\">192.168</span>.1.71:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  server k8s-master02\t<span class=\"token number\">192.168</span>.1.72:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  server k8s-master03\t<span class=\"token number\">192.168</span>.1.73:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>配置 KeepAlived，需要注意黄色部分的配置。</p>\n<p><mark>Master01 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/keepalived</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    state MASTER</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    interface ens160               <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.71      <span class=\"token comment\">#K8s-master01 IP 地址</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    priority <span class=\"token number\">101</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70        <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>Master02 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    interface ens160                <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.72       <span class=\"token comment\">#K8s-master02 IP 地址</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70              <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>Master03 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    interface ens160                 <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.73        <span class=\"token comment\">#K8s-master03 IP 地址</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70          <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>所有 master 节点</mark>配置 KeepAlived 健康检查文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/check_apiserver.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">k</span> <span class=\"token keyword\">in</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">seq</span> <span class=\"token number\">1</span> <span class=\"token number\">3</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token assign-left variable\">check_code</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>pgrep haproxy<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$check_code</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">expr</span> $err + <span class=\"token number\">1</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token builtin class-name\">continue</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token builtin class-name\">break</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$err</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"systemctl stop keepalived\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    /usr/bin/systemctl stop keepalived</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr></table></figure><p><mark>所有 master 节点</mark>配置健康检查文件添加执行权限：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">chmod</span> +x /etc/keepalived/check_apiserver.sh</pre></td></tr></table></figure><p><mark>所有 master 节点</mark>启动 haproxy 和 keepalived：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now haproxy</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now keepalived</span></pre></td></tr></table></figure><p>重要：如果安装了 keepalived 和 haproxy，需要测试 keepalived 是否是正常的</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>所有节点测试VIP</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ping 192.168.1.70 -c 4</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING <span class=\"token number\">192.168</span>.1.70 <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.70<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.464</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.063</span> ms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.062</span> ms</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">4</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.063</span> ms</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># telnet 192.168.1.70 16443</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Trying <span class=\"token number\">192.168</span>.1.70<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Connected to <span class=\"token number\">192.168</span>.1.70.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Escape character is <span class=\"token string\">'^]'</span><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Connection closed by foreign host.</pre></td></tr></table></figure><p>如果 ping 不通且 telnet 没有出现 ] ，则认为 VIP 不可以，不可在继续往下执行，需要排查 keepalived 的问题，比如防火墙和 selinux，haproxy 和 keepalived 的状态，监听端口等</p>\n<ul>\n<li>所有节点查看防火墙状态必须为 disable 和 inactive：systemctl status firewalld</li>\n<li>所有节点查看 selinux 状态，必须为 disable：getenforce</li>\n<li>master 节点查看 haproxy 和 keepalived 状态：systemctl status keepalived haproxy</li>\n<li>master 节点查看监听端口：netstat -lntp</li>\n</ul>\n<p>如果以上都没有问题，需要确认：</p>\n<ol>\n<li>\n<p>是否是公有云机器</p>\n</li>\n<li>\n<p>是否是私有云机器（类似 OpenStack）</p>\n</li>\n</ol>\n<p>上述公有云一般都是不支持 keepalived，私有云可能也有限制，需要和自己的私有云管理员咨询</p>\n<h4 id=\"3-runtime安装\"><a class=\"anchor\" href=\"#3-runtime安装\">#</a> 3. Runtime 安装</h4>\n<p>如果安装的版本低于 1.24，选择 Docker 和 Containerd 均可，高于 1.24 建议选择 Containerd 作为 Runtime，不再推荐使用 Docker 作为 Runtime。</p>\n<h5 id=\"31-安装containerd\"><a class=\"anchor\" href=\"#31-安装containerd\">#</a> 3.1 安装 Containerd</h5>\n<p><mark>所有节点</mark>配置安装源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class=\"token function\">git</span> <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</pre></td></tr></table></figure><p><mark>所有节点</mark>安装 docker-ce（如果在以前已经安装过，需要重新安装更新一下）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install docker-ce containerd -y</span></pre></td></tr></table></figure><p><em>可以无需启动 Docker，只需要配置和启动 Containerd 即可。</em></p>\n<p>首先配置 Containerd 所需的模块（<mark>所有节点</mark>）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>overlay</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>br_netfilter</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOF</pre></td></tr></table></figure><p><mark>所有节点</mark>加载模块：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># modprobe -- overlay</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># modprobe -- br_netfilter</span></pre></td></tr></table></figure><p><mark>所有节点</mark>，配置 Containerd 所需的内核：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.bridge.bridge-nf-call-iptables  <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.ipv4.ip_forward                 <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</pre></td></tr></table></figure><p><mark>所有节点</mark>加载内核：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># sysctl --system</span></pre></td></tr></table></figure><p><mark>所有节点</mark>生成 Containerd 的配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># mkdir -p /etc/containerd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># containerd config default | tee /etc/containerd/config.toml</span></pre></td></tr></table></figure><p><mark>所有节点</mark>更改 Containerd 的 Cgroup 和 Pause 镜像配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SystemdCgroup = false#SystemdCgroup = true#g'</span> /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr></table></figure><p><mark>所有节点</mark>启动 Containerd，并配置开机自启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now containerd</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置 crictl 客户端连接的运行时位置（可选）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat > /etc/crictl.yaml &lt;&lt;EOF</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>runtime-endpoint: unix:///run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>image-endpoint: unix:///run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>timeout: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>EOF</pre></td></tr></table></figure><h4 id=\"4-k8s及etcd安装\"><a class=\"anchor\" href=\"#4-k8s及etcd安装\">#</a> 4 . K8S 及 etcd 安装</h4>\n<p><mark>Master01</mark> 下载 kubernetes 安装包（1.32.3 需要更改为你看到的最新版本）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://dl.k8s.io/v1.32.0/kubernetes-server-linux-amd64.tar.gz</span></pre></td></tr></table></figure><p>最新版获取地址：<a href=\"https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.31.md\">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/</a></p>\n<p><mark>以下操作都在 master01 执行</mark></p>\n<p>下载 etcd 安装包：<a href=\"https://github.com/etcd-io/etcd/releases/\">https://github.com/etcd-io/etcd/releases/</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://github.com/etcd-io/etcd/releases/download/v3.5.16/etcd-v3.5.16-linux-amd64.tar.gz</span></pre></td></tr></table></figure><p>解压 kubernetes 安装文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span></pre></td></tr></table></figure><p>解压 etcd 安装文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  tar -zxvf etcd-v3.5.16-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.16-linux-amd64/etcd&#123;,ctl&#125;</span></pre></td></tr></table></figure><p>版本查看：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubelet --version</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Kubernetes v1.32.3</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># etcdctl version</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>etcdctl version: <span class=\"token number\">3.5</span>.16</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>API version: <span class=\"token number\">3.5</span></pre></td></tr></table></figure><p>将组件发送到其他节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">MasterNodes</span><span class=\"token operator\">=</span><span class=\"token string\">'k8s-master02 k8s-master03'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">WorkNodes</span><span class=\"token operator\">=</span><span class=\"token string\">'k8s-node01 k8s-node02'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$MasterNodes</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$NODE</span><span class=\"token punctuation\">;</span> <span class=\"token function\">scp</span> /usr/local/bin/kube<span class=\"token punctuation\">&#123;</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class=\"token punctuation\">&#125;</span> <span class=\"token variable\">$NODE</span>:/usr/local/bin/<span class=\"token punctuation\">;</span> <span class=\"token function\">scp</span> /usr/local/bin/etcd* <span class=\"token variable\">$NODE</span>:/usr/local/bin/<span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$WorkNodes</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>     <span class=\"token function\">scp</span> /usr/local/bin/kube<span class=\"token punctuation\">&#123;</span>let,-proxy<span class=\"token punctuation\">&#125;</span> <span class=\"token variable\">$NODE</span>:/usr/local/bin/ <span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><p><mark>Master01 节点</mark>切换到 1.32.x 分支（其他版本可以切换到其他分支，.x 即可，不需要更改为具体的小版本）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">git</span> checkout manual-installation-v1.32.x</pre></td></tr></table></figure><h4 id=\"5-生成证书\"><a class=\"anchor\" href=\"#5-生成证书\">#</a> 5 . 生成证书</h4>\n<p><em><mark>二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的</mark></em></p>\n<p><mark>Master01</mark> 下载生成证书工具（下载不成功可以去百度网盘）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> <span class=\"token string\">\"https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\"</span> <span class=\"token parameter variable\">-O</span> /usr/local/bin/cfssl</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">wget</span> <span class=\"token string\">\"https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\"</span> <span class=\"token parameter variable\">-O</span> /usr/local/bin/cfssljson</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</pre></td></tr></table></figure><h5 id=\"51-etcd证书\"><a class=\"anchor\" href=\"#51-etcd证书\">#</a> 5.1 Etcd 证书</h5>\n<p><mark>所有 Master 节点</mark>创建 etcd 证书目录：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> /etc/etcd/ssl <span class=\"token parameter variable\">-p</span></pre></td></tr></table></figure><p><mark>所有节点</mark>创建 kubernetes 相关目录：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/kubernetes/pki</pre></td></tr></table></figure><p><mark>Master01 节点</mark>生成 etcd 证书</p>\n<p>生成证书的 CSR（证书签名请求文件，配置了一些域名、公司、单位）文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/k8s-ha-install/pki</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 生成 etcd CA 证书和 CA 证书的 key</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>cfssl gencert <span class=\"token parameter variable\">-initca</span> etcd-ca-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/etcd/ssl/etcd-ca</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token parameter variable\">-hostname</span><span class=\"token operator\">=</span><span class=\"token number\">127.0</span>.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.71,192.168.1.72,192.168.1.73 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   etcd-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/etcd/ssl/etcd</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>执行结果</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> generate received request</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> \t<span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> received CSR</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> generating key: rsa-2048</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> encoded CSR</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> signed certificate with serial number     <span class=\"token number\">250230878926052708909595617022917808304837732033</span></pre></td></tr></table></figure><p>将证书复制到其他 master 节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">MasterNodes</span><span class=\"token operator\">=</span><span class=\"token string\">'k8s-master02 k8s-master03'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$MasterNodes</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token function\">ssh</span> <span class=\"token variable\">$NODE</span> <span class=\"token string\">\"mkdir -p /etc/etcd/ssl\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>       <span class=\"token function\">scp</span> /etc/etcd/ssl/<span class=\"token variable\">$&#123;FILE&#125;</span> <span class=\"token variable\">$NODE</span>:/etc/etcd/ssl/<span class=\"token variable\">$&#123;FILE&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><h5 id=\"52-k8s组件证书\"><a class=\"anchor\" href=\"#52-k8s组件证书\">#</a> 5.2 K8s 组件证书</h5>\n<p><mark>Master01</mark> 生成 kubernetes CA 证书：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/k8s-ha-install/pki</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>cfssl gencert <span class=\"token parameter variable\">-initca</span> ca-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/ca</pre></td></tr></table></figure><h6 id=\"521-apiserver证书\"><a class=\"anchor\" href=\"#521-apiserver证书\">#</a> 5.2.1 APIServer 证书</h6>\n<p>注意：10.96.0. 是 k8s service 的网段，如果说需要更改 k8s service 网段，那就需要更改 10.96.0.1</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json   <span class=\"token parameter variable\">-hostname</span><span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.1,192.168.1.70,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.1.71,192.168.1.72,192.168.1.73   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes   apiserver-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/apiserver</pre></td></tr></table></figure><p>生成 apiserver 的聚合证书：：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert   <span class=\"token parameter variable\">-initca</span> front-proxy-ca-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/front-proxy-ca </pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>cfssl gencert   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes   front-proxy-client-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/front-proxy-client</pre></td></tr></table></figure><p>返回结果（忽略警告）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> generate received request</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> received CSR</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> generating key: rsa-2048</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> encoded CSR</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> signed certificate with serial number <span class=\"token number\">597484897564859295955894546063479154194995827845</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>WARNING<span class=\"token punctuation\">]</span> This certificate lacks a <span class=\"token string\">\"hosts\"</span> field. This makes it unsuitable <span class=\"token keyword\">for</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>websites. For <span class=\"token function\">more</span> information see the Baseline Requirements <span class=\"token keyword\">for</span> the Issuance and Management</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class=\"token punctuation\">(</span>https://cabforum.org<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>specifically, section <span class=\"token number\">10.2</span>.3 <span class=\"token punctuation\">(</span><span class=\"token string\">\"Information Requirements\"</span><span class=\"token punctuation\">)</span>.</pre></td></tr></table></figure><h6 id=\"522-controllermanager\"><a class=\"anchor\" href=\"#522-controllermanager\">#</a> 5.2.2 ControllerManager</h6>\n<p>生成 controller-manage 的证书：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   manager-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/controller-manager</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>注意：修改黄色部分的IP地址</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># set-cluster：设置一个集群项，</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kubectl config set-cluster kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 设置一个环境项，一个上下文</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kubectl config set-context system:kube-controller-manager@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>system:kube-controller-manager <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># set-credentials 设置一个用户项</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kubectl config set-credentials system:kube-controller-manager <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>     --client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/controller-manager.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     --client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># 使用某个环境当做默认环境</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>kubectl config use-context system:kube-controller-manager@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig</pre></td></tr></table></figure><h6 id=\"523-scheduler证书\"><a class=\"anchor\" href=\"#523-scheduler证书\">#</a> 5.2.3 Scheduler 证书</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   scheduler-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/scheduler</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>注意：修改黄色部分的IP地址</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kubectl config set-cluster kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kubectl config set-credentials system:kube-scheduler <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     --client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/scheduler.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     --client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/scheduler-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kubectl config set-context system:kube-scheduler@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>     <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>system:kube-scheduler <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>kubectl config use-context system:kube-scheduler@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr></table></figure><h6 id=\"524-生成管理员证书\"><a class=\"anchor\" href=\"#524-生成管理员证书\">#</a> 5.2.4 生成管理员证书</h6>\n<p>Kubectl /etc/Kubernetes/admin.conf ~/.kube/config</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   admin-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/admin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>注意：修改黄色部分的IP</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kubectl config set-cluster kubernetes     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class=\"token operator\">=</span>true     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.kubeconfig</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kubectl config set-credentials kubernetes-admin     --client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/admin.pem     --client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/admin-key.pem     --embed-certs<span class=\"token operator\">=</span>true     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.kubeconfig</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>kubectl config set-context kubernetes-admin@kubernetes     <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes     <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>kubernetes-admin     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.kubeconfig</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kubectl config use-context kubernetes-admin@kubernetes     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.kubeconfig</pre></td></tr></table></figure><h6 id=\"525-创建serviceaccount证书\"><a class=\"anchor\" href=\"#525-创建serviceaccount证书\">#</a> 5.2.5 创建 ServiceAccount 证书</h6>\n<p>创建一对公钥，用来签发 ServiceAccount 的 Token：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl genrsa <span class=\"token parameter variable\">-out</span> /etc/kubernetes/pki/sa.key <span class=\"token number\">2048</span></pre></td></tr></table></figure><p>返回结果：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Generating RSA private key, <span class=\"token number\">2048</span> bit long modulus <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> primes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.+++++</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.+++++</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>e is <span class=\"token number\">65537</span> <span class=\"token punctuation\">(</span>0x010001<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl rsa <span class=\"token parameter variable\">-in</span> /etc/kubernetes/pki/sa.key <span class=\"token parameter variable\">-pubout</span> <span class=\"token parameter variable\">-out</span> /etc/kubernetes/pki/sa.pub</pre></td></tr></table></figure><p>发送证书至其他节点：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> k8s-master02 k8s-master03<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ls</span> /etc/kubernetes/pki <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> etcd<span class=\"token variable\">)</span></span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">scp</span> /etc/kubernetes/pki/<span class=\"token variable\">$&#123;FILE&#125;</span> <span class=\"token variable\">$NODE</span>:/etc/kubernetes/pki/<span class=\"token variable\">$&#123;FILE&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">done</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">scp</span> /etc/kubernetes/<span class=\"token variable\">$&#123;FILE&#125;</span> <span class=\"token variable\">$NODE</span>:/etc/kubernetes/<span class=\"token variable\">$&#123;FILE&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">done</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr></table></figure><p>查看证书文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls /etc/kubernetes/pki/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>admin.csr      apiserver.csr      ca.csr      controller-manager.csr      front-proxy-ca.csr      front-proxy-client.csr      sa.key         scheduler-key.pem</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>admin-key.pem  apiserver-key.pem  ca-key.pem  controller-manager-key.pem  front-proxy-ca-key.pem  front-proxy-client-key.pem  sa.pub         scheduler.pem</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>admin.pem      apiserver.pem      ca.pem      controller-manager.pem      front-proxy-ca.pem      front-proxy-client.pem      scheduler.csr</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls /etc/kubernetes/pki/ |wc -l</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">23</span></pre></td></tr></table></figure><h4 id=\"6-kubernetes组件配置\"><a class=\"anchor\" href=\"#6-kubernetes组件配置\">#</a> 6. Kubernetes 组件配置</h4>\n<h5 id=\"61-ecd配置\"><a class=\"anchor\" href=\"#61-ecd配置\">#</a> 6.1 Ecd 配置</h5>\n<p>Etcd 配置大致相同，注意修改每个 Master 节点的 etcd 配置的主机名和 IP 地址</p>\n<h6 id=\"611-master01\"><a class=\"anchor\" href=\"#611-master01\">#</a> 6.1.1 Master01</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/etcd/etcd.config.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name: <span class=\"token string\">'k8s-master01'</span>     <span class=\"token comment\"># k8s-master01 名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data-dir: /var/lib/etcd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>wal-dir: /var/lib/etcd/wal</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>snapshot-count: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>heartbeat-interval: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>election-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>quota-backend-bytes: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>listen-peer-urls: <span class=\"token string\">'https://192.168.1.71:2380'</span>            <span class=\"token comment\"># k8s-master01 IP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>listen-client-urls: <span class=\"token string\">'https://192.168.1.71:2379,http://127.0.0.1:2379'</span>   <span class=\"token comment\"># k8s-master01 IP</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>max-snapshots: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>max-wals: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>cors:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>initial-advertise-peer-urls: <span class=\"token string\">'https://192.168.1.71:2380'</span>  <span class=\"token comment\"># k8s-master01 IP</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>advertise-client-urls: <span class=\"token string\">'https://192.168.1.71:2379'</span>        <span class=\"token comment\"># k8s-master01 IP</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>discovery:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>discovery-fallback: <span class=\"token string\">'proxy'</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>discovery-proxy:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>discovery-srv:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>initial-cluster: <span class=\"token string\">'k8s-master01=https://192.168.1.71:2380,k8s-master02=https://192.168.1.72:2380,k8s-master03=https://192.168.1.73:2380'</span>     <span class=\"token comment\"># k8s-master01、k8s-master02、k8s-master03 IP </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>initial-cluster-token: <span class=\"token string\">'etcd-k8s-cluster'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>initial-cluster-state: <span class=\"token string\">'new'</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>strict-reconfig-check: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>enable-v2: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>enable-pprof: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy: <span class=\"token string\">'off'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy-failure-wait: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy-refresh-interval: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy-dial-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy-write-timeout: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy-read-timeout: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>client-transport-security:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>peer-transport-security:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  peer-client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>log-package-levels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>log-outputs: <span class=\"token punctuation\">[</span>default<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>force-new-cluster: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"612-master02\"><a class=\"anchor\" href=\"#612-master02\">#</a> 6.1.2 Master02</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/etcd/etcd.config.yml\t</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name: <span class=\"token string\">'k8s-master02'</span>   <span class=\"token comment\"># k8s-master02 名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data-dir: /var/lib/etcd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>wal-dir: /var/lib/etcd/wal</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>snapshot-count: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>heartbeat-interval: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>election-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>quota-backend-bytes: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>listen-peer-urls: <span class=\"token string\">'https://192.168.1.72:2380'</span>      <span class=\"token comment\"># k8s-master02 IP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>listen-client-urls: <span class=\"token string\">'https://192.168.1.72:2379,http://127.0.0.1:2379'</span>    <span class=\"token comment\"># k8s-master02 IP</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>max-snapshots: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>max-wals: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>cors:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>initial-advertise-peer-urls: <span class=\"token string\">'https://192.168.1.72:2380'</span>    <span class=\"token comment\"># k8s-master02 IP</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>advertise-client-urls: <span class=\"token string\">'https://192.168.1.72:2379'</span>     <span class=\"token comment\"># k8s-master02 IP</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>discovery:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>discovery-fallback: <span class=\"token string\">'proxy'</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>discovery-proxy:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>discovery-srv:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>initial-cluster: <span class=\"token string\">'k8s-master01=https://192.168.1.71:2380,k8s-master02=https://192.168.1.72:2380,k8s-master03=https://192.168.1.73:2380'</span>             <span class=\"token comment\"># k8s-master01、k8s-master02、k8s-master03 IP </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>initial-cluster-token: <span class=\"token string\">'etcd-k8s-cluster'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>initial-cluster-state: <span class=\"token string\">'new'</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>strict-reconfig-check: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>enable-v2: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>enable-pprof: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy: <span class=\"token string\">'off'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy-failure-wait: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy-refresh-interval: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy-dial-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy-write-timeout: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy-read-timeout: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>client-transport-security:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>peer-transport-security:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  peer-client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>log-package-levels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>log-outputs: <span class=\"token punctuation\">[</span>default<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>force-new-cluster: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"613-master03\"><a class=\"anchor\" href=\"#613-master03\">#</a> 6.1.3 Master03</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/etcd/etcd.config.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name: <span class=\"token string\">'k8s-master03'</span>           <span class=\"token comment\"># k8s-master03 名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data-dir: /var/lib/etcd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>wal-dir: /var/lib/etcd/wal</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>snapshot-count: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>heartbeat-interval: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>election-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>quota-backend-bytes: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>listen-peer-urls: <span class=\"token string\">'https://192.168.1.73:2380'</span>           <span class=\"token comment\"># k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>listen-client-urls: <span class=\"token string\">'https://192.168.1.73:2379,http://127.0.0.1:2379'</span>       <span class=\"token comment\"># k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>max-snapshots: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>max-wals: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>cors:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>initial-advertise-peer-urls: <span class=\"token string\">'https://192.168.1.73:2380'</span>      <span class=\"token comment\"># k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>advertise-client-urls: <span class=\"token string\">'https://192.168.1.73:2379'</span>            <span class=\"token comment\"># k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>discovery:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>discovery-fallback: <span class=\"token string\">'proxy'</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>discovery-proxy:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>discovery-srv:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>initial-cluster: <span class=\"token string\">'k8s-master01=https://192.168.1.71:2380,k8s-master02=https://192.168.1.72:2380,k8s-master03=https://192.168.1.73:2380'</span>                <span class=\"token comment\"># k8s-master01、k8s-master02、k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>initial-cluster-token: <span class=\"token string\">'etcd-k8s-cluster'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>initial-cluster-state: <span class=\"token string\">'new'</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>strict-reconfig-check: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>enable-v2: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>enable-pprof: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy: <span class=\"token string\">'off'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy-failure-wait: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy-refresh-interval: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy-dial-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy-write-timeout: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy-read-timeout: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>client-transport-security:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>peer-transport-security:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  peer-client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>log-package-levels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>log-outputs: <span class=\"token punctuation\">[</span>default<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>force-new-cluster: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"614-启动etcd\"><a class=\"anchor\" href=\"#614-启动etcd\">#</a> 6.1.4 启动 Etcd</h6>\n<p><mark>所有 Master 节点</mark>创建 etcd service 并启动</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /usr/lib/systemd/system/etcd.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Etcd Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://coreos.com/etcd/docs/latest/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>notify</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/etcd --config-file<span class=\"token operator\">=</span>/etc/etcd/etcd.config.yml</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>on-failure</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">LimitNOFILE</span><span class=\"token operator\">=</span><span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">Alias</span><span class=\"token operator\">=</span>etcd3.service</pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>创建 etcd 的证书目录：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> /etc/kubernetes/pki/etcd</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> etcd</pre></td></tr></table></figure><p>查看 etcd 状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ETCDCTL_API</span><span class=\"token operator\">=</span><span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>etcdctl <span class=\"token parameter variable\">--endpoints</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.1.73:2379,192.168.1.72:2379,192.168.1.71:2379\"</span> <span class=\"token parameter variable\">--cacert</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem <span class=\"token parameter variable\">--cert</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/etcd/etcd.pem <span class=\"token parameter variable\">--key</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out<span class=\"token operator\">=</span>table</pre></td></tr></table></figure><h5 id=\"62-apiserver配置\"><a class=\"anchor\" href=\"#62-apiserver配置\">#</a> 6.2 APIServer 配置</h5>\n<h6 id=\"621-master01\"><a class=\"anchor\" href=\"#621-master01\">#</a> 6.2.1 Master01</h6>\n<p>注意：本文档使用的 k8s service 网段为 10.96.0.0/16，该网段不能和宿主机的网段、Pod 网段的重复，请按需修改：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /usr/lib/systemd/system/kube-apiserver.service </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes API Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-apiserver <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --allow-privileged<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --bind-address<span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      --secure-port<span class=\"token operator\">=</span><span class=\"token number\">6443</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      --advertise-address<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.71 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      --service-cluster-ip-range<span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.0/16  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      --service-node-port-range<span class=\"token operator\">=</span><span class=\"token number\">30000</span>-32767  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      --etcd-servers<span class=\"token operator\">=</span>https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      --etcd-cafile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      --etcd-certfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      --etcd-keyfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      --client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      --tls-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      --tls-private-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      --kubelet-client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      --kubelet-client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      --service-account-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.pub  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      --service-account-signing-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.key  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      --service-account-issuer<span class=\"token operator\">=</span>https://kubernetes.default.svc.cluster.local <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      --kubelet-preferred-address-types<span class=\"token operator\">=</span>InternalIP,ExternalIP,Hostname  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      --enable-admission-plugins<span class=\"token operator\">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      --authorization-mode<span class=\"token operator\">=</span>Node,RBAC  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      --enable-bootstrap-token-auth<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      --requestheader-client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      --proxy-client-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      --proxy-client-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      --requestheader-allowed-names<span class=\"token operator\">=</span>aggregator  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      --requestheader-group-headers<span class=\"token operator\">=</span>X-Remote-Group  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      --requestheader-extra-headers-prefix<span class=\"token operator\">=</span>X-Remote-Extra-  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      --requestheader-username-headers<span class=\"token operator\">=</span>X-Remote-User</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token comment\"># --token-auth-file=/etc/kubernetes/token.csv</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>on-failure</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token assign-left variable\">LimitNOFILE</span><span class=\"token operator\">=</span><span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><h6 id=\"622-master02\"><a class=\"anchor\" href=\"#622-master02\">#</a> 6.2.2 Master02</h6>\n<p>注意：本文档使用的 k8s service 网段为 10.96.0.0/16，该网段不能和宿主机的网段、Pod 网段的重复，请按需修改：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim  /usr/lib/systemd/system/kube-apiserver.service </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes API Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-apiserver <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --allow-privileged<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --bind-address<span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      --secure-port<span class=\"token operator\">=</span><span class=\"token number\">6443</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      --advertise-address<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.72 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      --service-cluster-ip-range<span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.0/16  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      --service-node-port-range<span class=\"token operator\">=</span><span class=\"token number\">30000</span>-32767  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      --etcd-servers<span class=\"token operator\">=</span>https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      --etcd-cafile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      --etcd-certfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      --etcd-keyfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      --client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      --tls-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      --tls-private-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      --kubelet-client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      --kubelet-client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      --service-account-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.pub  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      --service-account-signing-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.key  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      --service-account-issuer<span class=\"token operator\">=</span>https://kubernetes.default.svc.cluster.local <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      --kubelet-preferred-address-types<span class=\"token operator\">=</span>InternalIP,ExternalIP,Hostname  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      --enable-admission-plugins<span class=\"token operator\">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      --authorization-mode<span class=\"token operator\">=</span>Node,RBAC  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      --enable-bootstrap-token-auth<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      --requestheader-client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      --proxy-client-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      --proxy-client-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      --requestheader-allowed-names<span class=\"token operator\">=</span>aggregator  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      --requestheader-group-headers<span class=\"token operator\">=</span>X-Remote-Group  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      --requestheader-extra-headers-prefix<span class=\"token operator\">=</span>X-Remote-Extra-  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      --requestheader-username-headers<span class=\"token operator\">=</span>X-Remote-User</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>on-failure</pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">LimitNOFILE</span><span class=\"token operator\">=</span><span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><h6 id=\"623-master03\"><a class=\"anchor\" href=\"#623-master03\">#</a> 6.2.3 Master03</h6>\n<p>注意：本文档使用的 k8s service 网段为 10.96.0.0/16，该网段不能和宿主机的网段、Pod 网段的重复，请按需修改：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim  /usr/lib/systemd/system/kube-apiserver.service </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes API Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-apiserver <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --allow-privileged<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --bind-address<span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      --secure-port<span class=\"token operator\">=</span><span class=\"token number\">6443</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      --advertise-address<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.73 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      --service-cluster-ip-range<span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.0/16  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      --service-node-port-range<span class=\"token operator\">=</span><span class=\"token number\">30000</span>-32767  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      --etcd-servers<span class=\"token operator\">=</span>https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      --etcd-cafile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      --etcd-certfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      --etcd-keyfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      --client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      --tls-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      --tls-private-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      --kubelet-client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      --kubelet-client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      --service-account-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.pub  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      --service-account-signing-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.key  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      --service-account-issuer<span class=\"token operator\">=</span>https://kubernetes.default.svc.cluster.local <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      --kubelet-preferred-address-types<span class=\"token operator\">=</span>InternalIP,ExternalIP,Hostname  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      --enable-admission-plugins<span class=\"token operator\">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      --authorization-mode<span class=\"token operator\">=</span>Node,RBAC  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      --enable-bootstrap-token-auth<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      --requestheader-client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      --proxy-client-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      --proxy-client-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      --requestheader-allowed-names<span class=\"token operator\">=</span>aggregator  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      --requestheader-group-headers<span class=\"token operator\">=</span>X-Remote-Group  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      --requestheader-extra-headers-prefix<span class=\"token operator\">=</span>X-Remote-Extra-  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      --requestheader-username-headers<span class=\"token operator\">=</span>X-Remote-User</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token comment\"># --token-auth-file=/etc/kubernetes/token.csv</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>on-failure</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token assign-left variable\">LimitNOFILE</span><span class=\"token operator\">=</span><span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><h6 id=\"624-启动apiserver\"><a class=\"anchor\" href=\"#624-启动apiserver\">#</a> 6.2.4 启动 apiserver</h6>\n<p><mark>所有 Master 节点</mark>开启 kube-apiserver：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl daemon-reload <span class=\"token operator\">&amp;&amp;</span> systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> kube-apiserver</pre></td></tr></table></figure><p>检测 kube-server 状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl status kube-apiserver</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>● kube-apiserver.service – Kubernetes API Server</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   Loaded: loaded <span class=\"token punctuation\">(</span>/usr/lib/systemd/system/kube-apiserver.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: disabled<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Sat <span class=\"token number\">2020</span>-08-22 <span class=\"token number\">21</span>:26:49 CST<span class=\"token punctuation\">;</span> 26s ago</pre></td></tr></table></figure><p>如果系统日志有这些提示可以忽略:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Dec <span class=\"token number\">11</span> <span class=\"token number\">20</span>:51:15 k8s-master01 kube-apiserver: I1211 <span class=\"token number\">20</span>:51:15.004739    <span class=\"token number\">7450</span> clientconn.go:948<span class=\"token punctuation\">]</span> ClientConn switching balancer to “pick_first”</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Dec <span class=\"token number\">11</span> <span class=\"token number\">20</span>:51:15 k8s-master01 kube-apiserver: I1211 <span class=\"token number\">20</span>:51:15.004843    <span class=\"token number\">7450</span> balancer_conn_wrappers.go:78<span class=\"token punctuation\">]</span> pickfirstBalancer: HandleSubConnStateChange: 0xc011bd4c80, <span class=\"token punctuation\">&#123;</span>CONNECTING <span class=\"token operator\">&lt;</span>nil<span class=\"token operator\">></span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Dec <span class=\"token number\">11</span> <span class=\"token number\">20</span>:51:15 k8s-master01 kube-apiserver: I1211 <span class=\"token number\">20</span>:51:15.010725    <span class=\"token number\">7450</span> balancer_conn_wrappers.go:78<span class=\"token punctuation\">]</span> pickfirstBalancer: HandleSubConnStateChange: 0xc011bd4c80, <span class=\"token punctuation\">&#123;</span>READY <span class=\"token operator\">&lt;</span>nil<span class=\"token operator\">></span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Dec <span class=\"token number\">11</span> <span class=\"token number\">20</span>:51:15 k8s-master01 kube-apiserver: I1211 <span class=\"token number\">20</span>:51:15.011370    <span class=\"token number\">7450</span> controlbuf.go:508<span class=\"token punctuation\">]</span> transport: loopyWriter.run returning. Connection error: desc <span class=\"token operator\">=</span> “transport is closing”</pre></td></tr></table></figure><h5 id=\"63-controllermanage\"><a class=\"anchor\" href=\"#63-controllermanage\">#</a> 6.3 ControllerManage</h5>\n<p><mark>所有 Master 节点</mark>配置 kube-controller-manager service（所有 master 节点配置一样）</p>\n<p>注意：本文档使用的 k8s Pod 网段为 172.16.0.0/16，该网段不能和宿主机的网段、k8s Service 网段的重复，请按需修改：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /usr/lib/systemd/system/kube-controller-manager.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes Controller Manager</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-controller-manager <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      --root-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --cluster-signing-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --cluster-signing-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      --service-account-private-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.key <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      --authentication-kubeconfig<span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      --authorization-kubeconfig<span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      --leader-elect<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      --use-service-account-credentials<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      --node-monitor-grace-period<span class=\"token operator\">=</span>40s <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      --node-monitor-period<span class=\"token operator\">=</span>5s <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token parameter variable\">--controllers</span><span class=\"token operator\">=</span>*,bootstrapsigner,tokencleaner <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      --allocate-node-cidrs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      --cluster-cidr<span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.0.0/16 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      --requestheader-client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      --node-cidr-mask-size<span class=\"token operator\">=</span><span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>启动 kube-controller-manager</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now kube-controller-manager</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Created symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service → /usr/lib/systemd/system/kube-controller-manager.service.</pre></td></tr></table></figure><p>查看启动状态</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl  status kube-controller-manager</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>● kube-controller-manager.service – Kubernetes Controller Manager</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   Loaded: loaded <span class=\"token punctuation\">(</span>/usr/lib/ ubern/system/kube-controller-manager.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: disabled<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Fri <span class=\"token number\">2020</span>-12-11 <span class=\"token number\">20</span>:53:05 CST<span class=\"token punctuation\">;</span> 8s ago</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     Docs: https://github.com/  ubernetes/  ubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> Main PID: <span class=\"token number\">7518</span> <span class=\"token punctuation\">(</span>kube-controller<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h5 id=\"64-scheduler\"><a class=\"anchor\" href=\"#64-scheduler\">#</a> 6.4 Scheduler</h5>\n<p>所有 Master 节点配置 kube-scheduler service（所有 master 节点配置一样）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /usr/lib/systemd/system/kube-scheduler.service </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes Scheduler</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-scheduler <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      --leader-elect<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --authentication-kubeconfig<span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --authorization-kubeconfig<span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><p>启动 scheduler：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now kube-scheduler</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Created symlink /etc/systemd/system/multi-user.target.wants/kube-scheduler.service → /usr/lib/systemd/system/kube-scheduler.service.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl status kube-scheduler</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>● kube-scheduler.service - Kubernetes Scheduler</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   Loaded: loaded <span class=\"token punctuation\">(</span>/usr/lib/systemd/system/kube-scheduler.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: disabled<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Wed <span class=\"token number\">2022</span>-05-04 <span class=\"token number\">17</span>:31:13 CST<span class=\"token punctuation\">;</span> 6s ago</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     Docs: https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> Main PID: <span class=\"token number\">5815</span> <span class=\"token punctuation\">(</span>kube-scheduler<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    Tasks: <span class=\"token number\">9</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   Memory: <span class=\"token number\">19</span>.8M</pre></td></tr></table></figure><h4 id=\"7-tls-bootstrapping配置\"><a class=\"anchor\" href=\"#7-tls-bootstrapping配置\">#</a> 7. TLS Bootstrapping 配置</h4>\n<p>只需要在<mark> Master01</mark> 创建 bootstrap</p>\n<p>注意： 修改黄色部分的 IP 地址</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/bootstrap</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl config set-cluster kubernetes     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class=\"token operator\">=</span>true     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kubectl config set-credentials tls-bootstrap-token-user     <span class=\"token parameter variable\">--token</span><span class=\"token operator\">=</span>c8ad9c.2e4d610cf3e7426e <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kubectl config set-context tls-bootstrap-token-user@kubernetes     <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes     <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>tls-bootstrap-token-user     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kubectl config use-context tls-bootstrap-token-user@kubernetes     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span></pre></td></tr></table></figure><p>可以正常查询集群状态，才可以继续往下，否则不行，需要排查 k8s 组件是否有故障（只要有结果即可，如果返回不一样不影响）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get cs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Warning: v1 ComponentStatus is deprecated <span class=\"token keyword\">in</span> v1.19+</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                 STATUS    MESSAGE   ERROR</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>controller-manager   Healthy   ok        </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>scheduler            Healthy   ok        </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>etcd-0               Healthy   ok</pre></td></tr></table></figure><p>创建 bootstrap 相关资源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f bootstrap.secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>secret/bootstrap-token-c8ad9c created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</pre></td></tr></table></figure><h4 id=\"8-node节点配置\"><a class=\"anchor\" href=\"#8-node节点配置\">#</a> 8. Node 节点配置</h4>\n<h5 id=\"81-复制证书\"><a class=\"anchor\" href=\"#81-复制证书\">#</a> 8.1 复制证书</h5>\n<p><mark>Master01 节点</mark>复制证书至其他节点：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /etc/kubernetes/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token function\">ssh</span> <span class=\"token variable\">$NODE</span> <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/kubernetes/pki</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>       <span class=\"token function\">scp</span> /etc/kubernetes/<span class=\"token variable\">$FILE</span> <span class=\"token variable\">$NODE</span>:/etc/kubernetes/<span class=\"token variable\">$&#123;FILE&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><p>执行结果：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ca.pem                                                                                                                                                                         <span class=\"token number\">100</span>% <span class=\"token number\">1407</span>   <span class=\"token number\">459</span>.5KB/s   00:00    </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>…</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>bootstrap-kubelet.kubeconfig                                                                                                                                                   <span class=\"token number\">100</span>% <span class=\"token number\">2291</span>   <span class=\"token number\">685</span>.4KB/s   00:00</pre></td></tr></table></figure><h5 id=\"82-kubelet配置\"><a class=\"anchor\" href=\"#82-kubelet配置\">#</a> 8.2 Kubelet 配置</h5>\n<p><mark>所有节点</mark>创建 Kubelet 配置目录</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 kubelet service</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim  /usr/lib/systemd/system/kubelet.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes Kubelet</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kubelet</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">StartLimitInterval</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 kubelet service 的配置文件（也可以写到 kubelet.service）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Runtime 为 Containerd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"KUBELET_SYSTEM_ARGS=--container-runtime-endpoint=unix:///run/containerd/containerd.sock\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' \"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kubelet <span class=\"token variable\">$KUBELET_KUBECONFIG_ARGS</span> <span class=\"token variable\">$KUBELET_CONFIG_ARGS</span> <span class=\"token variable\">$KUBELET_SYSTEM_ARGS</span> <span class=\"token variable\">$KUBELET_EXTRA_ARGS</span></pre></td></tr></table></figure><p><mark>所有节点</mark>创建 kubelet 的配置文件</p>\n<p><em>注意：如果更改了 k8s 的 service 网段，需要更改 kubelet-conf.yml 的 clusterDNS: 配置，改成 k8s Service 网段的第十个地址，比如 10.96.0.10</em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/kubernetes/kubelet-conf.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: kubelet.config.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: KubeletConfiguration</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>address: <span class=\"token number\">0.0</span>.0.0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>port: <span class=\"token number\">10250</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>readOnlyPort: <span class=\"token number\">10255</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>authentication:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  anonymous:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  webhook:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    cacheTTL: 2m0s</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  x509:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    clientCAFile: /etc/kubernetes/pki/ca.pem</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>authorization:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  mode: Webhook</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  webhook:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    cacheAuthorizedTTL: 5m0s</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    cacheUnauthorizedTTL: 30s</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>cgroupDriver: systemd</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>cgroupsPerQOS: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>clusterDNS:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>- <span class=\"token number\">10.96</span>.0.10</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>clusterDomain: cluster.local</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>containerLogMaxFiles: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>containerLogMaxSize: 10Mi</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>contentType: application/vnd.kubernetes.protobuf</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>cpuCFSQuota: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>cpuManagerPolicy: none</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>cpuManagerReconcilePeriod: 10s</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>enableControllerAttachDetach: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>enableDebuggingHandlers: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>enforceNodeAllocatable:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>- pods</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>eventBurst: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>eventRecordQPS: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>evictionHard:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  imagefs.available: <span class=\"token number\">15</span>%</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  memory.available: 100Mi</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  nodefs.available: <span class=\"token number\">10</span>%</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  nodefs.inodesFree: <span class=\"token number\">5</span>%</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>evictionPressureTransitionPeriod: 5m0s</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>failSwapOn: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>fileCheckFrequency: 20s</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>hairpinMode: promiscuous-bridge</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>healthzBindAddress: <span class=\"token number\">127.0</span>.0.1</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>healthzPort: <span class=\"token number\">10248</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>httpCheckFrequency: 20s</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>imageGCHighThresholdPercent: <span class=\"token number\">85</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>imageGCLowThresholdPercent: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>imageMinimumGCAge: 2m0s</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>iptablesDropBit: <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>iptablesMasqueradeBit: <span class=\"token number\">14</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>kubeAPIBurst: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>kubeAPIQPS: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>makeIPTablesUtilChains: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>maxOpenFiles: <span class=\"token number\">1000000</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>maxPods: <span class=\"token number\">110</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>nodeStatusUpdateFrequency: 10s</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>oomScoreAdj: <span class=\"token parameter variable\">-999</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>podPidsLimit: <span class=\"token parameter variable\">-1</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>registryBurst: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>registryPullQPS: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>resolvConf: /etc/resolv.conf</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>rotateCertificates: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>runtimeRequestTimeout: 2m0s</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>serializeImagePulls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>staticPodPath: /etc/kubernetes/manifests</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>streamingConnectionIdleTimeout: 4h0m0s</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>syncFrequency: 1m0s</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>volumeStatsAggPeriod: 1m0s</pre></td></tr></table></figure><p>启动<mark>所有节点</mark> kubelet</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> kubelet</pre></td></tr></table></figure><p>此时系统日志 /var/log/messages**** 显示只有如下两种信息为正常 ****，安装 calico 后即可恢复</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Unable to update cni config: no networks found <span class=\"token keyword\">in</span> /etc/cni/net.d</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pE2ZkVK\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/10/pE2ZkVK.png\" alt=\"pE2ZkVK.png\" /></a></p>\n<p><em>如果有很多报错日志，或者有大量看不懂的报错，说明 kubelet 的配置有误，需要检查 kubelet 配置</em></p>\n<p>Master01 查看集群状态 (Ready 或 NotReady 都正常)</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get node</span></pre></td></tr></table></figure><h5 id=\"83-kube-proxy配置\"><a class=\"anchor\" href=\"#83-kube-proxy配置\">#</a> 8.3 kube-proxy 配置</h5>\n<p><em>注意，如果不是高可用集群，192.168.1.70:8443 改为 master01 的地址，8443 改为 apiserver 的端口，默认是 6443</em></p>\n<p>生成 kube-proxy 的证书，以下操作只在<mark> Master01</mark> 执行</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/pki</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   kube-proxy-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/kube-proxy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kubectl config set-cluster kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kubectl config set-credentials system:kube-proxy <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     --client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/kube-proxy.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     --client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/kube-proxy-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kubectl config set-context system:kube-proxy@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>     <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>system:kube-proxy <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>kubectl config use-context system:kube-proxy@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr></table></figure><p>将 kubeconfig 发送至其他节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> k8s-master02 k8s-master03<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>     <span class=\"token function\">scp</span> /etc/kubernetes/kube-proxy.kubeconfig  <span class=\"token variable\">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> k8s-node01 k8s-node02<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     <span class=\"token function\">scp</span> /etc/kubernetes/kube-proxy.kubeconfig <span class=\"token variable\">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><p><mark>所有节点</mark>添加 kube-proxy 的配置和 service 文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /usr/lib/systemd/system/kube-proxy.service</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes Kube Proxy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-proxy <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.yaml <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><p>如果更改了集群 Pod 的网段，需要更改 kube-proxy.yaml 的 clusterCIDR 为自己的 Pod 网段：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/kubernetes/kube-proxy.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: kubeproxy.config.k8s.io/v1alpha1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>bindAddress: <span class=\"token number\">0.0</span>.0.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clientConnection:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  acceptContentTypes: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  burst: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  contentType: application/vnd.kubernetes.protobuf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  qps: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>clusterCIDR: <span class=\"token number\">172.16</span>.0.0/16 </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>configSyncPeriod: 15m0s</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>conntrack:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  max: null</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  maxPerCore: <span class=\"token number\">32768</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  min: <span class=\"token number\">131072</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  tcpCloseWaitTimeout: 1h0m0s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  tcpEstablishedTimeout: 24h0m0s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>enableProfiling: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>healthzBindAddress: <span class=\"token number\">0.0</span>.0.0:10256</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>hostnameOverride: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>iptables:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  masqueradeAll: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  masqueradeBit: <span class=\"token number\">14</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  minSyncPeriod: 0s</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  syncPeriod: 30s</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>ipvs:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  masqueradeAll: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  minSyncPeriod: 5s</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  scheduler: <span class=\"token string\">\"rr\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  syncPeriod: 30s</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>kind: KubeProxyConfiguration</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>metricsBindAddress: <span class=\"token number\">127.0</span>.0.1:10249</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>mode: <span class=\"token string\">\"ipvs\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>nodePortAddresses: null</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>oomScoreAdj: <span class=\"token parameter variable\">-999</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>portRange: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>udpIdleTimeout: 250ms</pre></td></tr></table></figure><p><mark>所有节点</mark>启动 kube-proxy</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now kube-proxy</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Created symlink /etc/systemd/system/multi-user.target.wants/kube-proxy.service → /usr/lib/systemd/system/kube-proxy.service.</pre></td></tr></table></figure><p>此时系统日志 /var/log/messages**** 显示只有如下两种信息为正常 ****，安装 calico 后即可恢复</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Unable to update cni config: no networks found <span class=\"token keyword\">in</span> /etc/cni/net.d</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pE2ZkVK\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/10/pE2ZkVK.png\" alt=\"pE2ZkVK.png\" /></a></p>\n<h4 id=\"9-calico组件的安装\"><a class=\"anchor\" href=\"#9-calico组件的安装\">#</a> 9. Calico 组件的安装</h4>\n<p>以下步骤只在 master01 执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/calico/</pre></td></tr></table></figure><p>更改 calico 的网段，主要需要将红色部分的网段，改为自己的 Pod 网段</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#POD_CIDR#172.16.0.0/16#g\"</span> calico.yaml</pre></td></tr></table></figure><p><em>检查网段是自己的 Pod 网段， grep &quot;IPV4POOL_CIDR&quot; calico.yaml  -A 1</em></p>\n<p>查看容器和节点状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 calico<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get po -n kube-system</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                                       READY   STATUS    RESTARTS      AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>calico-kube-controllers-66686fdb54-mk2g6   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>20s ago<span class=\"token punctuation\">)</span>   85s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>calico-node-8fxqp                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             85s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>calico-node-8nkfl                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             86s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>calico-node-pmpf4                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             86s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>calico-node-vnlk7                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             86s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>calico-node-xpchb                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             85s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>calico-typha-67c6dc57d6-259t8              <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             86s</pre></td></tr></table></figure><p><em>如果容器状态异常可以使用 kubectl describe 或者 kubectl logs 查看容器的日志</em></p>\n<ol>\n<li>Kubectl logs -f POD_NAME -n kube-system</li>\n<li>Kubectl logs -f POD_NAME -c upgrade-ipam -n kube-system</li>\n</ol>\n<h4 id=\"10-安装coredns\"><a class=\"anchor\" href=\"#10-安装coredns\">#</a> 10. 安装 CoreDNS</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/</pre></td></tr></table></figure><p>如果更改了 k8s service 的网段需要将 coredns 的 serviceIP 改成 k8s service 网段的第十个 IP</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">COREDNS_SERVICE_IP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span>kubectl get svc <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> kubernetes <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;print $3&#125;'</span><span class=\"token variable\">`</span></span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#KUBEDNS_SERVICE_IP#<span class=\"token variable\">$&#123;COREDNS_SERVICE_IP&#125;</span>#g\"</span> CoreDNS/coredns.yaml</pre></td></tr></table></figure><p>安装 coredns</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  create -f CoreDNS/coredns.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>serviceaccount/coredns created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:coredns created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>configmap/coredns created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>deployment.apps/coredns created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>service/kube-dns created</pre></td></tr></table></figure><h4 id=\"11-metrics部署\"><a class=\"anchor\" href=\"#11-metrics部署\">#</a> 11. Metrics 部署</h4>\n<p>在新版的 Kubernetes 中系统资源的采集均使用 Metrics-server，可以通过 Metrics 采集节点和 Pod 的内存、磁盘、CPU 和网络的使用率。</p>\n<p>以下操作均在<mark> master01 节点</mark>执行，安装 metrics server:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/metrics-server</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl  create <span class=\"token parameter variable\">-f</span> <span class=\"token builtin class-name\">.</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>serviceaccount/metrics-server created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:metrics-server created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>service/metrics-server created</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>deployment.apps/metrics-server created</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</pre></td></tr></table></figure><p>等待 metrics server 启动然后查看状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl  top node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           CPU<span class=\"token punctuation\">(</span>cores<span class=\"token punctuation\">)</span>   CPU%   MEMORY<span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span>   MEMORY%   </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   231m         <span class=\"token number\">5</span>%     1620Mi          <span class=\"token number\">42</span>%       </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   274m         <span class=\"token number\">6</span>%     1203Mi          <span class=\"token number\">31</span>%       </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   202m         <span class=\"token number\">5</span>%     1251Mi          <span class=\"token number\">32</span>%       </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>k8s-node01     69m          <span class=\"token number\">1</span>%     667Mi           <span class=\"token number\">17</span>%       </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>k8s-node02     73m          <span class=\"token number\">1</span>%     650Mi           <span class=\"token number\">16</span>%</pre></td></tr></table></figure><p>如果有如下报错，可以等待 10 分钟后，再次查看：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Error from server <span class=\"token punctuation\">(</span>ServiceUnavailable<span class=\"token punctuation\">)</span>: the server is currently unable to handle the request <span class=\"token punctuation\">(</span>get nodes.metrics.k8s.io<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"12-dashboard部署\"><a class=\"anchor\" href=\"#12-dashboard部署\">#</a> 12. Dashboard 部署</h4>\n<h5 id=\"121-安装dashboard\"><a class=\"anchor\" href=\"#121-安装dashboard\">#</a> 12.1 安装 Dashboard</h5>\n<p>Dashboard 用于展示集群中的各类资源，同时也可以通过 Dashboard 实时查看 Pod 的日志和在容器中执行一些命令等。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/dashboard/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 dashboard<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  create -f .</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>serviceaccount/admin-user created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/admin-user created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>namespace/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>serviceaccount/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>service/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>secret/kubernetes-dashboard-certs created</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>secret/kubernetes-dashboard-csrf created</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>secret/kubernetes-dashboard-key-holder created</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>configmap/kubernetes-dashboard-settings created</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>role.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>deployment.apps/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>service/dashboard-metrics-scraper created</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>deployment.apps/dashboard-metrics-scraper created</pre></td></tr></table></figure><h5 id=\"122-登录dashboard\"><a class=\"anchor\" href=\"#122-登录dashboard\">#</a> 12.2 登录 dashboard</h5>\n<p>在谷歌浏览器（Chrome）启动文件中加入启动参数，用于解决无法访问 Dashboard 的问题，参考下图：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>--test-type --ignore-certificate-errors</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pEgWfHJ\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgWfHJ.png\" alt=\"pEgWfHJ.png\" /></a></p>\n<p>更改 dashboard 的 svc 为 NodePort:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl edit svc kubernetes-dashboard <span class=\"token parameter variable\">-n</span> kubernetes-dashboard</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pEgW5NR\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgW5NR.png\" alt=\"pEgW5NR.png\" /></a></p>\n<p><em>将 ClusterIP 更改为 NodePort（如果已经为 NodePort 忽略此步骤）</em></p>\n<p>查看端口号：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc kubernetes-dashboard -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>         AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kubernetes-dashboard   NodePort   <span class=\"token number\">10.96</span>.139.11   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>:32409/TCP   24h</pre></td></tr></table></figure><p>根据自己的实例端口号，通过任意安装了 kube-proxy 的宿主机的 IP + 端口即可访问到 dashboard：</p>\n<p>访问 Dashboard：<a href=\"https://192.168.181.129:31106\">https://192.168.1.71:32409</a> （把 IP 地址和端口改成你自己的）选择登录方式为令牌（即 token 方式），参考下图：</p>\n<p><a href=\"https://imgse.com/i/pEgW736\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgW736.png\" alt=\"pEgW736.png\" /></a></p>\n<p>创建登录 Token：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create token admin-user <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>将 token 值输入到令牌后，单击登录即可访问 Dashboard，参考下图：</p>\n<p><a href=\"https://imgse.com/i/pEgfPv8\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgfPv8.png\" alt=\"pEgfPv8.png\" /></a></p>\n<h4 id=\"14-containerd配置镜像加速\"><a class=\"anchor\" href=\"#14-containerd配置镜像加速\">#</a> 14. Containerd 配置镜像加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/containerd/config.toml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#添加以下配置镜像加速服务</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"docker.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token assign-left variable\">endpoint</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"https://dockerproxy.com\"</span>, <span class=\"token string\">\"https://mirror.baidubce.com\"</span>,<span class=\"token string\">\"https://ccr.ccs.tencentyun.com\"</span>,<span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,<span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,<span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://registry-1.docker.io\"</span>, <span class=\"token string\">\"https://hbv0b596.mirror.aliyuncs.com\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"registry.k8s.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token assign-left variable\">endpoint</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"https://dockerproxy.com\"</span>, <span class=\"token string\">\"https://mirror.baidubce.com\"</span>,<span class=\"token string\">\"https://ccr.ccs.tencentyun.com\"</span>,<span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,<span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,<span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://hbv0b596.mirror.aliyuncs.com\"</span>, <span class=\"token string\">\"https://k8s.m.daocloud.io\"</span>, <span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://hub-mirror.c.163.com\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>所有节点重新启动 Containerd：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl restart containerd</span></pre></td></tr></table></figure><h4 id=\"15-docker配置镜像加速\"><a class=\"anchor\" href=\"#15-docker配置镜像加速\">#</a> 15. Docker 配置镜像加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">\"registry-mirrors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t  <span class=\"token string\">\"https://quay.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t  <span class=\"token string\">\"https://gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s-gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t  <span class=\"token string\">\"https://ghcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t  <span class=\"token string\">\"https://do.nark.eu.org\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.mirrors.sjtug.sjtu.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.1panel.live\"</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.rainbond.cc\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">]</span>, </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token string\">\"exec-opts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>EOF</pre></td></tr></table></figure><p>所有节点重新启动 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now docker</span></pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2771271649.html",
            "url": "http://ixuyong.cn/posts/2771271649.html",
            "title": "云原生K8s安全专家CKS认证考题详解",
            "date_published": "2025-04-09T13:38:39.000Z",
            "content_html": "<h3 id=\"云原生k8s安全专家cks认证考题详解\"><a class=\"anchor\" href=\"#云原生k8s安全专家cks认证考题详解\">#</a> 云原生 K8s 安全专家 CKS 认证考题详解</h3>\n<h4 id=\"1-k8s集群安全加固禁止匿名访问\"><a class=\"anchor\" href=\"#1-k8s集群安全加固禁止匿名访问\">#</a> <strong>1、K8s 集群安全加固：禁止匿名访问</strong></h4>\n<p><a href=\"https://imgse.com/i/pEgL5Uf\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgL5Uf.png\" alt=\"pEgL5Uf.png\" /></a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 更改授权模式和添加 NodeRestriction 准入控制器</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@master01:~<span class=\"token comment\"># cat /etc/kubernetes/manifests/kube-apiserver.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - --enable-admission-plugins<span class=\"token operator\">=</span>NodeRestriction</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - --authorization-mode<span class=\"token operator\">=</span>Node,RBAC</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#2. 删除 clusterrolebinding</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>root@master01:~<span class=\"token comment\"># systemctl restart kubelet</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl delete clusterrolebinding system:anonymous --kubeconfig=/etc/kubernetes/admin.conf</span></pre></td></tr></table></figure><h4 id=\"2-k8s基准测试考题分析\"><a class=\"anchor\" href=\"#2-k8s基准测试考题分析\">#</a> 2、K8s 基准测试考题分析</h4>\n<p><a href=\"https://imgse.com/i/pEKU1gA\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/15/pEKU1gA.png\" alt=\"pEKU1gA.png\" /></a></p>\n<p><a href=\"https://imgse.com/i/pEKUGut\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/15/pEKUGut.png\" alt=\"pEKUGut.png\" /></a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#切换集群，登录 master 节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#1. 修改 apiserver</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>root@master01:~<span class=\"token comment\"># cat /etc/kubernetes/manifests/kube-apiserver.yaml </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - --authorization-mode<span class=\"token operator\">=</span>Node,RBAC</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#2. 修改 etcd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>root@master01:~<span class=\"token comment\"># cat /etc/kubernetes/manifests/etcd.yaml </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    - --client-cert-auth<span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#3. 修改 kubelet</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>root@master01:~<span class=\"token comment\"># cat /var/lib/kubelet/config.yaml </span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>authentication:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  anonymous:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>authorization:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  mode: Webhook</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#4. 重启 kubelet</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>root@master01:~<span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>root@master01:~<span class=\"token comment\"># systemctl restart kubelet</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#5. 登录 node 节点</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>root@node01:~<span class=\"token comment\"># cat /var/lib/kubelet/config.yaml </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>apiVersion: kubelet.config.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>authentication:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  anonymous:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>authorization:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  mode: Webhook</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>root@node01:~<span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>root@node01:~<span class=\"token comment\"># systemctl restart kubelet</span></pre></td></tr></table></figure><h4 id=\"3-k8s密文管理考题分析\"><a class=\"anchor\" href=\"#3-k8s密文管理考题分析\">#</a> 3、K8s 密文管理考题分析</h4>\n<p><a href=\"https://imgse.com/i/pEKUL5D\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/15/pEKUL5D.png\" alt=\"pEKUL5D.png\" /></a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get deployment -n clever</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME     READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>clever   <span class=\"token number\">0</span>/1     <span class=\"token number\">1</span>            <span class=\"token number\">0</span>           86d</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get pods -n clever</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>NAME                      READY   STATUS              RESTARTS   AGE</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>clever-6766f68d99-75xt8   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          86d</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl create secret tls clever -n clever --cert ~/cert/tls.crt --key ~/cert/tls.key </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>secret/clever created</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get secret -n clever</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>NAME     TYPE                DATA   AGE</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>clever   kubernetes.io/tls   <span class=\"token number\">2</span>      2m31s</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get pods -n clever</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>NAME                      READY   STATUS              RESTARTS   AGE</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>clever-6766f68d99-75xt8   <span class=\"token number\">0</span>/1     ContainerCreating   <span class=\"token number\">0</span>          86d</pre></td></tr></table></figure><h4 id=\"4-k8s资源优化提升容器安全性\"><a class=\"anchor\" href=\"#4-k8s资源优化提升容器安全性\">#</a> <strong>4、K8s 资源优化：提升容器安全性</strong></h4>\n<p><a href=\"https://imgse.com/i/pEKBeYT\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/15/pEKBeYT.png\" alt=\"pEKBeYT.png\" /></a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 优化 Dockerfile</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@master01:~<span class=\"token comment\"># cat /home/candidate/Dockerfile </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>FROM ubuntu:16.04</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token environment constant\">USER</span> root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>RUN <span class=\"token function\">apt</span> get <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> <span class=\"token assign-left variable\">nginx</span><span class=\"token operator\">=</span><span class=\"token number\">4.2</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ENV <span class=\"token assign-left variable\">ENV</span><span class=\"token operator\">=</span>testing</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token environment constant\">USER</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>CMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"nginx -d\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#2. 优化 Deployment</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>root@master01:~<span class=\"token comment\"># cat /home/candidate/deployment.yaml </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>           <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'capabilities'</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">'add'</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">'NET_ADMIN'</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">'drop'</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">'all'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">'privileged'</span><span class=\"token builtin class-name\">:</span> False,<span class=\"token string\">'readOnlyRootFilesystem'</span><span class=\"token builtin class-name\">:</span> True, <span class=\"token string\">'runAsUser'</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">65535</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"5-docker安全问题考题分析\"><a class=\"anchor\" href=\"#5-docker安全问题考题分析\">#</a> 5、Docker 安全问题考题分析</h4>\n<p><a href=\"https://imgse.com/i/pElQ359\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/22/pElQ359.png\" alt=\"pElQ359.png\" /></a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 删除 develop 用户</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@master01:~<span class=\"token comment\"># ssh node001</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>root@node01:~<span class=\"token comment\"># id develop</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>develop<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>develop<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>develop<span class=\"token punctuation\">)</span>,999<span class=\"token punctuation\">(</span>docker<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>root@node01:~<span class=\"token comment\"># gpasswd -d develop docker</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>root@node01:~<span class=\"token comment\"># id develop</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>develop<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>develop<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>develop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2. 修改 docker 的配置文件</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#2.1 查看 docker 配置文件路径</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>root@node01:~<span class=\"token comment\"># systemctl status docker</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     Loaded: loaded <span class=\"token punctuation\">(</span>/lib/systemd/system/docker.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: enabled<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Sat <span class=\"token number\">2025</span>-02-22 06:04:52 UTC<span class=\"token punctuation\">;</span> 57min ago</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>root@node01:~<span class=\"token comment\"># ss -lntp|grep 2375</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>LISTEN <span class=\"token number\">0</span>      <span class=\"token number\">4096</span>                 *:2375             *:*    users:<span class=\"token variable\"><span class=\"token punctuation\">((</span>\"dockerd\"<span class=\"token punctuation\">,</span>pid<span class=\"token operator\">=</span><span class=\"token number\">1336</span><span class=\"token punctuation\">,</span>fd<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">))</span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#2.2 查看监听端口 2375</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>root@node01:~<span class=\"token comment\"># ss -lntp|grep 2375</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>LISTEN <span class=\"token number\">0</span>      <span class=\"token number\">4096</span>                 *:2375             *:*    users:<span class=\"token variable\"><span class=\"token punctuation\">((</span>\"dockerd\"<span class=\"token punctuation\">,</span>pid<span class=\"token operator\">=</span><span class=\"token number\">1325</span><span class=\"token punctuation\">,</span>fd<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">))</span></span>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#2.3 修改 docker 配置文件</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>root@node01:~<span class=\"token comment\"># vim /lib/systemd/system/docker.service </span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">[</span>Socket<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token assign-left variable\">SocketUser</span><span class=\"token operator\">=</span>root</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">SocketGroup</span><span class=\"token operator\">=</span>root</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">ListenStream</span><span class=\"token operator\">=</span>/var/run/docker.sock</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">#ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375 --containerd=/run/containerd/containerd.sock</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/bin/dockerd <span class=\"token parameter variable\">-H</span> fd:// <span class=\"token parameter variable\">--containerd</span><span class=\"token operator\">=</span>/run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">#2.4 重启 docker</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>root@node01:~<span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>root@node01:~<span class=\"token comment\"># systemctl restart docker</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>root@node01:~<span class=\"token comment\"># ss -lntp|grep 2375</span></pre></td></tr></table></figure><h4 id=\"6-k8s-ingress-ssl考题分析\"><a class=\"anchor\" href=\"#6-k8s-ingress-ssl考题分析\">#</a> 6、K8s Ingress SSL 考题分析</h4>\n<p><a href=\"https://imgse.com/i/pEKDfPK\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/15/pEKDfPK.png\" alt=\"pEKDfPK.png\" /></a></p>\n<p><strong>Concepts-&gt;Services, Load Balancing, and Networking-&gt;Ingress-&gt;tls</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get svc -n prod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>web    ClusterIP   <span class=\"token number\">10.96</span>.212.149   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>/TCP    86d</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get ingressclass</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>NAME    CONTROLLER             PARAMETERS   AGE</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nginx   k8s.io/ingress-nginx   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>       86d</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>root@master01:~<span class=\"token comment\"># vim ingress-web.yaml</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: web</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-redirect: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  ingressClassName: nginx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  tls:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - hosts:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - web.k8s.local</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    secretName: web-cert</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - host: web.k8s.local</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            name: web</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl apply -f ingress-web.yaml </span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>ingress.networking.k8s.io/web created</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get ingress -n prod</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>NAME   CLASS   HOSTS           ADDRESS   PORTS     AGE</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>web    nginx   web.k8s.local             <span class=\"token number\">80</span>, <span class=\"token number\">443</span>   7s</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#创建后测试</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>root@master01:~<span class=\"token comment\"># curl -Lk http://web.k8s.local</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>root@master01:~<span class=\"token comment\"># curl -Lkv http://web.k8s.local</span></pre></td></tr></table></figure><h4 id=\"7-k8s-serviceaccount考题解析\"><a class=\"anchor\" href=\"#7-k8s-serviceaccount考题解析\">#</a> 7、K8s ServiceAccount 考题解析</h4>\n<p><a href=\"https://imgse.com/i/pEKsYt0\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/15/pEKsYt0.png\" alt=\"pEKsYt0.png\" /></a></p>\n<p><strong>Tasks-&gt;Configure Pods and Containers-&gt;Configure Service Accounts for Pods-&gt;Launch a Pod using service account token projection</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl edit sa statsmonitor-sa -n monitoring</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>automountServiceAccountToken: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  creationTimestamp: <span class=\"token string\">\"2024-11-20T14:44:16Z\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: statsmonitor-sa</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: monitoring</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resourceVersion: <span class=\"token string\">\"104395\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  uid: 13ed4adf-cadf-49a1-a7f1-31a424f433a5</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>root@master01:~<span class=\"token comment\"># cat ~/statsmonitor/deployment.yaml </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  creationTimestamp: null</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    app: statsmonitor</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  name: statsmonitor</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  namespace: monitoring</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      app: statsmonitor</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      creationTimestamp: null</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        app: statsmonitor</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      - name: token</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        projected:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          sources:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          - serviceAccountToken:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              path: token</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      serviceAccountName: statsmonitor-sa</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      - image: m.daocloud.io/docker.io/library/nginx:latest</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount/token</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          name: token</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span>  <span class=\"token comment\">#只读挂载</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl apply -f  ~/statsmonitor/deployment.yaml</span></pre></td></tr></table></figure><h4 id=\"8-k8s-networkpolicy考题解析\"><a class=\"anchor\" href=\"#8-k8s-networkpolicy考题解析\">#</a> 8、K8s NetworkPolicy 考题解析</h4>\n<p><a href=\"https://imgse.com/i/pEKhc4J\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/16/pEKhc4J.png\" alt=\"pEKhc4J.png\" /></a></p>\n<p><strong>Concepts-&gt;Services, Load Balancing, and Networking-&gt;Network Policies</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@master01:~<span class=\"token comment\"># vim /home/candidate/KSCS00101/network-prolicy.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: NetworkPolicy</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: defaultdeny</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: production</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  podSelector: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  policyTypes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - Ingress</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\"># - Engress</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl apply -f  /home/candidate/KSCS00101/network-prolicy.yaml</span></pre></td></tr></table></figure><h4 id=\"9-k8s-cilium考题解析\"><a class=\"anchor\" href=\"#9-k8s-cilium考题解析\">#</a> 9、K8s Cilium 考题解析</h4>\n<p><a href=\"https://imgse.com/i/pEllBLT\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/22/pEllBLT.png\" alt=\"pEllBLT.png\" /></a></p>\n<p><strong>security-&gt;Overview of Network Policy-&gt;Layer 4 Examples</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get pods -n cilium-policy --show-labels</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                      READY   STATUS    RESTARTS     AGE   LABELS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>policy-858469dc69-rrhbz   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">4</span> <span class=\"token punctuation\">(</span>8d ago<span class=\"token punctuation\">)</span>   92d   <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>policy,pod-template-hash<span class=\"token operator\">=</span>858469dc69</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>root@master01:~<span class=\"token comment\"># vim cilium-policy.yaml</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>apiVersion: <span class=\"token string\">\"cilium.io/v2\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>kind: CiliumNetworkPolicy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  name: allow-ingress-host</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  namespace: cilium-policy</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  endpointSelector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      app: policy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  ingress:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  - fromEndpoints:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    - matchLabels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        k8s:io.kubernetes.pod.namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    authentication:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      mode: <span class=\"token string\">\"required\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - fromEntities:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    - <span class=\"token string\">\"host\"</span> </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl apply -f cilium-policy.yaml</span></pre></td></tr></table></figure><h4 id=\"10-k8s-securitycontext考题解析\"><a class=\"anchor\" href=\"#10-k8s-securitycontext考题解析\">#</a> 10、K8s SecurityContext 考题解析</h4>\n<p><a href=\"https://imgse.com/i/pEK5OnP\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/16/pEK5OnP.png\" alt=\"pEK5OnP.png\" /></a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@master01:~<span class=\"token comment\"># vim ~/confidential/nginx-unprivileged.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>          allowPrivilegeEscalation: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>          runAsNonRoot: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>          capabilities:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            drop: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ALL\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>          seccompProfile:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            type: RuntimeDefault</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl apply -f ~/confidential/nginx-unprivileged.yaml</span></pre></td></tr></table></figure><h4 id=\"11-k8s-securitycontext配置变更考题\"><a class=\"anchor\" href=\"#11-k8s-securitycontext配置变更考题\">#</a> 11、K8s SecurityContext 配置变更考题</h4>\n<p><a href=\"https://imgse.com/i/pEKIShQ\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/16/pEKIShQ.png\" alt=\"pEKIShQ.png\" /></a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl edit deploy lamp-deployment -n app</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      - image: m.daocloud.io/docker.io/library/nginx:latest</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        resources: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          allowPrivilegeEscalation: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          readOnlyRootFilesystem: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          runAsUser: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h4 id=\"12-k8s行为检测falco\"><a class=\"anchor\" href=\"#12-k8s行为检测falco\">#</a> <strong>12、K8s 行为检测：Falco</strong></h4>\n<p><a href=\"https://imgse.com/i/pElYTTf\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/22/pElYTTf.png\" alt=\"pElYTTf.png\" /></a></p>\n<p><strong>Concepts-&gt;rules-&gt;Basic of Falco Rules</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建 falco 规则文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@master01:~<span class=\"token comment\"># vim /etc/falco/devmem_rule.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>- rule: <span class=\"token string\">\"monitor devmem\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  desc: <span class=\"token string\">\"monitor devmem\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  condition: fd.name <span class=\"token operator\">==</span> <span class=\"token string\">'/dev/mem'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  output: <span class=\"token string\">\"Container: container_id=%container.id reading /dev/mem\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  priority: NOTICE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2. 执行扫描 (注意：需要查看题目是否声明了在哪个节点进行查询，如果没有指明节点，需要在所有的节点执行扫描）</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@node01:~<span class=\"token comment\"># falco -M 60 -r /etc/falco/devmem_rule.yaml</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">21</span>:44:14.368662183: Notice Container: <span class=\"token assign-left variable\">container_id</span><span class=\"token operator\">=</span>f459ad4e0661 reading /dev/mem</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#3. 使用 crictl 查询是哪个 Pod</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>root@node01:~<span class=\"token comment\"># crictl ps |grep f459ad4e0661</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>WARN<span class=\"token punctuation\">[</span>0000<span class=\"token punctuation\">]</span> runtime connect using default endpoints: <span class=\"token punctuation\">[</span>unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span class=\"token punctuation\">]</span>. As the default settings are now deprecated, you should <span class=\"token builtin class-name\">set</span> the endpoint instead. </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>WARN<span class=\"token punctuation\">[</span>0000<span class=\"token punctuation\">]</span> image connect using default endpoints: <span class=\"token punctuation\">[</span>unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span class=\"token punctuation\">]</span>. As the default settings are now deprecated, you should <span class=\"token builtin class-name\">set</span> the endpoint instead. </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>f459ad4e06615       05455a08881ea       <span class=\"token number\">10</span> minutes ago      Running             alpine              <span class=\"token number\">0</span>                   7ff2ea1a19ab9       cpu-677fcb7db7-nj6ll</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#4. 回到控制节点（退出 SSH）并查看该 Pod 处于的空间：</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get pods -A|grep cpu-677fcb7db7-nj6ll</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>default         cpu-677fcb7db7-nj6ll                 <span class=\"token number\">1</span>/1     Running            <span class=\"token number\">0</span>                 48m</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#5. 将该 Pod 的 deployment 副本设置为 0</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> root@master01:~<span class=\"token comment\"># kubectl scale deploy cpu --replicas=0 -n default</span></pre></td></tr></table></figure><h4 id=\"13-k8s合规性扫描bom\"><a class=\"anchor\" href=\"#13-k8s合规性扫描bom\">#</a> <strong>13、K8s 合规性扫描 Bom</strong></h4>\n<p><a href=\"https://imgse.com/i/pEMlQzV\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/17/pEMlQzV.png\" alt=\"pEMlQzV.png\" /></a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 查看 pod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get pods -n bom</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                   READY   STATUS    RESTARTS      AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>bom-6d7c56bd86-m4jmn   <span class=\"token number\">3</span>/3     Running   <span class=\"token number\">3</span> <span class=\"token punctuation\">(</span>11m ago<span class=\"token punctuation\">)</span>   23h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#2. 可以看到是容器 alpine3 包含了 libcrypto3-3.0.15-r0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl exec -it bom-6d7c56bd86-m4jmn -n bom -- sh</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Defaulted container <span class=\"token string\">\"alpine1\"</span> out of: alpine1, alpine2, alpine3</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/ <span class=\"token comment\"># apk list |grep libcrypto3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>WARNING: opening from cache https://dl-cdn.alpinelinux.org/alpine/v3.20/main: No such <span class=\"token function\">file</span> or directory</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>WARNING: opening from cache https://dl-cdn.alpinelinux.org/alpine/v3.20/community: No such <span class=\"token function\">file</span> or directory</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>libcrypto3-3.3.2-r0 x86_64 <span class=\"token punctuation\">&#123;</span>openssl<span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">(</span>Apache-2.0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>installed<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl exec -it bom-6d7c56bd86-m4jmn -c alpine2 -n bom -- sh</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>/ <span class=\"token comment\"># apk list |grep libcrypto3</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>WARNING: opening from cache https://dl-cdn.alpinelinux.org/alpine/v3.19/main: No such <span class=\"token function\">file</span> or directory</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>WARNING: opening from cache https://dl-cdn.alpinelinux.org/alpine/v3.19/community: No such <span class=\"token function\">file</span> or directory</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>libcrypto3-3.1.7-r0 x86_64 <span class=\"token punctuation\">&#123;</span>openssl<span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">(</span>Apache-2.0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>installed<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl exec -it bom-6d7c56bd86-m4jmn -c alpine3 -n bom -- sh</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>/ <span class=\"token comment\"># apk list|grep libcrypto3</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>WARNING: opening from cache https://dl-cdn.alpinelinux.org/alpine/v3.17/main: No such <span class=\"token function\">file</span> or directory</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>WARNING: opening from cache https://dl-cdn.alpinelinux.org/alpine/v3.17/community: No such <span class=\"token function\">file</span> or directory</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>libcrypto3-3.0.15-r0 x86_64 <span class=\"token punctuation\">&#123;</span>openssl<span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">(</span>Apache-2.0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>installed<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#3. 查看容器 alpine3 对应的镜像</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl edit deploy bom -n bom</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      - command:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - <span class=\"token function\">sleep</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - <span class=\"token string\">\"360000\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        image: registry.cn-beijing.aliyuncs.com/dotbalo/alpine:3.17.10</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">#4. 使用 bom 为该镜像生成 SPDX</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>root@master01:~<span class=\"token comment\"># mkdir ~/KSRS29J15</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>root@master01:~<span class=\"token comment\"># bom generate -i registry.cn-beijing.aliyuncs.com/dotbalo/alpine:3.17.10 > ~/KSRS29J15/bom.spdx</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">#5. 修改～/bom-deployment.yaml 文件，删 alpine3 容器相关的配置</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>root@master01:~<span class=\"token comment\"># vim ~/bom-deployment.yaml</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>name: alpine3</pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl replace -f  ~/bom-deployment.yaml</span></pre></td></tr></table></figure><h4 id=\"14-k8s审计日志概念理解\"><a class=\"anchor\" href=\"#14-k8s审计日志概念理解\">#</a> 14、K8s 审计日志概念理解</h4>\n<p><a href=\"https://imgse.com/i/pElcBdg\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/23/pElcBdg.png\" alt=\"pElcBdg.png\" /></a></p>\n<p><strong>Tasks-&gt;Monitoring, Logging, and Debugging-&gt;Troubleshooting Clusters-&gt;Auditing</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建审计日志规则</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@master01:~<span class=\"token comment\"># mkdir /etc/kubernetes/logpolicy  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>root@master01:~<span class=\"token comment\"># mkdir /var/log/kubernetes</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>root@master01:~<span class=\"token comment\"># cat /etc/kubernetes/logpolicy/sample-policy.yaml</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>apiVersion: audit.k8s.io/v1 <span class=\"token comment\"># This is required.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kind: Policy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># Don't generate audit events for all requests in RequestReceived stage.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>omitStages:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  - <span class=\"token string\">\"RequestReceived\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\"># Log pod changes at RequestResponse level</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - level: RequestResponse</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    resources:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - group: <span class=\"token string\">\"batch\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token comment\"># Resource \"pods\" doesn't match requests to any subresource of pods,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token comment\"># which is consistent with the RBAC policy.</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cronjobs\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - level: Request</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    resources:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    - group: <span class=\"token string\">\"\"</span> <span class=\"token comment\"># core API group</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"persistentvolumes\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\"># This rule only applies to resources in the \"kube-system\" namespace.</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\"># The empty string \"\" can be used to select non-namespaced resources.</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    namespaces: <span class=\"token punctuation\">[</span><span class=\"token string\">\"front-apps\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  - level: Metadata</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    - group: <span class=\"token string\">\"\"</span> <span class=\"token comment\"># core API group</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"secrets\"</span>, <span class=\"token string\">\"configmaps\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  - level: Metadata</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#2. 应用审计日志规则</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>root@master01:~<span class=\"token comment\"># vim /etc/kubernetes/logpolicy/sample-policy.yaml</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    - --audit-policy-file<span class=\"token operator\">=</span>/etc/kubernetes/logpolicy/sample-policy.yaml</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    - --audit-log-path<span class=\"token operator\">=</span>/var/log/kubernetes/kubernetes-logs.txt</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    - --audit-log-maxage<span class=\"token operator\">=</span><span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    - --audit-log-maxbackup<span class=\"token operator\">=</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    volumeMounts:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    - mountPath: /etc/kubernetes/logpolicy/sample-policy.yaml</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      name: audit</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    - mountPath: /var/log/kubernetes/</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      name: audit-log</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  - name: audit</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    hostPath:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      path: /etc/kubernetes/logpolicy/sample-policy.yaml</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      type: File</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  - name: audit-log</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    hostPath:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      path: /var/log/kubernetes/</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      type: DirectoryOrCreate</pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\">#3. 重启 kubelet</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>root@master01:~<span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>root@master01:~<span class=\"token comment\"># systemctl restart kubelet</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token comment\">#4. 查看日志</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>root@master01:~<span class=\"token comment\"># tail -f /var/log/kubernetes/kubernetes-logs.txt</span></pre></td></tr></table></figure><h4 id=\"15-k8s-imagepolicywebhook\"><a class=\"anchor\" href=\"#15-k8s-imagepolicywebhook\">#</a> 15、K8s ImagePolicyWebhook</h4>\n<p><a href=\"https://imgse.com/i/pEM36PA\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/17/pEM36PA.png\" alt=\"pEM36PA.png\" /></a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 切换 Context 后，ssh 到对应 master 节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@master01:~<span class=\"token comment\"># ssh master01</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 关闭默认允许</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>root@master01:~<span class=\"token comment\"># vim /etc/kubernetes/epconfig/admission_configuration.json </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token string\">\"imagePolicy\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token string\">\"kubeConfigFile\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"/etc/kubernetes/epconfig/kubeconfig.yaml\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     <span class=\"token string\">\"allowTTL\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">50</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     <span class=\"token string\">\"denyTTL\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">50</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     <span class=\"token string\">\"retryBackoff\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">500</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     <span class=\"token string\">\"defaultAllow\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">false</span>   <span class=\"token comment\">#'defaultAllow': false # 改成 false</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#3. 配置 Webhook 地址</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>root@master01:~<span class=\"token comment\"># vim /etc/kubernetes/epconfig/kubeconfig.yaml </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>- cluster:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    certificate-authority: /etc/kubernetes/pki/server.crt</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    server: https://wakanda.local:8082/image_policy  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#4. 开启 ImagePolicyWebhook</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>root@master01:~<span class=\"token comment\"># cat /etc/kubernetes/manifests/kube-apiserver.yaml </span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    - --enable-admission-plugins<span class=\"token operator\">=</span>NodeRestriction,ImagePolicyWebhook</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    - --admission-control-config-file<span class=\"token operator\">=</span>/etc/kubernetes/epconfig/admission_configuration.json</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    volumeMounts:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    - mountPath: /etc/kubernetes/epconfig</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      name: epconfig</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  - hostPath:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      path: /etc/kubernetes/epconfig</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    name: epconfig</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">#5. 重启服务</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>root@master01:~<span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>root@master01:~<span class=\"token comment\"># systemctl restart kubelet</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\">#6. 测试</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl apply -f /root/KSSC00202/configuration-test.yml</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl describe rc nginx-latest</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  Warning  FailedCreate  19s <span class=\"token punctuation\">(</span>x4 over 37s<span class=\"token punctuation\">)</span>  replication-controller  <span class=\"token punctuation\">(</span>combined from similar events<span class=\"token punctuation\">)</span>: Error creating: pods <span class=\"token string\">\"nginx-latest-k69tx\"</span> is forbidden: image policy webhook backend denied one or <span class=\"token function\">more</span> images: Images using latest tag are not allowed</pre></td></tr></table></figure><h4 id=\"16-k8s集群升级考题\"><a class=\"anchor\" href=\"#16-k8s集群升级考题\">#</a> 16、K8s 集群升级考题</h4>\n<p><a href=\"https://imgse.com/i/pEM8JeS\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/02/17/pEM8JeS.png\" alt=\"pEM8JeS.png\" /></a></p>\n<p><strong>Tasks-&gt;Administer a Cluster-&gt;Administer with kubeadm-&gt;Upgrade kubeadm Cluster-&gt;Upgrading Linux nodes</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 切换 context</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl config use-context k8s008</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 查看集群会发现 master 和 node 版本不一样</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get nodes</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>NAME       STATUS   ROLES           AGE   VERSION</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>master01   Ready    control-plane   89d   v1.31.2</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>node01     Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          89d   v1.31.1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#3. 切换 node 节点</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>root@master01:~<span class=\"token comment\"># ssh node01</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">sudo</span> apt-mark unhold kubeadm <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> <span class=\"token assign-left variable\">kubeadm</span><span class=\"token operator\">=</span><span class=\"token string\">'1.31.2-*'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token function\">sudo</span> apt-mark hold kubeadm</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>root@node01:~<span class=\"token comment\"># sudo kubeadm upgrade node</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#4. 切换 master 节点或控制端，驱逐 Pod</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl drain node01 --ignore-daemonsets  </span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#5.node01 节点变为禁止调度状态</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get nodes</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>NAME       STATUS                     ROLES           AGE   VERSION</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>master01   Ready                      control-plane   90d   v1.31.2</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>node01     Ready,SchedulingDisabled   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          90d   v1.31.1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#6. 切换 node 节点</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>root@node01:~<span class=\"token comment\"># sudo apt-mark unhold kubelet kubectl &amp;&amp; \\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>root@node01:~<span class=\"token comment\"># sudo apt-get update &amp;&amp; sudo apt-get install -y kubelet='1.31.2-*' kubectl='1.31.2-*' &amp;&amp; \\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token function\">sudo</span> apt-mark hold kubelet kubectl</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>root@node01:~<span class=\"token comment\"># sudo systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>root@node01:~<span class=\"token comment\"># sudo systemctl restart kubelet</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">#7. 切换 master 节点</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl uncordon node01</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>root@master01:~<span class=\"token comment\"># kubectl get nodes</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>NAME       STATUS   ROLES           AGE   VERSION</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>master01   Ready    control-plane   90d   v1.31.2</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>node01     Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          90d   v1.31.2</pre></td></tr></table></figure>",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3166738000.html",
            "url": "http://ixuyong.cn/posts/3166738000.html",
            "title": "Kubeadm高可用安装K8s集群",
            "date_published": "2025-04-09T10:28:34.000Z",
            "content_html": "<h2 id=\"kubeadm高可用安装k8s集群\"><a class=\"anchor\" href=\"#kubeadm高可用安装k8s集群\">#</a> Kubeadm 高可用安装 K8s 集群</h2>\n<h4 id=\"1-基本配置\"><a class=\"anchor\" href=\"#1-基本配置\">#</a> 1. 基本配置</h4>\n<h5 id=\"11-基本环境配置\"><a class=\"anchor\" href=\"#11-基本环境配置\">#</a> 1.1 基本环境配置</h5>\n<table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>IP 地址</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>k8s-master01 ~ 03</td>\n<td>192.168.1.71 ~ 73</td>\n<td>master 节点 * 3</td>\n</tr>\n<tr>\n<td>/</td>\n<td>192.168.1.70</td>\n<td>keepalived 虚拟 IP（不占用机器）</td>\n</tr>\n<tr>\n<td>k8s-node01 ~ 02</td>\n<td>192.168.1.74/75</td>\n<td>worker 节点 * 2</td>\n</tr>\n</tbody>\n</table>\n<p><em>请统一替换这些网段，Pod 网段和 service 和宿主机网段不要重复！！！</em></p>\n<table>\n<thead>\n<tr>\n<th><em><strong>* 配置信息 *</strong></em></th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>系统版本</td>\n<td>Rocky Linux 8/9</td>\n</tr>\n<tr>\n<td>Containerd</td>\n<td>latest</td>\n</tr>\n<tr>\n<td>Pod 网段</td>\n<td>172.16.0.0/16</td>\n</tr>\n<tr>\n<td>Service 网段</td>\n<td>10.96.0.0/16</td>\n</tr>\n</tbody>\n</table>\n<p><mark>所有节点</mark>更改主机名（其它节点按需修改）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hostnamectl set-hostname k8s-master01</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 hosts，修改 /etc/hosts 如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/hosts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.1.71 k8s-master01</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.1.72 k8s-master02</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">192.168</span>.1.73 k8s-master03</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">192.168</span>.1.74 k8s-node01</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">192.168</span>.1.75 k8s-node02</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 yum 源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置基础源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-i.bak</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    /etc/yum.repos.d/*.repo</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>yum makecache</pre></td></tr></table></figure><p><mark>所有节点</mark>必备工具安装：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class=\"token function\">git</span> rsyslog <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>关闭防火墙、selinux、dnsmasq、swap、开启 rsyslog。服务器配置如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> firewalld </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> dnsmasq</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>setenforce <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> rsyslog</pre></td></tr></table></figure><p><mark>所有节点</mark>关闭 swap 分区：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>swapoff <span class=\"token parameter variable\">-a</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-w</span> <span class=\"token assign-left variable\">vm.swappiness</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-ri</span> <span class=\"token string\">'/^[^#]*swap/s@^@#@'</span> /etc/fstab</pre></td></tr></table></figure><p><mark>所有节点</mark>安装 ntpdate：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> epel-release <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> dnf config-manager --set-enabled epel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> ntpsec</pre></td></tr></table></figure><p><mark>所有节点</mark>同步时间并配置上海时区：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span>/etc/timezone</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ntpdate time2.aliyun.com</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 加入到 crontab</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">crontab</span> <span class=\"token parameter variable\">-e</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 limit：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">ulimit</span> <span class=\"token parameter variable\">-SHn</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> /etc/security/limits.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 末尾添加如下内容</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>* soft nofile <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>* hard nofile <span class=\"token number\">131072</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>* soft nproc <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>* hard nproc <span class=\"token number\">655350</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>* soft memlock unlimited</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>* hard memlock unlimited</pre></td></tr></table></figure><p><mark>所有节点</mark>升级系统：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum update <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>Master01 节点</mark>免密钥登录其他节点，安装过程中生成配置文件和证书均在 Master01 上操作，集群管理也在 Master01 上操作：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ssh-keygen <span class=\"token parameter variable\">-t</span> rsa</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class=\"token punctuation\">;</span><span class=\"token keyword\">do</span> ssh-copy-id <span class=\"token parameter variable\">-i</span> .ssh/id_rsa.pub <span class=\"token variable\">$i</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">done</span></pre></td></tr></table></figure><p><em>注意：公有云环境，可能需要把 kubectl 放在一个非 Master 节点上</em></p>\n<p><mark>Master01 节点</mark>下载安装所有的源码文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/ <span class=\"token punctuation\">;</span> <span class=\"token function\">git</span> clone https://gitee.com/chinagei/k8s-ha-install</pre></td></tr></table></figure><h5 id=\"12-内核配置\"><a class=\"anchor\" href=\"#12-内核配置\">#</a> 1.2 内核配置</h5>\n<p><mark>所有节点</mark>安装 ipvsadm：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> ipvsadm ipset sysstat conntrack libseccomp <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置 ipvs 模块：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>modprobe -- ip_vs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>modprobe -- ip_vs_rr</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>modprobe -- ip_vs_wrr</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>modprobe -- ip_vs_sh</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>modprobe -- nf_conntrack</pre></td></tr></table></figure><p><mark>所有节点</mark>创建 ipvs.conf，并配置开机自动加载：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/modules-load.d/ipvs.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 加入以下内容</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ip_vs</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ip_vs_lc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ip_vs_wlc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ip_vs_rr</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ip_vs_wrr</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ip_vs_lblc</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ip_vs_lblcr</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ip_vs_dh</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ip_vs_sh</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ip_vs_fo</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ip_vs_nq</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ip_vs_sed</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ip_vs_ftp</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ip_vs_sh</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nf_conntrack</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ip_tables</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>ip_set</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>xt_set</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>ipt_set</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>ipt_rpfilter</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ipt_REJECT</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>ipip</pre></td></tr></table></figure><p><mark>所有节点</mark>然后执行 systemctl enable --now systemd-modules-load.service 即可（报错不用管）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> systemd-modules-load.service</pre></td></tr></table></figure><p><mark>所有节点</mark>内核优化配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /etc/sysctl.d/k8s.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.ipv4.ip_forward = 1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.bridge.bridge-nf-call-iptables = 1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables = 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>fs.may_detach_mounts = 1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>net.ipv4.conf.all.route_localnet = 1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>vm.overcommit_memory=1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>vm.panic_on_oom=0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>fs.inotify.max_user_watches=89100</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>fs.file-max=52706963</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>fs.nr_open=52706963</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>net.netfilter.nf_conntrack_max=2310720</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>net.ipv4.tcp_keepalive_time = 600</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>net.ipv4.tcp_keepalive_probes = 3</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>net.ipv4.tcp_keepalive_intvl =15</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>net.ipv4.tcp_max_tw_buckets = 36000</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>net.ipv4.tcp_tw_reuse = 1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>net.ipv4.tcp_max_orphans = 327680</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>net.ipv4.tcp_orphan_retries = 3</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net.ipv4.tcp_syncookies = 1</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>net.ipv4.tcp_max_syn_backlog = 16384</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>net.ipv4.ip_conntrack_max = 65536</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>net.ipv4.tcp_max_syn_backlog = 16384</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>net.ipv4.tcp_timestamps = 0</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>net.core.somaxconn = 16384</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p><mark>所有节点</mark>应用配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置完内核后，重启机器，之后查看内核模块是否已自动加载：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lsmod <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">--color</span><span class=\"token operator\">=</span>auto <span class=\"token parameter variable\">-e</span> ip_vs <span class=\"token parameter variable\">-e</span> nf_conntrack</pre></td></tr></table></figure><h4 id=\"2-高可用组件安装\"><a class=\"anchor\" href=\"#2-高可用组件安装\">#</a> 2. 高可用组件安装</h4>\n<p><em>注意：如果安装的不是高可用集群，haproxy 和 keepalived 无需安装</em></p>\n<p><em>注意：公有云要用公有云自带的负载均衡，比如阿里云的 SLB、NLB，腾讯云的 ELB，用来替代 haproxy 和 keepalived，因为公有云大部分都是不支持 keepalived 的。</em></p>\n<p><mark>所有 Master 节点</mark>通过 yum 安装 HAProxy 和 KeepAlived：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> keepalived haproxy <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>配置 HAProxy，需要注意黄色部分的 IP：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/haproxy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/haproxy/haproxy.cfg </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>global</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  maxconn  <span class=\"token number\">2000</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  ulimit-n  <span class=\"token number\">16384</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  log  <span class=\"token number\">127.0</span>.0.1 local0 err</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  stats <span class=\"token function\">timeout</span> 30s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>defaults</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  log global</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  mode  http</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  option  httplog</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">timeout</span> connect <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">timeout</span> client  <span class=\"token number\">50000</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">timeout</span> server  <span class=\"token number\">50000</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token function\">timeout</span> http-request 15s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">timeout</span> http-keep-alive 15s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>frontend monitor-in</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> *:33305</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  mode http</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  option httplog</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  monitor-uri /monitor</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>frontend k8s-master</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">0.0</span>.0.0:16443       <span class=\"token comment\">#HAProxy 监听端口</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">127.0</span>.0.1:16443     <span class=\"token comment\">#HAProxy 监听端口</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  mode tcp</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  option tcplog</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  tcp-request inspect-delay 5s</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  default_backend k8s-master</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>backend k8s-master</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  mode tcp</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  option tcplog</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  option tcp-check</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  balance roundrobin</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  default-server inter 10s downinter 5s rise <span class=\"token number\">2</span> fall <span class=\"token number\">2</span> slowstart 60s maxconn <span class=\"token number\">250</span> maxqueue <span class=\"token number\">256</span> weight <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  server k8s-master01\t<span class=\"token number\">192.168</span>.1.71:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  server k8s-master02\t<span class=\"token number\">192.168</span>.1.72:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  server k8s-master03\t<span class=\"token number\">192.168</span>.1.73:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>配置 KeepAlived，需要注意黄色部分的配置。</p>\n<p><mark>Master01 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/keepalived</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    state MASTER</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    interface ens160               <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.71      <span class=\"token comment\">#K8s-master01 IP 地址</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    priority <span class=\"token number\">101</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70        <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>Master02 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    interface ens160                <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.72       <span class=\"token comment\">#K8s-master02 IP 地址</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70              <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>Master03 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    interface ens160                 <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.73        <span class=\"token comment\">#K8s-master03 IP 地址</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70          <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>所有 master 节点</mark>配置 KeepAlived 健康检查文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/check_apiserver.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">k</span> <span class=\"token keyword\">in</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">seq</span> <span class=\"token number\">1</span> <span class=\"token number\">3</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token assign-left variable\">check_code</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>pgrep haproxy<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$check_code</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">expr</span> $err + <span class=\"token number\">1</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token builtin class-name\">continue</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token builtin class-name\">break</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$err</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"systemctl stop keepalived\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    /usr/bin/systemctl stop keepalived</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr></table></figure><p><mark>所有 master 节点</mark>配置健康检查文件添加执行权限：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">chmod</span> +x /etc/keepalived/check_apiserver.sh</pre></td></tr></table></figure><p><mark>所有 master 节点</mark>启动 haproxy 和 keepalived：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now haproxy</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now keepalived</span></pre></td></tr></table></figure><p>重要：如果安装了 keepalived 和 haproxy，需要测试 keepalived 是否是正常的</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>所有节点测试VIP</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ping 192.168.1.70 -c 4</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING <span class=\"token number\">192.168</span>.1.70 <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.70<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.464</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.063</span> ms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.062</span> ms</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">4</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.063</span> ms</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># telnet 192.168.1.70 16443</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Trying <span class=\"token number\">192.168</span>.1.70<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Connected to <span class=\"token number\">192.168</span>.1.70.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Escape character is <span class=\"token string\">'^]'</span><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Connection closed by foreign host.</pre></td></tr></table></figure><p>如果 ping 不通且 telnet 没有出现 ] ，则认为 VIP 不可以，不可在继续往下执行，需要排查 keepalived 的问题，比如防火墙和 selinux，haproxy 和 keepalived 的状态，监听端口等</p>\n<ul>\n<li>所有节点查看防火墙状态必须为 disable 和 inactive：systemctl status firewalld</li>\n<li>所有节点查看 selinux 状态，必须为 disable：getenforce</li>\n<li>master 节点查看 haproxy 和 keepalived 状态：systemctl status keepalived haproxy</li>\n<li>master 节点查看监听端口：netstat -lntp</li>\n</ul>\n<p>如果以上都没有问题，需要确认：</p>\n<ol>\n<li>\n<p>是否是公有云机器</p>\n</li>\n<li>\n<p>是否是私有云机器（类似 OpenStack）</p>\n</li>\n</ol>\n<p>上述公有云一般都是不支持 keepalived，私有云可能也有限制，需要和自己的私有云管理员咨询</p>\n<h4 id=\"3-runtime安装\"><a class=\"anchor\" href=\"#3-runtime安装\">#</a> 3. Runtime 安装</h4>\n<p>如果安装的版本低于 1.24，选择 Docker 和 Containerd 均可，高于 1.24 建议选择 Containerd 作为 Runtime，不再推荐使用 Docker 作为 Runtime。</p>\n<h5 id=\"31-安装containerd\"><a class=\"anchor\" href=\"#31-安装containerd\">#</a> 3.1 安装 Containerd</h5>\n<p><mark>所有节点</mark>配置安装源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class=\"token function\">git</span> <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</pre></td></tr></table></figure><p><mark>所有节点</mark>安装 docker-ce（如果在以前已经安装过，需要重新安装更新一下）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install docker-ce containerd -y</span></pre></td></tr></table></figure><p><em>可以无需启动 Docker，只需要配置和启动 Containerd 即可。</em></p>\n<p>首先配置 Containerd 所需的模块（<mark>所有节点</mark>）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>overlay</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>br_netfilter</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOF</pre></td></tr></table></figure><p><mark>所有节点</mark>加载模块：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># modprobe -- overlay</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># modprobe -- br_netfilter</span></pre></td></tr></table></figure><p><mark>所有节点</mark>，配置 Containerd 所需的内核：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.bridge.bridge-nf-call-iptables  <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.ipv4.ip_forward                 <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</pre></td></tr></table></figure><p><mark>所有节点</mark>加载内核：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># sysctl --system</span></pre></td></tr></table></figure><p><mark>所有节点</mark>生成 Containerd 的配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># mkdir -p /etc/containerd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># containerd config default | tee /etc/containerd/config.toml</span></pre></td></tr></table></figure><p><mark>所有节点</mark>更改 Containerd 的 Cgroup 和 Pause 镜像配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SystemdCgroup = false#SystemdCgroup = true#g'</span> /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr></table></figure><p><mark>所有节点</mark>启动 Containerd，并配置开机自启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now containerd</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置 crictl 客户端连接的运行时位置（可选）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat > /etc/crictl.yaml &lt;&lt;EOF</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>runtime-endpoint: unix:///run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>image-endpoint: unix:///run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>timeout: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>EOF</pre></td></tr></table></figure><h4 id=\"4-安装kubernetes组件\"><a class=\"anchor\" href=\"#4-安装kubernetes组件\">#</a> 4 . 安装 Kubernetes 组件</h4>\n<p><mark>所有节点</mark>配置源（注意更改版本号）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /etc/yum.repos.d/kubernetes.repo</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[kubernetes]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>name=Kubernetes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/rpm/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>enabled=1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>gpgcheck=1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/rpm/repodata/repomd.xml.key</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p>首先在<mark> Master01 节点</mark>查看最新的 Kubernetes 版本是多少：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum list kubeadm.x86_64 --showduplicates | sort -r</span></pre></td></tr></table></figure><p><mark>所有节点</mark>安装 1.32 最新版本 kubeadm、kubelet 和 kubectl：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install kubeadm-1.32* kubelet-1.32* kubectl-1.32* -y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>设置 Kubelet 开机自启动（由于还未初始化，没有 kubelet 的配置文件，此时 kubelet 无法启动，无需关心）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now kubelet</span></pre></td></tr></table></figure><p><em>此时 kubelet 是起不来的，日志会有报错不影响！</em></p>\n<h4 id=\"5-集群初始化\"><a class=\"anchor\" href=\"#5-集群初始化\">#</a> 5 . 集群初始化</h4>\n<p>以下操作在<mark> master01</mark>（注意黄色部分）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> kubeadm-config.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: kubeadm.k8s.io/v1beta3</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>bootstrapTokens:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>- groups:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  - system:bootstrappers:kubeadm:default-node-token</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  token: 7t2weq.bjbawausm0jaxury</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ttl: 24h0m0s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  usages:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  - signing</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - authentication</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kind: InitConfiguration</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>localAPIEndpoint:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  advertiseAddress: <span class=\"token number\">192.168</span>.1.71</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  bindPort: <span class=\"token number\">6443</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>nodeRegistration:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  criSocket: unix:///var/run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  name: k8s-master01</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  taints:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - effect: NoSchedule</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    key: node-role.kubernetes.io/control-plane</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>apiServer:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  certSANs:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  - <span class=\"token number\">192.168</span>.1.70               <span class=\"token comment\"># 如果搭建的不是高可用集群，把此处改为 master 的 IP</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  timeoutForControlPlane: 4m0s</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>apiVersion: kubeadm.k8s.io/v1beta3</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>certificatesDir: /etc/kubernetes/pki</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>clusterName: kubernetes</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>controlPlaneEndpoint: <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token comment\"># 如果搭建的不是高可用集群，把此处 IP 改为 master 的 IP，端口改成 6443</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>controllerManager: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>etcd:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  local:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    dataDir: /var/lib/etcd</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>kind: ClusterConfiguration</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>kubernetesVersion: v1.32.3    <span class=\"token comment\"># 更改此处的版本号和 kubeadm version 一致</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>networking:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  dnsDomain: cluster.local</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  podSubnet: <span class=\"token number\">172.16</span>.0.0/16    <span class=\"token comment\"># 注意此处的网段，不要与 service 和节点网段冲突</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  serviceSubnet: <span class=\"token number\">10.96</span>.0.0/16 <span class=\"token comment\"># 注意此处的网段，不要与 pod 和节点网段冲突</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>scheduler: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>master01 节点</mark>更新 kubeadm 文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml</pre></td></tr></table></figure><p>将 new.yaml 文件复制到<mark>其他 master 节点</mark>:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> k8s-master02 k8s-master03<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token function\">scp</span> new.yaml <span class=\"token variable\">$i</span>:/root/<span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><p>之后<mark>所有 Master 节点</mark>提前下载镜像，可以节省初始化时间（其他节点不需要更改任何配置，包括 IP 地址也不需要更改）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm config images pull <span class=\"token parameter variable\">--config</span> /root/new.yaml</pre></td></tr></table></figure><p>正确的反馈信息如下（<em><strong>* 版本可能不一样 *</strong></em>）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubeadm config images pull --config /root/new.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.32.0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.32.0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.32.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.32.0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.11.3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.10</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.16-0</pre></td></tr></table></figure><p><mark>Master01 节点</mark>初始化，初始化以后会在 /etc/kubernetes 目录下生成对应的证书和配置文件，之后其他 Master 节点加入 Master01 即可：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm init <span class=\"token parameter variable\">--config</span> /root/new.yaml  --upload-certs</pre></td></tr></table></figure><p>初始化成功以后，会产生 Token 值，用于其他节点加入时使用，因此要记录下初始化成功生成的 token 值（令牌值）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Your Kubernetes control-plane has initialized successfully<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>To start using your cluster, you need to run the following as a regular user:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> <span class=\"token environment constant\">$HOME</span>/.kube</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-i</span> /etc/kubernetes/admin.conf <span class=\"token environment constant\">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-u</span><span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">:</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-g</span><span class=\"token variable\">)</span></span> <span class=\"token environment constant\">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Alternatively, <span class=\"token keyword\">if</span> you are the root user, you can run:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">KUBECONFIG</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>You should now deploy a pod network to the cluster.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Run <span class=\"token string\">\"kubectl apply -f [podnetwork].yaml\"</span> with one of the options listed at:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  https://kubernetes.io/docs/concepts/cluster-administration/addons/</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>You can now <span class=\"token function\">join</span> any number of the control-plane <span class=\"token function\">node</span> running the following <span class=\"token builtin class-name\">command</span> on each as root:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 不要复制文档当中的，要去使用节点生成的</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  kubeadm <span class=\"token function\">join</span> <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token parameter variable\">--token</span> 7t2weq.bjbawausm0jaxury <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t--discovery-token-ca-cert-hash sha256:df72788de04bbc2e8fca70becb8a9e8503a962b5d7cd9b1842a0c39930d08c94 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t--control-plane --certificate-key c595f7f4a7a3beb0d5bdb75d9e4eff0a60b977447e76c1d6885e82c3aa43c94c</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Please note that the certificate-key gives access to cluster sensitive data, keep it secret<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>As a safeguard, uploaded-certs will be deleted <span class=\"token keyword\">in</span> two hours<span class=\"token punctuation\">;</span> If necessary, you can use</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token string\">\"kubeadm init phase upload-certs --upload-certs\"</span> to reload certs afterward.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Then you can <span class=\"token function\">join</span> any number of worker nodes by running the following on each as root:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kubeadm <span class=\"token function\">join</span> <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token parameter variable\">--token</span> 7t2weq.bjbawausm0jaxury <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t--discovery-token-ca-cert-hash sha256:df72788de04bbc2e8fca70becb8a9e8503a962b5d7cd9b1842a0c39930d08c94</pre></td></tr></table></figure><p><mark>Master01 节点</mark>配置环境变量，用于访问 Kubernetes 集群：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">>></span> /root/.bashrc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>export KUBECONFIG=/etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">source</span> /root/.bashrc</pre></td></tr></table></figure><p><mark>Master01 节点</mark>查看节点状态：（显示 NotReady 不影响）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           STATUS     ROLES           AGE   VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   NotReady   control-plane   24s   v1.32.3</pre></td></tr></table></figure><p>采用初始化安装方式，所有的系统组件均以容器的方式运行并且在 kube-system 命名空间内，此时可以查看 Pod 状态（显示 pending 不影响）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get pods -n kube-system</span></pre></td></tr></table></figure><h5 id=\"51-初始化失败排查\"><a class=\"anchor\" href=\"#51-初始化失败排查\">#</a> 5.1 初始化失败排查</h5>\n<p>如果初始化失败，重置后再次初始化，命令如下（没有失败不要执行）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm reset <span class=\"token parameter variable\">-f</span> <span class=\"token punctuation\">;</span> ipvsadm <span class=\"token parameter variable\">--clear</span>  <span class=\"token punctuation\">;</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span> ~/.kube</pre></td></tr></table></figure><p>如果多次尝试都是初始化失败，需要看系统日志，CentOS/RockyLinux 日志路径:/var/log/messages，Ubuntu 系列日志路径:/var/log/syslog：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">tail</span> <span class=\"token parameter variable\">-f</span> /var/log/messages <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"not found\"</span></pre></td></tr></table></figure><p>经常出错的原因：</p>\n<ol>\n<li>Containerd 的配置文件修改的不对，自行参考《安装 containerd》小节核对</li>\n<li>new.yaml 配置问题，比如非高可用集群忘记修改 16443 端口为 6443</li>\n<li>new.yaml 配置问题，三个网段有交叉，出现 IP 地址冲突</li>\n<li>VIP 不通导致无法初始化成功，此时 messages 日志会有 VIP 超时的报错</li>\n</ol>\n<h5 id=\"52-高可用master\"><a class=\"anchor\" href=\"#52-高可用master\">#</a> 5.2 高可用 Master</h5>\n<p><strong>其他 master</strong> 加入集群，master02 和 master03 分别执行 (千万不要在 master01 再次执行，不能直接复制文档当中的命令，而是你自己刚才 master01 初始化之后产生的命令)</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm <span class=\"token function\">join</span> <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token parameter variable\">--token</span> 7t2weq.bjbawausm0jaxury <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t--discovery-token-ca-cert-hash sha256:df72788de04bbc2e8fca70becb8a9e8503a962b5d7cd9b1842a0c39930d08c94 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t--control-plane --certificate-key c595f7f4a7a3beb0d5bdb75d9e4eff0a60b977447e76c1d6885e82c3aa43c94c</pre></td></tr></table></figure><p>查看当前状态：（如果显示 NotReady 不影响）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           STATUS     ROLES           AGE     VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   NotReady   control-plane   4m23s   v1.32.3</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   NotReady   control-plane   66s     v1.32.3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   NotReady   control-plane   14s     v1.32.3</pre></td></tr></table></figure><h5 id=\"53-token过期处理\"><a class=\"anchor\" href=\"#53-token过期处理\">#</a> 5.3 Token 过期处理</h5>\n<p>注意：以下步骤是上述 init 命令产生的 Token 过期了才需要执行以下步骤，如果没有过期不需要执行，直接 join 即可。</p>\n<p>Token 过期后生成新的 token：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm token create --print-join-command</pre></td></tr></table></figure><p>Master 需要生成 --certificate-key：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm init phase upload-certs  --upload-certs</pre></td></tr></table></figure><h4 id=\"6-node节点的配置\"><a class=\"anchor\" href=\"#6-node节点的配置\">#</a> 6. Node 节点的配置</h4>\n<p>Node 节点上主要部署公司的一些业务应用，生产环境中不建议 Master 节点部署系统组件之外的其他 Pod，测试环境可以允许 Master 节点部署 Pod 以节省系统资源。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm <span class=\"token function\">join</span> <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token parameter variable\">--token</span> 7t2weq.bjbawausm0jaxury <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t--discovery-token-ca-cert-hash sha256:377702f508fe70b9d8ab68beccaa9af1b4609b754e4cc2fcc6185974e1d620b5</pre></td></tr></table></figure><p>所有节点初始化完成后，查看集群状态（NotReady 不影响）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           STATUS     ROLES           AGE     VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   NotReady   control-plane   4m23s   v1.32.3</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   NotReady   control-plane   66s     v1.32.3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   NotReady   control-plane   14s     v1.32.3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>k8s-node01     NotReady   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          13s     v1.32.3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>k8s-node02     NotReady   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          10s     v1.32.3</pre></td></tr></table></figure><h4 id=\"7-calico组件的安装\"><a class=\"anchor\" href=\"#7-calico组件的安装\">#</a> 7. Calico 组件的安装</h4>\n<p><mark>所有节点</mark>禁止 NetworkManager 管理 Calico 的网络接口，防止有冲突或干扰：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">>></span>/etc/NetworkManager/conf.d/calico.conf<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[keyfile]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>unmanaged-devices=interface-name:cali*;interface-name:tunl*;interface-name:vxlan.calico;interface-name:vxlan-v6.calico;interface-name:wireguard.cali;interface-name:wg-v6.cali</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>systemctl restart NetworkManager</pre></td></tr></table></figure><p>以下步骤只在<mark> master01</mark> 执行（.x 不需要更改）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">git</span> checkout manual-installation-v1.32.x <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> calico/</pre></td></tr></table></figure><p>修改 Pod 网段：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">POD_SUBNET</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">cat</span> /etc/kubernetes/manifests/kube-controller-manager.yaml <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> cluster-cidr<span class=\"token operator\">=</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token parameter variable\">-F</span><span class=\"token operator\">=</span> <span class=\"token string\">'&#123;print $NF&#125;'</span><span class=\"token variable\">`</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#POD_CIDR#<span class=\"token variable\">$&#123;POD_SUBNET&#125;</span>#g\"</span> calico.yaml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kubectl apply <span class=\"token parameter variable\">-f</span> calico.yaml</pre></td></tr></table></figure><p>查看容器和节点状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n kube-system</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                                       READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>calico-kube-controllers-6f497d8478-v2q8c   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>calico-node-7mzmb                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>calico-node-ljqnl                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>calico-node-njqlb                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>calico-node-ph4m4                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>calico-node-rx8rl                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>coredns-76fccbbb6b-76559                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>coredns-76fccbbb6b-hkvn7                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>etcd-k8s-master01                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>etcd-k8s-master02                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>etcd-k8s-master03                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>kube-apiserver-k8s-master01                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kube-apiserver-k8s-master02                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kube-apiserver-k8s-master03                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kube-controller-manager-k8s-master01       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kube-controller-manager-k8s-master02       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kube-controller-manager-k8s-master03       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>kube-proxy-9dtz4                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>kube-proxy-jh7rl                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kube-proxy-jvvwt                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kube-proxy-sh89l                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>kube-proxy-t2j49                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kube-scheduler-k8s-master01                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kube-scheduler-k8s-master02                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>kube-scheduler-k8s-master03                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>metrics-server-7d9d8df576-jgnp2            <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr></table></figure><p>此时节点全部变为 Ready 状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get nodes</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           STATUS   ROLES           AGE   VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   Ready    control-plane   24h   v1.32.3</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   Ready    control-plane   24h   v1.32.3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   Ready    control-plane   24h   v1.32.3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>k8s-node01     Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          24h   v1.32.3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>k8s-node02     Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          24h   v1.32.3</pre></td></tr></table></figure><h4 id=\"8-metrics部署\"><a class=\"anchor\" href=\"#8-metrics部署\">#</a> 8. Metrics 部署</h4>\n<p>在新版的 Kubernetes 中系统资源的采集均使用 Metrics-server，可以通过 Metrics 采集节点和 Pod 的内存、磁盘、CPU 和网络的使用率。</p>\n<p>将<mark> Master01 节点</mark>的 front-proxy-ca.crt 复制到所有 Node 节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">scp</span> /etc/kubernetes/pki/front-proxy-ca.crt k8s-node01:/etc/kubernetes/pki/front-proxy-ca.crt</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">scp</span> /etc/kubernetes/pki/front-proxy-ca.crt k8s-node<span class=\"token punctuation\">(</span>其他节点自行拷贝<span class=\"token punctuation\">)</span>:/etc/kubernetes/pki/front-proxy-ca.crt</pre></td></tr></table></figure><p>以下操作均在<mark> master01 节点</mark>执行:</p>\n<p>安装 metrics server</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/kubeadm-metrics-server</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl  create -f comp.yaml </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>serviceaccount/metrics-server created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:metrics-server created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>service/metrics-server created</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>deployment.apps/metrics-server created</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</pre></td></tr></table></figure><p>查看状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get po -n kube-system -l k8s-app=metrics-server</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                              READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metrics-server-7d9d8df576-jgnp2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr></table></figure><p>等 Pod 变成 1/1   Running 后，查看节点和 Pod 资源使用率：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl top node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           CPU<span class=\"token punctuation\">(</span>cores<span class=\"token punctuation\">)</span>   CPU<span class=\"token punctuation\">(</span>%<span class=\"token punctuation\">)</span>   MEMORY<span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span>   MEMORY<span class=\"token punctuation\">(</span>%<span class=\"token punctuation\">)</span>   </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   132m         <span class=\"token number\">3</span>%       932Mi           <span class=\"token number\">5</span>%          </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   131m         <span class=\"token number\">3</span>%       845Mi           <span class=\"token number\">5</span>%          </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   148m         <span class=\"token number\">3</span>%       912Mi           <span class=\"token number\">5</span>%          </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>k8s-node01     54m          <span class=\"token number\">1</span>%       600Mi           <span class=\"token number\">3</span>%          </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>k8s-node02     49m          <span class=\"token number\">1</span>%       602Mi           <span class=\"token number\">3</span>%          </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl top po -A</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>NAMESPACE              NAME                                         CPU<span class=\"token punctuation\">(</span>cores<span class=\"token punctuation\">)</span>   MEMORY<span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span>   </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ingress-nginx          ingress-nginx-controller-5v9gl               2m           98Mi            </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ingress-nginx          ingress-nginx-controller-r978m               1m           104Mi           </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>krm                    krm-backend-d7ff675d8-vmt9z                  1m           21Mi            </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>krm                    krm-frontend-588ffd677b-c2pgj                1m           4Mi             </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>krm                    nginx-574cf48959-vcfjs                       0m           2Mi             </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kube-system            calico-kube-controllers-6f497d8478-v2q8c     6m           17Mi            </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kube-system            calico-node-7mzmb                            16m          176Mi           </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kube-system            calico-node-ljqnl                            15m          182Mi           </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kube-system            calico-node-njqlb                            19m          180Mi           </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kube-system            calico-node-ph4m4                            15m          178Mi           </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>kube-system            calico-node-rx8rl                            17m          180Mi           </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>kube-system            coredns-76fccbbb6b-76559                     2m           16Mi            </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kube-system            coredns-76fccbbb6b-hkvn7                     2m           16Mi            </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kube-system            etcd-k8s-master01                            22m          86Mi            </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>kube-system            etcd-k8s-master02                            27m          84Mi            </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kube-system            etcd-k8s-master03                            22m          84Mi            </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kube-system            kube-apiserver-k8s-master01                  22m          267Mi           </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>kube-system            kube-apiserver-k8s-master02                  20m          242Mi           </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>kube-system            kube-apiserver-k8s-master03                  18m          241Mi           </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>kube-system            kube-controller-manager-k8s-master01         6m           69Mi            </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kube-system            kube-controller-manager-k8s-master02         2m           21Mi            </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>kube-system            kube-controller-manager-k8s-master03         1m           19Mi            </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>kube-system            kube-proxy-9dtz4                             11m          30Mi            </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>kube-system            kube-proxy-jh7rl                             1m           27Mi            </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>kube-system            kube-proxy-jvvwt                             17m          29Mi            </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>kube-system            kube-proxy-sh89l                             1m           29Mi            </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>kube-system            kube-proxy-t2j49                             16m          29Mi            </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>kube-system            kube-scheduler-k8s-master01                  6m           25Mi            </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>kube-system            kube-scheduler-k8s-master02                  6m           25Mi            </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>kube-system            kube-scheduler-k8s-master03                  6m           25Mi            </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>kube-system            metrics-server-7d9d8df576-jgnp2              2m           26Mi            </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>kubernetes-dashboard   dashboard-metrics-scraper-69b4796d9b-klnwr   1m           19Mi            </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>kubernetes-dashboard   kubernetes-dashboard-778584b9dd-pd5ln        1m           31Mi</pre></td></tr></table></figure><h4 id=\"9-dashboard部署\"><a class=\"anchor\" href=\"#9-dashboard部署\">#</a> 9. Dashboard 部署</h4>\n<h5 id=\"91-安装dashboard\"><a class=\"anchor\" href=\"#91-安装dashboard\">#</a> 9.1 安装 Dashboard</h5>\n<p>Dashboard 用于展示集群中的各类资源，同时也可以通过 Dashboard 实时查看 Pod 的日志和在容器中执行一些命令等。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/dashboard/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 dashboard<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  create -f .</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>serviceaccount/admin-user created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/admin-user created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>namespace/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>serviceaccount/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>service/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>secret/kubernetes-dashboard-certs created</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>secret/kubernetes-dashboard-csrf created</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>secret/kubernetes-dashboard-key-holder created</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>configmap/kubernetes-dashboard-settings created</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>role.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>deployment.apps/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>service/dashboard-metrics-scraper created</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>deployment.apps/dashboard-metrics-scraper created</pre></td></tr></table></figure><h5 id=\"92-登录dashboard\"><a class=\"anchor\" href=\"#92-登录dashboard\">#</a> 9.2 登录 dashboard</h5>\n<p>在谷歌浏览器（Chrome）启动文件中加入启动参数，用于解决无法访问 Dashboard 的问题，参考下图：</p>\n<pre><code>--test-type --ignore-certificate-errors\n</code></pre>\n<p><a href=\"https://imgse.com/i/pEgWfHJ\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgWfHJ.png\" alt=\"pEgWfHJ.png\" /></a></p>\n<p>更改 dashboard 的 svc 为 NodePort:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl edit svc kubernetes-dashboard <span class=\"token parameter variable\">-n</span> kubernetes-dashboard</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pEgW5NR\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgW5NR.png\" alt=\"pEgW5NR.png\" /></a></p>\n<p><em>将 ClusterIP 更改为 NodePort（如果已经为 NodePort 忽略此步骤）</em></p>\n<p>查看端口号：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc kubernetes-dashboard -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>         AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kubernetes-dashboard   NodePort   <span class=\"token number\">10.96</span>.139.11   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>:32409/TCP   24h</pre></td></tr></table></figure><p>根据自己的实例端口号，通过任意安装了 kube-proxy 的宿主机的 IP + 端口即可访问到 dashboard：</p>\n<p>访问 Dashboard：<a href=\"https://192.168.181.129:31106\">https://192.168.1.71:32409</a> （把 IP 地址和端口改成你自己的）选择登录方式为令牌（即 token 方式），参考下图：</p>\n<p><a href=\"https://imgse.com/i/pEgW736\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgW736.png\" alt=\"pEgW736.png\" /></a></p>\n<p>创建登录 Token：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create token admin-user <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>将 token 值输入到令牌后，单击登录即可访问 Dashboard，参考下图：</p>\n<p><a href=\"https://imgse.com/i/pEgfPv8\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgfPv8.png\" alt=\"pEgfPv8.png\" /></a></p>\n<h4 id=\"10必看一些必须的配置更改\"><a class=\"anchor\" href=\"#10必看一些必须的配置更改\">#</a> 10.【必看】一些必须的配置更改</h4>\n<p>将 Kube-proxy 改为 ipvs 模式，因为在初始化集群的时候注释了 ipvs 配置，所以需要自行修改一下：</p>\n<p>在 master01 节点执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl edit cm kube-proxy <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mode: ipvs</pre></td></tr></table></figure><p>更新 Kube-Proxy 的 Pod：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl patch daemonset kube-proxy <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>spec<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>template<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>metadata<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>annotations<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>date<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> +<span class=\"token string\">'%s'</span><span class=\"token variable\">`</span></span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>&#125;&#125;&#125;&#125;&#125;\"</span> <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>验证 Kube-Proxy 模式:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 127.0.0.1:10249/proxyMode</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ipvs</pre></td></tr></table></figure><h4 id=\"11必看注意事项\"><a class=\"anchor\" href=\"#11必看注意事项\">#</a> 11.【必看】注意事项</h4>\n<p>注意：kubeadm 安装的集群，证书有效期默认是一年。master 节点的 kube-apiserver、kube-scheduler、kube-controller-manager、etcd 都是以容器运行的。可以通过 kubectl get po -n kube-system 查看。</p>\n<p>启动和二进制不同的是，kubelet 的配置文件在 /etc/sysconfig/kubelet 和 /var/lib/kubelet/config.yaml，修改后需要重启 kubelet 进程。</p>\n<p>其他组件的配置文件在 /etc/kubernetes/manifests 目录下，比如 kube-apiserver.yaml，该 yaml 文件更改后，kubelet 会自动刷新配置，也就是会重启 pod。不能再次创建该文件。</p>\n<p>kube-proxy 的配置在 kube-system 命名空间下的 configmap 中，可以通过</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl edit cm kube-proxy <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>进行更改，更改完成后，可以通过 patch 重启 kube-proxy</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl patch daemonset kube-proxy <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>spec<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>template<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>metadata<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>annotations<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>date<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> +<span class=\"token string\">'%s'</span><span class=\"token variable\">`</span></span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>&#125;&#125;&#125;&#125;&#125;\"</span> <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>Kubeadm 安装后，master 节点默认不允许部署 pod，可以通过以下方式删除 Taint，即可部署 Pod：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  taint node  -l node-role.kubernetes.io/control-plane node-role.kubernetes.io/control-plane:NoSchedule-</span></pre></td></tr></table></figure><h4 id=\"12-containerd配置镜像加速\"><a class=\"anchor\" href=\"#12-containerd配置镜像加速\">#</a> 12. Containerd 配置镜像加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/containerd/config.toml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#添加以下配置镜像加速服务</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"docker.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token assign-left variable\">endpoint</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"https://dockerproxy.com\"</span>, <span class=\"token string\">\"https://mirror.baidubce.com\"</span>,<span class=\"token string\">\"https://ccr.ccs.tencentyun.com\"</span>,<span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,<span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,<span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://registry-1.docker.io\"</span>, <span class=\"token string\">\"https://hbv0b596.mirror.aliyuncs.com\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"registry.k8s.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token assign-left variable\">endpoint</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"https://dockerproxy.com\"</span>, <span class=\"token string\">\"https://mirror.baidubce.com\"</span>,<span class=\"token string\">\"https://ccr.ccs.tencentyun.com\"</span>,<span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,<span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,<span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://hbv0b596.mirror.aliyuncs.com\"</span>, <span class=\"token string\">\"https://k8s.m.daocloud.io\"</span>, <span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://hub-mirror.c.163.com\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>所有节点重新启动 Containerd：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl restart containerd</span></pre></td></tr></table></figure><h4 id=\"13-docker配置镜像加速\"><a class=\"anchor\" href=\"#13-docker配置镜像加速\">#</a> 13. Docker 配置镜像加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">\"registry-mirrors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t  <span class=\"token string\">\"https://quay.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t  <span class=\"token string\">\"https://gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s-gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t  <span class=\"token string\">\"https://ghcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t  <span class=\"token string\">\"https://do.nark.eu.org\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.mirrors.sjtug.sjtu.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.1panel.live\"</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.rainbond.cc\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">]</span>, </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token string\">\"exec-opts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>EOF</pre></td></tr></table></figure><p>所有节点重新启动 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now docker</span></pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        }
    ]
}