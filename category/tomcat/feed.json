{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"tomcat\" category",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/754945111.html",
            "url": "http://ixuyong.cn/posts/754945111.html",
            "title": "Tomcat JVM调优实践",
            "date_published": "2025-06-08T02:51:57.000Z",
            "content_html": "<h3 id=\"tomcat-jvm调优实践\"><a class=\"anchor\" href=\"#tomcat-jvm调优实践\">#</a> Tomcat JVM 调优实践</h3>\n<h4 id=\"一-jvm基础架构\"><a class=\"anchor\" href=\"#一-jvm基础架构\">#</a> 一、JVM 基础架构</h4>\n<h5 id=\"11-jvm执行过程\"><a class=\"anchor\" href=\"#11-jvm执行过程\">#</a> 1.1 Jvm 执行过程</h5>\n<ol>\n<li>使用 java 编程语言开发 java 源代码，然后通过编译器把 java 编译为 java 类文件也叫字节码；</li>\n<li>通过类加载器 ClassLoader 将字节码加载到内存中，将其放在运行时数据区中的方法区内；</li>\n<li>然后调用执行引擎在 JVM 虚拟机中运行，然后将字节码编译成底层系统指令，在交由 CPU 执行；</li>\n<li>同时我们在编写程序时，不可能从头到尾去实现所有代码功能，可以通过 Java API 调用本地库接口（Native Interface）当中已经有的 java 代码来实现其他的功能（比如图形库、语言等）；</li>\n<li>总结：类的加载指的是将类的.class 文件中的二进制数据读取到内存中，将其放在运行时数据区的方法区内，然后在堆区创建一个对象，用来封装类在方法区的数据结构；</li>\n</ol>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/nKBTppH.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"12-jvm堆内存模型\"><a class=\"anchor\" href=\"#12-jvm堆内存模型\">#</a> 1.2 JVM 堆内存模型</h5>\n<ul>\n<li>\n<p>当 jvm 启动时，jvm 会自动从主机操作系统中取到一部分内存空间；</p>\n</li>\n<li>\n<p>然后 jvm 会自动将内存空间按照特定的格式，进行区域划分；</p>\n</li>\n<li>\n<p>划分区段的目的，主要是让垃圾回收算法能够更好的利用这些区域完成垃圾回收；</p>\n</li>\n<li>\n<p>jvm Heap 内存空间有三部分组成：</p>\n<ul>\n<li>年轻代</li>\n<li>老年代</li>\n</ul>\n</li>\n<li>\n<p>年轻代又可以划分三个子组成部分：</p>\n<ul>\n<li>新生区（Eden）：当一个对象刚刚创建时则创建在 Eden 中；</li>\n<li>存活区（Suvivor）：步入成熟区的初创对象；\n<ul>\n<li>Suvivor to</li>\n<li>Suvivor from</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>老年代</p>\n<ul>\n<li>\n<p>那些活跃的对象，很久都没有被回收掉，那么就送到老年代；</p>\n</li>\n<li>\n<p>如果年轻代内存不够，创建的对象过于庞大，则直接进入老年代，称之为分配担保；</p>\n</li>\n</ul>\n</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/EudJYlc.jpeg\" alt=\"3.jpg\" /></p>\n<h5 id=\"13-jvm堆内存参数分配\"><a class=\"anchor\" href=\"#13-jvm堆内存参数分配\">#</a> 1.3 JVM 堆内存参数分配</h5>\n<p>分配 JVM 内存空间，我们应该安装业务运行过程中，运行模式、或内存使用方式，来指定使用这些内存空间的大小，指定这些参数可以通过 java -opts 传递；</p>\n<ul>\n<li>-Xms：新生代和老年代初始空间；</li>\n<li>-Xmx：新生代和老年代总共可用的空间；</li>\n<li>-XX:NewSize：新生代初始空间；</li>\n<li>-XX:MaxNewSize：新生代最大空间</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/fnsr075.jpeg\" alt=\"4.jpg\" /></p>\n<h6 id=\"131-设置java项目的堆空间\"><a class=\"anchor\" href=\"#131-设置java项目的堆空间\">#</a> 1.3.1 设置 java 项目的堆空间</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat jvm_heap_params.java </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms100m</span> <span class=\"token parameter variable\">-Xmx100m</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> jvm_heap_params</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *    *************************************************</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *    */</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>public class jvm_heap_params <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\ttry <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\tThread.sleep<span class=\"token punctuation\">(</span>Integer.MAX_VALUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> catch <span class=\"token punctuation\">(</span>InterruptedException e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\te.printStackTrace<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"132-编译代码\"><a class=\"anchor\" href=\"#132-编译代码\">#</a> 1.3.2 编译代码</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac jvm_heap_params.java </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>jvm_heap_params.class  jvm_heap_params.java</pre></td></tr></table></figure><h6 id=\"133-指定堆内存启动\"><a class=\"anchor\" href=\"#133-指定堆内存启动\">#</a> 1.3.3 指定堆内存启动</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms200M -Xmx200M -cp . jvm_heap_params &amp;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">1664</span> jvm_heap_params</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">1676</span> Jps</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#通过 jinfo -flags 查看当前项目的内存分配</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># jinfo -flags 1664</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Attaching to process ID <span class=\"token number\">1664</span>, please wait<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Debugger attached successfully.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Server compiler detected.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>JVM version is <span class=\"token number\">25.451</span>-b10</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Non-default VM flags: <span class=\"token parameter variable\">-XX:CICompilerCount</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">209715200</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">209715200</span> <span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span><span class=\"token number\">69730304</span> <span class=\"token parameter variable\">-XX:MinHeapDeltaBytes</span><span class=\"token operator\">=</span><span class=\"token number\">524288</span> <span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span><span class=\"token number\">69730304</span> <span class=\"token parameter variable\">-XX:OldSize</span><span class=\"token operator\">=</span><span class=\"token number\">139984896</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseFastUnorderedTimeStamps</span> <span class=\"token parameter variable\">-XX:+UseParallelGC</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Command line:  <span class=\"token parameter variable\">-Xms200M</span> <span class=\"token parameter variable\">-Xmx200M</span></pre></td></tr></table></figure><h6 id=\"134-不指定堆内存启动\"><a class=\"anchor\" href=\"#134-不指定堆内存启动\">#</a> 1.3.4 不指定堆内存启动</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java  -cp . jvm_heap_params &amp;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">1763</span> Jps</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">1751</span> jvm_heap_params</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#通过 jinfo -flags 查看当前项目的内存分配</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># jinfo -flags 1751</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Attaching to process ID <span class=\"token number\">1751</span>, please wait<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Debugger attached successfully.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Server compiler detected.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>JVM version is <span class=\"token number\">25.451</span>-b10</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Non-default VM flags: <span class=\"token parameter variable\">-XX:CICompilerCount</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">31457280</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">478150656</span> <span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span><span class=\"token number\">159383552</span> <span class=\"token parameter variable\">-XX:MinHeapDeltaBytes</span><span class=\"token operator\">=</span><span class=\"token number\">524288</span> <span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:OldSize</span><span class=\"token operator\">=</span><span class=\"token number\">20971520</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseFastUnorderedTimeStamps</span> <span class=\"token parameter variable\">-XX:+UseParallelGC</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Command line:</pre></td></tr></table></figure><h5 id=\"14-tomcat设置堆空间\"><a class=\"anchor\" href=\"#14-tomcat设置堆空间\">#</a> 1.4 Tomcat 设置堆空间</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/bin/catalina.sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#添加如下内容</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPTS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token variable\">$JSSE_OPTS</span>\"</span>  <span class=\"token comment\">#下面添加</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPTS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> -Xms200m -Xmx200m -XX:+UseConcMarkSweepGC\"</span>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#生产服务器配置参数</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> -Xms2G -Xmx2G -XX:+UseConcMarkSweepGC\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1g8Q3Rg.jpeg\" alt=\"5.jpg\" /></p>\n<h4 id=\"二-gc垃圾回收算法\"><a class=\"anchor\" href=\"#二-gc垃圾回收算法\">#</a> 二、 GC 垃圾回收算法</h4>\n<h5 id=\"21-什么是垃圾\"><a class=\"anchor\" href=\"#21-什么是垃圾\">#</a> 2.1 什么是垃圾</h5>\n<ul>\n<li>GC 指的就是垃圾，垃圾指的是不在需要使用的 java 对象；</li>\n<li>程序在运行的过程中需要申请内存资源的，而在运行过程中，可能会产生无效的对象资源，如果不及时处理则会占用内存，最后造成内存溢出；</li>\n<li>Java 有自动垃圾回收机制，也就是 GC，使得开发能更专注业务代码，而无需关心内存释放问题；\n<ul>\n<li>那我们需要知道哪些对象是垃圾；</li>\n<li>以及这些垃圾对象该如何回收</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"22-如何确定哪些是垃圾\"><a class=\"anchor\" href=\"#22-如何确定哪些是垃圾\">#</a> 2.2 如何确定哪些是垃圾</h5>\n<p>如何确定哪些是垃圾，其实就是判断 “对象的存活状态”，常见的判断分析有两种：</p>\n<ul>\n<li>引用计数算法</li>\n<li>可达性分析算法</li>\n</ul>\n<h6 id=\"221-引用计数算法\"><a class=\"anchor\" href=\"#221-引用计数算法\">#</a> 2.2.1 引用计数算法</h6>\n<ul>\n<li>\n<p>实现原理：</p>\n<ul>\n<li>\n<p>给每个 Java 对象添加一个引用计数器；</p>\n</li>\n<li>\n<p>每当有一个地方引用它，计数器 + 1，引用失效则 - 1；</p>\n</li>\n<li>\n<p>当计数器不为 0 时，则判断对象为存活，否则判断为死亡；</p>\n</li>\n</ul>\n</li>\n<li>\n<p>算法优势</p>\n<ul>\n<li>\n<p>实现简单</p>\n</li>\n<li>\n<p>判断高效</p>\n</li>\n</ul>\n</li>\n<li>\n<p>算法缺陷</p>\n<ul>\n<li>每次对象被引用，都需要跟新计数器，存在时间开销；</li>\n<li>即使内存够用，在运行时进行计数，会让费 CPU 资源</li>\n<li>无法解决对象相互循环引用的问题，比如：\n<ul>\n<li><a href=\"http://objA.name\">objA.name</a> = objB;</li>\n<li><a href=\"http://objB.name\">objB.name</a> = objA;</li>\n<li>objA、objB 他们的计数器至少为 1，所以不可能被回收；</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>算法小结：</p>\n<ul>\n<li>由于算法存在判断逻辑漏洞，所以 JVM 虚拟机没有采用该算法判断 JAVA 对象是否存活；</li>\n</ul>\n</li>\n</ul>\n<h6 id=\"222-可达性分析算法\"><a class=\"anchor\" href=\"#222-可达性分析算法\">#</a> 2.2.2 可达性分析算法</h6>\n<p>Java 虚拟机采用的算法，可达性分析算法；</p>\n<ul>\n<li>将一系列 GC Roots 对象作为起点，从这些起点开始向下搜索；</li>\n<li>当一个对象 GC Roots 没有任何引用链相连时，则判断对象不可达，可以被 GC 回收；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/B6OLSwC.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"23-gc垃圾回收算法\"><a class=\"anchor\" href=\"#23-gc垃圾回收算法\">#</a> 2.3 GC 垃圾回收算法</h5>\n<p>GC 通过 “可达性分析算法” 标记了垃圾对象以及存活对象，那么该如何将标记的垃圾对象回收呢？</p>\n<ul>\n<li>标记 - 清除算法</li>\n<li>标记 - 复制算法</li>\n<li>标记 - 压缩算法</li>\n</ul>\n<h6 id=\"231-标记-清除算法\"><a class=\"anchor\" href=\"#231-标记-清除算法\">#</a> 2.3.1 标记 - 清除算法</h6>\n<p>标记清除算法分为两个阶段：</p>\n<ul>\n<li>标记阶段：标记出存活的对象，以及可回收的对象；</li>\n<li>清除阶段：回收掉所有被标记的对象；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/sx5sxl8.jpeg\" alt=\"2.jpg\" /></p>\n<p>标记清除算法缺点：</p>\n<ul>\n<li>效率不高，因为需要遍历所有的对象，然后标记存活对象，同时还要标记可回收对象；</li>\n<li>清除对象后位置不连续，难以找到连续的可用空间，所以容易产生碎片；</li>\n</ul>\n<h6 id=\"232-标记-复制算法\"><a class=\"anchor\" href=\"#232-标记-复制算法\">#</a> 2.3.2 标记 - 复制算法</h6>\n<p>算法基本概念：</p>\n<ul>\n<li>首先将内存划分为两块相等大小的区域，每次数据存储仅使用其中一块区域；</li>\n<li>当这一块区域使用完后，就将还存活的对象复制到另一块区域上面；</li>\n<li>最后将使用过的内存空间进行一次清理；</li>\n</ul>\n<p>算法工作过程：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ABEC1KS.jpeg\" alt=\"3.jpg\" /></p>\n<p>标记复制算法优点：</p>\n<ul>\n<li>在垃圾对象多的情况下，效率较高；</li>\n<li>垃圾清理后，内存无碎片；</li>\n</ul>\n<p>标记复制算法缺点：</p>\n<ul>\n<li>分配的两块内存区域，在同一时刻，只能使用一半，造成空间让费；</li>\n<li>如果创建的对象存活率较高时，需要在两个内存空间来回复制，效率低；</li>\n</ul>\n<h6 id=\"233-标记-压缩算法\"><a class=\"anchor\" href=\"#233-标记-压缩算法\">#</a> 2.3.3 标记 - 压缩算法</h6>\n<p>算法思想：它与 “标记复制” 算法类似，但是标记压缩算法不是把存活对象复制到另一块内存，而是把存活对象往内存的一端移动，然后直接回收边界以外的内存，因此不会产生内存碎片；</p>\n<p>算法工作过程：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Eg0fT8T.jpeg\" alt=\"4.jpg\" /></p>\n<h4 id=\"三-gc分代垃圾回收算法\"><a class=\"anchor\" href=\"#三-gc分代垃圾回收算法\">#</a> 三、GC 分代垃圾回收算法</h4>\n<p>由于 JVM 堆空间划分了年轻代和老年代，而且年轻代和老年代中存储对象各有特点，所以不同阶段适合使用不同的 GC 算法进行 GC 回收。</p>\n<p>根据回收对象的特点进行选择，在 JVM 中：</p>\n<ul>\n<li>年轻代对象存活时间低，适合使用 “复制算法”；</li>\n<li>老年代对象存活时间长，适合使用 “标记清除算法、标记压缩算法”；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/nlZrrag.jpeg\" alt=\"5.jpg\" /></p>\n<p>MinorGC/YoungGC：指年轻代触发 GC 动作</p>\n<p>MajorGC/OldGC：指老年代触发 GC 动作</p>\n<p>FullGC ：年轻代和老年代都没有空间，则全部回收，称之为 FullGC</p>\n<h5 id=\"31-gc年轻代垃圾回收-minorgcyounggc\"><a class=\"anchor\" href=\"#31-gc年轻代垃圾回收-minorgcyounggc\">#</a> 3.1 GC 年轻代垃圾回收 - MinorGC/YoungGC</h5>\n<h6 id=\"311-minorgcyounggc回收阶段1\"><a class=\"anchor\" href=\"#311-minorgcyounggc回收阶段1\">#</a> 3.1.1 MinorGC/YoungGC 回收阶段 1</h6>\n<ol>\n<li>刚刚启动 JVM 时，创建的对象会进入 Eden 区；</li>\n<li>当 Eden 区满了后，如果任然有新的对象需要创建，则会触发一次 MinorGC/YoungGC\n<ul>\n<li>通过根可达算法标记垃圾对象；</li>\n<li>将活跃的对象通过复制算法，复制到 S0 区域；</li>\n<li>然后将 Eden 对象去全部清除；</li>\n</ul>\n</li>\n<li>清理完成后，Eden 中没有任何对象，S0 中有存活对象，S1 中没有任何对象；</li>\n</ol>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iCz29Yz.jpeg\" alt=\"8.jpg\" /></p>\n<h6 id=\"312-minorgcyounggc回收阶段2\"><a class=\"anchor\" href=\"#312-minorgcyounggc回收阶段2\">#</a> 3.1.2 MinorGC/YoungGC 回收阶段 2</h6>\n<ol>\n<li>当再次创建对象时，对象任然会创建在 Eden 区；</li>\n<li>当 Eden 区空间满了后，会再次触发 GC 垃圾回收；\n<ul>\n<li>此时会将 Eden 区的对象复制到 S1 区；</li>\n<li>将 S0 存活的对象复制到 S1 区；</li>\n</ul>\n</li>\n<li>然后清理所有 Eden 区对象及 S0 区对象；</li>\n</ol>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/aCsOoV3.jpeg\" alt=\"9.jpg\" /></p>\n<h5 id=\"32-gc老年代垃圾回收-majorgcoldgc\"><a class=\"anchor\" href=\"#32-gc老年代垃圾回收-majorgcoldgc\">#</a> 3.2 GC 老年代垃圾回收 - MajorGC/OldGC</h5>\n<h6 id=\"321-majorgcoldgc回收阶段1\"><a class=\"anchor\" href=\"#321-majorgcoldgc回收阶段1\">#</a> 3.2.1 MajorGC/OldGC 回收阶段 1</h6>\n<ul>\n<li>当有较大对象创建时，可能不会出现在 Eden 区，而是直接进入老年代；</li>\n<li>每次在 From Survivor 到 To Survivor 移动时都存活的对象，年龄就 + 1，当年龄达到 15（Default）时，升级为老年代；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/wquhJo9.jpeg\" alt=\"6.jpg\" /></p>\n<h6 id=\"322-majorgcoldgc回收阶段2\"><a class=\"anchor\" href=\"#322-majorgcoldgc回收阶段2\">#</a> 3.2.2 MajorGC/OldGC 回收阶段 2</h6>\n<ul>\n<li>当创建新对象，如果 Eden + Survivor +Old 都无法存储时，就会发生 MajorGC/OldGC；\n<ul>\n<li>遍历整个堆，用来标记不存在使用的对象；</li>\n<li>将不在使用，或不存在访问的对象清除掉；</li>\n</ul>\n</li>\n<li>通常出现 MajorGC/OldGC 是指老年代发生了 GC；\n<ul>\n<li>当出现 MajorGC/OldGC 通常会伴随至少一次 MinorGC/YoungGC；</li>\n<li>而 MajorGC/OldGC 的速度通常会比 MinorGC/YoungGC 慢 10 倍以上；</li>\n</ul>\n</li>\n<li>如果 MinorGC/YoungGC 回收资源后，还是没有空间，则会触发 FullGC；将老年代和年轻代内存全部清空，一旦触发 FullGC 就需要熬过漫长的时间，甚至有可能要手动进行垃圾回收；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8hHenlL.jpeg\" alt=\"7.jpg\" /></p>\n<h5 id=\"33-stop-the-world\"><a class=\"anchor\" href=\"#33-stop-the-world\">#</a> 3.3 Stop-The-World</h5>\n<ul>\n<li>STW 是 Java 中一种全局暂停现象，多半有 GC 引起，所谓全局停顿，就是所有 Java 代码停止运行；</li>\n<li>一旦发生 GC，就是触发短暂的 STW，就好像垃圾车从家门口驶过，什么也做不了；</li>\n<li>STW 容易造成服务器长时间停止，以及资源不响应，对于 HA 系统，可能还会应急主备切换；</li>\n</ul>\n<h4 id=\"四-gc垃圾收集器\"><a class=\"anchor\" href=\"#四-gc垃圾收集器\">#</a> 四、GC 垃圾收集器</h4>\n<p>如果说 GC 垃圾回收算法只是内存回收的方法论，那 GC 垃圾收集器就是来具体实现这些算法，并实现内存回收；</p>\n<h5 id=\"41-gc垃圾收集器类型\"><a class=\"anchor\" href=\"#41-gc垃圾收集器类型\">#</a> 4.1 GC 垃圾收集器类型</h5>\n<ul>\n<li>串行垃圾收集器：GC 单线程实现内存垃圾回收，会暂停所有用户线程，如 Serial；</li>\n<li>并行垃圾收集器：GC 多线程并发实现内存垃圾回收，会暂停所有用户线程，如 ParNew、Parallel；</li>\n<li>并发垃圾收集器：用户线程和 GC 线程同时执行实现内存垃圾回收（不一定完全并行，可能交替执行），不停顿用户进程，或短暂停顿，如 CMS；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/olWEGJp.jpeg\" alt=\"11.jpg\" /></p>\n<p>Serial（复制算法）新生代单线程收集器，标记和清理都是单线程，优点简单高效；</p>\n<p>Serial Old（标记整理算法）老年代单线程收集器，Serial 收集器的老年代版本；</p>\n<p>ParNew（复制算法）新生代并行收集器，是 Serial 收集器的多线程版本，在多核 CPU 环境下会比 Serial 表现更好；</p>\n<p>Parallel Scavenge（复制算法）新生代并行收集器，追求高吞吐量，高效利用 CPU；</p>\n<p>Parallel Old（标记整理算法）Parallel Scavenge 老年代并行收集器，吞吐量优先；</p>\n<p>CMS（Concurrent Mark Sweep）（标记清除算法）老年代并行收集器，以获取最短回收停顿时间为目标的收集器，具有高并发、低停顿的特点，追求最短 GC 回收停顿时间；</p>\n<p>G1（Garbage First）（标记整理算法）并行收集器，G1 回收的范围是整个 Java 堆，包括新生代、老年代，而前六种收集器回收的范围仅限于新生代或老年代。</p>\n<h5 id=\"42-修改默认gc收集器\"><a class=\"anchor\" href=\"#42-修改默认gc收集器\">#</a> 4.2 修改默认 GC 收集器</h5>\n<p>Java 默认垃圾收集器为年轻代使用 Parallel Scavenge 垃圾收集器，老年代使用 Parallel Old 垃圾收集器，Tomcat 可以通过如下参数进行修改:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/bin/catalina.sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#添加如下内容</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPTS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token variable\">$JSSE_OPTS</span>\"</span>  <span class=\"token comment\">#下面添加</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> -Xms2G -Xmx2G -XX:+UseConcMarkSweepGC\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/LJLXv5v.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"43-串行垃圾收集器serial\"><a class=\"anchor\" href=\"#43-串行垃圾收集器serial\">#</a> 4.3 串行垃圾收集器 Serial</h5>\n<h6 id=\"431-serial基本概念\"><a class=\"anchor\" href=\"#431-serial基本概念\">#</a> 4.3.1 Serial 基本概念</h6>\n<ul>\n<li>串行垃圾收集器是最基本的、发展历史最悠久的收集器；</li>\n<li>特点：单线程、简单高效、对于限定单个 CPU 的环境来说，Serial 收集器由于没有线程交互的开销，专心做垃圾收集可以获得最高的单线程收集效率；</li>\n<li>注意：串行垃圾收集器在进行垃圾回收时，必须暂停其他所有的工作线程，直到它结束；</li>\n</ul>\n<h6 id=\"432-serial运行示意图\"><a class=\"anchor\" href=\"#432-serial运行示意图\">#</a> 4.3.2 Serial 运行示意图</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zdXbx6M.jpeg\" alt=\"2.jpg\" /></p>\n<h6 id=\"433-serialgc代码测试案例\"><a class=\"anchor\" href=\"#433-serialgc代码测试案例\">#</a> 4.3.3 SerialGC 代码测试案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 编写 java 代码 GC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat SerialGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   </pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *    思路：while循环中不断拼接字符串，直到oom异常</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *     <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms10m</span> <span class=\"token parameter variable\">-Xmx10m</span> <span class=\"token parameter variable\">-XX:+UseSerialGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *      <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> SerialGC</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> *       *************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *       */</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>public class SerialGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tString str <span class=\"token operator\">=</span> <span class=\"token string\">\"Oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tstr <span class=\"token operator\">+=</span> str + UUID.randomUUID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tstr.intern<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac SerialGC.java</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#2. 执行 java 代码，指定对应的 GC 收集器</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># -XX:+UseSerialGC 表示使用的 SerialGC</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 年轻代采用 SerialGC, 复制算法</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 老年代采用 SerialGCOld, 标记整理算法</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># GC 日志 https://www.cnblogs.com/gouge/p/9112782.html</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms10m -Xmx10m -XX:+UseSerialGC -XX:+PrintGCDetails -XX:+PrintCommandLineFlags -cp . SerialGC</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseSerialGC</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2747K-<span class=\"token operator\">></span>320K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011904</span> secs<span class=\"token punctuation\">]</span> 2747K-<span class=\"token operator\">></span>1148K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0012255</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2341K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0009890</span> secs<span class=\"token punctuation\">]</span> 3169K-<span class=\"token operator\">></span>2132K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0010105</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2678K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0006912</span> secs<span class=\"token punctuation\">]</span> 4810K-<span class=\"token operator\">></span>3444K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007214</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 1366K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004334</span> secs<span class=\"token punctuation\">]</span> 4810K-<span class=\"token operator\">></span>4756K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004566</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew <span class=\"token punctuation\">(</span>promotion failed<span class=\"token punctuation\">)</span> <span class=\"token builtin class-name\">:</span> 2678K-<span class=\"token operator\">></span>2678K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0002689</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Tenured: 4755K-<span class=\"token operator\">></span>3771K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0028598</span> secs<span class=\"token punctuation\">]</span> 7434K-<span class=\"token operator\">></span>3771K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3013K-<span class=\"token operator\">></span>3013K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0031812</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2678K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0018376</span> secs<span class=\"token punctuation\">]</span> 6449K-<span class=\"token operator\">></span>6395K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0018952</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2677K-<span class=\"token operator\">></span>2677K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0000409</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Tenured: 6395K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0032290</span> secs<span class=\"token punctuation\">]</span> 9073K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3013K-<span class=\"token operator\">></span>3013K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0033621</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Tenured: 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0028646</span> secs<span class=\"token punctuation\">]</span> 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3013K-<span class=\"token operator\">></span>3013K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0028871</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Exception <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> java.lang.OutOfMemoryError: Java heap space</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tat java.util.Arrays.copyOf<span class=\"token punctuation\">(</span>Arrays.java:3332<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tat java.lang.AbstractStringBuilder.ensureCapacityInternal<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:124<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tat java.lang.AbstractStringBuilder.append<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:448<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:142<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:137<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tat SerialGC.main<span class=\"token punctuation\">(</span>SerialGC.java:17<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>Heap</pre></td></tr><tr><td data-num=\"49\"></td><td><pre> def new generation   total 3072K, used 109K <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff950000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  eden space 2752K,   <span class=\"token number\">3</span>% used <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff61b5a8, 0x00000000ff8b0000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  from space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff8b0000, 0x00000000ff8b0000, 0x00000000ff900000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  to   space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff900000, 0x00000000ff900000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre> tenured generation   total 6848K, used 4408K <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x0000000100000000, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   the space 6848K,  <span class=\"token number\">64</span>% used <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x00000000ffd9e2b0, 0x00000000ffd9e400, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre> Metaspace       used 3046K, capacity 4486K, committed 4864K, reserved 1056768K</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  class space    used 330K, capacity 386K, committed 512K, reserved 1048576K</pre></td></tr></table></figure><h5 id=\"44并行垃圾收集器parnew\"><a class=\"anchor\" href=\"#44并行垃圾收集器parnew\">#</a> 4.4 并行垃圾收集器 ParNew</h5>\n<h6 id=\"441-parnew基本概念\"><a class=\"anchor\" href=\"#441-parnew基本概念\">#</a> 4.4.1 ParNew 基本概念</h6>\n<p>并行垃圾收集器在串行垃圾收集器的基础上做了改进，将单线程改为了多线程进行垃圾回收，这样可以缩短垃圾回收的时间，但还是会存在 STW （ Stop-The-World）的问题。</p>\n<h6 id=\"442-parnew运行示意图\"><a class=\"anchor\" href=\"#442-parnew运行示意图\">#</a> 4.4.2 ParNew 运行示意图</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/0Ad9b9b.jpeg\" alt=\"1.jpg\" /></p>\n<h6 id=\"443-parnewgc代码测试案例\"><a class=\"anchor\" href=\"#443-parnewgc代码测试案例\">#</a> 4.4.3 ParNewGC 代码测试案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 编写 java 代码 GC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ParNewGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *   思路：while循环中不断拼接字符串，直到oom异常</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *    <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms10m</span> <span class=\"token parameter variable\">-Xmx10m</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *     <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> ParNewGC</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *      </pre></td></tr><tr><td data-num=\"12\"></td><td><pre> *       *************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *       */</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>public class ParNewGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tString str <span class=\"token operator\">=</span> <span class=\"token string\">\"Oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tstr <span class=\"token operator\">+=</span> str + UUID.randomUUID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tstr.intern<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac ParNewGC.java</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 2. 执行 java 代码，指定对应的 GC 收集器</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 使用年轻代 UseParNew GC 默认激活老年代 SeariaOld GC（单线程）</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms10m -Xmx10m -XX:+UseParNewGC -XX:+PrintGCDetails -XX:+PrintCommandLineFlags -cp . ParNewGC</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Java HotSpot<span class=\"token punctuation\">(</span>TM<span class=\"token punctuation\">)</span> <span class=\"token number\">64</span>-Bit Server VM warning: Using the ParNew young collector with the Serial old collector is deprecated and will likely be removed <span class=\"token keyword\">in</span> a future release</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2747K-<span class=\"token operator\">></span>320K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0010884</span> secs<span class=\"token punctuation\">]</span> 2747K-<span class=\"token operator\">></span>1160K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011451</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2341K-<span class=\"token operator\">></span>227K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0019999</span> secs<span class=\"token punctuation\">]</span> 3181K-<span class=\"token operator\">></span>2380K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0020246</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2905K-<span class=\"token operator\">></span>28K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011000</span> secs<span class=\"token punctuation\">]</span> 5058K-<span class=\"token operator\">></span>3493K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011400</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 1394K-<span class=\"token operator\">></span>7K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011553</span> secs<span class=\"token punctuation\">]</span> 4859K-<span class=\"token operator\">></span>4783K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011894</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew <span class=\"token punctuation\">(</span>promotion failed<span class=\"token punctuation\">)</span>: 2685K-<span class=\"token operator\">></span>2679K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0006935</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Tenured: 4776K-<span class=\"token operator\">></span>3771K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0032073</span> secs<span class=\"token punctuation\">]</span> 7461K-<span class=\"token operator\">></span>3771K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3010K-<span class=\"token operator\">></span>3010K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0039609</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2678K-<span class=\"token operator\">></span>2K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011295</span> secs<span class=\"token punctuation\">]</span> 6449K-<span class=\"token operator\">></span>6397K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011634</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2679K-<span class=\"token operator\">></span>2679K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0000115</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Tenured: 6395K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0039025</span> secs<span class=\"token punctuation\">]</span> 9075K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3010K-<span class=\"token operator\">></span>3010K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0039539</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Tenured: 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0024659</span> secs<span class=\"token punctuation\">]</span> 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3010K-<span class=\"token operator\">></span>3010K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0024877</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>Exception <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> java.lang.OutOfMemoryError: Java heap space</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tat java.util.Arrays.copyOf<span class=\"token punctuation\">(</span>Arrays.java:3332<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tat java.lang.AbstractStringBuilder.ensureCapacityInternal<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:124<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tat java.lang.AbstractStringBuilder.append<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:448<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:142<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:137<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tat ParNewGC.main<span class=\"token punctuation\">(</span>ParNewGC.java:17<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>Heap</pre></td></tr><tr><td data-num=\"48\"></td><td><pre> par new generation   total 3072K, used 109K <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff950000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  eden space 2752K,   <span class=\"token number\">3</span>% used <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff61b5a8, 0x00000000ff8b0000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  from space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff8b0000, 0x00000000ff8b0000, 0x00000000ff900000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  to   space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff900000, 0x00000000ff900000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre> tenured generation   total 6848K, used 4408K <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x0000000100000000, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   the space 6848K,  <span class=\"token number\">64</span>% used <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x00000000ffd9e208, 0x00000000ffd9e400, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre> Metaspace       used 3044K, capacity 4486K, committed 4864K, reserved 1056768K</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  class space    used 330K, capacity 386K, committed 512K, reserved 1048576K</pre></td></tr></table></figure><h5 id=\"45-并行垃圾收集器parallel\"><a class=\"anchor\" href=\"#45-并行垃圾收集器parallel\">#</a> 4.5 并行垃圾收集器 Parallel</h5>\n<h6 id=\"451-parallel基本概念\"><a class=\"anchor\" href=\"#451-parallel基本概念\">#</a> 4.5.1 Parallel 基本概念</h6>\n<p>并行垃圾收集器在串行垃圾收集器的基础上做了改进，将单线程改为了多线程进行垃圾回收，这样可以缩短垃圾回收的时间，但还是会存在 STW （ Stop-The-World）的问题。</p>\n<h6 id=\"452-parallel运行示意图\"><a class=\"anchor\" href=\"#452-parallel运行示意图\">#</a> 4.5.2 Parallel 运行示意图</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/7PSWcv2.jpeg\" alt=\"3.jpg\" /></p>\n<h6 id=\"453-parallelgc代码测试案例\"><a class=\"anchor\" href=\"#453-parallelgc代码测试案例\">#</a> 4.5.3 ParallelGC 代码测试案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 编写 java 代码 GC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ParallelGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *  思路：while循环中不断拼接字符串，直到oom异常</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *   <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms10m</span> <span class=\"token parameter variable\">-Xmx10m</span> <span class=\"token parameter variable\">-XX:+UseParallelGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *    <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> ParallelGC</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> *     *************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *     */</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>public class ParallelGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tString str <span class=\"token operator\">=</span> <span class=\"token string\">\"Oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tstr <span class=\"token operator\">+=</span> str + UUID.randomUUID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tstr.intern<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac ParallelGC.java  \t\t\t</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 2. 执行 java 代码，指定对应的 GC 收集器</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 使用年轻代 ParallelScauenge GC 默认激活老年代 ParallelOld GC（单线程）\t\t\t</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\">#  java -Xms10m -Xmx10m -XX:+UseParallelGC -XX:+PrintGCDetails -XX:+PrintCommandLineFlags -cp . ParallelGC</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseParallelGC</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 1744K-<span class=\"token operator\">></span>501K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 1744K-<span class=\"token operator\">></span>773K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0013675</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 2509K-<span class=\"token operator\">></span>503K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 2781K-<span class=\"token operator\">></span>843K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0006946</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 2184K-<span class=\"token operator\">></span>240K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 3835K-<span class=\"token operator\">></span>2547K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0022336</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 2248K-<span class=\"token operator\">></span>240K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 8491K-<span class=\"token operator\">></span>6483K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007844</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> --<span class=\"token punctuation\">[</span>PSYoungGen: 1592K-<span class=\"token operator\">></span>1592K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 7836K-<span class=\"token operator\">></span>7836K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011287</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Ergonomics<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 1592K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>ParOldGen: 6243K-<span class=\"token operator\">></span>3114K<span class=\"token punctuation\">(</span>7168K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 7836K-<span class=\"token operator\">></span>3114K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0064498</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 40K-<span class=\"token operator\">></span>64K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 5779K-<span class=\"token operator\">></span>5802K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007213</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 64K-<span class=\"token operator\">></span>32K<span class=\"token punctuation\">(</span>1536K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 5802K-<span class=\"token operator\">></span>5770K<span class=\"token punctuation\">(</span>8704K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0010992</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 32K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>1536K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>ParOldGen: 5738K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>7168K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 5770K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>8704K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0030299</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 0K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>2048K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 4427K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>9216K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007654</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 0K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>2048K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>ParOldGen: 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>7168K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>9216K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0056029</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>Exception <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> java.lang.OutOfMemoryError: Java heap space</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tat java.util.Arrays.copyOf<span class=\"token punctuation\">(</span>Arrays.java:3332<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tat java.lang.AbstractStringBuilder.ensureCapacityInternal<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:124<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tat java.lang.AbstractStringBuilder.append<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:448<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:142<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:137<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tat ParallelGC.main<span class=\"token punctuation\">(</span>ParallelGC.java:17<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>Heap</pre></td></tr><tr><td data-num=\"50\"></td><td><pre> PSYoungGen      total 2048K, used 41K <span class=\"token punctuation\">[</span>0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  eden space 1024K, <span class=\"token number\">4</span>% used <span class=\"token punctuation\">[</span>0x00000000ffd00000,0x00000000ffd0a428,0x00000000ffe00000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  from space 1024K, <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ffe00000,0x00000000ffe00000,0x00000000fff00000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  to   space 1024K, <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000fff00000,0x00000000fff00000,0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre> ParOldGen       total 7168K, used 4408K <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  object space 7168K, <span class=\"token number\">61</span>% used <span class=\"token punctuation\">[</span>0x00000000ff600000,0x00000000ffa4e218,0x00000000ffd00000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre> Metaspace       used 3042K, capacity 4486K, committed 4864K, reserved 1056768K</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  class space    used 330K, capacity 386K, committed 512K, reserved 1048576K</pre></td></tr></table></figure><h5 id=\"46-并发垃圾收集器cms\"><a class=\"anchor\" href=\"#46-并发垃圾收集器cms\">#</a> 4.6 并发垃圾收集器 CMS</h5>\n<h6 id=\"461-cms基本概念\"><a class=\"anchor\" href=\"#461-cms基本概念\">#</a> 4.6.1 CMS 基本概念</h6>\n<ul>\n<li>CMS 全程 Concurrent Mark Sweep，是一款并发的、使用标记清除算法的垃圾回收器；</li>\n<li>CMS 回收器是针对老年代进行垃圾回收，它在某些阶段尽量与工作线程一起运行，以获取最短响应时间，减少 STW 时长（200ms 以内），提升响应速度，是互联网系统上较佳的回收算法；</li>\n<li>通过 - XX:+UseConcMarkSweepGC 参数启用老年代 CMS 回收器，会同时激活年轻代的 ParNEW 回收器；</li>\n</ul>\n<h6 id=\"462-cms运行示意图\"><a class=\"anchor\" href=\"#462-cms运行示意图\">#</a> 4.6.2 CMS 运行示意图</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/XeTE8CT.jpeg\" alt=\"4.jpg\" /></p>\n<ul>\n<li>CMS 优点：低停顿，并发执行；</li>\n<li>CMS 缺点：\n<ul>\n<li>并发执行对 CPU 资源压力大；</li>\n<li>无法处理在处理过程中产生的垃圾；</li>\n<li>采用标记清除算法会导致大量碎片，从而在分配大对象时，可能会触发 FullGC;</li>\n</ul>\n</li>\n</ul>\n<h6 id=\"463-cms-gc代码测试案例\"><a class=\"anchor\" href=\"#463-cms-gc代码测试案例\">#</a> 4.6.3 CMS GC 代码测试案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1. 编写 java 代码 GC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat CMSGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *  思路：while循环中不断拼接字符串，直到oom异常</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *   <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms10m</span> <span class=\"token parameter variable\">-Xmx10m</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *    <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> CMSGC</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> *     *************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *     */</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>public class CMSGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tString str <span class=\"token operator\">=</span> <span class=\"token string\">\"Oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tstr <span class=\"token operator\">+=</span> str + UUID.randomUUID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tstr.intern<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac CMSGC.java \t\t\t</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 2. 执行 java 代码，指定对应的 GC 收集器</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 使用年轻代 ParNewGC 默认激活老年代 ConcMarkSweepGC</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms10m -Xmx10m -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:+PrintCommandLineFlags -cp . CMSGC</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span><span class=\"token number\">3497984</span> <span class=\"token parameter variable\">-XX:MaxTenuringThreshold</span><span class=\"token operator\">=</span><span class=\"token number\">6</span> <span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span><span class=\"token number\">3497984</span> <span class=\"token parameter variable\">-XX:OldPLABSize</span><span class=\"token operator\">=</span><span class=\"token number\">16</span> <span class=\"token parameter variable\">-XX:OldSize</span><span class=\"token operator\">=</span><span class=\"token number\">6987776</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2747K-<span class=\"token operator\">></span>320K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0023735</span> secs<span class=\"token punctuation\">]</span> 2747K-<span class=\"token operator\">></span>1159K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0024383</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2341K-<span class=\"token operator\">></span>116K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0018810</span> secs<span class=\"token punctuation\">]</span> 3181K-<span class=\"token operator\">></span>2261K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0019107</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2794K-<span class=\"token operator\">></span>58K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0009690</span> secs<span class=\"token punctuation\">]</span> 4938K-<span class=\"token operator\">></span>3514K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0010009</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 1424K-<span class=\"token operator\">></span>14K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007894</span> secs<span class=\"token punctuation\">]</span> 4880K-<span class=\"token operator\">></span>4783K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0008156</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Initial Mark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-initial-mark: 4768K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 7460K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004243</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-mark-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew <span class=\"token punctuation\">(</span>promotion failed<span class=\"token punctuation\">)</span>: 2692K-<span class=\"token operator\">></span>2681K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004579</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>CMS<span class=\"token punctuation\">[</span>CMS-concurrent-mark: <span class=\"token number\">0.001</span>/0.002 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre> <span class=\"token punctuation\">(</span>concurrent mode failure<span class=\"token punctuation\">)</span>: 4768K-<span class=\"token operator\">></span>3778K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0040684</span> secs<span class=\"token punctuation\">]</span> 7460K-<span class=\"token operator\">></span>3778K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3008K-<span class=\"token operator\">></span>3008K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0046737</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2678K-<span class=\"token operator\">></span>2K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007443</span> secs<span class=\"token punctuation\">]</span> 6456K-<span class=\"token operator\">></span>6408K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0008044</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Initial Mark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-initial-mark: 6406K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 9031K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0003723</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-mark-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-mark: <span class=\"token number\">0.001</span>/0.001 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-preclean-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-preclean: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-abortable-preclean-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-abortable-preclean: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Final Remark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>YG occupancy: <span class=\"token number\">2679</span> K <span class=\"token punctuation\">(</span><span class=\"token number\">3072</span> K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Rescan <span class=\"token punctuation\">(</span>parallel<span class=\"token punctuation\">)</span> , <span class=\"token number\">0.0010492</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>weak refs processing, <span class=\"token number\">0.0000088</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>class unloading, <span class=\"token number\">0.0002491</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>scrub symbol table, <span class=\"token number\">0.0003293</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>scrub string table, <span class=\"token number\">0.0002142</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-remark: 6406K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 9085K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0019372</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-sweep-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-sweep: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-reset-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-reset: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2679K-<span class=\"token operator\">></span>2K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0008976</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>CMS: 5749K-<span class=\"token operator\">></span>4433K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0029519</span> secs<span class=\"token punctuation\">]</span> 5805K-<span class=\"token operator\">></span>4433K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0038988</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>CMS: 4433K-<span class=\"token operator\">></span>4414K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0027747</span> secs<span class=\"token punctuation\">]</span> 4433K-<span class=\"token operator\">></span>4414K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0028025</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Initial Mark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-initial-mark: 4414K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 4468K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004950</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-mark-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>Exception <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> <span class=\"token punctuation\">[</span>CMS-concurrent-mark: <span class=\"token number\">0.001</span>/0.001 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-preclean-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>java.lang.OutOfMemoryError: Java heap space</pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-preclean: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Final Remark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>YG occupancy: <span class=\"token number\">54</span> K <span class=\"token punctuation\">(</span><span class=\"token number\">3072</span> K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Rescan <span class=\"token punctuation\">(</span>parallel<span class=\"token punctuation\">)</span> , <span class=\"token number\">0.0006640</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>weak refs processing, <span class=\"token number\">0.0000071</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>class unloading, <span class=\"token number\">0.0002738</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>scrub symbol table, <span class=\"token number\">0.0003376</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>scrub string table, <span class=\"token number\">0.0002713</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-remark: 4414K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 4468K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0016334</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-sweep-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-sweep: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-reset-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-reset: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\tat java.util.Arrays.copyOf<span class=\"token punctuation\">(</span>Arrays.java:3332<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tat java.lang.AbstractStringBuilder.ensureCapacityInternal<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:124<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tat java.lang.AbstractStringBuilder.append<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:448<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:142<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:137<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\tat CMSGC.main<span class=\"token punctuation\">(</span>CMSGC.java:17<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>Heap</pre></td></tr><tr><td data-num=\"72\"></td><td><pre> par new generation   total 3072K, used 109K <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff950000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  eden space 2752K,   <span class=\"token number\">3</span>% used <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff61b5a8, 0x00000000ff8b0000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  from space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff900000, 0x00000000ff900000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  to   space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff8b0000, 0x00000000ff8b0000, 0x00000000ff900000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre> concurrent mark-sweep generation total 6848K, used 477K <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x0000000100000000, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre> Metaspace       used 3042K, capacity 4486K, committed 4864K, reserved 1056768K</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  class space    used 330K, capacity 386K, committed 512K, reserved 1048576K</pre></td></tr></table></figure><h4 id=\"五-jvm性能调优实践\"><a class=\"anchor\" href=\"#五-jvm性能调优实践\">#</a> 五、JVM 性能调优实践</h4>\n<ul>\n<li>调优一般包含多个层次，如：架构调优、代码调优、数据库调优、JVM 调优、操作系统调优；</li>\n<li>架构调优和代码调优是 JVM 调优的基础；</li>\n<li>当我们的架构和代码都已经调优后，还不能满足业务需求，才需要进行 JVM 调优；</li>\n</ul>\n<h5 id=\"51-什么是jvm调优\"><a class=\"anchor\" href=\"#51-什么是jvm调优\">#</a> 5.1 什么是 JVM 调优</h5>\n<ul>\n<li>\n<p>既然要进行 JVM 调优，那么就一定需要量化指标；</p>\n</li>\n<li>\n<p>JVM 调优原则：尽可能使用较小的内存和 CPU 来让 JAVA 程序获得更高的吞吐量以及较低的延迟；</p>\n<ul>\n<li>吞吐量：是指不考虑垃圾收集器引起的停顿时间或内存消耗，应用达到的最高性能指标</li>\n<li>低延迟：GC 停顿时间端，以及 GC 触发频率低；</li>\n<li>低内存：比较低的内存空间，能够获取程序的稳定运行；</li>\n</ul>\n</li>\n<li>\n<p>值得注意的是：任何一个指标性能的提高，几乎都是以牺牲其他性能指标的损耗为代价，两者不可兼得，具体需要根据业务的重要性做权衡；</p>\n</li>\n</ul>\n<h5 id=\"52-何时不需要jvm调优\"><a class=\"anchor\" href=\"#52-何时不需要jvm调优\">#</a> 5.2 何时不需要 JVM 调优</h5>\n<ul>\n<li>MinorGC 执行时间不到 50ms;</li>\n<li>MinorGC 执行不频繁，约 10s 一次；</li>\n<li>FullGC 执行时间不到 1s;</li>\n</ul>\n<h5 id=\"53-何时需要jvm调优\"><a class=\"anchor\" href=\"#53-何时需要jvm调优\">#</a> 5.3 何时需要 JVM 调优</h5>\n<p>当运行业务代码出现如下情况，则需要考虑进行 JVM 调优，但前提是代码没有办法进行优化了：</p>\n<ul>\n<li>FullGC 次数频繁：FullGC 如果很频繁的话，基本上可以肯定是分配的内存不够用；</li>\n<li>GC 停顿时间过长 1s：GC 过长会导致 STM 时间过长，肯定是内存堆空间分配不合理；</li>\n<li>应用出现 OOM 内存溢出；</li>\n<li>系统吞吐量与响应性能不高或持续下降：一般是 GC 停顿问题造成；</li>\n</ul>\n<h5 id=\"54-jvm调优常规方法\"><a class=\"anchor\" href=\"#54-jvm调优常规方法\">#</a> 5.4 JVM 调优常规方法</h5>\n<p>JVM 调优是一个手段，但是并不是定所有问题都可以通过 JVM 进行调优解决；</p>\n<ul>\n<li>大多数的 JAVA 应用不需要进行 JVM 调优；\n<ul>\n<li>首先项目还没有复杂到需要做 JVM 调优的程序，而且现在的机器内存都很大，可以尽情使用；</li>\n<li>其次 JVM 调优有一定难度，需要有相应工程调优经验，否则没有作用，或者造成性能反而下降；</li>\n</ul>\n</li>\n<li>大多数导致 GC 问题的原因是代码层面的问题导致；</li>\n<li>选择合适的 GC 收集器，并设置合理的堆空间参数；</li>\n<li>减少使用全局变量和大对象，减少创建对象的数量；\n<ul>\n<li>全局变量几乎不会被回收；</li>\n<li>大对象会直接进入老年代，从而造成 MajorGC；</li>\n</ul>\n</li>\n<li>分析 GC 日志优化代码比优化 JVM 参数效果更好；</li>\n<li>优先架构调优和代码调优，JVM 优化优先级放到最低；</li>\n<li>JVM 堆设置，一般通过 - Xms、-Xmx 限定最小值、最大值，为了避免垃圾收集器在最小、最大之间收缩堆而产生额外的时间和资源开销，通常把最大、最小设置为相同的值；</li>\n</ul>\n<h5 id=\"55-jvm各区域的默认值\"><a class=\"anchor\" href=\"#55-jvm各区域的默认值\">#</a> 5.5 JVM 各区域的默认值</h5>\n<p>参考链接：<a href=\"https://blog.csdn.net/qq_27184497/article/details/119055669\">https://blog.csdn.net/qq_27184497/article/details/119055669</a></p>\n<ul>\n<li>堆空间初始值：由 - Xms 指定，默认是物理内存的 1/64。比如电脑内存是 16G，由此得出公式为：16*1024/64=256M</li>\n<li>堆空间最大值：由 - Xmx 指定，默认是物理内存的 1/4。比如我电脑内存是 16G，由此得出公式为：16/4=4G</li>\n<li>老年代 ：占用整个堆内存 2/3 的空间，比如我目前堆内存是 4G，由此得出公式为：4*1024*(2/3)≈ 2730</li>\n<li>新生代：占用整个堆的 1/3 的空间；实际可用的是 4*1024*(1/3)≈ 1365 ，另外新生代实际可用的内存为 1365*80% ;</li>\n</ul>\n<p>新生代通过以下参数设置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span>256m      <span class=\"token comment\">#设置新生代初始内存</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span>256m   <span class=\"token comment\">#设置新生代最大内存</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token parameter variable\">-Xmn256m</span>             <span class=\"token comment\">#将 NewSize 与 MaxNewSize 设为一致 256m</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/wprIX9J.png\" alt=\"1.png\" /></p>\n<p>可以自行指定的参数：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token parameter variable\">-Xms500M</span>  \t\t\t\t\t  <span class=\"token comment\">#指定初始堆空间大小；</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token parameter variable\">-Xmx500M</span> \t\t\t\t\t  <span class=\"token comment\">#最大的堆空间大小；</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token parameter variable\">-XX:NewRatio</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\t\t\t      <span class=\"token comment\">#调整新生代和老年的比率； \t1:1，  默认是 1:2</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">6</span>  \t      <span class=\"token comment\">#调整年轻代中 Eden 和 Sur 比率： 6:2:2  默认 8:1:1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#参数示例</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token parameter variable\">-Xms500M</span>  <span class=\"token parameter variable\">-Xmx500M</span> <span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">6</span>  <span class=\"token parameter variable\">-XX:NewRatio</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>新生代：\t250MB</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Eden：\t  150M\t\t    <span class=\"token number\">60</span>%</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>From：\t  50M\t\t\t<span class=\"token number\">20</span>%</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>To：  \t  50M\t\t\t<span class=\"token number\">20</span>%</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>老年代：\t250MB</pre></td></tr></table></figure><h5 id=\"56-jvm优化代码示例一\"><a class=\"anchor\" href=\"#56-jvm优化代码示例一\">#</a> 5.6 JVM 优化代码示例一</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 示例代码</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat MoreMinorGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>@SuppressWarnings<span class=\"token punctuation\">(</span><span class=\"token string\">\"all\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>public class MoreMinorGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    private static void minorGC<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> throws InterruptedException <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        byte<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> x <span class=\"token operator\">=</span> new byte<span class=\"token punctuation\">[</span><span class=\"token number\">1024</span> * <span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   // 在 Eden 区域放入一个 1MB 的对象</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        x <span class=\"token operator\">=</span> new byte<span class=\"token punctuation\">[</span><span class=\"token number\">1024</span> * <span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        x <span class=\"token operator\">=</span> new byte<span class=\"token punctuation\">[</span><span class=\"token number\">1024</span> * <span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  // 会导致前两个 1MB 的对象成为垃圾对象</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        x <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>   // 将之前的三个 1MB 的对象都变成垃圾对象</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        // 这句代码就会触发年轻代的 Minor GC</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        byte<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> y <span class=\"token operator\">=</span> new byte<span class=\"token punctuation\">[</span><span class=\"token number\">2</span> * <span class=\"token number\">1024</span> * <span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   // 在 Eden 区中分配一个 2MB 的对象</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        Thread.sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    public static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> throws InterruptedException <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            minorGC<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#2. 编译代码</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac MoreMinorGC.java</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#3. 运行代码</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java \\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span>5M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span>5M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span>10M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span>10M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">8</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> MoreMinorGC</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">#4. 代码运行参数描述</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span>5M                           <span class=\"token comment\">#新生代初始内存</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span>5M                   <span class=\"token comment\">#新生代最大内存</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span>10M             <span class=\"token comment\">#初始堆空间 Xms</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span>10M               <span class=\"token comment\">#最大堆空间 Xmx</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">8</span>                     <span class=\"token comment\">#Eden、Survivore from、Survivore to 比例为 8:1:1</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span>                     <span class=\"token comment\">#新生代使用 ParNewGC</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span>     <span class=\"token comment\">#老年代使用 CMSGC</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span>                     <span class=\"token comment\">#打印 GC 日志</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span>   <span class=\"token comment\">#打印 GC 日志</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">#5. 追踪 GC</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token number\">8325</span> MoreMinorGC</pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token number\">6553</span> Bootstrap</pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token number\">8361</span> Jps</pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token number\">6574</span> plugin-core.jar</pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jstat -gc 8325</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token number\">512.0</span>  <span class=\"token number\">512.0</span>   <span class=\"token number\">0.0</span>    <span class=\"token number\">0.0</span>    <span class=\"token number\">4096.0</span>   <span class=\"token number\">2048.0</span>    <span class=\"token number\">5120.0</span>     <span class=\"token number\">3320.4</span>   <span class=\"token number\">4864.0</span> <span class=\"token number\">2479.2</span> <span class=\"token number\">512.0</span>  <span class=\"token number\">264.9</span>     <span class=\"token number\">199</span>    <span class=\"token number\">0.057</span>  <span class=\"token number\">49</span>      <span class=\"token number\">0.028</span>    <span class=\"token number\">0.08</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\">#6 将程序运行的堆内存扩大 10 倍</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java \\</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span>50M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span>50M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span>100M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span>100M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">8</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> MoreMinorGC</pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token comment\">#7. 追踪 GC，发现 YGC 没有那么频繁了，同时没有产生 FGC，GCT 时间明显变短了</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token number\">8400</span> MoreMinorGC</pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token number\">6553</span> Bootstrap</pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token number\">6574</span> plugin-core.jar</pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token number\">8414</span> Jps</pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jstat -gc 8400</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token number\">5120.0</span> <span class=\"token number\">5120.0</span> <span class=\"token number\">1414.5</span>  <span class=\"token number\">0.0</span>   <span class=\"token number\">40960.0</span>  <span class=\"token number\">39715.8</span>   <span class=\"token number\">51200.0</span>      <span class=\"token number\">0.0</span>     <span class=\"token number\">4864.0</span> <span class=\"token number\">2479.2</span> <span class=\"token number\">512.0</span>  <span class=\"token number\">264.9</span>       <span class=\"token number\">2</span>    <span class=\"token number\">0.008</span>   <span class=\"token number\">0</span>      <span class=\"token number\">0.000</span>    <span class=\"token number\">0.00</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token comment\">#8.GC 参数描述</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>S0C：Surivor区S0的大小</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>S1C：Surivor区S1的大小</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>S0U：Surivor区S0的使用大小</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>S1U：Surivor区S1的使用大小</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>EC： Eden区的大小</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>EU：Eden区的使用大小</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>OC：老年代大小</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>OU：老年代使用大小</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>MC：方法区大小</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>MU：方法区使用大小</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>CCSC:压缩类空间大小</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>CCSU:压缩类空间使用大小</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>YGC：年轻代垃圾回收次数</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>YGCT：年轻代垃圾回收消耗时间</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>FGC：老年代垃圾回收次数</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>FGCT：老年代垃圾回收消耗时间</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>GCT：垃圾回收消耗总时间</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>单位：KB</pre></td></tr></table></figure><h5 id=\"57-jvm优化代码示例二fullgc\"><a class=\"anchor\" href=\"#57-jvm优化代码示例二fullgc\">#</a> 5.7 JVM 优化代码示例二 FullGC</h5>\n<p>FullGc：清理整个内存堆，即包括年轻的也包括老年代</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 示例代码</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat MoreFullGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.time.LocalDate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">import</span> java.util.ArrayList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">import</span> java.util.List<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">import</span> java.util.concurrent.ScheduledThreadPoolExecutor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">import</span> java.util.concurrent.ThreadPoolExecutor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">import</span> java.util.concurrent.TimeUnit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>优化前</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token parameter variable\">-Xms20M</span> <span class=\"token parameter variable\">-Xmx20M</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintGCTimeStamps</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>优化后</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token parameter variable\">-Xms200M</span> <span class=\"token parameter variable\">-Xmx200M</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintGCTimeStamps</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>*/</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>@SuppressWarnings<span class=\"token punctuation\">(</span><span class=\"token string\">\"all\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>public class MoreFullGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    private static class Oldxu <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        private String name <span class=\"token operator\">=</span> <span class=\"token string\">\"oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        private int age <span class=\"token operator\">=</span> <span class=\"token number\">18</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        private String gender <span class=\"token operator\">=</span> <span class=\"token string\">\"male\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        private LocalDate birthday <span class=\"token operator\">=</span> LocalDate.MAX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        public void <span class=\"token function-name function\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            //</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    /** 线程池 */</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    private static final ScheduledThreadPoolExecutor executor <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            new ScheduledThreadPoolExecutor<span class=\"token punctuation\">(</span><span class=\"token number\">50</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    new ThreadPoolExecutor.DiscardOldestPolicy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    private static void processOldxu<span class=\"token punctuation\">(</span>List<span class=\"token operator\">&lt;</span>Oldxu<span class=\"token operator\">></span> Oldxu<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        Oldxu.forEach<span class=\"token punctuation\">(</span>i -<span class=\"token operator\">></span> executor.scheduleWithFixedDelay<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                i::func, <span class=\"token number\">2</span>, <span class=\"token number\">3</span>, TimeUnit.<span class=\"token environment constant\">SECONDS</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    private static List<span class=\"token operator\">&lt;</span>Oldxu<span class=\"token operator\">></span> getAllOldxu<span class=\"token punctuation\">(</span>int count<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        List<span class=\"token operator\">&lt;</span>Oldxu<span class=\"token operator\">></span> Oldxu <span class=\"token operator\">=</span> new ArrayList<span class=\"token operator\">&lt;></span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>int i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> count<span class=\"token punctuation\">;</span> ++i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            Oldxu.add<span class=\"token punctuation\">(</span>new Oldxu<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token builtin class-name\">return</span> Oldxu<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    public static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> throws InterruptedException <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        executor.setMaximumPoolSize<span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            processOldxu<span class=\"token punctuation\">(</span>getAllOldxu<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            Thread.sleep<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\">#2. 编译代码</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac MoreFullGC.java</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token comment\">#3. 运行代码</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms20M -Xmx20M \\</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> MoreFullGC</pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token comment\">#4. 追踪 GC</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token number\">6553</span> Bootstrap</pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token number\">8492</span> MoreFullGC</pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token number\">8557</span> Jps</pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token number\">6574</span> plugin-core.jar</pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jstat -gc 8492</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token number\">640.0</span>  <span class=\"token number\">640.0</span>   <span class=\"token number\">0.0</span>    <span class=\"token number\">0.0</span>    <span class=\"token number\">5504.0</span>   <span class=\"token number\">4440.6</span>   <span class=\"token number\">13696.0</span>    <span class=\"token number\">13696.0</span>   <span class=\"token number\">4864.0</span> <span class=\"token number\">3916.4</span> <span class=\"token number\">512.0</span>  <span class=\"token number\">433.9</span>      <span class=\"token number\">10</span>    <span class=\"token number\">0.036</span>  <span class=\"token number\">53</span>      <span class=\"token number\">0.182</span>    <span class=\"token number\">0.21</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token comment\">#5. 将程序运行的堆内存扩大 10 倍</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms200M -Xmx200M \\</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> MoreFullGC</pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token comment\">#6. 追踪 GC，发现 YGC 没有那么频繁了，同时没有产生 FGC，GCT 时间明显变短了</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token number\">8696</span> Jps</pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token number\">6553</span> Bootstrap</pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token number\">8633</span> MoreFullGC</pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token number\">6574</span> plugin-core.jar</pre></td></tr><tr><td data-num=\"96\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jstat -gc 8633</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token number\">6784.0</span> <span class=\"token number\">6784.0</span>  <span class=\"token number\">0.0</span>   <span class=\"token number\">993.6</span>  <span class=\"token number\">54656.0</span>  <span class=\"token number\">38837.2</span>   <span class=\"token number\">136576.0</span>     <span class=\"token number\">0.0</span>     <span class=\"token number\">4864.0</span> <span class=\"token number\">3906.9</span> <span class=\"token number\">512.0</span>  <span class=\"token number\">436.1</span>       <span class=\"token number\">1</span>    <span class=\"token number\">0.009</span>   <span class=\"token number\">0</span>      <span class=\"token number\">0.000</span>    <span class=\"token number\">0.00</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token comment\">#7.GC 参数描述</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>S0C：Surivor区S0的大小</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>S1C：Surivor区S1的大小</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>S0U：Surivor区S0的使用大小</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>S1U：Surivor区S1的使用大小</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>EC： Eden区的大小</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>EU：Eden区的使用大小</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>OC：老年代大小</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>OU：老年代使用大小</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>MC：方法区大小</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>MU：方法区使用大小</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>CCSC:压缩类空间大小</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>CCSU:压缩类空间使用大小</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>YGC：年轻代垃圾回收次数</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>YGCT：年轻代垃圾回收消耗时间</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>FGC：老年代垃圾回收次数</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>FGCT：老年代垃圾回收消耗时间</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>GCT：垃圾回收消耗总时间</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>单位：KB</pre></td></tr></table></figure><h4 id=\"六-tomcat开启jmx监控详解\"><a class=\"anchor\" href=\"#六-tomcat开启jmx监控详解\">#</a> 六、 Tomcat 开启 JMX 监控详解</h4>\n<h5 id=\"61-windows安装java\"><a class=\"anchor\" href=\"#61-windows安装java\">#</a> 6.1 Windows 安装 JAVA</h5>\n<p>参考链接：<a href=\"https://blog.csdn.net/qq_39652397/article/details/124045623\">https://blog.csdn.net/qq_39652397/article/details/124045623</a></p>\n<h5 id=\"62-tomcat启动jmx远程管理端口\"><a class=\"anchor\" href=\"#62-tomcat启动jmx远程管理端口\">#</a> 6.2 Tomcat 启动 JMX 远程管理端口</h5>\n<pre><code>[root@web01 ~]# vim /soft/tomcat/bin/catalina.sh\n#!/bin/sh\n\nCATALINA_OPTS=&quot;$CATALINA_OPTS \\\n-Dcom.sun.management.jmxremote \\\n-DJava.rmi.server.hostname=192.168.40.101 \\\n-Dcom.sun.management.jmxremote.port=9999 \\\n-Dcom.sun.management.jmxremote.ssl=false \\\n-Dcom.sun.management.jmxremote.authenticate=false&quot;\n...\n[root@web01 ~]# systemctl stop tomcat &amp;&amp; systemctl start tomcat\n[root@web01 ~]# netstat -lntp|grep java\ntcp6       0      0 :::9999                 :::*                    LISTEN      9725/java           \ntcp6       0      0 :::8080                 :::*                    LISTEN      9725/java \n</code></pre>\n<h5 id=\"63-通过jconsole监控jvm\"><a class=\"anchor\" href=\"#63-通过jconsole监控jvm\">#</a> 6.3 通过 Jconsole 监控 jvm</h5>\n<p>Jconsole-&gt; 远程进程 192.168.40.101:9999-&gt; 连接</p>\n<h5 id=\"64-通过jvisualvm监控jvm\"><a class=\"anchor\" href=\"#64-通过jvisualvm监控jvm\">#</a> 6.4 通过 Jvisualvm 监控 jvm</h5>\n<p>1、安装 visualvm<br />\n 在高版本 JDK（大于 1.8 或后期更新的 1.8 版本）中已经不会再自动集成 VisualVM，需手动安装；</p>\n<p>2、添加远程主机</p>\n<p>visualvm-&gt;remote-&gt;ADD remote host-&gt;192.168.40.101-&gt;ADD JMX connection-&gt;192.168.40.101:9999</p>\n<p>3、安装 GC 插件</p>\n<p>Tools-&gt;plugins-&gt;Auvilable pluginS-&gt;Visual GC-&gt;install</p>\n",
            "tags": [
                "Tomcat"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/4201058646.html",
            "url": "http://ixuyong.cn/posts/4201058646.html",
            "title": "Tomcat配置管理实践",
            "date_published": "2025-06-08T02:51:48.000Z",
            "content_html": "<h3 id=\"tomcat配置管理实践\"><a class=\"anchor\" href=\"#tomcat配置管理实践\">#</a> Tomcat 配置管理实践</h3>\n<h4 id=\"一-oraclejdk安装\"><a class=\"anchor\" href=\"#一-oraclejdk安装\">#</a> 一、OracleJdk 安装</h4>\n<p>OracleJdk 下载地址：<a href=\"https://www.oracle.com/java/technologies/downloads/#java8\">https://www.oracle.com/java/technologies/downloads/#java8</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf jdk-8u451-linux-x64.tar.gz -C /usr/local</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/jdk1.8.0_451/ /usr/local/jdk</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#添加环境变量</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/profile.d/jdk.sh</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JAVA_HOME</span><span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$JAVA_HOME</span>/bin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JRE_HOME</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/jre </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CLASSPATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/lib/:<span class=\"token variable\">$JRE_HOME</span>/lib/</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -version</span></pre></td></tr></table></figure><h4 id=\"二-tomcat安装\"><a class=\"anchor\" href=\"#二-tomcat安装\">#</a> 二、Tomcat 安装</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft &amp;&amp; cd /soft</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.106/bin/apache-tomcat-9.0.106.tar.gz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf apache-tomcat-9.0.106.tar.gz -C /soft</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /soft/apache-tomcat-9.0.106 /soft/tomcat</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># /soft/tomcat/bin/startup.sh</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep java</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">1765</span>/java           </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:8005          :::*                    LISTEN      <span class=\"token number\">1765</span>/javaa</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#Tomcat 启停配置文件</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/lib/systemd/system/tomcat.service</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># /usr/lib/systemd/system/tomcat.service</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Apache Tomcat</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>forking</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span>JAVA_HOME<span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span>CATALINA_HOME<span class=\"token operator\">=</span>/soft/tomcat</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span>CATALINA_BASE<span class=\"token operator\">=</span>/soft/tomcat</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/soft/tomcat/bin/startup.sh</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token assign-left variable\">ExecStop</span><span class=\"token operator\">=</span>/soft/tomcat/bin/shutdown.sh</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat      </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep java</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">1842</span>/java           </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:8005          :::*                    LISTEN      <span class=\"token number\">1842</span>/java</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Vc1v1lK.jpeg\" alt=\"Snipaste_2025-06-14_14-57-42.jpg\" /></p>\n<h4 id=\"三-tomcat配置\"><a class=\"anchor\" href=\"#三-tomcat配置\">#</a> 三、Tomcat 配置</h4>\n<h5 id=\"31-tomcat目录结构\"><a class=\"anchor\" href=\"#31-tomcat目录结构\">#</a> 3.1 Tomcat 目录结构</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bin\t\t：  二进制可执行（脚本文件 windwos版bat、linux版sh）</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conf\t：  配置文件，主配置是server.xml</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>lib\t\t：  都是一些java语言编写的jar包，这些都需要被调用，才能执行； module （jar、war）</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>logs\t：  tomcat的日志存放位置，可修改；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>temp\t：  tomcat的临时目录；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>webapps ：  相当于nginx中  root /soft/tomcat/webapps/     /soft/tomcat/webapps/ROOT</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>work\t<span class=\"token builtin class-name\">:</span>   tomcat的一个缓存目录；（java代码，编译为class字节码对外提供；）</pre></td></tr></table></figure><h5 id=\"32-tomcat配置文件说明\"><a class=\"anchor\" href=\"#32-tomcat配置文件说明\">#</a> 3.2 Tomcat 配置文件说明</h5>\n<ul>\n<li>server：表示一个 tomcat 实例；</li>\n<li>Listener：监听器；</li>\n<li>connector：连接器，支持 http、https、ajp 等协议请求；</li>\n<li>service：将 connector 与 engine 关联的组件；</li>\n<li>engine：具体 http、https 的请求与响应； （Nginx 中  http {}）</li>\n<li>host：与用户请求的 Host 字段进行比对；哪个 Host 匹配则哪个处理，如没有符合的则交给默认的 defaultHost 处理</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /soft/tomcat/conf/server.xml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"UTF-8\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--关闭tomcat的端口--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>Server <span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token string\">\"8005\"</span> <span class=\"token assign-left variable\">shutdown</span><span class=\"token operator\">=</span><span class=\"token string\">\"SHUTDOWN\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--监听器 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.startup.VersionLoggerListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.core.AprLifecycleListener\"</span> <span class=\"token assign-left variable\">SSLEngine</span><span class=\"token operator\">=</span><span class=\"token string\">\"on\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.core.JreMemoryLeakPreventionListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.core.ThreadLocalLeakPreventionListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--全局资源限制--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token operator\">&lt;</span>GlobalNamingResources<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Resource <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"UserDatabase\"</span> <span class=\"token assign-left variable\">auth</span><span class=\"token operator\">=</span><span class=\"token string\">\"Container\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.UserDatabase\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              <span class=\"token assign-left variable\">description</span><span class=\"token operator\">=</span><span class=\"token string\">\"User database that can be updated and saved\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              <span class=\"token assign-left variable\">factory</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.users.MemoryUserDatabaseFactory\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              <span class=\"token assign-left variable\">pathname</span><span class=\"token operator\">=</span><span class=\"token string\">\"conf/tomcat-users.xml\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/GlobalNamingResources<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--连接器--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Service <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"Catalina\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Connector <span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token string\">\"8080\"</span> <span class=\"token assign-left variable\">protocol</span><span class=\"token operator\">=</span><span class=\"token string\">\"HTTP/1.1\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>               <span class=\"token assign-left variable\">connectionTimeout</span><span class=\"token operator\">=</span><span class=\"token string\">\"20000\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>               <span class=\"token assign-left variable\">redirectPort</span><span class=\"token operator\">=</span><span class=\"token string\">\"8443\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--引擎--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Engine <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"Catalina\"</span> <span class=\"token assign-left variable\">defaultHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--调用限制--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Realm <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.realm.LockOutRealm\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Realm <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.realm.UserDatabaseRealm\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>               <span class=\"token assign-left variable\">resourceName</span><span class=\"token operator\">=</span><span class=\"token string\">\"UserDatabase\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Realm<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--虚拟主机--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"webapps\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token operator\">&lt;</span>/Engine<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/Service<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token operator\">&lt;</span>/Server<span class=\"token operator\">></span></pre></td></tr></table></figure><h5 id=\"33tomcat请求流程\"><a class=\"anchor\" href=\"#33tomcat请求流程\">#</a> 3.3Tomcat 请求流程</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ZU2ezrN.jpeg\" alt=\"2.jpg\" /></p>\n<p>假设来自用户的请求为：<a href=\"http://tomcat.hmallleasing.com:8080/index.jsp\">http://tomcat.hmallleasing.com:8080/index.jsp</a></p>\n<ul>\n<li>1. 服务端运行 Tomcat 应用，监听在本机的 8080 端口，等待连接；</li>\n<li>2. 浏览器发送 http 请求，并且请求服务端的 8080 端口，也就是 Tomcat 进程；</li>\n<li>3. 服务端通过 http connector 连接器获取请求，然后通过 service 将请求交给符合条件的 engine;</li>\n<li><a href=\"http://4.xn--Enginetomcat-4l2xh11ksszesu1a.hmallleasing.com:8080/index.jsp%EF%BC%8C%E9%81%8D%E5%8E%86%E5%AE%83%E6%89%80%E6%9C%89%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BAHost;\">4.Engine 获得请求 tomcat.hmallleasing.com:8080/index.jsp，遍历它所有虚拟主机 Host;</a></li>\n<li>5. 如果 Engine 匹配不到对应的 Host，就把请求交给 Engine 中的 defaultHost 处理；</li>\n<li>6. 如果 Engine 匹配到对应的 Host,  则提取该 Host 中指定的 appBase（代码存储路径）；</li>\n<li>7. 最后 Engine 将解析后的结果返回给 connector，connector 返回给浏览器；</li>\n</ul>\n<h5 id=\"35-tomcat与nginx对比\"><a class=\"anchor\" href=\"#35-tomcat与nginx对比\">#</a> 3.5 Tomcat 与 Nginx 对比</h5>\n<p>Nginx 中：</p>\n<ul>\n<li>http 层：只能有一个；</li>\n<li>server：可以有多个，多个表示多个站点；</li>\n<li>location：一个站点的多个 uri 的路径匹配</li>\n</ul>\n<p>Tomcat 中：</p>\n<ul>\n<li>engine：只能有一个，也是负责请求与响应的；</li>\n<li>Host：  可以有多个，多个表示多个站点；</li>\n<li>context：用来定义用户请求的 uri，将其调度到指定的目录中提取代码；</li>\n</ul>\n<h5 id=\"36-tomcat虚拟主机host\"><a class=\"anchor\" href=\"#36-tomcat虚拟主机host\">#</a> 3.6 Tomcat 虚拟主机 Host</h5>\n<ul>\n<li>name: 主机名称</li>\n<li>appBase：网站代码存放路径</li>\n<li>unpackWARs：自动解压 war 包</li>\n<li>autoDeploy：自动部署</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--tom1.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tom1.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/tom1\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr></table></figure><p>创建网站代码存放路径，写入测试代码，并重启 Tomcat；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/tom1/ROOT -p</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"Tomcat Test Page\" > /code/tom1/ROOT/index.html</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp;  systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ieCVXl0.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"37-tomcat虚拟主机context\"><a class=\"anchor\" href=\"#37-tomcat虚拟主机context\">#</a> 3.7 Tomcat 虚拟主机 Context</h5>\n<p>context 使用方式</p>\n<ul>\n<li>docBase: 站点存放的路径</li>\n<li>path: 访问站点的 URI 路径</li>\n<li>reloadable：修改了 jsp 文件，无需重启就可以实现显示的同步</li>\n</ul>\n<p>访问 http:/tom2.hamllleasing.com/zh-&gt; 映射 -&gt;/code/zh</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--tom1.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tom1.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/tom1\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Context <span class=\"token assign-left variable\">docBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/zh\"</span> <span class=\"token assign-left variable\">path</span><span class=\"token operator\">=</span><span class=\"token string\">\"/zh\"</span> <span class=\"token assign-left variable\">reloadable</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr></table></figure><p>注意：如果设定了 context，没有创建对应目录则无法启动 Tomcat</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f /soft/tomcat/logs/catalina.out</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tCaused by: java.lang.IllegalArgumentException: The main resource <span class=\"token builtin class-name\">set</span> specified <span class=\"token punctuation\">[</span>/code/zh<span class=\"token punctuation\">]</span> is not a directory or war file, or is not readable <span class=\"token punctuation\">(</span>it does not exist or permissions to access it are missing<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\tat org.apache.catalina.webresources.StandardRoot.createMainResourceSet<span class=\"token punctuation\">(</span>StandardRoot.java:758<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tat org.apache.catalina.webresources.StandardRoot.startInternal<span class=\"token punctuation\">(</span>StandardRoot.java:715<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tat org.apache.catalina.util.LifecycleBase.start<span class=\"token punctuation\">(</span>LifecycleBase.java:164<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>创建对应目录，写入测试代码，并重启 Tomcat</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"hello zh\" > /code/zh/index.html</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp;  systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/GoiPhZp.jpeg\" alt=\"2.jpg\" /></p>\n<h5 id=\"38-tomcat管理页面配置\"><a class=\"anchor\" href=\"#38-tomcat管理页面配置\">#</a> 3.8 Tomcat 管理页面配置</h5>\n<p>1、配置 Tomcat Bsic 认证，配置文件 /soft/tomcat/conf/tomcat-users.xml 最后添加用户，然后关联至对应资源的角色名称；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web03 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/tomcat-users.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token operator\">&lt;</span>role <span class=\"token assign-left variable\">rolename</span><span class=\"token operator\">=</span><span class=\"token string\">\"manager-gui,admin-gui\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token operator\">&lt;</span>user <span class=\"token assign-left variable\">username</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"123456\"</span> <span class=\"token assign-left variable\">roles</span><span class=\"token operator\">=</span><span class=\"token string\">\"manager-gui,admin-gui\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>/tomcat-users<span class=\"token operator\">></span></pre></td></tr></table></figure><p>2、由于 Tomcat 仅语序本地 127.0.0.1 进行 basic 认证，如果需要其他网段通过 basic 认证，还需配置允许访问规则。找到 webapps/ 项目 / META-INF/context.xml 配置；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改第一个项目</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/webapps/host-manager/META-INF/context.xml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>修改为：</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">allow</span><span class=\"token operator\">=</span><span class=\"token string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1|192\\.168\\.40\\.\\d+\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#2. 修改第二个项目</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim  /soft/tomcat/webapps/manager/META-INF/context.xml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>修改后：</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">allow</span><span class=\"token operator\">=</span><span class=\"token string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1|192\\.168\\.40\\.\\d+\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#3. 重启 tomcat</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gV1iMaz.jpeg\" alt=\"3.jpg\" /></p>\n<h4 id=\"四-tomcat部署zrlog\"><a class=\"anchor\" href=\"#四-tomcat部署zrlog\">#</a> 四、Tomcat 部署 zrlog</h4>\n<h5 id=\"41-zrlog单节点部署\"><a class=\"anchor\" href=\"#41-zrlog单节点部署\">#</a> 4.1 zrlog 单节点部署</h5>\n<h6 id=\"411-部署mysql\"><a class=\"anchor\" href=\"#411-部署mysql\">#</a> 4.1.1 部署 MySQL</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、关闭防火墙、selinux、环境配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname aizj_db01</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate git -y</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y --exclude=kernel* &amp;&amp; reboot</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 'Asia/Shanghai' >/etc/timezone</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/nul</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#2、安装 Mysql5.7</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y mysql-community-server</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@aizj_db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'localhost'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2023'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'zrlog'</span>@<span class=\"token string\">'192.168.40.%'</span> identified by <span class=\"token string\">'Superman*2023'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#3、允许 root 用户在任何地方进行远程登录，并具有所有库任何操作权限，具体操作如下：</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>mysql <span class=\"token parameter variable\">-u</span> root -p<span class=\"token string\">\"youpass\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>mysql<span class=\"token operator\">></span>GRANT ALL PRIVILEGES ON *.* TO <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2023'</span> WITH GRANT OPTION<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>FLUSH PRIVILEGES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#4. 创建数据库</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>mysql<span class=\"token operator\">></span> create database zrlog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Query OK, <span class=\"token number\">1</span> row affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h6 id=\"412-配置tomcat虚拟主机\"><a class=\"anchor\" href=\"#412-配置tomcat虚拟主机\">#</a> 4.1.2 配置 Tomcat 虚拟主机</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/server.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--zrlog.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"zrlog.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/zrlog\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"zrlog_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h6 id=\"413-准备项目代码\"><a class=\"anchor\" href=\"#413-准备项目代码\">#</a> 4.1.3 准备项目代码</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/zrlog</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv zrlog-2.2.0-5e8a51f-release.war /code/zrlog/ROOT.war</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls /code/zrlog/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ROOT.war</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/hR5jFTN.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"42-zrlog集群部署\"><a class=\"anchor\" href=\"#42-zrlog集群部署\">#</a> 4.2 zrlog 集群部署</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">服务器名称</th>\n<th style=\"text-align:center\">服务器 IP</th>\n<th style=\"text-align:center\">服务器角色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">lb01</td>\n<td style=\"text-align:center\">192.168.40.150</td>\n<td style=\"text-align:center\">Nginx</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">192.168.40.7</td>\n<td style=\"text-align:center\">Tomcat</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">192.168.40.8</td>\n<td style=\"text-align:center\">Tomcat</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">NFS</td>\n<td style=\"text-align:center\">192.168.40.32</td>\n<td style=\"text-align:center\">NFS</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">db01</td>\n<td style=\"text-align:center\">192.168.40.51</td>\n<td style=\"text-align:center\">MySQL</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Redis</td>\n<td style=\"text-align:center\">192.168.40.41</td>\n<td style=\"text-align:center\">Redis</td>\n</tr>\n</tbody>\n</table>\n<h6 id=\"421-安装jdk\"><a class=\"anchor\" href=\"#421-安装jdk\">#</a> 4.2.1 安装 jdk</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp jdk-8u451-linux-x64.tar.gz root@192.168.40.8:/root</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf jdk-8u451-linux-x64.tar.gz  -C /usr/local/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/jdk1.8.0_451/ /usr/local/jdk</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#添加环境变量</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/profile.d/jdk.sh</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JAVA_HOME</span><span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$JAVA_HOME</span>/bin</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JRE_HOME</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/jre </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CLASSPATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/lib/:<span class=\"token variable\">$JRE_HOME</span>/lib/</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -version</span></pre></td></tr></table></figure><h6 id=\"422-安装tomcat\"><a class=\"anchor\" href=\"#422-安装tomcat\">#</a> 4.2.2 安装 Tomcat</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp  /soft root@192.168.40.8:/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /soft/tomcat/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /soft/apache-tomcat-9.0.106 /soft/tomcat</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp /usr/lib/systemd/system/tomcat.service root@192.168.40.8:/usr/lib/systemd/system/tomcat.service</span></pre></td></tr></table></figure><h6 id=\"423-部署zrlog\"><a class=\"anchor\" href=\"#423-部署zrlog\">#</a> 4.2.3 部署 zrlog</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp /code/* root@192.168.40.8:/code/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep java</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">1806</span>/java           </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:8005          :::*                    LISTEN      <span class=\"token number\">1806</span>/java</pre></td></tr></table></figure><h6 id=\"424-接入nginx负载均衡\"><a class=\"anchor\" href=\"#424-接入nginx负载均衡\">#</a> 4.2.4 接入 Nginx 负载均衡</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/zrlog.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream zrlog <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name zrlog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass http://zrlog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>proxy_read_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nginx &amp;&amp; systemctl enable nginx</span></pre></td></tr></table></figure><h6 id=\"425-接入共享存储nfs\"><a class=\"anchor\" href=\"#425-接入共享存储nfs\">#</a> 4.2.5 接入共享存储 Nfs</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/exports</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/data/zrlog <span class=\"token number\">192.168</span>.40.0/24<span class=\"token punctuation\">(</span>rw,all_squash,anonuid<span class=\"token operator\">=</span><span class=\"token number\">666</span>,anongid<span class=\"token operator\">=</span><span class=\"token number\">666</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data/zrlog -p</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /data/zrlog/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nfs-server &amp;&amp; systemctl enable nfs-server</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#web01 挂载 nfs</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zrlog/ROOT/attached</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.40.32:/data/zrlog /code/zrlog/ROOT/attached/</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#web02 挂载 nfs, 由于 web02 节点没有该静态资源目录，所以自行创建</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zrlog/ROOT/attached</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.40.32:/data/zrlog /code/zrlog/ROOT/attached/</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr></table></figure><h6 id=\"426-集群配置https\"><a class=\"anchor\" href=\"#426-集群配置https\">#</a> 4.2.6 集群配置 Https</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ssl_key<span class=\"token punctuation\">]</span><span class=\"token comment\"># [root@lb01 ~]# cat /etc/nginx/conf.d/zrlog.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream zrlog <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name zrlog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        client_max_body_size 1G<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate  /etc/nginx/ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate_key  /etc/nginx/ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_session_timeout 100m<span class=\"token punctuation\">;</span>               <span class=\"token comment\">#多长时间内如果再进行连接，则不需要进行握手过程</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ssl_session_cache shared:cache:10m<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#建立会话的缓存</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tproxy_pass http://zrlog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      server_name zrlog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#创建证书目录</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/ssl_key</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ssl_key<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"427-tomcat会话保持session\"><a class=\"anchor\" href=\"#427-tomcat会话保持session\">#</a> 4.2.7 Tomcat 会话保持 session</h6>\n<p>1、为 web01、web02 节点添加虚拟主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/server.xml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--session.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"session.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/session\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"zrlog_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr></table></figure><p>2、为 web01、web02 配置 session 相关的网页</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 web01</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/session/ROOT -p</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/session/ROOT/index.jsp</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>%</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>//HttpSession session <span class=\"token operator\">=</span> request.getSession<span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>System.out.println<span class=\"token punctuation\">(</span>session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;br> web01 SESSION ID:\"</span> + session.getId<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> + <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"Session created time is :\"</span> + session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>+ <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>%<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:session.hmallleasing.com http://192.168.40.7:8080</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#2. 配置 web02</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/session/ROOT -p</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/session/ROOT/index.jsp</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">&lt;</span>%</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>//HttpSession session <span class=\"token operator\">=</span> request.getSession<span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>System.out.println<span class=\"token punctuation\">(</span>session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;br> web02 SESSION ID:\"</span> + session.getId<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> + <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"Session created time is :\"</span> + session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>+ <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>%<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:session.hmallleasing.com http://192.168.40.7:8080</span></pre></td></tr></table></figure><p>3、接入负载均衡，测试检查，看看是否通过轮询调度，获取的 session 是不一致</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/session.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream session <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        client_max_body_size 1G<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate  /etc/nginx/ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate_key  /etc/nginx/ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_session_timeout 100m<span class=\"token punctuation\">;</span>               <span class=\"token comment\">#多长时间内如果再进行连接，则不需要进行握手过程</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ssl_session_cache shared:cache:10m<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#建立会话的缓存</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tproxy_pass http://session<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      server_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3syDtTJ.jpeg\" alt=\"1.jpg\" /></p>\n<p>当用户通过负载均衡向服务器 A 发起 http 请求，A 服务器会下发一个 sessionID，通过 head 中 set-cookie 回传用户，用户下次请求时会携带 cookie 字段加上服务器用户名和密码进行请求 A 服务器，该值就是 A 服务器下发的 sessionID，如果验证通过则登录成功。由于负载均衡采用轮询调度机制，请求 A 节点下发一个 sessionID，用户带着 A 节点下发一个 sessionID 请求负载均衡，会调度到 B 节点，B 节点不认 A 节点 sessionID，最终形成死循环。</p>\n<p>4、使用负载均衡 ip_hash 来解决 session；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/session.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream session <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         ip_hash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        client_max_body_size 1G<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate  ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_certificate_key  ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ssl_session_timeout 100m<span class=\"token punctuation\">;</span>               <span class=\"token comment\">#多长时间内如果再进行连接，则不需要进行握手过程</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        ssl_session_cache shared:cache:10m<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#建立会话的缓存</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tproxy_pass http://session<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      server_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p>5、通过 redis 来解决 session 会话保持</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WcgGtb7.jpeg\" alt=\"1.jpg\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 安装 redis, 配置 redis</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install redis -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/redis.conf</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">bind</span> <span class=\"token number\">127.0</span>.0.1 <span class=\"token number\">192.168</span>.40.104</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>requirepass <span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start redis &amp;&amp; systemctl enable redis</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#2. 检查 redis 是否正常能对外提供服务</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -h 192.168.40.41 -a 123456</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">192.168</span>.40.104:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#3.tomcat 要支持 redis，需要模块（需要的是 jar 包）所有的应用节点都需要配置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>https://github.com/ran-jit/tomcat-cluster-redis-session-manager</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://github.com/ran-jit/tomcat-cluster-redis-session-manager/releases/download/4.0/tomcat-cluster-redis-session-manager.zip\t</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#4.web01、web02 复制 jar 包到 tomcat/lib 目录中</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip tomcat-cluster-redis-session-manager.zip</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp tomcat-cluster-redis-session-manager/lib/* /soft/tomcat/lib/</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#5.web01、web02 复制 redis 配置文件到 tomcat/conf 目录中。并更新他；</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp tomcat-cluster-redis-session-manager/conf/redis-data-cache.properties /soft/tomcat/conf/</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#6.web01、web02 修改 redis 配置信息</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/redis-data-cache.properties</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#- redis hosts. ex: 127.0.0.1:6379, 127.0.0.2:6379, 127.0.0.2:6380, ....</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">redis.hosts</span><span class=\"token operator\">=</span><span class=\"token number\">192.16</span>.40.41:6379</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#- redis password.</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">redis.password</span><span class=\"token operator\">=</span><span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#7..web01、web02 添加两行配置文件在 tomcat/conf/context.xml</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/context.xml</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat.request.session.redis.SessionHandlerValve\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Manager <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat.request.session.redis.SessionManager\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token operator\">&lt;</span>/Context<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#8.web01、web02 可选：修改 session 过期时间，默认 30m</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/web.xml</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token operator\">&lt;</span>session-config<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token operator\">&lt;</span>session-timeout<span class=\"token operator\">></span><span class=\"token number\">6</span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/session-timeout<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token operator\">&lt;</span>/session-config<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#8.web01、web02 重启 tomcat</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">#9.redis 查看 session</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -h 192.168.40.41 -a 123456</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token number\">192.168</span>.40.41:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> flushdb</pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token number\">192.168</span>.40.41:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *</pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"A8704CF8988CF60C30080420BA66AD0F\"</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/NbEnM7U.jpeg\" alt=\"2.jpg\" /></p>\n",
            "tags": [
                "Tomcat"
            ]
        }
    ]
}