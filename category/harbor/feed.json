{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生 • All posts by \"harbor\" category",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/3071070978.html",
            "url": "http://ixuyong.cn/posts/3071070978.html",
            "title": "企业级私有仓库Harbor搭建",
            "date_published": "2025-03-30T08:17:00.000Z",
            "content_html": "<h3 id=\"企业级私有仓库harbor\"><a class=\"anchor\" href=\"#企业级私有仓库harbor\">#</a> 企业级私有仓库 Harbor</h3>\n<p>企业部署 Kuberetes 集群环境之后，我们就可以将原来在传统虚拟机上运行的业务，迁移到 kubernetes 上，让 Kubernetes 通过容器的方式来管理。而一旦我们需要将传统业务使用容器的方式运行起来，就需要构建很多镜像，那么这些镜像就需要有一个专门的位置存储起来，为我们提供镜像上传和镜像下载等功能。但我们不能使用阿里云或者 Dockerhub 等仓库，首先拉取速度比较慢，其次镜像的安全性无法保证，所以就需要部署一个私有的镜像仓库来管理这些容器镜像。同时该仓库还需要提供高可用功能，确保随时都能上传和下载可用的容器镜像。</p>\n<h4 id=\"1-关闭防火墙-selinux-环境配置\"><a class=\"anchor\" href=\"#1-关闭防火墙-selinux-环境配置\">#</a> 1、关闭防火墙、Selinux、环境配置</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname harbor</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate -y</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr></table></figure><h4 id=\"2-docker安装\"><a class=\"anchor\" href=\"#2-docker安装\">#</a> 2、Docker 安装</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -o /etc/yum.repos.d/docker-ce.repo  https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum list docker-ce --showduplicates |sort -r </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install docker-ce docker-compose -y</span></pre></td></tr></table></figure><h4 id=\"3-配置docker加速\"><a class=\"anchor\" href=\"#3-配置docker加速\">#</a> 3、配置 Docker 加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">\"registry-mirrors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t  <span class=\"token string\">\"https://quay.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t  <span class=\"token string\">\"https://gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s-gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t  <span class=\"token string\">\"https://ghcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t  <span class=\"token string\">\"https://do.nark.eu.org\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.mirrors.sjtug.sjtu.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.1panel.live\"</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.rainbond.cc\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">]</span>, </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token string\">\"exec-opts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>EOF</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable docker --now</span></pre></td></tr></table></figure><h4 id=\"4-安装harbor\"><a class=\"anchor\" href=\"#4-安装harbor\">#</a> 4、安装 Harbor</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /soft/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://github.com/goharbor/harbor/releases/download/v2.6.1/harbor-offline-installer-v2.6.1.tgz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf harbor-offline-installer-v2.6.1.tgz</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd harbor</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim harbor.yml</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>hostname: <span class=\"token number\">192.168</span>.1.134</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#https:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#  # https port for harbor, default is 443</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#  port: 443</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#  # The path of cert and key files for nginx</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#  certificate: /your/certificate/path</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#  private_key: /your/private/key/path</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>harbor_admin_password: Harbor12345</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\">#  ./install.sh</span></pre></td></tr></table></figure><h4 id=\"5-配置nginx负载均衡调度\"><a class=\"anchor\" href=\"#5-配置nginx负载均衡调度\">#</a> 5、配置 Nginx 负载均衡调度</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim s.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    server_name harbor.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    client_max_body_size 1G<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    ssl_certificate  /etc/nginx/sslkey/_.hmallleasing.com_chain.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    ssl_certificate_key  /etc/nginx/sslkey/_.hmallleasing.com_key.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        proxy_pass http://192.168.1.134<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#       include proxy_params;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#       proxy_set_header Host $http_host;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        proxy_connect_timeout <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        proxy_read_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span>\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    server_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"6-推送镜像至harbor\"><a class=\"anchor\" href=\"#6-推送镜像至harbor\">#</a> 6、推送镜像至 Harbor</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker tag beae173ccac6 harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker login harbor.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr></table></figure><h4 id=\"7-harbor停止与启动\"><a class=\"anchor\" href=\"#7-harbor停止与启动\">#</a> 7、Harbor 停止与启动</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#停用 Harbor</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/soft/harbor</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose stop</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#启动 Harbor</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose up -d</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose start</span></pre></td></tr></table></figure>",
            "tags": [
                "Harbor"
            ]
        }
    ]
}