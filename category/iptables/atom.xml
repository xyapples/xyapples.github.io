<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://ixuyong.cn</id>
    <title>LinuxSre云原生 • Posts by &#34;iptables&#34; category</title>
    <link href="http://ixuyong.cn" />
    <updated>2025-09-19T14:01:02.000Z</updated>
    <category term="Aliyun" />
    <category term="Ansible" />
    <category term="DevOps" />
    <category term="Docker" />
    <category term="ELKStack" />
    <category term="Harbor" />
    <category term="Iptables" />
    <category term="Kubernetes" />
    <category term="LVS" />
    <category term="MySQL" />
    <category term="Linux" />
    <category term="rsync" />
    <category term="Samba" />
    <category term="Vsftp" />
    <category term="Nginx" />
    <category term="Openvpn" />
    <category term="Prometheus" />
    <category term="Rabbitmq" />
    <category term="Redis" />
    <category term="Shell" />
    <category term="Tomcat" />
    <category term="Windows" />
    <entry>
        <id>http://ixuyong.cn/posts/3327248306.html</id>
        <title>Firewalld防火墙实战</title>
        <link rel="alternate" href="http://ixuyong.cn/posts/3327248306.html"/>
        <content type="html">&lt;h3 id=&#34;firewalld防火墙&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#firewalld防火墙&#34;&gt;#&lt;/a&gt; Firewalld 防火墙&lt;/h3&gt;
&lt;h4 id=&#34;1-firewalld基本介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#1-firewalld基本介绍&#34;&gt;#&lt;/a&gt; 1. Firewalld 基本介绍&lt;/h4&gt;
&lt;h5 id=&#34;11-什么是firewalld&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#11-什么是firewalld&#34;&gt;#&lt;/a&gt; 1.1 什么是 Firewalld&lt;/h5&gt;
&lt;p&gt;在 Centos7 系统集成了多款防火墙管理工具，默认启用的是 Firewalld（动态防火墙管理器），Firewalld 支持 CLI 及 GUI 的两种管理方式。&lt;/p&gt;
&lt;p&gt;对于接触 Linux 较早的人员对 Iptables 比较熟悉。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;由于 Iptables 的规则比较麻烦，并且网络有一定要求，所以学习成本较高。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;但是 Firewalld 的学习对网络并没有那么高的要求，相对 Iptables 来说要简单不少。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/qzcAVWc.png&#34; alt=&#34;null&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;12-firewalld默认策略&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#12-firewalld默认策略&#34;&gt;#&lt;/a&gt; 1.2 Firewalld 默认策略&lt;/h5&gt;
&lt;p&gt;如果开启 Firewalld 防火墙，默认情况会阻止流量流入，但允许流量流出。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/8wD1htt.png&#34; alt=&#34;null&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;2-firewalld区域概念&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#2-firewalld区域概念&#34;&gt;#&lt;/a&gt; 2. Firewalld 区域概念&lt;/h4&gt;
&lt;p&gt;相较于传统的 Iptables 防火墙，firewalld 支持动态更新，并加入了区域 zone 的概念。&lt;/p&gt;
&lt;h5 id=&#34;21-什么是区域&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#21-什么是区域&#34;&gt;#&lt;/a&gt; 2.1 什么是区域&lt;/h5&gt;
&lt;p&gt;简单来说，区域就是 firewalld 预先准备了几套防火墙策略集合（策略模板），用户可以根据不用的场景而选择不同的策略模板，从而实现防火墙策略之间的快速切换。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/cKOASeU.png&#34; alt=&#34;null&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;22-区域与网络接口&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#22-区域与网络接口&#34;&gt;#&lt;/a&gt; 2.2 区域与网络接口&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;一个网卡仅能绑定一个区域，比如：eth0--&amp;gt;A 区域&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;但是一个区域可以绑定多个网卡，比如：B 区域 --&amp;gt;eth0、eth1&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;可以根据不同的策略来配置不同的规则，可以根据来源的地址设定不同的规则。比如：所有人能访问 80 端口，但只有公司的 IP 才允许访问 22 端口。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;23-默认区域规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#23-默认区域规则&#34;&gt;#&lt;/a&gt; 2.3 默认区域规则&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;区域&lt;/th&gt;
&lt;th&gt;默认区域规则&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;trusted（信任区域）&lt;/td&gt;
&lt;td&gt;允许所有的传入流量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;home（家庭区域）&lt;/td&gt;
&lt;td&gt;拒绝流入流量，除非与流出的流量相关；而如果流量与 ssh、mdns、ipp-client、amba-client 与 dhcpv6-client 服务相关，则允许流量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;internal（内部区域）&lt;/td&gt;
&lt;td&gt;等同于 home 区域&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;work（工作区域）&lt;/td&gt;
&lt;td&gt;拒绝流入的流量，除非与流出的流量相关；而如果流量与 ssh、ipp-client 与 dhcp6-client 服务相关，则允许流量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;public（公共区域）&lt;/td&gt;
&lt;td&gt;拒绝流入的流量，除非与流出的流量相关；而如果流量与 ssh、dhcp6-client 与服务相关，则允许流量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;external（外部区域）&lt;/td&gt;
&lt;td&gt;拒绝流入的流量，除非与流出的流量相关；而如果流量与 ssh 服务相关，则允许流量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;dmz（隔离区域也称为非军事区域）&lt;/td&gt;
&lt;td&gt;拒绝流入的流量，除非与流出的流量相关；而如果流量与 ssh 服务相关，则允许流量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;block（限制区域）&lt;/td&gt;
&lt;td&gt;拒绝流入的流量，除非与流出的流量相关&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;drop（丢弃区域）&lt;/td&gt;
&lt;td&gt;拒绝流入的流量，除非与流出的流量相关&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&#34;3-firewalld命令语法&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#3-firewalld命令语法&#34;&gt;#&lt;/a&gt; 3. Firewalld 命令语法&lt;/h4&gt;
&lt;h5 id=&#34;31-区域命令语法&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#31-区域命令语法&#34;&gt;#&lt;/a&gt; 3.1 区域命令语法&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--get-default-zone：查询默认区域的名称&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--set-default-zone&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;区域名称&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;：设置默认的区域，使其永久生效&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--get-active-zones：显示当前正在使用的区域与网卡名称&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--get-zones：显示总共可用的区域&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--new-zone&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;zone&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;：新增区域&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;32-接口命令语法&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#32-接口命令语法&#34;&gt;#&lt;/a&gt; 3.2 接口命令语法&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--add-interface&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;网卡名称&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;：将源自该网卡的所有流量都导向某个指定区域&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--change-interface&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;网卡名称&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;：将网卡关联至对应的区域&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;33-服务命令语法&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#33-服务命令语法&#34;&gt;#&lt;/a&gt; 3.3 服务命令语法&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--get-services：列出所有支持的服务名称&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--add-services：允许服务放行&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--remove-services：拒绝服务放行&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--query-services：查看服务是否放行&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;34-端口命令语法&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#34-端口命令语法&#34;&gt;#&lt;/a&gt; 3.4 端口命令语法&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--add-port&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;端口号/协议&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;：允许端口放行&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--remove-port&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;端口号/协议&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;：拒绝端口放行&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;35-管理命令语法&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#35-管理命令语法&#34;&gt;#&lt;/a&gt; 3.5 管理命令语法&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--list-all：显示当前区域的网卡配置参数、资源、端口以及服务等信息&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--reload：让&lt;span class=&#34;token string&#34;&gt;&#34;永久生效&#34;&lt;/span&gt;的配置规则立即生效，并覆盖当前的配置规则&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;4-firewalld区域配置&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#4-firewalld区域配置&#34;&gt;#&lt;/a&gt; 4. Firewalld 区域配置&lt;/h4&gt;
&lt;h5 id=&#34;41查询区域及规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#41查询区域及规则&#34;&gt;#&lt;/a&gt; 4.1 查询区域及规则&lt;/h5&gt;
&lt;p&gt;firewalld 启动后，我们需要知道使用的是什么区域，区域的规则明细又有那些&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、通过 --get-default-zone 获取当前默认使用的区域&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --get-default-zone&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;public&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2、通过 --get-active-zone 查看当前正在使用的区域与网卡名称&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --get-active-zone&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;public&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  interfaces: eth0 eth1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3、通过 --list-all 查看当前默认区域配置了哪些规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --list-all&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;public &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;active&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  target: default&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  icmp-block-inversion: no&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  interfaces: eth0 eth1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  sources: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  services: dhcpv6-client &lt;span class=&#34;token function&#34;&gt;ssh&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ports: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  protocols: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  masquerade: no&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  forward-ports: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  source-ports: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  icmp-blocks: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rich rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;42-多区域组合应用&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#42-多区域组合应用&#34;&gt;#&lt;/a&gt; 4.2 多区域组合应用&lt;/h5&gt;
&lt;p&gt;使用 firewalld 各个区域规则结合配置&lt;br /&gt;
调整默认 public 区域拒绝所有流量，但如果来源 IP 是 10.0.0.0/24 网段则允许&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1、临时移除默认区域的规则策略&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --remove-service=ssh --remove-service=dhcpv6-client&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2、添加来源是 10.0.0.0/24 网段，将其加入白名单 (更精细化控制使用富规则)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --add-source=192.168.40.0/24 --zone=trusted&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3、查看当前活动的区域&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --get-active-zone&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;public&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  interfaces: eth0 eth1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;trusted&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  sources: &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.0/24&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;5-firewalld规则配置&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#5-firewalld规则配置&#34;&gt;#&lt;/a&gt; 5. Firewalld 规则配置&lt;/h4&gt;
&lt;h5 id=&#34;51-配置端口规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#51-配置端口规则&#34;&gt;#&lt;/a&gt; 5.1 配置端口规则&lt;/h5&gt;
&lt;p&gt;放行 80/tcp 端口流量&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 单个端口 (临时)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --add-port&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;/tcp&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 多个端口 (临时)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --add-port&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;/tcp,8080/tcp&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 多个端口 (永久)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --add-port&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;/tcp,8080/tcp&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--permanent&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd &lt;span class=&#34;token parameter variable&#34;&gt;--reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4. 查看放行端口&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --list-ports&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#5. 移除端口规则 (临时)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --remove-port&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;/tcp,8080/tcp&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;52-配置服务规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#52-配置服务规则&#34;&gt;#&lt;/a&gt; 5.2 配置服务规则&lt;/h5&gt;
&lt;p&gt;放行 http、https 服务流量&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 放行单个服务&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --add-service=http&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 放行多个服务&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --add-service=&amp;#123;http,https&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 自定义服务名称&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cd /usr/lib/firewalld/services&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cp ssh.xml zabbix-agent.xml&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;?xml &lt;span class=&#34;token assign-left variable&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;1.0&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;encoding&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;utf-8&#34;&lt;/span&gt;?&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;service&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;short&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;zabbix-agent&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/short&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;description&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;Secure Shell &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;SSH&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; is a protocol &lt;span class=&#34;token keyword&#34;&gt;for&lt;/span&gt; logging into and executing commands on remote machines. It provides secure encrypted communications. If you plan on accessing your machine remotely via SSH over a firewalled interface, &lt;span class=&#34;token builtin class-name&#34;&gt;enable&lt;/span&gt; this option. You need the openssh-server package installed &lt;span class=&#34;token keyword&#34;&gt;for&lt;/span&gt; this option to be useful.&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/description&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;port &lt;span class=&#34;token assign-left variable&#34;&gt;protocol&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;tcp&#34;&lt;/span&gt; &lt;span class=&#34;token assign-left variable&#34;&gt;port&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;10050&#34;&lt;/span&gt;/&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;/service&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --add-service=zabbix-agent&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4. 查看火墙可以控制的所有服务&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --get-services&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;6-firewalld实现nat&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#6-firewalld实现nat&#34;&gt;#&lt;/a&gt; 6. Firewalld 实现 NAT&lt;/h4&gt;
&lt;h5 id=&#34;61-dnat应用场景&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#61-dnat应用场景&#34;&gt;#&lt;/a&gt; 6.1 DNAT 应用场景&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;基本概念：端口转发是指传统的目标地址映射，实现外网访问内网资源&lt;/li&gt;
&lt;li&gt;实现原理：firewalld 使用的是代理方式来实现地址映射，会占用随机端口&lt;/li&gt;
&lt;li&gt;实现语法：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd &lt;span class=&#34;token parameter variable&#34;&gt;--permanent&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--zone&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;区域&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; --add-forward-port&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;port&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;源端口号&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;:proto&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;协议&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;:toport&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;目标端口号&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;:toaddr&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt;目标IP地址&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;ul&gt;
&lt;li&gt;配置场景：将请求的 10.0.0.200:5555 端口转发至后端 172.16.1.9:22 端口&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/9l8r1h1.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;p&gt;实现地址转换，类似于代理模式，而非地址替换&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 开启 forward 转发&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# sysctl -p&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;net.ipv4.ip_forward &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2、配置转发规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --add-forward-port=port=5555:proto=tcp:toport=22:toaddr=172.16.1.7 --permanent&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --list-all&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;public &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;active&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  target: default&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  icmp-block-inversion: no&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  interfaces: eth0 eth1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  sources: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  services: dhcpv6-client &lt;span class=&#34;token function&#34;&gt;ssh&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ports: &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;/tcp &lt;span class=&#34;token number&#34;&gt;8080&lt;/span&gt;/tcp&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  protocols: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  masquerade: no&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  forward-ports: &lt;span class=&#34;token assign-left variable&#34;&gt;port&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;5555&lt;/span&gt;:proto&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;tcp:toport&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt;:toaddr&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;172.16&lt;/span&gt;.1.7&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  source-ports: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  icmp-blocks: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rich rules:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 如果使用 iptables 实现&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; nat &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; PREROUTING &lt;span class=&#34;token parameter variable&#34;&gt;-d&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.200 &lt;span class=&#34;token parameter variable&#34;&gt;--dport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;5555&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DNAT &lt;span class=&#34;token parameter variable&#34;&gt;--to&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;172.16&lt;/span&gt;.1.0:22&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;62-snat应用场景&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#62-snat应用场景&#34;&gt;#&lt;/a&gt; 6.2 SNAT 应用场景&lt;/h5&gt;
&lt;p&gt;在指定的带有公网 IP 的服务器上启动 firewalld 实现内部集群共享上网&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/mQAGBhb.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 开启 forward 转发&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# sysctl -p&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;net.ipv4.ip_forward &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2.firewalld 开启 masquerade&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --add-masquerade --permanent&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --reload&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --list-all&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;public &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;active&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  target: default&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  icmp-block-inversion: no&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  interfaces: eth0 eth1&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  sources: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  services: dhcpv6-client &lt;span class=&#34;token function&#34;&gt;ssh&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  ports: &lt;span class=&#34;token number&#34;&gt;80&lt;/span&gt;/tcp &lt;span class=&#34;token number&#34;&gt;8080&lt;/span&gt;/tcp&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  protocols: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  masquerade: &lt;span class=&#34;token function&#34;&gt;yes&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  forward-ports: &lt;span class=&#34;token assign-left variable&#34;&gt;port&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;5555&lt;/span&gt;:proto&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;tcp:toport&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt;:toaddr&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;172.16&lt;/span&gt;.1.7&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  source-ports: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  icmp-blocks: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;  rich rules: &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 客户端将网关指向 firewalld 服务器，并配置号 DNS&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@web01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# cat /etc/sysconfig/network-scripts/ifcfg-eth1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;TYPE&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;Ethernet&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;PROXY_METHOD&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;none&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;BROWSER_ONLY&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;no&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;BOOTPROTO&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;none&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;DEFROUTE&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;yes&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;IPV4_FAILURE_FATAL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;no&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;IPV6INIT&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;yes&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;IPV6_AUTOCONF&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;yes&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;33&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;IPV6_DEFROUTE&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;yes&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;34&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;IPV6_FAILURE_FATAL&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;no&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;35&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;IPV6_ADDR_GEN_MODE&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;stable-privacy&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;36&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;NAME&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth1&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;37&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;DEVICE&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;eth1&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;38&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;ONBOOT&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;yes&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;39&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;IPV6_PRIVACY&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;no&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;40&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;IPADDR&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;172.16.1.7&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;41&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;PREFIX&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#34;24&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;42&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;GATEWAY&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;172.16&lt;/span&gt;.1.200&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;43&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;44&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@web01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ifdown eth0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;45&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@web01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ifdown eth1 &amp;amp;&amp;amp; ifup eth1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;7-firewalld富规则策略&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#7-firewalld富规则策略&#34;&gt;#&lt;/a&gt; 7. Firewalld 富规则策略&lt;/h4&gt;
&lt;h5 id=&#34;71-rule基本介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#71-rule基本介绍&#34;&gt;#&lt;/a&gt; 7.1 Rule 基本介绍&lt;/h5&gt;
&lt;p&gt;firewalld 中的富规则表示更细致、更详细的防火墙策略配置，它可以针对系统服务、端口号、源地址和目标地址等诸多信息进行更有针对性的策略配置，优先级在所有的防火墙策略中也是最高的。&lt;/p&gt;
&lt;h5 id=&#34;72-rule命令语法&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#72-rule命令语法&#34;&gt;#&lt;/a&gt; 7.2 Rule 命令语法&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#富规则相关命令&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--add-rich-rule&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;&amp;lt;RULE&gt;&#39;&lt;/span&gt;     &lt;span class=&#34;token comment&#34;&gt;#在指定的区添加一条富规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--remove-rich-rule&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;&amp;lt;RULE&gt;&#39;&lt;/span&gt;  &lt;span class=&#34;token comment&#34;&gt;#在指定的区删除一条富规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--query-rich-rule&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;&amp;lt;RULE&gt;&#39;&lt;/span&gt;   &lt;span class=&#34;token comment&#34;&gt;#找到规则返回 0，找不到返回 1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;--list-rich-rule             &lt;span class=&#34;token comment&#34;&gt;#列出指定区里的所有富规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;73-rule执行顺序&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#73-rule执行顺序&#34;&gt;#&lt;/a&gt; 7.3 Rule 执行顺序&lt;/h5&gt;
&lt;p&gt;查看设定的规则，如果没有添加 --permanent 参数则重启 firewalld 会失效。富规则按先后顺序匹配，按先匹配到的规则生效。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --list-rich-rules&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;74-rule场景示例1&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#74-rule场景示例1&#34;&gt;#&lt;/a&gt; 7.4 Rule 场景示例 1&lt;/h5&gt;
&lt;p&gt;1、比如允许 10.0.0. 主机能够访问 http 服务，允许 172.16.1.0/24 能访问 10050 端口&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --add-rich-rule=&#39;rule family=ipv4 source address=10.0.0.1/32 service name=http accept&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# firewall-cmd --add-rich-rule=&#39;rule family=ipv4 source address=172.16.1.0/24 port port=&#34;10050&#34; protocol=&#34;tcp&#34; accept&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;75-rule场景示例2&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#75-rule场景示例2&#34;&gt;#&lt;/a&gt; 7.5 Rule 场景示例 2&lt;/h5&gt;
&lt;p&gt;默认 public 区域对外开放所有人能通过 ssh 服务连接，但拒绝 172.16.1.0/24 网段通过 ssh 连接服务器&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --add-rich-rule&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;rule family=ipv4 source address=172.16.1.0/24 service name=ssh drop&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;76-rule场景示例3&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#76-rule场景示例3&#34;&gt;#&lt;/a&gt; 7.6 Rule 场景示例 3&lt;/h5&gt;
&lt;p&gt;使用 firewalld，允许所有人能访问 http,https 服务，但只有 10.0.0.1 主机可以访问 ssh 服务&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --add-service&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;&amp;#123;&lt;/span&gt;http,https&lt;span class=&#34;token punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --remove-service&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;ssh&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --add-rich-rule&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;rule family=ipv4 source address=10.0.0.1/32 service name=ssh accept&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;77-rule场景示例4&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#77-rule场景示例4&#34;&gt;#&lt;/a&gt; 7.7 Rule 场景示例 4&lt;/h5&gt;
&lt;p&gt;当用户来源 IP 地址是 10.0.0.1 主机，则将用户请求的 5555 端口转发至后端 172.16.1.9 的 22 端口&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --add-masquerate&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;firewall-cmd --add-rich-rule&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;rule family=ipv4 source address=10.0.0.1/32 forward-port port=5555 protocol=tcp to-port=22 to-addr=172.16.1.9&#39;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
        <category term="Iptables" />
        <updated>2025-09-19T14:01:02.000Z</updated>
    </entry>
    <entry>
        <id>http://ixuyong.cn/posts/3328453550.html</id>
        <title>Iptables防火墙实战</title>
        <link rel="alternate" href="http://ixuyong.cn/posts/3328453550.html"/>
        <content type="html">&lt;h3 id=&#34;iptables防火墙实战&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#iptables防火墙实战&#34;&gt;#&lt;/a&gt; Iptables 防火墙实战&lt;/h3&gt;
&lt;h4 id=&#34;1iptables基本介绍&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#1iptables基本介绍&#34;&gt;#&lt;/a&gt; 1.Iptables 基本介绍&lt;/h4&gt;
&lt;h5 id=&#34;11-什么是防火墙&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#11-什么是防火墙&#34;&gt;#&lt;/a&gt; 1.1 什么是防火墙&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;过去，很长一段时期里，房屋都是草屋结构，如果一家失火，四邻也会跟着遭殃，所以为安全起见，古人就在自己居住地周围修筑搞搞的围墙，以阻挡外来的火势，保护自身的安全，这种墙就叫 “防火墙”。&lt;/li&gt;
&lt;li&gt;如今，“英特网” 把世界各地的计算机都紧密地连接在一起。如果不严加防卫，一旦网络被侵害，可能会出现不可预计的损失。那么互联网上，我们会采用类似防火墙的方法，来保护我们的网络不受侵害，为此我们需要设定防火墙规则，确定哪些类型的数据包允许通过，哪些不允许通过。&lt;/li&gt;
&lt;li&gt;那么具备这种功能的 “设备或软件” 就可以称之为 “防火墙”&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;12-防火墙的种类&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#12-防火墙的种类&#34;&gt;#&lt;/a&gt; 1.2 防火墙的种类&lt;/h5&gt;
&lt;p&gt;从逻辑上讲，防火墙可以大体分为主机防火墙和网络防火墙：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;主机防火墙：针对于单个主机进行防护，比如 Windowns。&lt;/li&gt;
&lt;li&gt;网络防火墙：往往处理网络入口，针对于网络入口进行防护， 服务于防火墙背后的服务器集群。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;从物理上讲，防火墙可以分为硬件防火墙和软件防火墙：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;硬件防火墙：在硬件级别实现部分防火墙功能，另外一部分功能基于软件实现，性能高、成本高。&lt;/li&gt;
&lt;li&gt;软件防火墙：以软件的方式模拟防火墙功能，运行在操作系统上，性能不高，成本低。&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;13-什么是iptables&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#13-什么是iptables&#34;&gt;#&lt;/a&gt; 1.3 什么是 iptables&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;iptables 其实不是真正的防火墙，就是一个代理程序，用户通过 iptables 这个代理程序，将安全规则执行到对应的 “安全框架” 中，这个 “安全框架” 才是真正的防火墙，这个安全框架叫 netfilter，是内核代码中不可缺少的一部分；&lt;/li&gt;
&lt;li&gt;iptables 位于操作系统的用户空间，我们后期是通过 iptables 命令工具操作 netfilter 内核框架；&lt;/li&gt;
&lt;li&gt;所以 iptables 的完整叫法应该是 netfilter/iptables，它是 linux 平台下的 “包过滤型防火墙”，这个包过滤防火墙是免费的，它可以替代昂贵的商业防火墙解决方案，完成数据包的过滤、连接追踪、限速、网络地址转换（NAT）等功能。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/QsIu39B.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;14-什么是包过滤防火墙&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#14-什么是包过滤防火墙&#34;&gt;#&lt;/a&gt; 1.4 什么是包过滤防火墙&lt;/h5&gt;
&lt;p&gt;包过滤防火墙它工作在 OSI 七层模型中的网络层，用来匹配网络数据包的 Header:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1. 将 Head 与预先定义好的防火墙规则进行比对；&lt;/li&gt;
&lt;li&gt;2. 与规则相匹配的包会被放行；&lt;/li&gt;
&lt;li&gt;3. 与规则不匹配的包则可能会被丢弃，也可能执行更复杂的动作；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;由于包过滤防火墙工作在网络层，故也称 “网络层防火墙”，它通过检查每一个数据包的：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;源地址、目的地址；&lt;/li&gt;
&lt;li&gt;源端口、目的端口；&lt;/li&gt;
&lt;li&gt;协议类型 TCP、UDP、ICMP，等状态信息来判断是否符合规则；&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;15-包过滤防火墙如何实现&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#15-包过滤防火墙如何实现&#34;&gt;#&lt;/a&gt; 1.5 包过滤防火墙如何实现&lt;/h5&gt;
&lt;p&gt;包过滤防火墙是由 Netfilter 来实现，它是内核的一部分，如果我们想要防火墙能够达到 “防火” 的目的，则需要在内核中设置关卡，所有进出的数据报文都要经过这些关卡进行检查：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;将如何条件的放行；&lt;/li&gt;
&lt;li&gt;不符合条件的阻止；&lt;/li&gt;
&lt;li&gt;而这些关卡在 iptables 中不被称为 “关卡”，而是被称为 “链”；&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;2-iptables链的概念&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#2-iptables链的概念&#34;&gt;#&lt;/a&gt; 2. Iptables 链的概念&lt;/h4&gt;
&lt;h5 id=&#34;21-什么是链&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#21-什么是链&#34;&gt;#&lt;/a&gt; 2.1 什么是链&lt;/h5&gt;
&lt;p&gt;在 iptables 中的关卡为什么被称为 “链” 呢？&lt;/p&gt;
&lt;p&gt;防火墙的作用就在于对经过的数据报文进行 &amp;quot;规则&amp;quot; 匹配，然后执行规则对应的 “动作”，所以当报文经过这些关卡的时候，则必须匹配这个关卡上的规则，但是这个关卡上可能不止一条规则，而是有很多条规则，当我们把这些规则串到一起的时候，就形成了 “链”。&lt;/p&gt;
&lt;p&gt;所以，每个经过这个 “关卡” 的报文，都要讲这条 “链” 上的所有规则匹配一遍，如果有如何条件的规则，则执行规则对应的动作，如果没有则执行默认链的动作。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/3sABXRs.jpeg&#34; alt=&#34;2.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;22-iptables有哪些链链&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#22-iptables有哪些链链&#34;&gt;#&lt;/a&gt; 2.2 iptables 有哪些链链&lt;/h5&gt;
&lt;p&gt;当我们启动了防火墙功能时，报文需要经过很多关卡，也就是说，根据实际情况的不同，报文经过 “链” 可能不同，大体分为如下三类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1. 请求到达本机：  PREROUTING  --&amp;gt;  INPUT  --&amp;gt;  Local Process&lt;/li&gt;
&lt;li&gt;2. 请求经过本机：  PREROUTING  --&amp;gt;  FORWARD --&amp;gt; POSTROUTING&lt;/li&gt;
&lt;li&gt;3. 请求从本机发出：Process     --&amp;gt;  OUTPUT  --&amp;gt; POSTROUTING&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;了解 iptables 链的数据包流向，后期在设定规则时，能很清楚的知道将规则设定在哪个链上。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/GzkcMvH.jpeg&#34; alt=&#34;3.jpg&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;3-iptables表的概念&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#3-iptables表的概念&#34;&gt;#&lt;/a&gt; 3. Iptables 表的概念&lt;/h4&gt;
&lt;h5 id=&#34;31-什么是表&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#31-什么是表&#34;&gt;#&lt;/a&gt; 3.1 什么是表&lt;/h5&gt;
&lt;p&gt;我们对每个 “链” 上都放置了一串规则，但是这些规则有些很相似，比如：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A 类规则都是对 IP 或者端口的过滤；&lt;/li&gt;
&lt;li&gt;B 类规则都是对报文进行修改的；&lt;/li&gt;
&lt;li&gt;C 类规则都是进行地址转换的；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;当我们把具有相同功能的规则集合在一起叫作 “表”，所以说，不同功能的规则，我们可以放置在不同的表中进行管理，二 iptables 已经为我们定义了 4 种表，每种表对应不同的功能。&lt;/p&gt;
&lt;h5 id=&#34;32-表的功能&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#32-表的功能&#34;&gt;#&lt;/a&gt; 3.2 表的功能&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;表名&lt;/th&gt;
&lt;th&gt;用途&lt;/th&gt;
&lt;th&gt;常用链&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;filter&lt;/td&gt;
&lt;td&gt;默认表，用于数据包过滤（允许 / 拒绝流量）&lt;/td&gt;
&lt;td&gt;INPUT, FORWARD, OUTPUT&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;nat&lt;/td&gt;
&lt;td&gt;网络地址转换（如端口转发、共享上网）&lt;/td&gt;
&lt;td&gt;PREROUTING,INPUT, OUTPUT, POSTROUTING&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;mangle&lt;/td&gt;
&lt;td&gt;修改数据包内容（如 TTL、QoS 标记）&lt;/td&gt;
&lt;td&gt;PREROUTING, POSTROUTING，INPUT, FORWARD, OUTPUT&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;raw&lt;/td&gt;
&lt;td&gt;关闭 nat 表上启用的连接追踪机制&lt;/td&gt;
&lt;td&gt;PREROUTING, OUTPUT&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h5 id=&#34;33-表与链的关系&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#33-表与链的关系&#34;&gt;#&lt;/a&gt; 3.3 表与链的关系&lt;/h5&gt;
&lt;p&gt;raw--&amp;gt;mangle--&amp;gt;nat--&amp;gt;filter&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/aJNFcbZ.jpeg&#34; alt=&#34;4.jpg&#34; /&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;问题 1：来自 &lt;code&gt;10.0.0.1&lt;/code&gt;  的地址，访问本机的 WEB 服务请求不允许，应该在哪个表的哪个链上设定规则？&lt;br /&gt;
答案一：很多同学会觉得是 PREROUTING 链，但其实是 INPUT 链，因为我们要做的是过滤，而 PREROUTING 不能做过滤，所以应该在 filter 表中的 INPUT 规则链上设定规则。&lt;/li&gt;
&lt;li&gt;问题 2：所有由本机发往 &lt;code&gt;10.0.0.0/24&lt;/code&gt;  网段的 &lt;code&gt;TCP&lt;/code&gt;  服务都不允许？&lt;br /&gt;
答案二：由本地发出会经过 OUTPUT、POSTROUTING，但由于 POSTROUTING 不支持做过滤，所以应该在 filter 表中的 OUTPUT 规则链上配置。&lt;/li&gt;
&lt;li&gt;问题 3：所有来自己本地内部网络的主机，向互联网发送 WEB 服务器请求都允许？&lt;br /&gt;
答案三：由本地发出会经过 PREROUTING,、FORWARD、POSTROUTING ，但由于 PREROUTING，POSTROUTING 不支持做过滤，所以应该在 filter 表中的 FORWARD 链上设定规则。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;4-iptables规则管理&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#4-iptables规则管理&#34;&gt;#&lt;/a&gt; 4. Iptables 规则管理&lt;/h4&gt;
&lt;h5 id=&#34;41-什么是规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#41-什么是规则&#34;&gt;#&lt;/a&gt; 4.1 什么是规则&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;数据包的过滤基于规则，而规则是由匹配条件 + 动作组成，那我们对规则的操作无非就是增删改查。&lt;/li&gt;
&lt;li&gt;操作规则的语法：iptables -t &amp;lt;表名&amp;gt; &amp;lt; 选项 &amp;gt; &amp;lt; 链名 &amp;gt; [规则] -j &amp;lt; 动作 &amp;gt;&lt;/li&gt;
&lt;li&gt;操作规则之前我们需要考量如下两个问题：
&lt;ul&gt;
&lt;li&gt;1）要实现什么功能：判断添加到哪个表上；&lt;/li&gt;
&lt;li&gt;2｝报文流经的路线：判断添加到哪个链上；&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;iptables 选项&lt;/th&gt;
&lt;th&gt;含义&lt;/th&gt;
&lt;th&gt;示例&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;-t,--table&lt;/td&gt;
&lt;td&gt;指定要操作的表（默认 filter）&lt;/td&gt;
&lt;td&gt;iptables -t filter&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-A,--append&lt;/td&gt;
&lt;td&gt;最佳一条规则至链的末尾&lt;/td&gt;
&lt;td&gt;iptables -t filter -A INPUT&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-I,--insert&lt;/td&gt;
&lt;td&gt;追加一条规则至链的首部&lt;/td&gt;
&lt;td&gt;iptables -t filter -I INPUT&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-D,--delete&lt;/td&gt;
&lt;td&gt;指定删除一条规则&lt;/td&gt;
&lt;td&gt;iptables -t filter -D INPUT 1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-R,--replace&lt;/td&gt;
&lt;td&gt;替换选定链中的规则&lt;/td&gt;
&lt;td&gt;iptables -t filter -R INPUT&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-S,--list-rules&lt;/td&gt;
&lt;td&gt;打印选定链中的所有规则&lt;/td&gt;
&lt;td&gt;iptables -t filter -S&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-Z,--zero&lt;/td&gt;
&lt;td&gt;将所有链中的数据包和字节计数器归零&lt;/td&gt;
&lt;td&gt;iptables -t filter -Z&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-N,--new-chain&lt;/td&gt;
&lt;td&gt;创建自定义名称规则链&lt;/td&gt;
&lt;td&gt;iptables -N New_Rules&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-E,--rename-chain&lt;/td&gt;
&lt;td&gt;给自定义链修改名称&lt;/td&gt;
&lt;td&gt;iptables -E Old_Rules New_Rules&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-X,--delete-chain&lt;/td&gt;
&lt;td&gt;删除自定义链&lt;/td&gt;
&lt;td&gt;iptables -X Rules_Name&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-P,--policy&lt;/td&gt;
&lt;td&gt;给链设定默认策略&lt;/td&gt;
&lt;td&gt;iptables -t filter -P DROP&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h5 id=&#34;42-如何查看规则&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#42-如何查看规则&#34;&gt;#&lt;/a&gt; 4.2 如何查看规则&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 如何查看&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -L -n -v --line-numbers&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt;  指定表明&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-L&lt;/span&gt; 查看详情&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-n&lt;/span&gt; 不反解&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token parameter variable&#34;&gt;-v&lt;/span&gt; 详细信息&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-line-numbers 显示规则编号&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 如何添加规则： 禁止 10.0.0.10 ping 10.0.0.200&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p icmp -s 10.0.0.10 -j drop&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 如何修改规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;-R:修改 需要指定规则的编号&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -R INPUT 1 -p icmp -s 10.0.0.10 -j REJECT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4. 如何清空计数器&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -Z&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#5. 备份规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables-save &gt; /etc/iptables.rule&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#6. 清空规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -F					# 只操作 filter&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t nat -F			# 清空 nat 表&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;26&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;27&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#7. 恢复规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;28&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables-restore &amp;lt; /etc/iptables.rule&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;29&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;30&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#8. 永久生效&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;31&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;命令： iptables-restore &lt;span class=&#34;token operator&#34;&gt;&amp;lt;&lt;/span&gt; /etc/iptables.rule  &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;32&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;加入开机自启动 /etc/rc.local&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;5iptables基本匹配&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#5iptables基本匹配&#34;&gt;#&lt;/a&gt; 5.Iptables 基本匹配&lt;/h4&gt;
&lt;h5 id=&#34;51-iptables匹配参数&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#51-iptables匹配参数&#34;&gt;#&lt;/a&gt; 5.1 iptables 匹配参数&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;条件参数&lt;/th&gt;
&lt;th&gt;含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;[!] -p, --protocol protocol&lt;/td&gt;
&lt;td&gt;指明需要匹配的协议，如 icmp、udp、tcp&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;[!] -s, --source address[/mask][,...]&lt;/td&gt;
&lt;td&gt;指定匹配源地址，如有多个可以逗号分隔&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;[!] -d, --destination address[/mask][,...]&lt;/td&gt;
&lt;td&gt;指定匹配目标地址，如有多个可以逗号分隔&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;[!] --source-port,--sport port[:port]&lt;/td&gt;
&lt;td&gt;指定源端口&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;[!] --destination-port,--dport port[:port]&lt;/td&gt;
&lt;td&gt;指定目标端口&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;[!] -i, --in-interface name&lt;/td&gt;
&lt;td&gt;接收数据包的接口名称&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;[!] -o, --out-interface name&lt;/td&gt;
&lt;td&gt;发送数据包的接口名称&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-m, --match match&lt;/td&gt;
&lt;td&gt;执行需要使用的匹配项，属于扩展匹配&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-j, --jump target&lt;/td&gt;
&lt;td&gt;执行匹配规则后的动作、ACCEPT、DROP、REJECT 等&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h5 id=&#34;52-iptables匹配示例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#52-iptables匹配示例&#34;&gt;#&lt;/a&gt; 5.2 iptables 匹配示例&lt;/h5&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;.仅允许&lt;span class=&#34;token variable&#34;&gt;&lt;span class=&#34;token variable&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;10.0&lt;/span&gt;.0.1&lt;span class=&#34;token variable&#34;&gt;`&lt;/span&gt;&lt;/span&gt; 访问 &lt;span class=&#34;token variable&#34;&gt;&lt;span class=&#34;token variable&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;10.0&lt;/span&gt;.0.200&lt;span class=&#34;token variable&#34;&gt;`&lt;/span&gt;&lt;/span&gt; 服务器的&lt;span class=&#34;token variable&#34;&gt;&lt;span class=&#34;token variable&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;`&lt;/span&gt;&lt;/span&gt;端口、其他地址全部拒绝&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -s 10.0.0.1 -d 10.0.0.200 -p tcp --dport 22 -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -A INPUT -d 10.0.0.200 -p tcp --dport 22 -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt;.所有来访问本机的协议，属于TCP协议的我们通通都放行；&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p tcp -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt;.凡是由本机发出的TCP协议报文，都允许出去，其他协议不行&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I OUTPUT -p tcp -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I OUTPUT -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;4&lt;/span&gt;.禁止其他主机从eth0向本机发送ping请求&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -i eth0 -p icmp -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt;.允许从本机发送&lt;span class=&#34;token variable&#34;&gt;&lt;span class=&#34;token variable&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;token function&#34;&gt;ping&lt;/span&gt;&lt;span class=&#34;token variable&#34;&gt;`&lt;/span&gt;&lt;/span&gt;请求，其他任何协议都不允许；  【ssh也会掉线】&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I OUTPUT -p icmp -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -A OUTPUT -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;6-iptables扩展匹配&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#6-iptables扩展匹配&#34;&gt;#&lt;/a&gt; 6. Iptables 扩展匹配&lt;/h4&gt;
&lt;h5 id=&#34;61-multiport模块&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#61-multiport模块&#34;&gt;#&lt;/a&gt; 6.1 multiport 模块&lt;/h5&gt;
&lt;p&gt;使用 multiport 模块可以添加多个不连续的端口；-m multiport &amp;lt;--sports|--dports|--ports&amp;gt; 端口 1 [, 端口 2,.., 端口 n]&lt;/p&gt;
&lt;p&gt;示例 ： &lt;code&gt;10.0.0.10&lt;/code&gt;  访问本机 &lt;code&gt;20、21、80、443&lt;/code&gt;  允许通过；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -s 10.0.0.10 -d 10.0.0.200 -p tcp -m multiport --dport 20:22,80,443 -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -A INPUT -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;62-iprange模块&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#62-iprange模块&#34;&gt;#&lt;/a&gt; 6.2 iprange 模块&lt;/h5&gt;
&lt;p&gt;使用 iprange 模块可以指定 &amp;quot;一段连续的 IP 地址范围&amp;quot;，用于匹配报文的源地址或者目标地址， iprange 扩展模块中有两个扩展匹配条件可以使用。&lt;br /&gt;
[!] --src-range from [-to]： 原地址范围&lt;br /&gt;
 [!] --dst-range from [-to]： 目标地址范围&lt;/p&gt;
&lt;p&gt;示例： &lt;code&gt;10.0.0.5-10.0.0.10&lt;/code&gt;  地址段 &lt;code&gt;ping&lt;/code&gt;  本机，则丢弃&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p icmp -m iprange --src-range 10.0.0.5-10.0.0.10 --dst-range 10.0.0.200 -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;63-string模块&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#63-string模块&#34;&gt;#&lt;/a&gt; 6.3 String 模块&lt;/h5&gt;
&lt;p&gt;使用 string 扩展模块，可以指定要匹配的字符串，如果报文中包含对应的字符串，则符合匹配条件。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;--algo {bm|kmp} ：字符匹配的查询算法；&lt;/li&gt;
&lt;li&gt;[!] --string pattern ：字符匹配的字符串；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;示例：应用返回的报文中包含字符 &lt;code&gt;&amp;quot;hello&amp;quot;&lt;/code&gt; ，我们就丢弃当前报文，其余正常通过。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 安装 HTTPd 服务并准备两个页面&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install httpd -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start httpd&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# echo &#34;hello&#34; &gt; /var/www/html/index.html&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# echo &#34;video&#34; &gt; /var/www/html/test.html&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@redis ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl 192.168.40.200/index.html&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;hello&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@redis ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl 192.168.40.200/test.html&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;video&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 配置 iptables 规则 (响应做规则匹配)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I OUTPUT -p tcp -m string --algo kmp --string &#34;video&#34; -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@redis ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl 192.168.40.200/index.html&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;hello&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@redis ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl 192.168.40.200/test.html #被拦截&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例：用户请求后端节点，如果包含 “&lt;a href=&#34;http://web.hmallleasing.com&#34;&gt;web.hmallleasing.com&lt;/a&gt;” 则拒绝。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I FORWARD -p tcp -m sting --algo kmp --string &#34;web.hmallleasing.com&#34; -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;64-time模块&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#64-time模块&#34;&gt;#&lt;/a&gt; 6.4 time 模块&lt;/h5&gt;
&lt;p&gt;使用 time 扩展模块，根据时间段区匹配报文，如果报文到达的时间在指定的时间范围以内，则符合匹配条件。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;--timestart hh:mm [:ss] ：开始时间&lt;/li&gt;
&lt;li&gt;--timestop hh:mm [:ss] ：结束时间&lt;/li&gt;
&lt;li&gt;[!] --monthdays day [,day...] ：指定一个月的某一天&lt;/li&gt;
&lt;li&gt;[!] --weekdays day [,day...] ：指定周一到周天&lt;/li&gt;
&lt;li&gt;--kerneltz ：使用内核时区而不是 UTC 时间&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;示例一：拒绝每天 8:00  ~ 12:00   (00:00-04:00)、14:00 ~ 18:00   (06:00-10:00)，任何主机发送 icmp 协议。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#utc 时间与本地时间快 8 小时，所以需要 - 8 小时&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p icmp -m time --timestar 00:00 --timestop 04:00 -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p icmp -m time --timestar 06:00 --timestop 10:00 -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例二：限制用户在上班时间 (每天 8:00  ~ 12:00   (00:00-04:00)、14:00 ~ 18:00   (06:00-10:00)) 禁止访问优酷、爱奇艺等资源，其他时间可以正常访问；&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#网络策略&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; FORWARD &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;youku&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 00:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; 04:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; FORWARD &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;iqyi&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 00:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; 04:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; FORWARD &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;taobao&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 00:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; 04:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; FORWARD &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;jd&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 00:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; 04:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; FORWARD &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;youku&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 06:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; FORWARD &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;iqyi&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 06:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; FORWARD &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;taobao&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 06:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; FORWARD &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;jd&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 06:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#主机策略&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;youku&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 00:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; 04:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;iqyi&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 00:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; 04:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;taobao&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 00:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; 04:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;jd&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 00:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; 04:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;youku&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 06:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;iqyi&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 06:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;21&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;taobao&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 06:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;22&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; string &lt;span class=&#34;token parameter variable&#34;&gt;--algo&lt;/span&gt; kmp &lt;span class=&#34;token parameter variable&#34;&gt;--string&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;jd&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;--timestar&lt;/span&gt; 06:00 &lt;span class=&#34;token parameter variable&#34;&gt;--timestop&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;10&lt;/span&gt;:00 &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;23&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;24&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#验证测试  &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;25&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@redis ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# curl -HHost:youku.hmallleasing.com http://172.16.1.200/index.html #被限制访问&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;65-icmp模块&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#65-icmp模块&#34;&gt;#&lt;/a&gt; 6.5 icmp 模块&lt;/h5&gt;
&lt;p&gt;icmp 扩展模块：默认情况当禁止 ping 后，其他主机无法 ping 通本主机，本主机也无法 ping 通其他主机。&lt;/p&gt;
&lt;p&gt;假设现在的需求是本主机可以 ping 通其他主机，而其他主机依然无法 ping 同本主机。&lt;/p&gt;
&lt;ul&gt;
&lt;li type[code]|typename=&#34;&#34;&gt;[!] --icmp-type&lt;/li&gt;
&lt;li&gt;指定 ICMP 类型: echo-request（8 请求）、echo-reply（0 回应）&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 禁用 icmp 无法满足需求&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p icmp -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 通过抓包可以发现 ping 会发送 echo request（请求）、echo-reply（回应）报文&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# tcpdump -p icmp -v&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcpdump: listening on eth0, link-type EN10MB &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;Ethernet&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;, capture size &lt;span class=&#34;token number&#34;&gt;262144&lt;/span&gt; bytes&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;20&lt;/span&gt;:39:58.467850 IP &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;tos 0x0, ttl &lt;span class=&#34;token number&#34;&gt;64&lt;/span&gt;, &lt;span class=&#34;token function&#34;&gt;id&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;25799&lt;/span&gt;, offset &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;, flags &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;DF&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;, proto ICMP &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;, length &lt;span class=&#34;token number&#34;&gt;84&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.41 &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; route: ICMP &lt;span class=&#34;token builtin class-name&#34;&gt;echo&lt;/span&gt; request, &lt;span class=&#34;token function&#34;&gt;id&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1770&lt;/span&gt;, &lt;span class=&#34;token function&#34;&gt;seq&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;, length &lt;span class=&#34;token number&#34;&gt;64&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;20&lt;/span&gt;:39:58.467878 IP &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;tos 0x0, ttl &lt;span class=&#34;token number&#34;&gt;64&lt;/span&gt;, &lt;span class=&#34;token function&#34;&gt;id&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;48604&lt;/span&gt;, offset &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;, flags &lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;none&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;, proto ICMP &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;, length &lt;span class=&#34;token number&#34;&gt;84&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;    route &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.41: ICMP &lt;span class=&#34;token builtin class-name&#34;&gt;echo&lt;/span&gt; reply, &lt;span class=&#34;token function&#34;&gt;id&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1770&lt;/span&gt;, &lt;span class=&#34;token function&#34;&gt;seq&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;, length &lt;span class=&#34;token number&#34;&gt;64&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 使用 icmp 模块&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p icmp -m icmp --icmp-type &#34;echo-request&#34; -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;66-connlimit模块&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#66-connlimit模块&#34;&gt;#&lt;/a&gt; 6.6 connlimit 模块&lt;/h5&gt;
&lt;p&gt;connlimit 扩展模块，限制每个客户端 IP 地址到服务器的并行连接数。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;--connlimit-upto n ：如果现有连接数小于或等于 n，则匹配。&lt;/li&gt;
&lt;li&gt;--connlimit-above n ：如果现有连接数大于 n，则匹配。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;DDOS 攻击脚本程序，模拟大量的并发数连接&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@redis ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ll flood_connect.c&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例：使用脚本模拟 DDOS 攻击，然后检查网站是否异常，如果异常，则使用 iptables 限制并发连接数。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 模拟 DDOS 攻击&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install httpd -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# echo &#34;hello&#34; &gt; /var/www/html/test.html&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# echo &#34;index-xuyong&#34; &gt; /var/www/html/index.html&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl restart httpd&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@redis ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# gcc flood_connect.c &lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@redis ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ./a.out 192.168.40.200&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2 通过 netstat 会发现大量的 ESTABLISHED 状态，从而造成正常用户请求异常，开启并发限制，然后测试&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -ntp |wc -l&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;1013&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -ntp | grep ESTABLISHED | wc -l&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;384&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# netstat -ntp | grep SYN_RECV | wc -l&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;72&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;18&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;19&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 限制同一 IP 的并发连接数为 10&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;20&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 10 -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;67-limit模块&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#67-limit模块&#34;&gt;#&lt;/a&gt; 6.7 limit 模块&lt;/h5&gt;
&lt;p&gt;limit 扩展模块：限制单位时间内流入包的数量。&lt;/p&gt;
&lt;p&gt;可以以秒为单位进行限制，也可以以分钟、小时、天作为单位进行限制。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;--limit rate [second|minute|hour|day] ：平均匹配的速率&lt;/li&gt;
&lt;li&gt;--limit-burst number ：超过限制速率的包，允许超过 burst 所设定值，默认可超出 5 个&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;示例一：限制主机每分钟接收 10 个 icmp 数据包，差不多 6s 会接收客户端一个数据包&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p icmp -m limit --limit 10/minute -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -A INPUT -p icmp -j REJECT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例二：允许 icmp 瞬间通过 10 个数据包通过，超过的数据包每分钟仅能通过一个&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -A INPUT -p icmp -m limit  --limit 1/m --limit-burst 10 -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -A INPUT -p icmp -j REJECT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;示例三：限制主机传输时的带宽每秒不超过 500k&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#（500k * 1000=500000 字节 / 1500=333 个包）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 主机防护：&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I OUTPUT -p tcp -m limit --limit 300/second -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -A OUTPUT -p tcp -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# dd if=/dev/zero of=/var/www/html/bigdata bs=300M count=3&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@redis ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# wget http://192.168.40.200/bigdata&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 网络防护：&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I FORWARD -p tcp -m limit --limit 300/second -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -A FORWARD -p tcp -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;68-tcp-flags模块&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#68-tcp-flags模块&#34;&gt;#&lt;/a&gt; 6.8 tcp-flags 模块&lt;/h5&gt;
&lt;p&gt;使用 tcp 扩展模块的 &amp;quot;--tcp-flags&amp;quot; 选项，即可对 TCP 的标志位进行匹配，匹配指定标志位的值是否为 &amp;quot;1&amp;quot;，在 tcp 协议建立连接的过程中，需要先进行三次握手，而三次握手就要依靠 tcp 头中的标记位进行。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第一次：客户端向服务端发起第一次 TCP 连接时，在 TCP 的 flag 标志位中，SYN、RST、ACK、,FIN 等标记位仅有 SYN 为 1，其他标记位为 0。&lt;/li&gt;
&lt;li&gt;第二次：服务端向客户端返回 ACK，在 TCP 的 flag 标志位中，SYN、RST、ACK,FIN 等标记位 SYN、ACK 为 1，其他标记位为 0。&lt;/li&gt;
&lt;li&gt;第三次：客户端向服务端返回 ACK，在 TCP 的 flag 标志位中，SYN、RST、ACK,FIN 等标记位 ACK 为 1，其他标记位为 0。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们可以通过 --tcp-flag 指明需要匹配哪些标志位，然后再指明这些标志位中，哪些必须为 1，剩余的都必须为 0。&lt;/p&gt;
&lt;p&gt;所以当服务器接收新请求时，SYN 标志位必须 1，其他的标志位为 0，服务端响应这个连接时， SYN、ACK 标志位必须为 1，其他的标志位为 0。（这样可以避免木马程序通过端口主动向外发送新连接。）&lt;/p&gt;
&lt;p&gt;示例：客户端连接服务端 22 端口第一次握手必须是客户端发起的，所以 SYN 必须为 1，剩下全部为 0。然后服务端可以通过 22 端口返回对应的报文 SYN、ACK 为 1。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 使用 &#34;--syn&#34; 选项相当于使用 &#34;--tcp-flags SYN,RST,ACK,FIN SYN&#34;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;--dport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; tcp --tcp-flags SYN,ACK,FIN,RST SYN &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;--dport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; tcp --tcp-flags SYN,ACK,FIN,RST ACK &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; OUTPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;--sport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; tcp --tcp-flags SYN,ACK,FIN,RST SYN,ACK &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;--sport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; tcp --tcp-flags SYN,ACK,FIN,RST ACK &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;7-iptables连接追踪state&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#7-iptables连接追踪state&#34;&gt;#&lt;/a&gt; 7. Iptables 连接追踪 state&lt;/h4&gt;
&lt;h5 id=&#34;71-什么是连接追踪&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#71-什么是连接追踪&#34;&gt;#&lt;/a&gt; 7.1 什么是连接追踪&lt;/h5&gt;
&lt;p&gt;state（conntrack） 连接跟踪，顾名思义，就是跟踪（并记录）连接的状态。&lt;/p&gt;
&lt;p&gt;如上图：是一台 IP 地址为 10.1.1.2 的 Linux 机器，我们能看到这台机器上有三条连接：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;机器访问外部 HTTP 服务的连接（目的端口 80）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;外部访问机器内 FTP 服务的连接（目的端口 21）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;机器访问外部 DNS 服务的连接（目的端口 53）&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;连接跟踪所做的事情就是发现并跟踪这些连接的状态，但这个追踪状态与 TCP 协议没有关系。它是由内核 nefilter 在 IP 层实现，可 IP 层是无连接、无追踪的，那是如何知道这个 IP 是否存在？当用户发送请求时，会将用户的请求存储在内核开辟的内存空间中，对应在 /proc/net/nf_conntrack&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;文件会记录源 IP、目标 IP、协议、时间、状态等信息；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;当下次在有用户发起请求，就可以通过内存空间中获取该用户是否来过，以此来实现连接追踪机制；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;注意：该文件能存储的条目是受 /proc/sys/net/nf_conntrack_max 设定大小所限；&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/kSFv53K.png&#34; alt=&#34;null&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;72-连接追踪的状态分类&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#72-连接追踪的状态分类&#34;&gt;#&lt;/a&gt; 7.2 连接追踪的状态分类&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;New：新请求，内存中不存在此连接的相关条目，因此识别为第一次请求，状态为 NEW。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ESTABLISHED：NEW 状态之后，再次建立连接，由于此前的连接还没有失效，所以追踪后被视为已连接通讯状态，状态为 ESTABLISHED。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;RELATED：相关的连接。比如 ftp 有两个连接，命令连接和数据连接。命令连接有来有往是一个独立的循环，数据连接有来有往又是另外一个独立的循环，但是两者之间有关系，如果没有命令连接就不可能有数据连接，所以我们将这种称为” 相关联的连接 “。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;INVALID：无效的连接。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;73-连接追踪应用场景&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#73-连接追踪应用场景&#34;&gt;#&lt;/a&gt; 7.3 连接追踪应用场景&lt;/h5&gt;
&lt;p&gt;正常情况下服务器的 80 端口不会主动连接其他服务器，如果出现了 80 端口连接其他服务器，那么说明出现了异常行为，或者可以理解为中了木马程序病毒。反弹端口型木马如果关闭 80 端口的响应报文，但那样就会造成请求进来无法响应；如果开放 80 端口，则又会出现异常行为。所以我们需要从 80 端口做连接追踪限制，凡事从 80 端口出去的就必须是对某个请求的响应，也就是说通过 80 端口出去的状态必须是 ESTABLISHED，不能是 NEW。&lt;/p&gt;
&lt;h5 id=&#34;74-连接追踪配置场景&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#74-连接追踪配置场景&#34;&gt;#&lt;/a&gt; 7.4 连接追踪配置场景&lt;/h5&gt;
&lt;p&gt;需求：允许接收远程主机的 SSH 与 HTTP 请求 （NEW、ESTABLISHED） ，同时仅允许本机回应 SSH 以及 HTTP 的响应（ESTABLISHED），但不允许本机通过 22、80 端口主动向外发起连接。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 进站，允许状态：NEW,ESTABLISHED&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; multiport &lt;span class=&#34;token parameter variable&#34;&gt;--dport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80,443&lt;/span&gt;,22 &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; state &lt;span class=&#34;token parameter variable&#34;&gt;--state&lt;/span&gt; NEW,ESTABLISHED &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 出站，允许状态：ESTABLISHED&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; OUTPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; multiport &lt;span class=&#34;token parameter variable&#34;&gt;--sport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;80,443&lt;/span&gt;,22 &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; state &lt;span class=&#34;token parameter variable&#34;&gt;--state&lt;/span&gt; ESTABLISHED &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;需求：如果服务器也需要使用 SSH 连接其他远程主机，则还需要增加以下配置（但不建议）&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; OUTPUT &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;--dport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; state &lt;span class=&#34;token parameter variable&#34;&gt;--state&lt;/span&gt; NEW,ESTABLISHED &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;--sport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; state &lt;span class=&#34;token parameter variable&#34;&gt;--state&lt;/span&gt; NEW,ESTABLISHED &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;8-iptables地址转换&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#8-iptables地址转换&#34;&gt;#&lt;/a&gt; 8. Iptables 地址转换&lt;/h4&gt;
&lt;h5 id=&#34;81-什么是nat&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#81-什么是nat&#34;&gt;#&lt;/a&gt; 8.1 什么是 NAT&lt;/h5&gt;
&lt;p&gt;网络地址转换 （NAT） ，意思也比较清楚：对（数据包的）网络地址 （IP +Port） 进行转换。&lt;br /&gt;
例如，机器自己的 IP 10.1.1.2 是能与外部正常通信的，但 192.168.1 网段是私有 IP 段，无法与外界通信，因此当源地址为 192.168。1 网段的包要出去时，机器会先将源 IP 换成机器自己的 10.1.1.2 再发送出去；收到应答包时，再进行相反的转换。这就是 NAT 的基本过程。&lt;/p&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/1g4lppi.png&#34; alt=&#34;null&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;82-nat的几种模式&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#82-nat的几种模式&#34;&gt;#&lt;/a&gt; 8.2 NAT 的几种模式&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;SNAT ：源地址转换&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;DNAT ：目标地址转换&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;PNAT ：端口转换&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;83-nat环境搭建图&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#83-nat环境搭建图&#34;&gt;#&lt;/a&gt; 8.3 NAT 环境搭建图&lt;/h5&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/rPsF9gQ.png&#34; alt=&#34;null&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;84-snat-示例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#84-snat-示例&#34;&gt;#&lt;/a&gt; 8.4 SNAT - 示例&lt;/h5&gt;
&lt;p&gt;需求：实现内网主机通过防火墙进行上网，需要使用 SNAT（源地址转换 POSTROUTING）&lt;br /&gt;
172.16.1.7 --&amp;gt; 172.16.1.200 -- POSTROUTING --&amp;gt; 10.0.0.200 --&amp;gt; &lt;a href=&#34;http://baidu.com&#34;&gt;baidu.com&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 将 172.16.1.7 的网关指向 172.16.1.200，关闭 eth0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@web01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# echo &#34;GATEWAY=172.16.1.200&#34; &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@web01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# echo &#34;DNS1=223.5.5.5&#34; &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@web01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ifdown eth1 &amp;amp;&amp;amp; ifup eth1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@web01 ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ifdown eth0&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 开启 iptables 防火墙的 forward 转发&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# echo &#34;net.ipv4.ip_forward = 1&#34; &gt;&gt; /etc/sysctl.conf&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# sysctl -p&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 配置 iptables 的 SNAT 转发规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3.1 指定从哪个 ip 地址转换出去（静态公网地址）&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t nat -I POSTROUTING -s 172.16.1.0/24 -j SNAT --to 10.0.0.200&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t nat -L&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3.2 当外网源地址为动态获取的地址时，MASQUERADE 可自行判断要转换为的外网地址&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;17&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -j MASQUERADE&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;85-dnat-示例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#85-dnat-示例&#34;&gt;#&lt;/a&gt; 8.5 DNAT - 示例&lt;/h5&gt;
&lt;p&gt;需求：实现外网主机通过防火墙访问内部主机 80 端口，需要通过 DNAT（目标地址转换 PREROUTING）&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#端口映射 DNAT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t nat -I PREROUTING -d 10.0.0.200 -p tcp --dport 80 -j DNAT --to 172.16.1.7:80&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t nat -L -n&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#地址映射 DNAT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t nat -I PREROUTING -d 10.0.0.200 -j DNAT --to 172.16.1.7&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;9-iptables-自定义链&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#9-iptables-自定义链&#34;&gt;#&lt;/a&gt; 9. Iptables - 自定义链&lt;/h4&gt;
&lt;h5 id=&#34;91-为什么要使用自定义链&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#91-为什么要使用自定义链&#34;&gt;#&lt;/a&gt; 9.1 为什么要使用自定义链&lt;/h5&gt;
&lt;p&gt;此前我们一直在 iptables 的默认链中定义规则，那么此处，我们就来了解一下自定义链。这里可能有疑问，iptables 的默认链就已经能够满足我们了，为什么还需要自定义链呢？&lt;/p&gt;
&lt;p&gt;当默认链中的规则非常多时，不便于管理。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;假设 INPUT 链中存放了 200 条规则，这 200 条规则有针对 80 端口的，有针对 22 端口的，有针对私网 IP 的，等等。&lt;/li&gt;
&lt;li&gt;假如想修改针对 80 端口的规则，可能需要从头到尾看一遍 200 条规则，找出哪些规则是针对 80 端口。这显然不合理。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;所以，我们需要使用自定义链，通过自定义链即可解决上述问题。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;假设，我们自定义一条链，链名叫 IN_HTTP ，我们可以将所有针对 80 端口入站规则都写入到这条自定义链中，当以后想要修改针对 80 端口入站规则时，就直接修改 IN_HTTP 链中的规则就可以了。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;即使默认链中有再多的规则，也没有关系，因为所有针对 80 端口的入站规则都存放在 IN_HTTP 链中。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;同理，我们可以将针对 22 端口的出站规则放入到 OUT_SSH 自定义链中，这样，我们就能快速定位到想修改的规则在哪里。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;92-自定义链基本应用&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#92-自定义链基本应用&#34;&gt;#&lt;/a&gt; 9.2 自定义链基本应用&lt;/h5&gt;
&lt;p&gt;1、在 filter 表中，添加一个自定义链&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -N IN_SSHD&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -L -n&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2、给自定义链配置对应的规则：禁止 10.0.0.10 访问 10.0.0.200 的 22 端口&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I IN_SSHD -s 192.168.40.10 -d 192.168.40.200 -p tcp --dport 22 -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3、测试后发现，规则没有生效，因为自定义的链需要被默认的链调用才会生效&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# 既然 IN_HTTP 链是为了针对 22 端口的入站规则而创建的，那么这些规则应该去匹配入站的报文，所以应该用 INPUT 链去引用它。&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -p tcp --dport 22 -j IN_SSHD&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -L -n&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Chain INPUT &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;policy ACCEPT&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;target     prot opt &lt;span class=&#34;token builtin class-name&#34;&gt;source&lt;/span&gt;               destination         &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;IN_SSHD    tcp  --  &lt;span class=&#34;token number&#34;&gt;0.0&lt;/span&gt;.0.0/0            &lt;span class=&#34;token number&#34;&gt;0.0&lt;/span&gt;.0.0/0            tcp dpt:22&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Chain FORWARD &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;policy ACCEPT&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;target     prot opt &lt;span class=&#34;token builtin class-name&#34;&gt;source&lt;/span&gt;               destination         &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Chain OUTPUT &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;policy ACCEPT&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;12&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;target     prot opt &lt;span class=&#34;token builtin class-name&#34;&gt;source&lt;/span&gt;               destination         &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;13&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;14&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Chain IN_SSHD &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; references&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;15&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;target     prot opt &lt;span class=&#34;token builtin class-name&#34;&gt;source&lt;/span&gt;               destination         &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;16&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;DROP       tcp  --  &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.10        &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.200       tcp dpt:22&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;93-自定义链执行顺序&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#93-自定义链执行顺序&#34;&gt;#&lt;/a&gt; 9.3 自定义链执行顺序&lt;/h5&gt;
&lt;p&gt;&lt;img loading=&#34;lazy&#34; data-src=&#34;https://wp-cdn.4ce.cn/v2/1dRnAKl.jpeg&#34; alt=&#34;1.jpg&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;94-如何删除自定义链&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#94-如何删除自定义链&#34;&gt;#&lt;/a&gt; 9.4 如何删除自定义链&lt;/h5&gt;
&lt;p&gt;删除自定义链需要满足两个条件:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、自定义链没有被引用&lt;/li&gt;
&lt;li&gt;2、自定义链中没有任何规则&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#1. 删除自定义规则&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-D&lt;/span&gt; IN_SSHD &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#2. 删除 INPUT 引用&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-D&lt;/span&gt; INPUT &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#3. 自定义链重命名&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-E&lt;/span&gt; IN_SSHD SSHD&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;#4. 删除自定义链&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-X&lt;/span&gt; SSHD&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h4 id=&#34;10-iptables场景示例&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#10-iptables场景示例&#34;&gt;#&lt;/a&gt; 10. Iptables 场景示例&lt;/h4&gt;
&lt;h5 id=&#34;101-场景示例1&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#101-场景示例1&#34;&gt;#&lt;/a&gt; 10.1 场景示例 1&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;1. 对所有的地址开放本机的 tcp（80、22、8080-9090）端口的访问&lt;/li&gt;
&lt;li&gt;2. 允许对所有的地址开放本机的基于 ICMP 协议的数据包访问&lt;/li&gt;
&lt;li&gt;3. 其他未被允许的端口禁止访问&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;思路：先允许，后拒绝&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;INPUT:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; multiport &lt;span class=&#34;token parameter variable&#34;&gt;--dport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22,443&lt;/span&gt;，80,8080:9090 &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; state &lt;span class=&#34;token parameter variable&#34;&gt;--state&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;NEW,ESTABLISHED,RELATED&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; icmp &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; INPUT &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;output:&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-I&lt;/span&gt; OUTPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; tcp &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; multiport &lt;span class=&#34;token parameter variable&#34;&gt;--sport&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;22,80&lt;/span&gt;,443,8080:9090 &lt;span class=&#34;token parameter variable&#34;&gt;-m&lt;/span&gt; state &lt;span class=&#34;token parameter variable&#34;&gt;--state&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#34;NEW,ESTABLISHED,RELATED&#34;&lt;/span&gt; &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&#34;token parameter variable&#34;&gt;-p&lt;/span&gt; icmp &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; ACCEPT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;iptables &lt;span class=&#34;token parameter variable&#34;&gt;-t&lt;/span&gt; filter &lt;span class=&#34;token parameter variable&#34;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&#34;token parameter variable&#34;&gt;-j&lt;/span&gt; DROP&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;102-场景示例二&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#102-场景示例二&#34;&gt;#&lt;/a&gt; 10.2 场景示例二&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;1. 员工在公司内部 &lt;code&gt;（10.0.0.0/24、10.8.0.0/24）&lt;/code&gt; 能访问服务器上任何服务&lt;/li&gt;
&lt;li&gt;2. 当员工出差外地，通过 &lt;code&gt;vpn&lt;/code&gt;  连接到公司，也可以访问内部上的任何服务&lt;/li&gt;
&lt;li&gt;3. 公司有门户网站需要允许公网用户访问 &lt;code&gt;http 80/tcp、https 443/tcp&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -F&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -s 10.0.0.0/24 -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I INPUT -s 10.8.0.0/24 -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -A INPUT -p tcp -m multiport --dport 80,443 -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -A INPUT -p tcp -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;103-ftp主动模式规则配置&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#103-ftp主动模式规则配置&#34;&gt;#&lt;/a&gt; 10.3 ftp 主动模式规则配置&lt;/h5&gt;
&lt;p&gt;ftp 服务一般有主动和被动 l 两个个模式，那么针对这两个模式该如何配置 Iptables 规则呢？&lt;/p&gt;
&lt;p&gt;通常 ftp 主动模式监听在 21 端口，然后由 20 端口作为数据传输端口，向客户端发送数据。&lt;/p&gt;
&lt;p&gt;1.vsftp 服务端配置支持主动模式&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install vsftpd -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl start vsftpd&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl enable vsftpd&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2. 客服端连接模式默认为被动模式，需要通过 passvie 命令切换到主动模式&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@client ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# yum install ftp -y&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@client ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ftp 192.168.40.200&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Connected to &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.200 &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.200&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;.&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token number&#34;&gt;220&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;vsFTPd &lt;span class=&#34;token number&#34;&gt;3.0&lt;/span&gt;.2&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Name &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.200:root&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;: anonymous&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;ftp&lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; passive&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;3. 登录服务端查看客户端与服务端的连接状态。【服务端 20 端口主动向客户端随机端口发送数据】&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route pub&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;#  netstat -antp&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Active Internet connections &lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;servers and established&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name         &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp        &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0.0&lt;/span&gt;.0.0:22              &lt;span class=&#34;token number&#34;&gt;0.0&lt;/span&gt;.0.0:*               LISTEN      &lt;span class=&#34;token number&#34;&gt;1067&lt;/span&gt;/sshd              &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.200:21       &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.1:51035      ESTABLISHED &lt;span class=&#34;token number&#34;&gt;2088&lt;/span&gt;/vsftpd         &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;tcp6       &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.200:20       &lt;span class=&#34;token number&#34;&gt;192.168&lt;/span&gt;.40.1:51017      TIME_WAIT   -&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;4. 配置防火墙放行 21、20 端口，以及建立连接后的数据传输。&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;INPUT&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -F&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -I INPUT -p tcp --dport 22 -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -A INPUT -p tcp -m state --state &#34;NEW,ESTABLISHED,RELATED&#34; -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -A INPUT -p tcp -m multiport --dports 20,21 -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -A INPUT -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;OUTPUT：&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I OUTPUT -p tcp -m multiport --sport 22 -m state --state &#34;ESTABLISHED&#34; -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -I OUTPUT -p tcp -m multiport --sport 20,21 -m state --state &#34;NEW,ESTABLISHED,RELATED&#34; -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -t filter -A OUTPUT -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h5 id=&#34;104-ftp被动模式规则配置&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#104-ftp被动模式规则配置&#34;&gt;#&lt;/a&gt; 10.4 ftp 被动模式规则配置&lt;/h5&gt;
&lt;p&gt;ftp 被动模式监听在 21 端口，然后由随机端口作为数据传输端口，向客户端回发数据。&lt;/p&gt;
&lt;p&gt;由于是随机就法办法指定端口，所以可以配置 vsftpd 控制随机端口范围。&lt;/p&gt;
&lt;p&gt;1. 修改 vsftpd 服务端传输数据时的随机端口&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# vim /etc/vsftpd/vsftpd.conf&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;pasv_min_port&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;50000&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token assign-left variable&#34;&gt;pasv_max_port&lt;/span&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;60000&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# systemctl restart vsftpd&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;2. 配置 iptables 规则&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;figcaption data-lang=&#34;bash&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# INPUT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -I INPUT -p tcp --dport 22 -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -A INPUT -p tcp -m multiport --dports 21,50000:60000 -m state --state &#34;NEW,ESTABLISHED,RELATED&#34; -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -A INPUT -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;# OUTPUT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -I OUTPUT -p tcp --sport 22 -m state --state &#34;ESTABLISHED&#34; -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -A OUTPUT -p tcp -m multiport --sports 21,50000:60000 -m state --state &#34;ESTABLISHED&#34; -j ACCEPT&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;root@route ~&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# iptables -A OUTPUT -j DROP&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
        <category term="Iptables" />
        <updated>2025-09-13T12:51:51.000Z</updated>
    </entry>
</feed>
